#Requires -RunAsAdministrator
<#
    .SYNOPSIS
        Installs PowerShell script "Enable_BitLocker.ps1", creates Scheduled Task that runs it.

    .DESCRIPTION
        Installs PowerShell script "Enable_BitLocker.ps1", creates Scheduled Task that runs it.
    
        How to
            Convert Enable_BitLocker.ps1 to Base64
                * https://www.base64encode.org/
                    * Destination charset: UTF8
                    * Newline separator: LF (Linux)

    .NOTES
        * In Intune, remember to set "Run this script using the logged in credentials"  according to the $DeviceContext variable.
            * Intune -> Device Configuration -> PowerShell Scripts -> $NameScriptFull -> Properties -> "Run this script using the logged in credentials"
            * DEVICE (Local System) or USER (Logged in user).
        * Only edit $NameScript and add your code in the #region Your Code Here.
        * You might want to touch "Settings - PowerShell - Output Preferences" for testing / development. 
            * $VerbosePreference, eventually $DebugPreference, to 'Continue' will print much more details.
#>


# Script Variables
$NameScript            = [string] 'Install-IronTrigger'
$DeviceContext         = [bool]   $true
$WriteToHKCUFromSystem = [bool]   $true

# Settings - PowerShell - Output Preferences
$DebugPreference       = 'SilentlyContinue'
$VerbosePreference     = 'SilentlyContinue'
$WarningPreference     = 'Continue'

#region    Don't Touch This
# Settings - PowerShell - Interaction
$ConfirmPreference     = 'None'
$InformationPreference = 'SilentlyContinue'
$ProgressPreference    = 'SilentlyContinue'

# Settings - PowerShell - Behaviour
$ErrorActionPreference = 'Continue'

# Dynamic Variables - Process & Environment
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'NameScriptFull' -Value ([string]('{0}_{1}' -f ($(if($DeviceContext){'Device'}else{'User'}),$NameScript)))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'NameScriptVerb' -Value ([string]$NameScript.Split('-')[0])
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'NameScriptNoun' -Value ([string]$NameScript.Split('-')[-1])
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrArchitectureProcess' -Value ([string]$(if([System.Environment]::Is64BitProcess){'64'}else{'32'}))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrArchitectureOS' -Value ([string]$(if([System.Environment]::Is64BitOperatingSystem){'64'}else{'32'}))

# Dynamic Variables - User
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrUserNameRunningAs' -Value ([string]$([System.Security.Principal.WindowsIdentity]::GetCurrent().'Name'))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrSIDRunningAs' -Value ([string]$([System.Security.Principal.WindowsIdentity]::GetCurrent().'User'.'Value'))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'BoolIsAdmin'  -Value ([bool]$(([System.Security.Principal.WindowsPrincipal]$([System.Security.Principal.WindowsIdentity]::GetCurrent())).IsInRole([System.Security.Principal.WindowsBuiltInRole]::Administrator)))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'BoolIsSystem' -Value ([bool]$($Script:StrSIDRunningAs -like ([string]$('S-1-5-18'))))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'BoolIsCorrectUser' -Value ([bool]$(if($Script:DeviceContext -and $Script:BoolIsSystem){$true}elseif(((-not($DeviceContext))) -and (-not($Script:BoolIsSystem))){$true}else{$false}))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'BoolWriteToHKCUFromSystem' -Value ([bool]$(if($DeviceContext -and $WriteToHKCUFromSystem){$true}else{$false}))

# Dynamic Variables - Logging
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'Timestamp' -Value ([string]$([datetime]::Now.ToString('yyMMdd-HHmmssffff')))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'PathDirLog' -Value ([string]$('{0}\IronstoneIT\Intune\DeviceConfiguration\' -f ([string]$(if($BoolIsSystem){$env:ProgramW6432}else{[System.Environment]::GetEnvironmentVariable('LocalAppData')}))))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'PathFileLog' -Value ([string]$('{0}{1}-{2}bit-{3}.txt' -f ($Script:PathDirLog,$Script:NameScriptFull,$Script:StrArchitectureProcess,$Script:Timestamp)))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'ScriptSuccess' -Value ([bool]$($true))

# Start Transcript
if (-not(Test-Path -Path $Script:PathDirLog)) {$null = New-Item -ItemType 'Directory' -Path $Script:PathDirLog -ErrorAction 'Stop'}
Start-Transcript -Path $Script:PathFileLog -ErrorAction 'Stop'


# Wrap in Try/Catch, so we can always end the transcript
Try {
    # Output User Info, Exit if not $BoolIsCorrectUser
    Write-Output -InputObject ('Running as user "{0}" ({1}). Has admin privileges? {2}. $DeviceContext? {3}. Running as correct user? {4}.' -f ($Script:StrUserNameRunningAs,$Script:StrSIDRunningAs,$Script:BoolIsAdmin.ToString(),$Script:DeviceContext.ToString(),$Script:BoolIsCorrectUser.ToString()))
    if (-not($Script:BoolIsCorrectUser)){Throw 'Not running as correct user!'; Break}


    # Output Process and OS Architecture Info
    Write-Output -InputObject ('PowerShell is running as a {0} bit process on a {1} bit OS.' -f ($Script:StrArchitectureProcess,$Script:StrArchitectureOS))


    # If OS is 64 bit, and PowerShell got launched as x86, relaunch as x64
    if ([System.Environment]::Is64BitOperatingSystem -and -not [System.Environment]::Is64BitProcess) {
        write-Output -InputObject (' * Will restart this PowerShell session as x64.')
        if (-not([string]::IsNullOrEmpty($MyInvocation.'Line'))) {& ('{0}\sysnative\WindowsPowerShell\v1.0\powershell.exe' -f ($env:windir)) -NonInteractive -NoProfile $MyInvocation.'Line'}
        else {& ('{0}\sysnative\WindowsPowerShell\v1.0\powershell.exe' -f ($env:windir)) -NonInteractive -NoProfile -File ('{0}' -f ($MyInvocation.'InvocationName')) $args}
        exit $LASTEXITCODE
    }

    
    #region    Get SID and "Domain\Username" for Intune User only if $WriteToHKCUFromSystem
        # If running in Device Context as "NT Authority\System"
        if ($DeviceContext -and $Script:BoolIsSystem -and $BoolWriteToHKCUFromSystem) {
            # Help Variables
            $Script:RegistryLoadedProfiles = [string[]]@()
            $Local:SID                     = [string]::Empty
            $Local:LengthInterval          = [byte[]]@(40 .. 80)


            # Load User Profiles NTUSER.DAT (Registry) that is not available from current context
            $PathProfileList = [string]('Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProfileList')
            $SIDsProfileList = [string[]]($([string[]](Get-ChildItem -Path $PathProfileList -Recurse:$false).'Name').ForEach{$_.Split('\')[-1]}.Where{$_ -like 'S-1-12-*'})
            foreach ($SID in $SIDsProfileList) {
                if (Test-Path -Path ('Registry::HKEY_USERS\{0}' -f ($SID)) -ErrorAction 'SilentlyContinue') {
                    Write-Output -InputObject ('User with SID "{0}" is already logged in and/or NTUSER.DAT is loaded.' -f ($SID))
                }
                else {
                    Write-Output -InputObject ('User with SID "{0}" is not logged in, thus NTUSER.DAT is not loaded into registry.' -f ($SID))
                    
                    # Get User Directory
                    $PathUserDirectory = [string]$(Get-ItemProperty -Path ('{0}\{1}' -f ($PathProfileList,$SID)) -Name 'ProfileImagePath' | Select-Object -ExpandProperty 'ProfileImagePath')
                    if ([string]::IsNullOrEmpty($PathUserDirectory)) {
                        Throw ('ERROR: No User Directory was found for user with SID "{0}".' -f ($SID))
                    }

                    # Get User Registry File, NTUSER.DAT
                    $PathFileUserRegistry = ('{0}\NTUSER.DAT' -f ($PathUserDirectory))
                    if (-not(Test-Path -Path $PathFileUserRegistry)) {
                        Throw ('ERROR: "{0}" does not exist.' -f ($PathFileUserRegistry))
                    }

                    # Load NTUSER.DAT
                    $null = Start-Process -FilePath ('{0}\reg.exe' -f ([string]([system.environment]::SystemDirectory))) -ArgumentList ('LOAD "HKEY_USERS\{0}" "{1}"' -f ($SID,$PathFileUserRegistry)) -WindowStyle 'Hidden' -Wait
                    if (Test-Path -Path ('Registry::HKEY_USERS\{0}' -f ($SID))) {
                        Write-Output -InputObject ('{0}Successfully loaded "{1}".' -f ("`t",$PathFileUserRegistry))
                        $RegistryLoadedProfiles += @($SID)
                    }
                    else {
                        Throw ('ERROR: Failed to load registry hive for SID "{0}", NTUSER.DAT location "{1}".' -f ($SID,$PathFileUserRegistry))
                    }
                }
            }


            # Get Intune User Information from Registry
            $IntuneUser = [PSCustomObject]([PSCustomObject[]]@(
                foreach ($x in [string[]]@(Get-ChildItem -Path 'Registry::HKEY_USERS' -Recurse:$false -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'Name' | ForEach-Object {$_.Split('\')[-1]} | Where-Object {[bool]$($_ -like 'S-1-12-*') -and [bool]$(Test-Path -Path ('Registry::HKEY_USERS\{0}\Software\IronstoneIT\Intune\UserInfo' -f ($_)))})) {
                    [PSCustomObject]@{
                        'IntuneUserSID' =[string](Get-ItemProperty -Path ('Registry::HKEY_USERS\{0}\Software\IronstoneIT\Intune\UserInfo' -f ($x)) -Name 'IntuneUserSID' -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'IntuneUserSID');
                        'IntuneUserName'=[string](Get-ItemProperty -Path ('Registry::HKEY_USERS\{0}\Software\IronstoneIT\Intune\UserInfo' -f ($x)) -Name 'IntuneUserName' -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'IntuneUserName');
                        'DateSet'       =Try{[datetime](Get-ItemProperty -Path ('Registry::HKEY_USERS\{0}\Software\IronstoneIT\Intune\UserInfo' -f ($x)) -Name 'DateSet' -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'DateSet')}Catch{[datetime]::MinValue};
                    }
                }).Where{-not([string]::IsNullOrEmpty($_.'IntuneUserSID') -or [string]::IsNullOrEmpty($_.'IntuneUserName'))} | Sort-Object -Property 'DateSet' -Descending:$false | Select-Object -Last 1
            )


            # Get Intune User SID
            $null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrIntuneUserSID' -Value (
                [string]$(
                    $Local:SID = [string]::Empty
                    # Try by registry values in HKEY_CURRENT_USER\Software\IronstoneIT\Intune\UserInfo
                    if (-not([string]::IsNullOrEmpty([string]($IntuneUser | Select-Object -ExpandProperty 'IntuneUserSID')))) {
                        $Local:SID = [string]($IntuneUser | Select-Object -ExpandProperty 'IntuneUserSID')
                    }

                    # If no valid SID yet, try Registry::HKEY_USERS
                    if ([string]::IsNullOrEmpty($Local:SID) -or (-not($Local:LengthInterval.Contains([byte]$Local:SID.'Length'))) -or (-not(Test-Path -Path ('Registry::HKEY_USERS\{0}' -f ($Local:SID)) -ErrorAction 'SilentlyContinue'))) {
                        # Get all potential SIDs from Registry::HKEY_USERS
                        $Local:SIDsFromRegistryAll = [string[]]@(Get-ChildItem -Path 'Registry::HKEY_USERS' -Recurse:$false -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'Name' | ForEach-Object {$_.Split('\')[-1]} | Where-Object {$_ -like 'S-1-12-*' -and $_ -notlike '*_Classes' -and $Local:LengthInterval.Contains([byte]$_.'Length')})
                        $Local:SID = [string]$(
                            # If none where found - Return emtpy string: Finding SID by registry will not be possible
                            if (@($Local:SIDsFromRegistryAll).'Count' -le 0) {
                                [string]::Empty
                            }
                            # If only one where found - Return it
                            elseif (@($Local:SIDsFromRegistryAll).'Count' -eq 1) {
                                [string]([string[]]@($Local:SIDsFromRegistryAll | Select-Object -First 1))
                            }
                            # If multiple where found - Try to filter out unwanted SIDs
                            else {
                                # Try to get all where IronstoneIT folder exist withing HKU (HKCU) registry
                                $Local:SIDs = [string[]]@($([string[]]@($Local:SIDsFromRegistryAll)).Where{Test-Path -Path ('Registry::HKEY_USERS\{0}\Software\IronstoneIT' -f ($_))})
                                # If none or more than 1 where found - Try getting only SIDs with AAD joined info in HKU (HKCU) registry
                                if (@($Local:SIDs).'Count' -le 0 -or @($Local:SIDs).'Count' -ge 2) {
                                    $Local:SIDs = [string[]]@($([string[]]@($Local:SIDsFromRegistryAll)).Where{Test-Path -Path ('Registry::HKEY_USERS\{0}\Software\Microsoft\Windows NT\CurrentVersion\WorkplaceJoin\AADNGC' -f ($_))})
                                }
                                # If none or more than 1 where found - Try matching Tenant ID for AAD joined HKLM with Tenant ID for AAD joined HKU (HKCU)
                                if (@($Local:SIDs).'Count' -le 0 -or @($Local:SIDs).'Count' -ge 2) {
                                    if (-not([string]::IsNullOrEmpty(($Local:TenantGUIDFromHKLM = [string]$($x='Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\CloudDomainJoin\JoinInfo'; Get-ItemProperty -Path ('{0}\{1}' -f ($x,[string](Get-ChildItem -Path $x -Recurse:$false -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'Name' | ForEach-Object {$_.Split('\')[-1]}))) -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'TenantId'))))) {
                                        $Local:SIDs = [string[]]@($([string[]]@($Local:SIDsFromRegistryAll)).Where{$Local:TenantGUIDFromHKLM -eq ([string]$($x=[string]('Registry::HKEY_USERS\{0}\Software\Microsoft\Windows NT\CurrentVersion\WorkplaceJoin\AADNGC' -f ($_)); Get-ItemProperty -Path ('{0}\{1}' -f ($x,([string](Get-ChildItem -Path $x -Recurse:$false -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'Name' | ForEach-Object {$_.Split('\')[-1]})))) -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'TenantDomain'))})
                                    }
                                }
                                if(@($Local:SIDs).'Count' -eq 1){
                                    [string]([string[]]@($Local:SIDs | Select-Object -First 1))
                                }
                                else{
                                    [string]::Empty
                                }
                            }
                        )
                    }

                    # If no valid SID yet, try by running process "Explorer"
                    if ([string]::IsNullOrEmpty($Local:SID) -or (-not($Local:LengthInterval.Contains([byte]$Local:SID.'Length'))) -or (-not(Test-Path -Path ('Registry::HKEY_USERS\{0}' -f ($Local:SID)) -ErrorAction 'SilentlyContinue'))) {
                        $Local:SID = [string]$(
                            $Local:UN = [string]([string[]]@(Get-WmiObject -Class 'Win32_Process' -Filter "Name='Explorer.exe'" -ErrorAction 'SilentlyContinue' | ForEach-Object {$($Owner = $_.GetOwner();if($Owner.'ReturnValue' -eq 0 -and $Owner.'Domain' -notlike 'nt *' -and $Owner.'Domain' -notlike 'nt-*'){('{0}\{1}' -f ($Owner.'Domain',$Owner.'User'))})}) | Select-Object -Unique -First 1)
                            if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.'Length' -lt 3) {
                                $Local:UN = [string]([string[]]@(Get-Process -Name 'explorer' -IncludeUserName -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'UserName' | Where-Object {$_ -notlike 'nt *' -and $_ -notlike 'nt-*'}) | Select-Object -Unique -First 1)
                            }
                            if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.'Length' -lt 3) {
                                [string]::Empty
                            }
                            else {
                                Try{
                                    $Local:SID = [string]$([System.Security.Principal.NTAccount]::new($Local:UN).Translate([System.Security.Principal.SecurityIdentifier]).'Value')
                                    if ([string]::IsNullOrEmpty($Local:SID) -or (-not($Local:LengthInterval.Contains([byte]$Local:SID.'Length'))) -or (-not(Test-Path -Path ('Registry::HKEY_USERS\{0}' -f ($Local:SID)) -ErrorAction 'SilentlyContinue'))) {
                                        [string]::Empty
                                    }
                                    else {
                                        $Local:SID
                                    }
                                }
                                catch{
                                    [string]::Empty
                                }
                            }
                        )
                    }
                
                    # If no valid SID yet, throw error
                    if ([string]::IsNullOrEmpty($Local:SID) -or (-not($Local:LengthInterval.Contains([byte]$Local:SID.'Length'))) -or (-not(Test-Path -Path ('Registry::HKEY_USERS\{0}' -f ($Local:SID)) -ErrorAction 'SilentlyContinue'))) {
                        Throw 'ERROR: Did not manage to get Intune user SID from SYSTEM context'
                    }

                    # If valid SID, return it
                    else {
                        $Local:SID
                    }         
                )
            )
        

            # Get Intune User Domain\UserName
            $null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrIntuneUserName' -Value (
                [string]$(
                    # Help Variables
                    $Local:UN = [string]::Empty

                    # Try by registry values in HKEY_CURRENT_USER\Software\IronstoneIT\Intune\UserInfo
                    if (-not([string]::IsNullOrEmpty($IntuneUser.'IntuneUserName'))) {
                        $Local:UN = [string]($IntuneUser.'IntuneUserName')
                    }
                
                    # If no valid UN yet, try by convert $Script:StrIntuneUserSID to "Domain\Username"
                    if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.'Length' -lt 3 -and (-not([string]::IsNullOrEmpty($Script:StrIntuneUserSID)))) {
                        $Local:UN = [string]$(Try{[System.Security.Principal.SecurityIdentifier]::new($Script:StrIntuneUserSID).Translate([System.Security.Principal.NTAccount]).'Value'}Catch{[string]::Empty})
                    }

                    # If no valid UN yet, try by Registry::HKEY_USERS\$Script:StrIntuneUserSID\Volatile Environment
                    if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.'Length' -lt 3-and (-not([string]::IsNullOrEmpty($Script:StrIntuneUserSID)))) {
                        $Local:UN = [string]$(Try{$Local:x = Get-ItemProperty -Path ('Registry::HKEY_USERS\{0}\Volatile Environment' -f ($Script:StrIntuneUserSID)) -Name 'USERDOMAIN','USERNAME' -ErrorAction 'SilentlyContinue';('{0}\{1}' -f ([string]($Local:x | Select-Object -ExpandProperty 'USERDOMAIN'),[string]($Local:x | Select-Object -ExpandProperty 'USERNAME')))}Catch{[string]::Empty})
                    }
                
                    # If no valid UN yet, try by running process Explorer.exe - Method 1
                    if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.'Length' -lt 3) {
                        $Local:UN = [string]([string[]]@(Get-WmiObject -Class 'Win32_Process' -Filter "Name='Explorer.exe'" -ErrorAction 'SilentlyContinue' | ForEach-Object -Process {$($Owner = $_.GetOwner();if($Owner.'ReturnValue' -eq 0 -and $Owner.'Domain' -notlike 'nt *' -and $Owner.'Domain' -notlike 'nt-*'){('{0}\{1}' -f ($Owner.'Domain',$Owner.'User'))})}) | Select-Object -Unique -First 1)
                    }
                
                    # If no valid UN yet, try by running process Explorer.exe - Method 2
                    if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.'Length' -lt 3) {
                        $Local:UN = [string]([string[]]@(Get-Process -Name 'explorer' -IncludeUserName -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'UserName' | Where-Object -FilterScript {$_ -notlike 'nt *' -and $_ -notlike 'nt-*'}) | Select-Object -Unique -First 1)
                    }                   

                    # If no valid UN yet, throw Error
                    if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.'Length' -lt 3) {
                        Throw 'ERROR: Did not manage to get "Domain"\"UserName" for Intune User.'
                    }

                    # If valid UN, return it
                    else {
                        $Local:UN
                    }
                )
            )
        }
        

        # If running in User Context / Not running as "NT Authority\System"
        elseif ((-not($DeviceContext)) -and (-not($Script:BoolIsSystem))) {
            $null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrIntuneUserSID' -Value ([string]([System.Security.Principal.WindowsIdentity]::GetCurrent().'User'.'Value'))
            $null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrIntuneUserName' -Value ([string]([System.Security.Principal.WindowsIdentity]::GetCurrent().'Name'))
            $null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrIntuneUserPrincipalName' -Value ([string]$(Try{$O=&('{0}\whoami.exe'-f([System.Environment]::GetFolderPath('System')))'/upn';if($?){$O}else{''}}Catch{''}))

            #region    Write SID, UserName and UserPrincipalName to HKCU if running in User Context
                # Assets
                $Local:RegPath   = [string]('Registry::HKEY_CURRENT_USER\Software\IronstoneIT\Intune\UserInfo')
                $Local:RegNames  = [string[]]@('IntuneUserSID','IntuneUserName','IntuneUserPrincipalName','DateSet')
                $Local:RegValues = [string[]]@($Script:StrIntuneUserSID,$Script:StrIntuneUserName,$Script:StrIntuneUserPrincipalName,[string]([datetime]::Now.ToString('o')))

                # Get Current Info
                $Local:CurrentUserSID           = [string](Get-ItemProperty -Path $Local:RegPath -Name $Local:RegNames[0] -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty $Local:RegNames[0] -ErrorAction 'SilentlyContinue')
                $Local:CurrentUserName          = [string](Get-ItemProperty -Path $Local:RegPath -Name $Local:RegNames[1] -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty $Local:RegNames[1] -ErrorAction 'SilentlyContinue')
                $Local:CurrentUserPrincipalName = [string](Get-ItemProperty -Path $Local:RegPath -Name $Local:RegNames[2] -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty $Local:RegNames[1] -ErrorAction 'SilentlyContinue')
                $Local:CurrentUserDateSet       = [datetime]$(Try{[datetime](Get-ItemProperty -Path $Local:RegPath -Name $Local:RegNames[2] -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty $Local:RegNames[2] -ErrorAction 'SilentlyContinue')}catch{[datetime]::MinValue})

                # Set Info if any of the values does not match wanted values
                if (
                    [bool]((-not[string]::IsNullOrEmpty($Local:RegValues[0])) -and $Local:RegValues[0] -ne $Local:CurrentUserSID) -or
                    [bool]((-not[string]::IsNullOrEmpty($Local:RegValues[1])) -and $Local:RegValues[1] -ne $Local:CurrentUserName) -or
                    [bool]((-not[string]::IsNullOrEmpty($Local:RegValues[2])) -and $Local:RegValues[2] -ne $Local:CurrentUserPrincipalName) -or
                    $Local:CurrentUserDateSet -eq [datetime]::MinValue
                ) {      
                    # Create path if not exist
                    if (-not(Test-Path -Path $Local:RegPath)) {
                        $null = New-Item -Path $Local:RegPath -Force -ErrorAction 'Stop'
                    }
                    # Set registry values
                    foreach ($x in [byte[]]@(0 .. [byte]($Local:RegNames.'Length' - 1))) {
                        if (-not[string]::IsNullOrEmpty($Local:RegValues[$x])) {
                            $null = Set-ItemProperty -Path $Local:RegPath -Name $Local:RegNames[$x] -Value $Local:RegValues[$x] -Force -ErrorAction 'Stop'
                        }
                    }
                }
            #endregion Write SID and UserName to HKCU if running in User Context
        }
        
        
        # Output Intune User and SID if found
        if (-not([string]::IsNullOrEmpty($Script:StrIntuneUserSID))) {
            Write-Output -InputObject ('Intune User SID "{0}", Username "{1}".' -f ($Script:StrIntuneUserSID,$Script:StrIntuneUserName))
        }
    #endregion Get SID and "Domain\Username" for Intune User



    # End the Initialize Region
    Write-Output -InputObject ('**********************')
#endregion Don't Touch This
################################################
#region    Your Code Here
################################################



#region    Variables
    # Settings
    $Script:ReadOnly           = [bool]$($false)

    # Files
    #region Files
        # Enable-BitLockerTrigger.PS1
        #region FilePS1
        $Script:NameFilePS1    = [string]$('Enable_BitLocker.ps1')
        $Script:ContentFilePS1 = [string]$('I1JlcXVpcmVzIC1SdW5Bc0FkbWluaXN0cmF0b3IKPCMgCiAgICAuU1lOT1BTSVMKICAgICAgICBFbmFibGVzIEJpdExvY2tlciBhbmQgYmFja3VwcyBSZWNvdmVyeSBQYXNzd29yZCB0byBib3RoIEF6dXJlIEFEIGFuZCBPbmVEcml2ZSBmb3IgQnVzaW5lc3MuCgogICAgLkRFU0NSSVBUSU9OIAogICAgICAgIEVuYWJsZXMgQml0TG9ja2VyIGFuZCBiYWNrdXBzIFJlY292ZXJ5IFBhc3N3b3JkIHRvIGJvdGggQXp1cmUgQUQgYW5kIE9uZURyaXZlIGZvciBCdXNpbmVzcy4KICAgICAgICAgICAgKiBEZXNpZ25lZCBmb3IgSW50dW5lIE1ETSBtYW5hZ2VkLCBBenVyZSBBRCBqb2luZWQgZGV2aWNlcy4KICAgICAgICAgICAgKiBDb250aW5vdXNseSBtb25pdG9ycyBCaXRMb2NrZXIgc3RhdHVzLgogICAgICAgICAgICAgICAgKiBXaWxsIHJlLWVuYWJsZSBpZiBCaXRMb2NrZXIgZ2V0cyBkaXNhYmxlZC4KICAgICAgICAgICAgICAgICogV2lsbCBiYWNrdXAgbmV3IFJlY292ZXJ5IFBhc3N3b3JkcyBpZiBub3QgYWxyZWFkeSBiYWNrZWQgdXAuCiM+CgoKIyBJbnB1dCBwYXJhbWV0ZXJzCltPdXRwdXRUeXBlKCRudWxsKV0KW0NtZGxldEJpbmRpbmcoKV0KcGFyYW0oKQoKCiMgSW1wb3J0IEJpdExvY2tlciBtb2R1bGUgLSBSZXF1aXJlbWVudAppZiAoW2J5dGVdJChHZXQtTW9kdWxlIC1OYW1lICdCaXRMb2NrZXInIC1FcnJvckFjdGlvbiAnU2lsZW50bHlDb250aW51ZScgfCBNZWFzdXJlLU9iamVjdCB8IFNlbGVjdC1PYmplY3QgLUV4cGFuZFByb3BlcnR5ICdDb3VudCcpIC1sZSAwKSB7CiAgICAkbnVsbCA9IEltcG9ydC1Nb2R1bGUgLU5hbWUgJ0JpdExvY2tlcicgLURpc2FibGVOYW1lQ2hlY2tpbmcgLUVycm9yQWN0aW9uICdTdG9wJwp9CgoKIyBNYWtlIHN1cmUgYWxsIG5ldHdvcmsgdHJhZmZpYyBnZW5lcmFjdGVkIGluIHRoaXMgc2NyaXB0IHVzZXMgVExTIDEuMgpbTmV0LlNlcnZpY2VQb2ludE1hbmFnZXJdOjpTZWN1cml0eVByb3RvY29sID0gW05ldC5TZWN1cml0eVByb3RvY29sVHlwZV06OlRsczEyCltTeXN0ZW0uTmV0LlNlcnZpY2VQb2ludE1hbmFnZXJdOjpTZWN1cml0eVByb3RvY29sID0gW1N5c3RlbS5OZXQuU2VjdXJpdHlQcm90b2NvbFR5cGVdOjpUbHMxMgoKCiNyZWdpb24gU2V0dGluZ3MgYW5kIFZhcmlhYmxlcwogICAgIyBTZXR0aW5ncyAgIAogICAgIyMgUmVtb3ZlIGZpbGVzIGFmdGVyIHN1Y2Nlc3MKICAgICMjIyBJZiBvbiwgd2lsbCByZW1vdmUgYWxsIGZpbGVzIGFmdGVyIGZpcnN0IHN1Y2Nlc3MuCiAgICAkbnVsbCA9IE5ldy1WYXJpYWJsZSAtT3B0aW9uICdSZWFkT25seScgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSAtTmFtZSAnQm9vbFJlbW92ZUZpbGVzQWZ0ZXJTdWNjZXNzJyAtVmFsdWUgKFtib29sXSRmYWxzZSkKICAgIAogICAgIyMgUmVtb3ZlIHNjZWhkdWxlZCB0YXNrIGFmdGVyIHN1Y2Nlc3MKICAgICMjIyBJZiBmYWxzZSwgd2lsbCBjaGFuZ2Ugc2NoZWR1bGVkIHRhc2sgdG8gcnVuIG9uY2UgYSBkYXkgYXQgMTI6MDAgYWZ0ZXIgZmlyc3Qgc3VjY2Vzc2Z1bGwgcnVuLCBvciBhZnRlciAzMCBmYWlsZWQgcnVucwogICAgIyMjIElmIHRydWUsIHdpbGwgZGVsZXRlIHNjaGVkdWxlZCB0YXNrIGFmdGVyIGZpcnN0IHN1Y2Nlc3NmdWxsIHJ1biBhbmQgYWZ0ZXIgMzAgZmFpbGVkIHJ1bnMKICAgICRudWxsID0gTmV3LVZhcmlhYmxlIC1PcHRpb24gJ1JlYWRPbmx5JyAtU2NvcGUgJ1NjcmlwdCcgLUZvcmNlIC1OYW1lICdCb29sUmVtb3ZlU2NoZWR1bGVkVGFza0FmdGVyRmlyc3RTdWNjZXNzJyAtVmFsdWUgKFtib29sXSRmYWxzZSkKICAgIAogICAgIyMgQmFja3VwIHRvIE9uZURyaXZlCiAgICAjIyMgSWYgdHJ1ZSB3aWxsIGJhY2t1cCB0byBPbmVEcml2ZSBmb3IgQnVzaW5lc3MsIHdpbGwgbm90IGNvdW50IGFzIHN1Y2Nlc3NmdWwgcnVuIGJlZm9yZSB0aGlzIHN0ZXAgaGFzIGNvbXBsZXRlZCBzdWNjZXNzZnVsbHkKICAgICMjIyBJZiBmYWxzZSB3aWxsIHNrdXAgYmFja3VwIHRvIE9uZURyaXZlIGZvciBCdXNpbmVzcwogICAgJG51bGwgPSBOZXctVmFyaWFibGUgLU9wdGlvbiAnUmVhZE9ubHknIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgLU5hbWUgJ0Jvb2xCYWNrdXBUb09uZURyaXZlRm9yQnVzaW5lc3MnIC1WYWx1ZSAoW2Jvb2xdJHRydWUpCiAgICAKICAgICMjIFNraXAgaGFyZHdhcmUgdGVzdCBpZiBuZXdseSBlbnJvbGxlZAogICAgIyMjIElmIHRydWUsIHdpbGwgc2tpcCBoYXJkd2FyZSB0ZXN0IHdoZW4gZW5hYmxpbmcgQml0TG9ja2VyIG9uIG5ld2x5IGVucm9sbGVkIEludHVuZSBkZXZpY2UuCiAgICAjIyMgSWYgZmFsc2UsIHdpbGwgbm90LgogICAgJG51bGwgPSBOZXctVmFyaWFibGUgLU9wdGlvbiAnUmVhZE9ubHknIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgLU5hbWUgJ0Jvb2xTa2lwSGFyZHdhcmVUZXN0T25OZXdseUVucm9sbGVkRGV2aWNlJyAtVmFsdWUgKFtib29sXSR0cnVlKQoKCgogICAgIyBWYXJpYWJsZXMKICAgICMjIFNjcmlwdAogICAgJG51bGwgPSBOZXctVmFyaWFibGUgLU9wdGlvbiAnUmVhZE9ubHknIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgLU5hbWUgJ05hbWVTY3JpcHQnIC1WYWx1ZSAkKFtzdHJpbmddJCgnSXJvblRyaWdnZXInKSkKICAgICRudWxsID0gTmV3LVZhcmlhYmxlIC1PcHRpb24gJ1JlYWRPbmx5JyAtU2NvcGUgJ1NjcmlwdCcgLUZvcmNlIC1OYW1lICdTY2hlZHVsZWRUYXNrTmFtZScgLVZhbHVlICQoW3N0cmluZ10kKCRTY3JpcHQ6TmFtZVNjcmlwdC5DbG9uZSgpKSkKICAgICRudWxsID0gTmV3LVZhcmlhYmxlIC1PcHRpb24gJ1JlYWRPbmx5JyAtU2NvcGUgJ1NjcmlwdCcgLUZvcmNlIC1OYW1lICdEaXJJbnN0YWxsJyAtVmFsdWUgJChbc3RyaW5nXSQoJ3swfVxQcm9ncmFtIEZpbGVzXElyb25zdG9uZUlUXHsxfVwnIC1mICgkZW52OlN5c3RlbURyaXZlLCRTY3JpcHQ6TmFtZVNjcmlwdCkpKQogICAgJG51bGwgPSBOZXctVmFyaWFibGUgLU9wdGlvbiAnUmVhZE9ubHknIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgLU5hbWUgJ0RpckxvZycgLVZhbHVlICQoW3N0cmluZ10kKCd7MH1cUHJvZ3JhbSBGaWxlc1xJcm9uc3RvbmVJVFxJbnR1bmVcRGV2aWNlQ29uZmlndXJhdGlvblwnIC1mICgkZW52OlN5c3RlbURyaXZlKSkpCiAgICAkbnVsbCA9IE5ldy1WYXJpYWJsZSAtT3B0aW9uICdSZWFkT25seScgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSAtTmFtZSAnRmlsZUxvZycgLVZhbHVlICQoW3N0cmluZ10kKCd7MH1Jcm9uVHJpZ2dlciAtIEVuYWJsZUJpdExvY2tlci5sb2cnIC1mICgkU2NyaXB0OkRpckxvZykpKQogICAgJG51bGwgPSBOZXctVmFyaWFibGUgLU9wdGlvbiAnUmVhZE9ubHknIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgLU5hbWUgJ0ZpbGVTdGF0cycgLVZhbHVlICQoW3N0cmluZ10kKCd7MH1zdGF0cy50eHQnIC1mICgkU2NyaXB0OkRpckluc3RhbGwpKSkKICAgIAogICAgIyMgSGVscAogICAgIyMjIFN0YXRpYyAvIFJlYWRPbmx5CiAgICAkbnVsbCA9IE5ldy1WYXJpYWJsZSAtT3B0aW9uICdSZWFkT25seScgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSAtTmFtZSAnT1NEcml2ZUxldHRlcicgLVZhbHVlICQoW3N0cmluZ10kKCRlbnY6U3lzdGVtRHJpdmUuVHJpbSgnOicpLlRvVXBwZXIoKSkpCiAgICAkbnVsbCA9IE5ldy1WYXJpYWJsZSAtT3B0aW9uICdSZWFkT25seScgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSAtTmFtZSAnQ29tcHV0ZXJOYW1lJyAtVmFsdWUgJChbc3RyaW5nXSQoW3N0cmluZ1tdXSQoW3N0cmluZ10oJGVudjpDT01QVVRFUk5BTUUpLlRyaW0oKSxbc3RyaW5nXShbU3lzdGVtLkVudmlyb25tZW50XTo6TWFjaGluZU5hbWUpLlRyaW0oKSAtbmUgW3N0cmluZ106OkVtcHR5KVswXSkpCiAgICAkbnVsbCA9IE5ldy1WYXJpYWJsZSAtT3B0aW9uICdSZWFkT25seScgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSAtTmFtZSAnQml0TG9ja2VyVm9sdW1lRW5jcnlwdGlvblN0YXR1c2VzJyAtVmFsdWUgJChbc3RyaW5nW11dJCgnRnVsbHlEZWNyeXB0ZWQnLCdFbmNyeXB0aW9uSW5Qcm9ncmVzcycsJ0Z1bGx5RW5jcnlwdGVkJykpCiAgICAjIyMgRHluYW1pYwogICAgJFNjcmlwdDpCb29sRGlkQW55dGhpbmdDaGFuZ2VUaGlzUnVudGltZSA9IFtib29sXSQoJGZhbHNlKSAgICAKI2VuZHJlZ2lvbiBTZXR0aW5ncyBhbmQgVmFyaWFibGVzCgoKCiNyZWdpb24gRnVuY3Rpb25zCiAgICAjcmVnaW9uIExvZ2dpbmcgYW5kIE91dHB1dAogICAgICAgICNyZWdpb24gTG9nV3JpdGUKICAgICAgICBGdW5jdGlvbiBMb2dXcml0ZSB7CiAgICAgICAgICAgIFBhcmFtICgKICAgICAgICAgICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJHRydWUpXQogICAgICAgICAgICAgICAgW1ZhbGlkYXRlTm90TnVsbE9yRW1wdHkoKV0KICAgICAgICAgICAgICAgIFtzdHJpbmddICRMb2dTdHJpbmcKICAgICAgICAgICAgKQoKICAgICAgICAgICAgIyBDcmVhdGUgdmFyaWFibGVzCiAgICAgICAgICAgICREYXRlVGltZSAgPSBbc3RyaW5nXSQoW1N5c3RlbS5EYXRlVGltZV06Ok5vdy5Ub1N0cmluZygneXlNTWRkIEhIOm1tOnNzOmZmJykpCiAgICAgICAgICAgICRMb2dTdHJpbmcgPSBbc3RyaW5nXSQoJ3swfSB7MX0nIC1mICgkRGF0ZVRpbWUsJExvZ1N0cmluZykpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEFkZCBjb250ZW50IHRvIGxvZyBmaWxlCiAgICAgICAgICAgIEFkZC1jb250ZW50IC1QYXRoICRTY3JpcHQ6RmlsZUxvZyAtVmFsdWUgJExvZ1N0cmluZyAtRW5jb2RpbmcgJ3V0ZjgnCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE91dHB1dCBjb250ZW50IHRvIGNvbnNvbGUKICAgICAgICAgICAgV3JpdGUtT3V0cHV0IC1JbnB1dE9iamVjdCAkTG9nU3RyaW5nCiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gTG9nV3JpdGUKCiAgICAgICAgI3JlZ2lvbiBMb2dFcnJvcnMKICAgICAgICBGdW5jdGlvbiBMb2dFcnJvcnMgewogICAgICAgICAgICBMb2dXcml0ZSAoJ0NhdWdodCBhbiBleGNlcHRpb246JykKICAgICAgICAgICAgTG9nV3JpdGUgKCdFeGNlcHRpb24gVHlwZTogICAgezB9JyAtZiAoJF8uJ0V4Y2VwdGlvbicuR2V0VHlwZSgpLidGdWxsTmFtZScpKQogICAgICAgICAgICBMb2dXcml0ZSAoJ0V4Y2VwdGlvbiBNZXNzYWdlOiB7MH0nIC1mICgkXy4nRXhjZXB0aW9uJy4nTWVzc2FnZScpKQogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIExvZ0Vycm9ycwoKCiAgICAgICAgI3JlZ2lvbiBXcml0ZS1TdGF0cwogICAgICAgICMgV3JpdGUtU3RhdHM6IE91dHB1dHMgY3VycmVudCBzdGF0dXMgb2YgdmFyaW91cyBib29sZWFucyBhbmQgb3RoZXIgbWVhc3VyZW1lbnRzCiAgICAgICAgRnVuY3Rpb24gV3JpdGUtU3RhdHMgeyAgICAKICAgICAgICAgICAgUGFyYW0oCiAgICAgICAgICAgICAgICBbcGFyYW1ldGVyKE1hbmRhdG9yeT0kZmFsc2UpXQogICAgICAgICAgICAgICAgW2Jvb2xdICRQcmV2aW91c09ubHkgPSAkZmFsc2UKICAgICAgICAgICAgKQogICAgICAgICAgICAjIEdlbmVyYWwKICAgICAgICAgICAgaWYgKCRQcmV2aW91c09ubHkpIHsKICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnUnVuczogezB9IHwgSGFzIElyb25UcmlnZ2VyIGhhZCBhIHN1Y2Nlc3NmdWxsIHJ1biBhbHJlYWR5PyB7MX0nIC1mICgkU2NyaXB0OkNvdW50UnVucywkU2NyaXB0OklzRmluaXNoZWQxc3RUaW1lKSkKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBPUyBEcml2ZQogICAgICAgICAgICBMb2dXcml0ZSAoJ09TIGRyaXZlICh7MH0pIHwgRW5jcnlwdGVkOiB7MX0gfCBSZWNvdmVyeSBQYXNzd29yZHMgcHJlc2VudDogezJ9IHwgQmFja3VwIHRvIE9uZURyaXZlOiB7M30gfCBCYWNrdXAgdG8gQXp1cmVBRDogezR9JyAtZiAoJE9TRHJpdmVMZXR0ZXIsJFNjcmlwdDpJc0VuY3J5cHRlZCwkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3LCRTY3JpcHQ6SXNCYWNrdXBPRCwkU2NyaXB0OklzQmFja3VwQUFEKSkKICAgICAgICAgICAgaWYgKC1ub3QoJFByZXZpb3VzT25seSkpIHsKICAgICAgICAgICAgICAgIExvZ3dyaXRlICgnT1MgZHJpdmUgKHswfSkgfCBWb2x1bWVTdGF0dXM6IHsxfSB8IFByb3RlY3Rpb25TdGF0dXM6IHsyfScgLWYgKCRPU0RyaXZlTGV0dGVyLCRTY3JpcHQ6Vm9sdW1lRW5jcnlwdGlvblN0YXR1cywkU2NyaXB0OlZvbHVtZVByb3RlY3Rpb25TdGF0dXMpKSAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKCRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFcpIHsKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ09TIGRyaXZlICh7MH0pIHwgUHJlc2VuY2Ugb2YgQml0TG9ja2VyIEtleVByb3RlY3RvciB8IFRQTTogezF9IHwgUmVjb3ZlcnlQYXNzd29yZDogezJ9JyAtZiAoJE9TRHJpdmVMZXR0ZXIsJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1swXSwkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzFdKSkKICAgICAgICAgICAgICAgICAgICBpZiAoJFNjcmlwdDpWb2x1bWVFbmNyeXB0aW9uU3RhdHVzWzFdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnT1MgZHJpdmUgKHswfSkgfCB7MX0nIC1mICgkT1NEcml2ZUxldHRlciwoV3JpdGUtUmVjb3ZlcnlQYXNzd29yZCkpKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE90aGVyIGZpeGVkIGRyaXZlcyB3aXRoIGEgZHJpdmUgbGV0dGVyCiAgICAgICAgICAgICAgICA8IyAjVE9ETwogICAgICAgICAgICAgICAgaWYgKCRTY3JpcHQ6T3RoZXJFbmNyeXB0ZWREcml2ZXMpIHsKICAgICAgICAgICAgICAgICAgICAkU2NyaXB0Ok90aGVyRW5jcnlwdGVkRHJpdmVzIHwgRm9yRWFjaC1PYmplY3QgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoLW5vdChbc3RyaW5nXTo6SXNOdWxsT3JFbXB0eSgkU2NyaXB0Ok90aGVyRW5jcnlwdGVkRHJpdmVzWzBdKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtzdHJpbmddICRMb2NhbDpEcml2ZVZvbHVtZVN0YXR1cyA9IChHZXQtVmFyaWFibGUgLU5hbWUgKCdWb2x1bWV7MH1FbmNTdGF0dXMnIC1mICRfKSAtU2NvcGUgJ1NjcmlwdCcpLlZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6RHJpdmVQcm90ZWN0aW9uU3RhdHVzID0gKEdldC1WYXJpYWJsZSAtTmFtZSAoJ1ZvbHVtZXswfVByb3RlY3Rpb25TdGF0dXMnIC1mICRfKSAtU2NvcGUgJ1NjcmlwdCcpLlZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMb2d3cml0ZSAoJ1N0YXR1cyBkcml2ZSAiezB9IiB8IFZvbHVtZVN0YXR1czogezF9IHwgUHJvdGVjdGlvblN0YXR1czogezJ9JyAtZiAoJF8sJExvY2FsOkRyaXZlVm9sdW1lU3RhdHVzLCRMb2NhbDpEcml2ZVByb3RlY3Rpb25TdGF0dXMpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgW2Jvb2xbXV0gJExvY2FsOktleVByb3RlY3RvclR5cGVzID0gR2V0LUJpdExvY2tlcktleVByb3RlY3RvclR5cGVzIC1Ecml2ZUxldHRlciAkXwogICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdCaXRMb2NrZXIgS2V5UHJvdGVjdG9yIFR5cGVzIHByZXNlbnQgZm9yIGRyaXZlICJ7MH0iPyB8IFRQTTogezF9IHwgUmVjb3ZlcnlQYXNzd29yZDogezJ9JyAtZiAoJF8sJExvY2FsOktleVByb3RlY3RvclR5cGVzWzBdLCRMb2NhbDpLZXlQcm90ZWN0b3JUeXBlc1sxXSkpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9Iz4KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIFdyaXRlLVN0YXRzCgoKICAgICAgICAjcmVnaW9uIFdyaXRlLVJlY292ZXJ5UGFzc3dvcmQKICAgICAgICAjIFdyaXRlLVJlY292ZXJ5UGFzc3dvcmQKICAgICAgICBGdW5jdGlvbiBXcml0ZS1SZWNvdmVyeVBhc3N3b3JkIHsKICAgICAgICAgICAgJExvY2FsOkMgPSBbYnl0ZV0kKGlmKCRTY3JpcHQ6Q291bnRSZWNvdmVyeVBhc3N3b3Jkcyl7JFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzfWVsc2V7MH0pCiAgICAgICAgICAgIFJldHVybiAoW3N0cmluZ10kKCd7MH0gUmVjb3ZlcnkgUGFzc3dvcmQocykgcHJlc2VudC57MX0nIC1mICgkTG9jYWw6QywoJChpZigkTG9jYWw6QyAtZ2UgMSl7J3swfXsxfScgLWYgKCJgcmBuIiwoR2V0LVN0cmluZ1JlY292ZXJ5UGFzc3dvcmRzKSl9KSkpKSkKICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBXcml0ZS1SZWNvdmVyeVBhc3N3b3JkCgoKICAgICAgICAjcmVnaW9uIEdldC1TdHJpbmdSZWNvdmVyeVBhc3N3b3JkcwogICAgICAgICMgUmV0dXJucyBhIHN0cmluZyBjb250YWluaW5nIHRoZSByZWNvdmVyeSBwYXNzd29yZHMgZnJvbSAkU2NyaXB0OkFycmF5UmVjb3ZlcnlQYXNzd29yZHMuIFVzZWZ1bGwgZm9yIHByaW50aW5nLyBsb2dnaW5nLyBiYWNrdXAKICAgICAgICBGdW5jdGlvbiBHZXQtU3RyaW5nUmVjb3ZlcnlQYXNzd29yZHMgewogICAgICAgICAgICBQYXJhbSgKICAgICAgICAgICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5PSRmYWxzZSldCiAgICAgICAgICAgICAgICBbVmFsaWRhdGVOb3ROdWxsT3JFbXB0eSgpXQogICAgICAgICAgICAgICAgW3N0cmluZ10gJERyaXZlTGV0dGVyID0gJE9TRHJpdmVMZXR0ZXIKICAgICAgICAgICAgKQoKICAgICAgICAgICAgIyBWYWxpZGF0ZSBJbnB1dAogICAgICAgICAgICAkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlciA9IFtzdHJpbmddJCgkRHJpdmVMZXR0ZXIuVHJpbSgnOicpLlRvVXBwZXIoKSkKICAgICAgICAgICAgaWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyLidMZW5ndGgnIC1ndCAxKSB7CiAgICAgICAgICAgICAgICBUaHJvdyAnRVJST1I6IERyaXZlIGxldHRlciBjYW5ub3QgYmUgbW9yZSB0aGFuIG9uZSBsZXR0ZXInCiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAjIENyZWF0ZSB2YXJpYWJsZSBuYW1lcwogICAgICAgICAgICAkTG9jYWw6QXJyYXlOYW1lICAgICA9IFtzdHJpbmddJCgnezB9QXJyYXlSZWNvdmVyeVBhc3N3b3JkcycgLWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyKSkKCgogICAgICAgICAgICAjIEdldCBBcnJheSwgbG9vcCBpdC4gSWRlYWxseSBvbmx5IG9uZSBwdywgYnV0IGxvb3AganVzdCB0byBiZSBzYWZlLgogICAgICAgICAgICAkTG9jYWw6VGVtcENvdW50ZXIgPSBbdWludDE2XSQoMCkKICAgICAgICAgICAgJExvY2FsOk91dFN0ciA9IFtzdHJpbmddOjpFbXB0eQogICAgICAgICAgICAoR2V0LVZhcmlhYmxlIC1OYW1lICRMb2NhbDpBcnJheU5hbWUgLVNjb3BlICdTY3JpcHQnIC1WYWx1ZU9ubHkpIHwgRm9yRWFjaC1PYmplY3QgewogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciArPSAoJ3swfSB8IEtleVByb3RlY3RvcklkICJ7MX0iIHwgUmVjb3ZlcnlQYXNzd29yZCAiezJ9IicgLWYgKCgkTG9jYWw6VGVtcENvdW50ZXIgKz0gMSksJF8uS2V5UHJvdGVjdG9ySWQsJF8uUmVjb3ZlcnlQYXNzd29yZCkpCiAgICAgICAgICAgICAgICBpZiAoJExvY2FsOlRlbXBDb3VudGVyIC1sdCAoKEdldC1WYXJpYWJsZSAtTmFtZSAkTG9jYWw6QXJyYXlOYW1lIC1TY29wZSAnU2NyaXB0JykuVmFsdWUpLkNvdW50KSB7JExvY2FsOk91dFN0ciArPSAiYHJgbiJ9CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAjIFJldHVybiB0aGUgc3RyaW5nCiAgICAgICAgICAgIFJldHVybiAkTG9jYWw6T3V0U3RyCiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gR2V0LVN0cmluZ1JlY292ZXJ5UGFzc3dvcmRzCiAgICAjZW5kcmVnaW9uIExvZ2dpbmcgYW5kIE91dHB1dAoKCgogICAgI3JlZ2lvbiBSZXR1cm4gVmFsdWVzIChVc2VkIGJ5IG90aGVyIEZ1bmN0aW9ucykKICAgICAgICAjcmVnaW9uICAgIEdldC1CaXRMb2NrZXJLZXlQcm90ZWN0b3JUeXBlcwogICAgICAgIEZ1bmN0aW9uIEdldC1Cb29sRHJpdmVIYXNCaXRMb2NrZXJUUE1hbmRQVyB7CiAgICAgICAgICAgIDwjCiAgICAgICAgICAgICAgICBSZXR1cm5zIGEgYm9vbCBhcnJheSwgd2hlcmUgdGhlIGZpcnN0IHJlcHJlc2VudHMgc3RhdHVzIG9mIFRQTSBwcmVzZW5jZSwgYW5kIHRoZSBzZWNvbmQgZm9yIFByb3RlY3Rpb24gUGFzc3dvcmQKICAgICAgICAgICAgIz4KICAgICAgICAgICAgUGFyYW0oCiAgICAgICAgICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeT0kZmFsc2UpXQogICAgICAgICAgICAgICAgW1ZhbGlkYXRlTm90TnVsbE9yRW1wdHkoKV0KICAgICAgICAgICAgICAgIFtzdHJpbmddICREcml2ZUxldHRlciA9ICRPU0RyaXZlTGV0dGVyCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVmFsaWRhdGUgSW5wdXQKICAgICAgICAgICAgJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIgPSBbc3RyaW5nXSQoJERyaXZlTGV0dGVyLlRyaW0oJzonKS5Ub1VwcGVyKCkpCiAgICAgICAgICAgIGlmICgkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlci4nTGVuZ3RoJyAtZ3QgMSkgewogICAgICAgICAgICAgICAgVGhyb3cgJ0VSUk9SOiBEcml2ZSBsZXR0ZXIgY2Fubm90IGJlIG1vcmUgdGhhbiBvbmUgbGV0dGVyJwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAjIEdldCBCaXRMb2NrZXIgVm9sdW1lCiAgICAgICAgICAgICRMb2NhbDpCaXRMb2NrZXJTdGF0dXMgPSBHZXQtQml0TG9ja2VyVm9sdW1lIC1Nb3VudFBvaW50ICRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENyZWF0ZSBvYmplY3QgY29udGFpbmluZyBudW1iZXIgb2YgUmVjb3ZlcnlQYXNzd29yZHMgKEluZGV4ID0gMCkgYW5kIFRQTSAoSW5kZXggPSAxKQogICAgICAgICAgICAkTG9jYWw6Q291bnRSZWNQYXNzID0gW3VpbnQxNl0kKDApCiAgICAgICAgICAgICRMb2NhbDpDb3VudFRQTSA9IFt1aW50MTZdJCgwKQogICAgICAgICAgICAkTG9jYWw6Qml0TG9ja2VyU3RhdHVzLidLZXlQcm90ZWN0b3InIHwgRm9yRWFjaC1PYmplY3QgewogICAgICAgICAgICAgICAgaWYgKCRfLidLZXlQcm90ZWN0b3JUeXBlJyAtZXEgJ1JlY292ZXJ5UGFzc3dvcmQnKSB7JExvY2FsOkNvdW50UmVjUGFzcyArPSAxfQogICAgICAgICAgICAgICAgZWxzZWlmICgkXy4nS2V5UHJvdGVjdG9yVHlwZScgLWVxICdUUE0nKSB7JExvY2FsOkNvdW50VFBNICs9IDF9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmV0dXJuIHRoZSBvYmplY3QKICAgICAgICAgICAgcmV0dXJuIChbYm9vbF0kKCRMb2NhbDpDb3VudFRQTSAtZ2UgMSksW2Jvb2xdJCgkTG9jYWw6Q291bnRSZWNQYXNzIC1nZSAxKSkKICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBHZXQtQml0TG9ja2VyS2V5UHJvdGVjdG9yVHlwZXMKCgogICAgICAgICNyZWdpb24gICAgR2V0LUFycmF5UmVjb3ZlcnlQYXNzd29yZHMKICAgICAgICAjIFJldHVybnMgYSBBcnJheUxpc3Qgd2l0aCBleGlzdGluZyBQcm90ZWN0aW9uUGFzc3dvcmRzCiAgICAgICAgRnVuY3Rpb24gR2V0LUFycmF5UmVjb3ZlcnlQYXNzd29yZHMgewogICAgICAgICAgICBQYXJhbSgKICAgICAgICAgICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5PSR0cnVlKV0KICAgICAgICAgICAgICAgIFtNaWNyb3NvZnQuQml0TG9ja2VyLlN0cnVjdHVyZXMuQml0TG9ja2VyVm9sdW1lXSAkQml0TG9ja2VyVm9sdW1lCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgR2V0IEJpdExvY2tlciBQcm90ZWN0aW9uUGFzc3dvcmRzCiAgICAgICAgICAgICRMb2NhbDpLZXlQcm90ZWN0b3JTdGF0dXMgICAgID0gJEJpdExvY2tlclZvbHVtZSB8IFNlbGVjdC1PYmplY3QgLUV4cGFuZFByb3BlcnR5ICdLZXlQcm90ZWN0b3InCiAgICAgICAgICAgICRMb2NhbDpBcnJheVJlY292ZXJ5UGFzc3dvcmRzID0gW01pY3Jvc29mdC5CaXRMb2NrZXIuU3RydWN0dXJlcy5CaXRMb2NrZXJWb2x1bWVLZXlQcm90ZWN0b3JbXV0kKCkKCiAgICAgICAgICAgICRMb2NhbDpLZXlQcm90ZWN0b3JTdGF0dXMgfCBGb3JFYWNoLU9iamVjdCAtUHJvY2VzcyB7CiAgICAgICAgICAgICAgICBpZiAoJF8uJ0tleVByb3RlY3RvclR5cGUnIC1lcSAnUmVjb3ZlcnlQYXNzd29yZCcpIHsKICAgICAgICAgICAgICAgICAgICAkTG9jYWw6QXJyYXlSZWNvdmVyeVBhc3N3b3JkcyArPSBbTWljcm9zb2Z0LkJpdExvY2tlci5TdHJ1Y3R1cmVzLkJpdExvY2tlclZvbHVtZUtleVByb3RlY3RvcltdXSQoJF8pCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmV0dXJuIHRoZSBvYmplY3QgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gJExvY2FsOkFycmF5UmVjb3ZlcnlQYXNzd29yZHMKICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBHZXQtQXJyYXlSZWNvdmVyeVBhc3N3b3JkcwoKCiAgICAgICAgI3JlZ2lvbiAgICBHZXQtVm9sdW1lVW5pcXVlSUQKICAgICAgICBGdW5jdGlvbiBHZXQtVm9sdW1lVW5pcXVlSUQgewogICAgICAgICAgICBwYXJhbSgKICAgICAgICAgICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5PSR0cnVlKV0KICAgICAgICAgICAgICAgIFtWYWxpZGF0ZU5vdE51bGxPckVtcHR5KCldCiAgICAgICAgICAgICAgICBbc3RyaW5nXSAkRHJpdmVMZXR0ZXIKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBWYWxpZGF0ZSBJbnB1dAogICAgICAgICAgICAkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlciA9IFtzdHJpbmddJCgkRHJpdmVMZXR0ZXIuVHJpbSgnOicpLlRvVXBwZXIoKSkKICAgICAgICAgICAgaWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyLidMZW5ndGgnIC1ndCAxKSB7CiAgICAgICAgICAgICAgICBUaHJvdyAnRVJST1I6IERyaXZlIGxldHRlciBjYW5ub3QgYmUgbW9yZSB0aGFuIG9uZSBsZXR0ZXInCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICMgR2V0IFVuaXF1ZSBWb2x1bWUKICAgICAgICAgICAgcmV0dXJuIFtzdHJpbmddJChHZXQtVm9sdW1lIC1Ecml2ZUxldHRlciAkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlciB8IFNlbGVjdC1PYmplY3QgLUV4cGFuZFByb3BlcnR5ICdVbmlxdWVJZCcpLlNwbGl0KCd7JylbLTFdLlRyaW0oJ31cJykKICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBHZXQtVm9sdW1lVW5pcXVlSUQKCgogICAgICAgICNyZWdpb24gICAgUmVmcmVzaC1CaXRMb2NrZXJWYXJpYWJsZXNGb3JDdXJyZW50Vm9sdW1lCiAgICAgICAgRnVuY3Rpb24gUmVmcmVzaC1CaXRMb2NrZXJWYXJpYWJsZXNGb3JDdXJyZW50Vm9sdW1lIHsKICAgICAgICAgICAgcGFyYW0oCiAgICAgICAgICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeT0kdHJ1ZSldCiAgICAgICAgICAgICAgICBbVmFsaWRhdGVOb3ROdWxsT3JFbXB0eSgpXQogICAgICAgICAgICAgICAgW3N0cmluZ10gJERyaXZlTGV0dGVyCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVmFsaWRhdGUgSW5wdXQKICAgICAgICAgICAgJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIgPSBbc3RyaW5nXSQoJERyaXZlTGV0dGVyLlRyaW0oJzonKS5Ub1VwcGVyKCkpCiAgICAgICAgICAgIGlmICgkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlci5MZW5ndGggLWd0IDEpIHsKICAgICAgICAgICAgICAgIFRocm93ICdFUlJPUjogRHJpdmUgbGV0dGVyIGNhbm5vdCBiZSBtb3JlIHRoYW4gb25lIGxldHRlcicKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICMgVmFyaWFibGVzIHRoYXRzIGFsd2F5cyBwcmVzZW50CiAgICAgICAgICAgICRTY3JpcHQ6Vm9sdW1lRW5jcnlwdGlvblN0YXR1cyAgICAgPSBbc3RyaW5nXSQoR2V0LVZhcmlhYmxlIC1OYW1lICgnezB9Vm9sdW1lRW5jcnlwdGlvblN0YXR1cycgLWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyKSkgLVNjb3BlICdTY3JpcHQnIC1WYWx1ZU9ubHkgLUVycm9yQWN0aW9uICdTdG9wJykKICAgICAgICAgICAgJFNjcmlwdDpWb2x1bWVQcm90ZWN0aW9uU3RhdHVzICAgICA9IFtzdHJpbmddJChHZXQtVmFyaWFibGUgLU5hbWUgKCd7MH1Wb2x1bWVQcm90ZWN0aW9uU3RhdHVzJyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpKSAtU2NvcGUgJ1NjcmlwdCcgLVZhbHVlT25seSAtRXJyb3JBY3Rpb24gJ1N0b3AnKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBWYXJpYWJsZXMgdGhhdHMgcHJlc2VudCBvbmx5IGlmIHRoZXJlcyBhdCBsZWFzdCBvbmUgS2V5UHJvdGVjdG9yIGZvciBjdXJyZW50IHZvbHVtZQogICAgICAgICAgICAkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXICAgICAgICAgID0gW2Jvb2xbXV0kKEdldC1WYXJpYWJsZSAtTmFtZSAoJ3swfVZvbHVtZUhhc1RQTWFuZFBXJyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpKSAtU2NvcGUgJ1NjcmlwdCcgLVZhbHVlT25seSAtRXJyb3JBY3Rpb24gJ1NpbGVudGx5Q29udGludWUnKQogICAgICAgICAgICAkU2NyaXB0OlZvbHVtZUVuY3J5cHRpb25QZXJjZW50YWdlID0gW3N0cmluZ10kKEdldC1WYXJpYWJsZSAtTmFtZSAoJ3swfVZvbHVtZUVuY3J5cHRpb25QZXJjZW50YWdlJyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpKSAtU2NvcGUgJ1NjcmlwdCcgLVZhbHVlT25seSAtRXJyb3JBY3Rpb24gJ1NpbGVudGx5Q29udGludWUnKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBWYXJpYWJsZXMgdGhhdHMgcHJlc2VudCBvbmx5IGlmIGN1cnJlbnQgdm9sdW1lIGlzIHByb3RlY3RlZCB3aXRoIG1pbmltdW0gYSBUUE0gYW5kIGEgUmVjb3ZlcnkgUGFzc3dvcmQKICAgICAgICAgICAgJFNjcmlwdDpBcnJheVJlY292ZXJ5UGFzc3dvcmRzICAgICA9IEdldC1WYXJpYWJsZSAtTmFtZSAoJ3swfUFycmF5UmVjb3ZlcnlQYXNzd29yZHMnIC1mICgkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlcikpIC1TY29wZSAnU2NyaXB0JyAtVmFsdWVPbmx5IC1FcnJvckFjdGlvbiAnU2lsZW50bHlDb250aW51ZScKICAgICAgICAgICAgJFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzICAgICA9IFtieXRlXSQoR2V0LVZhcmlhYmxlIC1OYW1lICgnezB9Q291bnRSZWNvdmVyeVBhc3N3b3JkcycgLWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyKSkgLVNjb3BlICdTY3JpcHQnIC1WYWx1ZU9ubHkgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJykKICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBSZWZyZXNoLUJpdExvY2tlclZhcmlhYmxlc0ZvckN1cnJlbnRWb2x1bWUKCgogICAgICAgICNyZWdpb24gICAgQ2hlY2stSWZCaXRMb2NrZXJQV0hhc0NoYW5nZWQKICAgICAgICBGdW5jdGlvbiBDaGVjay1JZkJpdExvY2tlclBXSGFzQ2hhbmdlZCB7CiAgICAgICAgICAgIHBhcmFtKAogICAgICAgICAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnk9JGZhbHNlKV0KICAgICAgICAgICAgICAgIFtWYWxpZGF0ZU5vdE51bGxPckVtcHR5KCldCiAgICAgICAgICAgICAgICBbc3RyaW5nXSAkRHJpdmVMZXR0ZXIgPSAkT1NEcml2ZUxldHRlcgogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEhlbHAgVmFyaWFibGVzCiAgICAgICAgICAgICRMb2NhbDpIYXNDaGFuZ2VkID0gW2Jvb2xdJCgkZmFsc2UpCiAgICAgICAgICAgICRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyID0gW3N0cmluZ10kKCREcml2ZUxldHRlci5UcmltKCc6JykuVG9VcHBlcigpKQogICAgICAgICAgICBpZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIuJ0xlbmd0aCcgLWd0IDEpIHsKICAgICAgICAgICAgICAgIFRocm93ICdFUlJPUjogRHJpdmUgbGV0dGVyIGNhbm5vdCBiZSBtb3JlIHRoYW4gb25lIGxldHRlcicKICAgICAgICAgICAgfQoKICAgICAgICAgICAgIyBOYW1lIFZhcmlhYmxlcwogICAgICAgICAgICAkTG9jYWw6TmFtZUFycmF5ID0gW3N0cmluZ10kKCd7MH1BcnJheVJlY292ZXJ5UGFzc3dvcmRzJyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpKQogICAgICAgICAgICAkTG9jYWw6Vm9sdW1lVW5pcXVlSUQgPSBbc3RyaW5nXSQoR2V0LVZvbHVtZVVuaXF1ZUlEIC1Ecml2ZUxldHRlciAkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlcikKICAgICAgICAgICAgJExvY2FsOk5hbWVGaWxlID0gW3N0cmluZ10kKCd7MH0udHh0JyAtZiAoJFZvbHVtZVVuaXF1ZUlEKSkKICAgICAgICAgICAKICAgICAgICAgICAgIyBHZXQgVmFyaWFibGVzCiAgICAgICAgICAgICRMb2NhbDpQYXRoRGlyID0gW3N0cmluZ10kKCd7MH17MX0nIC1mICgkU2NyaXB0OkRpckluc3RhbGwsJ0JhY2t1cEtleXNcJykpCiAgICAgICAgICAgICRMb2NhbDpQYXRoRmlsZSA9IFtzdHJpbmddJCgnezB9ezF9JyAtZiAoJExvY2FsOlBhdGhEaXIsJExvY2FsOk5hbWVGaWxlKSkKICAgICAgICAgICAgJExvY2FsOk5vd0tleVByb3RlY3RvcklEID0gW3N0cmluZ10kKCgoR2V0LVZhcmlhYmxlIC1OYW1lICRMb2NhbDpOYW1lQXJyYXkgLVNjb3BlICdTY3JpcHQnKS4nVmFsdWUnKS4nS2V5UHJvdGVjdG9ySUQnKQogICAgICAgICAgICAkTG9jYWw6Tm93UmVjb3ZlcnlQYXNzd29yZCA9IFtzdHJpbmddJCgoKEdldC1WYXJpYWJsZSAtTmFtZSAkTG9jYWw6TmFtZUFycmF5IC1TY29wZSAnU2NyaXB0JykuJ1ZhbHVlJykuJ1JlY292ZXJ5UGFzc3dvcmQnKQoKCiAgICAgICAgICAgICMgR2V0IHN0YXRzCiAgICAgICAgICAgIGlmICgtbm90IChUZXN0LVBhdGggLVBhdGggJExvY2FsOlBhdGhGaWxlKSkgewogICAgICAgICAgICAgICAgJExvY2FsOkhhc0NoYW5nZWQgPSAkdHJ1ZQogICAgICAgICAgICAgICAgaWYgKC1ub3QoVGVzdC1QYXRoIC1QYXRoICRMb2NhbDpQYXRoRGlyIC1FcnJvckFjdGlvbiAnU2lsZW50bHlDb250aW51ZScpKSB7CiAgICAgICAgICAgICAgICAgICAgJG51bGwgPSBOZXctSXRlbSAtUGF0aCAkTG9jYWw6UGF0aERpciAtSXRlbVR5cGUgJ0RpcmVjdG9yeScgLUZvcmNlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAkTG9jYWw6SW5wdXRTdHJpbmcgPSBbc3RyaW5nW11dJCgoR2V0LUNvbnRlbnQgLVBhdGggJExvY2FsOlBhdGhGaWxlKS5TcGxpdChbRW52aXJvbm1lbnRdOjpOZXdMaW5lKSkKICAgICAgICAgICAgICAgIGlmICgkPyAtYW5kICRMb2NhbDpJbnB1dFN0cmluZy4nTGVuZ3RoJyAtZ2UgNykgewogICAgICAgICAgICAgICAgICAgICRMb2NhbDpQcmV2S2V5UHJvdGVjdG9ySUQgPSBbc3RyaW5nXSQoJExvY2FsOklucHV0U3RyaW5nWzVdLlRyaW0oKSkKICAgICAgICAgICAgICAgICAgICAkTG9jYWw6UHJldlJlY292ZXJ5UGFzc3dvcmQgPSBbc3RyaW5nXSQoJExvY2FsOklucHV0U3RyaW5nWzddLlRyaW0oKSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgeyRMb2NhbDpIYXNDaGFuZ2VkID0gJHRydWV9CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAjIENoZWNrIGlmIGNoYW5nZWQKICAgICAgICAgICAgaWYgKCRMb2NhbDpQcmV2S2V5UHJvdGVjdG9ySUQpIHsKICAgICAgICAgICAgICAgIGlmICgkTG9jYWw6UHJldktleVByb3RlY3RvcklEIC1uZSAkTG9jYWw6Tm93S2V5UHJvdGVjdG9ySUQpIHskTG9jYWw6SGFzQ2hhbmdlZCA9ICR0cnVlfQogICAgICAgICAgICAgICAgaWYgKCRMb2NhbDpQcmV2UmVjb3ZlcnlQYXNzd29yZCAtbmUgJExvY2FsOk5vd1JlY292ZXJ5UGFzc3dvcmQpIHskTG9jYWw6SGFzQ2hhbmdlZCA9ICR0cnVlfQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgIyBXcml0ZSBuZXcgdmFsdWVzIGlmIGNoYW5nZWQgb3IgZG9lcyBub3QgZXhpc3QKICAgICAgICAgICAgaWYgKCRMb2NhbDpIYXNDaGFuZ2VkIC1vciAoLW5vdCAoVGVzdC1QYXRoIC1QYXRoICRMb2NhbDpQYXRoRmlsZSkpKSB7CiAgICAgICAgICAgICAgICAkTG9jYWw6T3V0U3RyID0gW3N0cmluZ106OkVtcHR5CiAgICAgICAgICAgICAgICAkTG9jYWw6T3V0U3RyICs9ICdEcml2ZS9Wb2x1bWUgTGV0dGVyIChOb3QgVW5pcXVlIGlkZW50aWZpZXIpOnswfScgLWYgImByYG4iCiAgICAgICAgICAgICAgICAkTG9jYWw6T3V0U3RyICs9ICd7MH17MX0nIC1mICRDdXJyZW50Vm9sdW1lTGV0dGVyLCJgcmBuIgogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciArPSAnVm9sdW1lIFVuaXF1ZUlEIChOYW1lIG9mIHRoaXMgZmlsZSk6ezB9JyAtZiAiYHJgbiIKICAgICAgICAgICAgICAgICRMb2NhbDpPdXRTdHIgKz0gJ3swfXsxfScgLWYgJExvY2FsOlZvbHVtZVVuaXF1ZUlELCJgcmBuIgogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciArPSAnS2V5UHJvdGVjdG9ySUQ6ezB9JyAtZiAiYHJgbiIKICAgICAgICAgICAgICAgICRMb2NhbDpPdXRTdHIgKz0gJ3swfXsxfScgLWYgJExvY2FsOk5vd0tleVByb3RlY3RvcklELCJgcmBuIgogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciArPSAnUmVjb3ZlcnkgUGFzc3dvcmQ6ezB9JyAtZiAiYHJgbiIKICAgICAgICAgICAgICAgICRMb2NhbDpPdXRTdHIgKz0gJ3swfXsxfScgLWYgJExvY2FsOk5vd1JlY292ZXJ5UGFzc3dvcmQsImByYG4iCiAgICAgICAgICAgICAgICAkbnVsbCA9IE91dC1GaWxlIC1GaWxlUGF0aCAkTG9jYWw6UGF0aEZpbGUgLUVuY29kaW5nICd1dGY4JyAtRm9yY2UgLUlucHV0T2JqZWN0ICgkTG9jYWw6T3V0U3RyKQogICAgICAgICAgICB9CgoKCiAgICAgICAgICAgICMgUmV0dXJuIHN0YXR1cwogICAgICAgICAgICByZXR1cm4gJExvY2FsOkhhc0NoYW5nZWQKICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBDaGVjay1JZkJpdExvY2tlclBXSGFzQ2hhbmdlZAogICAgI2VuZHJlZ2lvbiBSZXR1cm4gVmFsdWVzIChVc2VkIGJ5IG90aGVyIEZ1bmN0aW9ucykKCgoKICAgICNyZWdpb24gU2V0IFNjcmlwdCBXaWRlIFZhcmlhYmxlcwogICAgICAgICNyZWdpb24gR2V0LUJpdExvY2tlclN0YXR1cwogICAgICAgIEZ1bmN0aW9uIEdldC1CaXRMb2NrZXJTdGF0dXMgewogICAgICAgICAgICA8IwogICAgICAgICAgICAgICAgKiBGaWxscyB0d28gc3RyaW5ncyB3aXRoIGN1cnJlbnQgVm9sdW1lIEVuY3J5cHRpb24gU3RhdHVzLCBhbmQgVm9sdW1lIFByb3RlY3Rpb24gU3RhdHVzLiAKICAgICAgICAgICAgICAgICogQWxzbyBtYWtlcyBhIGJvb2wgYXJyYXkgd2l0aCB0cnVlIGZhbHNlIGZvciB8IDE6IFRQTSBwcmVzZW50IHwgMjogUmVjb3ZlcnkgUGFzc3dvcmQgUHJlc2VudAogICAgICAgICAgICAjPgogICAgICAgICAgICBQYXJhbSgKICAgICAgICAgICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5PSRmYWxzZSldCiAgICAgICAgICAgICAgICBbVmFsaWRhdGVOb3ROdWxsT3JFbXB0eSgpXQogICAgICAgICAgICAgICAgW3N0cmluZ10gJERyaXZlTGV0dGVyID0gJE9TRHJpdmVMZXR0ZXIKICAgICAgICAgICAgKQoKICAgICAgICAgICAgIyBIZWxwIHZhcmlhYmxlCiAgICAgICAgICAgICRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyID0gW3N0cmluZ10kKCREcml2ZUxldHRlci5UcmltKCc6JykuVG9VcHBlcigpKQogICAgICAgICAgICBpZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIuJ0xlbmd0aCcgLW5lIDEpIHsKICAgICAgICAgICAgICAgIFRocm93ICdFUlJPUjogRHJpdmUgbGV0dGVyIGNhbm5vdCBiZSBtb3JlIG9yIGxlc3MgdGhhbiBvbmUgbGV0dGVyIScKICAgICAgICAgICAgfQoKICAgICAgICAgICAgIyBHZXQgQml0TG9ja2VyIFN0YXR1cyBmb3IgVm9sdW1lCiAgICAgICAgICAgICRMb2NhbDpCaXRMb2NrZXJWb2x1bWVTdGF0dXMgPSBbTWljcm9zb2Z0LkJpdExvY2tlci5TdHJ1Y3R1cmVzLkJpdExvY2tlclZvbHVtZV0kKEdldC1CaXRMb2NrZXJWb2x1bWUgLU1vdW50UG9pbnQgJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpCiAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEJpdExvY2tlciBWb2x1bWUgRW5jcnlwdGlvbiBTdGF0dXM6IEZ1bGx5RGVjcnlwdGVkIHwgRW5jcnlwdGlvbkluUHJvZ3Jlc3MgfCBGdWxseUVuY3J5cHRlZAogICAgICAgICAgICBOZXctVmFyaWFibGUgLU5hbWUgKCd7MH1Wb2x1bWVFbmNyeXB0aW9uU3RhdHVzJyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpKSAtU2NvcGUgJ1NjcmlwdCcgLUZvcmNlIGAKICAgICAgICAgICAgICAgICAgICAgICAgIC1WYWx1ZSAoW3N0cmluZ10kKCRMb2NhbDpCaXRMb2NrZXJWb2x1bWVTdGF0dXMgfCBTZWxlY3QtT2JqZWN0IC1FeHBhbmRQcm9wZXJ0eSAnVm9sdW1lU3RhdHVzJykpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEJpdExvY2tlciBWb2x1bWUgUHJvdGVjdGlvbiBTdGF0dXM6IE9OIGlmIEVuY3J5cHRpb24gUGVyY2VudGFnZSA9IDEwMCUKICAgICAgICAgICAgTmV3LVZhcmlhYmxlIC1OYW1lICgnezB9Vm9sdW1lUHJvdGVjdGlvblN0YXR1cycgLWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyKSkgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSBgCiAgICAgICAgICAgICAgICAgICAgICAgICAtVmFsdWUgKFtzdHJpbmddJCgkTG9jYWw6Qml0TG9ja2VyVm9sdW1lU3RhdHVzIHwgU2VsZWN0LU9iamVjdCAtRXhwYW5kUHJvcGVydHkgJ1Byb3RlY3Rpb25TdGF0dXMnKSkKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgPCMgIAogICAgICAgICAgICAgICAgICAgIFZvbHVtZSBjYW4gYmUgJ0Z1bGx5IERlY3J5cHRlZCcsIGJ1dCBzdGlsbCBoYXZlIGEgVFBNIHByZXNlbnQuIAogICAgICAgICAgICAgICAgICAgIFRoaXMgaXMgdXN1YWxseSB0aGUgY2FzZSByaWdodCBhZnRlciBlbmNyeXB0aW9uIGhhcyBzdGFydGVkLiAKICAgICAgICAgICAgIz4KCgogICAgICAgICAgICAjIElmIHRoZXJlIGlzIGEgS2V5UHJvdGVjdG9yIGZvciBnaXZlbiB2b2x1bWUsIGdldCB0aGUgcmVzdCBvZiB0aGUgdmFyaWFibGVzCiAgICAgICAgICAgIGlmICgkTG9jYWw6Qml0TG9ja2VyVm9sdW1lU3RhdHVzLidLZXlQcm90ZWN0b3InLidDb3VudCcgLWd0IDApIHsKICAgICAgICAgICAgICAgICMgWzB9ID0gVm9sdW1lIGhhcyBUUE0/ICAgWzFdID0gVm9sdW1lIGhhcyBSZWNvdmVyeSBQYXNzd29yZD8KICAgICAgICAgICAgICAgIE5ldy1WYXJpYWJsZSAtTmFtZSAoJ3swfVZvbHVtZUhhc1RQTWFuZFBXJyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpKSAtU2NvcGUgJ1NjcmlwdCcgLUZvcmNlIGAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtVmFsdWUgKFtib29sW11dJChHZXQtQm9vbERyaXZlSGFzQml0TG9ja2VyVFBNYW5kUFcgLURyaXZlTGV0dGVyICRDdXJyZW50Vm9sdW1lTGV0dGVyKSkgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgRW5jcnlwdGlvbiBQZXJjZW50YWdlOiBIb3cgbG9uZyBoYXMgdGhlIGVuY3J5cHRpb24gcHJvY2VzcyBjb21lCiAgICAgICAgICAgICAgICBOZXctVmFyaWFibGUgLU5hbWUgKCd7MH1Wb2x1bWVFbmNyeXB0aW9uUGVyY2VudGFnZScgLWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyKSkgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSBgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLVZhbHVlIChbc3RyaW5nXSQoJExvY2FsOkJpdExvY2tlclZvbHVtZVN0YXR1cyB8IFNlbGVjdC1PYmplY3QgLUV4cGFuZFByb3BlcnR5ICdFbmNyeXB0aW9uUGVyY2VudGFnZScpLlRvU3RyaW5nKCkpICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBJZiBEcml2ZSBoYXMgVFBNIGFuZCBQVwogICAgICAgICAgICAgICAgaWYgKChHZXQtVmFyaWFibGUgLU5hbWUgKCd7MH1Wb2x1bWVIYXNUUE1hbmRQVycgLWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyKSkgLVNjb3BlICdTY3JpcHQnKS5WYWx1ZVsxXSkgewogICAgICAgICAgICAgICAgICAgICMgTmFtZSB0aGUgdmFyaWFibGVzCiAgICAgICAgICAgICAgICAgICAgJExvY2FsOk5hbWVBcnJheVJlY292ZXJ5UGFzc3dvcmRzID0gW3N0cmluZ10kKCd7MH1BcnJheVJlY292ZXJ5UGFzc3dvcmRzJyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpKQogICAgICAgICAgICAgICAgICAgICRMb2NhbDpOYW1lQ291bnRSZWNvdmVyeVBhc3N3b3JkcyA9IFtzdHJpbmddJCgnezB9Q291bnRSZWNvdmVyeVBhc3N3b3JkcycgLWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyKSkKCiAgICAgICAgICAgICAgICAgICAgIyBHZXQgQXJyYXkgd2l0aCBwcm90ZWN0aW9uIHBhc3N3b3JkcwogICAgICAgICAgICAgICAgICAgIE5ldy1WYXJpYWJsZSAtTmFtZSAkTG9jYWw6TmFtZUFycmF5UmVjb3ZlcnlQYXNzd29yZHMgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSBgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC1WYWx1ZSAoR2V0LUFycmF5UmVjb3ZlcnlQYXNzd29yZHMgLUJpdExvY2tlclZvbHVtZSAkTG9jYWw6Qml0TG9ja2VyVm9sdW1lU3RhdHVzKQoKICAgICAgICAgICAgICAgICAgICAjIENvdW50IEFycmF5UmVjb3ZlcnlQYXNzd29yZHMKICAgICAgICAgICAgICAgICAgICBOZXctVmFyaWFibGUgLU5hbWUgJExvY2FsOk5hbWVDb3VudFJlY292ZXJ5UGFzc3dvcmRzIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtVmFsdWUgKFtieXRlXSQoKEdldC1WYXJpYWJsZSAtTmFtZSAkTG9jYWw6TmFtZUFycmF5UmVjb3ZlcnlQYXNzd29yZHMpLidWYWx1ZScpLidMZW5ndGgnKQoKICAgICAgICAgICAgICAgICAgICAjIEdldCBWb2x1bWUgVW5pcXVlIElEICh0byBjaGVjayBpZiBwcm90ZWN0aW9uIHBhc3N3b3JkIGhhcyBjaGFuZ2VkKQogICAgICAgICAgICAgICAgICAgIE5ldy1WYXJpYWJsZSAtTmFtZSAoJ3swfVZvbHVtZVVuaXF1ZUlEJyAtZiAoJExvY2FsOk5hbWVWb2x1bWUpKSAtU2NvcGUgJ1NjcmlwdCcgLUZvcmNlIGAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLVZhbHVlICgoR2V0LVZvbHVtZVVuaXF1ZUlEIC1Ecml2ZUxldHRlciAkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlcikpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBHZXQtQml0TG9ja2VyU3RhdHVzCiAgICAjZW5kcmVnaW9uIFNldCBTY3JpcHQgV2lkZSBWYXJpYWJsZXMKCgoKICAgICNyZWdpb24gUmVnaXN0cnkgRnVuY3Rpb25zCiAgICAgICAgI3JlZ2lvbiBDcmVhdGUtRW52VmFyaWFibGVzCiAgICAgICAgIyBDcmVhdGUtRW52VmFyaWFibGVzOiBDcmVhdGVzIHZhcmlhYmxlcyB1c2VkIGJ5IHRoZSB0cm91Ymxlc2hvb3RlciBhdCB0aGUgYm90dG9tLCB3aGVuIGZhaWxlZCBydW5zIHJlYWNoZXMgYSBnaXZlbiBudW1iZXIuICAKICAgICAgICBGdW5jdGlvbiBDcmVhdGUtRW52VmFyaWFibGVzIHsKICAgICAgICAgICAgIyMjIyBTY3JpcHQgV2lkZSBWYXJpYWJsZXMKICAgICAgICAgICAgIyMgVGVuYW50CiAgICAgICAgICAgICRMb2NhbDpQYXRoRGlyUmVnVGVuYW50Sm9pbkluZm9CYXNlID0gW3N0cmluZ10kKCdSZWdpc3RyeTo6SEtFWV9MT0NBTF9NQUNISU5FXFNZU1RFTVxDdXJyZW50Q29udHJvbFNldFxDb250cm9sXENsb3VkRG9tYWluSm9pblxKb2luSW5mbycpCiAgICAgICAgICAgICRMb2NhbDpQYXRoRGlyUmVnVGVuYW50Sm9pbkluZm9GdWxsID0gW3N0cmluZ10kKCd7MH1cezF9JyAtZiAoJExvY2FsOlBhdGhEaXJSZWdUZW5hbnRKb2luSW5mb0Jhc2UsCiAgICAgICAgICAgICAgICAoR2V0LUNoaWxkSXRlbSAtUGF0aCAkTG9jYWw6UGF0aERpclJlZ1RlbmFudEpvaW5JbmZvQmFzZSB8IFNlbGVjdC1PYmplY3QgLUV4cGFuZFByb3BlcnR5ICdOYW1lJykuU3BsaXQoJ1wnKVstMV0KICAgICAgICAgICAgKSkKICAgICAgICAgICAgJFNjcmlwdDpOYW1lVGVuYW50ID0gW3N0cmluZ10kKEdldC1JdGVtUHJvcGVydHkgLVBhdGggJExvY2FsOlBhdGhEaXJSZWdUZW5hbnRKb2luSW5mb0Z1bGwpLidVc2VyRW1haWwnLlNwbGl0KCdAJylbMV0KICAgICAgICAgICAgJFNjcmlwdDpOYW1lVGVuYW50U2hvcnQgPSBbc3RyaW5nXSQoJFNjcmlwdDpOYW1lVGVuYW50LlNwbGl0KCcuJylbMF0pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIyBIYXJkd2FyZSBhbmQgV2luZG93cyBpbmZvCiAgICAgICAgICAgICRTY3JpcHQ6Q29tcHV0ZXJNYW51ZmFjdHVyZXIgPSBbc3RyaW5nXSQoUXVlcnktUmVnaXN0cnkgLURpciAnUmVnaXN0cnk6OkhLRVlfTE9DQUxfTUFDSElORVxIQVJEV0FSRVxERVNDUklQVElPTlxTeXN0ZW1cQklPU1xTeXN0ZW1NYW51ZmFjdHVyZXInKQogICAgICAgICAgICBpZiAoLW5vdChbc3RyaW5nXTo6SXNOdWxsT3JFbXB0eSgkU2NyaXB0OkNvbXB1dGVyTWFudWZhY3R1cmVyKSkpIHsKICAgICAgICAgICAgICAgICRTY3JpcHQ6Q29tcHV0ZXJGYW1pbHkgPSBbc3RyaW5nXSQoUXVlcnktUmVnaXN0cnkgLURpciAnUmVnaXN0cnk6OkhLRVlfTE9DQUxfTUFDSElORVxIQVJEV0FSRVxERVNDUklQVElPTlxTeXN0ZW1cQklPU1xTeXN0ZW1GYW1pbHknKQogICAgICAgICAgICAgICAgJFNjcmlwdDpDb21wdXRlclByb2R1Y3ROYW1lID0gW3N0cmluZ10kKFF1ZXJ5LVJlZ2lzdHJ5IC1EaXIgJ1JlZ2lzdHJ5OjpIS0VZX0xPQ0FMX01BQ0hJTkVcSEFSRFdBUkVcREVTQ1JJUFRJT05cU3lzdGVtXEJJT1NcU3lzdGVtUHJvZHVjdE5hbWUnKQogICAgICAgICAgICAgICAgJFNjcmlwdDpXaW5kb3dzRWRpdGlvbiA9IFtzdHJpbmddJChRdWVyeS1SZWdpc3RyeSAtRGlyICdSZWdpc3RyeTo6SEtFWV9MT0NBTF9NQUNISU5FXFNPRlRXQVJFXE1pY3Jvc29mdFxXaW5kb3dzIE5UXEN1cnJlbnRWZXJzaW9uXFByb2R1Y3ROYW1lJykKICAgICAgICAgICAgICAgICRTY3JpcHQ6V2luZG93c1ZlcnNpb24gPSBbc3RyaW5nXSQoUXVlcnktUmVnaXN0cnkgLURpciAnUmVnaXN0cnk6OkhLRVlfTE9DQUxfTUFDSElORVxTT0ZUV0FSRVxNaWNyb3NvZnRcV2luZG93cyBOVFxDdXJyZW50VmVyc2lvblxSZWxlYXNlSWQnKQogICAgICAgICAgICAgICAgJFNjcmlwdDpXaW5kb3dzVmVyc2lvbiArPSBbc3RyaW5nXSQoJyAoezB9KScgLWYgKFF1ZXJ5LVJlZ2lzdHJ5IC1EaXIgJ1JlZ2lzdHJ5OjpIS0VZX0xPQ0FMX01BQ0hJTkVcU09GVFdBUkVcTWljcm9zb2Z0XFdpbmRvd3MgTlRcQ3VycmVudFZlcnNpb25cQ3VycmVudEJ1aWxkJykpCiAgICAgICAgICAgIH0gCiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgJExvY2FsOkVudkluZm8gPSBHZXQtV21pT2JqZWN0IC1DbGFzcyAnV2luMzJfQ29tcHV0ZXJTeXN0ZW0nIHwgU2VsZWN0LU9iamVjdCAtUHJvcGVydHkgJ01hbnVmYWN0dXJlcicsJ01vZGVsJywnU3lzdGVtRmFtaWx5JwogICAgICAgICAgICAgICAgJFNjcmlwdDpDb21wdXRlck1hbnVmYWN0dXJlciA9IFtzdHJpbmddJCgkTG9jYWw6RW52SW5mby4nTWFudWZhY3R1cmVyJykKICAgICAgICAgICAgICAgICRTY3JpcHQ6Q29tcHV0ZXJGYW1pbHkgPSBbc3RyaW5nXSQoJExvY2FsOkVudkluZm8uJ1N5c3RlbUZhbWlseScpCiAgICAgICAgICAgICAgICAkU2NyaXB0OkNvbXB1dGVyUHJvZHVjdE5hbWUgPSBbc3RyaW5nXSQoJExvY2FsOkVudkluZm8uJ01vZGVsJykKICAgICAgICAgICAgICAgICRMb2NhbDpPU0luZm8gPSBHZXQtV21pT2JqZWN0IC1DbGFzcyAnV2luMzJfb3BlcmF0aW5nc3lzdGVtJyB8IFNlbGVjdC1PYmplY3QgLVByb3BlcnR5ICdDYXB0aW9uJywnVmVyc2lvbicKICAgICAgICAgICAgICAgICRTY3JpcHQ6V2luZG93c0VkaXRpb24gPSBbc3RyaW5nXSQoJExvY2FsOk9TSW5mby4nQ2FwdGlvbicpCiAgICAgICAgICAgICAgICAkU2NyaXB0OldpbmRvd3NWZXJzaW9uID0gW3N0cmluZ10kKCRMb2NhbDpPU0luZm8uJ1ZlcnNpb24nKQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gQ3JlYXRlLUVudlZhcmlhYmxlcwoKCiAgICAgICAgI3JlZ2lvbiAgICBRdWVyeS1SZWdpc3RyeQogICAgICAgIEZ1bmN0aW9uIFF1ZXJ5LVJlZ2lzdHJ5IHsKICAgICAgICAgICAgUGFyYW0gKFtQYXJhbWV0ZXIoTWFuZGF0b3J5PSR0cnVlKV0gW3N0cmluZ10gJERpcikKICAgICAgICAgICAgJExvY2FsOk91dCA9IFtzdHJpbmddOjpFbXB0eQogICAgICAgICAgICAkTG9jYWw6S2V5ID0gW3N0cmluZ10kKCREaXIuU3BsaXQoJ3tcfScpWy0xXSkKICAgICAgICAgICAgJExvY2FsOkRpciA9IFtzdHJpbmddJCgkRGlyLlJlcGxhY2UoJExvY2FsOktleSwnJykpCiAgICAgICAgCiAgICAgICAgICAgICRMb2NhbDpFeGlzdHMgPSBHZXQtSXRlbVByb3BlcnR5IC1QYXRoICgnezB9JyAtZiAkRGlyKSAtTmFtZSAoJ3swfScgLWYgJExvY2FsOktleSkgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJwogICAgICAgICAgICBpZiAoJEV4aXN0cykgewogICAgICAgICAgICAgICAgJExvY2FsOk91dCA9ICRMb2NhbDpFeGlzdHMuJExvY2FsOktleQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAkTG9jYWw6T3V0CiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gUXVlcnktUmVnaXN0cnkKICAgICNlbmRyZWdpb24gUmVnaXN0cnkgRnVuY3Rpb25zCgoKCiAgICAjcmVnaW9uICAgIEVkaXQtU2NoZWR1bGVkVGFzawogICAgZnVuY3Rpb24gRWRpdC1TY2hlZHVsZWRUYXNrIHsKICAgICAgICBQYXJhbSgKICAgICAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnk9JGZhbHNlKV0KICAgICAgICAgICAgW3N0cmluZ10gJFRhc2tOYW1lID0gJFNjcmlwdDpTY2hlZHVsZWRUYXNrTmFtZQogICAgICAgICkKCiAgICAgICAgJFRhc2sgPSBHZXQtU2NoZWR1bGVkVGFzayAtVGFza05hbWUgJFRhc2tOYW1lIC1FcnJvckFjdGlvbiAnU2lsZW50bHlDb250aW51ZScKCiAgICAgICAgaWYgKCRUYXNrKSB7CiAgICAgICAgICAgIGlmICgkU2NyaXB0OkJvb2xSZW1vdmVTY2hlZHVsZWRUYXNrQWZ0ZXJGaXJzdFN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICRudWxsID0gVW5yZWdpc3Rlci1TY2hlZHVsZWRUYXNrIC1UYXNrTmFtZSAkVGFzayAtQ29uZmlybTokZmFsc2UgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJwogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdSZW1vdmluZyB0aGUgU2NoZWR1bGVkIHRhc2sgInswfSIuIFN1Y2Nlc3M/IHsxfScgLWYgKCRUYXNrLidUYXNrTmFtZScsJD8uVG9TdHJpbmcoKSkpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAkTG9jYWw6TmV3U2NoZWRUaW1lID0gW2RhdGV0aW1lXSQoW2RhdGV0aW1lXTo6VG9kYXkuQWRkSG91cnMoMTIpKQogICAgICAgICAgICAgICAgJG51bGwgPSBTZXQtU2NoZWR1bGVkVGFzayAtVGFza05hbWUgJFNjcmlwdDpTY2hlZHVsZWRUYXNrTmFtZSAtVHJpZ2dlciAoTmV3LVNjaGVkdWxlZFRhc2tUcmlnZ2VyIC1EYWlseSAtQXQgJExvY2FsOk5ld1NjaGVkVGltZSkgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJwogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdFZGl0aW5nIFNjaGVkdWxlZCB0YXNrICJ7MH0iIHRvIHN0YXJ0IGRhaWx5IGF0IHsxfS4gU3VjY2Vzcz8gezJ9LicgLWYgKCRTY3JpcHQ6U2NoZWR1bGVkVGFza05hbWUsJExvY2FsOk5ld1NjaGVkVGltZS4nSG91cicuVG9TdHJpbmcoKSwkPy5Ub1N0cmluZygpKSkKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgTG9nV3JpdGUgKCdGb3VuZCBubyBTY2hlZHVsZWQgVGFzayB3aXRoIG5hbWUgInswfSIuJyAtZiAoJFRhc2tOYW1lKSkKICAgICAgICB9CiAgICB9CiAgICAjZW5kcmVnaW9uIEVkaXQtU2NoZWR1bGVkVGFzawoKCiAgICAjcmVnaW9uICAgIFByb21wdC1SZWJvb3QKICAgIEZ1bmN0aW9uIFByb21wdC1SZWJvb3QgewogICAgICAgICRMb2NhbDpUaW1lVG9SZWJvb3RJbk1pbnV0ZXMgPSBbdWludDE2XSQoNjApCiAgICAgICAgJExvY2FsOlN0clNob3J0TWVzc2FnZSA9IFtzdHJpbmddJCgnV2luZG93cyB3aWxsIHJlc3RhcnQgaW4gezB9IG1pbnV0ZXMgdG8gZmluaXNoIGRldmljZSBjb25maWd1cmF0aW9uLiBTYXZlIHlvdXIgd29yayEnIC1mICgkTG9jYWw6VGltZVRvUmVib290SW5NaW51dGVzKSkKICAgICAgICAkbnVsbCA9IGNtZC5leGUgL2MgKCdzaHV0ZG93biAvciAvdCB7MH0gL2MgInsxfSInIC1mICgkTG9jYWw6VGltZVRvUmVib290SW5NaW51dGVzKjYwKSwkTG9jYWw6U3RyU2hvcnRNZXNzYWdlKSAyPiYxCiAgICAgICAgaWYgKC1ub3QoJD8pKSB7CiAgICAgICAgICAgICRudWxsID0gY21kLmV4ZSAvYyAoJ3NodXRkb3duIC9hJykgMj4mMQogICAgICAgICAgICAkbnVsbCA9IGNtZC5leGUgL2MgKCdzaHV0ZG93biAvciAvdCB7MH0gL2MgInsxfSInIC1mICgkTG9jYWw6VGltZVRvUmVib290SW5NaW51dGVzKjYwKSwkTG9jYWw6U3RyU2hvcnRNZXNzYWdlKSAyPiYxCiAgICAgICAgfQoKICAgICAgICA8IyBGT1IgRlVUVVJFIEVOSEFOQ0VNRU5UUwogICAgICAgIFtzdHJpbmddICRMb2NhbDpTdHJNZXNzYWdlID0gJ1lvdXIgY29tcHV0ZXIgYXJlIGF3YWl0aW5nIGEgcmVzdGFydDonCiAgICAgICAgJExvY2FsOlN0ck1lc3NhZ2UgKz0gJ3swfSBZb3VyIG9yZ2FuaXphdGlvbiByZXF1aXJlcyB5b3VyIGhhcmQnIC1mICJgcmBuIgogICAgICAgICRMb2NhbDpTdHJNZXNzYWdlICs9ICd7MH0gZHJpdmUgdG8gYmUgZW5jeXB0ZWQuIEluIG9yZGVyIHRvJyAtZiAiYHJgbiIKICAgICAgICAkTG9jYWw6U3RyTWVzc2FnZSArPSAnezB9IGZpbmlzaCB0aGlzIHByb2Nlc3MsIHlvdSBuZWVkIHRvJyAtZiAiYHJgbiIKICAgICAgICAkTG9jYWw6U3RyTWVzc2FnZSArPSAnezB9IHJlc3RhcnQgeW91ciBjb21wdXRlci4gWW91IGNhbicgLWYgImByYG4iCiAgICAgICAgJExvY2FsOlN0ck1lc3NhZ2UgKz0gJ3swfSBlaXRoZXIgZG8gaXQgbWFudWFsbHksIG9yIGl0IHdpbGwnIC1mICJgcmBuIgogICAgICAgICRMb2NhbDpTdHJNZXNzYWdlICs9ICd7MH0gYXV0b21hdGljYWxseSBoYXBwZW4gaW4nIC1mICJgcmBuIgogICAgICAgICRMb2NhbDpTdHJNZXNzYWdlICs9ICd7MH0gezF9IG1pbnV0ZXMuJyAtZiAiYHJgbiIsJExvY2FsOlRpbWVUb1JlYm9vdEluTWludXRlcwogICAgICAgICRMb2NhbDpTdHJNZXNzYWdlICs9ICd7MH17MH0gU0FWRSBZT1VSIFdPUkshJyAtZiAiYHJgbiIKICAgICAgICAjPgogICAgfQogICAgI2VuZHJlZ2lvbiBQcm9tcHQtUmVib290ICAgIAojZW5kcmVnaW9uIEZ1bmN0aW9ucwoKCgojcmVnaW9uIEluaXRpYWxpemUKICAgIExvZ1dyaXRlICgnIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjJykKICAgIExvZ1dyaXRlICgnU3RhcnRpbmcgVHJpZ2dlciBCaXRMb2NrZXIgc2NyaXB0LicpCiAgICBMb2dXcml0ZSAoJyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIycpCiAgICBMb2dXcml0ZSAoJyMjIyBHZXQgc3RhdHMuJykKICAgICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKICAgICMjIEZldGNoIHByZXYgcnVuIHJlc3VsdHMgIyMKICAgICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMgICAgCiAgICBpZiAoLW5vdChUZXN0LVBhdGggLVBhdGggJFNjcmlwdDpGaWxlU3RhdHMpKSB7CiAgICAgICAgJFNjcmlwdDpDb3VudFJ1bnMgPSBbdWludDE2XSQoMCkKICAgICAgICAkU2NyaXB0OklzRmluaXNoZWQxc3RUaW1lID0gJFNjcmlwdDpJc0VuY3J5cHRlZCA9ICRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cgPSAkU2NyaXB0OklzQmFja3VwT0QgPSAkU2NyaXB0OklzQmFja3VwQUFEID0gW2Jvb2xdJCgkZmFsc2UpCiAgICAgICAgJFNjcmlwdDpPU0RyaXZlS2V5SUQgPSAkU2NyaXB0Ok9TRHJpdmVQcm90ZWN0aW9uUGFzc3dvcmQgPSBbc3RyaW5nXTo6RW1wdHkKICAgICAgICBMb2dXcml0ZSAoJyMgRmlyc3QgcnVuIScpCiAgICB9CiAgICBlbHNlIHsKICAgICAgICAkSW5wdXRTdHJpbmcgPSBbc3RyaW5nW11dJChHZXQtQ29udGVudCAtUGF0aCAkU2NyaXB0OkZpbGVTdGF0cykuU3BsaXQoW0Vudmlyb25tZW50XTo6TmV3TGluZSkKICAgICAgICAkU2NyaXB0OkNvdW50UnVucyA9IFt1aW50MTZdJCgkSW5wdXRTdHJpbmdbMF0pCiAgICAgICAgJFNjcmlwdDpJc0ZpbmlzaGVkMXN0VGltZSA9IFt1aW50MTZdJCgkSW5wdXRTdHJpbmdbMV0pCiAgICAgICAgJFNjcmlwdDpJc0VuY3J5cHRlZCA9IFt1aW50MTZdJCgkSW5wdXRTdHJpbmdbMl0pCiAgICAgICAgJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdyA9IFt1aW50MTZdJCgkSW5wdXRTdHJpbmdbM10pCiAgICAgICAgJFNjcmlwdDpJc0JhY2t1cE9EID0gW3VpbnQxNl0kKCRJbnB1dFN0cmluZ1s0XSkKICAgICAgICAkU2NyaXB0OklzQmFja3VwQUFEID0gW3VpbnQxNl0kKCRJbnB1dFN0cmluZ1s1XSkKICAgICAgICAkU2NyaXB0Ok9TRHJpdmVLZXlJRCA9IFtzdHJpbmddJCgkSW5wdXRTdHJpbmdbNl0pCiAgICAgICAgJFNjcmlwdDpPU0RyaXZlUHJvdGVjdGlvblBhc3N3b3JkID0gW3N0cmluZ10kKCRJbnB1dFN0cmluZ1s3XSkKICAgICAgICBMb2dXcml0ZSAoJyMgUHJldmlvdXMgcnVuIHJlc3VsdHM6JykKICAgICAgICBXcml0ZS1TdGF0cyAtUHJldmlvdXNPbmx5ICR0cnVlCiAgICB9CiAgICAKCiAgICAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiAgICAjIyMjIEdldCBjdXJyZW50IHN0YXR1cyAjIyMjCiAgICAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjICAKICAgIExvZ1dyaXRlICgnIyBDdXJyZW50IHN0YXR1czonKQogICAgICAgIAogICAgIyBHZXQgQ3VycmVudCBTdGF0dXMgZm9yIE9TIERyaXZlCiAgICBHZXQtQml0TG9ja2VyU3RhdHVzIC1Ecml2ZUxldHRlciAkU2NyaXB0Ok9TRHJpdmVMZXR0ZXIKICAgIFJlZnJlc2gtQml0TG9ja2VyVmFyaWFibGVzRm9yQ3VycmVudFZvbHVtZSAtRHJpdmVMZXR0ZXIgJFNjcmlwdDpPU0RyaXZlTGV0dGVyCiAgICAKCiAgICBpZiAoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQVykgewogICAgICAgIGlmICgkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzBdKSB7CiAgICAgICAgICAgICRTY3JpcHQ6SXNFbmNyeXB0ZWQgPSBbYm9vbF0kKCRTY3JpcHQ6Vm9sdW1lRW5jcnlwdGlvblN0YXR1cyAtZXEgJFNjcmlwdDpCaXRMb2NrZXJWb2x1bWVFbmNyeXB0aW9uU3RhdHVzZXNbMl0pCiAgICAgICAgfQogICAgICAgIGlmICgkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzFdKSB7CiAgICAgICAgICAgICRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cgPSBbYm9vbF0kKCRTY3JpcHQ6Q291bnRSZWNvdmVyeVBhc3N3b3JkcyAtZXEgMSkKICAgICAgICB9ICAgICAgICAgICAgICAgICAgIAogICAgfQogICAgZWxzZSB7CiAgICAgICAgJFNjcmlwdDpJc0VuY3J5cHRlZCA9ICRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cgPSBbYm9vbF0kKCRmYWxzZSkKICAgIH0KCgogICAgIyBPdGhlciBGaXhlZCBEcml2ZXMKICAgICNUT0RPCiAgICA8IwogICAgW1N0cmluZ1tdXSAkU2NyaXB0OkZpeGVkVm9sdW1lc0xldHRlcnMgPSBAKChHZXQtVm9sdW1lIHwgYAogICAgICAgIFdoZXJlLU9iamVjdCB7JF8uRHJpdmVUeXBlIC1lcSAnRml4ZWQnIC1hbmQgKC1ub3QoW3N0cmluZ106OklzTnVsbE9yRW1wdHkoJF8uRHJpdmVMZXR0ZXIpKSl9IHwgYAogICAgICAgIFdoZXJlLU9iamVjdCB7JF8uRHJpdmVMZXR0ZXIgLW5lICRPU0RyaXZlTGV0dGVyLlJlcGxhY2UoJzonLCcnKX0pLkRyaXZlTGV0dGVyKQogICAgCiAgICAkU2NyaXB0OkZpeGVkVm9sdW1lc0xldHRlcnMgfCBGb3JFYWNoLU9iamVjdCB7CiAgICAgICAgaWYgKC1ub3QoW3N0cmluZ106OklzTnVsbE9yRW1wdHkoJF8pKSkgewogICAgICAgICAgICBHZXQtQml0bG9ja2VyU3RhdHVzIC1Ecml2ZUxldHRlciAkXwogICAgICAgICAgICBpZiAoKEdldC1WYXJpYWJsZSAtTmFtZSAoJ3swfUNvdW50UHJvdGVjdGlvbktleXMnIC1mICRfKSAtU2NvcGUgJ1NjcmlwdCcpLkxlbmd0aCAtZ3QgMCkgewogICAgICAgICAgICAgICAgW3N0cmluZ1tdXSAkU2NyaXB0Ok90aGVyRW5jcnlwdGVkRHJpdmVzICs9IEAoJF8pCiAgICAgICAgICAgIH0KICAgICAgICB9ICAgICAKICAgIH0jPgoKICAgIFdyaXRlLVN0YXRzCiNlbmRyZWdpb24gSW5pdGlhbGl6ZQogICAgCgoKI3JlZ2lvbiBNYWluCiNyZWdpb24gRW5jcnlwdGlvbgojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKIyMjIyBCaXRMb2NrZXIgRW5jcnlwdGlvbiAjIyMjCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwpMb2dXcml0ZSAoJyMjIyBCaXRMb2NrZXIgRW5jcnlwdGlvbicpCgoKCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKIyBCaXRMb2NrZXIgRW5jcnlwdGlvbiBvZiBPUyBEcml2ZSAgIwojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiNyZWdpb24gQml0TG9ja2VyIEVuY3J5cHRpb24gb2YgT1MgRHJpdmUKCkxvZ1dyaXRlICgnIyBCaXRMb2NrZXIgRW5jcnlwdGlvbiBvZiBPUyBEcml2ZScpCmlmICgkU2NyaXB0OklzRW5jcnlwdGVkKSB7CiAgICBMb2dXcml0ZSAoJ09TIERyaXZlIGlzIGFscmVhZHkgZnVsbHkgZW5jcnlwdGVkLicpCn0KZWxzZSB7CiAgICAkU2NyaXB0OkJvb2xEaWRBbnl0aGluZ0NoYW5nZVRoaXNSdW50aW1lID0gW2Jvb2xdJCgkdHJ1ZSkKICAgIAogICAgIyBJZiAnRnVsbHlFbmNyeXB0ZWQnLCBhbmQgVFBNIHByZXNlbnQKICAgICMjIE1lYW5zIHRoYXQgT1MgRHJpdmUgaXMgc3VjY2Vzc2Z1bGx5IGVuY3J5cHRlZCB3aXRoIEJpdExvY2tlcgogICAgaWYgKCgkU2NyaXB0OlZvbHVtZUVuY3J5cHRpb25TdGF0dXMgLWVxICRTY3JpcHQ6Qml0TG9ja2VyVm9sdW1lRW5jcnlwdGlvblN0YXR1c2VzWzJdKSAtYW5kICRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMF0pIHsKICAgICAgICBMb2dXcml0ZSAoJ09TIERyaXZlIGlzIGZ1bGx5IGVuY3J5cHRlZCEnKQogICAgICAgICRTY3JpcHQ6SXNFbmNyeXB0ZWQgPSAkdHJ1ZQogICAgfQogICAgCgogICAgIyBJZiAnRW5jcnlwdGlvbkluUHJvZ3Jlc3MnIGFuZCBUUE0gcHJlc2VudAogICAgIyMgTWVhbnMgY29tcHV0ZXIgaGFzIHJlc3RhcnRlZCBhZnRlciBCaXRMb2NrZXIgZW5jcnlwdGlvbiB3YXMgZW5hYmxlZC4gV2FpdGluZyBmb3IgdGhlIHZvbHVtZSB0byBnZXQgZW5jcnlwdGVkCiAgICBlbHNlaWYgKCRTY3JpcHQ6Vm9sdW1lRW5jcnlwdGlvblN0YXR1cyAtZXEgJFNjcmlwdDpCaXRMb2NrZXJWb2x1bWVFbmNyeXB0aW9uU3RhdHVzZXNbMV0gLWFuZCAkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzBdKSB7CiAgICAgICAgTG9nV3JpdGUgKCdPUyBEcml2ZSBlbmNyeXB0aW9uIGlzIGluIHByb2dyZXNzOicpCiAgICAgICAgTG9nV3JpdGUgKCdSZXN0YXJ0IGhhdmUgdGFrZW4gcGxhY2UsIGFuZCBlbmNyeXB0aW9uIGhhcyBzdGFydGVkLicpCiAgICAgICAgTG9nV3JpdGUgKCdPUyBEcml2ZSBFbmNyeXB0aW9uIFBlcmNlbnRhZ2U6IHswfSUuJyAtZiAoJFNjcmlwdDpWb2x1bWVFbmNyeXB0aW9uUGVyY2VudGFnZSkpCiAgICAgICAgTG9nV3JpdGUgKCdDYW4gY29udGludWUgdG8gY2hlY2sgaWYgUmVjb3ZlcnkgUGFzc3dvcmQgaXMgcHJlc2VudCwgYW5kIGJhY2t1cCBpdC4nKQogICAgfQoKCiAgICAjIElmICdGdWxseURyZWN0eXB0ZWQnICAgICAKICAgIGVsc2VpZiAoJFNjcmlwdDpWb2x1bWVFbmNyeXB0aW9uU3RhdHVzIC1lcSAkU2NyaXB0OkJpdExvY2tlclZvbHVtZUVuY3J5cHRpb25TdGF0dXNlc1swXSkgeyAgICAgICAgCiAgICAgICAgIyBJZiAnRnVsbHlEcmVjdHlwdGVkJyBidXQgdGhlcmUgZXhpc3RzIGEgVFBNCiAgICAgICAgIyMgTWVhbnMgdGhhdCBlbmNyeXB0aW9uIGhhcyBzdGFydGVkLCBidXQgY29tcHV0ZXIgaXMgYXdhaXRpbmcgcmVzdGFydAogICAgICAgIGlmICgkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXIC1hbmQgJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1swXSkgewogICAgICAgICAgICBMb2dXcml0ZSAoJ09TIERyaXZlIEVuY3J5cHRpb24gaGFzIHN0YXJ0ZWQsIGJ1dCBjb21wdXRlciBoYXMgbm90IGJlZW4gcmVzdGFydGVkIHlldC4nKQogICAgICAgICAgICBMb2dXcml0ZSAoJ09TIERyaXZlIEVuY3J5cHRpb24gUGVyY2VudGFnZTogezB9JS4nIC1mICgkU2NyaXB0OlZvbHVtZUVuY3J5cHRpb25QZXJjZW50YWdlKSkKICAgICAgICAgICAgTG9nV3JpdGUgKCdDYW4gY29udGludWUgdG8gY2hlY2sgaWYgUmVjb3ZlcnkgUGFzc3dvcmQgaXMgcHJlc2VudCwgYW5kIGJhY2t1cCBpdC4nKQogICAgICAgIH0KICAgICAgICAKICAgICAgICAjIEVsc2UKICAgICAgICAjIyBNZWFucyBCaXRMb2NrZXIgc2hvdWxkIGJlIGVuYWJsZWQKICAgICAgICBlbHNlIHsKICAgICAgICAgICAgTG9nV3JpdGUgKCdPUyBEcml2ZSBpcyBub3QgZW5jcnlwdGVkLicpCiAgICAgICAgICAgIExvZ1dyaXRlICgnQXR0ZW1wdGluZyB0byBFbmFibGUgQml0TG9ja2VyIG9uIE9TIGRyaXZlICh7MH0pJyAtZiAoJE9TRHJpdmUpKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBTZXQgJFNraXBIYXJkd2FyZVRlc3QKICAgICAgICAgICAgJFNraXBIYXJkd2FyZVRlc3QgPSBbYm9vbF0kKAogICAgICAgICAgICAgICAgaWYgKCRTY3JpcHQ6Qm9vbFNraXBIYXJkd2FyZVRlc3RPbk5ld2x5RW5yb2xsZWREZXZpY2UpIHsKICAgICAgICAgICAgICAgICAgICAjIFNldCB0byB0cnVlIGlmIGl0J3MgbGVzcyB0aGFuIG9uZSBkYXkgc2luY2UgZW5yb2xsbWVudC4KICAgICAgICAgICAgICAgICAgICAkUGF0aCA9ICgnezB9XE1pY3Jvc29mdCBJbnR1bmUgTWFuYWdlbWVudCBFeHRlbnNpb24nIC1mICgke2VudjpQcm9ncmFtRmlsZXMoeDg2KX0pKQogICAgICAgICAgICAgICAgICAgIFtib29sXSQoCiAgICAgICAgICAgICAgICAgICAgICAgIFtkYXRldGltZV0kKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFtib29sXSQoVGVzdC1QYXRoIC1QYXRoICRQYXRoIC1FcnJvckFjdGlvbiAnU2lsZW50bHlDb250aW51ZScpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVHJ5ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkRGF0ZSA9IFtkYXRldGltZV0kKEdldC1JdGVtIC1QYXRoICRQYXRoIC1FcnJvckFjdGlvbiAnU2lsZW50bHlDb250aW51ZScgfCBTZWxlY3QtT2JqZWN0IC1FeHBhbmRQcm9wZXJ0eSAnQ3JlYXRpb25UaW1lVXRjJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCREYXRlIC1uZSBbZGF0ZXRpbWVdOjpNaW5WYWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJERhdGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgW2RhdGV0aW1lXTo6VXRjTm93CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ2F0Y2h7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtkYXRldGltZV06OlV0Y05vdwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtkYXRldGltZV06OlV0Y05vdwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICApIC1ndCBbZGF0ZXRpbWVdOjpVdGNOb3cuQWRkRGF5cygtMSkKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkZmFsc2UKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUcnkgdG8gZW5hYmxlIEJpdExvY2tlcgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgIyBFbmFibGUgQml0TG9ja2VyIHVzaW5nIFRQTQogICAgICAgICAgICAgICAgJG51bGwgPSBFbmFibGUtQml0TG9ja2VyIC1Nb3VudFBvaW50ICRPU0RyaXZlTGV0dGVyIC1UcG1Qcm90ZWN0b3IgLVVzZWRTcGFjZU9ubHk6JGZhbHNlIC1IYXJkd2FyZUVuY3J5cHRpb246JGZhbHNlIC1Ta2lwSGFyZHdhcmVUZXN0OiRTa2lwSGFyZHdhcmVUZXN0IC1FcnJvckFjdGlvbiAnQ29udGludWUnCiAgICAgICAgICAgICAgICBpZiAoJD8pIHsKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1N1Y2Nlc3NmdWxseSBlbmFibGVkIGJpdGxvY2tlci4nKSAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnRmFpbGVkIEVuYWJsaW5nIEJpdGxvY2tlciBUcG1Qcm90ZWN0b3IsIGl0YHMgcHJvYmFibHkgYWxyZWFkeSBlbmFibGVkJykKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSAKICAgICAgICAgICAgY2F0Y2ggewogICAgICAgICAgICAgICAgTG9nRXJyb3JzCiAgICAgICAgICAgICAgICBFbmFibGUtQml0TG9ja2VyIC1Nb3VudFBvaW50ICRPU0RyaXZlTGV0dGVyIC1UcG1Qcm90ZWN0b3IgLVVzZWRTcGFjZU9ubHk6JGZhbHNlIC1IYXJkd2FyZUVuY3J5cHRpb246JGZhbHNlIC1Ta2lwSGFyZHdhcmVUZXN0OiRTa2lwSGFyZHdhcmVUZXN0IC1FcnJvckFjdGlvbiAnU2lsZW50bHlDb250aW51ZScKICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnV2lsbCBhdHRlbXB0IHRvIEVuYWJsZSBCaXRMb2NrZXIgYW55d2F5IGFuZCB0aGVuIGNvbnRpbnVlLiBTdWNjZXNzPyB7MH0nIC1mICgkPykpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmluYWxseSB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0RpZCB3ZSBhY3R1YWxseSBlbmFibGUgQml0TG9ja2VyPycpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUmVmcmVzaCBWYXJpYWJsZXMKICAgICAgICAgICAgICAgIEdldC1CaXRMb2NrZXJTdGF0dXMgLURyaXZlTGV0dGVyICRPU0RyaXZlTGV0dGVyCiAgICAgICAgICAgICAgICBSZWZyZXNoLUJpdExvY2tlclZhcmlhYmxlc0ZvckN1cnJlbnRWb2x1bWUgLURyaXZlTGV0dGVyICRPU0RyaXZlTGV0dGVyCgogICAgICAgICAgICAgICAgIyBDaGVjayByZXN1bHQKICAgICAgICAgICAgICAgIGlmICgkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXIC1hbmQgJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1swXSkgewogICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnVFBNIHByZXNlbnQgZm9yIE9TIERyaXZlPyB7MH0nIC1mICgkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzBdKSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFByb21wdCByZWJvb3QgaWYgbm90ICRTa2lwSGFyZHdhcmVUZXN0CiAgICAgICAgICAgICAgICAgICAgaWYgKCRTa2lwSGFyZHdhcmVUZXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnTm90IHByb21wdGluZyBmb3IgcmVib290IC0gJFNraXBIYXJkd2FyZVRlc3QgaXMgJHRydWUuJykKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnUHJvbXB0aW5nIHJlYm9vdCAtICRTa2lwSGFyZHdhcmVUZXN0IGlzICRmYWxzZS4nKQogICAgICAgICAgICAgICAgICAgICAgICBQcm9tcHQtUmVib290CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdFUlJPUiwgbm90IGVuY3J5cHRlZC4gVFBNIG5vdCBwcmVzZW50IGZvciBPUyBEcml2ZScpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAjIElmIHNjZW5hcmlvIGZpdHMgbm9uZSBvZiB0aGUgY2FzZXMgYWJvdmUuLgogICAgZWxzZSB7CiAgICAgICAgTG9nV3JpdGUgKCdOZWl0aGVyICJ7MH0iLCAiezF9IiBvciAiezJ9Ii4nIC1mICgkU2NyaXB0OkJpdExvY2tlclZvbHVtZUVuY3J5cHRpb25TdGF0dXNlc1swXSwkU2NyaXB0OkJpdExvY2tlclZvbHVtZUVuY3J5cHRpb25TdGF0dXNlc1sxXSwkU2NyaXB0OkJpdExvY2tlclZvbHVtZUVuY3J5cHRpb25TdGF0dXNlc1syXSkpCiAgICB9Cn0KI2VuZHJlZ2lvbiBCaXRMb2NrZXIgRW5jcnlwdGlvbiBvZiBPUyBEcml2ZQoKCgojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiMgUHJvdGVjdGlvbiBQYXNzd29yZCBmb3IgT1MgRHJpdmUgICMKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwojcmVnaW9uIFByb3RlY3Rpb24gUGFzc3dvcmQgZm9yIE9TIERyaXZlCgpMb2dXcml0ZSAoJyMgQml0TG9ja2VyIFByb3RlY3Rpb24gUGFzc3dvcmQgZm9yIE9TIERyaXZlJykKIyBJZiAnRnVsbHlFbmNyeXB0ZWQnLCBvciBUTVAgaXMgcHJlc2VudAppZiAoJFNjcmlwdDpJc0VuY3J5cHRlZCAtb3IgKCRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFcgLWFuZCAkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzBdKSkgewogICAgCiAgICAKICAgICMgSWYgd2UncmUgZG9uZSB3aXRoIHJlY292ZXJ5IHBhc3N3b3JkKHMpIGFscmVhZHkKICAgIGlmICgkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3IC1hbmQgKCRTY3JpcHQ6Q291bnRSZWNvdmVyeVBhc3N3b3JkcyAtZXEgMSkpIHsKICAgICAgICBMb2dXcml0ZSAnUmVjb3ZlcnkgUGFzc3dvcmQgZm9yIE9TIERyaXZlIGlzIGFscmVhZHkgcHJlc2VudCcKICAgIH0KICAgIAoKICAgICMgSWYgd2UncmUgbm90IGRvbmUgd2l0aCByZWNvdmVyeSBwYXNzd29yZChzKQogICAgZWxzZSB7ICAgICAgICAKICAgICAgICAkU2NyaXB0OkJvb2xEaWRBbnl0aGluZ0NoYW5nZVRoaXNSdW50aW1lID0gW2Jvb2xdJCgkdHJ1ZSkKICAgICAgICAkTG9jYWw6U3VjY2VzcyA9IFtib29sXSQoJGZhbHNlKQogICAgICAgIAogICAgICAgIAogICAgICAgICMgSWYgdGhlcmUgZXhpc3RzIEJpdExvY2tlciBFbmNyeXB0aW9uIFJlY292ZXJ5IFBhc3N3b3JkICAgICAgIAogICAgICAgIGlmICgkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzFdKSB7CiAgICAgICAgICAgIAoKICAgICAgICAgICAgIyBJZiB0aGVyZXMgaXMgX2FfIFByb3RlY3Rpb25QYXNzd29yZCwgd2UncmUgZG9uZQogICAgICAgICAgICBpZiAoJFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzIC1lcSAxKSB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAnT25seSBhIHBhc3N3b3JkIHByZXNlbnQnCiAgICAgICAgICAgICAgICAkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3ID0gJHRydWUKICAgICAgICAgICAgICAgICRMb2NhbDpTdWNjZXNzID0gJHRydWUKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICMgSWYgdGhlcmUgaXMgbXVsdGlwbGUgUmVjb3ZlcnlQYXNzd29yZHMsIHdlIG5lZWQgdG8gcmVtb3ZlIGFsbCBidXQgb25lCiAgICAgICAgICAgIGVsc2VpZiAoJFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzIC1ndCAxKSB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAnTXVsdGlwbGUgcGFzc3dvcmRzIHByZXNlbnQnCiAgICAgICAgICAgICAgICBXcml0ZS1SZWNvdmVyeVBhc3N3b3JkCiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1dpbGwgcmVtb3ZlIGFsbCBidXQgdGhlIGZpcnN0IG9uZScpCiAgICAgICAgICAgICAgICAkU2NyaXB0OkFycmF5UmVjb3ZlcnlQYXNzd29yZHMgfCBGb3JFYWNoLU9iamVjdCB7IAogICAgICAgICAgICAgICAgICAgIGlmICgkXy4nS2V5UHJvdGVjdG9ySWQnIC1uZSAkU2NyaXB0OkFycmF5UmVjb3ZlcnlQYXNzd29yZHNbMF0uJ0tleVByb3RlY3RvcklkJykgewogICAgICAgICAgICAgICAgICAgICAgICAkbnVsbCA9IFJlbW92ZS1CaXRMb2NrZXJLZXlQcm90ZWN0b3IgLU1vdW50UG9pbnQgJE9TRHJpdmVMZXR0ZXIgLUtleVByb3RlY3RvcklkICRfLidLZXlQcm90ZWN0b3JJZCcKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQ/KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1N1Y2Nlc3NmdWxseSByZW1vdmVkIHwgS2V5UHJvdGVjdG9ySWQgInswfSIgfCBSZWNvdmVyeVBhc3N3b3JkICJ7MX0iJyAtZiAoJF8uJ0tleVByb3RlY3RvcklkJywkXy4nUmVjb3ZlcnlQYXNzd29yZCcpKQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1N1Y2Nlc3NmdWxseSBza2lwcGVkIHRoZSBmaXJzdCBrZXkuIHwgS2V5UHJvdGVjdG9ySWQgInswfSIgfCBSZWNvdmVyeVBhc3N3b3JkICJ7MX0iJyAtZiAoJF8uJ0tleVByb3RlY3RvcklkJywkXy4nUmVjb3ZlcnlQYXNzd29yZCcpKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBHZXQtQml0TG9ja2VyU3RhdHVzCiAgICAgICAgICAgICAgICBpZiAoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQVyAtYW5kICRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMV0gLWFuZCAoJFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzIC1lcSAxKSkgewogICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdWNjZXNzID0gJHRydWUKICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgIAogICAgICAgICAgICB9CgoKICAgICAgICAgICAgIyBUaGlzIHNob3VsZCBub3QgYmUgcG9zc2libGUKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAnRVJST1I6IFJlY292ZXJ5UGFzc3dvcmQgcHJlc2VudCwgYnV0IGNvdW50IDwgMScKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgCiAgICAgICAgI3JlZ2lvbiBBZGQgUHJvdGVjdGlvbiBQYXNzd29yZCBJZiBOb25lIFByZXNlbnQKICAgICAgICBlbHNlIHsKICAgICAgICAgICAgTG9nV3JpdGUgKCdObyBCaXRMb2NrZXIgUmVjb3ZlcnkgUGFzc3dvcmRzIGZvdW5kIGZvciBPUyBEcml2ZSB7MH0sIGNyZWF0aW5nIG9uZS4nIC1mICgkT1NEcml2ZUxldHRlcikpCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAkbnVsbCA9IEFkZC1CaXRMb2NrZXJLZXlQcm90ZWN0b3IgLU1vdW50UG9pbnQgJE9TRHJpdmVMZXR0ZXIgLVJlY292ZXJ5UGFzc3dvcmRQcm90ZWN0b3IgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJyAtV2FybmluZ0FjdGlvbiAnU2lsZW50bHlDb250aW51ZScKICAgICAgICAgICAgICAgIGlmICgkPykgewogICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdWNjZXNzID0gJHRydWUKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICRudWxsID0gRW5hYmxlLUJpdExvY2tlciAtTW91bnRQb2ludCAkT1NEcml2ZUxldHRlciAtUmVjb3ZlcnlQYXNzd29yZFByb3RlY3RvciAtVXNlZFNwYWNlT25seTokZmFsc2UgLUhhcmR3YXJlRW5jcnlwdGlvbjokZmFsc2UgLVNraXBIYXJkd2FyZVRlc3Q6JGZhbHNlIC1FcnJvckFjdGlvbiAnU3RvcCcKICAgICAgICAgICAgICAgICAgICBpZiAoJD8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN1Y2Nlc3MgPSAkdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgIH0gCiAgICAgICAgICAgIGNhdGNoIHsKICAgICAgICAgICAgICAgIExvZ0Vycm9ycwogICAgICAgICAgICAgICAgJG51bGwgPSBBZGQtQml0TG9ja2VyS2V5UHJvdGVjdG9yIC1Nb3VudFBvaW50ICRPU0RyaXZlTGV0dGVyIC1SZWNvdmVyeVBhc3N3b3JkUHJvdGVjdG9yIC1FcnJvckFjdGlvbiAnU2lsZW50bHlDb250aW51ZScgLVdhcm5pbmdBY3Rpb24gJ1NpbGVudGx5Q29udGludWUnCiAgICAgICAgICAgICAgICBpZiAoJExhc3RFeGl0Q29kZSAtZXEgMCkgewogICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdWNjZXNzID0gJHRydWUKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICRudWxsID0gRW5hYmxlLUJpdExvY2tlciAtTW91bnRQb2ludCAkT1NEcml2ZUxldHRlciAtUmVjb3ZlcnlQYXNzd29yZFByb3RlY3RvciAtVXNlZFNwYWNlT25seTokZmFsc2UgLUhhcmR3YXJlRW5jcnlwdGlvbjokZmFsc2UgLVNraXBIYXJkd2FyZVRlc3Q6JGZhbHNlIC1FcnJvckFjdGlvbiAnU2lsZW50bHlDb250aW51ZScKICAgICAgICAgICAgICAgICAgICBpZiAoJD8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN1Y2Nlc3MgPSAkdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnVHJpZWQgdG8gYWRkIEJpdExvY2tlciBSZWNvdmVyeVBhc3N3b3JkUHJvdGVjdG9yLiBTdWNjZXNzPyB7MH0uJyAtZiAoJExvY2FsOlN1Y2Nlc3MpKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIEFkZCBQcm90ZWN0aW9uIFBhc3N3b3JkIElmIE5vbmUgUHJlc2VudAoKICAgICAgICAKCiAgICAgICAgIyBDb3VudCBhbmQgbGlzdCBleGlzdGluZyBSZWNvdmVyeVBhc3N3b3JkLCBvbmx5IHdyaXRlIHN1Y2Nlc3MgaWYgdGhlcmVzIG9uZSAgICAgICAgCiAgICAgICAgaWYgKCRMb2NhbDpTdWNjZXNzKSB7CiAgICAgICAgICAgIExvZ1dyaXRlICdDaGVja2luZyBpZiB0aGVyZSBpcyBvbmx5IG9uZSBQcm90ZWN0aW9uIFBhc3N3b3JkLicKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVmcmVzaCBWYXJpYWJsZXMgZm9yIGN1cnJlbnQgdm9sdW1lCiAgICAgICAgICAgIEdldC1CaXRMb2NrZXJTdGF0dXMgLURyaXZlTGV0dGVyICRPU0RyaXZlTGV0dGVyCiAgICAgICAgICAgIFJlZnJlc2gtQml0TG9ja2VyVmFyaWFibGVzRm9yQ3VycmVudFZvbHVtZSAtRHJpdmVMZXR0ZXIgJE9TRHJpdmVMZXR0ZXIKCiAgICAgICAgICAgICMgQ2hlY2sgcmVzdWx0cwogICAgICAgICAgICAkTG9jYWw6Qm9vbFRlbXAgPSBbYm9vbF0kKGlmKCRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFcpeygkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzFdKX1lbHNleyRmYWxzZX0pCiAgICAgICAgICAgIExvZ1dyaXRlICgnUHJvdGVjdGlvbiBQYXNzd29yZCBQcmVzZW50PyB7MH0nIC1mICgkTG9jYWw6Qm9vbFRlbXApKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoJExvY2FsOkJvb2xUZW1wKSB7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICgkU2NyaXB0OkNvdW50UmVjb3ZlcnlQYXNzd29yZHMgLWVxIDEpIHsgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdTVUNDRVNTLCBrZXlzIGxlZnQ6IDEuJykKICAgICAgICAgICAgICAgICAgICAkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3ID0gJHRydWUKICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICdGQUlMLCBrZXlzIGxlZnQ6IHswfS4nIC1mICgkU2NyaXB0OkNvdW50UmVjb3ZlcnlQYXNzd29yZHMpCiAgICAgICAgICAgICAgICAgICAgJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdyA9ICRmYWxzZQogICAgICAgICAgICAgICAgfSAgCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0ZBSUwsIG5vIFByb3RlY3Rpb24gUGFzc3dvcmQgZm91bmQnKQogICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAKICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAKICAgICAgICBlbHNlIHsKICAgICAgICAgICAgTG9nV3JpdGUgKCdTb21ldGhpbmcgZmFpbGVkJykKICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAKICAgIH0KICAgICNlbmRyZWdpb24gSWYgdGhlcmVzIDAgb3IgbXVsdGlwbGUgUHJvdGVjdGlvbnNQYXNzd29yZChzKSAKfQoKCiMgTm90IGVuY3J5cHRlZCA9IE5vIG1ha2luZyBvZiBSZWNvdmVyeVBhc3N3b3JkCmVsc2UgewogICAgTG9nV3JpdGUgKCdPUyBEcml2ZSBpcyAiRnVsbHlEZWNyeXB0ZWQiIGFuZCB0aGVyZSBleGlzdHMgbm8gIlRQTSIuJykKICAgIExvZ1dyaXRlICgnQml0TG9ja2VyIFJlY292ZXJ5UGFzc3dvcmQgY2FuIG5vdCBiZSBhZGRlZCBhdCB0aGlzIHRpbWUuJykKICAgIExvZ1dyaXRlICgnUmVjb3ZlcnkgUGFzc3dvcmQgcHJlc2VudD8gezB9JyAtZiAoW3N0cmluZ10kKGlmKCRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFcpeyRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMF19ZWxzZXskZmFsc2V9KSkpCiAgICAkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3ID0gJGZhbHNlCn0KCiMgV3JpdGUgcmVjb3ZlcnkgcGFzc3dvcmQocykgaWYgYW55dGhpbmcgY2hhbmdlZCB0aGlzIHJ1bnRpbWUKaWYgKCRTY3JpcHQ6Qm9vbERpZEFueXRoaW5nQ2hhbmdlVGhpc1J1bnRpbWUgLWFuZCAkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzFdKSB7CiAgICBXcml0ZS1SZWNvdmVyeVBhc3N3b3JkCn0KI2VuZHJlZ2lvbiBQcm90ZWN0aW9uIFBhc3N3b3JkIGZvciBPUyBEcml2ZQojZW5kcmVnaW9uIEVuY3J5cHRpb24KCgoKIyMjIyMjIyMjIyMjIyMjIyMjIyMKIyMjIyMjIEJBQ0tVUCAjIyMjIyMKIyMjIyMjIyMjIyMjIyMjIyMjIyMKI3JlZ2lvbiBCYWNrdXAKCgpMb2dXcml0ZSAoJyMjIyBCYWNrdXAgUHJvdGVjdGlvbiBQYXNzd29yZCB0byBBenVyZUFBRCBhbmQgT25lRHJpdmU0QicpCgojIENoZWNrIGZvciBjaGFuZ2VzIGlmIEZpbmlzaGVkMXN0VGltZQppZiAoJFNjcmlwdDpJc0ZpbmlzaGVkMXN0VGltZSAtb3IgJFNjcmlwdDpJc0JhY2t1cEFBRCAtYW5kIFtib29sXSQoW2Jvb2xdJCgkU2NyaXB0OkJvb2xCYWNrdXBUb09uZURyaXZlRm9yQnVzaW5lc3MgLWFuZCAkU2NyaXB0OklzQmFja3VwT0QpIC1vciBbYm9vbF0kKC1ub3QoJFNjcmlwdDpCb29sQmFja3VwVG9PbmVEcml2ZUZvckJ1c2luZXNzKSkpKSB7CiAgICBMb2dXcml0ZSAoJ0RyaXZlIGlzIGFscmVhZHkgYmFja2VkIHVwLicpCiAgICBMb2dXcml0ZSAoJ1dpbGwgY2hlY2sgaWYgYW55dGhpbmcgaGFzIGNoYW5nZWQuJykKCiAgICBpZiAoQ2hlY2stSWZCaXRMb2NrZXJQV0hhc0NoYW5nZWQpIHsKICAgICAgICBMb2dXcml0ZSAnU29tZXRoaW5nIGhhcyBjaGFuZ2VkLCBCaXRMb2NrZXIgUmVjb3ZlcnkgUHJvdGVjdGlvbiBQYXNzd29yZCBpcyBub3QgdGhlIHNhbWUgYXMgdGhlIG9uZSBiYWNrZWQgdXAuJwogICAgICAgICRTY3JpcHQ6SXNCYWNrdXBBQUQgPSAkU2NyaXB0OklzQmFja3VwT0QgPSAkZmFsc2UKICAgICAgICAkU2NyaXB0OkJvb2xEaWRBbnl0aGluZ0NoYW5nZVRoaXNSdW50aW1lID0gJHRydWUKICAgIH0KICAgIGVsc2UgewogICAgICAgIExvZ1dyaXRlICdOb3RoaW5nIGhhcyBjaGFuZ2VkLCBCaXRMb2NrZXIgUmVjb3ZlcnkgUHJvdGVjdGlvbiBQYXNzd29yZCBpcyB0aGUgc2FtZSBhcyB0aGUgb25lIHByZXZpb3VzbHkgYmFja2VkIHVwLicKICAgIH0KfQoKCiMgSWYgbm8gYmFja3VwcwppZiAoLW5vdCgkU2NyaXB0OklzQmFja3VwQUFEIC1hbmQgW2Jvb2xdJChbYm9vbF0kKCRTY3JpcHQ6Qm9vbEJhY2t1cFRvT25lRHJpdmVGb3JCdXNpbmVzcyAtYW5kICRTY3JpcHQ6SXNCYWNrdXBPRCkgLW9yIFtib29sXSQoLW5vdCgkU2NyaXB0OkJvb2xCYWNrdXBUb09uZURyaXZlRm9yQnVzaW5lc3MpKSkpKSB7CiAgICAjIElmIFByb3RlY3Rpb25QYXNzd29yZChzKSBleGlzdAogICAgaWYgKCRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cpIHsKICAgICAgICAgICAgCiAgICAgICAgTG9nV3JpdGUgKCdPUyBEcml2ZSBpcyBlbmNyeXB0ZWQsIGFuZCB0aGVyZSBhcmUgezB9IFByb3RlY3Rpb25QYXNzd29yZChzKSBwcmVzZW50LicgLWYgKCRTY3JpcHQ6QXJyYXlSZWNvdmVyeVBhc3N3b3Jkcy4nQ291bnQnKSkKICAgICAgICBMb2dXcml0ZSAoJ1dyaXRpbmcgZXhpc3RpbmcgUmVjb3ZlcnlQYXNzd29yZCBmb3IgY3VycmVudCBkcml2ZSwgZm9yIGZ1dHVyZSByZWZlcmVuY2UuLi4nKQogICAgICAgICRudWxsID0gQ2hlY2stSWZCaXRMb2NrZXJQV0hhc0NoYW5nZWQKICAgICAgICAKICAgICAgICBMb2dXcml0ZSAoJ0NvbnRpbnVpbmcgd2l0aCBiYWNrdXAuJykKCiAgICAKICAgICAgICAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKICAgICAgICAjIE9uZURyaXZlIGZvciBCdXNpbmVzcyBiYWNrdXAKICAgICAgICAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKICAgICAgICAjcmVnaW9uIEJhY2t1cCBPbmVEcml2ZSBmb3IgQnVzaW5lc3MKICAgIAogICAgICAgIExvZ1dyaXRlICgnIyBCYWNrdXAgdG8gT25lRHJpdmUnKQogICAgICAgIGlmICgtbm90JFNjcmlwdDpCb29sQmFja3VwVG9PbmVEcml2ZUZvckJ1c2luZXNzKSB7CiAgICAgICAgICAgIExvZ1dyaXRlICgnRGlzYWJsZWQgaW4gc2NyaXB0IHNldHRpbmdzLicpCiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBMb2dXcml0ZSAoJ0VuYWJsZWQgaW4gc2NyaXB0IHNldHRpbmdzLicpCiAgICAgICAgICAgIGlmICgkU2NyaXB0OklzQmFja3VwT0QpIHsKICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnQWxyZWFkeSBkb25lJykKICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAkU2NyaXB0OkJvb2xEaWRBbnl0aGluZ0NoYW5nZVRoaXNSdW50aW1lID0gJHRydWUKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBUcnkgewogICAgICAgICAgICAgICAgICAgICMgR2V0IEN1cnJlbnQgVXNlciBhcyBTZWN1cml0eUlkZW50aWZpZXIKICAgICAgICAgICAgICAgICAgICBpZiAoLW5vdCgkU2NyaXB0OlBhdGhEaXJSb290Q1UpKXsKICAgICAgICAgICAgICAgICAgICAgICAgJFNjcmlwdDpQYXRoRGlyUm9vdENVID0gW3N0cmluZ10kKCdSZWdpc3RyeTo6SEtFWV9VU0VSU1x7MH1cJyAtZiAoW1N5c3RlbS5TZWN1cml0eS5QcmluY2lwYWwuTlRBY2NvdW50XTo6bmV3KChHZXQtUHJvY2VzcyAtTmFtZSAnZXhwbG9yZXInIC1JbmNsdWRlVXNlck5hbWUgfCBTZWxlY3QtT2JqZWN0IC1FeHBhbmRQcm9wZXJ0eSAnVXNlck5hbWUnIC1GaXJzdCAxKSkuVHJhbnNsYXRlKFtTeXN0ZW0uU2VjdXJpdHkuUHJpbmNpcGFsLlNlY3VyaXR5SWRlbnRpZmllcl0pLidWYWx1ZScpKQogICAgICAgICAgICAgICAgICAgICAgICBpZigoLW5vdCgkPykpIC1vciBbc3RyaW5nXTo6SXNOdWxsT3JFbXB0eSgkUGF0aERpclJvb3RDVSkpe0JyZWFrfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBHZXQgT25lRHJpdmUgZm9yIEJ1c2luZXNzIHBhdGggZnJvbSByZWdpc3RyeSAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgJFJlZ1ZhbHVlcyA9IFthcnJheV0kKEdldC1DaGlsZEl0ZW0gLVBhdGggKCd7MH1cU09GVFdBUkVcTWljcm9zb2Z0XE9uZURyaXZlXEFjY291bnRzXCcgLWYgKCRQYXRoRGlyUm9vdENVKSkgfCBXaGVyZS1PYmplY3QgLVByb3BlcnR5ICdOYW1lJyAtbGlrZSAnKlxCdXNpbmVzcyonKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgRXhpdCBUcnkvQ2F0Y2ggaWYgbm8gYWNjb3VudHMgd2hlcmUgZm91bmQKICAgICAgICAgICAgICAgICAgICBpZiAoJFJlZ1ZhbHVlcy4nQ291bnQnIC1sZSAwKSB7ICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICRTY3JpcHQ6SXNCYWNrdXBPRCA9ICRmYWxzZQogICAgICAgICAgICAgICAgICAgICAgICBUaHJvdyAoJ0ZhaWxlZCB0byBmaW5kIE9uZURyaXZlIGZvciBCdXNpbmVzcyBhY2NvdW50cy4nKQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgIyBGb3IgZWFjaCBmb3VuZCBPbmVEcml2ZSBmb3IgQnVzaW5lc3MgYWNjb3VudAogICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRSZWdWYWx1ZSBpbiAkUmVnVmFsdWVzKSB7ICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpQYXRoRGlyT0Q0QiA9IFtzdHJpbmddJChHZXQtSXRlbVByb3BlcnR5IC1QYXRoICRSZWdWYWx1ZS4nTmFtZScuUmVwbGFjZSgnSEtFWV9VU0VSU1wnLCdSZWdpc3RyeTo6SEtFWV9VU0VSU1wnKSAtTmFtZSAnVXNlckZvbGRlcicpLidVc2VyRm9sZGVyJwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBFeGl0IFRyeS9DYXRjaCBpZiBmYWlsZWQgdG8gYnVpbGQgcGF0aCBmb3IgT25lRHJpdmUgZm9yIEJ1c2luZXNzIGZvbGRlciAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkTG9jYWw6UGF0aERpck9ENEIgLW5vdGxpa2UgKCd7MH1cVXNlcnNcKlxPbmVEcml2ZSAtKicgLWYgKCRPU0RyaXZlKSkgLWFuZCAoLW5vdFtib29sXSQoVGVzdC1QYXRoIC1QYXRoICRMb2NhbDpQYXRoRGlyT0Q0QikpKSB7ICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJFNjcmlwdDpJc0JhY2t1cE9EID0gJGZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaHJvdyAoJ0ZhaWxlZCB0byBidWlsZCBPbmVEcml2ZSBwYXRoICgiezB9IiksIG9yIGl0IGRvZXMgbm90IGV4aXN0LicgLWYgKCRMb2NhbDpQYXRoKSkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIENyZWF0ZSBzY3JpcHQgdmFyaWFibGVzIGlmIHRoZXkgZG8gbm90IGV4aXN0IGFscmVhZHkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKC1ub3QoJFNjcmlwdDpDb21wdXRlclByb2R1Y3ROYW1lKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgQ3JlYXRlLUVudlZhcmlhYmxlcwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBSdW50aW1lIHZhcmlhYmxlCiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpCb29sRm9sZGVyRXhpc3RzID0gW2Jvb2xdJCgkZmFsc2UpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKCiAgICAgICAgICAgICAgICAgICAgICAgICMgQ3JlYXRpbmcgcGF0aHMKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwUGFyZW50ID0gW3N0cmluZ10kKCd7MH1cQml0TG9ja2VyIFJlY292ZXJ5XCcgLWYgKCRMb2NhbDpQYXRoRGlyT0Q0QikpCiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpQYXRoRGlyT0Q0QkJhY2t1cCA9IFtzdHJpbmddJCgnezB9ezF9ICh7Mn0gezN9KVwnIC1mICgkTG9jYWw6UGF0aERpck9ENEJCYWNrdXBQYXJlbnQsJFNjcmlwdDpDb21wdXRlck5hbWUsJFNjcmlwdDpDb21wdXRlck1hbnVmYWN0dXJlciwkU2NyaXB0OkNvbXB1dGVyUHJvZHVjdE5hbWUpKQogICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ09uZURyaXZlIGZvciBCdXNpbmVzcyBQYXRoOiB7MH0nIC1mICgkTG9jYWw6UGF0aERpck9ENEIpKQogICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0JhY2t1cCBQYXRoIFBhcmVudDogICAgICAgICB7MH0nIC1mICgkTG9jYWw6UGF0aERpck9ENEJCYWNrdXBQYXJlbnQpKQogICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0JhY2t1cCBQYXRoIGZvciBCaXRsb2NrZXIgUmVjb3ZlcnkgS2V5KHMpOiB7MH0nIC1mICgkTG9jYWw6UGF0aERpck9ENEJCYWNrdXApKSAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAoKICAgICAgICAgICAgICAgICAgICAgICAgI1Rlc3RpbmcgaWYgUmVjb3ZlcnkgZm9sZGVyIGV4aXN0cyBpZiBub3QgY3JlYXRlIG9uZQogICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1Rlc3RpbmcgaWYgYmFja3VwIGZvbGRlciBleGlzdHMsIGNyZWF0ZSBpdCBpZiBub3QuJykKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFRlc3QtUGF0aCAtUGF0aCAkTG9jYWw6UGF0aERpck9ENEJCYWNrdXAgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOkJvb2xGb2xkZXJFeGlzdHMgPSAkdHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgJ0NyZWF0aW5nIE9uZURyaXZlIGZvciBCdXNpbmVzcyBmb2xkZXIgZm9yIGJhY2t1cC4nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbnVsbCA9IE5ldy1JdGVtIC1QYXRoICRMb2NhbDpQYXRoRGlyT0Q0QkJhY2t1cCAtSXRlbVR5cGUgJ0RpcmVjdG9yeScgLUZvcmNlIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOkJvb2xGb2xkZXJFeGlzdHMgPSBUZXN0LVBhdGggLVBhdGggJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ3swfScgLWYgJChpZigkTG9jYWw6Qm9vbEZvbGRlckV4aXN0cyl7J1N1Y2Nlc3MuJ31lbHNleydGYWlsZWQuJ30pKQogICAgICAgICAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKCiAgICAgICAgICAgICAgICAgICAgICAgICMgRXhpdCBUcnkvQ2F0Y2ggb2YgZmFpbGVkIHRvIGNyZWF0ZSBPbmVEcml2ZSBmb3IgQnVzaW5lc3MgQmFja3VwIGlmIGl0IGRpZG4ndCBleGlzdAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoLW5vdCgkTG9jYWw6Qm9vbEZvbGRlckV4aXN0cykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRTY3JpcHQ6SXNCYWNrdXBPRCA9ICRmYWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhyb3cgJ0ZhaWxlZCB0byBjaGVjayBvciBjcmVhdGUgZm9sZGVyLicKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBNYWtlIHN1cmUgJ0JpdExvY2tlciBSZWNvdmVyeScgZm9sZGVyIGlzIGhpZGRlbgogICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ01ha2luZyBzdXJlICJ7MH0iIGlzIGhpZGRlbi4nIC1mICgkTG9jYWw6UGF0aERpck9ENEJCYWNrdXBQYXJlbnQpKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoKEdldC1JdGVtIC1QYXRoICRMb2NhbDpQYXRoRGlyT0Q0QkJhY2t1cFBhcmVudCAtRm9yY2UpLkF0dHJpYnV0ZXMgLW5vdGxpa2UgJypoaWRkZW4qJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgKEdldC1JdGVtIC1QYXRoICRMb2NhbDpQYXRoRGlyT0Q0QkJhY2t1cFBhcmVudCAtRm9yY2UpLkF0dHJpYnV0ZXMgPSAoR2V0LUl0ZW0gLVBhdGggJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwUGFyZW50IC1Gb3JjZSkuQXR0cmlidXRlcyAtYm9yICdIaWRkZW4nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1N1Y2Nlc3NmdWxseSBoaWRkZW4/IHswfS4nIC1mICgkPykpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0FscmVhZHkgaGlkZGVuLicpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKCiAgICAgICAgICAgICAgICAgICAgICAgICMgR2V0IEFycmF5UmVjb3ZlcnlQYXNzd29yZHMgZm9yIGN1cnJlbnQgdm9sdW1lCiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpDdXJyZW50Vm9sdW1lQXJyYXlSZWNvdmVyeVBhc3N3b3JkcyA9IEdldC1WYXJpYWJsZSAtTmFtZSAoJ3swfUFycmF5UmVjb3ZlcnlQYXNzd29yZHMnIC1mICgkT1NEcml2ZUxldHRlcikpIC1TY29wZSAnU2NyaXB0JyAtVmFsdWVPbmx5IC1FcnJvckFjdGlvbiAnU3RvcCcKCiAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBDcmVhdGUgc3RyaW5nIGZvciBCaXRMb2NrZXJSZWNvdmVyeVBhc3N3b3JkLnR4dAogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyA9IFtzdHJpbmddOjpFbXB0eQogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAoJ0JpdExvY2tlciBSZWNvdmVyeVBhc3N3b3JkIGZvciBPUyBEcml2ZSAoezB9KXsxfScgLWYgKCRlbnY6U3lzdGVtRHJpdmUsImByYG4iKSkKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gR2V0LVN0cmluZ1JlY292ZXJ5UGFzc3dvcmRzCiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICJgcmBuYHJgbiIKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gJ0JpdExvY2tlciBEcml2ZSBFbmNyeXB0aW9uIHJlY292ZXJ5IGtleXswfScgLWYgImByYG4iCiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICdUbyB2ZXJpZnkgdGhhdCB0aGlzIGlzIHRoZSBjb3JyZWN0IHJlY292ZXJ5IGtleSwgY29tcGFyZSB0aGUgc3RhcnQgb2YgdGhlIGZvbGxvd2luZ3swfScgLWYgImByYG4iCiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICdpZGVudGlmaWVyIHdpdGggdGhlIGlkZW50aWZpZXIgdmFsdWUgZGlzcGxheWVkIG9uIHlvdXIgUEMuJwogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAiYHJgbmByYG4iCiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICgnSWRlbnRpZmllcjogezB9JyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVBcnJheVJlY292ZXJ5UGFzc3dvcmRzWzBdLktleVByb3RlY3RvcklkKSkKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gImByYG5gcmBuIgogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAnSWYgdGhlIGFib3ZlIGlkZW50aWZpZXIgbWF0Y2hlcyB0aGUgb25lIGRpc3BsYXllZCBieSB5b3VyIFBDLHswfScgLWYgImByYG4iCiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICd0aGVuIHVzZSB0aGUgZm9sbG93aW5nIGtleSB0byAgdW5sb2NrIHlvdXIgZHJpdmU6JwogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAiYHJgbmByYG4iCiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICgnUmVjb3ZlcnkgS2V5OiB7MH0nIC1mICgkTG9jYWw6Q3VycmVudFZvbHVtZUFycmF5UmVjb3ZlcnlQYXNzd29yZHNbMF0uUmVjb3ZlcnlQYXNzd29yZCkpCiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICJgcmBuYHJgbiIKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gJ0lmIHRoZSBhYm92ZSBpZGVudGlmaWVyIGRvZXNuYHQgbWF0Y2ggdGhlIG9uZSBkaXNwbGF5ZWQgYnkgeW91ciBQQyx7MH0nIC1mICJgcmBuIgogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAndGhlbiB0aGlzIGlzbmB0IHRoZSByaWdodCBrZXkgdG8gdW5sb2NrIHlvdXIgZHJpdmUuezB9JyAtZiAiYHJgbiIKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gJ1RyeSBhbm90aGVyIHJlY292ZXJ5IGtleSwgb3IgcmVmZXIgdG97MH0nIC1mICJgcmBuIiAKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gJ2h0dHBzOi8vZ28ubWljcm9zb2Z0LmNvbS9md2xpbmsvP0xpbmtJRD0yNjA1ODkgZm9yIGFkZGl0aW9uYWwgYXNzaXN0YW5jZS4nCgoKICAgICAgICAgICAgICAgICAgICAgICAgIyBPdXQtRmlsZSB0aGUgc3RyaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICdDcmVhdGluZyBiYWNrdXAgaW4gT25lRHJpdmUgZm9yIEJ1c2luZXNzLicKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOk9ENEJCYWNrdXBGaWxlUGF0aCA9IFtzdHJpbmddJCgnezB9Qml0bG9ja2VyUmVjb3ZlcnlQYXNzd29yZC17MX0udHh0JyAtZiAoJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwLChHZXQtRGF0ZSAtRm9ybWF0ICd5eU1NZGRoaG1tc3MnKSkpCiAgICAgICAgICAgICAgICAgICAgICAgIE91dC1GaWxlIC1GaWxlUGF0aCAkTG9jYWw6T0Q0QkJhY2t1cEZpbGVQYXRoIC1FbmNvZGluZyAndXRmOCcgLUZvcmNlIC1JbnB1dE9iamVjdCAoJExvY2FsOlN0clJlY1Bhc3MpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChUZXN0LVBhdGggLVBhdGggJExvY2FsOk9ENEJCYWNrdXBGaWxlUGF0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJFNjcmlwdDpJc0JhY2t1cE9EID0gJHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgICAgIAoKCiAgICAgICAgICAgICAgICAgICAgICAgICMgT25lRHJpdmUgZm9yIEJ1c2luZXNzIEJhY2t1cCBTdWNjZXNzPwogICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1N1Y2Nlc3M/IHswfScgLWYgKCRTY3JpcHQ6SXNCYWNrdXBPRCkpCiAgICAgICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBDYXRjaCB7CiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdFcnJvciB3aGlsZSBiYWNrdXAgdG8gT25lRHJpdmUsIG1ha2Ugc3VyZSB0aGF0IHlvdSBhcmUgQUFEIGpvaW5lZCBhbmQgYXJlIHJ1bm5pbmcgdGhlIGNtZGxldCBhcyBhbiBhZG1pbi4nKQogICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnRXJyb3IgbWVzc2FnZTonICsgImByYG4iICsgKCRfKSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIEZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnRGlkIGJhY2t1cCB0byBPbmVEcml2ZSBzdWNjZWVkPyB7MH0nIC1mICgkU2NyaXB0OklzQmFja3VwT0QpKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gQmFja3VwIE9uZURyaXZlIGZvciBCdXNpbmVzcwogICAgCgoKICAgICAgICAjIyMjIyMjIyMjIyMjIyMjIwogICAgICAgICMgQXp1cmUgQUQgQmFja3VwCiAgICAgICAgIyMjIyMjIyMjIyMjIyMjIyMKICAgICAgICAjcmVnaW9uIEJhY2t1cCBBenVyZSBBQUQKCiAgICAgICAgTG9nV3JpdGUgKCcjIEJhY2t1cCB0byBBenVyZSBBRCcpCiAgICAgICAgaWYgKCRTY3JpcHQ6SXNCYWNrdXBBQUQpIHsKICAgICAgICAgICAgTG9nV3JpdGUgKCdBbHJlYWR5IGRvbmUnKQogICAgICAgIH0KICAgICAgICAKICAgICAgICBlbHNlIHsKICAgICAgICAgICAgJFNjcmlwdDpCb29sRGlkQW55dGhpbmdDaGFuZ2VUaGlzUnVudGltZSA9ICR0cnVlCiAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIFRyeSB7CiAgICAgICAgICAgICAgICAjIEdldCBBcnJheVJlY292ZXJ5UGFzc3dvcmRzIGZvciBjdXJyZW50IHZvbHVtZQogICAgICAgICAgICAgICAgJExvY2FsOkN1cnJlbnRWb2x1bWVBcnJheVJlY292ZXJ5UGFzc3dvcmRzID0gR2V0LVZhcmlhYmxlIC1OYW1lICgnezB9QXJyYXlSZWNvdmVyeVBhc3N3b3JkcycgLWYgKCRPU0RyaXZlTGV0dGVyKSkgLVNjb3BlICdTY3JpcHQnIC1WYWx1ZU9ubHkgLUVycm9yQWN0aW9uICdTdG9wJwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIENoZWNrIGlmIHdlIGNhbiB1c2UgQmFja3VwVG9BQUQtQml0TG9ja2VyS2V5UHJvdGVjdG9yIGNvbW1hbmRsZXQgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBMb2dXcml0ZSAnQ2hlY2tpbmcgaWYgd2UgY2FuIHVzZSAiQmFja3VwVG9BQUQtQml0TG9ja2VyS2V5UHJvdGVjdG9yIiBjb21tYW5kbGV0LicKCiAgICAgICAgICAgICAgICBpZiAoR2V0LUNvbW1hbmQgLU5hbWUgJ0JhY2t1cFRvQUFELUJpdExvY2tlcktleVByb3RlY3RvcicgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJykgeyAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdDb21tYW5kbGV0IGV4aXN0cyEnIC1mICgkTG9jYWw6Q21kTmFtZSkpIAogICAgICAgICAgICAgICAgICAgICRudWxsID0gQmFja3VwVG9BQUQtQml0TG9ja2VyS2V5UHJvdGVjdG9yIC1Nb3VudFBvaW50ICRPU0RyaXZlTGV0dGVyIC1LZXlQcm90ZWN0b3JJZCAkTG9jYWw6Q3VycmVudFZvbHVtZUFycmF5UmVjb3ZlcnlQYXNzd29yZHNbMF0uJ0tleVByb3RlY3RvcklkJyAtRXJyb3JBY3Rpb24gJ1NpbGVudGx5Q29udGludWUnCiAgICAgICAgICAgICAgICAgICAgaWYgKCQ/KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRTY3JpcHQ6SXNCYWNrdXBBQUQgPSAkdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgJG51bGwgPSBCYWNrdXBUb0FBRC1CaXRMb2NrZXJLZXlQcm90ZWN0b3IgLU1vdW50UG9pbnQgJE9TRHJpdmVMZXR0ZXIgLUtleVByb3RlY3RvcklkICRMb2NhbDpDdXJyZW50Vm9sdW1lQXJyYXlSZWNvdmVyeVBhc3N3b3Jkc1swXS5LZXlQcm90ZWN0b3JJZCAtRXJyb3JBY3Rpb24gJ1N0b3AnCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkPykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJFNjcmlwdDpJc0JhY2t1cEFBRCA9ICR0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdTdWNjZXNzPyB7MH0nIC1mICgkU2NyaXB0OklzQmFja3VwQUFEKSkKICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgICAgICBlbHNlIHsgCiAgICAgICAgICAgICAgICAgICAgIyBCYWNrdXBUb0FBRC1CaXRMb2NrZXJLZXlQcm90ZWN0b3IgY29tbWFuZGxldCBub3QgYXZhaWxhYmxlLCB1c2luZyBvdGhlciBtZWNoYW5pc20gCiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgJ0JhY2t1cFRvQUFELUJpdExvY2tlcktleVByb3RlY3RvciBjb21tYW5kbGV0IG5vdCBhdmFpbGFibGUsIHVzaW5nIG90aGVyIG1lY2hhbmlzbS4nIAogICAgICAgICAgICAgICAgICAgICMgR2V0IHRoZSBBQUQgTWFjaGluZSBDZXJ0aWZpY2F0ZQogICAgICAgICAgICAgICAgICAgICRDZXJ0aWZpY2F0ZSAgICAgICAgICAgPSAoJChbYXJyYXldJChHZXQtQ2hpbGRJdGVtIC1QYXRoICdDZXJ0aWZpY2F0ZTo6TG9jYWxNYWNoaW5lXE15JykpLldoZXJleyRfLidJc3N1ZXInIC1tYXRjaCAnQ049TVMtT3JnYW5pemF0aW9uLUFjY2Vzcyd9KQogICAgICAgICAgICAgICAgICAgICRDZXJ0aWZpY2F0ZVRodW1icHJpbnQgPSBbc3RyaW5nXSQoJENlcnRpZmljYXRlIHwgU2VsZWN0LU9iamVjdCAtRXhwYW5kUHJvcGVydHkgJ1RodW1icHJpbnQnKQogICAgICAgICAgICAgICAgICAgICRDZXJ0aWZpY2F0ZVN1YmplY3QgICAgPSBbc3RyaW5nXSQoW3N0cmluZ10kKCRDZXJ0aWZpY2F0ZSB8IFNlbGVjdC1PYmplY3QgLUV4cGFuZFByb3BlcnR5ICdTdWJqZWN0JykuUmVwbGFjZSgnQ049JywnJykpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBHZXQgdGVuYW50IGRvbWFpbiBuYW1lIGZyb20gcmVnaXN0cnkKICAgICAgICAgICAgICAgICAgICAkVGVuYW50RG9tYWluID0gW3N0cmluZ10kKFtzdHJpbmddJChHZXQtSXRlbVByb3BlcnR5IC1QYXRoICgnUmVnaXN0cnk6OkhLRVlfTE9DQUxfTUFDSElORVxTWVNURU1cQ3VycmVudENvbnRyb2xTZXRcQ29udHJvbFxDbG91ZERvbWFpbkpvaW5cSm9pbkluZm9cezB9JyAtZiAoJENlcnRpZmljYXRlVGh1bWJwcmludCkpIC1OYW1lICdVc2VyRW1haWwnIHwgU2VsZWN0LU9iamVjdCAtRXhwYW5kUHJvcGVydHkgJ1VzZXJFbWFpbCcpLlNwbGl0KCdAJylbLTFdKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTWFrZSBzdXJlIHdlIGhhdmUgdmFsaWQgdmFsdWVzCiAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJFZhcmlhYmxlIGluIFthcnJheV0kKCRDZXJ0aWZpY2F0ZVRodW1icHJpbnQsJENlcnRpZmljYXRlU3ViamVjdCwkVGVuYW50RG9tYWluKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoW3N0cmluZ106OklzTnVsbE9yRW1wdHkoJFZhcmlhYmxlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhyb3cgJ0ZhaWxlZCB0byBiYWNrdXAgdG8gQUFEIHVzaW5nIGFsdGVybmF0aXZlIG1ldGhvZCBpbnZvbHZpbmcgSW52b2tlLVdlYlJlcXVlc3QuJwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAjIExvZwogICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICRUZW5hbnREb21haW4KICAgICAgICAgICAgICAgICAgICAjIEdlbmVyYXRlIHRoZSBib2R5IHRvIHNlbmQgdG8gQUFEIGNvbnRhaW5pbmcgdGhlIHJlY292ZXJ5IGluZm9ybWF0aW9uCiAgICAgICAgICAgICAgICAgICAgIyBHZXQgdGhlIEJpdExvY2tlciBrZXkgaW5mb3JtYXRpb24gZnJvbSBXTUkKICAgICAgICAgICAgICAgICAgICBbYXJyYXldJChHZXQtQml0TG9ja2VyVm9sdW1lIC1Nb3VudFBvaW50ICRPU0RyaXZlTGV0dGVyIHwgU2VsZWN0LU9iamVjdCAtRXhwYW5kUHJvcGVydHkgJ0tleVByb3RlY3RvcicpLldoZXJleyRfLidLZXlQcm90ZWN0b3JUeXBlJyAtZXEgJ1JlY292ZXJ5UGFzc3dvcmQnfS5Gb3JFYWNoewogICAgICAgICAgICAgICAgICAgICAgICAkS2V5ID0gJF8KICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCJraWQgOiAkKCRLZXkuJ0tleVByb3RlY3RvcklkJykga2V5OiAkKCRLZXkuJ1JlY292ZXJ5UGFzc3dvcmQnKSIpCiAgICAgICAgICAgICAgICAgICAgICAgICRCb2R5ID0gW3N0cmluZ10kKCJ7IiJrZXkiIjoiIiQoJEtleS4nUmVjb3ZlcnlQYXNzd29yZCcpIiIsIiJraWQiIjoiIiQoJEtleS4nS2V5UHJvdGVjdG9ySWQnLlJlcGxhY2UoJ3snLCcnKS5SZXBsYWNlKCd9JywnJykpIiIsIiJ2b2wiIjoiIk9TViIifSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgQ3JlYXRlIHRoZSBVUkwgdG8gcG9zdCB0aGUgZGF0YSB0byBiYXNlZCBvbiB0aGUgdGVuYW50IGFuZCBkZXZpY2UgaW5mb3JtYXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgJFVyaSA9IFtzdHJpbmddJCgnaHR0cHM6Ly9lbnRlcnByaXNlcmVnaXN0cmF0aW9uLndpbmRvd3MubmV0L21hbmFnZS97MH0vZGV2aWNlL3sxfT9hcGktdmVyc2lvbj0xLjAnIC1mICgkVGVuYW50RG9tYWluLCRDZXJ0aWZpY2F0ZVN1YmplY3QpKQogICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAiQ3JlYXRpbmcgdXJsLi4uJFVyaSIKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBQb3N0IHRoZSBkYXRhIHRvIHRoZSBVUkwgYW5kIHNpZ24gaXQgd2l0aCB0aGUgQUFEIE1hY2hpbmUgQ2VydGlmaWNhdGUKICAgICAgICAgICAgICAgICAgICAgICAgJFJlcXVlc3QgPSBJbnZva2UtV2ViUmVxdWVzdCAtVXJpICRVcmkgLUJvZHkgJEJvZHkgLVVzZUJhc2ljUGFyc2luZyAtTWV0aG9kICdQb3N0JyAtVXNlRGVmYXVsdENyZWRlbnRpYWxzIC1DZXJ0aWZpY2F0ZSAkQ2VydGlmaWNhdGUKICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgJFJlcXVlc3QuJ1Jhd0NvbnRlbnQnCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkPykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJFNjcmlwdDpJc0JhY2t1cEFBRCA9ICR0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgIH0gICAgCiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnUG9zdCB0aGUgZGF0YSB0byB0aGUgVVJMIGFuZCBzaWduIGl0IHdpdGggdGhlIEFBRCBNYWNoaW5lIENlcnRpZmljYXRlLiBTdWNjZXNzPyB7MH0nIC1mICgkU2NyaXB0OklzQmFja3VwQUFEKSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICB9CiAgICAgICAgICAgIENhdGNoIHsKICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnRXJyb3Igd2hpbGUgYmFja3VwIHRvIEF6dXJlIEFELCBtYWtlIHN1cmUgdGhhdCB5b3UgYXJlIEFBRCBqb2luZWQgYW5kIGFyZSBydW5uaW5nIHRoZSBjbWRsZXQgYXMgYW4gYWRtaW4uJykKICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnRXJyb3IgbWVzc2FnZTonICsgImByYG4iICsgKCRfKSkKICAgICAgICAgICAgICAgICRJc0JhY2t1cEFBRCA9ICRmYWxzZQogICAgICAgICAgICB9CiAgICAgICAgICAgIEZpbmFsbHkgewogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdEaWQgYmFja3VwIHRvIEF6dXJlIEFEIFN1Y2NlZWQ/IHswfScgLWYgKCRTY3JpcHQ6SXNCYWNrdXBBQUQpKQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gQmFja3VwIEF6dXJlIEFBRAogICAgICAgIAogICAgICAgIAogICAgICAgICMgSWYgbm8gYmFja3VwIGFuZCBubyBSZWNvdmVyeSBQYXNzd29yZHMgcHJlc2VudAogICAgICAgIAogICAgfQogICAgZWxzZSB7CiAgICAgICAgTG9nV3JpdGUgJ09TIERyaXZlIGlzIG5vdCBlbmNyeXB0ZWQsIHRoZXJlIGFyZSBubyBSZWNvdmVyeSBQYXNzd29yZHMsIGFuZCB0aGVyZSBhcmUgbm8gYmFja3Vwcy4nCiAgICB9Cn0KI2VuZHJlZ2lvbiBCYWNrdXAKI2VuZHJlZ2lvbiBNYWluCgoKCgojIyMjIyMjIyMjIyMjIyMjIyMjIwojIyMjIEVORCBSRVNVTFRTICMjIwojIyMjIyMjIyMjIyMjIyMjIyMjIwojcmVnaW9uIEVuZCBSZXN1bHRzIApMb2dXcml0ZSAoJyMjIyBFbmQgcmVzdWx0cycpCiMgQ2xlYW5pbmcgdXAgaWYgc3VjY2VzcwppZiAoJFNjcmlwdDpJc0ZpbmlzaGVkMXN0VGltZSkgewogICAgTG9nV3JpdGUgJ0ZpbmlzaGVkIGZpcnN0IHRpbWUgPSBUcnVlIHwgSnVzdCBjaGVja2VkIHdlYXRoZXIgQml0TG9ja2VyIFJlY292ZXJ5IFBhc3N3b3JkIGhhZCBjaGFuZ2VkLicKfQoKZWxzZSB7CiAgICBpZiAoJFNjcmlwdDpJc0VuY3J5cHRlZCAtYW5kICRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cgLWFuZCAkU2NyaXB0OklzQmFja3VwQUFEIC1hbmQKICAgICAgICAoW2Jvb2xdJCgkU2NyaXB0OkJvb2xCYWNrdXBUb09uZURyaXZlRm9yQnVzaW5lc3MgLWFuZCAkU2NyaXB0OklzQmFja3VwT0QpIC1vciBbYm9vbF0kKC1ub3QoJFNjcmlwdDpCb29sQmFja3VwVG9PbmVEcml2ZUZvckJ1c2luZXNzKSkpCiAgICApIHsKICAgICAgICAkQkxWID0gR2V0LUJpdExvY2tlclZvbHVtZSAtTW91bnRQb2ludCAkZW52OlN5c3RlbURyaXZlCiAgICAgICAgaWYgKCgkQkxWLidWb2x1bWVTdGF0dXMnIC1lcSAkU2NyaXB0OkJpdExvY2tlclZvbHVtZUVuY3J5cHRpb25TdGF0dXNlc1syXSkgLWFuZCAoQCgkQkxWLidLZXlQcm90ZWN0b3InIHwgV2hlcmUtT2JqZWN0IC1Qcm9wZXJ0eSAnS2V5UHJvdGVjdG9yVHlwZScgLWVxICdSZWNvdmVyeVBhc3N3b3JkJykuJ0NvdW50JyAtZXEgMSkpIHsKICAgICAgICAKICAgICAgICAgICAgIyBGaXJzdCBzdWNjZXNzZnVsbCBydW4KICAgICAgICAgICAgJFNjcmlwdDpJc0ZpbmlzaGVkMXN0VGltZSA9ICR0cnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFNjaGVkdWxlZFRhc2sKICAgICAgICAgICAgRWRpdC1TY2hlZHVsZWRUYXNrIC1UYXNrTmFtZSAkU2NyaXB0OlNjaGVkdWxlZFRhc2tOYW1lCgogICAgICAgICAgICAjIEZpbGVzCiAgICAgICAgICAgICNyZWdpb24gUmVtb3ZlIGZpbGVzCiAgICAgICAgICAgIGlmICgkU2NyaXB0OkJvb2xSZW1vdmVGaWxlc0FmdGVyU3VjY2VzcyAtYW5kICRTY3JpcHQ6SXNGaW5pc2hlZDFzdFRpbWUpIHsgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICRudWxsID0gU3RhcnQtSm9iIC1Bcmd1bWVudExpc3QgJFNjcmlwdDpGaWxlTG9nIC1TY3JpcHRCbG9jayB7CiAgICAgICAgICAgICAgICAgICAgUGFyYW0oW3N0cmluZ10gJEZpbGVMb2cpCiAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgRnVuY3Rpb24gTG9nV3JpdGUgewogICAgICAgICAgICAgICAgICAgICAgICBQYXJhbSAoW3N0cmluZ10kTG9nU3RyaW5nKQogICAgICAgICAgICAgICAgICAgICAgICAkYSA9IFtzdHJpbmddJChHZXQtRGF0ZSkKICAgICAgICAgICAgICAgICAgICAgICAgJExvZ1N0cmluZyA9IFtzdHJpbmddJCgkYSwgJExvZ1N0cmluZykKICAgICAgICAgICAgICAgICAgICAgICAgQWRkLWNvbnRlbnQgLVBhdGggJEZpbGVMb2cgLVZhbHVlICRMb2dTdHJpbmcKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgJExvY2FsOlJlbURpclBhdGggPSBbc3RyaW5nXSQoJHtlbnY6UHJvZ3JhbUZpbGVzKHg4Nil9ICsgJ1xCaXRMb2NrZXJUcmlnZ2VyXCcpCiAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBTdGFydC1TbGVlcCAtU2Vjb25kcyA1CiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdTdGFydGVkIHRoZSBqb2IgdG8gcmVtb3ZlICJ7MH0iJyAtZiAoJExvY2FsOlJlbURpclBhdGgpKQogICAgICAgICAgICAgICAgICAgIGlmIChUZXN0LVBhdGggJExvY2FsOlJlbURpclBhdGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgUmVtb3ZlLUl0ZW0gLVBhdGggJExvY2FsOlJlbURpclBhdGggLVJlY3Vyc2UgLUZvcmNlCiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnUmVtb3ZpbmcgdGhlIGZvbGRlciAocmVjdXJzZSwgZm9yY2UpLiBTdWNjZXNzPyB7MH0nIC1mICgkPykpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0ZvbGRlciBkb2VzIG5vdCBleGlzdCcpCiAgICAgICAgICAgICAgICAgICAgfSAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfQogICAgICAgICAgICAjZW5kcmVnaW9uIFJlbW92ZSBGaWxlcwogICAgICAgIH0gICAgCiAgICB9CiAgICBlbHNlIHsKICAgICAgICBMb2dXcml0ZSAnVGhlcmUgYXJlIHN0aWxsIHRoaW5ncyB0byBkby4gVHJ5aW5nIGFnYWluIGxhdGVyLicKICAgIH0KfQojZW5kcmVnaW9uIEVuZCBSZXN1bHRzCgoKCiMjIyMjIyMjIyMjIyMjIyMjIyMjCiMjIyMgUyBUIEEgVCBTICMjIyMjCiMjIyMjIyMjIyMjIyMjIyMjIyMjCkxvZ1dyaXRlICgnIyMjIFNUQVRTJykKJFNjcmlwdDpDb3VudFJ1bnMgKz0gMQoKaWYgKC1ub3QoJFNjcmlwdDpCb29sUmVtb3ZlRmlsZXNBZnRlclN1Y2Nlc3MpKSB7CiAgICBpZiAoLW5vdChUZXN0LVBhdGggJFNjcmlwdDpEaXJJbnN0YWxsKSkgewogICAgICAgICRudWxsID0gTmV3LUl0ZW0gLVBhdGggJFNjcmlwdDpEaXJJbnN0YWxsIC1JdGVtVHlwZSAnRGlyZWN0b3J5JyAtRm9yY2UKICAgIH0KICAgIAogICAgIyBGZXRjaCBPUyBkcml2ZSBlbmNyeXB0aW9uIGtleSBhbmQgcGFzc3dvcmQKICAgICRTY3JpcHQ6T1NEcml2ZUtleUlEID0gW3N0cmluZ10kKCRTY3JpcHQ6Q0FycmF5UmVjb3ZlcnlQYXNzd29yZHMgfCBTZWxlY3QtT2JqZWN0IC1GaXJzdCAxIC1FeHBhbmRQcm9wZXJ0eSAnS2V5UHJvdGVjdG9ySWQnKQogICAgJFNjcmlwdDpPU0RyaXZlUHJvdGVjdGlvblBhc3N3b3JkID0gW3N0cmluZ10kKCRTY3JpcHQ6Q0FycmF5UmVjb3ZlcnlQYXNzd29yZHMgfCBTZWxlY3QtT2JqZWN0IC1GaXJzdCAxIC1FeHBhbmRQcm9wZXJ0eSAnUmVjb3ZlcnlQYXNzd29yZCcpCgogICAgIyBDcmVhdGUgb3V0cHV0IHN0cmluZwogICAgJE91dFN0cmluZyA9IFtzdHJpbmddJCgoJFNjcmlwdDpDb3VudFJ1bnMpLlRvU3RyaW5nKCkgKyAiYHJgbiIpICAgICAgICAgICAgIyAwICAgTGluZSAxCiAgICAkT3V0U3RyaW5nICs9ICgoW2J5dGVdICRTY3JpcHQ6SXNGaW5pc2hlZDFzdFRpbWUpLlRvU3RyaW5nKCkgKyAiYHJgbiIpICAgICAjIDEgICBMaW5lIDIKICAgICRPdXRTdHJpbmcgKz0gKChbYnl0ZV0gJFNjcmlwdDpJc0VuY3J5cHRlZCkuVG9TdHJpbmcoKSArICJgcmBuIikgICAgICAgICAgICMgMiAgIExpbmUgMwogICAgJE91dFN0cmluZyArPSAoKFtieXRlXSAkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3KS5Ub1N0cmluZygpICsgImByYG4iKSAgICAgIyAzICAgTGluZSA0CiAgICAkT3V0U3RyaW5nICs9ICgoW2J5dGVdICRTY3JpcHQ6SXNCYWNrdXBPRCkuVG9TdHJpbmcoKSArICJgcmBuIikgICAgICAgICAgICAjIDQgICBMaW5lIDUKICAgICRPdXRTdHJpbmcgKz0gKChbYnl0ZV0gJFNjcmlwdDpJc0JhY2t1cEFBRCkuVG9TdHJpbmcoKSArICJgcmBuIikgICAgICAgICAgICMgNSAgIExpbmUgNgogICAgJE91dFN0cmluZyArPSAoKFtzdHJpbmddICRTY3JpcHQ6T1NEcml2ZUtleUlEKSArICJgcmBuIikgICAgICAgICAgICAgICAgICAgIyA2ICAgTGluZSA3CiAgICAkT3V0U3RyaW5nICs9ICgoW3N0cmluZ10gJFNjcmlwdDpPU0RyaXZlUHJvdGVjdGlvblBhc3N3b3JkKSkgICAgICAgICAgICAgICAjIDcgICBMaW5lIDgKICAgCiAgICAjIE91dHB1dCB0aGUgc3RhdHMgZmlsZQogICAgJG51bGwgPSBPdXQtRmlsZSAtRmlsZVBhdGggJFNjcmlwdDpGaWxlU3RhdHMgLUVuY29kaW5nICd1dGY4JyAtRm9yY2UgLUlucHV0T2JqZWN0ICgkT3V0U3RyaW5nKQp9CkxvZ1dyaXRlICgnUnVucyBzbyBmYXI6IHswfScgLWYgKCRTY3JpcHQ6Q291bnRSdW5zKSkKCmlmICgkU2NyaXB0OkJvb2xEaWRBbnl0aGluZ0NoYW5nZVRoaXNSdW50aW1lKSB7CiAgICBXcml0ZS1TdGF0cyAKfQoKCgojIyMgR2l2ZSB1cCBhZnRlciBYIHJ1bnMgYW5kIElzRmluaXNoZWQxc3RUaW1lIC1lcSAkZmFsc2UKaWYgKCRTY3JpcHQ6Q291bnRSdW5zIC1lcSAzMCAtYW5kICgtbm90KCRTY3JpcHQ6SXNGaW5pc2hlZDFzdFRpbWUpKSkgewogICAgTG9nV3JpdGUgKCdTaG91bGQgaGF2ZSBiZWVuIGRvbmUgYnkgbm93LicpCiAgICBFZGl0LVNjaGVkdWxlZFRhc2sgLVRhc2tOYW1lICRTY3JpcHQ6U2NoZWR1bGVkVGFza05hbWUgICAgCn0KCgoKCiMjIyMjIyMjIyMjIyMjIyMjIyMjCiMjIyMgIEQgTyBOIEUgICMjIyMjCiMjIyMjIyMjIyMjIyMjIyMjIyMjCkxvZ1dyaXRlICgnQWxsIGRvbmUsIGV4aXRpbmcgc2NyaXB0Li4uJykKI2VuZHJlZ2lvbiBNYWluCg==')
        #endregion FilePS1
    #endregion Files

    # Script specific variables
    $Script:NameApp            = [string]$($NameScriptNoun)
    $Script:NameScheduledTask  = [string]$($NameScriptNoun)
    $Script:PathDirInstall     = [string]$('{0}\IronstoneIT\{1}' -f ($env:ProgramW6432,$Script:NameApp))
    $Script:PathFileInstall    = [string]$('{0}\{1}' -f ($Script:PathDirInstall,$Script:NameFilePS1))
#endregion Variables




#region Main
    Write-Output -InputObject ('### {0}' -f ($NameScript))



    ###########################################################
    ### 1. Clean up BitLockerTrigger and IronTrigger
    Write-Output -InputObject ('{0}# 1. Clean up previous install paths.' -f ("`r`n`r`n"))
    
    # Paths
    Write-Verbose -Message ('Remove previous install path(s) if present')
    # Get Directory Paths
    $Local:RemPaths = [string[]]@(
        # Install Directory used in this script
        ($Script:PathDirInstall),
        # Install Dirs matching "*Trigger*" or "*BitLocker*" is ProgramFiles x64
        @(Get-ChildItem -Path ('{0}\IronstoneIT\' -f ($env:ProgramW6432)) -Directory -ErrorAction 'SilentlyContinue' | Where-Object {$_.Name -like '*trigger*' -or $_.Name -like '*BitLocker*'} | Select-Object -ExpandProperty 'FullName'),
        # Install Dirs matching "*Trigger*" or "*BitLocker*" is ProgramFiles x86
        @(Get-ChildItem -Path ('{0}\IronstoneIT\' -f (${env:ProgramFiles(x86)})) -Directory -ErrorAction 'SilentlyContinue' | Where-Object {$_.Name -like '*trigger*' -or $_.Name -like '*BitLocker*'} | Select-Object -ExpandProperty 'FullName')
    )
    # Remove Directory Paths
    foreach ($Path in $Local:RemPaths) {
        if (-not([string]::IsNullOrEmpty($Path.Trim()))) {
            Write-Verbose -Message ('   Removing "{0}" if it exists.' -f ($Path))
            if (Test-Path -Path $Path) {
                $null = Remove-Item -Path $Path -Force -Recurse
                Write-Verbose -Message ('      Directory does exist. Removing. Success? {0}' -f ($?))
            }
            else {
                Write-Verbose -Message ('      Directory does not exist')
            }
        }
    }
    
    # Stats and Logs
    Write-Verbose -Message ('Remove previous files: Stats and Logs')
    @(Get-ChildItem -Path ('{0}\Temp' -f ($env:windir)) -File -ErrorAction 'SilentlyContinue' | Where-Object -FilterScript {$_.'Name' -like '*trigger*'} | Select-Object -ExpandProperty 'FullName') | ForEach-Object {
        Remove-Item -Path $_ -Force
        Write-Verbose -Message ('Removing "{0}". Success? {1}.' -f ($_,$?.ToString()))
    }
    Get-ChildItem -Path $PathDirLog -Name '*EnableBitLocker.log' -File -Force -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'PSChildName' | ForEach-Object {Remove-Item -Path ('{0}{1}' -f ($PathDirLog,$_)) -Force}

    # Scheduled tasks
    Write-Verbose -Message ('Remove previous ScheduledTask(s)')
    $Local:ScheduledTasks = Get-ScheduledTask | Where-Object {
        # Exact Name
        @($Script:NameScheduledTask,'IronTrigger','Enable_BitLocker').Contains($_.'TaskName') -or `
        # Regex
        $_.'TaskName' -like '*BitLocker' -or $_.'TaskName' -like '*IronTrigger*'
    }
    
    if ($Local:ScheduledTasks.'Length' -gt 0) {
        $Local:ScheduledTasks | ForEach-Object {             
            $null = Unregister-ScheduledTask -TaskName $_.'TaskName' -Confirm:$false -ErrorAction 'SilentlyContinue'
            Write-Verbose -Message ('  Removing the Scheduled task "{0}". Success? {1}' -f ($_.'TaskName',$?))
        }
    }
    else {
        if (Get-ScheduledTask -TaskName $Script:NameScheduledTask -ErrorAction 'SilentlyContinue') {            
            $null = Unregister-ScheduledTask -TaskName $Script:NameScheduledTask -Confirm:$false -ErrorAction 'SilentlyContinue'
            Write-Verbose -Message ('  Removing the Scheduled task "{0}". Success? {1}' -f ($Script:NameScheduledTask,$?))
        }
        else {
            Write-Verbose -Message ('  Scheduled task "{0}" does not exist.' -f ($Script:ScheduledTaskName))
        }
    }




    ###########################################################
    ### 2. Install Files
    Write-Output -InputObject ('{0}# 2. Install files.' -f ("`r`n`r`n"))
    # Create path if not exist
    if (-not([System.IO.Directory]::Exists($Script:PathDirInstall))){$null=[System.IO.Directory]::CreateDirectory($Script:PathDirInstall)}
    # Output file
    $null = Out-File -FilePath $Script:PathFileInstall -Encoding 'Utf8' -InputObject ([System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($Script:ContentFilePS1))) -Force:$true -ErrorAction 'Stop'
    # Verbose
    Write-Verbose -Message ('   Success? {0}' -f ($?))



    
    ###########################################################
    ### 3. Surpress BitLocker Toast Notifications
    Write-Output -InputObject ('{0}# 3. Surpress BitLocker Toast Notifications.' -f ("`r`n`r`n"))

    # Create registry base path to HKCU:\ from System context
    $RegDirBase = [string]$('Registry::HKEY_USERS\{0}\Software\Microsoft\Windows\CurrentVersion\Notifications\Settings' -f ($Script:StrIntuneUserSID))
    
    # Registry paths to disable BitLocker Toast Notifications
    $RegDirs    = [string[]]@(
        [string]('{0}\Windows.SystemToast.BitLockerPolicyRefresh' -f ($RegDirBase)),
        [string]('{0}\Windows.SystemToast.BdeUnlock' -f ($RegDirBase))
    )

    # Set registry values
    foreach ($RegDir in $RegDirs) {
        if (-not(Test-Path -Path $RegDir)) {$null = New-Item -Path $RegDir -ItemType 'Directory' -Force}
        $null = Set-ItemProperty -Path $RegDir -Name 'Enabled' -Value 0 -Type 'DWord' -Force
        if (-not($?)) {
            Throw 'ERROR: Failed to set registry values to surpress BotLocker Toast Notifications.'
        }
        else {
            Write-Verbose -Message ('   Success.')
        }
    }




    ###########################################################
    ### 4. Create ScheduledTask and run it if success
    Write-Output -InputObject ('{0}# 4. Create Scheduled Task "{1}", run it if success.' -f ("`r`n`r`n",$Script:NameScheduledTask))
    # Get path of PowerShell.exe and the .PS1 file
    $PathFilePowerShell = [string] '%SystemRoot%\system32\WindowsPowerShell\v1.0\powershell.exe' # Works regardless of 64bit vs 32bit
    $PathFilePS1        = [string] ('{0}\{1}' -f ($Script:PathDirInstall,$Script:NameFilePS1))
    # Create Scheduled Task
    #region    Create Scheduled Task running PS1 using PowerShell.exe - Every 15 Minutes
        # Construct Scheduled Task
        $ScheduledTask = New-ScheduledTask                                                    `
            -Action    (New-ScheduledTaskAction -Execute ('"{0}"' -f ($PathFilePowerShell)) -Argument ('-ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -WindowStyle Hidden -File "{0}"' -f ($PathFilePS1))) `
            -Principal (New-ScheduledTaskPrincipal -UserId 'NT AUTHORITY\SYSTEM' -RunLevel 'Highest')                                                                                                                   `
            -Trigger   (New-ScheduledTaskTrigger -Once -At ([datetime]::Today) -RepetitionInterval ([timespan]::FromMinutes(15)))                                                                                       `
            -Settings  (New-ScheduledTaskSettingsSet -Hidden -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -ExecutionTimeLimit ([timespan]::FromMinutes(10)) -Compatibility 4 -StartWhenAvailable)
        $ScheduledTask.'Author'      = 'Ironstone'
        $ScheduledTask.'Description' = ('{0}Runs a PowerShell script. {1}Execute: "{2}". {1}Arguments: "{3}".' -f (
            $(if([string]::IsNullOrEmpty($DescriptionScheduledTask)){''}else{('{0} {1}' -f ($DescriptionScheduledTask,"`r`n"))}),"`r`n",
            [string]($ScheduledTask | Select-Object -ExpandProperty 'Actions' | Select-Object -ExpandProperty 'Execute'),
            [string]($ScheduledTask | Select-Object -ExpandProperty 'Actions' | Select-Object -ExpandProperty 'Arguments')
        ))

        # Register Scheduled Task
        $null = Register-ScheduledTask -TaskName $NameScheduledTask -InputObject $ScheduledTask -Force -Verbose:$false -Debug:$false
                
        # Check if success registering Scheduled Task
        $SuccessCreatingScheduledTask = [bool]$($? -and [bool]$([byte](@(Get-ScheduledTask -TaskName $NameScheduledTask).'Count') -eq 1))
        Write-Verbose -Message ('Success creating scheduled task "{0}"? "{1}".' -f ($NameScheduledTask,$SuccessCreatingScheduledTask.ToString()))
                
        # Run Scheduled Task if Success Creating It
        if ($SuccessCreatingScheduledTask) {$null = Start-ScheduledTask -TaskName $NameScheduledTask}
        else {Throw 'ERROR: Failed to create scheduled task.'}
    #endregion Create Scheduled Task running PS1 using PowerShell.exe - Every 15 Minutes




    ###########################################################
    ### Done
    Write-Output -InputObject ('{0}Done.' -f ("`r`n`r`n"))    
#endregion Main



################################################
#endregion Your Code Here
################################################   
#region    Don't touch this
}
Catch {
    # Set ScriptSuccess to false
    $null = Set-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'ScriptSuccess' -Value ([bool]$($false))
    # Construct error message
    ## Generic content
    $ErrorMessage = [string]$('{0}Catched error:' -f ([System.Environment]::NewLine))    
    ## Last exit code if any
    if (-not[string]::IsNullOrEmpty($LASTEXITCODE)) {
        $ErrorMessage += ('{0}# Last exit code ($LASTEXITCODE):{0}{1}' -f ([System.Environment]::NewLine,$LASTEXITCODE))
    }
    ## Dynamically add info to the error message
    foreach ($ParentProperty in [string[]]$($_.GetType().GetProperties().'Name')) {
        if ($_.$ParentProperty) {
            $ErrorMessage += ('{0}# {1}:' -f ([System.Environment]::NewLine,$ParentProperty))
            foreach ($ChildProperty in [string[]]$($_.$ParentProperty.GetType().GetProperties().'Name')) {
                ### Build ErrorValue
                $ErrorValue = [string]::Empty
                if ($_.$ParentProperty.$ChildProperty -is [System.Collections.IDictionary]) {
                    foreach ($Name in [string[]]$($_.$ParentProperty.$ChildProperty.GetEnumerator().'Name')) {
                        if (-not[string]::IsNullOrEmpty([string]$($_.$ParentProperty.$ChildProperty.$Name))) {
                            $ErrorValue += ('{0} = {1}{2}' -f ($Name,[string]$($_.$ParentProperty.$ChildProperty.$Name),[System.Environment]::NewLine))
                        }
                    }
                }
                else {
                    $ErrorValue = [string]$($_.$ParentProperty.$ChildProperty)
                }
                if (-not[string]::IsNullOrEmpty($ErrorValue)) {
                    $ErrorMessage += ('{0}## {1}\{2}:{0}{3}' -f ([System.Environment]::NewLine,$ParentProperty,$ChildProperty,$ErrorValue.Trim()))
                }
            }
        }
    }
    # Write Error Message
    Write-Error -Message $ErrorMessage -ErrorAction 'Continue'
}
Finally {
    # Unload Users' Registry Profiles (NTUSER.DAT) if any were loaded
    if ($Script:BoolIsSystem -and $BoolWriteToHKCUFromSystem -and ([string[]]@($RegistryLoadedProfiles | Where-Object -FilterScript {-not([string]::IsNullOrEmpty($_))})).'Count' -gt 0) {
        # Close Regedit.exe if running, can't unload hives otherwise
        $null = Get-Process -Name 'regedit' -ErrorAction 'SilentlyContinue' | ForEach-Object -Process {Stop-Process -InputObject $_ -ErrorAction 'SilentlyContinue'}

        # Get all logged in users
        $SIDsLoggedInUsers = [string[]]$(([string[]]@(Get-Process -Name 'explorer' -IncludeUserName -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'UserName' -Unique | ForEach-Object -Process {Try{[System.Security.Principal.NTAccount]::new(($_)).Translate([System.Security.Principal.SecurityIdentifier]).'Value'}Catch{}} | Where-Object -FilterScript {-not([string]::IsNullOrEmpty($_))}),[string]$([System.Security.Principal.WindowsIdentity]::GetCurrent().'User'.'Value')) | Select-Object -Unique)

        foreach ($SID in $RegistryLoadedProfiles) {
            # If SID is found in $SIDsLoggedInUsers - Don't Unload Hive
            if ([bool]$(([string[]]@($SIDsLoggedInUsers | ForEach-Object -Process {$_.Trim().ToUpper()})).Contains($SID.Trim().ToUpper()))) {
                Write-Output -InputObject ('User with SID "{0}" is currently logged in, will not unload registry hive.' -f ($SID))
            }
            # If SID is not found in $SIDsLoggedInUsers - Unload Hive
            else {
                $PathUserHive = [string]('HKEY_USERS\{0}' -f ($SID))
                $null = Start-Process -FilePath ('{0}\reg.exe' -f ([string]$([system.environment]::SystemDirectory))) -ArgumentList ('UNLOAD "{0}"' -f ($PathUserHive)) -WindowStyle 'Hidden' -Wait

                # Check success
                if (Test-Path -Path ('Registry::{0}' -f ($PathUserHive)) -ErrorAction 'SilentlyContinue') {
                    Write-Output -InputObject ('ERROR: Failed to unload user registry hive "{0}".' -f ($PathUserHive)) -ErrorAction 'Continue'
                }
                else {
                    Write-Output -InputObject ('Successfully unloaded user registry hive "{0}".' -f ($PathUserHive))
                }
            }
        }
    }
    
    # Stop Transcript
    Stop-Transcript
}
# Exit script
if ($ScriptSuccess) {
    Exit 0
}
else {
    Exit 1
}
#endregion Don't touch this