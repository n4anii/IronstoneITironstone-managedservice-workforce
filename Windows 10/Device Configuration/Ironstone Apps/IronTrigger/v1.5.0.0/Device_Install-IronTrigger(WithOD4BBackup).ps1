<#

.SYNOPSIS
    Installs PowerShell script "Enable_BitLocker.ps1", creates Scheduled Task that runs it.

.DESCRIPTION
    Installs PowerShell script "Enable_BitLocker.ps1", creates Scheduled Task that runs it.
    
    How to
        Convert Enable_BitLocker.ps1 to Base64
            * https://www.base64encode.org/
                * Destination charset: UTF8
                * Newline separator: LF (Linux)

.NOTES
    * In Intune, remember to set "Run this script using the logged in credentials"  according to the $DeviceContext variable.
        * Intune -> Device Configuration -> PowerShell Scripts -> $NameScriptFull -> Properties -> "Run this script using the logged in credentials"
        * DEVICE (Local System) or USER (Logged in user).
    * Only edit $NameScript and add your code in the #region Your Code Here.
    * You might want to touch "Settings - PowerShell - Output Preferences" for testing / development. 
        * $VerbosePreference, eventually $DebugPreference, to 'Continue' will print much more details.

#>


# Script Variables
$NameScript            = [string] 'Install-IronTrigger'
$DeviceContext         = [bool]   $true
$WriteToHKCUFromSystem = [bool]   $true

# Settings - PowerShell - Output Preferences
$DebugPreference       = 'SilentlyContinue'
$VerbosePreference     = 'SilentlyContinue'
$WarningPreference     = 'Continue'

#region    Don't Touch This
# Settings - PowerShell - Interaction
$ConfirmPreference     = 'None'
$InformationPreference = 'SilentlyContinue'
$ProgressPreference    = 'SilentlyContinue'

# Settings - PowerShell - Behaviour
$ErrorActionPreference = 'Continue'

# Dynamic Variables - Process & Environment
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'NameScriptFull' -Value ([string]('{0}_{1}' -f ($(if($DeviceContext){'Device'}else{'User'}),$NameScript)))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'NameScriptVerb' -Value ([string]$NameScript.Split('-')[0])
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'NameScriptNoun' -Value ([string]$NameScript.Split('-')[-1])
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrArchitectureProcess' -Value ([string]$(if([System.Environment]::Is64BitProcess){'64'}else{'32'}))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrArchitectureOS' -Value ([string]$(if([System.Environment]::Is64BitOperatingSystem){'64'}else{'32'}))

# Dynamic Variables - User
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrUserNameRunningAs' -Value ([string]$([System.Security.Principal.WindowsIdentity]::GetCurrent().'Name'))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrSIDRunningAs' -Value ([string]$([System.Security.Principal.WindowsIdentity]::GetCurrent().'User'.'Value'))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'BoolIsAdmin'  -Value ([bool]$(([System.Security.Principal.WindowsPrincipal]$([System.Security.Principal.WindowsIdentity]::GetCurrent())).IsInRole([System.Security.Principal.WindowsBuiltInRole]::Administrator)))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'BoolIsSystem' -Value ([bool]$($Script:StrSIDRunningAs -like ([string]$('S-1-5-18'))))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'BoolIsCorrectUser' -Value ([bool]$(if($Script:DeviceContext -and $Script:BoolIsSystem){$true}elseif(((-not($DeviceContext))) -and (-not($Script:BoolIsSystem))){$true}else{$false}))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'BoolWriteToHKCUFromSystem' -Value ([bool]$(if($DeviceContext -and $WriteToHKCUFromSystem){$true}else{$false}))

# Dynamic Variables - Logging
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'Timestamp' -Value ([string]$([datetime]::Now.ToString('yyMMdd-HHmmssffff')))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'PathDirLog' -Value ([string]$('{0}\IronstoneIT\Intune\DeviceConfiguration\' -f ([string]$(if($BoolIsSystem){$env:ProgramW6432}else{[System.Environment]::GetEnvironmentVariable('AppData')}))))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'PathFileLog' -Value ([string]$('{0}{1}-{2}bit-{3}.txt' -f ($Script:PathDirLog,$Script:NameScriptFull,$Script:StrArchitectureProcess,$Script:Timestamp)))

# Start Transcript
if (-not(Test-Path -Path $Script:PathDirLog)) {$null = New-Item -ItemType 'Directory' -Path $Script:PathDirLog -ErrorAction 'Stop'}
Start-Transcript -Path $Script:PathFileLog -ErrorAction 'Stop'


# Wrap in Try/Catch, so we can always end the transcript
Try {
    # Output User Info, Exit if not $BoolIsCorrectUser
    Write-Output -InputObject ('Running as user "{0}" ({1}). Has admin privileges? {2}. $DeviceContext? {3}. Running as correct user? {4}.' -f ($Script:StrUserNameRunningAs,$Script:StrSIDRunningAs,$Script:BoolIsAdmin.ToString(),$Script:DeviceContext.ToString(),$Script:BoolIsCorrectUser.ToString()))
    if (-not($Script:BoolIsCorrectUser)){Throw 'Not running as correct user!'; Break}


    # Output Process and OS Architecture Info
    Write-Output -InputObject ('PowerShell is running as a {0} bit process on a {1} bit OS.' -f ($Script:StrArchitectureProcess,$Script:StrArchitectureOS))


    # If OS is 64 bit, and PowerShell got launched as x86, relaunch as x64
    if ([System.Environment]::Is64BitOperatingSystem -and -not [System.Environment]::Is64BitProcess) {
        write-Output -InputObject (' * Will restart this PowerShell session as x64.')
        if (-not([string]::IsNullOrEmpty($MyInvocation.'Line'))) {& ('{0}\sysnative\WindowsPowerShell\v1.0\powershell.exe' -f ($env:windir)) -NonInteractive -NoProfile $MyInvocation.'Line'}
        else {& ('{0}\sysnative\WindowsPowerShell\v1.0\powershell.exe' -f ($env:windir)) -NonInteractive -NoProfile -File ('{0}' -f ($MyInvocation.'InvocationName')) $args}
        exit $LASTEXITCODE
    }

    
    #region    Get SID and "Domain\Username" for Intune User only if $WriteToHKCUFromSystem
        # If running in Device Context as "NT Authority\System"
        if ($DeviceContext -and $Script:BoolIsSystem -and $BoolWriteToHKCUFromSystem) {
            # Help Variables
            $Script:RegistryLoadedProfiles = [string[]]@()
            $Local:SID                     = [string]::Empty
            $Local:LengthInterval          = [byte[]]@(40 .. 80)


            # Load User Profiles NTUSER.DAT (Registry) that is not available from current context
            $PathProfileList = [string]('Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProfileList')
            $SIDsProfileList = [string[]]@(Get-ChildItem -Path $PathProfileList -Recurse:$false | Select-Object -ExpandProperty 'Name' | ForEach-Object -Process {$_.Split('\')[-1]} | Where-Object -FilterScript {$_ -like 'S-1-12-*'})
            foreach ($SID in $SIDsProfileList) {
                if (Test-Path -Path ('Registry::HKEY_USERS\{0}' -f ($SID)) -ErrorAction 'SilentlyContinue') {
                    Write-Output -InputObject ('User with SID "{0}" is already logged in and/or NTUSER.DAT is loaded.' -f ($SID))
                }
                else {
                    Write-Output -InputObject ('User with SID "{0}" is not logged in, thus NTUSER.DAT is not loaded into registry.' -f ($SID))
                    
                    # Get User Directory
                    $PathUserDirectory = [string]$(Get-ItemProperty -Path ('{0}\{1}' -f ($PathProfileList,$SID)) -Name 'ProfileImagePath' | Select-Object -ExpandProperty 'ProfileImagePath')
                    if ([string]::IsNullOrEmpty($PathUserDirectory)) {
                        Throw ('ERROR: No User Directory was found for user with SID "{0}".' -f ($SID))
                    }

                    # Get User Registry File, NTUSER.DAT
                    $PathFileUserRegistry = ('{0}\NTUSER.DAT' -f ($PathUserDirectory))
                    if (-not(Test-Path -Path $PathFileUserRegistry)) {
                        Throw ('ERROR: "{0}" does not exist.' -f ($PathFileUserRegistry))
                    }

                    # Load NTUSER.DAT
                    $null = Start-Process -FilePath ('{0}\reg.exe' -f ([string]([system.environment]::SystemDirectory))) -ArgumentList ('LOAD "HKEY_USERS\{0}" "{1}"' -f ($SID,$PathFileUserRegistry)) -WindowStyle 'Hidden' -Wait
                    if (Test-Path -Path ('Registry::HKEY_USERS\{0}' -f ($SID))) {
                        Write-Output -InputObject ('{0}Successfully loaded "{1}".' -f ("`t",$PathFileUserRegistry))
                        $RegistryLoadedProfiles += @($SID)
                    }
                    else {
                        Throw ('ERROR: Failed to load registry hive for SID "{0}", NTUSER.DAT location "{1}".' -f ($SID,$PathFileUserRegistry))
                    }
                }
            }


            # Get Intune User Information from Registry
            $IntuneUser = [PSCustomObject]([PSCustomObject[]]@(
                foreach ($x in [string[]]@(Get-ChildItem -Path 'Registry::HKEY_USERS' -Recurse:$false -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'Name' | ForEach-Object {$_.Split('\')[-1]} | Where-Object {[bool]$($_ -like 'S-1-12-*') -and [bool]$(Test-Path -Path ('Registry::HKEY_USERS\{0}\Software\IronstoneIT\Intune\UserInfo' -f ($_)))})) {
                    [PSCustomObject]@{
                        'IntuneUserSID' =[string](Get-ItemProperty -Path ('Registry::HKEY_USERS\{0}\Software\IronstoneIT\Intune\UserInfo' -f ($x)) -Name 'IntuneUserSID' -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'IntuneUserSID');
                        'IntuneUserName'=[string](Get-ItemProperty -Path ('Registry::HKEY_USERS\{0}\Software\IronstoneIT\Intune\UserInfo' -f ($x)) -Name 'IntuneUserName' -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'IntuneUserName');
                        'DateSet'       =Try{[datetime](Get-ItemProperty -Path ('Registry::HKEY_USERS\{0}\Software\IronstoneIT\Intune\UserInfo' -f ($x)) -Name 'DateSet' -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'DateSet')}Catch{[datetime]::MinValue};
                    }
                }) | Where-Object {-not([string]::IsNullOrEmpty($_.IntuneUserSID) -or [string]::IsNullOrEmpty($_.IntuneUserName))} | Sort-Object -Property 'DateSet' -Descending:$false | Select-Object -Last 1
            )


            # Get Intune User SID
            $null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrIntuneUserSID' -Value (
                [string]$(
                    $Local:SID = [string]::Empty
                    # Try by registry values in HKEY_CURRENT_USER\Software\IronstoneIT\Intune\UserInfo
                    if (-not([string]::IsNullOrEmpty([string]($IntuneUser | Select-Object -ExpandProperty 'IntuneUserSID')))) {
                        $Local:SID = [string]($IntuneUser | Select-Object -ExpandProperty 'IntuneUserSID')
                    }

                    # If no valid SID yet, try Registry::HKEY_USERS
                    if ([string]::IsNullOrEmpty($Local:SID) -or (-not($Local:LengthInterval.Contains([byte]$Local:SID.Length))) -or (-not(Test-Path -Path ('Registry::HKEY_USERS\{0}' -f ($Local:SID)) -ErrorAction 'SilentlyContinue'))) {
                        # Get all potential SIDs from Registry::HKEY_USERS
                        $Local:SIDsFromRegistryAll = [string[]]@(Get-ChildItem -Path 'Registry::HKEY_USERS' -Recurse:$false -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'Name' | ForEach-Object {$_.Split('\')[-1]} | Where-Object {$_ -like 'S-1-12-*' -and $_ -notlike '*_Classes' -and $Local:LengthInterval.Contains([byte]$_.'Length')})
                        $Local:SID = [string]$(
                            # If none where found - Return emtpy string: Finding SID by registry will not be possible
                            if (@($Local:SIDsFromRegistryAll).'Count' -le 0) {
                                [string]::Empty
                            }
                            # If only one where found - Return it
                            elseif (@($Local:SIDsFromRegistryAll).'Count' -eq 1) {
                                [string]([string[]]@($Local:SIDsFromRegistryAll | Select-Object -First 1))
                            }
                            # If multiple where found - Try to filter out unwanted SIDs
                            else {
                                # Try to get all where IronstoneIT folder exist withing HKU (HKCU) registry
                                $Local:SIDs = [string[]]@([string[]]@($Local:SIDsFromRegistryAll) | Where-Object {Test-Path -Path ('Registry::HKEY_USERS\{0}\Software\IronstoneIT' -f ($_))})
                                # If none or more than 1 where found - Try getting only SIDs with AAD joined info in HKU (HKCU) registry
                                if (@($Local:SIDs).'Count' -le 0 -or @($Local:SIDs).'Count' -ge 2) {
                                    $Local:SIDs = [string[]]@([string[]]@($Local:SIDsFromRegistryAll) | Where-Object {Test-Path -Path ('Registry::HKEY_USERS\{0}\Software\Microsoft\Windows NT\CurrentVersion\WorkplaceJoin\AADNGC' -f ($_))})
                                }
                                # If none or more than 1 where found - Try matching Tenant ID for AAD joined HKLM with Tenant ID for AAD joined HKU (HKCU)
                                if (@($Local:SIDs).'Count' -le 0 -or @($Local:SIDs).'Count' -ge 2) {
                                    if (-not([string]::IsNullOrEmpty(($Local:TenantGUIDFromHKLM = [string]$($x='Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\CloudDomainJoin\JoinInfo'; Get-ItemProperty -Path ('{0}\{1}' -f ($x,[string](Get-ChildItem -Path $x -Recurse:$false -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'Name' | ForEach-Object {$_.Split('\')[-1]}))) -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'TenantId'))))) {
                                        $Local:SIDs = [string[]]@(@($Local:SIDsFromRegistryAll) | Where-Object {$Local:TenantGUIDFromHKLM -eq ([string]$($x=[string]('Registry::HKEY_USERS\{0}\Software\Microsoft\Windows NT\CurrentVersion\WorkplaceJoin\AADNGC' -f ($_)); Get-ItemProperty -Path ('{0}\{1}' -f ($x,([string](Get-ChildItem -Path $x -Recurse:$false -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'Name' | ForEach-Object {$_.Split('\')[-1]})))) -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'TenantDomain'))})
                                    }
                                }
                                if(@($Local:SIDs).'Count' -eq 1){
                                    [string]([string[]]@($Local:SIDs | Select-Object -First 1))
                                }
                                else{
                                    [string]::Empty
                                }
                            }
                        )
                    }

                    # If no valid SID yet, try by running process "Explorer"
                    if ([string]::IsNullOrEmpty($Local:SID) -or (-not($Local:LengthInterval.Contains([byte]$Local:SID.'Length'))) -or (-not(Test-Path -Path ('Registry::HKEY_USERS\{0}' -f ($Local:SID)) -ErrorAction 'SilentlyContinue'))) {
                        $Local:SID = [string]$(
                            $Local:UN = [string]([string[]]@(Get-WmiObject -Class 'Win32_Process' -Filter "Name='Explorer.exe'" -ErrorAction 'SilentlyContinue' | ForEach-Object {$($Owner = $_.GetOwner();if($Owner.'ReturnValue' -eq 0 -and $Owner.'Domain' -notlike 'nt *' -and $Owner.'Domain' -notlike 'nt-*'){('{0}\{1}' -f ($Owner.'Domain',$Owner.'User'))})}) | Select-Object -Unique -First 1)
                            if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.'Length' -lt 3) {
                                $Local:UN = [string]([string[]]@(Get-Process -Name 'explorer' -IncludeUserName -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'UserName' | Where-Object {$_ -notlike 'nt *' -and $_ -notlike 'nt-*'}) | Select-Object -Unique -First 1)
                            }
                            if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.'Length' -lt 3) {
                                [string]::Empty
                            }
                            else {
                                Try{
                                    $Local:SID = [string]$([System.Security.Principal.NTAccount]::new($Local:UN).Translate([System.Security.Principal.SecurityIdentifier]).'Value')
                                    if ([string]::IsNullOrEmpty($Local:SID) -or (-not($Local:LengthInterval.Contains([byte]$Local:SID.'Length'))) -or (-not(Test-Path -Path ('Registry::HKEY_USERS\{0}' -f ($Local:SID)) -ErrorAction 'SilentlyContinue'))) {
                                        [string]::Empty
                                    }
                                    else {
                                        $Local:SID
                                    }
                                }
                                catch{
                                    [string]::Empty
                                }
                            }
                        )
                    }
                
                    # If no valid SID yet, throw error
                    if ([string]::IsNullOrEmpty($Local:SID) -or (-not($Local:LengthInterval.Contains([byte]$Local:SID.'Length'))) -or (-not(Test-Path -Path ('Registry::HKEY_USERS\{0}' -f ($Local:SID)) -ErrorAction 'SilentlyContinue'))) {
                        Throw 'ERROR: Did not manage to get Intune user SID from SYSTEM context'
                    }

                    # If valid SID, return it
                    else {
                        $Local:SID
                    }         
                )
            )
        

            # Get Intune User Domain\UserName
            $null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrIntuneUserName' -Value (
                [string]$(
                    # Help Variables
                    $Local:UN = [string]::Empty

                    # Try by registry values in HKEY_CURRENT_USER\Software\IronstoneIT\Intune\UserInfo
                    if (-not([string]::IsNullOrEmpty($IntuneUser.'IntuneUserName'))) {
                        $Local:UN = [string]($IntuneUser.'IntuneUserName')
                    }
                
                    # If no valid UN yet, try by convertid $Script:StrIntuneUserSID to "Domain\Username"
                    if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.'Length' -lt 3 -and (-not([string]::IsNullOrEmpty($Script:StrIntuneUserSID)))) {
                        $Local:UN = [string]$(Try{[System.Security.Principal.SecurityIdentifier]::new($Script:StrIntuneUserSID).Translate([System.Security.Principal.NTAccount]).Value}Catch{[string]::Empty})
                    }

                    # If no valid UN yet, try by Registry::HKEY_USERS\$Script:StrIntuneUserSID\Volatile Environment
                    if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.'Length' -lt 3-and (-not([string]::IsNullOrEmpty($Script:StrIntuneUserSID)))) {
                        $Local:UN = [string]$(Try{$Local:x = Get-ItemProperty -Path ('Registry::HKEY_USERS\{0}\Volatile Environment' -f ($Script:StrIntuneUserSID)) -Name 'USERDOMAIN','USERNAME' -ErrorAction 'SilentlyContinue';('{0}\{1}' -f ([string]($Local:x | Select-Object -ExpandProperty 'USERDOMAIN'),[string]($Local:x | Select-Object -ExpandProperty 'USERNAME')))}Catch{[string]::Empty})
                    }
                
                    # If no valid UN yet, try by running process Explorer.exe - Method 1
                    if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.'Length' -lt 3) {
                        $Local:UN = [string]([string[]]@(Get-WmiObject -Class 'Win32_Process' -Filter "Name='Explorer.exe'" -ErrorAction 'SilentlyContinue' | ForEach-Object {$($Owner = $_.GetOwner();if($Owner.'ReturnValue' -eq 0 -and $Owner.'Domain' -notlike 'nt *' -and $Owner.'Domain' -notlike 'nt-*'){('{0}\{1}' -f ($Owner.'Domain',$Owner.'User'))})}) | Select-Object -Unique -First 1)
                    }
                
                    # If no valid UN yet, try by running process Explorer.exe - Method 2
                    if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.'Length' -lt 3) {
                        $Local:UN = [string]([string[]]@(Get-Process -Name 'explorer' -IncludeUserName -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'UserName' | Where-Object {$_ -notlike 'nt *' -and $_ -notlike 'nt-*'}) | Select-Object -Unique -First 1)
                    }                   

                    # If no valid UN yet, throw Error
                    if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.'Length' -lt 3) {
                        Throw 'ERROR: Did not manage to get "Domain"\"UserName" for Intune User.'
                    }

                    # If valid UN, return it
                    else {
                        $Local:UN
                    }
                )
            )
        }
        

        # If running in User Context / Not running as "NT Authority\System"
        elseif ((-not($Script:BoolIsSystem)) -and (-not($DeviceContext))) {
            $null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrIntuneUserSID' -Value ([string]([System.Security.Principal.WindowsIdentity]::GetCurrent().'User'.'Value'))
            $null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrIntuneUserName' -Value ([string]([System.Security.Principal.WindowsIdentity]::GetCurrent().'Name'))

            #region    Write SID and UserName to HKCU if running in User Context
                # Assets
                $Local:RegPath   = [string]('Registry::HKEY_CURRENT_USER\Software\IronstoneIT\Intune\UserInfo')
                $Local:RegNames  = [string[]]@('IntuneUserSID','IntuneUserName','DateSet')
                $Local:RegValues = [string[]]@($Script:StrIntuneUserSID,$Script:StrIntuneUserName,([string]([datetime]::Now.ToString('o'))))

                # Get Current Info
                $Local:CurrentUserSID     = [string](Get-ItemProperty -Path $Local:RegPath -Name $Local:RegNames[0] -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty $Local:RegNames[0] -ErrorAction 'SilentlyContinue')
                $Local:CurrentUserName    = [string](Get-ItemProperty -Path $Local:RegPath -Name $Local:RegNames[1] -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty $Local:RegNames[1] -ErrorAction 'SilentlyContinue')
                $Local:CurrentUserDateSet = [datetime]$(Try{[datetime](Get-ItemProperty -Path $Local:RegPath -Name $Local:RegNames[2] -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty $Local:RegNames[2] -ErrorAction 'SilentlyContinue')}catch{[datetime]::MinValue})

                # Set Info if any of the values does not match wanted values
                if ($Local:CurrentUserSID -ne $Local:RegValues[0] -or $Local:CurrentUserName -ne $Local:RegValues[1] -or $Local:CurrentUserDateSet -eq [datetime]::MinValue) {      
                    if (-not(Test-Path -Path $Local:RegPath)) {
                        $null = New-Item -Path $Local:RegPath -Force -ErrorAction 'Stop'
                    }

                    foreach ($x in [byte[]]@(0 .. [byte]($Local:RegNames.'Length' - 1))) {
                        $null = Set-ItemProperty -Path $Local:RegPath -Name $Local:RegNames[$x] -Value $Local:RegValues[$x] -Force -ErrorAction 'Stop'
                    }
                }
            #endregion Write SID and UserName to HKCU if running in User Context            
        }
        
        
        # Output Intune User and SID if found
        if (-not([string]::IsNullOrEmpty($Script:StrIntuneUserSID))) {
            Write-Output -InputObject ('Intune User SID "{0}", Username "{1}".' -f ($Script:StrIntuneUserSID,$Script:StrIntuneUserName))
        }
    #endregion Get SID and "Domain\Username" for Intune User



    # End the Initialize Region
    Write-Output -InputObject ('**********************')
#endregion Don't Touch This
################################################
#region    Your Code Here
################################################



#region    Variables
    # Settings
    $Script:ReadOnly           = [bool]$($false)

    # Files
    #region Files
        # Enable-BitLockerTrigger.PS1
        #region FilePS1
        $Script:NameFilePS1    = [string]$('Enable_BitLocker.ps1')
        $Script:ContentFilePS1 = [string]$('I1JlcXVpcmVzIC1SdW5Bc0FkbWluaXN0cmF0b3IKCjwjIAogCi5ERVNDUklQVElPTiAKIENoZWNrIHdoZXRoZXIgQml0TG9ja2VyIGlzIEVuYWJsZWQsIGlmIG5vdCBFbmFibGUgQml0TG9ja2VyIG9uIEFBRCBKb2luZWQgZGV2aWNlcyBhbmQgc3RvcmUgcmVjb3ZlcnkgaW5mbyBpbiBBQUQgCiBBZGRlZCBsb2dnaW5nCiM+IAoKW2NtZGxldGJpbmRpbmcoKV0KcGFyYW0oKQoKCiMgSW1wb3J0IEJpdExvY2tlciBtb2R1bGUKaWYgKFtieXRlXSQoR2V0LU1vZHVsZSAtTmFtZSAnQml0TG9ja2VyJyAtRXJyb3JBY3Rpb24gJ1NpbGVudGx5Q29udGludWUnIHwgTWVhc3VyZS1PYmplY3QgfCBTZWxlY3QtT2JqZWN0IC1FeHBhbmRQcm9wZXJ0eSAnQ291bnQnKSAtbGUgMCkgewogICAgJG51bGwgPSBJbXBvcnQtTW9kdWxlIC1OYW1lICdCaXRMb2NrZXInIC1EaXNhYmxlTmFtZUNoZWNraW5nIC1FcnJvckFjdGlvbiAnU3RvcCcKfQoKCiMgTWFrZSBzdXJlIGFsbCBuZXR3b3JrIHRyYWZmaWMgZ2VuZXJhY3RlZCBpbiB0aGlzIHNjcmlwdCB1c2VzIFRMUyAxLjIKW05ldC5TZXJ2aWNlUG9pbnRNYW5hZ2VyXTo6U2VjdXJpdHlQcm90b2NvbCA9IFtOZXQuU2VjdXJpdHlQcm90b2NvbFR5cGVdOjpUbHMxMgpbU3lzdGVtLk5ldC5TZXJ2aWNlUG9pbnRNYW5hZ2VyXTo6U2VjdXJpdHlQcm90b2NvbCA9IFtTeXN0ZW0uTmV0LlNlY3VyaXR5UHJvdG9jb2xUeXBlXTo6VGxzMTIKCgojcmVnaW9uIFNldHRpbmdzIGFuZCBWYXJpYWJsZXMKICAgICMgU2V0dGluZ3MKICAgICMjIEdVSQogICAgIyMjIElmIG9uLCB3aWxsIHByb21wdCB1c2VyIHRvIHJlYm9vdCB3aXRoIFdpbmRvd3MgRm9ybXMgR1VJLgogICAgJG51bGwgPSBOZXctVmFyaWFibGUgLU9wdGlvbiAnUmVhZE9ubHknIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgLU5hbWUgJ0Jvb2xTaG93R1VJJyAtVmFsdWUgJChbYm9vbF0kKCRmYWxzZSkpICAgIAogICAgIyMgUmVtb3ZlIGZpbGVzIGFmdGVyIHN1Y2Nlc3MKICAgICMjIyBJZiBvbiwgd2lsbCByZW1vdmUgYWxsIGZpbGVzIGFmdGVyIGZpcnN0IHN1Y2Nlc3MuCiAgICAkbnVsbCA9IE5ldy1WYXJpYWJsZSAtT3B0aW9uICdSZWFkT25seScgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSAtTmFtZSAnQm9vbFJlbW92ZUZpbGVzQWZ0ZXJTdWNjZXNzJyAtVmFsdWUgJChbYm9vbF0kKCRmYWxzZSkpCiAgICAjIyBSZW1vdmUgc2NlaGR1bGVkIHRhc2sgYWZ0ZXIgc3VjY2VzcwogICAgIyMjIElmIG9mZiwgd2lsbCBjaGFuZ2Ugc2NoZWR1bGVkIHRhc2sgdG8gcnVuIG9uY2UgYSBkYXkgYXQgMTI6MDAgYWZ0ZXIgZmlyc3Qgc3VjY2Vzc2Z1bGwgcnVuLCBvciBhZnRlciAzMCBmYWlsZWQgcnVucwogICAgIyMjIElmIG9uLCB3aWxsIGRlbGV0ZSBzY2hlZHVsZWQgdGFzayBhZnRlciBmaXJzdCBzdWNjZXNzZnVsbCBydW4gYW5kIGFmdGVyIDMwIGZhaWxlZCBydW5zCiAgICAkbnVsbCA9IE5ldy1WYXJpYWJsZSAtT3B0aW9uICdSZWFkT25seScgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSAtTmFtZSAnQm9vbFJlbW92ZVNjaGVkdWxlZFRhc2tBZnRlckZpcnN0U3VjY2VzcycgLVZhbHVlICQoW2Jvb2xdJCgkZmFsc2UpKQogICAgIyMgQmFja3VwIHRvIE9uZURyaXZlCiAgICAjIyMgSWYgdHJ1ZSB3aWxsIGJhY2t1cCB0byBPbmVEcml2ZSBmb3IgQnVzaW5lc3MsIHdpbGwgbm90IGNvdW50IGFzIHN1Y2Nlc3NmdWwgcnVuIGJlZm9yZSB0aGlzIHN0ZXAgaGFzIGNvbXBsZXRlZCBzdWNjZXNzZnVsbHkKICAgICMjIyBJZiBmYWxzZSB3aWxsIHNrdXAgYmFja3VwIHRvIE9uZURyaXZlIGZvciBCdXNpbmVzcwogICAgJG51bGwgPSBOZXctVmFyaWFibGUgLU9wdGlvbiAnUmVhZE9ubHknIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgLU5hbWUgJ0Jvb2xCYWNrdXBUb09uZURyaXZlRm9yQnVzaW5lc3MnIC1WYWx1ZSAkKFtib29sXSQoJHRydWUpKQoKICAgICMgVmFyaWFibGVzCiAgICAjIyBTY3JpcHQKICAgICRudWxsID0gTmV3LVZhcmlhYmxlIC1PcHRpb24gJ1JlYWRPbmx5JyAtU2NvcGUgJ1NjcmlwdCcgLUZvcmNlIC1OYW1lICdOYW1lU2NyaXB0JyAtVmFsdWUgJChbc3RyaW5nXSQoJ0lyb25UcmlnZ2VyJykpCiAgICAkbnVsbCA9IE5ldy1WYXJpYWJsZSAtT3B0aW9uICdSZWFkT25seScgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSAtTmFtZSAnU2NoZWR1bGVkVGFza05hbWUnIC1WYWx1ZSAkKFtzdHJpbmddJCgkU2NyaXB0Ok5hbWVTY3JpcHQuQ2xvbmUoKSkpCiAgICAkbnVsbCA9IE5ldy1WYXJpYWJsZSAtT3B0aW9uICdSZWFkT25seScgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSAtTmFtZSAnRGlySW5zdGFsbCcgLVZhbHVlICQoW3N0cmluZ10kKCd7MH1cUHJvZ3JhbSBGaWxlc1xJcm9uc3RvbmVJVFx7MX1cJyAtZiAoJGVudjpTeXN0ZW1Ecml2ZSwkU2NyaXB0Ok5hbWVTY3JpcHQpKSkKICAgICRudWxsID0gTmV3LVZhcmlhYmxlIC1PcHRpb24gJ1JlYWRPbmx5JyAtU2NvcGUgJ1NjcmlwdCcgLUZvcmNlIC1OYW1lICdEaXJMb2cnIC1WYWx1ZSAkKFtzdHJpbmddJCgnezB9XFByb2dyYW0gRmlsZXNcSXJvbnN0b25lSVRcSW50dW5lXERldmljZUNvbmZpZ3VyYXRpb25cJyAtZiAoJGVudjpTeXN0ZW1Ecml2ZSkpKQogICAgJG51bGwgPSBOZXctVmFyaWFibGUgLU9wdGlvbiAnUmVhZE9ubHknIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgLU5hbWUgJ0ZpbGVMb2cnIC1WYWx1ZSAkKFtzdHJpbmddJCgnezB9SXJvblRyaWdnZXIgLSBFbmFibGVCaXRMb2NrZXIubG9nJyAtZiAoJFNjcmlwdDpEaXJMb2cpKSkKICAgICRudWxsID0gTmV3LVZhcmlhYmxlIC1PcHRpb24gJ1JlYWRPbmx5JyAtU2NvcGUgJ1NjcmlwdCcgLUZvcmNlIC1OYW1lICdGaWxlU3RhdHMnIC1WYWx1ZSAkKFtzdHJpbmddJCgnezB9c3RhdHMudHh0JyAtZiAoJFNjcmlwdDpEaXJJbnN0YWxsKSkpCiAgICAjIyBIZWxwCiAgICAjIyMgU3RhdGljIC8gUmVhZE9ubHkKICAgICRudWxsID0gTmV3LVZhcmlhYmxlIC1PcHRpb24gJ1JlYWRPbmx5JyAtU2NvcGUgJ1NjcmlwdCcgLUZvcmNlIC1OYW1lICdPU0RyaXZlTGV0dGVyJyAtVmFsdWUgJChbc3RyaW5nXSQoJGVudjpTeXN0ZW1Ecml2ZS5UcmltKCc6JykuVG9VcHBlcigpKSkKICAgICRudWxsID0gTmV3LVZhcmlhYmxlIC1PcHRpb24gJ1JlYWRPbmx5JyAtU2NvcGUgJ1NjcmlwdCcgLUZvcmNlIC1OYW1lICdDb21wdXRlck5hbWUnIC1WYWx1ZSAkKFtzdHJpbmddJChbc3RyaW5nW11dJChbc3RyaW5nXSgkZW52OkNPTVBVVEVSTkFNRSkuVHJpbSgpLFtzdHJpbmddKFtTeXN0ZW0uRW52aXJvbm1lbnRdOjpNYWNoaW5lTmFtZSkuVHJpbSgpIC1uZSBbc3RyaW5nXTo6RW1wdHkpWzBdKSkKICAgICRudWxsID0gTmV3LVZhcmlhYmxlIC1PcHRpb24gJ1JlYWRPbmx5JyAtU2NvcGUgJ1NjcmlwdCcgLUZvcmNlIC1OYW1lICdCaXRMb2NrZXJWb2x1bWVFbmNyeXB0aW9uU3RhdHVzZXMnIC1WYWx1ZSAkKFtzdHJpbmdbXV0kKCdGdWxseURlY3J5cHRlZCcsJ0VuY3J5cHRpb25JblByb2dyZXNzJywnRnVsbHlFbmNyeXB0ZWQnKSkKICAgICMjIyBEeW5hbWljCiAgICAkU2NyaXB0OkJvb2xEaWRBbnl0aGluZ0NoYW5nZVRoaXNSdW50aW1lID0gW2Jvb2xdJCgkZmFsc2UpICAgIAojZW5kcmVnaW9uIFNldHRpbmdzIGFuZCBWYXJpYWJsZXMKCgoKI3JlZ2lvbiBGdW5jdGlvbnMKICAgICNyZWdpb24gTG9nZ2luZyBhbmQgT3V0cHV0CiAgICAgICAgI3JlZ2lvbiBMb2dXcml0ZQogICAgICAgIEZ1bmN0aW9uIExvZ1dyaXRlIHsKICAgICAgICAgICAgUGFyYW0gKAogICAgICAgICAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnkgPSAkdHJ1ZSldCiAgICAgICAgICAgICAgICBbVmFsaWRhdGVOb3ROdWxsT3JFbXB0eSgpXQogICAgICAgICAgICAgICAgW3N0cmluZ10gJExvZ1N0cmluZwogICAgICAgICAgICApCgogICAgICAgICAgICAjIENyZWF0ZSB2YXJpYWJsZXMKICAgICAgICAgICAgJERhdGVUaW1lICA9IFtzdHJpbmddJChbU3lzdGVtLkRhdGVUaW1lXTo6Tm93LlRvU3RyaW5nKCd5eU1NZGQgSEg6bW06c3M6ZmYnKSkKICAgICAgICAgICAgJExvZ1N0cmluZyA9IFtzdHJpbmddJCgnezB9IHsxfScgLWYgKCREYXRlVGltZSwkTG9nU3RyaW5nKSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQWRkIGNvbnRlbnQgdG8gbG9nIGZpbGUKICAgICAgICAgICAgQWRkLWNvbnRlbnQgLVBhdGggJFNjcmlwdDpGaWxlTG9nIC1WYWx1ZSAkTG9nU3RyaW5nIC1FbmNvZGluZyAndXRmOCcKICAgICAgICAgICAgCiAgICAgICAgICAgICMgT3V0cHV0IGNvbnRlbnQgdG8gY29uc29sZQogICAgICAgICAgICBXcml0ZS1PdXRwdXQgLUlucHV0T2JqZWN0ICRMb2dTdHJpbmcKICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBMb2dXcml0ZQoKICAgICAgICAjcmVnaW9uIExvZ0Vycm9ycwogICAgICAgIEZ1bmN0aW9uIExvZ0Vycm9ycyB7CiAgICAgICAgICAgIExvZ1dyaXRlICgnQ2F1Z2h0IGFuIGV4Y2VwdGlvbjonKQogICAgICAgICAgICBMb2dXcml0ZSAoJ0V4Y2VwdGlvbiBUeXBlOiAgICB7MH0nIC1mICgkXy4nRXhjZXB0aW9uJy5HZXRUeXBlKCkuJ0Z1bGxOYW1lJykpCiAgICAgICAgICAgIExvZ1dyaXRlICgnRXhjZXB0aW9uIE1lc3NhZ2U6IHswfScgLWYgKCRfLidFeGNlcHRpb24nLidNZXNzYWdlJykpCiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gTG9nRXJyb3JzCgoKICAgICAgICAjcmVnaW9uIFdyaXRlLVN0YXRzCiAgICAgICAgIyBXcml0ZS1TdGF0czogT3V0cHV0cyBjdXJyZW50IHN0YXR1cyBvZiB2YXJpb3VzIGJvb2xlYW5zIGFuZCBvdGhlciBtZWFzdXJlbWVudHMKICAgICAgICBGdW5jdGlvbiBXcml0ZS1TdGF0cyB7ICAgIAogICAgICAgICAgICBQYXJhbSgKICAgICAgICAgICAgICAgIFtwYXJhbWV0ZXIoTWFuZGF0b3J5PSRmYWxzZSldCiAgICAgICAgICAgICAgICBbYm9vbF0gJFByZXZpb3VzT25seSA9ICRmYWxzZQogICAgICAgICAgICApCiAgICAgICAgICAgICMgR2VuZXJhbAogICAgICAgICAgICBpZiAoJFByZXZpb3VzT25seSkgewogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdSdW5zOiB7MH0gfCBIYXMgSXJvblRyaWdnZXIgaGFkIGEgc3VjY2Vzc2Z1bGwgcnVuIGFscmVhZHk/IHsxfScgLWYgKCRTY3JpcHQ6Q291bnRSdW5zLCRTY3JpcHQ6SXNGaW5pc2hlZDFzdFRpbWUpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAjIE9TIERyaXZlCiAgICAgICAgICAgIExvZ1dyaXRlICgnT1MgZHJpdmUgKHswfSkgfCBFbmNyeXB0ZWQ6IHsxfSB8IFJlY292ZXJ5IFBhc3N3b3JkcyBwcmVzZW50OiB7Mn0gfCBCYWNrdXAgdG8gT25lRHJpdmU6IHszfSB8IEJhY2t1cCB0byBBenVyZUFEOiB7NH0nIC1mICgkT1NEcml2ZUxldHRlciwkU2NyaXB0OklzRW5jcnlwdGVkLCRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3csJFNjcmlwdDpJc0JhY2t1cE9ELCRTY3JpcHQ6SXNCYWNrdXBBQUQpKQogICAgICAgICAgICBpZiAoLW5vdCgkUHJldmlvdXNPbmx5KSkgewogICAgICAgICAgICAgICAgTG9nd3JpdGUgKCdPUyBkcml2ZSAoezB9KSB8IFZvbHVtZVN0YXR1czogezF9IHwgUHJvdGVjdGlvblN0YXR1czogezJ9JyAtZiAoJE9TRHJpdmVMZXR0ZXIsJFNjcmlwdDpWb2x1bWVFbmNyeXB0aW9uU3RhdHVzLCRTY3JpcHQ6Vm9sdW1lUHJvdGVjdGlvblN0YXR1cykpICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQVykgewogICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnT1MgZHJpdmUgKHswfSkgfCBQcmVzZW5jZSBvZiBCaXRMb2NrZXIgS2V5UHJvdGVjdG9yIHwgVFBNOiB7MX0gfCBSZWNvdmVyeVBhc3N3b3JkOiB7Mn0nIC1mICgkT1NEcml2ZUxldHRlciwkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzBdLCRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMV0pKQogICAgICAgICAgICAgICAgICAgIGlmICgkU2NyaXB0OlZvbHVtZUVuY3J5cHRpb25TdGF0dXNbMV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdPUyBkcml2ZSAoezB9KSB8IHsxfScgLWYgKCRPU0RyaXZlTGV0dGVyLChXcml0ZS1SZWNvdmVyeVBhc3N3b3JkKSkpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgT3RoZXIgZml4ZWQgZHJpdmVzIHdpdGggYSBkcml2ZSBsZXR0ZXIKICAgICAgICAgICAgICAgIDwjICNUT0RPCiAgICAgICAgICAgICAgICBpZiAoJFNjcmlwdDpPdGhlckVuY3J5cHRlZERyaXZlcykgewogICAgICAgICAgICAgICAgICAgICRTY3JpcHQ6T3RoZXJFbmNyeXB0ZWREcml2ZXMgfCBGb3JFYWNoLU9iamVjdCB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgtbm90KFtzdHJpbmddOjpJc051bGxPckVtcHR5KCRTY3JpcHQ6T3RoZXJFbmNyeXB0ZWREcml2ZXNbMF0pKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgW3N0cmluZ10gJExvY2FsOkRyaXZlVm9sdW1lU3RhdHVzID0gKEdldC1WYXJpYWJsZSAtTmFtZSAoJ1ZvbHVtZXswfUVuY1N0YXR1cycgLWYgJF8pIC1TY29wZSAnU2NyaXB0JykuVmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtzdHJpbmddICRMb2NhbDpEcml2ZVByb3RlY3Rpb25TdGF0dXMgPSAoR2V0LVZhcmlhYmxlIC1OYW1lICgnVm9sdW1lezB9UHJvdGVjdGlvblN0YXR1cycgLWYgJF8pIC1TY29wZSAnU2NyaXB0JykuVmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIExvZ3dyaXRlICgnU3RhdHVzIGRyaXZlICJ7MH0iIHwgVm9sdW1lU3RhdHVzOiB7MX0gfCBQcm90ZWN0aW9uU3RhdHVzOiB7Mn0nIC1mICgkXywkTG9jYWw6RHJpdmVWb2x1bWVTdGF0dXMsJExvY2FsOkRyaXZlUHJvdGVjdGlvblN0YXR1cykpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBbYm9vbFtdXSAkTG9jYWw6S2V5UHJvdGVjdG9yVHlwZXMgPSBHZXQtQml0TG9ja2VyS2V5UHJvdGVjdG9yVHlwZXMgLURyaXZlTGV0dGVyICRfCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0JpdExvY2tlciBLZXlQcm90ZWN0b3IgVHlwZXMgcHJlc2VudCBmb3IgZHJpdmUgInswfSI/IHwgVFBNOiB7MX0gfCBSZWNvdmVyeVBhc3N3b3JkOiB7Mn0nIC1mICgkXywkTG9jYWw6S2V5UHJvdGVjdG9yVHlwZXNbMF0sJExvY2FsOktleVByb3RlY3RvclR5cGVzWzFdKSkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0jPgogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gV3JpdGUtU3RhdHMKCgogICAgICAgICNyZWdpb24gV3JpdGUtUmVjb3ZlcnlQYXNzd29yZAogICAgICAgICMgV3JpdGUtUmVjb3ZlcnlQYXNzd29yZAogICAgICAgIEZ1bmN0aW9uIFdyaXRlLVJlY292ZXJ5UGFzc3dvcmQgewogICAgICAgICAgICAkTG9jYWw6QyA9IFtieXRlXSQoaWYoJFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzKXskU2NyaXB0OkNvdW50UmVjb3ZlcnlQYXNzd29yZHN9ZWxzZXswfSkKICAgICAgICAgICAgUmV0dXJuIChbc3RyaW5nXSQoJ3swfSBSZWNvdmVyeSBQYXNzd29yZChzKSBwcmVzZW50LnsxfScgLWYgKCRMb2NhbDpDLCgkKGlmKCRMb2NhbDpDIC1nZSAxKXsnezB9ezF9JyAtZiAoImByYG4iLChHZXQtU3RyaW5nUmVjb3ZlcnlQYXNzd29yZHMpKX0pKSkpKQogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIFdyaXRlLVJlY292ZXJ5UGFzc3dvcmQKCgogICAgICAgICNyZWdpb24gR2V0LVN0cmluZ1JlY292ZXJ5UGFzc3dvcmRzCiAgICAgICAgIyBSZXR1cm5zIGEgc3RyaW5nIGNvbnRhaW5pbmcgdGhlIHJlY292ZXJ5IHBhc3N3b3JkcyBmcm9tICRTY3JpcHQ6QXJyYXlSZWNvdmVyeVBhc3N3b3Jkcy4gVXNlZnVsbCBmb3IgcHJpbnRpbmcvIGxvZ2dpbmcvIGJhY2t1cAogICAgICAgIEZ1bmN0aW9uIEdldC1TdHJpbmdSZWNvdmVyeVBhc3N3b3JkcyB7CiAgICAgICAgICAgIFBhcmFtKAogICAgICAgICAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnk9JGZhbHNlKV0KICAgICAgICAgICAgICAgIFtWYWxpZGF0ZU5vdE51bGxPckVtcHR5KCldCiAgICAgICAgICAgICAgICBbc3RyaW5nXSAkRHJpdmVMZXR0ZXIgPSAkT1NEcml2ZUxldHRlcgogICAgICAgICAgICApCgogICAgICAgICAgICAjIFZhbGlkYXRlIElucHV0CiAgICAgICAgICAgICRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyID0gW3N0cmluZ10kKCREcml2ZUxldHRlci5UcmltKCc6JykuVG9VcHBlcigpKQogICAgICAgICAgICBpZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIuJ0xlbmd0aCcgLWd0IDEpIHsKICAgICAgICAgICAgICAgIFRocm93ICdFUlJPUjogRHJpdmUgbGV0dGVyIGNhbm5vdCBiZSBtb3JlIHRoYW4gb25lIGxldHRlcicKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICMgQ3JlYXRlIHZhcmlhYmxlIG5hbWVzCiAgICAgICAgICAgICRMb2NhbDpBcnJheU5hbWUgICAgID0gW3N0cmluZ10kKCd7MH1BcnJheVJlY292ZXJ5UGFzc3dvcmRzJyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpKQoKCiAgICAgICAgICAgICMgR2V0IEFycmF5LCBsb29wIGl0LiBJZGVhbGx5IG9ubHkgb25lIHB3LCBidXQgbG9vcCBqdXN0IHRvIGJlIHNhZmUuCiAgICAgICAgICAgICRMb2NhbDpUZW1wQ291bnRlciA9IFt1aW50MTZdJCgwKQogICAgICAgICAgICAkTG9jYWw6T3V0U3RyID0gW3N0cmluZ106OkVtcHR5CiAgICAgICAgICAgIChHZXQtVmFyaWFibGUgLU5hbWUgJExvY2FsOkFycmF5TmFtZSAtU2NvcGUgJ1NjcmlwdCcgLVZhbHVlT25seSkgfCBGb3JFYWNoLU9iamVjdCB7CiAgICAgICAgICAgICAgICAkTG9jYWw6T3V0U3RyICs9ICgnezB9IHwgS2V5UHJvdGVjdG9ySWQgInsxfSIgfCBSZWNvdmVyeVBhc3N3b3JkICJ7Mn0iJyAtZiAoKCRMb2NhbDpUZW1wQ291bnRlciArPSAxKSwkXy5LZXlQcm90ZWN0b3JJZCwkXy5SZWNvdmVyeVBhc3N3b3JkKSkKICAgICAgICAgICAgICAgIGlmICgkTG9jYWw6VGVtcENvdW50ZXIgLWx0ICgoR2V0LVZhcmlhYmxlIC1OYW1lICRMb2NhbDpBcnJheU5hbWUgLVNjb3BlICdTY3JpcHQnKS5WYWx1ZSkuQ291bnQpIHskTG9jYWw6T3V0U3RyICs9ICJgcmBuIn0KICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICMgUmV0dXJuIHRoZSBzdHJpbmcKICAgICAgICAgICAgUmV0dXJuICRMb2NhbDpPdXRTdHIKICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBHZXQtU3RyaW5nUmVjb3ZlcnlQYXNzd29yZHMKICAgICNlbmRyZWdpb24gTG9nZ2luZyBhbmQgT3V0cHV0CgoKCiAgICAjcmVnaW9uIFJldHVybiBWYWx1ZXMgKFVzZWQgYnkgb3RoZXIgRnVuY3Rpb25zKQogICAgICAgICNyZWdpb24gICAgR2V0LUJpdExvY2tlcktleVByb3RlY3RvclR5cGVzCiAgICAgICAgRnVuY3Rpb24gR2V0LUJvb2xEcml2ZUhhc0JpdExvY2tlclRQTWFuZFBXIHsKICAgICAgICAgICAgPCMKICAgICAgICAgICAgICAgIFJldHVybnMgYSBib29sIGFycmF5LCB3aGVyZSB0aGUgZmlyc3QgcmVwcmVzZW50cyBzdGF0dXMgb2YgVFBNIHByZXNlbmNlLCBhbmQgdGhlIHNlY29uZCBmb3IgUHJvdGVjdGlvbiBQYXNzd29yZAogICAgICAgICAgICAjPgogICAgICAgICAgICBQYXJhbSgKICAgICAgICAgICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5PSRmYWxzZSldCiAgICAgICAgICAgICAgICBbVmFsaWRhdGVOb3ROdWxsT3JFbXB0eSgpXQogICAgICAgICAgICAgICAgW3N0cmluZ10gJERyaXZlTGV0dGVyID0gJE9TRHJpdmVMZXR0ZXIKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBWYWxpZGF0ZSBJbnB1dAogICAgICAgICAgICAkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlciA9IFtzdHJpbmddJCgkRHJpdmVMZXR0ZXIuVHJpbSgnOicpLlRvVXBwZXIoKSkKICAgICAgICAgICAgaWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyLidMZW5ndGgnIC1ndCAxKSB7CiAgICAgICAgICAgICAgICBUaHJvdyAnRVJST1I6IERyaXZlIGxldHRlciBjYW5ub3QgYmUgbW9yZSB0aGFuIG9uZSBsZXR0ZXInCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgR2V0IEJpdExvY2tlciBWb2x1bWUKICAgICAgICAgICAgJExvY2FsOkJpdExvY2tlclN0YXR1cyA9IEdldC1CaXRMb2NrZXJWb2x1bWUgLU1vdW50UG9pbnQgJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ3JlYXRlIG9iamVjdCBjb250YWluaW5nIG51bWJlciBvZiBSZWNvdmVyeVBhc3N3b3JkcyAoSW5kZXggPSAwKSBhbmQgVFBNIChJbmRleCA9IDEpCiAgICAgICAgICAgICRMb2NhbDpDb3VudFJlY1Bhc3MgPSBbdWludDE2XSQoMCkKICAgICAgICAgICAgJExvY2FsOkNvdW50VFBNID0gW3VpbnQxNl0kKDApCiAgICAgICAgICAgICRMb2NhbDpCaXRMb2NrZXJTdGF0dXMuJ0tleVByb3RlY3RvcicgfCBGb3JFYWNoLU9iamVjdCB7CiAgICAgICAgICAgICAgICBpZiAoJF8uJ0tleVByb3RlY3RvclR5cGUnIC1lcSAnUmVjb3ZlcnlQYXNzd29yZCcpIHskTG9jYWw6Q291bnRSZWNQYXNzICs9IDF9CiAgICAgICAgICAgICAgICBlbHNlaWYgKCRfLidLZXlQcm90ZWN0b3JUeXBlJyAtZXEgJ1RQTScpIHskTG9jYWw6Q291bnRUUE0gKz0gMX0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXR1cm4gdGhlIG9iamVjdAogICAgICAgICAgICByZXR1cm4gKFtib29sXSQoJExvY2FsOkNvdW50VFBNIC1nZSAxKSxbYm9vbF0kKCRMb2NhbDpDb3VudFJlY1Bhc3MgLWdlIDEpKQogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIEdldC1CaXRMb2NrZXJLZXlQcm90ZWN0b3JUeXBlcwoKCiAgICAgICAgI3JlZ2lvbiAgICBHZXQtQXJyYXlSZWNvdmVyeVBhc3N3b3JkcwogICAgICAgICMgUmV0dXJucyBhIEFycmF5TGlzdCB3aXRoIGV4aXN0aW5nIFByb3RlY3Rpb25QYXNzd29yZHMKICAgICAgICBGdW5jdGlvbiBHZXQtQXJyYXlSZWNvdmVyeVBhc3N3b3JkcyB7CiAgICAgICAgICAgIFBhcmFtKAogICAgICAgICAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnk9JHRydWUpXQogICAgICAgICAgICAgICAgW01pY3Jvc29mdC5CaXRMb2NrZXIuU3RydWN0dXJlcy5CaXRMb2NrZXJWb2x1bWVdICRCaXRMb2NrZXJWb2x1bWUKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBHZXQgQml0TG9ja2VyIFByb3RlY3Rpb25QYXNzd29yZHMKICAgICAgICAgICAgJExvY2FsOktleVByb3RlY3RvclN0YXR1cyAgICAgPSAkQml0TG9ja2VyVm9sdW1lIHwgU2VsZWN0LU9iamVjdCAtRXhwYW5kUHJvcGVydHkgJ0tleVByb3RlY3RvcicKICAgICAgICAgICAgJExvY2FsOkFycmF5UmVjb3ZlcnlQYXNzd29yZHMgPSBbTWljcm9zb2Z0LkJpdExvY2tlci5TdHJ1Y3R1cmVzLkJpdExvY2tlclZvbHVtZUtleVByb3RlY3RvcltdXSQoKQoKICAgICAgICAgICAgJExvY2FsOktleVByb3RlY3RvclN0YXR1cyB8IEZvckVhY2gtT2JqZWN0IC1Qcm9jZXNzIHsKICAgICAgICAgICAgICAgIGlmICgkXy4nS2V5UHJvdGVjdG9yVHlwZScgLWVxICdSZWNvdmVyeVBhc3N3b3JkJykgewogICAgICAgICAgICAgICAgICAgICRMb2NhbDpBcnJheVJlY292ZXJ5UGFzc3dvcmRzICs9IFtNaWNyb3NvZnQuQml0TG9ja2VyLlN0cnVjdHVyZXMuQml0TG9ja2VyVm9sdW1lS2V5UHJvdGVjdG9yW11dJCgkXykKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXR1cm4gdGhlIG9iamVjdCAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiAkTG9jYWw6QXJyYXlSZWNvdmVyeVBhc3N3b3JkcwogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIEdldC1BcnJheVJlY292ZXJ5UGFzc3dvcmRzCgoKICAgICAgICAjcmVnaW9uICAgIEdldC1Wb2x1bWVVbmlxdWVJRAogICAgICAgIEZ1bmN0aW9uIEdldC1Wb2x1bWVVbmlxdWVJRCB7CiAgICAgICAgICAgIHBhcmFtKAogICAgICAgICAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnk9JHRydWUpXQogICAgICAgICAgICAgICAgW1ZhbGlkYXRlTm90TnVsbE9yRW1wdHkoKV0KICAgICAgICAgICAgICAgIFtzdHJpbmddICREcml2ZUxldHRlcgogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFZhbGlkYXRlIElucHV0CiAgICAgICAgICAgICRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyID0gW3N0cmluZ10kKCREcml2ZUxldHRlci5UcmltKCc6JykuVG9VcHBlcigpKQogICAgICAgICAgICBpZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIuJ0xlbmd0aCcgLWd0IDEpIHsKICAgICAgICAgICAgICAgIFRocm93ICdFUlJPUjogRHJpdmUgbGV0dGVyIGNhbm5vdCBiZSBtb3JlIHRoYW4gb25lIGxldHRlcicKICAgICAgICAgICAgfQoKICAgICAgICAgICAgIyBHZXQgVW5pcXVlIFZvbHVtZQogICAgICAgICAgICByZXR1cm4gW3N0cmluZ10kKEdldC1Wb2x1bWUgLURyaXZlTGV0dGVyICRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyIHwgU2VsZWN0LU9iamVjdCAtRXhwYW5kUHJvcGVydHkgJ1VuaXF1ZUlkJykuU3BsaXQoJ3snKVstMV0uVHJpbSgnfVwnKQogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIEdldC1Wb2x1bWVVbmlxdWVJRAoKCiAgICAgICAgI3JlZ2lvbiAgICBSZWZyZXNoLUJpdExvY2tlclZhcmlhYmxlc0ZvckN1cnJlbnRWb2x1bWUKICAgICAgICBGdW5jdGlvbiBSZWZyZXNoLUJpdExvY2tlclZhcmlhYmxlc0ZvckN1cnJlbnRWb2x1bWUgewogICAgICAgICAgICBwYXJhbSgKICAgICAgICAgICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5PSR0cnVlKV0KICAgICAgICAgICAgICAgIFtWYWxpZGF0ZU5vdE51bGxPckVtcHR5KCldCiAgICAgICAgICAgICAgICBbc3RyaW5nXSAkRHJpdmVMZXR0ZXIKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBWYWxpZGF0ZSBJbnB1dAogICAgICAgICAgICAkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlciA9IFtzdHJpbmddJCgkRHJpdmVMZXR0ZXIuVHJpbSgnOicpLlRvVXBwZXIoKSkKICAgICAgICAgICAgaWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyLkxlbmd0aCAtZ3QgMSkgewogICAgICAgICAgICAgICAgVGhyb3cgJ0VSUk9SOiBEcml2ZSBsZXR0ZXIgY2Fubm90IGJlIG1vcmUgdGhhbiBvbmUgbGV0dGVyJwogICAgICAgICAgICB9CgoKICAgICAgICAgICAgIyBWYXJpYWJsZXMgdGhhdHMgYWx3YXlzIHByZXNlbnQKICAgICAgICAgICAgJFNjcmlwdDpWb2x1bWVFbmNyeXB0aW9uU3RhdHVzICAgICA9IFtzdHJpbmddJChHZXQtVmFyaWFibGUgLU5hbWUgKCd7MH1Wb2x1bWVFbmNyeXB0aW9uU3RhdHVzJyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpKSAtU2NvcGUgJ1NjcmlwdCcgLVZhbHVlT25seSAtRXJyb3JBY3Rpb24gJ1N0b3AnKQogICAgICAgICAgICAkU2NyaXB0OlZvbHVtZVByb3RlY3Rpb25TdGF0dXMgICAgID0gW3N0cmluZ10kKEdldC1WYXJpYWJsZSAtTmFtZSAoJ3swfVZvbHVtZVByb3RlY3Rpb25TdGF0dXMnIC1mICgkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlcikpIC1TY29wZSAnU2NyaXB0JyAtVmFsdWVPbmx5IC1FcnJvckFjdGlvbiAnU3RvcCcpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFZhcmlhYmxlcyB0aGF0cyBwcmVzZW50IG9ubHkgaWYgdGhlcmVzIGF0IGxlYXN0IG9uZSBLZXlQcm90ZWN0b3IgZm9yIGN1cnJlbnQgdm9sdW1lCiAgICAgICAgICAgICRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFcgICAgICAgICAgPSBbYm9vbFtdXSQoR2V0LVZhcmlhYmxlIC1OYW1lICgnezB9Vm9sdW1lSGFzVFBNYW5kUFcnIC1mICgkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlcikpIC1TY29wZSAnU2NyaXB0JyAtVmFsdWVPbmx5IC1FcnJvckFjdGlvbiAnU2lsZW50bHlDb250aW51ZScpCiAgICAgICAgICAgICRTY3JpcHQ6Vm9sdW1lRW5jcnlwdGlvblBlcmNlbnRhZ2UgPSBbc3RyaW5nXSQoR2V0LVZhcmlhYmxlIC1OYW1lICgnezB9Vm9sdW1lRW5jcnlwdGlvblBlcmNlbnRhZ2UnIC1mICgkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlcikpIC1TY29wZSAnU2NyaXB0JyAtVmFsdWVPbmx5IC1FcnJvckFjdGlvbiAnU2lsZW50bHlDb250aW51ZScpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFZhcmlhYmxlcyB0aGF0cyBwcmVzZW50IG9ubHkgaWYgY3VycmVudCB2b2x1bWUgaXMgcHJvdGVjdGVkIHdpdGggbWluaW11bSBhIFRQTSBhbmQgYSBSZWNvdmVyeSBQYXNzd29yZAogICAgICAgICAgICAkU2NyaXB0OkFycmF5UmVjb3ZlcnlQYXNzd29yZHMgICAgID0gR2V0LVZhcmlhYmxlIC1OYW1lICgnezB9QXJyYXlSZWNvdmVyeVBhc3N3b3JkcycgLWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyKSkgLVNjb3BlICdTY3JpcHQnIC1WYWx1ZU9ubHkgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJwogICAgICAgICAgICAkU2NyaXB0OkNvdW50UmVjb3ZlcnlQYXNzd29yZHMgICAgID0gW2J5dGVdJChHZXQtVmFyaWFibGUgLU5hbWUgKCd7MH1Db3VudFJlY292ZXJ5UGFzc3dvcmRzJyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpKSAtU2NvcGUgJ1NjcmlwdCcgLVZhbHVlT25seSAtRXJyb3JBY3Rpb24gJ1NpbGVudGx5Q29udGludWUnKQogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIFJlZnJlc2gtQml0TG9ja2VyVmFyaWFibGVzRm9yQ3VycmVudFZvbHVtZQoKCiAgICAgICAgI3JlZ2lvbiAgICBDaGVjay1JZkJpdExvY2tlclBXSGFzQ2hhbmdlZAogICAgICAgIEZ1bmN0aW9uIENoZWNrLUlmQml0TG9ja2VyUFdIYXNDaGFuZ2VkIHsKICAgICAgICAgICAgcGFyYW0oCiAgICAgICAgICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeT0kZmFsc2UpXQogICAgICAgICAgICAgICAgW1ZhbGlkYXRlTm90TnVsbE9yRW1wdHkoKV0KICAgICAgICAgICAgICAgIFtzdHJpbmddICREcml2ZUxldHRlciA9ICRPU0RyaXZlTGV0dGVyCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgSGVscCBWYXJpYWJsZXMKICAgICAgICAgICAgJExvY2FsOkhhc0NoYW5nZWQgPSBbYm9vbF0kKCRmYWxzZSkKICAgICAgICAgICAgJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIgPSBbc3RyaW5nXSQoJERyaXZlTGV0dGVyLlRyaW0oJzonKS5Ub1VwcGVyKCkpCiAgICAgICAgICAgIGlmICgkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlci4nTGVuZ3RoJyAtZ3QgMSkgewogICAgICAgICAgICAgICAgVGhyb3cgJ0VSUk9SOiBEcml2ZSBsZXR0ZXIgY2Fubm90IGJlIG1vcmUgdGhhbiBvbmUgbGV0dGVyJwogICAgICAgICAgICB9CgogICAgICAgICAgICAjIE5hbWUgVmFyaWFibGVzCiAgICAgICAgICAgICRMb2NhbDpOYW1lQXJyYXkgPSBbc3RyaW5nXSQoJ3swfUFycmF5UmVjb3ZlcnlQYXNzd29yZHMnIC1mICgkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlcikpCiAgICAgICAgICAgICRMb2NhbDpWb2x1bWVVbmlxdWVJRCA9IFtzdHJpbmddJChHZXQtVm9sdW1lVW5pcXVlSUQgLURyaXZlTGV0dGVyICRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyKQogICAgICAgICAgICAkTG9jYWw6TmFtZUZpbGUgPSBbc3RyaW5nXSQoJ3swfS50eHQnIC1mICgkVm9sdW1lVW5pcXVlSUQpKQogICAgICAgICAgIAogICAgICAgICAgICAjIEdldCBWYXJpYWJsZXMKICAgICAgICAgICAgJExvY2FsOlBhdGhEaXIgPSBbc3RyaW5nXSQoJ3swfXsxfScgLWYgKCRTY3JpcHQ6RGlySW5zdGFsbCwnQmFja3VwS2V5c1wnKSkKICAgICAgICAgICAgJExvY2FsOlBhdGhGaWxlID0gW3N0cmluZ10kKCd7MH17MX0nIC1mICgkTG9jYWw6UGF0aERpciwkTG9jYWw6TmFtZUZpbGUpKQogICAgICAgICAgICAkTG9jYWw6Tm93S2V5UHJvdGVjdG9ySUQgPSBbc3RyaW5nXSQoKChHZXQtVmFyaWFibGUgLU5hbWUgJExvY2FsOk5hbWVBcnJheSAtU2NvcGUgJ1NjcmlwdCcpLidWYWx1ZScpLidLZXlQcm90ZWN0b3JJRCcpCiAgICAgICAgICAgICRMb2NhbDpOb3dSZWNvdmVyeVBhc3N3b3JkID0gW3N0cmluZ10kKCgoR2V0LVZhcmlhYmxlIC1OYW1lICRMb2NhbDpOYW1lQXJyYXkgLVNjb3BlICdTY3JpcHQnKS4nVmFsdWUnKS4nUmVjb3ZlcnlQYXNzd29yZCcpCgoKICAgICAgICAgICAgIyBHZXQgc3RhdHMKICAgICAgICAgICAgaWYgKC1ub3QgKFRlc3QtUGF0aCAtUGF0aCAkTG9jYWw6UGF0aEZpbGUpKSB7CiAgICAgICAgICAgICAgICAkTG9jYWw6SGFzQ2hhbmdlZCA9ICR0cnVlCiAgICAgICAgICAgICAgICBpZiAoLW5vdChUZXN0LVBhdGggLVBhdGggJExvY2FsOlBhdGhEaXIgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJykpIHsKICAgICAgICAgICAgICAgICAgICAkbnVsbCA9IE5ldy1JdGVtIC1QYXRoICRMb2NhbDpQYXRoRGlyIC1JdGVtVHlwZSAnRGlyZWN0b3J5JyAtRm9yY2UKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICRMb2NhbDpJbnB1dFN0cmluZyA9IFtzdHJpbmdbXV0kKChHZXQtQ29udGVudCAtUGF0aCAkTG9jYWw6UGF0aEZpbGUpLlNwbGl0KFtFbnZpcm9ubWVudF06Ok5ld0xpbmUpKQogICAgICAgICAgICAgICAgaWYgKCQ/IC1hbmQgJExvY2FsOklucHV0U3RyaW5nLidMZW5ndGgnIC1nZSA3KSB7CiAgICAgICAgICAgICAgICAgICAgJExvY2FsOlByZXZLZXlQcm90ZWN0b3JJRCA9IFtzdHJpbmddJCgkTG9jYWw6SW5wdXRTdHJpbmdbNV0uVHJpbSgpKQogICAgICAgICAgICAgICAgICAgICRMb2NhbDpQcmV2UmVjb3ZlcnlQYXNzd29yZCA9IFtzdHJpbmddJCgkTG9jYWw6SW5wdXRTdHJpbmdbN10uVHJpbSgpKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7JExvY2FsOkhhc0NoYW5nZWQgPSAkdHJ1ZX0KICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICMgQ2hlY2sgaWYgY2hhbmdlZAogICAgICAgICAgICBpZiAoJExvY2FsOlByZXZLZXlQcm90ZWN0b3JJRCkgewogICAgICAgICAgICAgICAgaWYgKCRMb2NhbDpQcmV2S2V5UHJvdGVjdG9ySUQgLW5lICRMb2NhbDpOb3dLZXlQcm90ZWN0b3JJRCkgeyRMb2NhbDpIYXNDaGFuZ2VkID0gJHRydWV9CiAgICAgICAgICAgICAgICBpZiAoJExvY2FsOlByZXZSZWNvdmVyeVBhc3N3b3JkIC1uZSAkTG9jYWw6Tm93UmVjb3ZlcnlQYXNzd29yZCkgeyRMb2NhbDpIYXNDaGFuZ2VkID0gJHRydWV9CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAjIFdyaXRlIG5ldyB2YWx1ZXMgaWYgY2hhbmdlZCBvciBkb2VzIG5vdCBleGlzdAogICAgICAgICAgICBpZiAoJExvY2FsOkhhc0NoYW5nZWQgLW9yICgtbm90IChUZXN0LVBhdGggLVBhdGggJExvY2FsOlBhdGhGaWxlKSkpIHsKICAgICAgICAgICAgICAgICRMb2NhbDpPdXRTdHIgPSBbc3RyaW5nXTo6RW1wdHkKICAgICAgICAgICAgICAgICRMb2NhbDpPdXRTdHIgKz0gJ0RyaXZlL1ZvbHVtZSBMZXR0ZXIgKE5vdCBVbmlxdWUgaWRlbnRpZmllcik6ezB9JyAtZiAiYHJgbiIKICAgICAgICAgICAgICAgICRMb2NhbDpPdXRTdHIgKz0gJ3swfXsxfScgLWYgJEN1cnJlbnRWb2x1bWVMZXR0ZXIsImByYG4iCiAgICAgICAgICAgICAgICAkTG9jYWw6T3V0U3RyICs9ICdWb2x1bWUgVW5pcXVlSUQgKE5hbWUgb2YgdGhpcyBmaWxlKTp7MH0nIC1mICJgcmBuIgogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciArPSAnezB9ezF9JyAtZiAkTG9jYWw6Vm9sdW1lVW5pcXVlSUQsImByYG4iCiAgICAgICAgICAgICAgICAkTG9jYWw6T3V0U3RyICs9ICdLZXlQcm90ZWN0b3JJRDp7MH0nIC1mICJgcmBuIgogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciArPSAnezB9ezF9JyAtZiAkTG9jYWw6Tm93S2V5UHJvdGVjdG9ySUQsImByYG4iCiAgICAgICAgICAgICAgICAkTG9jYWw6T3V0U3RyICs9ICdSZWNvdmVyeSBQYXNzd29yZDp7MH0nIC1mICJgcmBuIgogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciArPSAnezB9ezF9JyAtZiAkTG9jYWw6Tm93UmVjb3ZlcnlQYXNzd29yZCwiYHJgbiIKICAgICAgICAgICAgICAgICRudWxsID0gT3V0LUZpbGUgLUZpbGVQYXRoICRMb2NhbDpQYXRoRmlsZSAtRW5jb2RpbmcgJ3V0ZjgnIC1Gb3JjZSAtSW5wdXRPYmplY3QgKCRMb2NhbDpPdXRTdHIpCiAgICAgICAgICAgIH0KCgoKICAgICAgICAgICAgIyBSZXR1cm4gc3RhdHVzCiAgICAgICAgICAgIHJldHVybiAkTG9jYWw6SGFzQ2hhbmdlZAogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIENoZWNrLUlmQml0TG9ja2VyUFdIYXNDaGFuZ2VkCiAgICAjZW5kcmVnaW9uIFJldHVybiBWYWx1ZXMgKFVzZWQgYnkgb3RoZXIgRnVuY3Rpb25zKQoKCgogICAgI3JlZ2lvbiBTZXQgU2NyaXB0IFdpZGUgVmFyaWFibGVzCiAgICAgICAgI3JlZ2lvbiBHZXQtQml0TG9ja2VyU3RhdHVzCiAgICAgICAgRnVuY3Rpb24gR2V0LUJpdExvY2tlclN0YXR1cyB7CiAgICAgICAgICAgIDwjCiAgICAgICAgICAgICAgICAqIEZpbGxzIHR3byBzdHJpbmdzIHdpdGggY3VycmVudCBWb2x1bWUgRW5jcnlwdGlvbiBTdGF0dXMsIGFuZCBWb2x1bWUgUHJvdGVjdGlvbiBTdGF0dXMuIAogICAgICAgICAgICAgICAgKiBBbHNvIG1ha2VzIGEgYm9vbCBhcnJheSB3aXRoIHRydWUgZmFsc2UgZm9yIHwgMTogVFBNIHByZXNlbnQgfCAyOiBSZWNvdmVyeSBQYXNzd29yZCBQcmVzZW50CiAgICAgICAgICAgICM+CiAgICAgICAgICAgIFBhcmFtKAogICAgICAgICAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnk9JGZhbHNlKV0KICAgICAgICAgICAgICAgIFtWYWxpZGF0ZU5vdE51bGxPckVtcHR5KCldCiAgICAgICAgICAgICAgICBbc3RyaW5nXSAkRHJpdmVMZXR0ZXIgPSAkT1NEcml2ZUxldHRlcgogICAgICAgICAgICApCgogICAgICAgICAgICAjIEhlbHAgdmFyaWFibGUKICAgICAgICAgICAgJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIgPSBbc3RyaW5nXSQoJERyaXZlTGV0dGVyLlRyaW0oJzonKS5Ub1VwcGVyKCkpCiAgICAgICAgICAgIGlmICgkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlci4nTGVuZ3RoJyAtbmUgMSkgewogICAgICAgICAgICAgICAgVGhyb3cgJ0VSUk9SOiBEcml2ZSBsZXR0ZXIgY2Fubm90IGJlIG1vcmUgb3IgbGVzcyB0aGFuIG9uZSBsZXR0ZXIhJwogICAgICAgICAgICB9CgogICAgICAgICAgICAjIEdldCBCaXRMb2NrZXIgU3RhdHVzIGZvciBWb2x1bWUKICAgICAgICAgICAgJExvY2FsOkJpdExvY2tlclZvbHVtZVN0YXR1cyA9IFtNaWNyb3NvZnQuQml0TG9ja2VyLlN0cnVjdHVyZXMuQml0TG9ja2VyVm9sdW1lXSQoR2V0LUJpdExvY2tlclZvbHVtZSAtTW91bnRQb2ludCAkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlcikKICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgQml0TG9ja2VyIFZvbHVtZSBFbmNyeXB0aW9uIFN0YXR1czogRnVsbHlEZWNyeXB0ZWQgfCBFbmNyeXB0aW9uSW5Qcm9ncmVzcyB8IEZ1bGx5RW5jcnlwdGVkCiAgICAgICAgICAgIE5ldy1WYXJpYWJsZSAtTmFtZSAoJ3swfVZvbHVtZUVuY3J5cHRpb25TdGF0dXMnIC1mICgkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlcikpIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgYAogICAgICAgICAgICAgICAgICAgICAgICAgLVZhbHVlIChbc3RyaW5nXSQoJExvY2FsOkJpdExvY2tlclZvbHVtZVN0YXR1cyB8IFNlbGVjdC1PYmplY3QgLUV4cGFuZFByb3BlcnR5ICdWb2x1bWVTdGF0dXMnKSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQml0TG9ja2VyIFZvbHVtZSBQcm90ZWN0aW9uIFN0YXR1czogT04gaWYgRW5jcnlwdGlvbiBQZXJjZW50YWdlID0gMTAwJQogICAgICAgICAgICBOZXctVmFyaWFibGUgLU5hbWUgKCd7MH1Wb2x1bWVQcm90ZWN0aW9uU3RhdHVzJyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpKSAtU2NvcGUgJ1NjcmlwdCcgLUZvcmNlIGAKICAgICAgICAgICAgICAgICAgICAgICAgIC1WYWx1ZSAoW3N0cmluZ10kKCRMb2NhbDpCaXRMb2NrZXJWb2x1bWVTdGF0dXMgfCBTZWxlY3QtT2JqZWN0IC1FeHBhbmRQcm9wZXJ0eSAnUHJvdGVjdGlvblN0YXR1cycpKQogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICA8IyAgCiAgICAgICAgICAgICAgICAgICAgVm9sdW1lIGNhbiBiZSAnRnVsbHkgRGVjcnlwdGVkJywgYnV0IHN0aWxsIGhhdmUgYSBUUE0gcHJlc2VudC4gCiAgICAgICAgICAgICAgICAgICAgVGhpcyBpcyB1c3VhbGx5IHRoZSBjYXNlIHJpZ2h0IGFmdGVyIGVuY3J5cHRpb24gaGFzIHN0YXJ0ZWQuIAogICAgICAgICAgICAjPgoKCiAgICAgICAgICAgICMgSWYgdGhlcmUgaXMgYSBLZXlQcm90ZWN0b3IgZm9yIGdpdmVuIHZvbHVtZSwgZ2V0IHRoZSByZXN0IG9mIHRoZSB2YXJpYWJsZXMKICAgICAgICAgICAgaWYgKCRMb2NhbDpCaXRMb2NrZXJWb2x1bWVTdGF0dXMuJ0tleVByb3RlY3RvcicuJ0NvdW50JyAtZ3QgMCkgewogICAgICAgICAgICAgICAgIyBbMH0gPSBWb2x1bWUgaGFzIFRQTT8gICBbMV0gPSBWb2x1bWUgaGFzIFJlY292ZXJ5IFBhc3N3b3JkPwogICAgICAgICAgICAgICAgTmV3LVZhcmlhYmxlIC1OYW1lICgnezB9Vm9sdW1lSGFzVFBNYW5kUFcnIC1mICgkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlcikpIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIC1WYWx1ZSAoW2Jvb2xbXV0kKEdldC1Cb29sRHJpdmVIYXNCaXRMb2NrZXJUUE1hbmRQVyAtRHJpdmVMZXR0ZXIgJEN1cnJlbnRWb2x1bWVMZXR0ZXIpKSAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBFbmNyeXB0aW9uIFBlcmNlbnRhZ2U6IEhvdyBsb25nIGhhcyB0aGUgZW5jcnlwdGlvbiBwcm9jZXNzIGNvbWUKICAgICAgICAgICAgICAgIE5ldy1WYXJpYWJsZSAtTmFtZSAoJ3swfVZvbHVtZUVuY3J5cHRpb25QZXJjZW50YWdlJyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpKSAtU2NvcGUgJ1NjcmlwdCcgLUZvcmNlIGAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtVmFsdWUgKFtzdHJpbmddJCgkTG9jYWw6Qml0TG9ja2VyVm9sdW1lU3RhdHVzIHwgU2VsZWN0LU9iamVjdCAtRXhwYW5kUHJvcGVydHkgJ0VuY3J5cHRpb25QZXJjZW50YWdlJykuVG9TdHJpbmcoKSkgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIElmIERyaXZlIGhhcyBUUE0gYW5kIFBXCiAgICAgICAgICAgICAgICBpZiAoKEdldC1WYXJpYWJsZSAtTmFtZSAoJ3swfVZvbHVtZUhhc1RQTWFuZFBXJyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpKSAtU2NvcGUgJ1NjcmlwdCcpLlZhbHVlWzFdKSB7CiAgICAgICAgICAgICAgICAgICAgIyBOYW1lIHRoZSB2YXJpYWJsZXMKICAgICAgICAgICAgICAgICAgICAkTG9jYWw6TmFtZUFycmF5UmVjb3ZlcnlQYXNzd29yZHMgPSBbc3RyaW5nXSQoJ3swfUFycmF5UmVjb3ZlcnlQYXNzd29yZHMnIC1mICgkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlcikpCiAgICAgICAgICAgICAgICAgICAgJExvY2FsOk5hbWVDb3VudFJlY292ZXJ5UGFzc3dvcmRzID0gW3N0cmluZ10kKCd7MH1Db3VudFJlY292ZXJ5UGFzc3dvcmRzJyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpKQoKICAgICAgICAgICAgICAgICAgICAjIEdldCBBcnJheSB3aXRoIHByb3RlY3Rpb24gcGFzc3dvcmRzCiAgICAgICAgICAgICAgICAgICAgTmV3LVZhcmlhYmxlIC1OYW1lICRMb2NhbDpOYW1lQXJyYXlSZWNvdmVyeVBhc3N3b3JkcyAtU2NvcGUgJ1NjcmlwdCcgLUZvcmNlIGAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLVZhbHVlIChHZXQtQXJyYXlSZWNvdmVyeVBhc3N3b3JkcyAtQml0TG9ja2VyVm9sdW1lICRMb2NhbDpCaXRMb2NrZXJWb2x1bWVTdGF0dXMpCgogICAgICAgICAgICAgICAgICAgICMgQ291bnQgQXJyYXlSZWNvdmVyeVBhc3N3b3JkcwogICAgICAgICAgICAgICAgICAgIE5ldy1WYXJpYWJsZSAtTmFtZSAkTG9jYWw6TmFtZUNvdW50UmVjb3ZlcnlQYXNzd29yZHMgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSBgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC1WYWx1ZSAoW2J5dGVdJCgoR2V0LVZhcmlhYmxlIC1OYW1lICRMb2NhbDpOYW1lQXJyYXlSZWNvdmVyeVBhc3N3b3JkcykuJ1ZhbHVlJykuJ0xlbmd0aCcpCgogICAgICAgICAgICAgICAgICAgICMgR2V0IFZvbHVtZSBVbmlxdWUgSUQgKHRvIGNoZWNrIGlmIHByb3RlY3Rpb24gcGFzc3dvcmQgaGFzIGNoYW5nZWQpCiAgICAgICAgICAgICAgICAgICAgTmV3LVZhcmlhYmxlIC1OYW1lICgnezB9Vm9sdW1lVW5pcXVlSUQnIC1mICgkTG9jYWw6TmFtZVZvbHVtZSkpIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtVmFsdWUgKChHZXQtVm9sdW1lVW5pcXVlSUQgLURyaXZlTGV0dGVyICRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyKSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIEdldC1CaXRMb2NrZXJTdGF0dXMKICAgICNlbmRyZWdpb24gU2V0IFNjcmlwdCBXaWRlIFZhcmlhYmxlcwoKCgogICAgI3JlZ2lvbiBSZWdpc3RyeSBGdW5jdGlvbnMKICAgICAgICAjcmVnaW9uIENyZWF0ZS1FbnZWYXJpYWJsZXMKICAgICAgICAjIENyZWF0ZS1FbnZWYXJpYWJsZXM6IENyZWF0ZXMgdmFyaWFibGVzIHVzZWQgYnkgdGhlIHRyb3VibGVzaG9vdGVyIGF0IHRoZSBib3R0b20sIHdoZW4gZmFpbGVkIHJ1bnMgcmVhY2hlcyBhIGdpdmVuIG51bWJlci4gIAogICAgICAgIEZ1bmN0aW9uIENyZWF0ZS1FbnZWYXJpYWJsZXMgewogICAgICAgICAgICAjIyMjIFNjcmlwdCBXaWRlIFZhcmlhYmxlcwogICAgICAgICAgICAjIyBUZW5hbnQKICAgICAgICAgICAgJExvY2FsOlBhdGhEaXJSZWdUZW5hbnRKb2luSW5mb0Jhc2UgPSBbc3RyaW5nXSQoJ1JlZ2lzdHJ5OjpIS0VZX0xPQ0FMX01BQ0hJTkVcU1lTVEVNXEN1cnJlbnRDb250cm9sU2V0XENvbnRyb2xcQ2xvdWREb21haW5Kb2luXEpvaW5JbmZvJykKICAgICAgICAgICAgJExvY2FsOlBhdGhEaXJSZWdUZW5hbnRKb2luSW5mb0Z1bGwgPSBbc3RyaW5nXSQoJ3swfVx7MX0nIC1mICgkTG9jYWw6UGF0aERpclJlZ1RlbmFudEpvaW5JbmZvQmFzZSwKICAgICAgICAgICAgICAgIChHZXQtQ2hpbGRJdGVtIC1QYXRoICRMb2NhbDpQYXRoRGlyUmVnVGVuYW50Sm9pbkluZm9CYXNlIHwgU2VsZWN0LU9iamVjdCAtRXhwYW5kUHJvcGVydHkgJ05hbWUnKS5TcGxpdCgnXCcpWy0xXQogICAgICAgICAgICApKQogICAgICAgICAgICAkU2NyaXB0Ok5hbWVUZW5hbnQgPSBbc3RyaW5nXSQoR2V0LUl0ZW1Qcm9wZXJ0eSAtUGF0aCAkTG9jYWw6UGF0aERpclJlZ1RlbmFudEpvaW5JbmZvRnVsbCkuJ1VzZXJFbWFpbCcuU3BsaXQoJ0AnKVsxXQogICAgICAgICAgICAkU2NyaXB0Ok5hbWVUZW5hbnRTaG9ydCA9IFtzdHJpbmddJCgkU2NyaXB0Ok5hbWVUZW5hbnQuU3BsaXQoJy4nKVswXSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMjIEhhcmR3YXJlIGFuZCBXaW5kb3dzIGluZm8KICAgICAgICAgICAgJFNjcmlwdDpDb21wdXRlck1hbnVmYWN0dXJlciA9IFtzdHJpbmddJChRdWVyeS1SZWdpc3RyeSAtRGlyICdSZWdpc3RyeTo6SEtFWV9MT0NBTF9NQUNISU5FXEhBUkRXQVJFXERFU0NSSVBUSU9OXFN5c3RlbVxCSU9TXFN5c3RlbU1hbnVmYWN0dXJlcicpCiAgICAgICAgICAgIGlmICgtbm90KFtzdHJpbmddOjpJc051bGxPckVtcHR5KCRTY3JpcHQ6Q29tcHV0ZXJNYW51ZmFjdHVyZXIpKSkgewogICAgICAgICAgICAgICAgJFNjcmlwdDpDb21wdXRlckZhbWlseSA9IFtzdHJpbmddJChRdWVyeS1SZWdpc3RyeSAtRGlyICdSZWdpc3RyeTo6SEtFWV9MT0NBTF9NQUNISU5FXEhBUkRXQVJFXERFU0NSSVBUSU9OXFN5c3RlbVxCSU9TXFN5c3RlbUZhbWlseScpCiAgICAgICAgICAgICAgICAkU2NyaXB0OkNvbXB1dGVyUHJvZHVjdE5hbWUgPSBbc3RyaW5nXSQoUXVlcnktUmVnaXN0cnkgLURpciAnUmVnaXN0cnk6OkhLRVlfTE9DQUxfTUFDSElORVxIQVJEV0FSRVxERVNDUklQVElPTlxTeXN0ZW1cQklPU1xTeXN0ZW1Qcm9kdWN0TmFtZScpCiAgICAgICAgICAgICAgICAkU2NyaXB0OldpbmRvd3NFZGl0aW9uID0gW3N0cmluZ10kKFF1ZXJ5LVJlZ2lzdHJ5IC1EaXIgJ1JlZ2lzdHJ5OjpIS0VZX0xPQ0FMX01BQ0hJTkVcU09GVFdBUkVcTWljcm9zb2Z0XFdpbmRvd3MgTlRcQ3VycmVudFZlcnNpb25cUHJvZHVjdE5hbWUnKQogICAgICAgICAgICAgICAgJFNjcmlwdDpXaW5kb3dzVmVyc2lvbiA9IFtzdHJpbmddJChRdWVyeS1SZWdpc3RyeSAtRGlyICdSZWdpc3RyeTo6SEtFWV9MT0NBTF9NQUNISU5FXFNPRlRXQVJFXE1pY3Jvc29mdFxXaW5kb3dzIE5UXEN1cnJlbnRWZXJzaW9uXFJlbGVhc2VJZCcpCiAgICAgICAgICAgICAgICAkU2NyaXB0OldpbmRvd3NWZXJzaW9uICs9IFtzdHJpbmddJCgnICh7MH0pJyAtZiAoUXVlcnktUmVnaXN0cnkgLURpciAnUmVnaXN0cnk6OkhLRVlfTE9DQUxfTUFDSElORVxTT0ZUV0FSRVxNaWNyb3NvZnRcV2luZG93cyBOVFxDdXJyZW50VmVyc2lvblxDdXJyZW50QnVpbGQnKSkKICAgICAgICAgICAgfSAKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAkTG9jYWw6RW52SW5mbyA9IEdldC1XbWlPYmplY3QgLUNsYXNzICdXaW4zMl9Db21wdXRlclN5c3RlbScgfCBTZWxlY3QtT2JqZWN0IC1Qcm9wZXJ0eSAnTWFudWZhY3R1cmVyJywnTW9kZWwnLCdTeXN0ZW1GYW1pbHknCiAgICAgICAgICAgICAgICAkU2NyaXB0OkNvbXB1dGVyTWFudWZhY3R1cmVyID0gW3N0cmluZ10kKCRMb2NhbDpFbnZJbmZvLidNYW51ZmFjdHVyZXInKQogICAgICAgICAgICAgICAgJFNjcmlwdDpDb21wdXRlckZhbWlseSA9IFtzdHJpbmddJCgkTG9jYWw6RW52SW5mby4nU3lzdGVtRmFtaWx5JykKICAgICAgICAgICAgICAgICRTY3JpcHQ6Q29tcHV0ZXJQcm9kdWN0TmFtZSA9IFtzdHJpbmddJCgkTG9jYWw6RW52SW5mby4nTW9kZWwnKQogICAgICAgICAgICAgICAgJExvY2FsOk9TSW5mbyA9IEdldC1XbWlPYmplY3QgLUNsYXNzICdXaW4zMl9vcGVyYXRpbmdzeXN0ZW0nIHwgU2VsZWN0LU9iamVjdCAtUHJvcGVydHkgJ0NhcHRpb24nLCdWZXJzaW9uJwogICAgICAgICAgICAgICAgJFNjcmlwdDpXaW5kb3dzRWRpdGlvbiA9IFtzdHJpbmddJCgkTG9jYWw6T1NJbmZvLidDYXB0aW9uJykKICAgICAgICAgICAgICAgICRTY3JpcHQ6V2luZG93c1ZlcnNpb24gPSBbc3RyaW5nXSQoJExvY2FsOk9TSW5mby4nVmVyc2lvbicpCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBDcmVhdGUtRW52VmFyaWFibGVzCgoKICAgICAgICAjcmVnaW9uICAgIFF1ZXJ5LVJlZ2lzdHJ5CiAgICAgICAgRnVuY3Rpb24gUXVlcnktUmVnaXN0cnkgewogICAgICAgICAgICBQYXJhbSAoW1BhcmFtZXRlcihNYW5kYXRvcnk9JHRydWUpXSBbc3RyaW5nXSAkRGlyKQogICAgICAgICAgICAkTG9jYWw6T3V0ID0gW3N0cmluZ106OkVtcHR5CiAgICAgICAgICAgICRMb2NhbDpLZXkgPSBbc3RyaW5nXSQoJERpci5TcGxpdCgne1x9JylbLTFdKQogICAgICAgICAgICAkTG9jYWw6RGlyID0gW3N0cmluZ10kKCREaXIuUmVwbGFjZSgkTG9jYWw6S2V5LCcnKSkKICAgICAgICAKICAgICAgICAgICAgJExvY2FsOkV4aXN0cyA9IEdldC1JdGVtUHJvcGVydHkgLVBhdGggKCd7MH0nIC1mICREaXIpIC1OYW1lICgnezB9JyAtZiAkTG9jYWw6S2V5KSAtRXJyb3JBY3Rpb24gJ1NpbGVudGx5Q29udGludWUnCiAgICAgICAgICAgIGlmICgkRXhpc3RzKSB7CiAgICAgICAgICAgICAgICAkTG9jYWw6T3V0ID0gJExvY2FsOkV4aXN0cy4kTG9jYWw6S2V5CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICRMb2NhbDpPdXQKICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBRdWVyeS1SZWdpc3RyeQogICAgI2VuZHJlZ2lvbiBSZWdpc3RyeSBGdW5jdGlvbnMKCgoKICAgICNyZWdpb24gICAgRWRpdC1TY2hlZHVsZWRUYXNrCiAgICBmdW5jdGlvbiBFZGl0LVNjaGVkdWxlZFRhc2sgewogICAgICAgIFBhcmFtKAogICAgICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeT0kZmFsc2UpXQogICAgICAgICAgICBbc3RyaW5nXSAkVGFza05hbWUgPSAkU2NyaXB0OlNjaGVkdWxlZFRhc2tOYW1lCiAgICAgICAgKQoKICAgICAgICAkVGFzayA9IEdldC1TY2hlZHVsZWRUYXNrIC1UYXNrTmFtZSAkVGFza05hbWUgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJwoKICAgICAgICBpZiAoJFRhc2spIHsKICAgICAgICAgICAgaWYgKCRTY3JpcHQ6Qm9vbFJlbW92ZVNjaGVkdWxlZFRhc2tBZnRlckZpcnN0U3VjY2VzcykgewogICAgICAgICAgICAgICAgJG51bGwgPSBVbnJlZ2lzdGVyLVNjaGVkdWxlZFRhc2sgLVRhc2tOYW1lICRUYXNrIC1Db25maXJtOiRmYWxzZSAtRXJyb3JBY3Rpb24gJ1NpbGVudGx5Q29udGludWUnCiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1JlbW92aW5nIHRoZSBTY2hlZHVsZWQgdGFzayAiezB9Ii4gU3VjY2Vzcz8gezF9JyAtZiAoJFRhc2suJ1Rhc2tOYW1lJywkPy5Ub1N0cmluZygpKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICRMb2NhbDpOZXdTY2hlZFRpbWUgPSBbZGF0ZXRpbWVdJChbZGF0ZXRpbWVdOjpUb2RheS5BZGRIb3VycygxMikpCiAgICAgICAgICAgICAgICAkbnVsbCA9IFNldC1TY2hlZHVsZWRUYXNrIC1UYXNrTmFtZSAkU2NyaXB0OlNjaGVkdWxlZFRhc2tOYW1lIC1UcmlnZ2VyIChOZXctU2NoZWR1bGVkVGFza1RyaWdnZXIgLURhaWx5IC1BdCAkTG9jYWw6TmV3U2NoZWRUaW1lKSAtRXJyb3JBY3Rpb24gJ1NpbGVudGx5Q29udGludWUnCiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0VkaXRpbmcgU2NoZWR1bGVkIHRhc2sgInswfSIgdG8gc3RhcnQgZGFpbHkgYXQgezF9LiBTdWNjZXNzPyB7Mn0uJyAtZiAoJFNjcmlwdDpTY2hlZHVsZWRUYXNrTmFtZSwkTG9jYWw6TmV3U2NoZWRUaW1lLidIb3VyJy5Ub1N0cmluZygpLCQ/LlRvU3RyaW5nKCkpKQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBMb2dXcml0ZSAoJ0ZvdW5kIG5vIFNjaGVkdWxlZCBUYXNrIHdpdGggbmFtZSAiezB9Ii4nIC1mICgkVGFza05hbWUpKQogICAgICAgIH0KICAgIH0KICAgICNlbmRyZWdpb24gRWRpdC1TY2hlZHVsZWRUYXNrCgoKICAgICNyZWdpb24gICAgUHJvbXB0LVJlYm9vdAogICAgRnVuY3Rpb24gUHJvbXB0LVJlYm9vdCB7CiAgICAgICAgJExvY2FsOlRpbWVUb1JlYm9vdEluTWludXRlcyA9IFt1aW50MTZdJCg2MCkKICAgICAgICAkTG9jYWw6U3RyU2hvcnRNZXNzYWdlID0gW3N0cmluZ10kKCdXaW5kb3dzIHdpbGwgcmVzdGFydCBpbiB7MH0gbWludXRlcyB0byBmaW5pc2ggZGV2aWNlIGNvbmZpZ3VyYXRpb24uIFNhdmUgeW91ciB3b3JrIScgLWYgKCRMb2NhbDpUaW1lVG9SZWJvb3RJbk1pbnV0ZXMpKQogICAgICAgICRudWxsID0gY21kLmV4ZSAvYyAoJ3NodXRkb3duIC9yIC90IHswfSAvYyAiezF9IicgLWYgKCRMb2NhbDpUaW1lVG9SZWJvb3RJbk1pbnV0ZXMqNjApLCRMb2NhbDpTdHJTaG9ydE1lc3NhZ2UpIDI+JjEKICAgICAgICBpZiAoLW5vdCgkPykpIHsKICAgICAgICAgICAgJG51bGwgPSBjbWQuZXhlIC9jICgnc2h1dGRvd24gL2EnKSAyPiYxCiAgICAgICAgICAgICRudWxsID0gY21kLmV4ZSAvYyAoJ3NodXRkb3duIC9yIC90IHswfSAvYyAiezF9IicgLWYgKCRMb2NhbDpUaW1lVG9SZWJvb3RJbk1pbnV0ZXMqNjApLCRMb2NhbDpTdHJTaG9ydE1lc3NhZ2UpIDI+JjEKICAgICAgICB9CgogICAgICAgIDwjIEZPUiBGVVRVUkUgRU5IQU5DRU1FTlRTCiAgICAgICAgW3N0cmluZ10gJExvY2FsOlN0ck1lc3NhZ2UgPSAnWW91ciBjb21wdXRlciBhcmUgYXdhaXRpbmcgYSByZXN0YXJ0OicKICAgICAgICAkTG9jYWw6U3RyTWVzc2FnZSArPSAnezB9IFlvdXIgb3JnYW5pemF0aW9uIHJlcXVpcmVzIHlvdXIgaGFyZCcgLWYgImByYG4iCiAgICAgICAgJExvY2FsOlN0ck1lc3NhZ2UgKz0gJ3swfSBkcml2ZSB0byBiZSBlbmN5cHRlZC4gSW4gb3JkZXIgdG8nIC1mICJgcmBuIgogICAgICAgICRMb2NhbDpTdHJNZXNzYWdlICs9ICd7MH0gZmluaXNoIHRoaXMgcHJvY2VzcywgeW91IG5lZWQgdG8nIC1mICJgcmBuIgogICAgICAgICRMb2NhbDpTdHJNZXNzYWdlICs9ICd7MH0gcmVzdGFydCB5b3VyIGNvbXB1dGVyLiBZb3UgY2FuJyAtZiAiYHJgbiIKICAgICAgICAkTG9jYWw6U3RyTWVzc2FnZSArPSAnezB9IGVpdGhlciBkbyBpdCBtYW51YWxseSwgb3IgaXQgd2lsbCcgLWYgImByYG4iCiAgICAgICAgJExvY2FsOlN0ck1lc3NhZ2UgKz0gJ3swfSBhdXRvbWF0aWNhbGx5IGhhcHBlbiBpbicgLWYgImByYG4iCiAgICAgICAgJExvY2FsOlN0ck1lc3NhZ2UgKz0gJ3swfSB7MX0gbWludXRlcy4nIC1mICJgcmBuIiwkTG9jYWw6VGltZVRvUmVib290SW5NaW51dGVzCiAgICAgICAgJExvY2FsOlN0ck1lc3NhZ2UgKz0gJ3swfXswfSBTQVZFIFlPVVIgV09SSyEnIC1mICJgcmBuIgogICAgICAgICM+CiAgICB9CiAgICAjZW5kcmVnaW9uIFByb21wdC1SZWJvb3QgICAgCiNlbmRyZWdpb24gRnVuY3Rpb25zCgoKCiNyZWdpb24gSW5pdGlhbGl6ZQogICAgTG9nV3JpdGUgKCcjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMnKQogICAgTG9nV3JpdGUgKCdTdGFydGluZyBUcmlnZ2VyIEJpdExvY2tlciBzY3JpcHQuJykKICAgIExvZ1dyaXRlICgnIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjJykKICAgIExvZ1dyaXRlICgnIyMjIEdldCBzdGF0cy4nKQogICAgIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwogICAgIyMgRmV0Y2ggcHJldiBydW4gcmVzdWx0cyAjIwogICAgIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyAgICAKICAgIGlmICgtbm90KFRlc3QtUGF0aCAtUGF0aCAkU2NyaXB0OkZpbGVTdGF0cykpIHsKICAgICAgICAkU2NyaXB0OkNvdW50UnVucyA9IFt1aW50MTZdJCgwKQogICAgICAgICRTY3JpcHQ6SXNGaW5pc2hlZDFzdFRpbWUgPSAkU2NyaXB0OklzRW5jcnlwdGVkID0gJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdyA9ICRTY3JpcHQ6SXNCYWNrdXBPRCA9ICRTY3JpcHQ6SXNCYWNrdXBBQUQgPSBbYm9vbF0kKCRmYWxzZSkKICAgICAgICAkU2NyaXB0Ok9TRHJpdmVLZXlJRCA9ICRTY3JpcHQ6T1NEcml2ZVByb3RlY3Rpb25QYXNzd29yZCA9IFtzdHJpbmddOjpFbXB0eQogICAgICAgIExvZ1dyaXRlICgnIyBGaXJzdCBydW4hJykKICAgIH0KICAgIGVsc2UgewogICAgICAgICRJbnB1dFN0cmluZyA9IFtzdHJpbmdbXV0kKEdldC1Db250ZW50IC1QYXRoICRTY3JpcHQ6RmlsZVN0YXRzKS5TcGxpdChbRW52aXJvbm1lbnRdOjpOZXdMaW5lKQogICAgICAgICRTY3JpcHQ6Q291bnRSdW5zID0gW3VpbnQxNl0kKCRJbnB1dFN0cmluZ1swXSkKICAgICAgICAkU2NyaXB0OklzRmluaXNoZWQxc3RUaW1lID0gW3VpbnQxNl0kKCRJbnB1dFN0cmluZ1sxXSkKICAgICAgICAkU2NyaXB0OklzRW5jcnlwdGVkID0gW3VpbnQxNl0kKCRJbnB1dFN0cmluZ1syXSkKICAgICAgICAkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3ID0gW3VpbnQxNl0kKCRJbnB1dFN0cmluZ1szXSkKICAgICAgICAkU2NyaXB0OklzQmFja3VwT0QgPSBbdWludDE2XSQoJElucHV0U3RyaW5nWzRdKQogICAgICAgICRTY3JpcHQ6SXNCYWNrdXBBQUQgPSBbdWludDE2XSQoJElucHV0U3RyaW5nWzVdKQogICAgICAgICRTY3JpcHQ6T1NEcml2ZUtleUlEID0gW3N0cmluZ10kKCRJbnB1dFN0cmluZ1s2XSkKICAgICAgICAkU2NyaXB0Ok9TRHJpdmVQcm90ZWN0aW9uUGFzc3dvcmQgPSBbc3RyaW5nXSQoJElucHV0U3RyaW5nWzddKQogICAgICAgIExvZ1dyaXRlICgnIyBQcmV2aW91cyBydW4gcmVzdWx0czonKQogICAgICAgIFdyaXRlLVN0YXRzIC1QcmV2aW91c09ubHkgJHRydWUKICAgIH0KICAgIAoKICAgICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKICAgICMjIyMgR2V0IGN1cnJlbnQgc3RhdHVzICMjIyMKICAgICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMgIAogICAgTG9nV3JpdGUgKCcjIEN1cnJlbnQgc3RhdHVzOicpCiAgICAgICAgCiAgICAjIEdldCBDdXJyZW50IFN0YXR1cyBmb3IgT1MgRHJpdmUKICAgIEdldC1CaXRMb2NrZXJTdGF0dXMgLURyaXZlTGV0dGVyICRTY3JpcHQ6T1NEcml2ZUxldHRlcgogICAgUmVmcmVzaC1CaXRMb2NrZXJWYXJpYWJsZXNGb3JDdXJyZW50Vm9sdW1lIC1Ecml2ZUxldHRlciAkU2NyaXB0Ok9TRHJpdmVMZXR0ZXIKICAgIAoKICAgIGlmICgkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXKSB7CiAgICAgICAgaWYgKCRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMF0pIHsKICAgICAgICAgICAgJFNjcmlwdDpJc0VuY3J5cHRlZCA9IFtib29sXSQoJFNjcmlwdDpWb2x1bWVFbmNyeXB0aW9uU3RhdHVzIC1lcSAkU2NyaXB0OkJpdExvY2tlclZvbHVtZUVuY3J5cHRpb25TdGF0dXNlc1syXSkKICAgICAgICB9CiAgICAgICAgaWYgKCRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMV0pIHsKICAgICAgICAgICAgJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdyA9IFtib29sXSQoJFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzIC1lcSAxKQogICAgICAgIH0gICAgICAgICAgICAgICAgICAgCiAgICB9CiAgICBlbHNlIHsKICAgICAgICAkU2NyaXB0OklzRW5jcnlwdGVkID0gJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdyA9IFtib29sXSQoJGZhbHNlKQogICAgfQoKCiAgICAjIE90aGVyIEZpeGVkIERyaXZlcwogICAgI1RPRE8KICAgIDwjCiAgICBbU3RyaW5nW11dICRTY3JpcHQ6Rml4ZWRWb2x1bWVzTGV0dGVycyA9IEAoKEdldC1Wb2x1bWUgfCBgCiAgICAgICAgV2hlcmUtT2JqZWN0IHskXy5Ecml2ZVR5cGUgLWVxICdGaXhlZCcgLWFuZCAoLW5vdChbc3RyaW5nXTo6SXNOdWxsT3JFbXB0eSgkXy5Ecml2ZUxldHRlcikpKX0gfCBgCiAgICAgICAgV2hlcmUtT2JqZWN0IHskXy5Ecml2ZUxldHRlciAtbmUgJE9TRHJpdmVMZXR0ZXIuUmVwbGFjZSgnOicsJycpfSkuRHJpdmVMZXR0ZXIpCiAgICAKICAgICRTY3JpcHQ6Rml4ZWRWb2x1bWVzTGV0dGVycyB8IEZvckVhY2gtT2JqZWN0IHsKICAgICAgICBpZiAoLW5vdChbc3RyaW5nXTo6SXNOdWxsT3JFbXB0eSgkXykpKSB7CiAgICAgICAgICAgIEdldC1CaXRsb2NrZXJTdGF0dXMgLURyaXZlTGV0dGVyICRfCiAgICAgICAgICAgIGlmICgoR2V0LVZhcmlhYmxlIC1OYW1lICgnezB9Q291bnRQcm90ZWN0aW9uS2V5cycgLWYgJF8pIC1TY29wZSAnU2NyaXB0JykuTGVuZ3RoIC1ndCAwKSB7CiAgICAgICAgICAgICAgICBbc3RyaW5nW11dICRTY3JpcHQ6T3RoZXJFbmNyeXB0ZWREcml2ZXMgKz0gQCgkXykKICAgICAgICAgICAgfQogICAgICAgIH0gICAgIAogICAgfSM+CgogICAgV3JpdGUtU3RhdHMKI2VuZHJlZ2lvbiBJbml0aWFsaXplCiAgICAKCgojcmVnaW9uIE1haW4KI3JlZ2lvbiBFbmNyeXB0aW9uCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwojIyMjIEJpdExvY2tlciBFbmNyeXB0aW9uICMjIyMKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCkxvZ1dyaXRlICgnIyMjIEJpdExvY2tlciBFbmNyeXB0aW9uJykKCgoKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwojIEJpdExvY2tlciBFbmNyeXB0aW9uIG9mIE9TIERyaXZlICAjCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKI3JlZ2lvbiBCaXRMb2NrZXIgRW5jcnlwdGlvbiBvZiBPUyBEcml2ZQoKTG9nV3JpdGUgKCcjIEJpdExvY2tlciBFbmNyeXB0aW9uIG9mIE9TIERyaXZlJykKaWYgKCRTY3JpcHQ6SXNFbmNyeXB0ZWQpIHsKICAgIExvZ1dyaXRlICgnT1MgRHJpdmUgaXMgYWxyZWFkeSBmdWxseSBlbmNyeXB0ZWQuJykKfQplbHNlIHsKICAgICRTY3JpcHQ6Qm9vbERpZEFueXRoaW5nQ2hhbmdlVGhpc1J1bnRpbWUgPSBbYm9vbF0kKCR0cnVlKQogICAgCiAgICAjIElmICdGdWxseUVuY3J5cHRlZCcsIGFuZCBUUE0gcHJlc2VudAogICAgIyBNZWFucyB0aGF0IE9TIERyaXZlIGlzIHN1Y2Nlc3NmdWxseSBlbmNyeXB0ZWQgd2l0aCBCaXRMb2NrZXIKICAgIGlmICgoJFNjcmlwdDpWb2x1bWVFbmNyeXB0aW9uU3RhdHVzIC1lcSAkU2NyaXB0OkJpdExvY2tlclZvbHVtZUVuY3J5cHRpb25TdGF0dXNlc1syXSkgLWFuZCAkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzBdKSB7CiAgICAgICAgTG9nV3JpdGUgKCdPUyBEcml2ZSBpcyBmdWxseSBlbmNyeXB0ZWQhJykKICAgICAgICAkU2NyaXB0OklzRW5jcnlwdGVkID0gJHRydWUKICAgIH0KICAgIAoKICAgICMgSWYgJ0VuY3J5cHRpb25JblByb2dyZXNzJyBhbmQgVFBNIHByZXNlbnQKICAgICMgTWVhbnMgY29tcHV0ZXIgaGFzIHJlc3RhcnRlZCBhZnRlciBCaXRMb2NrZXIgZW5jcnlwdGlvbiB3YXMgZW5hYmxlZC4gV2FpdGluZyBmb3IgdGhlIHZvbHVtZSB0byBnZXQgZW5jcnlwdGVkCiAgICBlbHNlaWYgKCRTY3JpcHQ6Vm9sdW1lRW5jcnlwdGlvblN0YXR1cyAtZXEgJFNjcmlwdDpCaXRMb2NrZXJWb2x1bWVFbmNyeXB0aW9uU3RhdHVzZXNbMV0gLWFuZCAkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzBdKSB7CiAgICAgICAgTG9nV3JpdGUgKCdPUyBEcml2ZSBlbmNyeXB0aW9uIGlzIGluIHByb2dyZXNzOicpCiAgICAgICAgTG9nV3JpdGUgKCdSZXN0YXJ0IGhhdmUgdGFrZW4gcGxhY2UsIGFuZCBlbmNyeXB0aW9uIGhhcyBzdGFydGVkLicpCiAgICAgICAgTG9nV3JpdGUgKCdPUyBEcml2ZSBFbmNyeXB0aW9uIFBlcmNlbnRhZ2U6IHswfSUuJyAtZiAoJFNjcmlwdDpWb2x1bWVFbmNyeXB0aW9uUGVyY2VudGFnZSkpCiAgICAgICAgTG9nV3JpdGUgKCdDYW4gY29udGludWUgdG8gY2hlY2sgaWYgUmVjb3ZlcnkgUGFzc3dvcmQgaXMgcHJlc2VudCwgYW5kIGJhY2t1cCBpdC4nKQogICAgfQoKCiAgICAjIElmICdGdWxseURyZWN0eXB0ZWQnICAgICAKICAgIGVsc2VpZiAoJFNjcmlwdDpWb2x1bWVFbmNyeXB0aW9uU3RhdHVzIC1lcSAkU2NyaXB0OkJpdExvY2tlclZvbHVtZUVuY3J5cHRpb25TdGF0dXNlc1swXSkgewogICAgICAgIAogICAgICAgICMgSWYgJ0Z1bGx5RHJlY3R5cHRlZCcgYnV0IHRoZXJlIGV4aXN0cyBhIFRQTQogICAgICAgICMgTWVhbnMgdGhhdCBlbmNyeXB0aW9uIGhhcyBzdGFydGVkLCBidXQgY29tcHV0ZXIgaXMgYXdhaXRpbmcgcmVzdGFydAogICAgICAgIGlmICgkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXIC1hbmQgJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1swXSkgewogICAgICAgICAgICBMb2dXcml0ZSAoJ09TIERyaXZlIEVuY3J5cHRpb24gaGFzIHN0YXJ0ZWQsIGJ1dCBjb21wdXRlciBoYXMgbm90IGJlZW4gcmVzdGFydGVkIHlldC4nKQogICAgICAgICAgICBMb2dXcml0ZSAoJ09TIERyaXZlIEVuY3J5cHRpb24gUGVyY2VudGFnZTogezB9JS4nIC1mICgkU2NyaXB0OlZvbHVtZUVuY3J5cHRpb25QZXJjZW50YWdlKSkKICAgICAgICAgICAgTG9nV3JpdGUgKCdDYW4gY29udGludWUgdG8gY2hlY2sgaWYgUmVjb3ZlcnkgUGFzc3dvcmQgaXMgcHJlc2VudCwgYW5kIGJhY2t1cCBpdC4nKQogICAgICAgIH0KICAgICAgICAKICAgICAgICBlbHNlIHsKICAgICAgICAgICAgTG9nV3JpdGUgKCdPUyBEcml2ZSBpcyBub3QgZW5jcnlwdGVkLicpCiAgICAgICAgICAgIExvZ1dyaXRlICgnQXR0ZW1wdGluZyB0byBFbmFibGUgQml0TG9ja2VyIG9uIE9TIGRyaXZlICh7MH0pJyAtZiAoJE9TRHJpdmUpKQogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgIyBFbmFibGUgQml0TG9ja2VyIHVzaW5nIFRQTQogICAgICAgICAgICAgICAgJG51bGwgPSBFbmFibGUtQml0TG9ja2VyIC1Nb3VudFBvaW50ICRPU0RyaXZlTGV0dGVyIC1UcG1Qcm90ZWN0b3IgLVVzZWRTcGFjZU9ubHk6JGZhbHNlIC1IYXJkd2FyZUVuY3J5cHRpb246JGZhbHNlIC1FcnJvckFjdGlvbiAnQ29udGludWUnCiAgICAgICAgICAgICAgICBpZiAoJD8pIHsKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1N1Y2Nlc3NmdWxseSBlbmFibGVkIGJpdGxvY2tlci4nKSAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnRmFpbGVkIEVuYWJsaW5nIEJpdGxvY2tlciBUcG1Qcm90ZWN0b3IsIGl0YHMgcHJvYmFibHkgYWxyZWFkeSBlbmFibGVkJykKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSAKICAgICAgICAgICAgY2F0Y2ggewogICAgICAgICAgICAgICAgTG9nRXJyb3JzCiAgICAgICAgICAgICAgICBFbmFibGUtQml0TG9ja2VyIC1Nb3VudFBvaW50ICRPU0RyaXZlTGV0dGVyIC1UcG1Qcm90ZWN0b3IgLVVzZWRTcGFjZU9ubHk6JGZhbHNlIC1IYXJkd2FyZUVuY3J5cHRpb246JGZhbHNlIC1FcnJvckFjdGlvbiAnU2lsZW50bHlDb250aW51ZScKICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnV2lsbCBhdHRlbXB0IHRvIEVuYWJsZSBCaXRMb2NrZXIgYW55d2F5IGFuZCB0aGVuIGNvbnRpbnVlLiBTdWNjZXNzPyB7MH0nIC1mICgkPykpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmluYWxseSB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0RpZCB3ZSBhY3R1YWxseSBlbmFibGUgQml0TG9ja2VyPycpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUmVmcmVzaCBWYXJpYWJsZXMKICAgICAgICAgICAgICAgIEdldC1CaXRMb2NrZXJTdGF0dXMgLURyaXZlTGV0dGVyICRPU0RyaXZlTGV0dGVyCiAgICAgICAgICAgICAgICBSZWZyZXNoLUJpdExvY2tlclZhcmlhYmxlc0ZvckN1cnJlbnRWb2x1bWUgLURyaXZlTGV0dGVyICRPU0RyaXZlTGV0dGVyCgogICAgICAgICAgICAgICAgIyBDaGVjayByZXN1bHQKICAgICAgICAgICAgICAgIGlmICgkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXIC1hbmQgJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1swXSkgewogICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnVFBNIHByZXNlbnQgZm9yIE9TIERyaXZlPyB7MH0nIC1mICgkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzBdKSkKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1Byb21wdGluZyByZWJvb3QuJykKICAgICAgICAgICAgICAgICAgICBQcm9tcHQtUmVib290CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0VSUk9SLCBub3QgZW5jcnlwdGVkLiBUUE0gbm90IHByZXNlbnQgZm9yIE9TIERyaXZlJykKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgICMgSWYgc2NlbmFyaW8gZml0cyBub25lIG9mIHRoZSBjYXNlcyBhYm92ZS4uCiAgICBlbHNlIHsKICAgICAgICBMb2dXcml0ZSAoJ05laXRoZXIgInswfSIsICJ7MX0iIG9yICJ7Mn0iLicgLWYgKCRTY3JpcHQ6Qml0TG9ja2VyVm9sdW1lRW5jcnlwdGlvblN0YXR1c2VzWzBdLCRTY3JpcHQ6Qml0TG9ja2VyVm9sdW1lRW5jcnlwdGlvblN0YXR1c2VzWzFdLCRTY3JpcHQ6Qml0TG9ja2VyVm9sdW1lRW5jcnlwdGlvblN0YXR1c2VzWzJdKSkKICAgIH0KfQojZW5kcmVnaW9uIEJpdExvY2tlciBFbmNyeXB0aW9uIG9mIE9TIERyaXZlCgoKCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKIyBQcm90ZWN0aW9uIFBhc3N3b3JkIGZvciBPUyBEcml2ZSAgIwojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiNyZWdpb24gUHJvdGVjdGlvbiBQYXNzd29yZCBmb3IgT1MgRHJpdmUKCkxvZ1dyaXRlICgnIyBCaXRMb2NrZXIgUHJvdGVjdGlvbiBQYXNzd29yZCBmb3IgT1MgRHJpdmUnKQojIElmICdGdWxseUVuY3J5cHRlZCcsIG9yIFRNUCBpcyBwcmVzZW50CmlmICgkU2NyaXB0OklzRW5jcnlwdGVkIC1vciAoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQVyAtYW5kICRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMF0pKSB7CiAgICAKICAgIAogICAgIyBJZiB3ZSdyZSBkb25lIHdpdGggcmVjb3ZlcnkgcGFzc3dvcmQocykgYWxyZWFkeQogICAgaWYgKCRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cgLWFuZCAoJFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzIC1lcSAxKSkgewogICAgICAgIExvZ1dyaXRlICdSZWNvdmVyeSBQYXNzd29yZCBmb3IgT1MgRHJpdmUgaXMgYWxyZWFkeSBwcmVzZW50JwogICAgfQogICAgCgogICAgIyBJZiB3ZSdyZSBub3QgZG9uZSB3aXRoIHJlY292ZXJ5IHBhc3N3b3JkKHMpCiAgICBlbHNlIHsgICAgICAgIAogICAgICAgICRTY3JpcHQ6Qm9vbERpZEFueXRoaW5nQ2hhbmdlVGhpc1J1bnRpbWUgPSBbYm9vbF0kKCR0cnVlKQogICAgICAgICRMb2NhbDpTdWNjZXNzID0gW2Jvb2xdJCgkZmFsc2UpCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgIyBJZiB0aGVyZSBleGlzdHMgQml0TG9ja2VyIEVuY3J5cHRpb24gUmVjb3ZlcnkgUGFzc3dvcmQgICAgICAgCiAgICAgICAgaWYgKCRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMV0pIHsKICAgICAgICAgICAgCgogICAgICAgICAgICAjIElmIHRoZXJlcyBpcyBfYV8gUHJvdGVjdGlvblBhc3N3b3JkLCB3ZSdyZSBkb25lCiAgICAgICAgICAgIGlmICgkU2NyaXB0OkNvdW50UmVjb3ZlcnlQYXNzd29yZHMgLWVxIDEpIHsKICAgICAgICAgICAgICAgIExvZ1dyaXRlICdPbmx5IGEgcGFzc3dvcmQgcHJlc2VudCcKICAgICAgICAgICAgICAgICRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cgPSAkdHJ1ZQogICAgICAgICAgICAgICAgJExvY2FsOlN1Y2Nlc3MgPSAkdHJ1ZQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgIyBJZiB0aGVyZSBpcyBtdWx0aXBsZSBSZWNvdmVyeVBhc3N3b3Jkcywgd2UgbmVlZCB0byByZW1vdmUgYWxsIGJ1dCBvbmUKICAgICAgICAgICAgZWxzZWlmICgkU2NyaXB0OkNvdW50UmVjb3ZlcnlQYXNzd29yZHMgLWd0IDEpIHsKICAgICAgICAgICAgICAgIExvZ1dyaXRlICdNdWx0aXBsZSBwYXNzd29yZHMgcHJlc2VudCcKICAgICAgICAgICAgICAgIFdyaXRlLVJlY292ZXJ5UGFzc3dvcmQKICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnV2lsbCByZW1vdmUgYWxsIGJ1dCB0aGUgZmlyc3Qgb25lJykKICAgICAgICAgICAgICAgICRTY3JpcHQ6QXJyYXlSZWNvdmVyeVBhc3N3b3JkcyB8IEZvckVhY2gtT2JqZWN0IHsgCiAgICAgICAgICAgICAgICAgICAgaWYgKCRfLidLZXlQcm90ZWN0b3JJZCcgLW5lICRTY3JpcHQ6QXJyYXlSZWNvdmVyeVBhc3N3b3Jkc1swXS4nS2V5UHJvdGVjdG9ySWQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRudWxsID0gUmVtb3ZlLUJpdExvY2tlcktleVByb3RlY3RvciAtTW91bnRQb2ludCAkT1NEcml2ZUxldHRlciAtS2V5UHJvdGVjdG9ySWQgJF8uJ0tleVByb3RlY3RvcklkJwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJD8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnU3VjY2Vzc2Z1bGx5IHJlbW92ZWQgfCBLZXlQcm90ZWN0b3JJZCAiezB9IiB8IFJlY292ZXJ5UGFzc3dvcmQgInsxfSInIC1mICgkXy4nS2V5UHJvdGVjdG9ySWQnLCRfLidSZWNvdmVyeVBhc3N3b3JkJykpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnU3VjY2Vzc2Z1bGx5IHNraXBwZWQgdGhlIGZpcnN0IGtleS4gfCBLZXlQcm90ZWN0b3JJZCAiezB9IiB8IFJlY292ZXJ5UGFzc3dvcmQgInsxfSInIC1mICgkXy4nS2V5UHJvdGVjdG9ySWQnLCRfLidSZWNvdmVyeVBhc3N3b3JkJykpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIEdldC1CaXRMb2NrZXJTdGF0dXMKICAgICAgICAgICAgICAgIGlmICgkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXIC1hbmQgJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1sxXSAtYW5kICgkU2NyaXB0OkNvdW50UmVjb3ZlcnlQYXNzd29yZHMgLWVxIDEpKSB7CiAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN1Y2Nlc3MgPSAkdHJ1ZQogICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAjIFRoaXMgc2hvdWxkIG5vdCBiZSBwb3NzaWJsZQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIExvZ1dyaXRlICdFUlJPUjogUmVjb3ZlcnlQYXNzd29yZCBwcmVzZW50LCBidXQgY291bnQgPCAxJwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAKICAgICAgICAjcmVnaW9uIEFkZCBQcm90ZWN0aW9uIFBhc3N3b3JkIElmIE5vbmUgUHJlc2VudAogICAgICAgIGVsc2UgewogICAgICAgICAgICBMb2dXcml0ZSAoJ05vIEJpdExvY2tlciBSZWNvdmVyeSBQYXNzd29yZHMgZm91bmQgZm9yIE9TIERyaXZlIHswfSwgY3JlYXRpbmcgb25lLicgLWYgKCRPU0RyaXZlTGV0dGVyKSkKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICRudWxsID0gQWRkLUJpdExvY2tlcktleVByb3RlY3RvciAtTW91bnRQb2ludCAkT1NEcml2ZUxldHRlciAtUmVjb3ZlcnlQYXNzd29yZFByb3RlY3RvciAtRXJyb3JBY3Rpb24gJ1NpbGVudGx5Q29udGludWUnIC1XYXJuaW5nQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJwogICAgICAgICAgICAgICAgaWYgKCQ/KSB7CiAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN1Y2Nlc3MgPSAkdHJ1ZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJG51bGwgPSBFbmFibGUtQml0TG9ja2VyIC1Nb3VudFBvaW50ICRPU0RyaXZlTGV0dGVyIC1SZWNvdmVyeVBhc3N3b3JkUHJvdGVjdG9yIC1FcnJvckFjdGlvbiAnU3RvcCcKICAgICAgICAgICAgICAgICAgICBpZiAoJD8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN1Y2Nlc3MgPSAkdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgIH0gCiAgICAgICAgICAgIGNhdGNoIHsKICAgICAgICAgICAgICAgIExvZ0Vycm9ycwogICAgICAgICAgICAgICAgJG51bGwgPSBBZGQtQml0TG9ja2VyS2V5UHJvdGVjdG9yIC1Nb3VudFBvaW50ICRPU0RyaXZlTGV0dGVyIC1SZWNvdmVyeVBhc3N3b3JkUHJvdGVjdG9yIC1FcnJvckFjdGlvbiAnU2lsZW50bHlDb250aW51ZScgLVdhcm5pbmdBY3Rpb24gJ1NpbGVudGx5Q29udGludWUnCiAgICAgICAgICAgICAgICBpZiAoJExhc3RFeGl0Q29kZSAtZXEgMCkgewogICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdWNjZXNzID0gJHRydWUKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICRudWxsID0gRW5hYmxlLUJpdExvY2tlciAtTW91bnRQb2ludCAkT1NEcml2ZUxldHRlciAtUmVjb3ZlcnlQYXNzd29yZFByb3RlY3RvciAtRXJyb3JBY3Rpb24gJ1NpbGVudGx5Q29udGludWUnCiAgICAgICAgICAgICAgICAgICAgaWYgKCQ/KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdWNjZXNzID0gJHRydWUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmluYWxseSB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1RyaWVkIHRvIGFkZCBCaXRMb2NrZXIgUmVjb3ZlcnlQYXNzd29yZFByb3RlY3Rvci4gU3VjY2Vzcz8gezB9LicgLWYgKCRMb2NhbDpTdWNjZXNzKSkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBBZGQgUHJvdGVjdGlvbiBQYXNzd29yZCBJZiBOb25lIFByZXNlbnQKCiAgICAgICAgCgogICAgICAgICMgQ291bnQgYW5kIGxpc3QgZXhpc3RpbmcgUmVjb3ZlcnlQYXNzd29yZCwgb25seSB3cml0ZSBzdWNjZXNzIGlmIHRoZXJlcyBvbmUgICAgICAgIAogICAgICAgIGlmICgkTG9jYWw6U3VjY2VzcykgewogICAgICAgICAgICBMb2dXcml0ZSAnQ2hlY2tpbmcgaWYgdGhlcmUgaXMgb25seSBvbmUgUHJvdGVjdGlvbiBQYXNzd29yZC4nCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlZnJlc2ggVmFyaWFibGVzIGZvciBjdXJyZW50IHZvbHVtZQogICAgICAgICAgICBHZXQtQml0TG9ja2VyU3RhdHVzIC1Ecml2ZUxldHRlciAkT1NEcml2ZUxldHRlcgogICAgICAgICAgICBSZWZyZXNoLUJpdExvY2tlclZhcmlhYmxlc0ZvckN1cnJlbnRWb2x1bWUgLURyaXZlTGV0dGVyICRPU0RyaXZlTGV0dGVyCgogICAgICAgICAgICAjIENoZWNrIHJlc3VsdHMKICAgICAgICAgICAgJExvY2FsOkJvb2xUZW1wID0gW2Jvb2xdJChpZigkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXKXsoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1sxXSl9ZWxzZXskZmFsc2V9KQogICAgICAgICAgICBMb2dXcml0ZSAoJ1Byb3RlY3Rpb24gUGFzc3dvcmQgUHJlc2VudD8gezB9JyAtZiAoJExvY2FsOkJvb2xUZW1wKSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCRMb2NhbDpCb29sVGVtcCkgeyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoJFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzIC1lcSAxKSB7ICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnU1VDQ0VTUywga2V5cyBsZWZ0OiAxLicpCiAgICAgICAgICAgICAgICAgICAgJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdyA9ICR0cnVlCiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAnRkFJTCwga2V5cyBsZWZ0OiB7MH0uJyAtZiAoJFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzKQogICAgICAgICAgICAgICAgICAgICRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cgPSAkZmFsc2UKICAgICAgICAgICAgICAgIH0gIAogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdGQUlMLCBubyBQcm90ZWN0aW9uIFBhc3N3b3JkIGZvdW5kJykKICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIExvZ1dyaXRlICgnU29tZXRoaW5nIGZhaWxlZCcpCiAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgCiAgICB9CiAgICAjZW5kcmVnaW9uIElmIHRoZXJlcyAwIG9yIG11bHRpcGxlIFByb3RlY3Rpb25zUGFzc3dvcmQocykgCn0KCgojIE5vdCBlbmNyeXB0ZWQgPSBObyBtYWtpbmcgb2YgUmVjb3ZlcnlQYXNzd29yZAplbHNlIHsKICAgIExvZ1dyaXRlICgnT1MgRHJpdmUgaXMgIkZ1bGx5RGVjcnlwdGVkIiBhbmQgdGhlcmUgZXhpc3RzIG5vICJUUE0iLicpCiAgICBMb2dXcml0ZSAoJ0JpdExvY2tlciBSZWNvdmVyeVBhc3N3b3JkIGNhbiBub3QgYmUgYWRkZWQgYXQgdGhpcyB0aW1lLicpCiAgICBMb2dXcml0ZSAoJ1JlY292ZXJ5IFBhc3N3b3JkIHByZXNlbnQ/IHswfScgLWYgKFtzdHJpbmddJChpZigkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXKXskU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzBdfWVsc2V7JGZhbHNlfSkpKQogICAgJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdyA9ICRmYWxzZQp9CgojIFdyaXRlIHJlY292ZXJ5IHBhc3N3b3JkKHMpIGlmIGFueXRoaW5nIGNoYW5nZWQgdGhpcyBydW50aW1lCmlmICgkU2NyaXB0OkJvb2xEaWRBbnl0aGluZ0NoYW5nZVRoaXNSdW50aW1lIC1hbmQgJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1sxXSkgewogICAgV3JpdGUtUmVjb3ZlcnlQYXNzd29yZAp9CiNlbmRyZWdpb24gUHJvdGVjdGlvbiBQYXNzd29yZCBmb3IgT1MgRHJpdmUKI2VuZHJlZ2lvbiBFbmNyeXB0aW9uCgoKCiMjIyMjIyMjIyMjIyMjIyMjIyMjCiMjIyMjIyBCQUNLVVAgIyMjIyMjCiMjIyMjIyMjIyMjIyMjIyMjIyMjCiNyZWdpb24gQmFja3VwCgoKTG9nV3JpdGUgKCcjIyMgQmFja3VwIFByb3RlY3Rpb24gUGFzc3dvcmQgdG8gQXp1cmVBQUQgYW5kIE9uZURyaXZlNEInKQoKIyBDaGVjayBmb3IgY2hhbmdlcyBpZiBGaW5pc2hlZDFzdFRpbWUKaWYgKCRTY3JpcHQ6SXNGaW5pc2hlZDFzdFRpbWUgLW9yICRTY3JpcHQ6SXNCYWNrdXBBQUQgLWFuZCBbYm9vbF0kKFtib29sXSQoJFNjcmlwdDpCb29sQmFja3VwVG9PbmVEcml2ZUZvckJ1c2luZXNzIC1hbmQgJFNjcmlwdDpJc0JhY2t1cE9EKSAtb3IgW2Jvb2xdJCgtbm90KCRTY3JpcHQ6Qm9vbEJhY2t1cFRvT25lRHJpdmVGb3JCdXNpbmVzcykpKSkgewogICAgTG9nV3JpdGUgKCdEcml2ZSBpcyBhbHJlYWR5IGJhY2tlZCB1cC4nKQogICAgTG9nV3JpdGUgKCdXaWxsIGNoZWNrIGlmIGFueXRoaW5nIGhhcyBjaGFuZ2VkLicpCgogICAgaWYgKENoZWNrLUlmQml0TG9ja2VyUFdIYXNDaGFuZ2VkKSB7CiAgICAgICAgTG9nV3JpdGUgJ1NvbWV0aGluZyBoYXMgY2hhbmdlZCwgQml0TG9ja2VyIFJlY292ZXJ5IFByb3RlY3Rpb24gUGFzc3dvcmQgaXMgbm90IHRoZSBzYW1lIGFzIHRoZSBvbmUgYmFja2VkIHVwLicKICAgICAgICAkU2NyaXB0OklzQmFja3VwQUFEID0gJFNjcmlwdDpJc0JhY2t1cE9EID0gJGZhbHNlCiAgICAgICAgJFNjcmlwdDpCb29sRGlkQW55dGhpbmdDaGFuZ2VUaGlzUnVudGltZSA9ICR0cnVlCiAgICB9CiAgICBlbHNlIHsKICAgICAgICBMb2dXcml0ZSAnTm90aGluZyBoYXMgY2hhbmdlZCwgQml0TG9ja2VyIFJlY292ZXJ5IFByb3RlY3Rpb24gUGFzc3dvcmQgaXMgdGhlIHNhbWUgYXMgdGhlIG9uZSBwcmV2aW91c2x5IGJhY2tlZCB1cC4nCiAgICB9Cn0KCgojIElmIG5vIGJhY2t1cHMKaWYgKC1ub3QoJFNjcmlwdDpJc0JhY2t1cEFBRCAtYW5kIFtib29sXSQoW2Jvb2xdJCgkU2NyaXB0OkJvb2xCYWNrdXBUb09uZURyaXZlRm9yQnVzaW5lc3MgLWFuZCAkU2NyaXB0OklzQmFja3VwT0QpIC1vciBbYm9vbF0kKC1ub3QoJFNjcmlwdDpCb29sQmFja3VwVG9PbmVEcml2ZUZvckJ1c2luZXNzKSkpKSkgewogICAgIyBJZiBQcm90ZWN0aW9uUGFzc3dvcmQocykgZXhpc3QKICAgIGlmICgkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3KSB7CiAgICAgICAgICAgIAogICAgICAgIExvZ1dyaXRlICgnT1MgRHJpdmUgaXMgZW5jcnlwdGVkLCBhbmQgdGhlcmUgYXJlIHswfSBQcm90ZWN0aW9uUGFzc3dvcmQocykgcHJlc2VudC4nIC1mICgkU2NyaXB0OkFycmF5UmVjb3ZlcnlQYXNzd29yZHMuJ0NvdW50JykpCiAgICAgICAgTG9nV3JpdGUgKCdXcml0aW5nIGV4aXN0aW5nIFJlY292ZXJ5UGFzc3dvcmQgZm9yIGN1cnJlbnQgZHJpdmUsIGZvciBmdXR1cmUgcmVmZXJlbmNlLi4uJykKICAgICAgICAkbnVsbCA9IENoZWNrLUlmQml0TG9ja2VyUFdIYXNDaGFuZ2VkCiAgICAgICAgCiAgICAgICAgTG9nV3JpdGUgKCdDb250aW51aW5nIHdpdGggYmFja3VwLicpCgogICAgCiAgICAgICAgIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiAgICAgICAgIyBPbmVEcml2ZSBmb3IgQnVzaW5lc3MgYmFja3VwCiAgICAgICAgIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiAgICAgICAgI3JlZ2lvbiBCYWNrdXAgT25lRHJpdmUgZm9yIEJ1c2luZXNzCiAgICAKICAgICAgICBMb2dXcml0ZSAoJyMgQmFja3VwIHRvIE9uZURyaXZlJykKICAgICAgICBpZiAoLW5vdCRTY3JpcHQ6Qm9vbEJhY2t1cFRvT25lRHJpdmVGb3JCdXNpbmVzcykgewogICAgICAgICAgICBMb2dXcml0ZSAoJ0Rpc2FibGVkIGluIHNjcmlwdCBzZXR0aW5ncy4nKQogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgTG9nV3JpdGUgKCdFbmFibGVkIGluIHNjcmlwdCBzZXR0aW5ncy4nKQogICAgICAgICAgICBpZiAoJFNjcmlwdDpJc0JhY2t1cE9EKSB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0FscmVhZHkgZG9uZScpCiAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgJFNjcmlwdDpCb29sRGlkQW55dGhpbmdDaGFuZ2VUaGlzUnVudGltZSA9ICR0cnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgVHJ5IHsKICAgICAgICAgICAgICAgICAgICAjIEdldCBDdXJyZW50IFVzZXIgYXMgU2VjdXJpdHlJZGVudGlmaWVyCiAgICAgICAgICAgICAgICAgICAgaWYgKC1ub3QoJFNjcmlwdDpQYXRoRGlyUm9vdENVKSl7CiAgICAgICAgICAgICAgICAgICAgICAgICRTY3JpcHQ6UGF0aERpclJvb3RDVSA9IFtzdHJpbmddJCgnUmVnaXN0cnk6OkhLRVlfVVNFUlNcezB9XCcgLWYgKFtTeXN0ZW0uU2VjdXJpdHkuUHJpbmNpcGFsLk5UQWNjb3VudF06Om5ldygoR2V0LVByb2Nlc3MgLU5hbWUgJ2V4cGxvcmVyJyAtSW5jbHVkZVVzZXJOYW1lIHwgU2VsZWN0LU9iamVjdCAtRXhwYW5kUHJvcGVydHkgJ1VzZXJOYW1lJyAtRmlyc3QgMSkpLlRyYW5zbGF0ZShbU3lzdGVtLlNlY3VyaXR5LlByaW5jaXBhbC5TZWN1cml0eUlkZW50aWZpZXJdKS4nVmFsdWUnKSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYoKC1ub3QoJD8pKSAtb3IgW3N0cmluZ106OklzTnVsbE9yRW1wdHkoJFBhdGhEaXJSb290Q1UpKXtCcmVha30KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgR2V0IE9uZURyaXZlIGZvciBCdXNpbmVzcyBwYXRoIGZyb20gcmVnaXN0cnkgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICRSZWdWYWx1ZXMgPSBbYXJyYXldJChHZXQtQ2hpbGRJdGVtIC1QYXRoICgnezB9XFNPRlRXQVJFXE1pY3Jvc29mdFxPbmVEcml2ZVxBY2NvdW50c1wnIC1mICgkUGF0aERpclJvb3RDVSkpIHwgV2hlcmUtT2JqZWN0IC1Qcm9wZXJ0eSAnTmFtZScgLWxpa2UgJypcQnVzaW5lc3MqJykKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEV4aXQgVHJ5L0NhdGNoIGlmIG5vIGFjY291bnRzIHdoZXJlIGZvdW5kCiAgICAgICAgICAgICAgICAgICAgaWYgKCRSZWdWYWx1ZXMuJ0NvdW50JyAtbGUgMCkgeyAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAkU2NyaXB0OklzQmFja3VwT0QgPSAkZmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgVGhyb3cgKCdGYWlsZWQgdG8gZmluZCBPbmVEcml2ZSBmb3IgQnVzaW5lc3MgYWNjb3VudHMuJykKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICMgRm9yIGVhY2ggZm91bmQgT25lRHJpdmUgZm9yIEJ1c2luZXNzIGFjY291bnQKICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkUmVnVmFsdWUgaW4gJFJlZ1ZhbHVlcykgeyAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6UGF0aERpck9ENEIgPSBbc3RyaW5nXSQoR2V0LUl0ZW1Qcm9wZXJ0eSAtUGF0aCAkUmVnVmFsdWUuJ05hbWUnLlJlcGxhY2UoJ0hLRVlfVVNFUlNcJywnUmVnaXN0cnk6OkhLRVlfVVNFUlNcJykgLU5hbWUgJ1VzZXJGb2xkZXInKS4nVXNlckZvbGRlcicKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgRXhpdCBUcnkvQ2F0Y2ggaWYgZmFpbGVkIHRvIGJ1aWxkIHBhdGggZm9yIE9uZURyaXZlIGZvciBCdXNpbmVzcyBmb2xkZXIgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJExvY2FsOlBhdGhEaXJPRDRCIC1ub3RsaWtlICgnezB9XFVzZXJzXCpcT25lRHJpdmUgLSonIC1mICgkT1NEcml2ZSkpIC1hbmQgKC1ub3RbYm9vbF0kKFRlc3QtUGF0aCAtUGF0aCAkTG9jYWw6UGF0aERpck9ENEIpKSkgeyAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRTY3JpcHQ6SXNCYWNrdXBPRCA9ICRmYWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhyb3cgKCdGYWlsZWQgdG8gYnVpbGQgT25lRHJpdmUgcGF0aCAoInswfSIpLCBvciBpdCBkb2VzIG5vdCBleGlzdC4nIC1mICgkTG9jYWw6UGF0aCkpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBDcmVhdGUgc2NyaXB0IHZhcmlhYmxlcyBpZiB0aGV5IGRvIG5vdCBleGlzdCBhbHJlYWR5CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgtbm90KCRTY3JpcHQ6Q29tcHV0ZXJQcm9kdWN0TmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIENyZWF0ZS1FbnZWYXJpYWJsZXMKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgUnVudGltZSB2YXJpYWJsZQogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6Qm9vbEZvbGRlckV4aXN0cyA9IFtib29sXSQoJGZhbHNlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCgogICAgICAgICAgICAgICAgICAgICAgICAjIENyZWF0aW5nIHBhdGhzCiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpQYXRoRGlyT0Q0QkJhY2t1cFBhcmVudCA9IFtzdHJpbmddJCgnezB9XEJpdExvY2tlciBSZWNvdmVyeVwnIC1mICgkTG9jYWw6UGF0aERpck9ENEIpKQogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6UGF0aERpck9ENEJCYWNrdXAgPSBbc3RyaW5nXSQoJ3swfXsxfSAoezJ9IHszfSlcJyAtZiAoJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwUGFyZW50LCRTY3JpcHQ6Q29tcHV0ZXJOYW1lLCRTY3JpcHQ6Q29tcHV0ZXJNYW51ZmFjdHVyZXIsJFNjcmlwdDpDb21wdXRlclByb2R1Y3ROYW1lKSkKICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdPbmVEcml2ZSBmb3IgQnVzaW5lc3MgUGF0aDogezB9JyAtZiAoJExvY2FsOlBhdGhEaXJPRDRCKSkKICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdCYWNrdXAgUGF0aCBQYXJlbnQ6ICAgICAgICAgezB9JyAtZiAoJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwUGFyZW50KSkKICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdCYWNrdXAgUGF0aCBmb3IgQml0bG9ja2VyIFJlY292ZXJ5IEtleShzKTogezB9JyAtZiAoJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwKSkgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKCiAgICAgICAgICAgICAgICAgICAgICAgICNUZXN0aW5nIGlmIFJlY292ZXJ5IGZvbGRlciBleGlzdHMgaWYgbm90IGNyZWF0ZSBvbmUKICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdUZXN0aW5nIGlmIGJhY2t1cCBmb2xkZXIgZXhpc3RzLCBjcmVhdGUgaXQgaWYgbm90LicpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChUZXN0LVBhdGggLVBhdGggJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwIC1FcnJvckFjdGlvbiAnU2lsZW50bHlDb250aW51ZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpCb29sRm9sZGVyRXhpc3RzID0gJHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICdDcmVhdGluZyBPbmVEcml2ZSBmb3IgQnVzaW5lc3MgZm9sZGVyIGZvciBiYWNrdXAuJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJG51bGwgPSBOZXctSXRlbSAtUGF0aCAkTG9jYWw6UGF0aERpck9ENEJCYWNrdXAgLUl0ZW1UeXBlICdEaXJlY3RvcnknIC1Gb3JjZSAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpCb29sRm9sZGVyRXhpc3RzID0gVGVzdC1QYXRoIC1QYXRoICRMb2NhbDpQYXRoRGlyT0Q0QkJhY2t1cAogICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCd7MH0nIC1mICQoaWYoJExvY2FsOkJvb2xGb2xkZXJFeGlzdHMpeydTdWNjZXNzLid9ZWxzZXsnRmFpbGVkLid9KSkKICAgICAgICAgICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgCgogICAgICAgICAgICAgICAgICAgICAgICAjIEV4aXQgVHJ5L0NhdGNoIG9mIGZhaWxlZCB0byBjcmVhdGUgT25lRHJpdmUgZm9yIEJ1c2luZXNzIEJhY2t1cCBpZiBpdCBkaWRuJ3QgZXhpc3QKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKC1ub3QoJExvY2FsOkJvb2xGb2xkZXJFeGlzdHMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkU2NyaXB0OklzQmFja3VwT0QgPSAkZmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRocm93ICdGYWlsZWQgdG8gY2hlY2sgb3IgY3JlYXRlIGZvbGRlci4nCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgTWFrZSBzdXJlICdCaXRMb2NrZXIgUmVjb3ZlcnknIGZvbGRlciBpcyBoaWRkZW4KICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdNYWtpbmcgc3VyZSAiezB9IiBpcyBoaWRkZW4uJyAtZiAoJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwUGFyZW50KSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChHZXQtSXRlbSAtUGF0aCAkTG9jYWw6UGF0aERpck9ENEJCYWNrdXBQYXJlbnQgLUZvcmNlKS5BdHRyaWJ1dGVzIC1ub3RsaWtlICcqaGlkZGVuKicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChHZXQtSXRlbSAtUGF0aCAkTG9jYWw6UGF0aERpck9ENEJCYWNrdXBQYXJlbnQgLUZvcmNlKS5BdHRyaWJ1dGVzID0gKEdldC1JdGVtIC1QYXRoICRMb2NhbDpQYXRoRGlyT0Q0QkJhY2t1cFBhcmVudCAtRm9yY2UpLkF0dHJpYnV0ZXMgLWJvciAnSGlkZGVuJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdTdWNjZXNzZnVsbHkgaGlkZGVuPyB7MH0uJyAtZiAoJD8pKQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdBbHJlYWR5IGhpZGRlbi4nKQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCgogICAgICAgICAgICAgICAgICAgICAgICAjIEdldCBBcnJheVJlY292ZXJ5UGFzc3dvcmRzIGZvciBjdXJyZW50IHZvbHVtZQogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6Q3VycmVudFZvbHVtZUFycmF5UmVjb3ZlcnlQYXNzd29yZHMgPSBHZXQtVmFyaWFibGUgLU5hbWUgKCd7MH1BcnJheVJlY292ZXJ5UGFzc3dvcmRzJyAtZiAoJE9TRHJpdmVMZXR0ZXIpKSAtU2NvcGUgJ1NjcmlwdCcgLVZhbHVlT25seSAtRXJyb3JBY3Rpb24gJ1N0b3AnCgogICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgQ3JlYXRlIHN0cmluZyBmb3IgQml0TG9ja2VyUmVjb3ZlcnlQYXNzd29yZC50eHQKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgPSBbc3RyaW5nXTo6RW1wdHkKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gKCdCaXRMb2NrZXIgUmVjb3ZlcnlQYXNzd29yZCBmb3IgT1MgRHJpdmUgKHswfSl7MX0nIC1mICgkZW52OlN5c3RlbURyaXZlLCJgcmBuIikpCiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9IEdldC1TdHJpbmdSZWNvdmVyeVBhc3N3b3JkcwogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAiYHJgbmByYG4iCiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICdCaXRMb2NrZXIgRHJpdmUgRW5jcnlwdGlvbiByZWNvdmVyeSBrZXl7MH0nIC1mICJgcmBuIgogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAnVG8gdmVyaWZ5IHRoYXQgdGhpcyBpcyB0aGUgY29ycmVjdCByZWNvdmVyeSBrZXksIGNvbXBhcmUgdGhlIHN0YXJ0IG9mIHRoZSBmb2xsb3dpbmd7MH0nIC1mICJgcmBuIgogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAnaWRlbnRpZmllciB3aXRoIHRoZSBpZGVudGlmaWVyIHZhbHVlIGRpc3BsYXllZCBvbiB5b3VyIFBDLicKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gImByYG5gcmBuIgogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAoJ0lkZW50aWZpZXI6IHswfScgLWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lQXJyYXlSZWNvdmVyeVBhc3N3b3Jkc1swXS5LZXlQcm90ZWN0b3JJZCkpCiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICJgcmBuYHJgbiIKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gJ0lmIHRoZSBhYm92ZSBpZGVudGlmaWVyIG1hdGNoZXMgdGhlIG9uZSBkaXNwbGF5ZWQgYnkgeW91ciBQQyx7MH0nIC1mICJgcmBuIgogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAndGhlbiB1c2UgdGhlIGZvbGxvd2luZyBrZXkgdG8gIHVubG9jayB5b3VyIGRyaXZlOicKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gImByYG5gcmBuIgogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAoJ1JlY292ZXJ5IEtleTogezB9JyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVBcnJheVJlY292ZXJ5UGFzc3dvcmRzWzBdLlJlY292ZXJ5UGFzc3dvcmQpKQogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAiYHJgbmByYG4iCiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICdJZiB0aGUgYWJvdmUgaWRlbnRpZmllciBkb2VzbmB0IG1hdGNoIHRoZSBvbmUgZGlzcGxheWVkIGJ5IHlvdXIgUEMsezB9JyAtZiAiYHJgbiIKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gJ3RoZW4gdGhpcyBpc25gdCB0aGUgcmlnaHQga2V5IHRvIHVubG9jayB5b3VyIGRyaXZlLnswfScgLWYgImByYG4iCiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICdUcnkgYW5vdGhlciByZWNvdmVyeSBrZXksIG9yIHJlZmVyIHRvezB9JyAtZiAiYHJgbiIgCiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICdodHRwczovL2dvLm1pY3Jvc29mdC5jb20vZndsaW5rLz9MaW5rSUQ9MjYwNTg5IGZvciBhZGRpdGlvbmFsIGFzc2lzdGFuY2UuJwoKCiAgICAgICAgICAgICAgICAgICAgICAgICMgT3V0LUZpbGUgdGhlIHN0cmluZwogICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAnQ3JlYXRpbmcgYmFja3VwIGluIE9uZURyaXZlIGZvciBCdXNpbmVzcy4nCiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpPRDRCQmFja3VwRmlsZVBhdGggPSBbc3RyaW5nXSQoJ3swfUJpdGxvY2tlclJlY292ZXJ5UGFzc3dvcmQtezF9LnR4dCcgLWYgKCRMb2NhbDpQYXRoRGlyT0Q0QkJhY2t1cCwoR2V0LURhdGUgLUZvcm1hdCAneXlNTWRkaGhtbXNzJykpKQogICAgICAgICAgICAgICAgICAgICAgICBPdXQtRmlsZSAtRmlsZVBhdGggJExvY2FsOk9ENEJCYWNrdXBGaWxlUGF0aCAtRW5jb2RpbmcgJ3V0ZjgnIC1Gb3JjZSAtSW5wdXRPYmplY3QgKCRMb2NhbDpTdHJSZWNQYXNzKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoVGVzdC1QYXRoIC1QYXRoICRMb2NhbDpPRDRCQmFja3VwRmlsZVBhdGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRTY3JpcHQ6SXNCYWNrdXBPRCA9ICR0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgICAgICAKCgogICAgICAgICAgICAgICAgICAgICAgICAjIE9uZURyaXZlIGZvciBCdXNpbmVzcyBCYWNrdXAgU3VjY2Vzcz8KICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdTdWNjZXNzPyB7MH0nIC1mICgkU2NyaXB0OklzQmFja3VwT0QpKQogICAgICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgQ2F0Y2ggewogICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnRXJyb3Igd2hpbGUgYmFja3VwIHRvIE9uZURyaXZlLCBtYWtlIHN1cmUgdGhhdCB5b3UgYXJlIEFBRCBqb2luZWQgYW5kIGFyZSBydW5uaW5nIHRoZSBjbWRsZXQgYXMgYW4gYWRtaW4uJykKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0Vycm9yIG1lc3NhZ2U6JyArICJgcmBuIiArICgkXykpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBGaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0RpZCBiYWNrdXAgdG8gT25lRHJpdmUgc3VjY2VlZD8gezB9JyAtZiAoJFNjcmlwdDpJc0JhY2t1cE9EKSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIEJhY2t1cCBPbmVEcml2ZSBmb3IgQnVzaW5lc3MKICAgIAoKCiAgICAgICAgIyMjIyMjIyMjIyMjIyMjIyMKICAgICAgICAjIEF6dXJlIEFEIEJhY2t1cAogICAgICAgICMjIyMjIyMjIyMjIyMjIyMjCiAgICAgICAgI3JlZ2lvbiBCYWNrdXAgQXp1cmUgQUFECgogICAgICAgIExvZ1dyaXRlICgnIyBCYWNrdXAgdG8gQXp1cmUgQUQnKQogICAgICAgIGlmICgkU2NyaXB0OklzQmFja3VwQUFEKSB7CiAgICAgICAgICAgIExvZ1dyaXRlICgnQWxyZWFkeSBkb25lJykKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICRTY3JpcHQ6Qm9vbERpZEFueXRoaW5nQ2hhbmdlVGhpc1J1bnRpbWUgPSAkdHJ1ZQogICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICBUcnkgewogICAgICAgICAgICAgICAgIyBHZXQgQXJyYXlSZWNvdmVyeVBhc3N3b3JkcyBmb3IgY3VycmVudCB2b2x1bWUKICAgICAgICAgICAgICAgICRMb2NhbDpDdXJyZW50Vm9sdW1lQXJyYXlSZWNvdmVyeVBhc3N3b3JkcyA9IEdldC1WYXJpYWJsZSAtTmFtZSAoJ3swfUFycmF5UmVjb3ZlcnlQYXNzd29yZHMnIC1mICgkT1NEcml2ZUxldHRlcikpIC1TY29wZSAnU2NyaXB0JyAtVmFsdWVPbmx5IC1FcnJvckFjdGlvbiAnU3RvcCcKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBDaGVjayBpZiB3ZSBjYW4gdXNlIEJhY2t1cFRvQUFELUJpdExvY2tlcktleVByb3RlY3RvciBjb21tYW5kbGV0ICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgTG9nV3JpdGUgJ0NoZWNraW5nIGlmIHdlIGNhbiB1c2UgIkJhY2t1cFRvQUFELUJpdExvY2tlcktleVByb3RlY3RvciIgY29tbWFuZGxldC4nCgogICAgICAgICAgICAgICAgaWYgKEdldC1Db21tYW5kIC1OYW1lICdCYWNrdXBUb0FBRC1CaXRMb2NrZXJLZXlQcm90ZWN0b3InIC1FcnJvckFjdGlvbiAnU2lsZW50bHlDb250aW51ZScpIHsgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnQ29tbWFuZGxldCBleGlzdHMhJyAtZiAoJExvY2FsOkNtZE5hbWUpKSAKICAgICAgICAgICAgICAgICAgICAkbnVsbCA9IEJhY2t1cFRvQUFELUJpdExvY2tlcktleVByb3RlY3RvciAtTW91bnRQb2ludCAkT1NEcml2ZUxldHRlciAtS2V5UHJvdGVjdG9ySWQgJExvY2FsOkN1cnJlbnRWb2x1bWVBcnJheVJlY292ZXJ5UGFzc3dvcmRzWzBdLidLZXlQcm90ZWN0b3JJZCcgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJwogICAgICAgICAgICAgICAgICAgIGlmICgkPykgewogICAgICAgICAgICAgICAgICAgICAgICAkU2NyaXB0OklzQmFja3VwQUFEID0gJHRydWUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRudWxsID0gQmFja3VwVG9BQUQtQml0TG9ja2VyS2V5UHJvdGVjdG9yIC1Nb3VudFBvaW50ICRPU0RyaXZlTGV0dGVyIC1LZXlQcm90ZWN0b3JJZCAkTG9jYWw6Q3VycmVudFZvbHVtZUFycmF5UmVjb3ZlcnlQYXNzd29yZHNbMF0uS2V5UHJvdGVjdG9ySWQgLUVycm9yQWN0aW9uICdTdG9wJwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJD8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRTY3JpcHQ6SXNCYWNrdXBBQUQgPSAkdHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnU3VjY2Vzcz8gezB9JyAtZiAoJFNjcmlwdDpJc0JhY2t1cEFBRCkpCiAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgICAgZWxzZSB7IAogICAgICAgICAgICAgICAgICAgICMgQmFja3VwVG9BQUQtQml0TG9ja2VyS2V5UHJvdGVjdG9yIGNvbW1hbmRsZXQgbm90IGF2YWlsYWJsZSwgdXNpbmcgb3RoZXIgbWVjaGFuaXNtIAogICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICdCYWNrdXBUb0FBRC1CaXRMb2NrZXJLZXlQcm90ZWN0b3IgY29tbWFuZGxldCBub3QgYXZhaWxhYmxlLCB1c2luZyBvdGhlciBtZWNoYW5pc20uJyAKICAgICAgICAgICAgICAgICAgICAjIEdldCB0aGUgQUFEIE1hY2hpbmUgQ2VydGlmaWNhdGUKICAgICAgICAgICAgICAgICAgICAkQ2VydGlmaWNhdGUgICAgICAgICAgID0gJChbYXJyYXldJChHZXQtQ2hpbGRJdGVtIC1QYXRoICdDZXJ0OlxMb2NhbE1hY2hpbmVcTXlcJykuV2hlcmV7JF8uJ0lzc3VlcicgLW1hdGNoICdDTj1NUy1Pcmdhbml6YXRpb24tQWNjZXNzJ30pCiAgICAgICAgICAgICAgICAgICAgJENlcnRpZmljYXRlVGh1bWJwcmludCA9IFtzdHJpbmddJCgkQ2VydGlmaWNhdGUgfCBTZWxlY3QtT2JqZWN0IC1FeHBhbmRQcm9wZXJ0eSAnVGh1bWJwcmludCcpCiAgICAgICAgICAgICAgICAgICAgJENlcnRpZmljYXRlU3ViamVjdCAgICA9IFtzdHJpbmddJChbc3RyaW5nXSQoJENlcnRpZmljYXRlIHwgU2VsZWN0LU9iamVjdCAtRXhwYW5kUHJvcGVydHkgJ1N1YmplY3QnKS5SZXBsYWNlKCdDTj0nLCcnKSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEdldCB0ZW5hbnQgZG9tYWluIG5hbWUgZnJvbSByZWdpc3RyeQogICAgICAgICAgICAgICAgICAgICRUZW5hbnREb21haW4gPSBbc3RyaW5nXSQoW3N0cmluZ10kKEdldC1JdGVtUHJvcGVydHkgLVBhdGggKCdSZWdpc3RyeTo6SEtFWV9MT0NBTF9NQUNISU5FXFNZU1RFTVxDdXJyZW50Q29udHJvbFNldFxDb250cm9sXENsb3VkRG9tYWluSm9pblxKb2luSW5mb1x7MH0nIC1mICgkQ2VydGlmaWNhdGVUaHVtYnByaW50KSkgLU5hbWUgJ1VzZXJFbWFpbCcgfCBTZWxlY3QtT2JqZWN0IC1FeHBhbmRQcm9wZXJ0eSAnVXNlckVtYWlsJykuU3BsaXQoJ0AnKVstMV0pCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBNYWtlIHN1cmUgd2UgaGF2ZSB2YWxpZCB2YWx1ZXMKICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkVmFyaWFibGUgaW4gW2FycmF5XSQoJENlcnRpZmljYXRlVGh1bWJwcmludCwkQ2VydGlmaWNhdGVTdWJqZWN0LCRUZW5hbnREb21haW4pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChbc3RyaW5nXTo6SXNOdWxsT3JFbXB0eSgkVmFyaWFibGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaHJvdyAnRmFpbGVkIHRvIGJhY2t1cCB0byBBQUQgdXNpbmcgYWx0ZXJuYXRpdmUgbWV0aG9kIGludm9sdmluZyBJbnZva2UtV2ViUmVxdWVzdC4nCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICMgTG9nCiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgJFRlbmFudERvbWFpbgogICAgICAgICAgICAgICAgICAgICMgR2VuZXJhdGUgdGhlIGJvZHkgdG8gc2VuZCB0byBBQUQgY29udGFpbmluZyB0aGUgcmVjb3ZlcnkgaW5mb3JtYXRpb24KICAgICAgICAgICAgICAgICAgICAjIEdldCB0aGUgQml0TG9ja2VyIGtleSBpbmZvcm1hdGlvbiBmcm9tIFdNSQogICAgICAgICAgICAgICAgICAgIFthcnJheV0kKEdldC1CaXRMb2NrZXJWb2x1bWUgLU1vdW50UG9pbnQgJE9TRHJpdmVMZXR0ZXIgfCBTZWxlY3QtT2JqZWN0IC1FeHBhbmRQcm9wZXJ0eSAnS2V5UHJvdGVjdG9yJykuV2hlcmV7JF8uJ0tleVByb3RlY3RvclR5cGUnIC1lcSAnUmVjb3ZlcnlQYXNzd29yZCd9LkZvckVhY2h7CiAgICAgICAgICAgICAgICAgICAgICAgICRLZXkgPSAkXwogICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoImtpZCA6ICQoJEtleS4nS2V5UHJvdGVjdG9ySWQnKSBrZXk6ICQoJEtleS4nUmVjb3ZlcnlQYXNzd29yZCcpIikKICAgICAgICAgICAgICAgICAgICAgICAgJEJvZHkgPSBbc3RyaW5nXSQoInsiImtleSIiOiIiJCgkS2V5LidSZWNvdmVyeVBhc3N3b3JkJykiIiwiImtpZCIiOiIiJCgkS2V5LidLZXlQcm90ZWN0b3JJZCcuUmVwbGFjZSgneycsJycpLlJlcGxhY2UoJ30nLCcnKSkiIiwiInZvbCIiOiIiT1NWIiJ9IikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBDcmVhdGUgdGhlIFVSTCB0byBwb3N0IHRoZSBkYXRhIHRvIGJhc2VkIG9uIHRoZSB0ZW5hbnQgYW5kIGRldmljZSBpbmZvcm1hdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAkVXJpID0gW3N0cmluZ10kKCdodHRwczovL2VudGVycHJpc2VyZWdpc3RyYXRpb24ud2luZG93cy5uZXQvbWFuYWdlL3swfS9kZXZpY2UvezF9P2FwaS12ZXJzaW9uPTEuMCcgLWYgKCRUZW5hbnREb21haW4sJENlcnRpZmljYXRlU3ViamVjdCkpCiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICJDcmVhdGluZyB1cmwuLi4kVXJpIgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIFBvc3QgdGhlIGRhdGEgdG8gdGhlIFVSTCBhbmQgc2lnbiBpdCB3aXRoIHRoZSBBQUQgTWFjaGluZSBDZXJ0aWZpY2F0ZQogICAgICAgICAgICAgICAgICAgICAgICAkUmVxdWVzdCA9IEludm9rZS1XZWJSZXF1ZXN0IC1VcmkgJFVyaSAtQm9keSAkQm9keSAtVXNlQmFzaWNQYXJzaW5nIC1NZXRob2QgJ1Bvc3QnIC1Vc2VEZWZhdWx0Q3JlZGVudGlhbHMgLUNlcnRpZmljYXRlICRDZXJ0aWZpY2F0ZQogICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAkUmVxdWVzdC4nUmF3Q29udGVudCcKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQ/KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkU2NyaXB0OklzQmFja3VwQUFEID0gJHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgfSAgICAKICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdQb3N0IHRoZSBkYXRhIHRvIHRoZSBVUkwgYW5kIHNpZ24gaXQgd2l0aCB0aGUgQUFEIE1hY2hpbmUgQ2VydGlmaWNhdGUuIFN1Y2Nlc3M/IHswfScgLWYgKCRTY3JpcHQ6SXNCYWNrdXBBQUQpKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgIH0KICAgICAgICAgICAgQ2F0Y2ggewogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdFcnJvciB3aGlsZSBiYWNrdXAgdG8gQXp1cmUgQUQsIG1ha2Ugc3VyZSB0aGF0IHlvdSBhcmUgQUFEIGpvaW5lZCBhbmQgYXJlIHJ1bm5pbmcgdGhlIGNtZGxldCBhcyBhbiBhZG1pbi4nKQogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdFcnJvciBtZXNzYWdlOicgKyAiYHJgbiIgKyAoJF8pKQogICAgICAgICAgICAgICAgJElzQmFja3VwQUFEID0gJGZhbHNlCiAgICAgICAgICAgIH0KICAgICAgICAgICAgRmluYWxseSB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0RpZCBiYWNrdXAgdG8gQXp1cmUgQUQgU3VjY2VlZD8gezB9JyAtZiAoJFNjcmlwdDpJc0JhY2t1cEFBRCkpCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBCYWNrdXAgQXp1cmUgQUFECiAgICAgICAgCiAgICAgICAgCiAgICAgICAgIyBJZiBubyBiYWNrdXAgYW5kIG5vIFJlY292ZXJ5IFBhc3N3b3JkcyBwcmVzZW50CiAgICAgICAgCiAgICB9CiAgICBlbHNlIHsKICAgICAgICBMb2dXcml0ZSAnT1MgRHJpdmUgaXMgbm90IGVuY3J5cHRlZCwgdGhlcmUgYXJlIG5vIFJlY292ZXJ5IFBhc3N3b3JkcywgYW5kIHRoZXJlIGFyZSBubyBiYWNrdXBzLicKICAgIH0KfQojZW5kcmVnaW9uIEJhY2t1cAojZW5kcmVnaW9uIE1haW4KCgoKIyMjIyMjIyMjIyMjIyMjIyMjIyMKIyMjIyMjICBHIFUgSSAjIyMjIyMKIyMjIyMjIyMjIyMjIyMjIyMjIyMKI3JlZ2lvbiBHVUkKaWYgKCRTY3JpcHQ6SXNFbmNyeXB0ZWQgLWFuZCAkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3IC1hbmQgJFNjcmlwdDpCb29sU2hvd0dVSSkgewogICAgIyBTaG93IHJlYm9vdCBwcm9tcHQgdG8gdXNlcgogICAgTG9nV3JpdGUgIlByb21wdGluZyB1c2VyIHRvIFJlYm9vdCBjb21wdXRlci4iCiAgICAgICAgICAgCgogICAgW3ZvaWRdW1N5c3RlbS5SZWZsZWN0aW9uLkFzc2VtYmx5XTo6TG9hZFdpdGhQYXJ0aWFsTmFtZSgg4oCcU3lzdGVtLldpbmRvd3MuRm9ybXPigJ0pCiAgICBbdm9pZF1bU3lzdGVtLlJlZmxlY3Rpb24uQXNzZW1ibHldOjpMb2FkV2l0aFBhcnRpYWxOYW1lKCDigJxNaWNyb3NvZnQuVmlzdWFsQmFzaWPigJ0pCgogICAgJGZvcm0gPSBbU3lzdGVtLldpbmRvd3MuRm9ybXMuRm9ybV06Om5ldygpCiAgICAkZm9ybS4nV2lkdGgnID0gNTAwCiAgICAkZm9ybS4nSGVpZ2h0JyA9IDE1MAogICAgJGZvcm0uJ1RleHQnID0gJ0JpdExvY2tlciByZXF1aXJlcyBhIHJlYm9vdCEnCiAgICAkZm9ybS4nU3RhcnRQb3NpdGlvbicgPSBbU3lzdGVtLldpbmRvd3MuRm9ybXMuRm9ybVN0YXJ0UG9zaXRpb25dOjpDZW50ZXJTY3JlZW4KCiAgICAkRHJvcERvd25BcnJheSA9IEAoIjQ6SG91cnMiLCAiODpIb3VycyIsICIxMjpIb3VycyIsICIyNDpIb3VycyIpCiAgICAkRERMID0gW1N5c3RlbS5XaW5kb3dzLkZvcm1zLkNvbWJvQm94XTo6bmV3KCkKICAgICREREwuJ0xvY2F0aW9uJyA9IFtTeXN0ZW0uRHJhd2luZy5TaXplXTo6bmV3KDE0MCwgMTApCiAgICAkRERMLidTaXplJyA9IFtTeXN0ZW0uRHJhd2luZy5TaXplXTo6bmV3KDEzMCwgMzApCiAgICBmb3JlYWNoICgkSXRlbSBpbiAkRHJvcERvd25BcnJheSkgewogICAgICAgICREREwuJ0l0ZW1zJy5BZGQoJEl0ZW0pIHwgT3V0LU51bGwKICAgIH0KICAgICREREwuJ1NlbGVjdGVkSW5kZXgnID0gMAoKICAgICRidXR0b24xID0gW1N5c3RlbS5XaW5kb3dzLkZvcm1zLmJ1dHRvbl06Om5ldygpCiAgICAkYnV0dG9uMS4nTGVmdCcgPSA0MAogICAgJGJ1dHRvbjEuJ1RvcCcgPSA4NQogICAgJGJ1dHRvbjEuJ1dpZHRoJyA9IDEwMAogICAgJGJ1dHRvbjEuJ1RleHQnID0gJ1JlYm9vdCBOb3cnCiAgICAkYnV0dG9uMS4nQWRkX0NsaWNrJyh7JGdsb2JhbDp4aW5wdXQgPSAnUmVib290JzsgJEZvcm0uQ2xvc2UoKX0pCgogICAgJGJ1dHRvbjIgPSBbU3lzdGVtLldpbmRvd3MuRm9ybXMuYnV0dG9uXTo6bmV3KCkKICAgICRidXR0b24yLidMZWZ0JyA9IDE3MAogICAgJGJ1dHRvbjIuJ1RvcCcgPSA4NQogICAgJGJ1dHRvbjIuJ1dpZHRoJyA9IDEwMAogICAgJGJ1dHRvbjIuJ1RleHQnID0gJ1Bvc3Rwb25lJwogICAgJGJ1dHRvbjIuJ0FkZF9DbGljaycoeyRnbG9iYWw6eGlucHV0ID0gJ1Bvc3Rwb25lOicgKyAkRERMLlRleHQ7ICRGb3JtLkNsb3NlKCl9KQoKICAgICRidXR0b24zID0gW1N5c3RlbS5XaW5kb3dzLkZvcm1zLmJ1dHRvbl06Om5ldygpCiAgICAkYnV0dG9uMy4nTGVmdCcgPSAyOTA7CiAgICAkYnV0dG9uMy4nVG9wJyA9IDg1OwogICAgJGJ1dHRvbjMuJ1dpZHRoJyA9IDEwMDsKICAgICRidXR0b24zLidUZXh0JyA9ICdDYW5jZWwnOwogICAgJGJ1dHRvbjMuJ0FkZF9DbGljaycoeyRnbG9iYWw6eGlucHV0ID0gIlBvc3Rwb25lMjQiOyAkRm9ybS5DbG9zZSgpfSkKCgogICAgJGZvcm0uJ0tleVByZXZpZXcnID0gJFRydWUKICAgICRmb3JtLidBZGRfS2V5RG93bicoIHtpZiAoJF8uJ0tleUNvZGUnIC1lcSAnRW50ZXInKSAKICAgICAgICB7JHggPSAkdGV4dEJveDEuJ1RleHQnOyAkZm9ybS5DbG9zZSgpfX0pCiAgICAkZm9ybS4nQWRkX0tleURvd24nKCB7aWYgKCRfLidLZXlDb2RlJyAtZXEgJ0VzY2FwZScpIAogICAgICAgIHskZm9ybS5DbG9zZSgpfX0pCgogICAgJGV2ZW50SGFuZGxlciA9IFtTeXN0ZW0uRXZlbnRIYW5kbGVyXSB7IAogICAgICAgICRidXR0b24xLidDbGljayc7CiAgICAgICAgJERyb3BEb3duQXJyYXkuJ1RleHQnOwogICAgICAgICRmb3JtLkNsb3NlKCk7IH07CgogICAgIyRidXR0b24uQWRkX0NsaWNrKCRldmVudEhhbmRsZXIpIDsKICAgICRmb3JtLidDb250cm9scycuQWRkKCRidXR0b24xKTsKICAgICRmb3JtLidDb250cm9scycuQWRkKCRidXR0b24yKTsKICAgICRmb3JtLidDb250cm9scycuQWRkKCRidXR0b24zKTsKICAgICRmb3JtLidDb250cm9scycuQWRkKCREREwpOwogICAgJGZvcm0uJ0NvbnRyb2xzJy5BZGQoJHRleHRMYWJlbDEpCiAgICAkcmV0ID0gJGZvcm0uU2hvd0RpYWxvZygpOwoKICAgIGlmICgkZ2xvYmFsOnhpbnB1dCAtZXEgJ1JlYm9vdCcpIHtzaHV0ZG93biAtciAtZiAvdCA2MDB9CiAgICBpZiAoJGdsb2JhbDp4aW5wdXQgLWxpa2UgJ1Bvc3Rwb25lOio6SG91cnMnKSB7CiAgICAgICAgJGh2YWwgPSAoKFtpbnRdJGdsb2JhbDp4aW5wdXQuc3BsaXQoIjoiKVsxXSkgKiA2MCAqIDYwKQogICAgICAgIHNodXRkb3duIC1yIC1mIC90ICRodmFsCiAgICB9CiAgICBpZiAoJGdsb2JhbDp4aW5wdXQgLWVxICdQb3N0cG9uZTI0Jykge3NodXRkb3duIC1yIC1mIC90IDg2NDAwfQp9CiNlbmRyZWdpb24gR1VJCgoKCiMjIyMjIyMjIyMjIyMjIyMjIyMjCiMjIyMgRU5EIFJFU1VMVFMgIyMjCiMjIyMjIyMjIyMjIyMjIyMjIyMjCiNyZWdpb24gRW5kIFJlc3VsdHMgCkxvZ1dyaXRlICgnIyMjIEVuZCByZXN1bHRzJykKIyBDbGVhbmluZyB1cCBpZiBzdWNjZXNzCmlmICgkU2NyaXB0OklzRmluaXNoZWQxc3RUaW1lKSB7CiAgICBMb2dXcml0ZSAnRmluaXNoZWQgZmlyc3QgdGltZSA9IFRydWUgfCBKdXN0IGNoZWNrZWQgd2VhdGhlciBCaXRMb2NrZXIgUmVjb3ZlcnkgUGFzc3dvcmQgaGFkIGNoYW5nZWQuJwp9CgplbHNlIHsKICAgIGlmICgkU2NyaXB0OklzRW5jcnlwdGVkIC1hbmQgJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdyAtYW5kICRTY3JpcHQ6SXNCYWNrdXBBQUQgLWFuZAogICAgICAgIChbYm9vbF0kKCRTY3JpcHQ6Qm9vbEJhY2t1cFRvT25lRHJpdmVGb3JCdXNpbmVzcyAtYW5kICRTY3JpcHQ6SXNCYWNrdXBPRCkgLW9yIFtib29sXSQoLW5vdCgkU2NyaXB0OkJvb2xCYWNrdXBUb09uZURyaXZlRm9yQnVzaW5lc3MpKSkKICAgICkgewogICAgICAgICRCTFYgPSBHZXQtQml0TG9ja2VyVm9sdW1lIC1Nb3VudFBvaW50ICRlbnY6U3lzdGVtRHJpdmUKICAgICAgICBpZiAoKCRCTFYuJ1ZvbHVtZVN0YXR1cycgLWVxICRTY3JpcHQ6Qml0TG9ja2VyVm9sdW1lRW5jcnlwdGlvblN0YXR1c2VzWzJdKSAtYW5kIChAKCRCTFYuJ0tleVByb3RlY3RvcicgfCBXaGVyZS1PYmplY3QgLVByb3BlcnR5ICdLZXlQcm90ZWN0b3JUeXBlJyAtZXEgJ1JlY292ZXJ5UGFzc3dvcmQnKS4nQ291bnQnIC1lcSAxKSkgewogICAgICAgIAogICAgICAgICAgICAjIEZpcnN0IHN1Y2Nlc3NmdWxsIHJ1bgogICAgICAgICAgICAkU2NyaXB0OklzRmluaXNoZWQxc3RUaW1lID0gJHRydWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU2NoZWR1bGVkVGFzawogICAgICAgICAgICBFZGl0LVNjaGVkdWxlZFRhc2sgLVRhc2tOYW1lICRTY3JpcHQ6U2NoZWR1bGVkVGFza05hbWUKCiAgICAgICAgICAgICMgRmlsZXMKICAgICAgICAgICAgI3JlZ2lvbiBSZW1vdmUgZmlsZXMKICAgICAgICAgICAgaWYgKCRTY3JpcHQ6Qm9vbFJlbW92ZUZpbGVzQWZ0ZXJTdWNjZXNzIC1hbmQgJFNjcmlwdDpJc0ZpbmlzaGVkMXN0VGltZSkgeyAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgJG51bGwgPSBTdGFydC1Kb2IgLUFyZ3VtZW50TGlzdCAkU2NyaXB0OkZpbGVMb2cgLVNjcmlwdEJsb2NrIHsKICAgICAgICAgICAgICAgICAgICBQYXJhbShbc3RyaW5nXSAkRmlsZUxvZykKICAgICAgICAKICAgICAgICAgICAgICAgICAgICBGdW5jdGlvbiBMb2dXcml0ZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIFBhcmFtIChbc3RyaW5nXSRMb2dTdHJpbmcpCiAgICAgICAgICAgICAgICAgICAgICAgICRhID0gW3N0cmluZ10kKEdldC1EYXRlKQogICAgICAgICAgICAgICAgICAgICAgICAkTG9nU3RyaW5nID0gW3N0cmluZ10kKCRhLCAkTG9nU3RyaW5nKQogICAgICAgICAgICAgICAgICAgICAgICBBZGQtY29udGVudCAtUGF0aCAkRmlsZUxvZyAtVmFsdWUgJExvZ1N0cmluZwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAkTG9jYWw6UmVtRGlyUGF0aCA9IFtzdHJpbmddJCgke2VudjpQcm9ncmFtRmlsZXMoeDg2KX0gKyAnXEJpdExvY2tlclRyaWdnZXJcJykKICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIFN0YXJ0LVNsZWVwIC1TZWNvbmRzIDUKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1N0YXJ0ZWQgdGhlIGpvYiB0byByZW1vdmUgInswfSInIC1mICgkTG9jYWw6UmVtRGlyUGF0aCkpCiAgICAgICAgICAgICAgICAgICAgaWYgKFRlc3QtUGF0aCAkTG9jYWw6UmVtRGlyUGF0aCkgewogICAgICAgICAgICAgICAgICAgICAgICBSZW1vdmUtSXRlbSAtUGF0aCAkTG9jYWw6UmVtRGlyUGF0aCAtUmVjdXJzZSAtRm9yY2UKICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdSZW1vdmluZyB0aGUgZm9sZGVyIChyZWN1cnNlLCBmb3JjZSkuIFN1Y2Nlc3M/IHswfScgLWYgKCQ/KSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnRm9sZGVyIGRvZXMgbm90IGV4aXN0JykKICAgICAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9CiAgICAgICAgICAgICNlbmRyZWdpb24gUmVtb3ZlIEZpbGVzCiAgICAgICAgfSAgICAKICAgIH0KICAgIGVsc2UgewogICAgICAgIExvZ1dyaXRlICdUaGVyZSBhcmUgc3RpbGwgdGhpbmdzIHRvIGRvLiBUcnlpbmcgYWdhaW4gbGF0ZXIuJwogICAgfQp9CiNlbmRyZWdpb24gRW5kIFJlc3VsdHMKCgoKIyMjIyMjIyMjIyMjIyMjIyMjIyMKIyMjIyBTIFQgQSBUIFMgIyMjIyMKIyMjIyMjIyMjIyMjIyMjIyMjIyMKTG9nV3JpdGUgKCcjIyMgU1RBVFMnKQokU2NyaXB0OkNvdW50UnVucyArPSAxCgppZiAoLW5vdCgkU2NyaXB0OkJvb2xSZW1vdmVGaWxlc0FmdGVyU3VjY2VzcykpIHsKICAgIGlmICgtbm90KFRlc3QtUGF0aCAkU2NyaXB0OkRpckluc3RhbGwpKSB7CiAgICAgICAgJG51bGwgPSBOZXctSXRlbSAtUGF0aCAkU2NyaXB0OkRpckluc3RhbGwgLUl0ZW1UeXBlICdEaXJlY3RvcnknIC1Gb3JjZQogICAgfQogICAgCiAgICAjIEZldGNoIE9TIGRyaXZlIGVuY3J5cHRpb24ga2V5IGFuZCBwYXNzd29yZAogICAgJFNjcmlwdDpPU0RyaXZlS2V5SUQgPSBbc3RyaW5nXSQoJFNjcmlwdDpDQXJyYXlSZWNvdmVyeVBhc3N3b3JkcyB8IFNlbGVjdC1PYmplY3QgLUZpcnN0IDEgLUV4cGFuZFByb3BlcnR5ICdLZXlQcm90ZWN0b3JJZCcpCiAgICAkU2NyaXB0Ok9TRHJpdmVQcm90ZWN0aW9uUGFzc3dvcmQgPSBbc3RyaW5nXSQoJFNjcmlwdDpDQXJyYXlSZWNvdmVyeVBhc3N3b3JkcyB8IFNlbGVjdC1PYmplY3QgLUZpcnN0IDEgLUV4cGFuZFByb3BlcnR5ICdSZWNvdmVyeVBhc3N3b3JkJykKCiAgICAjIENyZWF0ZSBvdXRwdXQgc3RyaW5nCiAgICAkT3V0U3RyaW5nID0gW3N0cmluZ10kKCgkU2NyaXB0OkNvdW50UnVucykuVG9TdHJpbmcoKSArICJgcmBuIikgICAgICAgICAgICAjIDAgICBMaW5lIDEKICAgICRPdXRTdHJpbmcgKz0gKChbYnl0ZV0gJFNjcmlwdDpJc0ZpbmlzaGVkMXN0VGltZSkuVG9TdHJpbmcoKSArICJgcmBuIikgICAgICMgMSAgIExpbmUgMgogICAgJE91dFN0cmluZyArPSAoKFtieXRlXSAkU2NyaXB0OklzRW5jcnlwdGVkKS5Ub1N0cmluZygpICsgImByYG4iKSAgICAgICAgICAgIyAyICAgTGluZSAzCiAgICAkT3V0U3RyaW5nICs9ICgoW2J5dGVdICRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cpLlRvU3RyaW5nKCkgKyAiYHJgbiIpICAgICAjIDMgICBMaW5lIDQKICAgICRPdXRTdHJpbmcgKz0gKChbYnl0ZV0gJFNjcmlwdDpJc0JhY2t1cE9EKS5Ub1N0cmluZygpICsgImByYG4iKSAgICAgICAgICAgICMgNCAgIExpbmUgNQogICAgJE91dFN0cmluZyArPSAoKFtieXRlXSAkU2NyaXB0OklzQmFja3VwQUFEKS5Ub1N0cmluZygpICsgImByYG4iKSAgICAgICAgICAgIyA1ICAgTGluZSA2CiAgICAkT3V0U3RyaW5nICs9ICgoW3N0cmluZ10gJFNjcmlwdDpPU0RyaXZlS2V5SUQpICsgImByYG4iKSAgICAgICAgICAgICAgICAgICAjIDYgICBMaW5lIDcKICAgICRPdXRTdHJpbmcgKz0gKChbc3RyaW5nXSAkU2NyaXB0Ok9TRHJpdmVQcm90ZWN0aW9uUGFzc3dvcmQpKSAgICAgICAgICAgICAgICMgNyAgIExpbmUgOAogICAKICAgICMgT3V0cHV0IHRoZSBzdGF0cyBmaWxlCiAgICAkbnVsbCA9IE91dC1GaWxlIC1GaWxlUGF0aCAkU2NyaXB0OkZpbGVTdGF0cyAtRW5jb2RpbmcgJ3V0ZjgnIC1Gb3JjZSAtSW5wdXRPYmplY3QgKCRPdXRTdHJpbmcpCn0KTG9nV3JpdGUgKCdSdW5zIHNvIGZhcjogezB9JyAtZiAoJFNjcmlwdDpDb3VudFJ1bnMpKQoKaWYgKCRTY3JpcHQ6Qm9vbERpZEFueXRoaW5nQ2hhbmdlVGhpc1J1bnRpbWUpIHsKICAgIFdyaXRlLVN0YXRzIAp9CgoKCiMjIyBHaXZlIHVwIGFmdGVyIFggcnVucyBhbmQgSXNGaW5pc2hlZDFzdFRpbWUgLWVxICRmYWxzZQppZiAoJFNjcmlwdDpDb3VudFJ1bnMgLWVxIDMwIC1hbmQgKC1ub3QoJFNjcmlwdDpJc0ZpbmlzaGVkMXN0VGltZSkpKSB7CiAgICBMb2dXcml0ZSAoJ1Nob3VsZCBoYXZlIGJlZW4gZG9uZSBieSBub3cuJykKICAgIEVkaXQtU2NoZWR1bGVkVGFzayAtVGFza05hbWUgJFNjcmlwdDpTY2hlZHVsZWRUYXNrTmFtZQoKICAgIGlmICgkZmFsc2UpIHsKICAgICAgICAjIyMgR2F0aGVyaW5nIGluZm8gZm9yIHRoZSBlbWFpbAogICAgICAgIGlmICgtbm90KCRTY3JpcHQ6V2luZG93c1ZlcnNpb24pKSB7CiAgICAgICAgICAgIENyZWF0ZS1FbnZWYXJpYWJsZXMKICAgICAgICB9CiAgICAgICAgIyMjIEJ1aWxkaW5nIGVtYWlsIHN0cmluZwogICAgICAgICRMb2NhbDpTdHJTdWJqZWN0ID0gW3N0cmluZ10kKCdCaXRMb2NrZXJUcmlnZ2VyIGZhaWxlZCB7MH0gdGltZXMgZm9yIHRlbmFudCAiezF9IiwgZGV2aWNlOiAiezJ9IicgLWYgKCRDb3VudFJ1bnMuVG9TdHJpbmcoKSwkTG9jYWw6TmFtZVRlbmFudCwkTG9jYWw6TmFtZUNvbXB1dGVyKSkKICAgICAgICAkTG9jYWw6U3RyRW1haWwgPSBbc3RyaW5nXTo6RW1wdHkKICAgICAgICAkTG9jYWw6U3RyRW1haWwgKz0gKCRMb2NhbDpTdHJTdWJqZWN0KQogICAgICAgICRMb2NhbDpTdHJFbWFpbCArPSAoImByYG4iKQogICAgICAgICRMb2NhbDpTdHJFbWFpbCArPSAoImByYG4iICsgJyMjIEVudmlyb25tZW50IGluZm8nKQogICAgICAgICRMb2NhbDpTdHJFbWFpbCArPSAoImByYG4iICsgJ0RldmljZSBuYW1lOiAnICsgJFNjcmlwdDpDb21wdXRlck5hbWUgKyAnIHwgTWFudWZhY3R1cmVyOiAnICsgJFNjcmlwdDpDb21wdXRlck1hbnVmYWN0dXJlciArICcgfCBNb2RlbDogJyArICRTY3JpcHQ6Q29tcHV0ZXJQcm9kdWN0TmFtZSkgCiAgICAgICAgJExvY2FsOlN0ckVtYWlsICs9ICgiYHJgbiIgKyAnV2luZG93cyBFZGl0aW9uOiAnICsgJFNjcmlwdDpXaW5kb3dzRWRpdGlvbiArICcgfCBXaW5kb3dzIFZlcnNpb24nICsgJFNjcmlwdDpXaW5kb3dzVmVyc2lvbikKICAgICAgICAkTG9jYWw6U3RyRW1haWwgKz0gKCJgcmBuYHJgbiIgKyAnVGhlcmUgaGF2ZSBub3cgYmVlbiB7MH0gcnVucywgYnV0IEJpdExvY2tlclRyaWdnZXIgU1RJTEwgZmFpbHMuJyAtZiAoJFNjcmlwdDpDb3VudFJ1bnMpKQogICAgICAgICRMb2NhbDpTdHJFbWFpbCArPSAoImByYG4iICsgJ1N1Y2Nlc3Mgc3RhdHVzIHwgRW5jcnlwdGVkIDogezB9IHwgUHJvdGVjdGlvbiBQYXNzd29yZHMgcHJlc2VudCA6IHsxfSB8IEJhY2t1cCB0byBBenVyZUFEIDogezJ9IHwgQmFja3VwIHRvIE9uZURyaXZlIDogezN9JyAtZiAoJFNjcmlwdDpJc0VuY3J5cHRlZCwkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3LCRTY3JpcHQ6SXNCYWNrdXBBQUQsJFNjcmlwdDpJc0JhY2t1cE9EKSkKICAgICAgICBMb2dXcml0ZSAoJExvY2FsOlN0ckVtYWlsKQogICAgICAgIDwjIyMgU2VuZCBlbWFpbAogICAgICAgICMjIE1haWwgYWRkcmVzcyhlcykKICAgICAgICBbc3RyaW5nXSAkTG9jYWw6U3RyVG9FbWFpbEFkZHJlc3MgPSAnT2xhdiBSLiBCaXJrZWxhbmQgPG9sYXZiQGlyb25zdG9laXQuY29tPjsnCiAgICAgICAgIyRTdHJFbWFpbEFkZHJlc3MgKz0gJ0lyb25zdG9uZSBTZXJ2aWNlZGVzayA8c2VydmljZWRla3NAaXJvbnN0b25laXQuY29tPicKICAgICAgICBbc3RyaW5nXSAkTG9jYWw6U3RyRnJvbUVtYWlsQWRkcmVzcyA9ICgnQml0TG9ja2VyVHJpZ2dlckZhaWxAezB9JyAtZiAoJFNjcmlwdDpOYW1lVGVuYW50KSkKICAgICAgICAjU2VuZC1NYWlsTWVzc2FnZSAtVG8gJExvY2FsOlN0clRvRW1haWxBZGRyZXNzIC1TbXRwU2VydmVyICAtRnJvbSAkTG9jYWw6U3RyRnJvbUVtYWlsQWRkcmVzcyAtU3ViamVjdCAkTG9jYWw6U3RyU3ViamVjdCAtQm9keSAkTG9jYWw6U3RyRW1haWwKICAgICAgICAjPgogICAgfQp9CgoKCgoKIyMjIyMjIyMjIyMjIyMjIyMjIyMKIyMjIyAgRCBPIE4gRSAgIyMjIyMKIyMjIyMjIyMjIyMjIyMjIyMjIyMKTG9nV3JpdGUgKCdBbGwgZG9uZSwgZXhpdGluZyBzY3JpcHQuLi4nKQojZW5kcmVnaW9uIE1haW4=')
        #endregion FilePS1
    #endregion Files

    # Script specific variables
    $Script:NameApp            = [string]$($NameScriptNoun)
    $Script:NameScheduledTask  = [string]$($NameScriptNoun)
    $Script:PathDirInstall     = [string]$('{0}\IronstoneIT\{1}' -f ($env:ProgramW6432,$Script:NameApp))
    $Script:PathFileInstall    = [string]$('{0}\{1}' -f ($Script:PathDirInstall,$Script:NameFilePS1))
#endregion Variables




#region Main
    Write-Output -InputObject ('### {0}' -f ($NameScript))



    ###########################################################
    ### 1. Clean up BitLockerTrigger and IronTrigger
    Write-Output -InputObject ('{0}# 1. Clean up previous install paths.' -f ("`r`n`r`n"))
    
    # Paths
    Write-Verbose -Message ('Remove previous install path(s) if present')
    # Get Directory Paths
    $Local:RemPaths = [string[]]@(
        # Install Directory used in this script
        ($Script:PathDirInstall),
        # Install Dirs matching "*Trigger*" or "*BitLocker*" is ProgramFiles x64
        @(Get-ChildItem -Path ('{0}\IronstoneIT\' -f ($env:ProgramW6432)) -Directory -ErrorAction 'SilentlyContinue' | Where-Object {$_.Name -like '*trigger*' -or $_.Name -like '*BitLocker*'} | Select-Object -ExpandProperty 'FullName'),
        # Install Dirs matching "*Trigger*" or "*BitLocker*" is ProgramFiles x86
        @(Get-ChildItem -Path ('{0}\IronstoneIT\' -f (${env:ProgramFiles(x86)})) -Directory -ErrorAction 'SilentlyContinue' | Where-Object {$_.Name -like '*trigger*' -or $_.Name -like '*BitLocker*'} | Select-Object -ExpandProperty 'FullName')
    )
    # Remove Directory Paths
    foreach ($Path in $Local:RemPaths) {
        if (-not([string]::IsNullOrEmpty($Path.Trim()))) {
            Write-Verbose -Message ('   Removing "{0}" if it exists.' -f ($Path))
            if (Test-Path -Path $Path) {
                $null = Remove-Item -Path $Path -Force -Recurse
                Write-Verbose -Message ('      Directory does exist. Removing. Success? {0}' -f ($?))
            }
            else {
                Write-Verbose -Message ('      Directory does not exist')
            }
        }
    }
    
    # Stats and Logs
    Write-Verbose -Message ('Remove previous files: Stats and Logs')
    @(Get-ChildItem -Path ('{0}\Temp' -f ($env:windir)) -File -ErrorAction 'SilentlyContinue' | Where-Object -FilterScript {$_.'Name' -like '*trigger*'} | Select-Object -ExpandProperty 'FullName') | ForEach-Object {
        Remove-Item -Path $_ -Force
        Write-Verbose -Message ('Removing "{0}". Success? {1}.' -f ($_,$?.ToString()))
    }
    Get-ChildItem -Path $PathDirLog -Name '*EnableBitLocker.log' -File -Force -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'PSChildName' | ForEach-Object {Remove-Item -Path ('{0}{1}' -f ($PathDirLog,$_)) -Force}

    # Scheduled tasks
    Write-Verbose -Message ('Remove previous ScheduledTask(s)')
    $Local:ScheduledTasks = Get-ScheduledTask | Where-Object {
        # Exact Name
        @($Script:NameScheduledTask,'IronTrigger','Enable_BitLocker').Contains($_.'TaskName') -or `
        # Regex
        $_.'TaskName' -like '*BitLocker' -or $_.'TaskName' -like '*IronTrigger*'
    }
    
    if ($Local:ScheduledTasks.'Length' -gt 0) {
        $Local:ScheduledTasks | ForEach-Object {             
            $null = Unregister-ScheduledTask -TaskName $_.'TaskName' -Confirm:$false -ErrorAction 'SilentlyContinue'
            Write-Verbose -Message ('  Removing the Scheduled task "{0}". Success? {1}' -f ($_.'TaskName',$?))
        }
    }
    else {
        if (Get-ScheduledTask -TaskName $Script:NameScheduledTask -ErrorAction 'SilentlyContinue') {            
            $null = Unregister-ScheduledTask -TaskName $Script:NameScheduledTask -Confirm:$false -ErrorAction 'SilentlyContinue'
            Write-Verbose -Message ('  Removing the Scheduled task "{0}". Success? {1}' -f ($Script:NameScheduledTask,$?))
        }
        else {
            Write-Verbose -Message ('  Scheduled task "{0}" does not exist.' -f ($Script:ScheduledTaskName))
        }
    }




    ###########################################################
    ### 2. Install Files
    Write-Output -InputObject ('{0}# 2. Install files.' -f ("`r`n`r`n"))
    # Create path if not exist
    if (-not([System.IO.Directory]::Exists($Script:PathDirInstall))){$null=[System.IO.Directory]::CreateDirectory($Script:PathDirInstall)}
    # Output file
    $null = Out-File -FilePath $Script:PathFileInstall -Encoding 'Utf8' -InputObject ([System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($Script:ContentFilePS1))) -Force:$true -ErrorAction 'Stop'
    # Verbose
    Write-Verbose -Message ('   Success? {0}' -f ($?))



    
    ###########################################################
    ### 3. Surpress BitLocker Toast Notifications
    Write-Output -InputObject ('{0}# 3. Surpress BitLocker Toast Notifications.' -f ("`r`n`r`n"))

    # Create registry base path to HKCU:\ from System context
    $RegDirBase = [string]$('Registry::HKEY_USERS\{0}\Software\Microsoft\Windows\CurrentVersion\Notifications\Settings' -f ($Script:StrIntuneUserSID))
    
    # Registry paths to disable BitLocker Toast Notifications
    $RegDirs    = [string[]]@(
        [string]('{0}\Windows.SystemToast.BitLockerPolicyRefresh' -f ($RegDirBase)),
        [string]('{0}\Windows.SystemToast.BdeUnlock' -f ($RegDirBase))
    )

    # Set registry values
    foreach ($RegDir in $RegDirs) {
        if (-not(Test-Path -Path $RegDir)) {$null = New-Item -Path $RegDir -ItemType 'Directory' -Force}
        $null = Set-ItemProperty -Path $RegDir -Name 'Enabled' -Value 0 -Type 'DWord' -Force
        if (-not($?)) {
            Throw 'ERROR: Failed to set registry values to surpress BotLocker Toast Notifications.'
        }
        else {
            Write-Verbose -Message ('   Success.')
        }
    }




    ###########################################################
    ### 4. Create ScheduledTask and run it if success
    Write-Output -InputObject ('{0}# 4. Create Scheduled Task "{1}", run it if success.' -f ("`r`n`r`n",$Script:NameScheduledTask))
    # Get path of PowerShell.exe and the .PS1 file
    $PathFilePowerShell = [string] '%SystemRoot%\system32\WindowsPowerShell\v1.0\powershell.exe' # Works regardless of 64bit vs 32bit
    $PathFilePS1        = [string] ('{0}\{1}' -f ($Script:PathDirInstall,$Script:NameFilePS1))
    # Create Scheduled Task
    #region    Create Scheduled Task running PS1 using PowerShell.exe - Every 15 Minutes
        # Construct Scheduled Task
        $ScheduledTask = New-ScheduledTask                                                    `
            -Action    (New-ScheduledTaskAction -Execute ('"{0}"' -f ($PathFilePowerShell)) -Argument ('-ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -WindowStyle Hidden -File "{0}"' -f ($PathFilePS1))) `
            -Principal (New-ScheduledTaskPrincipal -UserId 'NT AUTHORITY\SYSTEM' -RunLevel 'Highest')                                                                                                                   `
            -Trigger   (New-ScheduledTaskTrigger -Once -At ([datetime]::Today) -RepetitionInterval ([timespan]::FromMinutes(15)))                                                                                       `
            -Settings  (New-ScheduledTaskSettingsSet -Hidden -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -ExecutionTimeLimit ([timespan]::FromMinutes(10)) -Compatibility 4 -StartWhenAvailable)
        $ScheduledTask.'Author'      = 'Ironstone'
        $ScheduledTask.'Description' = ('{0}Runs a PowerShell script. {1}Execute: "{2}". {1}Arguments: "{3}".' -f (
            $(if([string]::IsNullOrEmpty($DescriptionScheduledTask)){''}else{('{0} {1}' -f ($DescriptionScheduledTask,"`r`n"))}),"`r`n",
            [string]($ScheduledTask | Select-Object -ExpandProperty 'Actions' | Select-Object -ExpandProperty 'Execute'),
            [string]($ScheduledTask | Select-Object -ExpandProperty 'Actions' | Select-Object -ExpandProperty 'Arguments')
        ))

        # Register Scheduled Task
        $null = Register-ScheduledTask -TaskName $NameScheduledTask -InputObject $ScheduledTask -Force -Verbose:$false -Debug:$false
                
        # Check if success registering Scheduled Task
        $SuccessCreatingScheduledTask = [bool]$($? -and [bool]$([byte](@(Get-ScheduledTask -TaskName $NameScheduledTask).'Count') -eq 1))
        Write-Verbose -Message ('Success creating scheduled task "{0}"? "{1}".' -f ($NameScheduledTask,$SuccessCreatingScheduledTask.ToString()))
                
        # Run Scheduled Task if Success Creating It
        if ($SuccessCreatingScheduledTask) {$null = Start-ScheduledTask -TaskName $NameScheduledTask}
        else {Throw 'ERROR: Failed to create scheduled task.'}
    #endregion Create Scheduled Task running PS1 using PowerShell.exe - Every 15 Minutes




    ###########################################################
    ### Done
    Write-Output -InputObject ('{0}Done.' -f ("`r`n`r`n"))    
#endregion Main



################################################
#endregion Your Code Here
################################################   
#region    Don't touch this
}
Catch {
    # Construct Message
    ## Generic 
    $ErrorMessage = [string]$('{0}Finished with errors:' -f ("`r`n"))
    $ErrorMessage += [string]$('{0}# Exception:{0}{1}' -f ("`r`n",$_.'Exception'))
    ## Dynamically add info to the error message
    foreach ($ParentProperty in [string[]]$($_ | Get-Member -MemberType 'Property' | Select-Object -ExpandProperty 'Name')) {
        if ($_.$ParentProperty) {
            $ErrorMessage += ('{0}# {1}:' -f ("`r`n",$ParentProperty))
            foreach ($ChildProperty in [string[]]$($_.$ParentProperty | Get-Member -MemberType 'Property' | Select-Object -ExpandProperty 'Name')) {
                ### Build ErrorValue
                $ErrorValue = [string]::Empty
                if ($_.$ParentProperty.$ChildProperty -is [System.Collections.IDictionary]) {
                    foreach ($Name in [string[]]$($_.$ParentProperty.$ChildProperty.GetEnumerator().'Name')) {
                        $ErrorValue += ('{0} = {1}{2}' -f ($Name,[string]$($_.$ParentProperty.$ChildProperty.$Name),"`r`n"))
                    }
                }
                else {
                    $ErrorValue = [string]$($_.$ParentProperty.$ChildProperty)
                }
                if (-not[string]::IsNullOrEmpty($ErrorValue)) {
                    $ErrorMessage += ('{0}## {1}\{2}:{0}{3}' -f ("`r`n",$ParentProperty,$ChildProperty,$ErrorValue.Trim()))
                }
            }
        }
    }
    ## Last exit code
    if (-not[string]::IsNullOrEmpty($LASTEXITCODE)) {
        $ErrorMessage += ('{0}# Last exit code:{0}{1}' -f ("`r`n",$LASTEXITCODE))
    }
    # Write Error Message
    Write-Error -Message $ErrorMessage -ErrorAction 'Continue'
}
Finally {
    # Unload Users' Registry Profiles (NTUSER.DAT) if any were loaded
    if ($Script:BoolIsSystem -and $BoolWriteToHKCUFromSystem -and ([string[]]@($RegistryLoadedProfiles | Where-Object -FilterScript {-not([string]::IsNullOrEmpty($_))})).'Count' -gt 0) {
        # Close Regedit.exe if running, can't unload hives otherwise
        $null = Get-Process -Name 'regedit' -ErrorAction 'SilentlyContinue' | ForEach-Object -Process {Stop-Process -InputObject $_ -ErrorAction 'SilentlyContinue'}

        # Get all logged in users
        $SIDsLoggedInUsers = [string[]]$(([string[]]@(Get-Process -Name 'explorer' -IncludeUserName | Select-Object -ExpandProperty 'UserName' -Unique | ForEach-Object -Process {Try{[System.Security.Principal.NTAccount]::new(($_)).Translate([System.Security.Principal.SecurityIdentifier]).'Value'}Catch{}} | Where-Object -FilterScript {-not([string]::IsNullOrEmpty($_))}),[string]$([System.Security.Principal.WindowsIdentity]::GetCurrent().'User'.'Value')) | Select-Object -Unique)

        foreach ($SID in $RegistryLoadedProfiles) {
            # If SID is found in $SIDsLoggedInUsers - Don't Unload Hive
            if ([bool]$(([string[]]@($SIDsLoggedInUsers | ForEach-Object -Process {$_.Trim().ToUpper()})).Contains($SID.Trim().ToUpper()))) {
                Write-Output -InputObject ('User with SID "{0}" is currently logged in, will not unload registry hive.' -f ($SID))
            }
            # If SID is not found in $SIDsLoggedInUsers - Unload Hive
            else {
                $PathUserHive = [string]('Registry::HKEY_USERS\{0}' -f ($SID))
                $null = Start-Process -FilePath ('{0}\reg.exe' -f ([string]$([system.environment]::SystemDirectory))) -ArgumentList ('UNLOAD "{0}"' -f ($PathUserHive)) -WindowStyle 'Hidden' -Wait

                # Check success
                if (Test-Path -Path ('Registry::{0}' -f ($PathUserHive)) -ErrorAction 'SilentlyContinue') {
                    Write-Output -InputObject ('ERROR: Failed to unload user registry hive "{0}".' -f ($PathUserHive)) -ErrorAction 'Continue'
                }
                else {
                    Write-Output -InputObject ('Successfully unloaded user registry hive "{0}".' -f ($PathUserHive))
                }
            }
        }
    }
    
    # Stop Transcript
    Stop-Transcript
}
#endregion Don't touch this