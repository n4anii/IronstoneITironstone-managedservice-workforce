<#

.SYNOPSIS
    Installs PowerShell script "Enable-BitLocker.ps1", creates Scheduled Task that runs it.

.DESCRIPTION


.NOTES
    * In Intune, remember to set "Run this script using the logged in credentials"  according to the $DeviceContext variable.
        * Intune -> Device Configuration -> PowerShell Scripts -> $NameScriptFull -> Properties -> "Run this script using the logged in credentials"
        * DEVICE (Local System) or USER (Logged in user).
    * Only edit $NameScript and add your code in the #region Your Code Here.
    * You might want to touch "Settings - PowerShell - Output Preferences" for testing / development. 
        * $VerbosePreference, eventually $DebugPreference, to 'Continue' will print much more details.

#>


# Script Variables
$NameScript    = [string] 'Install-IronTrigger'
$DeviceContext = [bool]   $true

# Settings - PowerShell - Output Preferences
$DebugPreference       = 'SilentlyContinue'
$VerbosePreference     = 'SilentlyContinue'
$WarningPreference     = 'Continue'

#region    Don't Touch This
# Settings - PowerShell - Interaction
$ConfirmPreference     = 'None'
$InformationPreference = 'SilentlyContinue'
$ProgressPreference    = 'SilentlyContinue'

# Settings - PowerShell - Behaviour
$ErrorActionPreference = 'Continue'

# Dynamic Variables - Process & Environment
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'NameScriptFull' -Value ([string]('{0}_{1}' -f ($(if($DeviceContext){'Device'}else{'User'}),$NameScript)))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'NameScriptVerb' -Value ([string]$NameScript.Split('-')[0])
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'NameScriptNoun' -Value ([string]$NameScript.Split('-')[-1])
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrArchitectureProcess' -Value ([string]$(if([System.Environment]::Is64BitProcess){'64'}else{'32'}))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrArchitectureOS' -Value ([string]$(if([System.Environment]::Is64BitOperatingSystem){'64'}else{'32'}))

# Dynamic Variables - User
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrUserNameRunningAs' -Value ([string]$([System.Security.Principal.WindowsIdentity]::GetCurrent().Name))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrSIDRunningAs' -Value ([string]$([System.Security.Principal.WindowsIdentity]::GetCurrent().User.Value))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'BoolIsAdmin'  -Value ([bool]$([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'BoolIsSystem' -Value ([bool]$($Script:StrSIDRunningAs -eq ([string]('S-1-5-18'))))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'BoolIsCorrectUser' -Value ([bool]$(if($Script:DeviceContext -and $Script:BoolIsSystem){$true}elseif(-not($DeviceContext -and $Script:BoolIsSystem)){$true}else{$false}))

# Dynamic Variables - Logging
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'Timestamp' -Value ([string]$([datetime]::Now.ToString('yyMMdd-HHmmssffff')))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'PathDirLog' -Value ([string]$('{0}\IronstoneIT\Intune\DeviceConfiguration\' -f ([string]$(if($BoolIsSystem){$env:ProgramW6432}else{[System.Environment]::GetEnvironmentVariable('AppData')}))))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'PathFileLog' -Value ([string]$('{0}{1}-{2}bit-{3}.txt' -f ($Script:PathDirLog,$Script:NameScriptFull,$Script:StrArchitectureProcess,$Script:Timestamp)))

# Start Transcript
if (-not(Test-Path -Path $Script:PathDirLog)) {$null = New-Item -ItemType 'Directory' -Path $Script:PathDirLog -ErrorAction 'Stop'}
Start-Transcript -Path $Script:PathFileLog -ErrorAction 'Stop'


# Wrap in Try/Catch, so we can always end the transcript
Try {
    # Output User Info, Exit if not $BoolIsCorrectUser
    Write-Output -InputObject ('Running as user "{0}" ({1}). Has admin privileges? {2}. $DeviceContext = {3}. Running as correct user? {4}.' -f ($Script:StrUserNameRunningAs,$Script:StrSIDRunningAs,$Script:BoolIsAdmin.ToString(),$Script:DeviceContext.ToString(),$Script:BoolIsCorrectUser.ToString()))
    if (-not($Script:BoolIsCorrectUser)){Throw 'Not running as correct user!'; Break}


    # Output Process and OS Architecture Info
    Write-Output -InputObject ('PowerShell is running as a {0} bit process on a {1} bit OS.' -f ($Script:StrArchitectureProcess,$Script:StrArchitectureOS))


    # If OS is 64 bit, and PowerShell got launched as x86, relaunch as x64
    if ([System.Environment]::Is64BitOperatingSystem -and -not [System.Environment]::Is64BitProcess) {
        write-Output -InputObject (' * Will restart this PowerShell session as x64.')
        if ($myInvocation.Line) {& ('{0}\sysnative\WindowsPowerShell\v1.0\powershell.exe' -f ($env:windir)) -NonInteractive -NoProfile $myInvocation.Line}
        else {& ('{0}\sysnative\WindowsPowerShell\v1.0\powershell.exe' -f ($env:windir)) -NonInteractive -NoProfile -File ('{0}' -f ($myInvocation.InvocationName)) $args}
        exit $LASTEXITCODE
    }

    
    #region    Get SID and "Domain\Username" for Intune User
        # If running in Device Context as "NT Authority\System"
        if ($DeviceContext -and $Script:BoolIsSystem) {
            # Help Variables
            $Script:RegistryLoadedProfiles = [string[]]@()
            $Local:SID                     = [string]::Empty
            $Local:LengthInterval          = [byte[]]@(40 .. 80)


            # Load User Profiles NTUSER.DAT (Registry) that is not available from current context
            $PathProfileList = [string]('Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProfileList')
            $SIDsProfileList = [string[]]@(Get-ChildItem -Path $PathProfileList -Recurse:$false | Select-Object -ExpandProperty 'Name' | ForEach-Object -Process {$_.Split('\')[-1]} | Where-Object -FilterScript {$_ -like 'S-1-12-*'})
            foreach ($SID in $SIDsProfileList) {
                if (Test-Path -Path ('Registry::HKEY_USERS\{0}' -f ($SID)) -ErrorAction 'SilentlyContinue') {
                    Write-Output -InputObject ('User with SID "{0}" is already logged in and/or NTUSER.DAT is loaded.' -f ($SID))
                }
                else {
                    Write-Output -InputObject ('User with SID "{0}" is not logged in, thus NTUSER.DAT is not loaded into registry.' -f ($SID))
                    
                    # Get User Directory
                    $PathUserDirectory = [string]$(Get-ItemProperty -Path ('{0}\{1}' -f ($PathProfileList,$SID)) -Name 'ProfileImagePath' | Select-Object -ExpandProperty 'ProfileImagePath')
                    if ([string]::IsNullOrEmpty($PathUserDirectory)) {
                        Throw ('ERROR: No User Directory was found for user with SID "{0}".' -f ($SID))
                    }

                    # Get User Registry File, NTUSER.DAT
                    $PathFileUserRegistry = ('{0}\NTUSER.DAT' -f ($PathUserDirectory))
                    if (-not(Test-Path -Path $PathFileUserRegistry)) {
                        Throw ('ERROR: "{0}" does not exist.' -f ($PathFileUserRegistry))
                    }

                    # Load NTUSER.DAT
                    $null = Start-Process -FilePath ('{0}\reg.exe' -f ([string]([system.environment]::SystemDirectory))) -ArgumentList ('LOAD "HKEY_USERS\{0}" "{1}"' -f ($SID,$PathFileUserRegistry)) -WindowStyle 'Hidden' -Wait
                    if (Test-Path -Path ('Registry::HKEY_USERS\{0}' -f ($SID))) {
                        Write-Output -InputObject ('{0}Successfully loaded "{1}".' -f ("`t",$PathFileUserRegistry))
                        $RegistryLoadedProfiles += @($SID)
                    }
                    else {
                        Throw ('ERROR: Failed to load registry hive for SID "{0}", NTUSER.DAT location "{1}".' -f ($SID,$PathFileUserRegistry))
                    }
                }
            }


            # Get Intune User Information from Registry
            $IntuneUser = [PSCustomObject]([PSCustomObject[]]@(
                foreach ($x in [string[]]@(Get-ChildItem -Path 'Registry::HKEY_USERS' -Recurse:$false -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'Name' | ForEach-Object {$_.Split('\')[-1]} | Where-Object {[bool]$($_ -like 'S-1-12-*') -and [bool]$(Test-Path -Path ('Registry::HKEY_USERS\{0}\Software\IronstoneIT\Intune\UserInfo' -f ($_)))})) {
                    [PSCustomObject]@{
                        'IntuneUserSID' =[string](Get-ItemProperty -Path ('Registry::HKEY_USERS\{0}\Software\IronstoneIT\Intune\UserInfo' -f ($x)) -Name 'IntuneUserSID' -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'IntuneUserSID');
                        'IntuneUserName'=[string](Get-ItemProperty -Path ('Registry::HKEY_USERS\{0}\Software\IronstoneIT\Intune\UserInfo' -f ($x)) -Name 'IntuneUserName' -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'IntuneUserName');
                        'DateSet'       =Try{[datetime](Get-ItemProperty -Path ('Registry::HKEY_USERS\{0}\Software\IronstoneIT\Intune\UserInfo' -f ($x)) -Name 'DateSet' -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'DateSet')}Catch{[datetime]::MinValue};
                    }
                }) | Where-Object {-not([string]::IsNullOrEmpty($_.IntuneUserSID) -or [string]::IsNullOrEmpty($_.IntuneUserName))} | Sort-Object -Property 'DateSet' -Descending:$false | Select-Object -Last 1
            )


            # Get Intune User SID
            $null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrIntuneUserSID' -Value (
                [string]$(
                    $Local:SID = [string]::Empty
                    # Try by registry values in HKEY_CURRENT_USER\Software\IronstoneIT\Intune\UserInfo
                    if (-not([string]::IsNullOrEmpty([string]($IntuneUser | Select-Object -ExpandProperty 'IntuneUserSID')))) {
                        $Local:SID = [string]($IntuneUser | Select-Object -ExpandProperty 'IntuneUserSID')
                    }

                    # If no valid SID yet, try Registry::HKEY_USERS
                    if ([string]::IsNullOrEmpty($Local:SID) -or (-not($Local:LengthInterval.Contains([byte]$Local:SID.Length))) -or (-not(Test-Path -Path ('Registry::HKEY_USERS\{0}' -f ($Local:SID)) -ErrorAction 'SilentlyContinue'))) {
                        # Get all potential SIDs from Registry::HKEY_USERS
                        $Local:SIDsFromRegistryAll = [string[]]@(Get-ChildItem -Path 'Registry::HKEY_USERS' -Recurse:$false -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'Name' | ForEach-Object {$_.Split('\')[-1]} | Where-Object {$_ -like 'S-1-12-*' -and $_ -notlike '*_Classes' -and $Local:LengthInterval.Contains([byte]$_.Length)})
                        $Local:SID = [string]$(
                            # If none where found - Return emtpy string: Finding SID by registry will not be possible
                            if (@($Local:SIDsFromRegistryAll).Count -le 0) {
                                [string]::Empty
                            }
                            # If only one where found - Return it
                            elseif (@($Local:SIDsFromRegistryAll).Count -eq 1) {
                                [string]([string[]]@($Local:SIDsFromRegistryAll | Select-Object -First 1))
                            }
                            # If multiple where found - Try to filter out unwanted SIDs
                            else {
                                # Try to get all where IronstoneIT folder exist withing HKU (HKCU) registry
                                $Local:SIDs = [string[]]@([string[]]@($Local:SIDsFromRegistryAll) | Where-Object {Test-Path -Path ('Registry::HKEY_USERS\{0}\Software\IronstoneIT' -f ($_))})
                                # If none or more than 1 where found - Try getting only SIDs with AAD joined info in HKU (HKCU) registry
                                if (@($Local:SIDs).Count -le 0 -or @($Local:SIDs).Count -ge 2) {
                                    $Local:SIDs = [string[]]@([string[]]@($Local:SIDsFromRegistryAll) | Where-Object {Test-Path -Path ('Registry::HKEY_USERS\{0}\Software\Microsoft\Windows NT\CurrentVersion\WorkplaceJoin\AADNGC' -f ($_))})
                                }
                                # If none or more than 1 where found - Try matching Tenant ID for AAD joined HKLM with Tenant ID for AAD joined HKU (HKCU)
                                if (@($Local:SIDs).Count -le 0 -or @($Local:SIDs).Count -ge 2) {
                                    if (-not([string]::IsNullOrEmpty(($Local:TenantGUIDFromHKLM = [string]$($x='Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\CloudDomainJoin\JoinInfo'; Get-ItemProperty -Path ('{0}\{1}' -f ($x,[string](Get-ChildItem -Path $x -Recurse:$false -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'Name' | ForEach-Object {$_.Split('\')[-1]}))) -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'TenantId'))))) {
                                        $Local:SIDs = [string[]]@(@($Local:SIDsFromRegistryAll) | Where-Object {$Local:TenantGUIDFromHKLM -eq ([string]$($x=[string]('Registry::HKEY_USERS\{0}\Software\Microsoft\Windows NT\CurrentVersion\WorkplaceJoin\AADNGC' -f ($_)); Get-ItemProperty -Path ('{0}\{1}' -f ($x,([string](Get-ChildItem -Path $x -Recurse:$false -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'Name' | ForEach-Object {$_.Split('\')[-1]})))) -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'TenantDomain'))})
                                    }
                                }
                                if(@($Local:SIDs).Count -eq 1){
                                    [string]([string[]]@($Local:SIDs | Select-Object -First 1))
                                }
                                else{
                                    [string]::Empty
                                }
                            }
                        )
                    }

                    # If no valid SID yet, try by running process "Explorer"
                    if ([string]::IsNullOrEmpty($Local:SID) -or (-not($Local:LengthInterval.Contains([byte]$Local:SID.Length))) -or (-not(Test-Path -Path ('Registry::HKEY_USERS\{0}' -f ($Local:SID)) -ErrorAction 'SilentlyContinue'))) {
                        $Local:SID = [string]$(
                            $Local:UN = [string]([string[]]@(Get-WmiObject -Class 'Win32_Process' -Filter "Name='Explorer.exe'" -ErrorAction 'SilentlyContinue' | ForEach-Object {$($Owner = $_.GetOwner();if($Owner.ReturnValue -eq 0 -and $Owner.Domain -notlike 'nt *' -and $Owner.Domain -notlike 'nt-*'){('{0}\{1}' -f ($Owner.Domain,$Owner.User))})}) | Select-Object -Unique -First 1)
                            if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.Length -lt 3) {
                                $Local:UN = [string]([string[]]@(Get-Process -Name 'explorer' -IncludeUserName -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'UserName' | Where-Object {$_ -notlike 'nt *' -and $_ -notlike 'nt-*'}) | Select-Object -Unique -First 1)
                            }
                            if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.Length -lt 3) {
                                [string]::Empty
                            }
                            else {
                                Try{
                                    $Local:SID = [string]([System.Security.Principal.NTAccount]::new($Local:UN).Translate([System.Security.Principal.SecurityIdentifier]).Value)
                                    if ([string]::IsNullOrEmpty($Local:SID) -or (-not($Local:LengthInterval.Contains([byte]$Local:SID.Length))) -or (-not(Test-Path -Path ('Registry::HKEY_USERS\{0}' -f ($Local:SID)) -ErrorAction 'SilentlyContinue'))) {
                                        [string]::Empty
                                    }
                                    else {
                                        $Local:SID
                                    }
                                }
                                catch{
                                    [string]::Empty
                                }
                            }
                        )
                    }
                
                    # If no valid SID yet, throw error
                    if ([string]::IsNullOrEmpty($Local:SID) -or (-not($Local:LengthInterval.Contains([byte]$Local:SID.Length))) -or (-not(Test-Path -Path ('Registry::HKEY_USERS\{0}' -f ($Local:SID)) -ErrorAction 'SilentlyContinue'))) {
                        Throw 'ERROR: Did not manage to get Intune user SID from SYSTEM context'
                    }

                    # If valid SID, return it
                    else {
                        $Local:SID
                    }         
                )
            )
        

            # Get Intune User Domain\UserName
            $null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrIntuneUserName' -Value (
                [string]$(
                    # Help Variables
                    $Local:UN = [string]::Empty

                    # Try by registry values in HKEY_CURRENT_USER\Software\IronstoneIT\Intune\UserInfo
                    if (-not([string]::IsNullOrEmpty($IntuneUser.IntuneUserName))) {
                        $Local:UN = [string]($IntuneUser.IntuneUserName)
                    }
                
                    # If no valid UN yet, try by convertid $Script:StrIntuneUserSID to "Domain\Username"
                    if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.Length -lt 3 -and (-not([string]::IsNullOrEmpty($Script:StrIntuneUserSID)))) {
                        $Local:UN = [string]$(Try{[System.Security.Principal.SecurityIdentifier]::new($Script:StrIntuneUserSID).Translate([System.Security.Principal.NTAccount]).Value}Catch{[string]::Empty})
                    }

                    # If no valid UN yet, try by Registry::HKEY_USERS\$Script:StrIntuneUserSID\Volatile Environment
                    if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.Length -lt 3-and (-not([string]::IsNullOrEmpty($Script:StrIntuneUserSID)))) {
                        $Local:UN = [string]$(Try{$Local:x = Get-ItemProperty -Path ('Registry::HKEY_USERS\{0}\Volatile Environment' -f ($Script:StrIntuneUserSID)) -Name 'USERDOMAIN','USERNAME' -ErrorAction 'SilentlyContinue';('{0}\{1}' -f ([string]($Local:x | Select-Object -ExpandProperty 'USERDOMAIN'),[string]($Local:x | Select-Object -ExpandProperty 'USERNAME')))}Catch{[string]::Empty})
                    }
                
                    # If no valid UN yet, try by running process Explorer.exe - Method 1
                    if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.Length -lt 3) {
                        $Local:UN = [string]([string[]]@(Get-WmiObject -Class 'Win32_Process' -Filter "Name='Explorer.exe'" -ErrorAction 'SilentlyContinue' | ForEach-Object {$($Owner = $_.GetOwner();if($Owner.ReturnValue -eq 0 -and $Owner.Domain -notlike 'nt *' -and $Owner.Domain -notlike 'nt-*'){('{0}\{1}' -f ($Owner.Domain,$Owner.User))})}) | Select-Object -Unique -First 1)
                    }
                
                    # If no valid UN yet, try by running process Explorer.exe - Method 2
                    if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.Length -lt 3) {
                        $Local:UN = [string]([string[]]@(Get-Process -Name 'explorer' -IncludeUserName -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'UserName' | Where-Object {$_ -notlike 'nt *' -and $_ -notlike 'nt-*'}) | Select-Object -Unique -First 1)
                    }                   

                    # If no valid UN yet, throw Error
                    if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.Length -lt 3) {
                        Throw 'ERROR: Did not manage to get "Domain"\"UserName" for Intune User.'
                    }

                    # If valid UN, return it
                    else {
                        $Local:UN
                    }
                )
            )
        }
        

        # If running in User Context / Not running as "NT Authority\System"
        else {
            $null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrIntuneUserSID' -Value ([string]([System.Security.Principal.WindowsIdentity]::GetCurrent().User.Value))
            $null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrIntuneUserName' -Value ([string]([System.Security.Principal.WindowsIdentity]::GetCurrent().Name))

            #region    Write SID and UserName to HKCU if running in User Context
                # Assets
                $Local:RegPath   = [string]('Registry::HKEY_CURRENT_USER\Software\IronstoneIT\Intune\UserInfo')
                $Local:RegNames  = [string[]]@('IntuneUserSID','IntuneUserName','DateSet')
                $Local:RegValues = [string[]]@($Script:StrIntuneUserSID,$Script:StrIntuneUserName,([string]([datetime]::Now.ToString('o'))))

                # Get Current Info
                $Local:CurrentUserSID     = [string](Get-ItemProperty -Path $Local:RegPath -Name $Local:RegNames[0] -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty $Local:RegNames[0] -ErrorAction 'SilentlyContinue')
                $Local:CurrentUserName    = [string](Get-ItemProperty -Path $Local:RegPath -Name $Local:RegNames[1] -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty $Local:RegNames[1] -ErrorAction 'SilentlyContinue')
                $Local:CurrentUserDateSet = [datetime]$(Try{[datetime](Get-ItemProperty -Path $Local:RegPath -Name $Local:RegNames[2] -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty $Local:RegNames[2] -ErrorAction 'SilentlyContinue')}catch{[datetime]::MinValue})

                # Set Info if any of the values does not match wanted values
                if ($Local:CurrentUserSID -ne $Local:RegValues[0] -or $Local:CurrentUserName -ne $Local:RegValues[1] -or $Local:CurrentUserDateSet -eq [datetime]::MinValue) {      
                    if (-not(Test-Path -Path $Local:RegPath)) {
                        $null = New-Item -Path $Local:RegPath -Force -ErrorAction 'Stop'
                    }

                    foreach ($x in [byte[]]@(0 .. [byte]($Local:RegNames.Length - 1))) {
                        $null = Set-ItemProperty -Path $Local:RegPath -Name $Local:RegNames[$x] -Value $Local:RegValues[$x] -Force -ErrorAction 'Stop'
                    }
                }
            #endregion Write SID and UserName to HKCU if running in User Context            
        }
        Write-Output -InputObject ('Intune User SID "{0}", Username "{1}".' -f ($Script:StrIntuneUserSID,$Script:StrIntuneUserName))
    #endregion Get SID and "Domain\Username" for Intune User



    # End the Initialize Region
    Write-Output -InputObject ('**********************')
#endregion Don't Touch This
################################################
#region    Your Code Here
################################################



#region    Variables
    # Settings
    $Script:ReadOnly           = [bool]   $false

    # Script specific variables
    $Script:NameApp            = [string] $NameScriptNoun
    $Script:NameScheduledTask  = [string] $NameScriptNoun
    $Script:PathDirInstall     = [string] ('{0}\IronstoneIT\{1}' -f ($env:ProgramW6432,$Script:NameApp))

    # Files
    #region Files
        # Enable-BitLockerTrigger.PS1
        #region FilePS1
        $Script:NameFilePS1    = [string] 'Enable_BitLocker.ps1'
        $Script:ContentFilePS1 = [string] ('PCMKUFNTY3JpcHRJbmZvIAouVkVSU0lPTiAxLjQuMC4wCi5HVUlEIGY1MTg3ZTNmLWVkMGEtNGNlMS1iNDM4LWQ4ZjQyMTYxOWNhMyAKLk9SSUdJTkFMIEFVVEhPUiBKYW4gVmFuIE1laXJ2ZW5uZSAKLk1PRElGSUVEIEJZIE9sYXYgUi4gQmlya2VsYW5kLCBTb29yYWogUmFqYWdvcGFsYW4sIFBhdWwgSHVpamJyZWd0cywgUGlldGVyIFdpZ2xldmVuICYgTmlhbGwgQnJhZHkgKHdpbmRvd3Mtbm9vYi5jb20gMjAxNy84LzE3KQouQ09QWVJJR0hUIAouVEFHUyBBenVyZSBJbnR1bmUgQml0TG9ja2VyICAKLkxJQ0VOU0VVUkkgIAouUFJPSkVDVFVSSSAgCi5JQ09OVVJJICAKLkVYVEVSTkFMTU9EVUxFREVQRU5ERU5DSUVTICAKLlJFUVVJUkVEU0NSSVBUUyAgCi5FWFRFUk5BTFNDUklQVERFUEVOREVOQ0lFUyAgCi5SRUxFQVNFTk9URVMKLlRPRE8gCiM+Cgo8IyAKIAouREVTQ1JJUFRJT04gCiBDaGVjayB3aGV0aGVyIEJpdExvY2tlciBpcyBFbmFibGVkLCBpZiBub3QgRW5hYmxlIEJpdExvY2tlciBvbiBBQUQgSm9pbmVkIGRldmljZXMgYW5kIHN0b3JlIHJlY292ZXJ5IGluZm8gaW4gQUFEIAogQWRkZWQgbG9nZ2luZwojPiAKCltjbWRsZXRiaW5kaW5nKCldCnBhcmFtKAogICAgW1BhcmFtZXRlcigpXQogICAgW1ZhbGlkYXRlTm90TnVsbE9yRW1wdHkoKV0KICAgIFtzdHJpbmddICRPU0RyaXZlID0gJGVudjpTeXN0ZW1Ecml2ZQopCltOZXQuU2VydmljZVBvaW50TWFuYWdlcl06OlNlY3VyaXR5UHJvdG9jb2wgPSBbTmV0LlNlY3VyaXR5UHJvdG9jb2xUeXBlXTo6VGxzMTIKCgoKI3JlZ2lvbiBTZXR0aW5ncyBhbmQgVmFyaWFibGVzCiMjIyBTZXR0aW5ncwogICAgIyBJZiBvbiwgd2lsbCBwcm9tcHQgdXNlciB0byByZWJvb3Qgd2l0aCBXaW5kb3dzIEZvcm1zIEdVSS4KICAgIFtib29sXSAkR1VJID0gJGZhbHNlCiAgICAjIElmIG9uLCB3aWxsIHJlbW92ZSBhbGwgZmlsZXMgYWZ0ZXIgZmlyc3Qgc3VjY2Vzcy4KICAgIFtib29sXSAkU2NyaXB0OkJvb2xSZW1vdmVGaWxlc0FmdGVyU3VjY2VzcyA9ICRmYWxzZQogICAgIyBJZiBvZmYsIHdpbGwgY2hhbmdlIHNjaGVkdWxlZCB0YXNrIHRvIHJ1biBvbmNlIGEgZGF5IGF0IDEyOjAwIGFmdGVyIGZpcnN0IHN1Y2Nlc3NmdWxsIHJ1biwgb3IgYWZ0ZXIgMzAgZmFpbGVkIHJ1bnMKICAgICMgSWYgb24sIHdpbGwgZGVsZXRlIHNjaGVkdWxlZCB0YXNrIGFmdGVyIGZpcnN0IHN1Y2Nlc3NmdWxsIHJ1biBhbmQgYWZ0ZXIgMzAgZmFpbGVkIHJ1bnMKICAgIFtib29sXSAkU2NyaXB0OkJvb2xSZW1vdmVTY2hlZHVsZWRUYXNrQWZ0ZXJGaXJzdFN1Y2Nlc3MgPSAkZmFsc2UKIyMjIFZhcmlhYmxlcyAtIEhlbHAKICAgIFtzdHJpbmddICRTY3JpcHQ6T1NEcml2ZUxldHRlciAgICAgPSAkT1NEcml2ZS5UcmltKCc6JykuVG9VcHBlcigpCiMjIyBWYXJpYWJsZXMgLSBTY3JpcHQKICAgIFtzdHJpbmddICRTY3JpcHQ6TmFtZVNjcmlwdCAgICAgICAgPSAnSXJvblRyaWdnZXInCiAgICBbc3RyaW5nXSAkU2NyaXB0OlNjaGVkdWxlZFRhc2tOYW1lID0gJFNjcmlwdDpOYW1lU2NyaXB0LkNsb25lKCkKICAgIFtzdHJpbmddICRTY3JpcHQ6RGlySW5zdGFsbCAgICAgICAgPSAoJ3swfVxQcm9ncmFtIEZpbGVzXElyb25zdG9uZUlUXHsxfVwnIC1mICgkZW52OlN5c3RlbURyaXZlLCRTY3JpcHQ6TmFtZVNjcmlwdCkpCiAgICBbc3RyaW5nXSAkU2NyaXB0OkRpckxvZyAgICAgICAgICAgID0gKCd7MH1cUHJvZ3JhbSBGaWxlc1xJcm9uc3RvbmVJVFxJbnR1bmVcRGV2aWNlQ29uZmlndXJhdGlvblwnIC1mICgkZW52OlN5c3RlbURyaXZlKSkKICAgIFtzdHJpbmddICRTY3JpcHQ6RmlsZUxvZyAgICAgICAgICAgPSAoJ3swfUlyb25UcmlnZ2VyIC0gRW5hYmxlQml0TG9ja2VyLmxvZycgLWYgKCRTY3JpcHQ6RGlyTG9nKSkKICAgIFtzdHJpbmddICRTY3JpcHQ6RmlsZVN0YXRzICAgICAgICAgPSAoJ3swfXN0YXRzLnR4dCcgLWYgKCRTY3JpcHQ6RGlySW5zdGFsbCkpCiMgSGVscCBWYXJpYWJsZXMgKERPTidUIENIQU5HRSkKICAgIFtzdHJpbmddICRTY3JpcHQ6Q29tcHV0ZXJOYW1lICAgICAgPSBbc3RyaW5nXSAkQ29tcHV0ZXJOYW1lID0gQChbc3RyaW5nXSgkZW52OkNPTVBVVEVSTkFNRSkuVHJpbSgpLFtzdHJpbmddKFtTeXN0ZW0uRW52aXJvbm1lbnRdOjpNYWNoaW5lTmFtZSkuVHJpbSgpIC1uZSBbc3RyaW5nXTo6RW1wdHkpWzBdCiAgICBbYm9vbF0gICAkU2NyaXB0OkJvb2xEaWRBbnl0aGluZ0NoYW5nZVRoaXNSdW50aW1lID0gJGZhbHNlCiAgICBbU3RyaW5nW11dICRTY3JpcHQ6Qml0TG9ja2VyVm9sdW1lRW5jcnlwdGlvblN0YXR1c2VzID0gQCgnRnVsbHlEZWNyeXB0ZWQnLCdFbmNyeXB0aW9uSW5Qcm9ncmVzcycsJ0Z1bGx5RW5jcnlwdGVkJykKI2VuZHJlZ2lvbiBTZXR0aW5ncyBhbmQgVmFyaWFibGVzCgoKCiNyZWdpb24gRnVuY3Rpb25zCiAgICAjcmVnaW9uIExvZ2dpbmcgYW5kIE91dHB1dAogICAgICAgICNyZWdpb24gTG9nV3JpdGUKICAgICAgICBGdW5jdGlvbiBMb2dXcml0ZSB7CiAgICAgICAgICAgIFBhcmFtICgKICAgICAgICAgICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJHRydWUpXQogICAgICAgICAgICAgICAgW1ZhbGlkYXRlTm90TnVsbE9yRW1wdHkoKV0KICAgICAgICAgICAgICAgIFtzdHJpbmddJExvZ1N0cmluZwogICAgICAgICAgICApCgogICAgICAgICAgICAjIENyZWF0ZSB2YXJpYWJsZXMKICAgICAgICAgICAgW3N0cmluZ10gJERhdGVUaW1lICA9IFtTeXN0ZW0uRGF0ZVRpbWVdOjpOb3cuVG9TdHJpbmcoJ3l5TU1kZCBISDptbTpzczpmZicpCiAgICAgICAgICAgIFtzdHJpbmddICRMb2dTdHJpbmcgPSAoJ3swfSB7MX0nIC1mICgkRGF0ZVRpbWUsJExvZ1N0cmluZykpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEFkZCBjb250ZW50IHRvIGxvZyBmaWxlCiAgICAgICAgICAgIEFkZC1jb250ZW50IC1QYXRoICRTY3JpcHQ6RmlsZUxvZyAtVmFsdWUgJExvZ1N0cmluZyAtRW5jb2RpbmcgJ3V0ZjgnCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE91dHB1dCBjb250ZW50IHRvIGNvbnNvbGUKICAgICAgICAgICAgV3JpdGUtT3V0cHV0IC1JbnB1dE9iamVjdCAkTG9nU3RyaW5nCiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gTG9nV3JpdGUKCiAgICAgICAgI3JlZ2lvbiBMb2dFcnJvcnMKICAgICAgICBGdW5jdGlvbiBMb2dFcnJvcnMgewogICAgICAgICAgICBMb2dXcml0ZSAoJ0NhdWdodCBhbiBleGNlcHRpb246JykKICAgICAgICAgICAgTG9nV3JpdGUgKCdFeGNlcHRpb24gVHlwZTogICAgezB9JyAtZiAoJF8uRXhjZXB0aW9uLkdldFR5cGUoKS5GdWxsTmFtZSkpCiAgICAgICAgICAgIExvZ1dyaXRlICgnRXhjZXB0aW9uIE1lc3NhZ2U6IHswfScgLWYgKCRfLkV4Y2VwdGlvbi5NZXNzYWdlKSkKICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBMb2dFcnJvcnMKCgogICAgICAgICNyZWdpb24gV3JpdGUtU3RhdHMKICAgICAgICAjIFdyaXRlLVN0YXRzOiBPdXRwdXRzIGN1cnJlbnQgc3RhdHVzIG9mIHZhcmlvdXMgYm9vbGVhbnMgYW5kIG90aGVyIG1lYXN1cmVtZW50cwogICAgICAgIEZ1bmN0aW9uIFdyaXRlLVN0YXRzIHsgICAgCiAgICAgICAgICAgIFBhcmFtKAogICAgICAgICAgICAgICAgW3BhcmFtZXRlcihNYW5kYXRvcnk9JGZhbHNlKV0KICAgICAgICAgICAgICAgIFtib29sXSAkUHJldmlvdXNPbmx5ID0gJGZhbHNlCiAgICAgICAgICAgICkKICAgICAgICAgICAgIyBHZW5lcmFsCiAgICAgICAgICAgIGlmICgkUHJldmlvdXNPbmx5KSB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1J1bnM6IHswfSB8IEhhcyBJcm9uVHJpZ2dlciBoYWQgYSBzdWNjZXNzZnVsbCBydW4gYWxyZWFkeT8gezF9JyAtZiAoJFNjcmlwdDpDb3VudFJ1bnMsJFNjcmlwdDpJc0ZpbmlzaGVkMXN0VGltZSkpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgT1MgRHJpdmUKICAgICAgICAgICAgTG9nV3JpdGUgKCdPUyBkcml2ZSAoezB9KSB8IEVuY3J5cHRlZDogezF9IHwgUmVjb3ZlcnkgUGFzc3dvcmRzIHByZXNlbnQ6IHsyfSB8IEJhY2t1cCB0byBPbmVEcml2ZTogezN9IHwgQmFja3VwIHRvIEF6dXJlQUQ6IHs0fScgLWYgKCRPU0RyaXZlLCRTY3JpcHQ6SXNFbmNyeXB0ZWQsJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdywkU2NyaXB0OklzQmFja3VwT0QsJFNjcmlwdDpJc0JhY2t1cEFBRCkpCiAgICAgICAgICAgIGlmICgtbm90KCRQcmV2aW91c09ubHkpKSB7CiAgICAgICAgICAgICAgICBMb2d3cml0ZSAoJ09TIGRyaXZlICh7MH0pIHwgVm9sdW1lU3RhdHVzOiB7MX0gfCBQcm90ZWN0aW9uU3RhdHVzOiB7Mn0nIC1mICgkT1NEcml2ZSwkU2NyaXB0OlZvbHVtZUVuY3J5cHRpb25TdGF0dXMsJFNjcmlwdDpWb2x1bWVQcm90ZWN0aW9uU3RhdHVzKSkgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICgkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXKSB7CiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdPUyBkcml2ZSAoezB9KSB8IFByZXNlbmNlIG9mIEJpdExvY2tlciBLZXlQcm90ZWN0b3IgfCBUUE06IHsxfSB8IFJlY292ZXJ5UGFzc3dvcmQ6IHsyfScgLWYgKCRPU0RyaXZlLCRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMF0sJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1sxXSkpCiAgICAgICAgICAgICAgICAgICAgaWYgKCRTY3JpcHQ6Vm9sdW1lRW5jcnlwdGlvblN0YXR1c1sxXSkgewogICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ09TIGRyaXZlICh7MH0pIHwgezF9JyAtZiAoJE9TRHJpdmUsKFdyaXRlLVJlY292ZXJ5UGFzc3dvcmQpKSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBPdGhlciBmaXhlZCBkcml2ZXMgd2l0aCBhIGRyaXZlIGxldHRlcgogICAgICAgICAgICAgICAgPCMgI1RPRE8KICAgICAgICAgICAgICAgIGlmICgkU2NyaXB0Ok90aGVyRW5jcnlwdGVkRHJpdmVzKSB7CiAgICAgICAgICAgICAgICAgICAgJFNjcmlwdDpPdGhlckVuY3J5cHRlZERyaXZlcyB8IEZvckVhY2gtT2JqZWN0IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKC1ub3QoW3N0cmluZ106OklzTnVsbE9yRW1wdHkoJFNjcmlwdDpPdGhlckVuY3J5cHRlZERyaXZlc1swXSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6RHJpdmVWb2x1bWVTdGF0dXMgPSAoR2V0LVZhcmlhYmxlIC1OYW1lICgnVm9sdW1lezB9RW5jU3RhdHVzJyAtZiAkXykgLVNjb3BlICdTY3JpcHQnKS5WYWx1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgW3N0cmluZ10gJExvY2FsOkRyaXZlUHJvdGVjdGlvblN0YXR1cyA9IChHZXQtVmFyaWFibGUgLU5hbWUgKCdWb2x1bWV7MH1Qcm90ZWN0aW9uU3RhdHVzJyAtZiAkXykgLVNjb3BlICdTY3JpcHQnKS5WYWx1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9nd3JpdGUgKCdTdGF0dXMgZHJpdmUgInswfSIgfCBWb2x1bWVTdGF0dXM6IHsxfSB8IFByb3RlY3Rpb25TdGF0dXM6IHsyfScgLWYgKCRfLCRMb2NhbDpEcml2ZVZvbHVtZVN0YXR1cywkTG9jYWw6RHJpdmVQcm90ZWN0aW9uU3RhdHVzKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtib29sW11dICRMb2NhbDpLZXlQcm90ZWN0b3JUeXBlcyA9IEdldC1CaXRMb2NrZXJLZXlQcm90ZWN0b3JUeXBlcyAtRHJpdmVMZXR0ZXIgJF8KICAgICAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnQml0TG9ja2VyIEtleVByb3RlY3RvciBUeXBlcyBwcmVzZW50IGZvciBkcml2ZSAiezB9Ij8gfCBUUE06IHsxfSB8IFJlY292ZXJ5UGFzc3dvcmQ6IHsyfScgLWYgKCRfLCRMb2NhbDpLZXlQcm90ZWN0b3JUeXBlc1swXSwkTG9jYWw6S2V5UHJvdGVjdG9yVHlwZXNbMV0pKQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSM+CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBXcml0ZS1TdGF0cwoKCiAgICAgICAgI3JlZ2lvbiBXcml0ZS1SZWNvdmVyeVBhc3N3b3JkCiAgICAgICAgIyBXcml0ZS1SZWNvdmVyeVBhc3N3b3JkCiAgICAgICAgRnVuY3Rpb24gV3JpdGUtUmVjb3ZlcnlQYXNzd29yZCB7CiAgICAgICAgICAgIFtieXRlXSAkTG9jYWw6QyA9ICQoaWYoJFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzKXskU2NyaXB0OkNvdW50UmVjb3ZlcnlQYXNzd29yZHN9ZWxzZXswfSkKICAgICAgICAgICAgUmV0dXJuIChbc3RyaW5nXSAoJ3swfSBSZWNvdmVyeSBQYXNzd29yZChzKSBwcmVzZW50LnsxfScgLWYgKCRMb2NhbDpDLCgkKElmKCRMb2NhbDpDIC1nZSAxKXsnezB9ezF9JyAtZiAoImByYG4iLChHZXQtU3RyaW5nUmVjb3ZlcnlQYXNzd29yZHMpKX0pKSkpKQogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIFdyaXRlLVJlY292ZXJ5UGFzc3dvcmQKCgogICAgICAgICNyZWdpb24gR2V0LVN0cmluZ1JlY292ZXJ5UGFzc3dvcmRzCiAgICAgICAgIyBSZXR1cm5zIGEgc3RyaW5nIGNvbnRhaW5pbmcgdGhlIHJlY292ZXJ5IHBhc3N3b3JkcyBmcm9tICRTY3JpcHQ6QXJyYXlSZWNvdmVyeVBhc3N3b3Jkcy4gVXNlZnVsbCBmb3IgcHJpbnRpbmcvIGxvZ2dpbmcvIGJhY2t1cAogICAgICAgIEZ1bmN0aW9uIEdldC1TdHJpbmdSZWNvdmVyeVBhc3N3b3JkcyB7CiAgICAgICAgICAgIFBhcmFtKAogICAgICAgICAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnk9JGZhbHNlKV0KICAgICAgICAgICAgICAgIFtWYWxpZGF0ZU5vdE51bGxPckVtcHR5KCldCiAgICAgICAgICAgICAgICBbc3RyaW5nXSAkRHJpdmVMZXR0ZXIgPSAkT1NEcml2ZQogICAgICAgICAgICApCgogICAgICAgICAgICAjIFZhbGlkYXRlIElucHV0CiAgICAgICAgICAgIFtzdHJpbmddICRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyID0gJERyaXZlTGV0dGVyLlRyaW0oJzonKS5Ub1VwcGVyKCkKICAgICAgICAgICAgaWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyLkxlbmd0aCAtZ3QgMSkgewogICAgICAgICAgICAgICAgVGhyb3cgJ0VSUk9SOiBEcml2ZSBsZXR0ZXIgY2Fubm90IGJlIG1vcmUgdGhhbiBvbmUgbGV0dGVyJwogICAgICAgICAgICB9CgoKICAgICAgICAgICAgIyBDcmVhdGUgdmFyaWFibGUgbmFtZXMKICAgICAgICAgICAgW3N0cmluZ10gJExvY2FsOkFycmF5TmFtZSAgICAgPSAoJ3swfUFycmF5UmVjb3ZlcnlQYXNzd29yZHMnIC1mICgkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlcikpCgoKICAgICAgICAgICAgIyBHZXQgQXJyYXksIGxvb3AgaXQuIElkZWFsbHkgb25seSBvbmUgcHcsIGJ1dCBsb29wIGp1c3QgdG8gYmUgc2FmZS4KICAgICAgICAgICAgW3VpbnQxNl0gJExvY2FsOlRlbXBDb3VudGVyID0gMAogICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6T3V0U3RyID0gW3N0cmluZ106OkVtcHR5CiAgICAgICAgICAgIChHZXQtVmFyaWFibGUgLU5hbWUgJExvY2FsOkFycmF5TmFtZSAtU2NvcGUgJ1NjcmlwdCcgLVZhbHVlT25seSkgfCBGb3JFYWNoLU9iamVjdCB7CiAgICAgICAgICAgICAgICAkTG9jYWw6T3V0U3RyICs9ICgnezB9IHwgS2V5UHJvdGVjdG9ySWQgInsxfSIgfCBSZWNvdmVyeVBhc3N3b3JkICJ7Mn0iJyAtZiAoKCRMb2NhbDpUZW1wQ291bnRlciArPSAxKSwkXy5LZXlQcm90ZWN0b3JJZCwkXy5SZWNvdmVyeVBhc3N3b3JkKSkKICAgICAgICAgICAgICAgIGlmICgkTG9jYWw6VGVtcENvdW50ZXIgLWx0ICgoR2V0LVZhcmlhYmxlIC1OYW1lICRMb2NhbDpBcnJheU5hbWUgLVNjb3BlICdTY3JpcHQnKS5WYWx1ZSkuQ291bnQpIHskTG9jYWw6T3V0U3RyICs9ICJgcmBuIn0KICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICMgUmV0dXJuIHRoZSBzdHJpbmcKICAgICAgICAgICAgUmV0dXJuICRMb2NhbDpPdXRTdHIKICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBHZXQtU3RyaW5nUmVjb3ZlcnlQYXNzd29yZHMKICAgICNlbmRyZWdpb24gTG9nZ2luZyBhbmQgT3V0cHV0CgoKCiAgICAjcmVnaW9uIFJldHVybiBWYWx1ZXMgKFVzZWQgYnkgb3RoZXIgRnVuY3Rpb25zKQogICAgICAgICNyZWdpb24gICAgR2V0LUJpdExvY2tlcktleVByb3RlY3RvclR5cGVzCiAgICAgICAgRnVuY3Rpb24gR2V0LUJvb2xEcml2ZUhhc0JpdExvY2tlclRQTWFuZFBXIHsKICAgICAgICAgICAgPCMKICAgICAgICAgICAgICAgIFJldHVybnMgYSBib29sIGFycmF5LCB3aGVyZSB0aGUgZmlyc3QgcmVwcmVzZW50cyBzdGF0dXMgb2YgVFBNIHByZXNlbmNlLCBhbmQgdGhlIHNlY29uZCBmb3IgUHJvdGVjdGlvbiBQYXNzd29yZAogICAgICAgICAgICAjPgogICAgICAgICAgICBQYXJhbSgKICAgICAgICAgICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5PSRmYWxzZSldCiAgICAgICAgICAgICAgICBbVmFsaWRhdGVOb3ROdWxsT3JFbXB0eSgpXQogICAgICAgICAgICAgICAgW3N0cmluZ10gJERyaXZlTGV0dGVyID0gJE9TRHJpdmUKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBWYWxpZGF0ZSBJbnB1dAogICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlciA9ICREcml2ZUxldHRlci5UcmltKCc6JykuVG9VcHBlcigpCiAgICAgICAgICAgIGlmICgkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlci5MZW5ndGggLWd0IDEpIHsKICAgICAgICAgICAgICAgIFRocm93ICdFUlJPUjogRHJpdmUgbGV0dGVyIGNhbm5vdCBiZSBtb3JlIHRoYW4gb25lIGxldHRlcicKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBHZXQgQml0TG9ja2VyIFZvbHVtZQogICAgICAgICAgICAkTG9jYWw6Qml0TG9ja2VyU3RhdHVzID0gR2V0LUJpdExvY2tlclZvbHVtZSAtTW91bnRQb2ludCAkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlcgogICAgICAgICAgICAKICAgICAgICAgICAgIyBDcmVhdGUgb2JqZWN0IGNvbnRhaW5pbmcgbnVtYmVyIG9mIFJlY292ZXJ5UGFzc3dvcmRzIChJbmRleCA9IDApIGFuZCBUUE0gKEluZGV4ID0gMSkKICAgICAgICAgICAgW3VpbnQxNl0gJExvY2FsOkNvdW50UmVjUGFzcyA9IDAKICAgICAgICAgICAgW3VpbnQxNl0gJExvY2FsOkNvdW50VFBNID0gMAogICAgICAgICAgICAkTG9jYWw6Qml0TG9ja2VyU3RhdHVzLktleVByb3RlY3RvciB8IEZvckVhY2gtT2JqZWN0IHsKICAgICAgICAgICAgICAgIGlmICgkXy5LZXlQcm90ZWN0b3JUeXBlIC1lcSAnUmVjb3ZlcnlQYXNzd29yZCcpIHskTG9jYWw6Q291bnRSZWNQYXNzICs9IDF9CiAgICAgICAgICAgICAgICBlbHNlaWYgKCRfLktleVByb3RlY3RvclR5cGUgLWVxICdUUE0nKSB7JExvY2FsOkNvdW50VFBNICs9IDF9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmV0dXJuIHRoZSBvYmplY3QKICAgICAgICAgICAgcmV0dXJuIChbYm9vbF0gKCRMb2NhbDpDb3VudFRQTSAtZ2UgMSksW2Jvb2xdICgkTG9jYWw6Q291bnRSZWNQYXNzIC1nZSAxKSkKICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBHZXQtQml0TG9ja2VyS2V5UHJvdGVjdG9yVHlwZXMKCgogICAgICAgICNyZWdpb24gICAgR2V0LUFycmF5UmVjb3ZlcnlQYXNzd29yZHMKICAgICAgICAjIFJldHVybnMgYSBBcnJheUxpc3Qgd2l0aCBleGlzdGluZyBQcm90ZWN0aW9uUGFzc3dvcmRzCiAgICAgICAgRnVuY3Rpb24gR2V0LUFycmF5UmVjb3ZlcnlQYXNzd29yZHMgewogICAgICAgICAgICBQYXJhbSgKICAgICAgICAgICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5PSR0cnVlKV0KICAgICAgICAgICAgICAgIFtNaWNyb3NvZnQuQml0TG9ja2VyLlN0cnVjdHVyZXMuQml0TG9ja2VyVm9sdW1lXSAkQml0TG9ja2VyVm9sdW1lCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgR2V0IEJpdExvY2tlciBQcm90ZWN0aW9uUGFzc3dvcmRzCiAgICAgICAgICAgICRMb2NhbDpLZXlQcm90ZWN0b3JTdGF0dXMgICAgID0gJEJpdExvY2tlclZvbHVtZSB8IFNlbGVjdC1PYmplY3QgLUV4cGFuZFByb3BlcnR5IEtleVByb3RlY3RvcgogICAgICAgICAgICAkTG9jYWw6QXJyYXlSZWNvdmVyeVBhc3N3b3JkcyA9IE5ldy1PYmplY3QgTWljcm9zb2Z0LkJpdExvY2tlci5TdHJ1Y3R1cmVzLkJpdExvY2tlclZvbHVtZUtleVByb3RlY3RvcltdICgkTG9jYWw6S2V5UHJvdGVjdG9yU3RhdHVzLkNvdW50IC0gMSkKCiAgICAgICAgICAgICRMb2NhbDpJbmRleENvdW50ID0gW2J5dGVdOjpNaW5WYWx1ZQogICAgICAgICAgICAkTG9jYWw6S2V5UHJvdGVjdG9yU3RhdHVzIHwgRm9yRWFjaC1PYmplY3QgewogICAgICAgICAgICAgICAgaWYgKCRfLktleVByb3RlY3RvclR5cGUgLWVxICdSZWNvdmVyeVBhc3N3b3JkJykgewogICAgICAgICAgICAgICAgICAgICRudWxsID0gJExvY2FsOkFycmF5UmVjb3ZlcnlQYXNzd29yZHNbJExvY2FsOkluZGV4Q291bnQrK10gPSAkXwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJldHVybiB0aGUgb2JqZWN0ICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuICgkTG9jYWw6QXJyYXlSZWNvdmVyeVBhc3N3b3JkcykKICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBHZXQtQXJyYXlSZWNvdmVyeVBhc3N3b3JkcwoKCiAgICAgICAgI3JlZ2lvbiAgICBHZXQtVm9sdW1lVW5pcXVlSUQKICAgICAgICBGdW5jdGlvbiBHZXQtVm9sdW1lVW5pcXVlSUQgewogICAgICAgICAgICBwYXJhbSgKICAgICAgICAgICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5PSR0cnVlKV0KICAgICAgICAgICAgICAgIFtWYWxpZGF0ZU5vdE51bGxPckVtcHR5KCldCiAgICAgICAgICAgICAgICBbc3RyaW5nXSAkRHJpdmVMZXR0ZXIKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBWYWxpZGF0ZSBJbnB1dAogICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlciA9ICREcml2ZUxldHRlci5UcmltKCc6JykuVG9VcHBlcigpCiAgICAgICAgICAgIGlmICgkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlci5MZW5ndGggLWd0IDEpIHsKICAgICAgICAgICAgICAgIFRocm93ICdFUlJPUjogRHJpdmUgbGV0dGVyIGNhbm5vdCBiZSBtb3JlIHRoYW4gb25lIGxldHRlcicKICAgICAgICAgICAgfQoKICAgICAgICAgICAgIyBHZXQgVW5pcXVlIFZvbHVtZQogICAgICAgICAgICByZXR1cm4gW3N0cmluZ10oKEdldC1Wb2x1bWUgLURyaXZlTGV0dGVyICRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyIHwgU2VsZWN0LU9iamVjdCAtRXhwYW5kUHJvcGVydHkgJ1VuaXF1ZUlkJykuU3BsaXQoJ3snKVstMV0uVHJpbSgnfVwnKSkKICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBHZXQtVm9sdW1lVW5pcXVlSUQKCgogICAgICAgICNyZWdpb24gICAgUmVmcmVzaC1CaXRMb2NrZXJWYXJpYWJsZXNGb3JDdXJyZW50Vm9sdW1lCiAgICAgICAgRnVuY3Rpb24gUmVmcmVzaC1CaXRMb2NrZXJWYXJpYWJsZXNGb3JDdXJyZW50Vm9sdW1lIHsKICAgICAgICAgICAgcGFyYW0oCiAgICAgICAgICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeT0kdHJ1ZSldCiAgICAgICAgICAgICAgICBbVmFsaWRhdGVOb3ROdWxsT3JFbXB0eSgpXQogICAgICAgICAgICAgICAgW3N0cmluZ10gJERyaXZlTGV0dGVyCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVmFsaWRhdGUgSW5wdXQKICAgICAgICAgICAgW3N0cmluZ10gJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIgPSAkRHJpdmVMZXR0ZXIuVHJpbSgnOicpLlRvVXBwZXIoKQogICAgICAgICAgICBpZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIuTGVuZ3RoIC1ndCAxKSB7CiAgICAgICAgICAgICAgICBUaHJvdyAnRVJST1I6IERyaXZlIGxldHRlciBjYW5ub3QgYmUgbW9yZSB0aGFuIG9uZSBsZXR0ZXInCiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAjIFZhcmlhYmxlcyB0aGF0cyBhbHdheXMgcHJlc2VudAogICAgICAgICAgICBbc3RyaW5nXSAkU2NyaXB0OlZvbHVtZUVuY3J5cHRpb25TdGF0dXMgICAgID0gR2V0LVZhcmlhYmxlIC1OYW1lICgnezB9Vm9sdW1lRW5jcnlwdGlvblN0YXR1cycgLWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyKSkgLVNjb3BlICdTY3JpcHQnIC1WYWx1ZU9ubHkgLUVycm9yQWN0aW9uICdTdG9wJwogICAgICAgICAgICBbc3RyaW5nXSAkU2NyaXB0OlZvbHVtZVByb3RlY3Rpb25TdGF0dXMgICAgID0gR2V0LVZhcmlhYmxlIC1OYW1lICgnezB9Vm9sdW1lUHJvdGVjdGlvblN0YXR1cycgLWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyKSkgLVNjb3BlICdTY3JpcHQnIC1WYWx1ZU9ubHkgLUVycm9yQWN0aW9uICdTdG9wJwogICAgICAgICAgICAKICAgICAgICAgICAgIyBWYXJpYWJsZXMgdGhhdHMgcHJlc2VudCBvbmx5IGlmIHRoZXJlcyBhdCBsZWFzdCBvbmUgS2V5UHJvdGVjdG9yIGZvciBjdXJyZW50IHZvbHVtZQogICAgICAgICAgICBbYm9vbFtdXSAkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXICAgICAgICAgID0gR2V0LVZhcmlhYmxlIC1OYW1lICgnezB9Vm9sdW1lSGFzVFBNYW5kUFcnIC1mICgkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlcikpIC1TY29wZSAnU2NyaXB0JyAtVmFsdWVPbmx5IC1FcnJvckFjdGlvbiAnU2lsZW50bHlDb250aW51ZScKICAgICAgICAgICAgW3N0cmluZ10gJFNjcmlwdDpWb2x1bWVFbmNyeXB0aW9uUGVyY2VudGFnZSA9IEdldC1WYXJpYWJsZSAtTmFtZSAoJ3swfVZvbHVtZUVuY3J5cHRpb25QZXJjZW50YWdlJyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpKSAtU2NvcGUgJ1NjcmlwdCcgLVZhbHVlT25seSAtRXJyb3JBY3Rpb24gJ1NpbGVudGx5Q29udGludWUnCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFZhcmlhYmxlcyB0aGF0cyBwcmVzZW50IG9ubHkgaWYgY3VycmVudCB2b2x1bWUgaXMgcHJvdGVjdGVkIHdpdGggbWluaW11bSBhIFRQTSBhbmQgYSBSZWNvdmVyeSBQYXNzd29yZAogICAgICAgICAgICAkU2NyaXB0OkFycmF5UmVjb3ZlcnlQYXNzd29yZHMgICAgICAgICAgICAgID0gR2V0LVZhcmlhYmxlIC1OYW1lICgnezB9QXJyYXlSZWNvdmVyeVBhc3N3b3JkcycgLWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyKSkgLVNjb3BlICdTY3JpcHQnIC1WYWx1ZU9ubHkgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJwogICAgICAgICAgICBbYnl0ZV0gJFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzICAgICAgID0gR2V0LVZhcmlhYmxlIC1OYW1lICgnezB9Q291bnRSZWNvdmVyeVBhc3N3b3JkcycgLWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyKSkgLVNjb3BlICdTY3JpcHQnIC1WYWx1ZU9ubHkgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJwogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIFJlZnJlc2gtQml0TG9ja2VyVmFyaWFibGVzRm9yQ3VycmVudFZvbHVtZQoKCiAgICAgICAgI3JlZ2lvbiAgICBDaGVjay1JZkJpdExvY2tlclBXSGFzQ2hhbmdlZAogICAgICAgIEZ1bmN0aW9uIENoZWNrLUlmQml0TG9ja2VyUFdIYXNDaGFuZ2VkIHsKICAgICAgICAgICAgcGFyYW0oCiAgICAgICAgICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeT0kZmFsc2UpXQogICAgICAgICAgICAgICAgW1ZhbGlkYXRlTm90TnVsbE9yRW1wdHkoKV0KICAgICAgICAgICAgICAgIFtzdHJpbmddICREcml2ZUxldHRlciA9ICRPU0RyaXZlCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgSGVscCBWYXJpYWJsZXMKICAgICAgICAgICAgW2Jvb2xdICRMb2NhbDpIYXNDaGFuZ2VkICAgICAgICAgICAgPSAkZmFsc2UKICAgICAgICAgICAgW3N0cmluZ10gJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIgPSAkRHJpdmVMZXR0ZXIuVHJpbSgnOicpLlRvVXBwZXIoKQogICAgICAgICAgICBpZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIuTGVuZ3RoIC1ndCAxKSB7CiAgICAgICAgICAgICAgICBUaHJvdyAnRVJST1I6IERyaXZlIGxldHRlciBjYW5ub3QgYmUgbW9yZSB0aGFuIG9uZSBsZXR0ZXInCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICMgTmFtZSBWYXJpYWJsZXMKICAgICAgICAgICAgW3N0cmluZ10gJExvY2FsOk5hbWVBcnJheSAgICAgID0gKCd7MH1BcnJheVJlY292ZXJ5UGFzc3dvcmRzJyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpKQogICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6Vm9sdW1lVW5pcXVlSUQgPSBHZXQtVm9sdW1lVW5pcXVlSUQgLURyaXZlTGV0dGVyICRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyCiAgICAgICAgICAgIFtzdHJpbmddICRMb2NhbDpOYW1lRmlsZSAgICAgICA9ICgnezB9LnR4dCcgLWYgKCRWb2x1bWVVbmlxdWVJRCkpCiAgICAgICAgICAgCiAgICAgICAgICAgICMgR2V0IFZhcmlhYmxlcwogICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6UGF0aERpciAgPSAoJ3swfXsxfScgLWYgKCRTY3JpcHQ6RGlySW5zdGFsbCwnQmFja3VwS2V5c1wnKSkKICAgICAgICAgICAgW3N0cmluZ10gJExvY2FsOlBhdGhGaWxlID0gKCd7MH17MX0nIC1mICgkTG9jYWw6UGF0aERpciwkTG9jYWw6TmFtZUZpbGUpKQogICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6Tm93S2V5UHJvdGVjdG9ySUQgPSAoKEdldC1WYXJpYWJsZSAtTmFtZSAkTG9jYWw6TmFtZUFycmF5IC1TY29wZSAnU2NyaXB0JykuVmFsdWUpLktleVByb3RlY3RvcklECiAgICAgICAgICAgIFtzdHJpbmddICRMb2NhbDpOb3dSZWNvdmVyeVBhc3N3b3JkID0gKChHZXQtVmFyaWFibGUgLU5hbWUgJExvY2FsOk5hbWVBcnJheSAtU2NvcGUgJ1NjcmlwdCcpLlZhbHVlKS5SZWNvdmVyeVBhc3N3b3JkCgoKICAgICAgICAgICAgIyBHZXQgc3RhdHMKICAgICAgICAgICAgaWYgKC1ub3QgKFRlc3QtUGF0aCAtUGF0aCAkTG9jYWw6UGF0aEZpbGUpKSB7CiAgICAgICAgICAgICAgICAkTG9jYWw6SGFzQ2hhbmdlZCA9ICR0cnVlCiAgICAgICAgICAgICAgICBpZiAoLW5vdChUZXN0LVBhdGggLVBhdGggJExvY2FsOlBhdGhEaXIgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJykpIHsKICAgICAgICAgICAgICAgICAgICAkbnVsbCA9IE5ldy1JdGVtIC1QYXRoICRMb2NhbDpQYXRoRGlyIC1JdGVtVHlwZSBEaXJlY3RvcnkgLUZvcmNlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBbc3RyaW5nW11dICRMb2NhbDpJbnB1dFN0cmluZyA9IChHZXQtQ29udGVudCAtUGF0aCAkTG9jYWw6UGF0aEZpbGUpLlNwbGl0KFtFbnZpcm9ubWVudF06Ok5ld0xpbmUpCiAgICAgICAgICAgICAgICBpZiAoJD8gLWFuZCAkTG9jYWw6SW5wdXRTdHJpbmcuTGVuZ3RoIC1nZSA3KSB7CiAgICAgICAgICAgICAgICAgICAgW3N0cmluZ10gJExvY2FsOlByZXZLZXlQcm90ZWN0b3JJRCA9ICRMb2NhbDpJbnB1dFN0cmluZ1s1XS5UcmltKCkKICAgICAgICAgICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6UHJldlJlY292ZXJ5UGFzc3dvcmQgPSAkTG9jYWw6SW5wdXRTdHJpbmdbN10uVHJpbSgpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHskTG9jYWw6SGFzQ2hhbmdlZCA9ICR0cnVlfQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgIyBDaGVjayBpZiBjaGFuZ2VkCiAgICAgICAgICAgIGlmICgkTG9jYWw6UHJldktleVByb3RlY3RvcklEKSB7CiAgICAgICAgICAgICAgICBpZiAoJExvY2FsOlByZXZLZXlQcm90ZWN0b3JJRCAtbmUgJExvY2FsOk5vd0tleVByb3RlY3RvcklEKSB7JExvY2FsOkhhc0NoYW5nZWQgPSAkdHJ1ZX0KICAgICAgICAgICAgICAgIGlmICgkTG9jYWw6UHJldlJlY292ZXJ5UGFzc3dvcmQgLW5lICRMb2NhbDpOb3dSZWNvdmVyeVBhc3N3b3JkKSB7JExvY2FsOkhhc0NoYW5nZWQgPSAkdHJ1ZX0KICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICMgV3JpdGUgbmV3IHZhbHVlcyBpZiBjaGFuZ2VkIG9yIGRvZXMgbm90IGV4aXN0CiAgICAgICAgICAgIGlmICgkTG9jYWw6SGFzQ2hhbmdlZCAtb3IgKC1ub3QgKFRlc3QtUGF0aCAtUGF0aCAkTG9jYWw6UGF0aEZpbGUpKSkgewogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciA9IFtzdHJpbmddOjpFbXB0eQogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciArPSAnRHJpdmUvVm9sdW1lIExldHRlciAoTm90IFVuaXF1ZSBpZGVudGlmaWVyKTp7MH0nIC1mICJgcmBuIgogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciArPSAnezB9ezF9JyAtZiAkQ3VycmVudFZvbHVtZUxldHRlciwiYHJgbiIKICAgICAgICAgICAgICAgICRMb2NhbDpPdXRTdHIgKz0gJ1ZvbHVtZSBVbmlxdWVJRCAoTmFtZSBvZiB0aGlzIGZpbGUpOnswfScgLWYgImByYG4iCiAgICAgICAgICAgICAgICAkTG9jYWw6T3V0U3RyICs9ICd7MH17MX0nIC1mICRMb2NhbDpWb2x1bWVVbmlxdWVJRCwiYHJgbiIKICAgICAgICAgICAgICAgICRMb2NhbDpPdXRTdHIgKz0gJ0tleVByb3RlY3RvcklEOnswfScgLWYgImByYG4iCiAgICAgICAgICAgICAgICAkTG9jYWw6T3V0U3RyICs9ICd7MH17MX0nIC1mICRMb2NhbDpOb3dLZXlQcm90ZWN0b3JJRCwiYHJgbiIKICAgICAgICAgICAgICAgICRMb2NhbDpPdXRTdHIgKz0gJ1JlY292ZXJ5IFBhc3N3b3JkOnswfScgLWYgImByYG4iCiAgICAgICAgICAgICAgICAkTG9jYWw6T3V0U3RyICs9ICd7MH17MX0nIC1mICRMb2NhbDpOb3dSZWNvdmVyeVBhc3N3b3JkLCJgcmBuIgogICAgICAgICAgICAgICAgJG51bGwgPSBPdXQtRmlsZSAtRmlsZVBhdGggJExvY2FsOlBhdGhGaWxlIC1FbmNvZGluZyB1dGY4IC1Gb3JjZSAtSW5wdXRPYmplY3QgKCRMb2NhbDpPdXRTdHIpCiAgICAgICAgICAgIH0KCgoKICAgICAgICAgICAgIyBSZXR1cm4gc3RhdHVzCiAgICAgICAgICAgIHJldHVybiAkTG9jYWw6SGFzQ2hhbmdlZCAgICAgIAogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIENoZWNrLUlmQml0TG9ja2VyUFdIYXNDaGFuZ2VkCiAgICAjZW5kcmVnaW9uIFJldHVybiBWYWx1ZXMgKFVzZWQgYnkgb3RoZXIgRnVuY3Rpb25zKQoKCgogICAgI3JlZ2lvbiBTZXQgU2NyaXB0IFdpZGUgVmFyaWFibGVzCiAgICAgICAgI3JlZ2lvbiBHZXQtQml0TG9ja2VyU3RhdHVzCiAgICAgICAgRnVuY3Rpb24gR2V0LUJpdExvY2tlclN0YXR1cyB7CiAgICAgICAgICAgIDwjCiAgICAgICAgICAgICAgICAqIEZpbGxzIHR3byBzdHJpbmdzIHdpdGggY3VycmVudCBWb2x1bWUgRW5jcnlwdGlvbiBTdGF0dXMsIGFuZCBWb2x1bWUgUHJvdGVjdGlvbiBTdGF0dXMuIAogICAgICAgICAgICAgICAgKiBBbHNvIG1ha2VzIGEgYm9vbCBhcnJheSB3aXRoIHRydWUgZmFsc2UgZm9yIHwgMTogVFBNIHByZXNlbnQgfCAyOiBSZWNvdmVyeSBQYXNzd29yZCBQcmVzZW50CiAgICAgICAgICAgICM+CiAgICAgICAgICAgIFBhcmFtKAogICAgICAgICAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnk9JGZhbHNlKV0KICAgICAgICAgICAgICAgIFtWYWxpZGF0ZU5vdE51bGxPckVtcHR5KCldCiAgICAgICAgICAgICAgICBbc3RyaW5nXSAkRHJpdmVMZXR0ZXIgPSAkT1NEcml2ZQogICAgICAgICAgICApCgogICAgICAgICAgICAjIEhlbHAgdmFyaWFibGUKICAgICAgICAgICAgW3N0cmluZ10gJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIgPSAkRHJpdmVMZXR0ZXIuVHJpbSgnOicpLlRvVXBwZXIoKQogICAgICAgICAgICBpZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIuTGVuZ3RoIC1uZSAxKSB7CiAgICAgICAgICAgICAgICBUaHJvdyAnRVJST1I6IERyaXZlIGxldHRlciBjYW5ub3QgYmUgbW9yZSBvciBsZXNzIHRoYW4gb25lIGxldHRlciEnCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICMgR2V0IEJpdExvY2tlciBTdGF0dXMgZm9yIFZvbHVtZQogICAgICAgICAgICBbTWljcm9zb2Z0LkJpdExvY2tlci5TdHJ1Y3R1cmVzLkJpdExvY2tlclZvbHVtZV0gJExvY2FsOkJpdExvY2tlclZvbHVtZVN0YXR1cyA9IEdldC1CaXRMb2NrZXJWb2x1bWUgLU1vdW50UG9pbnQgJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIKICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgQml0TG9ja2VyIFZvbHVtZSBFbmNyeXB0aW9uIFN0YXR1czogRnVsbHlEZWNyeXB0ZWQgfCBFbmNyeXB0aW9uSW5Qcm9ncmVzcyB8IEZ1bGx5RW5jcnlwdGVkCiAgICAgICAgICAgIE5ldy1WYXJpYWJsZSAtTmFtZSAoJ3swfVZvbHVtZUVuY3J5cHRpb25TdGF0dXMnIC1mICgkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlcikpIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgYAogICAgICAgICAgICAgICAgICAgICAgICAgLVZhbHVlIChbc3RyaW5nXSgkTG9jYWw6Qml0TG9ja2VyVm9sdW1lU3RhdHVzIHwgU2VsZWN0LU9iamVjdCAtRXhwYW5kUHJvcGVydHkgJ1ZvbHVtZVN0YXR1cycpKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCaXRMb2NrZXIgVm9sdW1lIFByb3RlY3Rpb24gU3RhdHVzOiBPTiBpZiBFbmNyeXB0aW9uIFBlcmNlbnRhZ2UgPSAxMDAlCiAgICAgICAgICAgIE5ldy1WYXJpYWJsZSAtTmFtZSAoJ3swfVZvbHVtZVByb3RlY3Rpb25TdGF0dXMnIC1mICgkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlcikpIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgYAogICAgICAgICAgICAgICAgICAgICAgICAgLVZhbHVlIChbc3RyaW5nXSgkTG9jYWw6Qml0TG9ja2VyVm9sdW1lU3RhdHVzIHwgU2VsZWN0LU9iamVjdCAtRXhwYW5kUHJvcGVydHkgJ1Byb3RlY3Rpb25TdGF0dXMnKSkKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgPCMgIAogICAgICAgICAgICAgICAgICAgIFZvbHVtZSBjYW4gYmUgJ0Z1bGx5IERlY3J5cHRlZCcsIGJ1dCBzdGlsbCBoYXZlIGEgVFBNIHByZXNlbnQuIAogICAgICAgICAgICAgICAgICAgIFRoaXMgaXMgdXN1YWxseSB0aGUgY2FzZSByaWdodCBhZnRlciBlbmNyeXB0aW9uIGhhcyBzdGFydGVkLiAKICAgICAgICAgICAgIz4KCgogICAgICAgICAgICAjIElmIHRoZXJlIGlzIGEgS2V5UHJvdGVjdG9yIGZvciBnaXZlbiB2b2x1bWUsIGdldCB0aGUgcmVzdCBvZiB0aGUgdmFyaWFibGVzCiAgICAgICAgICAgIGlmICgkTG9jYWw6Qml0TG9ja2VyVm9sdW1lU3RhdHVzLktleVByb3RlY3Rvci5Db3VudCAtZ3QgMCkgewogICAgICAgICAgICAgICAgIyBbMH0gPSBWb2x1bWUgaGFzIFRQTT8gICBbMV0gPSBWb2x1bWUgaGFzIFJlY292ZXJ5IFBhc3N3b3JkPwogICAgICAgICAgICAgICAgTmV3LVZhcmlhYmxlIC1OYW1lICgnezB9Vm9sdW1lSGFzVFBNYW5kUFcnIC1mICgkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlcikpIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIC1WYWx1ZSAoW2Jvb2xbXV0oR2V0LUJvb2xEcml2ZUhhc0JpdExvY2tlclRQTWFuZFBXIC1Ecml2ZUxldHRlciAkQ3VycmVudFZvbHVtZUxldHRlcikpICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEVuY3J5cHRpb24gUGVyY2VudGFnZTogSG93IGxvbmcgaGFzIHRoZSBlbmNyeXB0aW9uIHByb2Nlc3MgY29tZQogICAgICAgICAgICAgICAgTmV3LVZhcmlhYmxlIC1OYW1lICgnezB9Vm9sdW1lRW5jcnlwdGlvblBlcmNlbnRhZ2UnIC1mICgkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlcikpIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIC1WYWx1ZSAoW3N0cmluZ10oJExvY2FsOkJpdExvY2tlclZvbHVtZVN0YXR1cyB8IFNlbGVjdC1PYmplY3QgLUV4cGFuZFByb3BlcnR5ICdFbmNyeXB0aW9uUGVyY2VudGFnZScpLlRvU3RyaW5nKCkpICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBJZiBEcml2ZSBoYXMgVFBNIGFuZCBQVwogICAgICAgICAgICAgICAgaWYgKChHZXQtVmFyaWFibGUgLU5hbWUgKCd7MH1Wb2x1bWVIYXNUUE1hbmRQVycgLWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyKSkgLVNjb3BlICdTY3JpcHQnKS5WYWx1ZVsxXSkgewogICAgICAgICAgICAgICAgICAgICMgTmFtZSB0aGUgdmFyaWFibGVzCiAgICAgICAgICAgICAgICAgICAgW3N0cmluZ10gJExvY2FsOk5hbWVBcnJheVJlY292ZXJ5UGFzc3dvcmRzID0gKCd7MH1BcnJheVJlY292ZXJ5UGFzc3dvcmRzJyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpKQogICAgICAgICAgICAgICAgICAgIFtzdHJpbmddICRMb2NhbDpOYW1lQ291bnRSZWNvdmVyeVBhc3N3b3JkcyA9ICgnezB9Q291bnRSZWNvdmVyeVBhc3N3b3JkcycgLWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyKSkKCiAgICAgICAgICAgICAgICAgICAgIyBHZXQgQXJyYXkgd2l0aCBwcm90ZWN0aW9uIHBhc3N3b3JkcwogICAgICAgICAgICAgICAgICAgIE5ldy1WYXJpYWJsZSAtTmFtZSAkTG9jYWw6TmFtZUFycmF5UmVjb3ZlcnlQYXNzd29yZHMgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSBgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC1WYWx1ZSAoR2V0LUFycmF5UmVjb3ZlcnlQYXNzd29yZHMgLUJpdExvY2tlclZvbHVtZSAkTG9jYWw6Qml0TG9ja2VyVm9sdW1lU3RhdHVzKQoKICAgICAgICAgICAgICAgICAgICAjIENvdW50IEFycmF5UmVjb3ZlcnlQYXNzd29yZHMKICAgICAgICAgICAgICAgICAgICBOZXctVmFyaWFibGUgLU5hbWUgJExvY2FsOk5hbWVDb3VudFJlY292ZXJ5UGFzc3dvcmRzIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtVmFsdWUgKFtieXRlXSgoR2V0LVZhcmlhYmxlIC1OYW1lICRMb2NhbDpOYW1lQXJyYXlSZWNvdmVyeVBhc3N3b3JkcykuVmFsdWUpLkxlbmd0aCkKCiAgICAgICAgICAgICAgICAgICAgIyBHZXQgVm9sdW1lIFVuaXF1ZSBJRCAodG8gY2hlY2sgaWYgcHJvdGVjdGlvbiBwYXNzd29yZCBoYXMgY2hhbmdlZCkKICAgICAgICAgICAgICAgICAgICBOZXctVmFyaWFibGUgLU5hbWUgKCd7MH1Wb2x1bWVVbmlxdWVJRCcgLWYgKCRMb2NhbDpOYW1lVm9sdW1lKSkgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSBgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC1WYWx1ZSAoKEdldC1Wb2x1bWVVbmlxdWVJRCAtRHJpdmVMZXR0ZXIgJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gR2V0LUJpdExvY2tlclN0YXR1cwogICAgI2VuZHJlZ2lvbiBTZXQgU2NyaXB0IFdpZGUgVmFyaWFibGVzCgoKCiAgICAjcmVnaW9uIFJlZ2lzdHJ5IEZ1bmN0aW9ucwogICAgICAgICNyZWdpb24gQ3JlYXRlLUVudlZhcmlhYmxlcwogICAgICAgICMgQ3JlYXRlLUVudlZhcmlhYmxlczogQ3JlYXRlcyB2YXJpYWJsZXMgdXNlZCBieSB0aGUgdHJvdWJsZXNob290ZXIgYXQgdGhlIGJvdHRvbSwgd2hlbiBmYWlsZWQgcnVucyByZWFjaGVzIGEgZ2l2ZW4gbnVtYmVyLiAgCiAgICAgICAgRnVuY3Rpb24gQ3JlYXRlLUVudlZhcmlhYmxlcyB7CiAgICAgICAgICAgICMjIyMgU2NyaXB0IFdpZGUgVmFyaWFibGVzCiAgICAgICAgICAgICMjIFRlbmFudAogICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6UGF0aERpclJlZ1RlbmFudEpvaW5JbmZvQmFzZSA9ICdSZWdpc3RyeTo6SEtFWV9MT0NBTF9NQUNISU5FXFNZU1RFTVxDdXJyZW50Q29udHJvbFNldFxDb250cm9sXENsb3VkRG9tYWluSm9pblxKb2luSW5mbycKICAgICAgICAgICAgW3N0cmluZ10gJExvY2FsOlBhdGhEaXJSZWdUZW5hbnRKb2luSW5mb0Z1bGwgPSAoJ3swfVx7MX0nIC1mICgkTG9jYWw6UGF0aERpclJlZ1RlbmFudEpvaW5JbmZvQmFzZSwKICAgICAgICAgICAgICAgIChHZXQtQ2hpbGRJdGVtIC1QYXRoICRMb2NhbDpQYXRoRGlyUmVnVGVuYW50Sm9pbkluZm9CYXNlIHwgU2VsZWN0LU9iamVjdCAtRXhwYW5kUHJvcGVydHkgTmFtZSkuU3BsaXQoJ1wnKVstMV0KICAgICAgICAgICAgKSkKICAgICAgICAgICAgW3N0cmluZ10gJFNjcmlwdDpOYW1lVGVuYW50ID0gKEdldC1JdGVtUHJvcGVydHkgLVBhdGggJExvY2FsOlBhdGhEaXJSZWdUZW5hbnRKb2luSW5mb0Z1bGwpLlVzZXJFbWFpbC5TcGxpdCgnQCcpWzFdCiAgICAgICAgICAgIFtzdHJpbmddICRTY3JpcHQ6TmFtZVRlbmFudFNob3J0ID0gJFNjcmlwdDpOYW1lVGVuYW50LlNwbGl0KCcuJylbMF0KICAgICAgICAgICAgCiAgICAgICAgICAgICMjIEhhcmR3YXJlIGFuZCBXaW5kb3dzIGluZm8KICAgICAgICAgICAgW3N0cmluZ10gJFNjcmlwdDpDb21wdXRlck1hbnVmYWN0dXJlciA9IFF1ZXJ5LVJlZ2lzdHJ5IC1EaXIgJ0hLTE06XEhBUkRXQVJFXERFU0NSSVBUSU9OXFN5c3RlbVxCSU9TXFN5c3RlbU1hbnVmYWN0dXJlcicKICAgICAgICAgICAgaWYgKC1ub3QoW3N0cmluZ106OklzTnVsbE9yRW1wdHkoJFNjcmlwdDpDb21wdXRlck1hbnVmYWN0dXJlcikpKSB7CiAgICAgICAgICAgICAgICBbc3RyaW5nXSAkU2NyaXB0OkNvbXB1dGVyRmFtaWx5ID0gUXVlcnktUmVnaXN0cnkgLURpciAnSEtMTTpcSEFSRFdBUkVcREVTQ1JJUFRJT05cU3lzdGVtXEJJT1NcU3lzdGVtRmFtaWx5JwogICAgICAgICAgICAgICAgW3N0cmluZ10gJFNjcmlwdDpDb21wdXRlclByb2R1Y3ROYW1lID0gUXVlcnktUmVnaXN0cnkgLURpciAnSEtMTTpcSEFSRFdBUkVcREVTQ1JJUFRJT05cU3lzdGVtXEJJT1NcU3lzdGVtUHJvZHVjdE5hbWUnCiAgICAgICAgICAgICAgICBbc3RyaW5nXSAkU2NyaXB0OldpbmRvd3NFZGl0aW9uID0gUXVlcnktUmVnaXN0cnkgLURpciAnSEtMTTpcU09GVFdBUkVcTWljcm9zb2Z0XFdpbmRvd3MgTlRcQ3VycmVudFZlcnNpb25cUHJvZHVjdE5hbWUnCiAgICAgICAgICAgICAgICBbc3RyaW5nXSAkU2NyaXB0OldpbmRvd3NWZXJzaW9uID0gUXVlcnktUmVnaXN0cnkgLURpciAnSEtMTTpcU09GVFdBUkVcTWljcm9zb2Z0XFdpbmRvd3MgTlRcQ3VycmVudFZlcnNpb25cUmVsZWFzZUlkJwogICAgICAgICAgICAgICAgW3N0cmluZ10gJFNjcmlwdDpXaW5kb3dzVmVyc2lvbiArPSAoJyAoezB9KScgLWYgKFF1ZXJ5LVJlZ2lzdHJ5IC1EaXIgJ0hLTE06XFNPRlRXQVJFXE1pY3Jvc29mdFxXaW5kb3dzIE5UXEN1cnJlbnRWZXJzaW9uXEN1cnJlbnRCdWlsZCcpKQogICAgICAgICAgICB9IAogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICRMb2NhbDpFbnZJbmZvID0gR2V0LVdtaU9iamVjdCAtQ2xhc3MgJ1dpbjMyX0NvbXB1dGVyU3lzdGVtJyB8IFNlbGVjdC1PYmplY3QgLVByb3BlcnR5IE1hbnVmYWN0dXJlcixNb2RlbCxTeXN0ZW1GYW1pbHkgICAgICAgIAogICAgICAgICAgICAgICAgW3N0cmluZ10gJFNjcmlwdDpDb21wdXRlck1hbnVmYWN0dXJlciA9ICRMb2NhbDpFbnZJbmZvLk1hbnVmYWN0dXJlcgogICAgICAgICAgICAgICAgW3N0cmluZ10gJFNjcmlwdDpDb21wdXRlckZhbWlseSA9ICRMb2NhbDpFbnZJbmZvLlN5c3RlbUZhbWlseQogICAgICAgICAgICAgICAgW3N0cmluZ10gJFNjcmlwdDpDb21wdXRlclByb2R1Y3ROYW1lID0gJExvY2FsOkVudkluZm8uTW9kZWwKICAgICAgICAgICAgICAgICRMb2NhbDpPU0luZm8gPSBHZXQtV21pT2JqZWN0IC1DbGFzcyAnV2luMzJfb3BlcmF0aW5nc3lzdGVtJyB8IFNlbGVjdC1PYmplY3QgLVByb3BlcnR5IENhcHRpb24sVmVyc2lvbgogICAgICAgICAgICAgICAgW3N0cmluZ10gJFNjcmlwdDpXaW5kb3dzRWRpdGlvbiA9ICRMb2NhbDpPU0luZm8uQ2FwdGlvbgogICAgICAgICAgICAgICAgW3N0cmluZ10gJFNjcmlwdDpXaW5kb3dzVmVyc2lvbiA9ICRMb2NhbDpPU0luZm8uVmVyc2lvbgogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gQ3JlYXRlLUVudlZhcmlhYmxlcwoKCiAgICAgICAgI3JlZ2lvbiAgICBRdWVyeS1SZWdpc3RyeQogICAgICAgIEZ1bmN0aW9uIFF1ZXJ5LVJlZ2lzdHJ5IHsKICAgICAgICAgICAgUGFyYW0gKFtQYXJhbWV0ZXIoTWFuZGF0b3J5PSR0cnVlKV0gW3N0cmluZ10gJERpcikKICAgICAgICAgICAgJExvY2FsOk91dCA9IFtzdHJpbmddOjpFbXB0eQogICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6S2V5ID0gJERpci5TcGxpdCgne1x9JylbLTFdCiAgICAgICAgICAgIFtzdHJpbmddICRMb2NhbDpEaXIgPSAkRGlyLlJlcGxhY2UoJExvY2FsOktleSwnJykKICAgICAgICAKICAgICAgICAgICAgJExvY2FsOkV4aXN0cyA9IEdldC1JdGVtUHJvcGVydHkgLVBhdGggKCd7MH0nIC1mICREaXIpIC1OYW1lICgnezB9JyAtZiAkTG9jYWw6S2V5KSAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZQogICAgICAgICAgICBpZiAoJEV4aXN0cykgewogICAgICAgICAgICAgICAgJExvY2FsOk91dCA9ICRMb2NhbDpFeGlzdHMuJExvY2FsOktleQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAkTG9jYWw6T3V0CiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gUXVlcnktUmVnaXN0cnkKICAgICNlbmRyZWdpb24gUmVnaXN0cnkgRnVuY3Rpb25zCgoKCiAgICAjcmVnaW9uICAgIEVkaXQtU2NoZWR1bGVkVGFzawogICAgZnVuY3Rpb24gRWRpdC1TY2hlZHVsZWRUYXNrIHsKICAgICAgICBQYXJhbSgKICAgICAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnk9JGZhbHNlKV0KICAgICAgICAgICAgW3N0cmluZ10gJFRhc2tOYW1lID0gJFNjcmlwdDpTY2hlZHVsZWRUYXNrTmFtZQogICAgICAgICkKCiAgICAgICAgJFRhc2sgPSBHZXQtU2NoZWR1bGVkVGFzayAtVGFza05hbWUgJFRhc2tOYW1lIC1FcnJvckFjdGlvbiAnU2lsZW50bHlDb250aW51ZScKCiAgICAgICAgaWYgKCRUYXNrKSB7CiAgICAgICAgICAgIGlmICgkU2NyaXB0OkJvb2xSZW1vdmVTY2hlZHVsZWRUYXNrQWZ0ZXJGaXJzdFN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICRudWxsID0gVW5yZWdpc3Rlci1TY2hlZHVsZWRUYXNrIC1UYXNrTmFtZSAkVGFzayAtQ29uZmlybTokZmFsc2UgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJwogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdSZW1vdmluZyB0aGUgU2NoZWR1bGVkIHRhc2sgInswfSIuIFN1Y2Nlc3M/IHsxfScgLWYgKCRUYXNrLlRhc2tOYW1lLCQ/LlRvU3RyaW5nKCkpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgW0RhdGVUaW1lXSAkTG9jYWw6TmV3U2NoZWRUaW1lID0gW0RhdGVUaW1lXTo6VG9kYXkuQWRkSG91cnMoMTIpICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgJG51bGwgPSBTZXQtU2NoZWR1bGVkVGFzayAtVGFza05hbWUgJFNjcmlwdDpTY2hlZHVsZWRUYXNrTmFtZSAtVHJpZ2dlciAoTmV3LVNjaGVkdWxlZFRhc2tUcmlnZ2VyIC1EYWlseSAtQXQgJExvY2FsOk5ld1NjaGVkVGltZSkgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJwogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdFZGl0aW5nIFNjaGVkdWxlZCB0YXNrICJ7MH0iIHRvIHN0YXJ0IGRhaWx5IGF0IHsxfS4gU3VjY2Vzcz8gezJ9LicgLWYgKCRTY3JpcHQ6U2NoZWR1bGVkVGFza05hbWUsJExvY2FsOk5ld1NjaGVkVGltZS5Ib3VyLlRvU3RyaW5nKCksJD8uVG9TdHJpbmcoKSkpCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIExvZ1dyaXRlICgnRm91bmQgbm8gU2NoZWR1bGVkIFRhc2sgd2l0aCBuYW1lICJ7MH0iLicgLWYgKCRUYXNrTmFtZSkpCiAgICAgICAgfQogICAgfQogICAgI2VuZHJlZ2lvbiBFZGl0LVNjaGVkdWxlZFRhc2sKCgogICAgI3JlZ2lvbiAgICBQcm9tcHQtUmVib290CiAgICBGdW5jdGlvbiBQcm9tcHQtUmVib290IHsKICAgICAgICBbdWludDE2XSAkTG9jYWw6VGltZVRvUmVib290SW5NaW51dGVzID0gNjAgCiAgICAgICAgW3N0cmluZ10gJExvY2FsOlN0clNob3J0TWVzc2FnZSA9ICgnV2luZG93cyB3aWxsIHJlc3RhcnQgaW4gezB9IG1pbnV0ZXMgdG8gZmluaXNoIGRldmljZSBjb25maWd1cmF0aW9uLiBTYXZlIHlvdXIgd29yayEnIC1mICgkTG9jYWw6VGltZVRvUmVib290SW5NaW51dGVzKSkKICAgICAgICAkbnVsbCA9IGNtZC5leGUgL2MgKCdzaHV0ZG93biAvciAvdCB7MH0gL2MgInsxfSInIC1mICgkTG9jYWw6VGltZVRvUmVib290SW5NaW51dGVzKjYwKSwkTG9jYWw6U3RyU2hvcnRNZXNzYWdlKSAyPiYxCiAgICAgICAgaWYgKC1ub3QoJD8pKSB7CiAgICAgICAgICAgICRudWxsID0gY21kLmV4ZSAvYyAoJ3NodXRkb3duIC9hJykgMj4mMQogICAgICAgICAgICAkbnVsbCA9IGNtZC5leGUgL2MgKCdzaHV0ZG93biAvciAvdCB7MH0gL2MgInsxfSInIC1mICgkTG9jYWw6VGltZVRvUmVib290SW5NaW51dGVzKjYwKSwkTG9jYWw6U3RyU2hvcnRNZXNzYWdlKSAyPiYxCiAgICAgICAgfQoKICAgICAgICA8IyBGT1IgRlVUVVJFIEVOSEFOQ0VNRU5UUwogICAgICAgIFtzdHJpbmddICRMb2NhbDpTdHJNZXNzYWdlID0gJ1lvdXIgY29tcHV0ZXIgYXJlIGF3YWl0aW5nIGEgcmVzdGFydDonCiAgICAgICAgJExvY2FsOlN0ck1lc3NhZ2UgKz0gJ3swfSBZb3VyIG9yZ2FuaXphdGlvbiByZXF1aXJlcyB5b3VyIGhhcmQnIC1mICJgcmBuIgogICAgICAgICRMb2NhbDpTdHJNZXNzYWdlICs9ICd7MH0gZHJpdmUgdG8gYmUgZW5jeXB0ZWQuIEluIG9yZGVyIHRvJyAtZiAiYHJgbiIKICAgICAgICAkTG9jYWw6U3RyTWVzc2FnZSArPSAnezB9IGZpbmlzaCB0aGlzIHByb2Nlc3MsIHlvdSBuZWVkIHRvJyAtZiAiYHJgbiIKICAgICAgICAkTG9jYWw6U3RyTWVzc2FnZSArPSAnezB9IHJlc3RhcnQgeW91ciBjb21wdXRlci4gWW91IGNhbicgLWYgImByYG4iCiAgICAgICAgJExvY2FsOlN0ck1lc3NhZ2UgKz0gJ3swfSBlaXRoZXIgZG8gaXQgbWFudWFsbHksIG9yIGl0IHdpbGwnIC1mICJgcmBuIgogICAgICAgICRMb2NhbDpTdHJNZXNzYWdlICs9ICd7MH0gYXV0b21hdGljYWxseSBoYXBwZW4gaW4nIC1mICJgcmBuIgogICAgICAgICRMb2NhbDpTdHJNZXNzYWdlICs9ICd7MH0gezF9IG1pbnV0ZXMuJyAtZiAiYHJgbiIsJExvY2FsOlRpbWVUb1JlYm9vdEluTWludXRlcwogICAgICAgICRMb2NhbDpTdHJNZXNzYWdlICs9ICd7MH17MH0gU0FWRSBZT1VSIFdPUkshJyAtZiAiYHJgbiIKICAgICAgICAjPgogICAgfQogICAgI2VuZHJlZ2lvbiBQcm9tcHQtUmVib290ICAgIAojZW5kcmVnaW9uIEZ1bmN0aW9ucwoKCgojcmVnaW9uIEluaXRpYWxpemUKICAgIExvZ1dyaXRlICgnIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjJykKICAgIExvZ1dyaXRlICgnU3RhcnRpbmcgVHJpZ2dlciBCaXRMb2NrZXIgc2NyaXB0LicpCiAgICBMb2dXcml0ZSAoJyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIycpCiAgICBMb2dXcml0ZSAoJyMjIyBHZXQgc3RhdHMuJykKICAgICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKICAgICMjIEZldGNoIHByZXYgcnVuIHJlc3VsdHMgIyMKICAgICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMgICAgCiAgICBpZiAoLW5vdCAoVGVzdC1QYXRoIC1QYXRoICRTY3JpcHQ6RmlsZVN0YXRzKSkgewogICAgICAgIFt1aW50MTZdICRTY3JpcHQ6Q291bnRSdW5zID0gMAogICAgICAgIFtib29sXSAkU2NyaXB0OklzRmluaXNoZWQxc3RUaW1lID0gW2Jvb2xdICRTY3JpcHQ6SXNFbmNyeXB0ZWQgPSBbYm9vbF0gJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdyA9IFtib29sXSAkU2NyaXB0OklzQmFja3VwT0QgPSBbYm9vbF0gJFNjcmlwdDpJc0JhY2t1cEFBRCA9ICRmYWxzZQogICAgICAgICRTY3JpcHQ6T1NEcml2ZUtleUlEID0gJFNjcmlwdDpPU0RyaXZlUHJvdGVjdGlvblBhc3N3b3JkID0gW3N0cmluZ106OkVtcHR5CiAgICAgICAgTG9nV3JpdGUgKCcjIEZpcnN0IHJ1biEnKQogICAgfQogICAgZWxzZSB7CiAgICAgICAgW1N0cmluZ1tdXSAkSW5wdXRTdHJpbmcgPSAoR2V0LUNvbnRlbnQgLVBhdGggJFNjcmlwdDpGaWxlU3RhdHMpLlNwbGl0KFtFbnZpcm9ubWVudF06Ok5ld0xpbmUpCiAgICAgICAgW3VpbnQxNl0gJFNjcmlwdDpDb3VudFJ1bnMgPSBbdWludDE2XSAkSW5wdXRTdHJpbmdbMF0KICAgICAgICBbYm9vbF0gJFNjcmlwdDpJc0ZpbmlzaGVkMXN0VGltZSA9IFt1aW50MTZdICRJbnB1dFN0cmluZ1sxXQogICAgICAgIFtib29sXSAkU2NyaXB0OklzRW5jcnlwdGVkID0gW3VpbnQxNl0gJElucHV0U3RyaW5nWzJdCiAgICAgICAgW2Jvb2xdICRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cgPSBbdWludDE2XSAkSW5wdXRTdHJpbmdbM10KICAgICAgICBbYm9vbF0gJFNjcmlwdDpJc0JhY2t1cE9EID0gW3VpbnQxNl0gJElucHV0U3RyaW5nWzRdCiAgICAgICAgW2Jvb2xdICRTY3JpcHQ6SXNCYWNrdXBBQUQgPSBbdWludDE2XSAkSW5wdXRTdHJpbmdbNV0KICAgICAgICBbc3RyaW5nXSAkU2NyaXB0Ok9TRHJpdmVLZXlJRCA9IFtzdHJpbmddICRJbnB1dFN0cmluZ1s2XQogICAgICAgIFtzdHJpbmddICRTY3JpcHQ6T1NEcml2ZVByb3RlY3Rpb25QYXNzd29yZCA9IFtzdHJpbmddICRJbnB1dFN0cmluZ1s3XQogICAgICAgIExvZ1dyaXRlICgnIyBQcmV2aW91cyBydW4gcmVzdWx0czonKQogICAgICAgIFdyaXRlLVN0YXRzIC1QcmV2aW91c09ubHkgJHRydWUKICAgIH0KICAgIAoKICAgICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKICAgICMjIyMgR2V0IGN1cnJlbnQgc3RhdHVzICMjIyMKICAgICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMgIAogICAgTG9nV3JpdGUgKCcjIEN1cnJlbnQgc3RhdHVzOicpCiAgICAKICAgICMgQ3VycmVudCBEcml2ZSAoT1MgRHJpdmUpCiAgICAkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlciA9ICRTY3JpcHQ6T1NEcml2ZUxldHRlcgogICAgCiAgICAjIEdldCBDdXJyZW50IFN0YXR1cyBmb3IgT1MgRHJpdmUKICAgIEdldC1CaXRMb2NrZXJTdGF0dXMgLURyaXZlTGV0dGVyICRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyCiAgICBSZWZyZXNoLUJpdExvY2tlclZhcmlhYmxlc0ZvckN1cnJlbnRWb2x1bWUgLURyaXZlTGV0dGVyICRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyCiAgICAKCiAgICBpZiAoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQVykgewogICAgICAgIGlmICgkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzBdKSB7CiAgICAgICAgICAgIFtib29sXSAkU2NyaXB0OklzRW5jcnlwdGVkID0gKCRTY3JpcHQ6Vm9sdW1lRW5jcnlwdGlvblN0YXR1cyAtZXEgJFNjcmlwdDpCaXRMb2NrZXJWb2x1bWVFbmNyeXB0aW9uU3RhdHVzZXNbMl0pCiAgICAgICAgfQogICAgICAgIGlmICgkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzFdKSB7CiAgICAgICAgICAgIFtib29sXSAkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3ID0gKCRTY3JpcHQ6Q291bnRSZWNvdmVyeVBhc3N3b3JkcyAtZXEgMSkKICAgICAgICB9ICAgICAgICAgICAgICAgICAgIAogICAgfQogICAgZWxzZSB7CiAgICAgICAgW2Jvb2xdICRTY3JpcHQ6SXNFbmNyeXB0ZWQgPSBbYm9vbF0gJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdyA9ICRmYWxzZQogICAgfQoKCiAgICAjIE90aGVyIEZpeGVkIERyaXZlcwogICAgI1RPRE8KICAgIDwjCiAgICBbU3RyaW5nW11dICRTY3JpcHQ6Rml4ZWRWb2x1bWVzTGV0dGVycyA9IEAoKEdldC1Wb2x1bWUgfCBgCiAgICAgICAgV2hlcmUtT2JqZWN0IHskXy5Ecml2ZVR5cGUgLWVxICdGaXhlZCcgLWFuZCAoLW5vdChbc3RyaW5nXTo6SXNOdWxsT3JFbXB0eSgkXy5Ecml2ZUxldHRlcikpKX0gfCBgCiAgICAgICAgV2hlcmUtT2JqZWN0IHskXy5Ecml2ZUxldHRlciAtbmUgJE9TRHJpdmUuUmVwbGFjZSgnOicsJycpfSkuRHJpdmVMZXR0ZXIpCiAgICAKICAgICRTY3JpcHQ6Rml4ZWRWb2x1bWVzTGV0dGVycyB8IEZvckVhY2gtT2JqZWN0IHsKICAgICAgICBpZiAoLW5vdChbc3RyaW5nXTo6SXNOdWxsT3JFbXB0eSgkXykpKSB7CiAgICAgICAgICAgIEdldC1CaXRsb2NrZXJTdGF0dXMgLURyaXZlTGV0dGVyICRfCiAgICAgICAgICAgIGlmICgoR2V0LVZhcmlhYmxlIC1OYW1lICgnezB9Q291bnRQcm90ZWN0aW9uS2V5cycgLWYgJF8pIC1TY29wZSAnU2NyaXB0JykuTGVuZ3RoIC1ndCAwKSB7CiAgICAgICAgICAgICAgICBbc3RyaW5nW11dICRTY3JpcHQ6T3RoZXJFbmNyeXB0ZWREcml2ZXMgKz0gQCgkXykKICAgICAgICAgICAgfQogICAgICAgIH0gICAgIAogICAgfSM+CgogICAgV3JpdGUtU3RhdHMKI2VuZHJlZ2lvbiBJbml0aWFsaXplCiAgICAKCgojcmVnaW9uIE1haW4KI3JlZ2lvbiBFbmNyeXB0aW9uCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwojIyMjIEJpdExvY2tlciBFbmNyeXB0aW9uICMjIyMKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCkxvZ1dyaXRlICgnIyMjIEJpdExvY2tlciBFbmNyeXB0aW9uJykKCgoKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwojIEJpdExvY2tlciBFbmNyeXB0aW9uIG9mIE9TIERyaXZlICAjCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKI3JlZ2lvbiBCaXRMb2NrZXIgRW5jcnlwdGlvbiBvZiBPUyBEcml2ZQoKTG9nV3JpdGUgKCcjIEJpdExvY2tlciBFbmNyeXB0aW9uIG9mIE9TIERyaXZlJykKaWYgKCRTY3JpcHQ6SXNFbmNyeXB0ZWQpIHsKICAgIExvZ1dyaXRlICgnT1MgRHJpdmUgaXMgYWxyZWFkeSBmdWxseSBlbmNyeXB0ZWQuJykKfQplbHNlIHsKICAgIFtib29sXSAkU2NyaXB0OkJvb2xEaWRBbnl0aGluZ0NoYW5nZVRoaXNSdW50aW1lID0gJHRydWUKICAgIAogICAgIyBJZiAnRnVsbHlFbmNyeXB0ZWQnLCBhbmQgVFBNIHByZXNlbnQKICAgICMgTWVhbnMgdGhhdCBPUyBEcml2ZSBpcyBzdWNjZXNzZnVsbHkgZW5jcnlwdGVkIHdpdGggQml0TG9ja2VyCiAgICBpZiAoKCRTY3JpcHQ6Vm9sdW1lRW5jcnlwdGlvblN0YXR1cyAtZXEgJFNjcmlwdDpCaXRMb2NrZXJWb2x1bWVFbmNyeXB0aW9uU3RhdHVzZXNbMl0pIC1hbmQgJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1swXSkgewogICAgICAgIExvZ1dyaXRlICgnT1MgRHJpdmUgaXMgZnVsbHkgZW5jcnlwdGVkIScpCiAgICAgICAgJFNjcmlwdDpJc0VuY3J5cHRlZCA9ICR0cnVlCiAgICB9CiAgICAKCiAgICAjIElmICdFbmNyeXB0aW9uSW5Qcm9ncmVzcycgYW5kIFRQTSBwcmVzZW50CiAgICAjIE1lYW5zIGNvbXB1dGVyIGhhcyByZXN0YXJ0ZWQgYWZ0ZXIgQml0TG9ja2VyIGVuY3J5cHRpb24gd2FzIGVuYWJsZWQuIFdhaXRpbmcgZm9yIHRoZSB2b2x1bWUgdG8gZ2V0IGVuY3J5cHRlZAogICAgZWxzZWlmICgkU2NyaXB0OlZvbHVtZUVuY3J5cHRpb25TdGF0dXMgLWVxICRTY3JpcHQ6Qml0TG9ja2VyVm9sdW1lRW5jcnlwdGlvblN0YXR1c2VzWzFdIC1hbmQgJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1swXSkgewogICAgICAgIExvZ1dyaXRlICgnT1MgRHJpdmUgZW5jcnlwdGlvbiBpcyBpbiBwcm9ncmVzczonKQogICAgICAgIExvZ1dyaXRlICgnUmVzdGFydCBoYXZlIHRha2VuIHBsYWNlLCBhbmQgZW5jcnlwdGlvbiBoYXMgc3RhcnRlZC4nKQogICAgICAgIExvZ1dyaXRlICgnT1MgRHJpdmUgRW5jcnlwdGlvbiBQZXJjZW50YWdlOiB7MH0lLicgLWYgKCRTY3JpcHQ6Vm9sdW1lRW5jcnlwdGlvblBlcmNlbnRhZ2UpKQogICAgICAgIExvZ1dyaXRlICgnQ2FuIGNvbnRpbnVlIHRvIGNoZWNrIGlmIFJlY292ZXJ5IFBhc3N3b3JkIGlzIHByZXNlbnQsIGFuZCBiYWNrdXAgaXQuJykKICAgIH0KCgogICAgIyBJZiAnRnVsbHlEcmVjdHlwdGVkJyAgICAgCiAgICBlbHNlaWYgKCRTY3JpcHQ6Vm9sdW1lRW5jcnlwdGlvblN0YXR1cyAtZXEgJFNjcmlwdDpCaXRMb2NrZXJWb2x1bWVFbmNyeXB0aW9uU3RhdHVzZXNbMF0pIHsKICAgICAgICAKICAgICAgICAjIElmICdGdWxseURyZWN0eXB0ZWQnIGJ1dCB0aGVyZSBleGlzdHMgYSBUUE0KICAgICAgICAjIE1lYW5zIHRoYXQgZW5jcnlwdGlvbiBoYXMgc3RhcnRlZCwgYnV0IGNvbXB1dGVyIGlzIGF3YWl0aW5nIHJlc3RhcnQKICAgICAgICBpZiAoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQVyAtYW5kICRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMF0pIHsKICAgICAgICAgICAgTG9nV3JpdGUgKCdPUyBEcml2ZSBFbmNyeXB0aW9uIGhhcyBzdGFydGVkLCBidXQgY29tcHV0ZXIgaGFzIG5vdCBiZWVuIHJlc3RhcnRlZCB5ZXQuJykKICAgICAgICAgICAgTG9nV3JpdGUgKCdPUyBEcml2ZSBFbmNyeXB0aW9uIFBlcmNlbnRhZ2U6IHswfSUuJyAtZiAoJFNjcmlwdDpWb2x1bWVFbmNyeXB0aW9uUGVyY2VudGFnZSkpCiAgICAgICAgICAgIExvZ1dyaXRlICgnQ2FuIGNvbnRpbnVlIHRvIGNoZWNrIGlmIFJlY292ZXJ5IFBhc3N3b3JkIGlzIHByZXNlbnQsIGFuZCBiYWNrdXAgaXQuJykKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIExvZ1dyaXRlICgnT1MgRHJpdmUgaXMgbm90IGVuY3J5cHRlZC4nKQogICAgICAgICAgICBMb2dXcml0ZSAoJ0F0dGVtcHRpbmcgdG8gRW5hYmxlIEJpdExvY2tlciBvbiBPUyBkcml2ZSAoezB9KScgLWYgKCRPU0RyaXZlKSkKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICMgRW5hYmxlIEJpdExvY2tlciB1c2luZyBUUE0KICAgICAgICAgICAgICAgICRudWxsID0gRW5hYmxlLUJpdExvY2tlciAtTW91bnRQb2ludCAkT1NEcml2ZSAtVHBtUHJvdGVjdG9yIC1Vc2VkU3BhY2VPbmx5OiRmYWxzZSAtSGFyZHdhcmVFbmNyeXB0aW9uOiRmYWxzZSAtRXJyb3JBY3Rpb24gJ0NvbnRpbnVlJwogICAgICAgICAgICAgICAgaWYgKCQ/KSB7CiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdTdWNjZXNzZnVsbHkgZW5hYmxlZCBiaXRsb2NrZXIuJykgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0ZhaWxlZCBFbmFibGluZyBCaXRsb2NrZXIgVHBtUHJvdGVjdG9yLCBpdGBzIHByb2JhYmx5IGFscmVhZHkgZW5hYmxlZCcpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gCiAgICAgICAgICAgIGNhdGNoIHsKICAgICAgICAgICAgICAgIExvZ0Vycm9ycwogICAgICAgICAgICAgICAgRW5hYmxlLUJpdExvY2tlciAtTW91bnRQb2ludCAkT1NEcml2ZSAtVHBtUHJvdGVjdG9yIC1Vc2VkU3BhY2VPbmx5OiRmYWxzZSAtSGFyZHdhcmVFbmNyeXB0aW9uOiRmYWxzZSAtRXJyb3JBY3Rpb24gJ1NpbGVudGx5Q29udGludWUnCiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1dpbGwgYXR0ZW1wdCB0byBFbmFibGUgQml0TG9ja2VyIGFueXdheSBhbmQgdGhlbiBjb250aW51ZS4gU3VjY2Vzcz8gezB9JyAtZiAoJD8pKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZpbmFsbHkgewogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdEaWQgd2UgYWN0dWFsbHkgZW5hYmxlIEJpdExvY2tlcj8nKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFJlZnJlc2ggVmFyaWFibGVzCiAgICAgICAgICAgICAgICBHZXQtQml0TG9ja2VyU3RhdHVzIC1Ecml2ZUxldHRlciAkT1NEcml2ZQogICAgICAgICAgICAgICAgUmVmcmVzaC1CaXRMb2NrZXJWYXJpYWJsZXNGb3JDdXJyZW50Vm9sdW1lIC1Ecml2ZUxldHRlciAkT1NEcml2ZQoKICAgICAgICAgICAgICAgICMgQ2hlY2sgcmVzdWx0CiAgICAgICAgICAgICAgICBpZiAoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQVyAtYW5kICRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMF0pIHsKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1RQTSBwcmVzZW50IGZvciBPUyBEcml2ZT8gezB9JyAtZiAoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1swXSkpCiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdQcm9tcHRpbmcgcmVib290LicpCiAgICAgICAgICAgICAgICAgICAgUHJvbXB0LVJlYm9vdAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdFUlJPUiwgbm90IGVuY3J5cHRlZC4gVFBNIG5vdCBwcmVzZW50IGZvciBPUyBEcml2ZScpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAjIElmIHNjZW5hcmlvIGZpdHMgbm9uZSBvZiB0aGUgY2FzZXMgYWJvdmUuLgogICAgZWxzZSB7CiAgICAgICAgTG9nV3JpdGUgKCdOZWl0aGVyICJ7MH0iLCAiezF9IiBvciAiezJ9Ii4nIC1mICgkU2NyaXB0OkJpdExvY2tlclZvbHVtZUVuY3J5cHRpb25TdGF0dXNlc1swXSwkU2NyaXB0OkJpdExvY2tlclZvbHVtZUVuY3J5cHRpb25TdGF0dXNlc1sxXSwkU2NyaXB0OkJpdExvY2tlclZvbHVtZUVuY3J5cHRpb25TdGF0dXNlc1syXSkpCiAgICB9Cn0KI2VuZHJlZ2lvbiBCaXRMb2NrZXIgRW5jcnlwdGlvbiBvZiBPUyBEcml2ZQoKCgojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiMgUHJvdGVjdGlvbiBQYXNzd29yZCBmb3IgT1MgRHJpdmUgICMKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwojcmVnaW9uIFByb3RlY3Rpb24gUGFzc3dvcmQgZm9yIE9TIERyaXZlCgpMb2dXcml0ZSAoJyMgQml0TG9ja2VyIFByb3RlY3Rpb24gUGFzc3dvcmQgZm9yIE9TIERyaXZlJykKIyBJZiAnRnVsbHlFbmNyeXB0ZWQnLCBvciBUTVAgaXMgcHJlc2VudAppZiAoJFNjcmlwdDpJc0VuY3J5cHRlZCAtb3IgKCRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFcgLWFuZCAkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzBdKSkgewogICAgCiAgICAKICAgICMgSWYgd2UncmUgZG9uZSB3aXRoIHJlY292ZXJ5IHBhc3N3b3JkKHMpIGFscmVhZHkKICAgIGlmICgkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3IC1hbmQgKCRTY3JpcHQ6Q291bnRSZWNvdmVyeVBhc3N3b3JkcyAtZXEgMSkpIHsKICAgICAgICBMb2dXcml0ZSAnUmVjb3ZlcnkgUGFzc3dvcmQgZm9yIE9TIERyaXZlIGlzIGFscmVhZHkgcHJlc2VudCcKICAgIH0KICAgIAoKICAgICMgSWYgd2UncmUgbm90IGRvbmUgd2l0aCByZWNvdmVyeSBwYXNzd29yZChzKQogICAgZWxzZSB7ICAgICAgICAKICAgICAgICBbYm9vbF0gJFNjcmlwdDpCb29sRGlkQW55dGhpbmdDaGFuZ2VUaGlzUnVudGltZSA9ICR0cnVlCiAgICAgICAgW2Jvb2xdICRMb2NhbDpTdWNjZXNzID0gJGZhbHNlCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgIyBJZiB0aGVyZSBleGlzdHMgQml0TG9ja2VyIEVuY3J5cHRpb24gUmVjb3ZlcnkgUGFzc3dvcmQgICAgICAgCiAgICAgICAgaWYgKCRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMV0pIHsKICAgICAgICAgICAgCgogICAgICAgICAgICAjIElmIHRoZXJlcyBpcyBfYV8gUHJvdGVjdGlvblBhc3N3b3JkLCB3ZSdyZSBkb25lCiAgICAgICAgICAgIGlmICgkU2NyaXB0OkNvdW50UmVjb3ZlcnlQYXNzd29yZHMgLWVxIDEpIHsKICAgICAgICAgICAgICAgIExvZ1dyaXRlICdPbmx5IGEgcGFzc3dvcmQgcHJlc2VudCcKICAgICAgICAgICAgICAgICRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cgPSAkdHJ1ZQogICAgICAgICAgICAgICAgJExvY2FsOlN1Y2Nlc3MgPSAkdHJ1ZQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgIyBJZiB0aGVyZSBpcyBtdWx0aXBsZSBSZWNvdmVyeVBhc3N3b3Jkcywgd2UgbmVlZCB0byByZW1vdmUgYWxsIGJ1dCBvbmUKICAgICAgICAgICAgZWxzZWlmICgkU2NyaXB0OkNvdW50UmVjb3ZlcnlQYXNzd29yZHMgLWd0IDEpIHsKICAgICAgICAgICAgICAgIExvZ1dyaXRlICdNdWx0aXBsZSBwYXNzd29yZHMgcHJlc2VudCcKICAgICAgICAgICAgICAgIFdyaXRlLVJlY292ZXJ5UGFzc3dvcmQKICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnV2lsbCByZW1vdmUgYWxsIGJ1dCB0aGUgZmlyc3Qgb25lJykKICAgICAgICAgICAgICAgICRTY3JpcHQ6QXJyYXlSZWNvdmVyeVBhc3N3b3JkcyB8IEZvckVhY2gtT2JqZWN0IHsgCiAgICAgICAgICAgICAgICAgICAgaWYgKCRfLktleVByb3RlY3RvcklkIC1uZSAkU2NyaXB0OkFycmF5UmVjb3ZlcnlQYXNzd29yZHNbMF0uS2V5UHJvdGVjdG9ySWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJG51bGwgPSBSZW1vdmUtQml0TG9ja2VyS2V5UHJvdGVjdG9yIC1Nb3VudFBvaW50ICRPU0RyaXZlIC1LZXlQcm90ZWN0b3JJZCAkXy5LZXlQcm90ZWN0b3JJRAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJD8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnU3VjY2Vzc2Z1bGx5IHJlbW92ZWQgfCBLZXlQcm90ZWN0b3JJZCAiezB9IiB8IFJlY292ZXJ5UGFzc3dvcmQgInsxfSInIC1mICgkXy5LZXlQcm90ZWN0b3JJZCwkXy5SZWNvdmVyeVBhc3N3b3JkKSkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdTdWNjZXNzZnVsbHkgc2tpcHBlZCB0aGUgZmlyc3Qga2V5LiB8IEtleVByb3RlY3RvcklkICJ7MH0iIHwgUmVjb3ZlcnlQYXNzd29yZCAiezF9IicgLWYgKCRfLktleVByb3RlY3RvcklkLCRfLlJlY292ZXJ5UGFzc3dvcmQpKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBHZXQtQml0TG9ja2VyU3RhdHVzCiAgICAgICAgICAgICAgICBpZiAoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQVyAtYW5kICRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMV0gLWFuZCAoJFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzIC1lcSAxKSkgewogICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdWNjZXNzID0gJHRydWUKICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgIAogICAgICAgICAgICB9CgoKICAgICAgICAgICAgIyBUaGlzIHNob3VsZCBub3QgYmUgcG9zc2libGUKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAnRVJST1I6IFJlY292ZXJ5UGFzc3dvcmQgcHJlc2VudCwgYnV0IGNvdW50IDwgMScKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgCiAgICAgICAgI3JlZ2lvbiBBZGQgUHJvdGVjdGlvbiBQYXNzd29yZCBJZiBOb25lIFByZXNlbnQKICAgICAgICBlbHNlIHsKICAgICAgICAgICAgTG9nV3JpdGUgKCdObyBCaXRMb2NrZXIgUmVjb3ZlcnkgUGFzc3dvcmRzIGZvdW5kIGZvciBPUyBEcml2ZSB7MH0sIGNyZWF0aW5nIG9uZS4nIC1mICRPU0RyaXZlKQogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgJG51bGwgPSBBZGQtQml0TG9ja2VyS2V5UHJvdGVjdG9yIC1Nb3VudFBvaW50ICRPU0RyaXZlIC1SZWNvdmVyeVBhc3N3b3JkUHJvdGVjdG9yIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlIC1XYXJuaW5nQWN0aW9uIFNpbGVudGx5Q29udGludWUKICAgICAgICAgICAgICAgIGlmICgkPykgewogICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdWNjZXNzID0gJHRydWUKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICRudWxsID0gRW5hYmxlLUJpdExvY2tlciAtTW91bnRQb2ludCAkT1NEcml2ZSAtUmVjb3ZlcnlQYXNzd29yZFByb3RlY3RvciAtRXJyb3JBY3Rpb24gU3RvcAogICAgICAgICAgICAgICAgICAgIGlmICgkPykgewogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3VjY2VzcyA9ICR0cnVlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgfSAKICAgICAgICAgICAgY2F0Y2ggewogICAgICAgICAgICAgICAgTG9nRXJyb3JzCiAgICAgICAgICAgICAgICAkbnVsbCA9IEFkZC1CaXRMb2NrZXJLZXlQcm90ZWN0b3IgLU1vdW50UG9pbnQgJE9TRHJpdmUgLVJlY292ZXJ5UGFzc3dvcmRQcm90ZWN0b3IgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUgLVdhcm5pbmdBY3Rpb24gU2lsZW50bHlDb250aW51ZQogICAgICAgICAgICAgICAgaWYgKCRMYXN0RXhpdENvZGUgLWVxIDApIHsKICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3VjY2VzcyA9ICR0cnVlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkbnVsbCA9IEVuYWJsZS1CaXRMb2NrZXIgLU1vdW50UG9pbnQgJE9TRHJpdmUgLVJlY292ZXJ5UGFzc3dvcmRQcm90ZWN0b3IgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUKICAgICAgICAgICAgICAgICAgICBpZiAoJD8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN1Y2Nlc3MgPSAkdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnVHJpZWQgdG8gYWRkIEJpdExvY2tlciBSZWNvdmVyeVBhc3N3b3JkUHJvdGVjdG9yLiBTdWNjZXNzPyB7MH0uJyAtZiAoJExvY2FsOlN1Y2Nlc3MpKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIEFkZCBQcm90ZWN0aW9uIFBhc3N3b3JkIElmIE5vbmUgUHJlc2VudAoKICAgICAgICAKCiAgICAgICAgIyBDb3VudCBhbmQgbGlzdCBleGlzdGluZyBSZWNvdmVyeVBhc3N3b3JkLCBvbmx5IHdyaXRlIHN1Y2Nlc3MgaWYgdGhlcmVzIG9uZSAgICAgICAgCiAgICAgICAgaWYgKCRMb2NhbDpTdWNjZXNzKSB7CiAgICAgICAgICAgIExvZ1dyaXRlICdDaGVja2luZyBpZiB0aGVyZSBpcyBvbmx5IG9uZSBQcm90ZWN0aW9uIFBhc3N3b3JkLicKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVmcmVzaCBWYXJpYWJsZXMgZm9yIGN1cnJlbnQgdm9sdW1lCiAgICAgICAgICAgIEdldC1CaXRMb2NrZXJTdGF0dXMgLURyaXZlTGV0dGVyICRPU0RyaXZlCiAgICAgICAgICAgIFJlZnJlc2gtQml0TG9ja2VyVmFyaWFibGVzRm9yQ3VycmVudFZvbHVtZSAtRHJpdmVMZXR0ZXIgJE9TRHJpdmUKCiAgICAgICAgICAgICMgQ2hlY2sgcmVzdWx0cwogICAgICAgICAgICBbYm9vbF0gJExvY2FsOkJvb2xUZW1wID0gJChpZigkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXKXsoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1sxXSl9ZWxzZXskZmFsc2V9KQogICAgICAgICAgICBMb2dXcml0ZSAoJ1Byb3RlY3Rpb24gUGFzc3dvcmQgUHJlc2VudD8gezB9JyAtZiAoJExvY2FsOkJvb2xUZW1wKSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCRMb2NhbDpCb29sVGVtcCkgeyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoJFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzIC1lcSAxKSB7ICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnU1VDQ0VTUywga2V5cyBsZWZ0OiAxLicpCiAgICAgICAgICAgICAgICAgICAgJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdyA9ICR0cnVlCiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAnRkFJTCwga2V5cyBsZWZ0OiB7MH0uJyAtZiAoJFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzKQogICAgICAgICAgICAgICAgICAgICRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cgPSAkZmFsc2UKICAgICAgICAgICAgICAgIH0gIAogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdGQUlMLCBubyBQcm90ZWN0aW9uIFBhc3N3b3JkIGZvdW5kJykKICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIExvZ1dyaXRlICgnU29tZXRoaW5nIGZhaWxlZCcpCiAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgCiAgICB9CiAgICAjZW5kcmVnaW9uIElmIHRoZXJlcyAwIG9yIG11bHRpcGxlIFByb3RlY3Rpb25zUGFzc3dvcmQocykgCn0KCgojIE5vdCBlbmNyeXB0ZWQgPSBObyBtYWtpbmcgb2YgUmVjb3ZlcnlQYXNzd29yZAplbHNlIHsKICAgIExvZ1dyaXRlICgnT1MgRHJpdmUgaXMgIkZ1bGx5RGVjcnlwdGVkIiBhbmQgdGhlcmUgZXhpc3RzIG5vICJUUE0iLicpCiAgICBMb2dXcml0ZSAoJ0JpdExvY2tlciBSZWNvdmVyeVBhc3N3b3JkIGNhbiBub3QgYmUgYWRkZWQgYXQgdGhpcyB0aW1lLicpCiAgICBMb2dXcml0ZSAoJ1JlY292ZXJ5IFBhc3N3b3JkIHByZXNlbnQ/IHswfScgLWYgKCQoaWYoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQVyl7JFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1swXX1lbHNleyRmYWxzZX0pKSkKICAgICRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cgPSAkZmFsc2UKfQoKIyBXcml0ZSByZWNvdmVyeSBwYXNzd29yZChzKSBpZiBhbnl0aGluZyBjaGFuZ2VkIHRoaXMgcnVudGltZQppZiAoJFNjcmlwdDpCb29sRGlkQW55dGhpbmdDaGFuZ2VUaGlzUnVudGltZSAtYW5kICRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMV0pIHsKICAgIFdyaXRlLVJlY292ZXJ5UGFzc3dvcmQKfQojZW5kcmVnaW9uIFByb3RlY3Rpb24gUGFzc3dvcmQgZm9yIE9TIERyaXZlCiNlbmRyZWdpb24gRW5jcnlwdGlvbgoKCgojIyMjIyMjIyMjIyMjIyMjIyMjIwojIyMjIyMgQkFDS1VQICMjIyMjIwojIyMjIyMjIyMjIyMjIyMjIyMjIwojcmVnaW9uIEJhY2t1cAoKCkxvZ1dyaXRlICgnIyMjIEJhY2t1cCBQcm90ZWN0aW9uIFBhc3N3b3JkIHRvIEF6dXJlQUFEIGFuZCBPbmVEcml2ZTRCJykKCiMgQ2hlY2sgZm9yIGNoYW5nZXMgaWYgRmluaXNoZWQxc3RUaW1lCmlmICgkU2NyaXB0OklzRmluaXNoZWQxc3RUaW1lIC1vciAkU2NyaXB0OklzQmFja3VwQUFEIC1hbmQgJFNjcmlwdDpJc0JhY2t1cE9EKSB7CiAgICBMb2dXcml0ZSAoJ0RyaXZlIGlzIGFscmVhZHkgYmFja2VkIHVwLicpCiAgICBMb2dXcml0ZSAoJ1dpbGwgY2hlY2sgaWYgYW55dGhpbmcgaGFzIGNoYW5nZWQuJykKCiAgICBpZiAoQ2hlY2stSWZCaXRMb2NrZXJQV0hhc0NoYW5nZWQpIHsKICAgICAgICBMb2dXcml0ZSAnU29tZXRoaW5nIGhhcyBjaGFuZ2VkLCBCaXRMb2NrZXIgUmVjb3ZlcnkgUHJvdGVjdGlvbiBQYXNzd29yZCBpcyBub3QgdGhlIHNhbWUgYXMgdGhlIG9uZSBiYWNrZWQgdXAuJwogICAgICAgICRTY3JpcHQ6SXNCYWNrdXBBQUQgPSAkU2NyaXB0OklzQmFja3VwT0QgPSAkZmFsc2UKICAgICAgICAkU2NyaXB0OkJvb2xEaWRBbnl0aGluZ0NoYW5nZVRoaXNSdW50aW1lID0gJHRydWUKICAgIH0KICAgIGVsc2UgewogICAgICAgIExvZ1dyaXRlICdOb3RoaW5nIGhhcyBjaGFuZ2VkLCBCaXRMb2NrZXIgUmVjb3ZlcnkgUHJvdGVjdGlvbiBQYXNzd29yZCBpcyB0aGUgc2FtZSBhcyB0aGUgb25lIHByZXZpb3VzbHkgYmFja2VkIHVwLicKICAgIH0KfQoKCiMgSWYgbm8gYmFja3VwcwppZiAoLW5vdCAoJFNjcmlwdDpJc0JhY2t1cEFBRCAtYW5kICRTY3JpcHQ6SXNCYWNrdXBPRCkpIHsKICAgICMgSWYgUHJvdGVjdGlvblBhc3N3b3JkKHMpIGV4aXN0CiAgICBpZiAoJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdykgewogICAgICAgICAgICAKICAgICAgICBMb2dXcml0ZSAoJ09TIERyaXZlIGlzIGVuY3J5cHRlZCwgYW5kIHRoZXJlIGFyZSB7MH0gUHJvdGVjdGlvblBhc3N3b3JkKHMpIHByZXNlbnQuJyAtZiAoJFNjcmlwdDpBcnJheVJlY292ZXJ5UGFzc3dvcmRzLkNvdW50KSkKICAgICAgICBMb2dXcml0ZSAoJ1dyaXRpbmcgZXhpc3RpbmcgUmVjb3ZlcnlQYXNzd29yZCBmb3IgY3VycmVudCBkcml2ZSwgZm9yIGZ1dHVyZSByZWZlcmVuY2UuLi4nKQogICAgICAgICRudWxsID0gQ2hlY2stSWZCaXRMb2NrZXJQV0hhc0NoYW5nZWQKICAgICAgICAKICAgICAgICBMb2dXcml0ZSAoJ0NvbnRpbnVpbmcgd2l0aCBiYWNrdXAuJykKCiAgICAKICAgICAgICAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKICAgICAgICAjIE9uZURyaXZlIGZvciBCdXNpbmVzcyBiYWNrdXAKICAgICAgICAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKICAgICAgICAjcmVnaW9uIEJhY2t1cCBPbmVEcml2ZSBmb3IgQnVzaW5lc3MKICAgIAogICAgICAgIExvZ1dyaXRlICgnIyBCYWNrdXAgdG8gT25lRHJpdmUnKQogICAgICAgIGlmICgkU2NyaXB0OklzQmFja3VwT0QpIHsKICAgICAgICAgICAgTG9nV3JpdGUgKCdBbHJlYWR5IGRvbmUnKQogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgJFNjcmlwdDpCb29sRGlkQW55dGhpbmdDaGFuZ2VUaGlzUnVudGltZSA9ICR0cnVlCiAgICAgICAgICAgIAogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgIyBHZXQgQ3VycmVudCBVc2VyIGFzIFNlY3VyaXR5SWRlbnRpZmllcgogICAgICAgICAgICAgICAgaWYgKC1ub3QoJFNjcmlwdDpQYXRoRGlyUm9vdENVKSl7CiAgICAgICAgICAgICAgICAgICAgW3N0cmluZ10gJFNjcmlwdDpQYXRoRGlyUm9vdENVID0gKCdIS1U6XHswfVwnIC1mIChbU3lzdGVtLlNlY3VyaXR5LlByaW5jaXBhbC5OVEFjY291bnRdOjpuZXcoKEdldC1Qcm9jZXNzIC1OYW1lICdleHBsb3JlcicgLUluY2x1ZGVVc2VyTmFtZSB8IFNlbGVjdC1PYmplY3QgLUV4cGFuZFByb3BlcnR5IFVzZXJOYW1lIC1GaXJzdCAxKSkuVHJhbnNsYXRlKFtTeXN0ZW0uU2VjdXJpdHkuUHJpbmNpcGFsLlNlY3VyaXR5SWRlbnRpZmllcl0pLlZhbHVlKSkKICAgICAgICAgICAgICAgICAgICBpZigoLW5vdCgkPykpIC1vciBbc3RyaW5nXTo6SXNOdWxsT3JFbXB0eSgkUGF0aERpclJvb3RDVSkpe0JyZWFrfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEFkZCBIS1U6XCBhcyBQU0RyaXZlIGlmIG5vdCBhbHJlYWR5CiAgICAgICAgICAgICAgICBpZiAoKEdldC1QU0RyaXZlIC1OYW1lICdIS1UnIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlKSAtZXEgJG51bGwpIHskbnVsbCA9IE5ldy1QU0RyaXZlIC1QU1Byb3ZpZGVyIFJlZ2lzdHJ5IC1OYW1lICdIS1UnIC1Sb290ICdIS0VZX1VTRVJTJ30KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBHZXQgT25lRHJpdmUgZm9yIEJ1c2luZXNzIHBhdGggZnJvbSByZWdpc3RyeSAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAkUmVnVmFsdWVzID0gR2V0LUNoaWxkSXRlbSAtUGF0aCAoJ3swfVxTT0ZUV0FSRVxNaWNyb3NvZnRcT25lRHJpdmVcQWNjb3VudHNcJyAtZiAoJFBhdGhEaXJSb290Q1UpKQogICAgICAgICAgICAgICAgZm9yZWFjaCAoJFJlZ1ZhbHVlIGluICRSZWdWYWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6T0Q0QkFjY1R5cGUgPSAoJFJlZ1ZhbHVlIHwgU2VsZWN0LU9iamVjdCAtRXhwYW5kUHJvcGVydHkgJ05hbWUnKS5TcGxpdCgne1x9JylbLTFdCiAgICAgICAgICAgICAgICAgICAgaWYgKCRMb2NhbDpPRDRCQWNjVHlwZSAtbGlrZSAnQnVzaW5lc3MqJykgewogICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0ZvdW5kIGEgT25lRHJpdmUgZm9yIEJ1c2luZXNzIGFjY291bnQuJykKICAgICAgICAgICAgICAgICAgICAgICAgW3N0cmluZ10gJExvY2FsOlBhdGhEaXJPRDRCID0gKEdldC1JdGVtUHJvcGVydHkgLVBhdGggJFJlZ1ZhbHVlLk5hbWUuUmVwbGFjZSgnSEtFWV9VU0VSU1wnLCdIS1U6XCcpIC1OYW1lICdVc2VyRm9sZGVyJykuVXNlckZvbGRlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJExvY2FsOlBhdGhEaXJPRDRCIC1ub3RsaWtlICgnezB9XFVzZXJzXCpcT25lRHJpdmUgLSonIC1mICgkT1NEcml2ZSkpIC1hbmQgKC1ub3QoVGVzdC1QYXRoIC1QYXRoICRMb2NhbDpQYXRoRGlyT0Q0QikpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0ZhaWxlZCB0byBidWlsZCBPbmVEcml2ZSBwYXRoOiAiezB9Iiwgb3IgaXQgZG9lcyBub3QgZXhpc3QuJyAtZiAoJExvY2FsOlBhdGgpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgJFNjcmlwdDpJc0JhY2t1cE9EID0gJGZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgeyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoLW5vdCgkU2NyaXB0OkNvbXB1dGVyUHJvZHVjdE5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ3JlYXRlLUVudlZhcmlhYmxlcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIFJ1bnRpbWUgdmFyaWFibGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtib29sXSAkTG9jYWw6Qm9vbEZvbGRlckV4aXN0cyA9ICRmYWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBDcmVhdGluZyBwYXRocwogICAgICAgICAgICAgICAgICAgICAgICAgICAgW3N0cmluZ10gJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwUGFyZW50ID0gKCd7MH1cQml0TG9ja2VyIFJlY292ZXJ5XCcgLWYgKCRMb2NhbDpQYXRoRGlyT0Q0QikpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6UGF0aERpck9ENEJCYWNrdXAgPSAoJ3swfXsxfSAoezJ9IHszfSlcJyAtZiAoJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwUGFyZW50LCRTY3JpcHQ6Q29tcHV0ZXJOYW1lLCRTY3JpcHQ6Q29tcHV0ZXJNYW51ZmFjdHVyZXIsJFNjcmlwdDpDb21wdXRlclByb2R1Y3ROYW1lKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnT25lRHJpdmUgZm9yIEJ1c2luZXNzIFBhdGg6IHswfScgLWYgKCRMb2NhbDpQYXRoRGlyT0Q0QikpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0JhY2t1cCBQYXRoIFBhcmVudDogICAgICAgICB7MH0nIC1mICgkTG9jYWw6UGF0aERpck9ENEJCYWNrdXBQYXJlbnQpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdCYWNrdXAgUGF0aCBmb3IgQml0bG9ja2VyIFJlY292ZXJ5IEtleShzKTogezB9JyAtZiAoJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwKSkgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjVGVzdGluZyBpZiBSZWNvdmVyeSBmb2xkZXIgZXhpc3RzIGlmIG5vdCBjcmVhdGUgb25lCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1Rlc3RpbmcgaWYgYmFja3VwIGZvbGRlciBleGlzdHMsIGNyZWF0ZSBpdCBpZiBub3QuJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChUZXN0LVBhdGggLVBhdGggJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwIC1FcnJvckFjdGlvbiAnU2lsZW50bHlDb250aW51ZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6Qm9vbEZvbGRlckV4aXN0cyA9ICR0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAnQ3JlYXRpbmcgT25lRHJpdmUgZm9yIEJ1c2luZXNzIGZvbGRlciBmb3IgYmFja3VwLicKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbnVsbCA9IE5ldy1JdGVtIC1QYXRoICRMb2NhbDpQYXRoRGlyT0Q0QkJhY2t1cCAtSXRlbVR5cGUgJ0RpcmVjdG9yeScgLUZvcmNlIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpCb29sRm9sZGVyRXhpc3RzID0gVGVzdC1QYXRoIC1QYXRoICRMb2NhbDpQYXRoRGlyT0Q0QkJhY2t1cAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnezB9JyAtZiAkKGlmKCRMb2NhbDpCb29sRm9sZGVyRXhpc3RzKXsnU3VjY2Vzcy4nfWVsc2V7J0ZhaWxlZC4nfSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIENyZWF0ZSBPbmVEcml2ZSBmb3IgQnVzaW5lc3MgQmFja3VwIGlmIHRoZSBmb2xkZXIgZXhpc3RzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoLW5vdCgkTG9jYWw6Qm9vbEZvbGRlckV4aXN0cykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAnRmFpbGVkIHRvIGNoZWNrIG9yIGNyZWF0ZSBmb2xkZXIuJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBNYWtlIHN1cmUgJ0JpdExvY2tlciBSZWNvdmVyeScgZm9sZGVyIGlzIGhpZGRlbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnTWFraW5nIHN1cmUgInswfSIgaXMgaGlkZGVuLicgLWYgKCRMb2NhbDpQYXRoRGlyT0Q0QkJhY2t1cFBhcmVudCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChHZXQtSXRlbSAtUGF0aCAkTG9jYWw6UGF0aERpck9ENEJCYWNrdXBQYXJlbnQgLUZvcmNlKS5BdHRyaWJ1dGVzIC1ub3RsaWtlICcqaGlkZGVuKicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKEdldC1JdGVtIC1QYXRoICRMb2NhbDpQYXRoRGlyT0Q0QkJhY2t1cFBhcmVudCAtRm9yY2UpLkF0dHJpYnV0ZXMgPSAoR2V0LUl0ZW0gLVBhdGggJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwUGFyZW50IC1Gb3JjZSkuQXR0cmlidXRlcyAtYm9yICdIaWRkZW4nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnU3VjY2Vzc2Z1bGx5IGhpZGRlbj8gezB9LicgLWYgKCQ/KSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnQWxyZWFkeSBoaWRkZW4uJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgR2V0IEFycmF5UmVjb3ZlcnlQYXNzd29yZHMgZm9yIGN1cnJlbnQgdm9sdW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOkN1cnJlbnRWb2x1bWVBcnJheVJlY292ZXJ5UGFzc3dvcmRzID0gR2V0LVZhcmlhYmxlIC1OYW1lICgnezB9QXJyYXlSZWNvdmVyeVBhc3N3b3JkcycgLWYgKCRPU0RyaXZlTGV0dGVyKSkgLVNjb3BlICdTY3JpcHQnIC1WYWx1ZU9ubHkgLUVycm9yQWN0aW9uICdTdG9wJwoKICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgQ3JlYXRlIHN0cmluZyBmb3IgQml0TG9ja2VyUmVjb3ZlcnlQYXNzd29yZC50eHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyA9IFtzdHJpbmddOjpFbXB0eQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICgnQml0TG9ja2VyIFJlY292ZXJ5UGFzc3dvcmQgZm9yIE9TIERyaXZlICh7MH0pezF9JyAtZiAoJGVudjpTeXN0ZW1Ecml2ZSwiYHJgbiIpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9IEdldC1TdHJpbmdSZWNvdmVyeVBhc3N3b3JkcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICJgcmBuYHJgbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAnQml0TG9ja2VyIERyaXZlIEVuY3J5cHRpb24gcmVjb3Zlcnkga2V5ezB9JyAtZiAiYHJgbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAnVG8gdmVyaWZ5IHRoYXQgdGhpcyBpcyB0aGUgY29ycmVjdCByZWNvdmVyeSBrZXksIGNvbXBhcmUgdGhlIHN0YXJ0IG9mIHRoZSBmb2xsb3dpbmd7MH0nIC1mICJgcmBuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICdpZGVudGlmaWVyIHdpdGggdGhlIGlkZW50aWZpZXIgdmFsdWUgZGlzcGxheWVkIG9uIHlvdXIgUEMuJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICJgcmBuYHJgbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAoJ0lkZW50aWZpZXI6IHswfScgLWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lQXJyYXlSZWNvdmVyeVBhc3N3b3Jkc1swXS5LZXlQcm90ZWN0b3JJZCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gImByYG5gcmBuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICdJZiB0aGUgYWJvdmUgaWRlbnRpZmllciBtYXRjaGVzIHRoZSBvbmUgZGlzcGxheWVkIGJ5IHlvdXIgUEMsezB9JyAtZiAiYHJgbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAndGhlbiB1c2UgdGhlIGZvbGxvd2luZyBrZXkgdG8gIHVubG9jayB5b3VyIGRyaXZlOicKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAiYHJgbmByYG4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gKCdSZWNvdmVyeSBLZXk6IHswfScgLWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lQXJyYXlSZWNvdmVyeVBhc3N3b3Jkc1swXS5SZWNvdmVyeVBhc3N3b3JkKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAiYHJgbmByYG4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gJ0lmIHRoZSBhYm92ZSBpZGVudGlmaWVyIGRvZXNuYHQgbWF0Y2ggdGhlIG9uZSBkaXNwbGF5ZWQgYnkgeW91ciBQQyx7MH0nIC1mICJgcmBuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICd0aGVuIHRoaXMgaXNuYHQgdGhlIHJpZ2h0IGtleSB0byB1bmxvY2sgeW91ciBkcml2ZS57MH0nIC1mICJgcmBuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICdUcnkgYW5vdGhlciByZWNvdmVyeSBrZXksIG9yIHJlZmVyIHRvezB9JyAtZiAiYHJgbiIgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gJ2h0dHBzOi8vZ28ubWljcm9zb2Z0LmNvbS9md2xpbmsvP0xpbmtJRD0yNjA1ODkgZm9yIGFkZGl0aW9uYWwgYXNzaXN0YW5jZS4nCgoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIE91dC1GaWxlIHRoZSBzdHJpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAnQ3JlYXRpbmcgYmFja3VwIGluIE9uZURyaXZlIGZvciBCdXNpbmVzcy4nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgW3N0cmluZ10gJExvY2FsOk9ENEJCYWNrdXBGaWxlUGF0aCA9ICgnezB9Qml0bG9ja2VyUmVjb3ZlcnlQYXNzd29yZC17MX0udHh0JyAtZiAoJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwLChHZXQtRGF0ZSAtRm9ybWF0ICd5eU1NZGRoaG1tc3MnKSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgT3V0LUZpbGUgLUZpbGVQYXRoICRMb2NhbDpPRDRCQmFja3VwRmlsZVBhdGggLUVuY29kaW5nICd1dGY4JyAtRm9yY2UgLUlucHV0T2JqZWN0ICgkTG9jYWw6U3RyUmVjUGFzcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoVGVzdC1QYXRoIC1QYXRoICRMb2NhbDpPRDRCQmFja3VwRmlsZVBhdGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJFNjcmlwdDpJc0JhY2t1cE9EID0gJHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgT25lRHJpdmUgZm9yIEJ1c2luZXNzIEJhY2t1cCBTdWNjZXNzPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdTdWNjZXNzPyB7MH0nIC1mICgkU2NyaXB0OklzQmFja3VwT0QpKQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1NraXBwaW5nIHBlcnNvbmFsIE9uZURyaXZlIGZvciBCdXNpbmVzcyBmb2xkZXJzLicpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoIHsKICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnRXJyb3Igd2hpbGUgYmFja3VwIHRvIE9uZURyaXZlLCBtYWtlIHN1cmUgdGhhdCB5b3UgYXJlIEFBRCBqb2luZWQgYW5kIGFyZSBydW5uaW5nIHRoZSBjbWRsZXQgYXMgYW4gYWRtaW4uJykKICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnRXJyb3IgbWVzc2FnZTonICsgImByYG4iICsgKCRfKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnRGlkIGJhY2t1cCB0byBPbmVEcml2ZSBzdWNjZWVkPyB7MH0nIC1mICgkU2NyaXB0OklzQmFja3VwT0QpKQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gQmFja3VwIE9uZURyaXZlIGZvciBCdXNpbmVzcwogICAgCgoKICAgICAgICAjIyMjIyMjIyMjIyMjIyMjIwogICAgICAgICMgQXp1cmUgQUQgQmFja3VwCiAgICAgICAgIyMjIyMjIyMjIyMjIyMjIyMKICAgICAgICAjcmVnaW9uIEJhY2t1cCBBenVyZSBBQUQKCiAgICAgICAgTG9nV3JpdGUgKCcjIEJhY2t1cCB0byBBenVyZSBBRCcpCiAgICAgICAgaWYgKCRTY3JpcHQ6SXNCYWNrdXBBQUQpIHsKICAgICAgICAgICAgTG9nV3JpdGUgKCdBbHJlYWR5IGRvbmUnKQogICAgICAgIH0KICAgICAgICAKICAgICAgICBlbHNlIHsKICAgICAgICAgICAgJFNjcmlwdDpCb29sRGlkQW55dGhpbmdDaGFuZ2VUaGlzUnVudGltZSA9ICR0cnVlCiAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAjIEdldCBBcnJheVJlY292ZXJ5UGFzc3dvcmRzIGZvciBjdXJyZW50IHZvbHVtZQogICAgICAgICAgICAgICAgJExvY2FsOkN1cnJlbnRWb2x1bWVBcnJheVJlY292ZXJ5UGFzc3dvcmRzID0gR2V0LVZhcmlhYmxlIC1OYW1lICgnezB9QXJyYXlSZWNvdmVyeVBhc3N3b3JkcycgLWYgKCRPU0RyaXZlTGV0dGVyKSkgLVNjb3BlICdTY3JpcHQnIC1WYWx1ZU9ubHkgLUVycm9yQWN0aW9uICdTdG9wJwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIENoZWNrIGlmIHdlIGNhbiB1c2UgQmFja3VwVG9BQUQtQml0TG9ja2VyS2V5UHJvdGVjdG9yIGNvbW1hbmRsZXQKICAgICAgICAgICAgICAgICRMb2NhbDpDbWROYW1lID0gJ0JhY2t1cFRvQUFELUJpdExvY2tlcktleVByb3RlY3RvcicKICAgICAgICAgICAgICAgIExvZ1dyaXRlICdDaGVja2luZyBpZiB3ZSBjYW4gdXNlIEJhY2t1cFRvQUFELUJpdExvY2tlcktleVByb3RlY3RvciBjb21tYW5kbGV0LicKCiAgICAgICAgICAgICAgICBpZiAoR2V0LUNvbW1hbmQgJExvY2FsOkNtZE5hbWUgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJykgewogICAgICAgICAgICAgICAgICAgICNCYWNrdXBUb0FBRC1CaXRMb2NrZXJLZXlQcm90ZWN0b3IgY29tbWFuZGxldCBleGlzdHMKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ3swfSBjb21tYW5kbGV0IGV4aXN0cyEnIC1mICgkTG9jYWw6Q21kTmFtZSkpIAogICAgICAgICAgICAgICAgICAgICRudWxsID0gQmFja3VwVG9BQUQtQml0TG9ja2VyS2V5UHJvdGVjdG9yIC1Nb3VudFBvaW50ICRPU0RyaXZlIC1LZXlQcm90ZWN0b3JJZCAkTG9jYWw6Q3VycmVudFZvbHVtZUFycmF5UmVjb3ZlcnlQYXNzd29yZHNbMF0uS2V5UHJvdGVjdG9ySWQgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJwogICAgICAgICAgICAgICAgICAgIGlmICgkPykgewogICAgICAgICAgICAgICAgICAgICAgICAkU2NyaXB0OklzQmFja3VwQUFEID0gJHRydWUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRudWxsID0gQmFja3VwVG9BQUQtQml0TG9ja2VyS2V5UHJvdGVjdG9yIC1Nb3VudFBvaW50ICRPU0RyaXZlIC1LZXlQcm90ZWN0b3JJZCAkTG9jYWw6Q3VycmVudFZvbHVtZUFycmF5UmVjb3ZlcnlQYXNzd29yZHNbMF0uS2V5UHJvdGVjdG9ySWQgLUVycm9yQWN0aW9uICdTdG9wJwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJD8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRTY3JpcHQ6SXNCYWNrdXBBQUQgPSAkdHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnU3VjY2Vzcz8gezB9JyAtZiAoJFNjcmlwdDpJc0JhY2t1cEFBRCkpCiAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICAgICAgZWxzZSB7IAogICAgICAgICAgICAgICAgICAgICMgQmFja3VwVG9BQUQtQml0TG9ja2VyS2V5UHJvdGVjdG9yIGNvbW1hbmRsZXQgbm90IGF2YWlsYWJsZSwgdXNpbmcgb3RoZXIgbWVjaGFuaXNtIAogICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICdCYWNrdXBUb0FBRC1CaXRMb2NrZXJLZXlQcm90ZWN0b3IgY29tbWFuZGxldCBub3QgYXZhaWxhYmxlLCB1c2luZyBvdGhlciBtZWNoYW5pc20uJyAKICAgICAgICAgICAgICAgICAgICAjIEdldCB0aGUgQUFEIE1hY2hpbmUgQ2VydGlmaWNhdGUKICAgICAgICAgICAgICAgICAgICAkY2VydCA9IEdldC1DaGlsZEl0ZW0gQ2VydDpcTG9jYWxNYWNoaW5lXE15XCB8IFdoZXJlLU9iamVjdCB7ICRfLklzc3VlciAtbWF0Y2ggJ0NOPU1TLU9yZ2FuaXphdGlvbi1BY2Nlc3MnIH0KCiAgICAgICAgICAgICAgICAgICAgIyBPYnRhaW4gdGhlIEFBRCBEZXZpY2UgSUQgZnJvbSB0aGUgY2VydGlmaWNhdGUKICAgICAgICAgICAgICAgICAgICAkaWQgPSAkY2VydC5TdWJqZWN0LlJlcGxhY2UoJ0NOPScsJycpCgogICAgICAgICAgICAgICAgICAgICMgR2V0IHRoZSB0ZW5hbnQgbmFtZSBmcm9tIHRoZSByZWdpc3RyeQogICAgICAgICAgICAgICAgICAgICR0ZW5hbnQgPSAoR2V0LUl0ZW1Qcm9wZXJ0eSBIS0xNOlxTWVNURU1cQ3VycmVudENvbnRyb2xTZXRcQ29udHJvbFxDbG91ZERvbWFpbkpvaW5cSm9pbkluZm9cJCgkaWQpKS5Vc2VyRW1haWwuU3BsaXQoJ0AnKVsxXQogICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICR0ZW5hbnQKICAgICAgICAgICAgICAgICAgICAjIEdlbmVyYXRlIHRoZSBib2R5IHRvIHNlbmQgdG8gQUFEIGNvbnRhaW5pbmcgdGhlIHJlY292ZXJ5IGluZm9ybWF0aW9uCiAgICAgICAgICAgICAgICAgICAgIyBHZXQgdGhlIEJpdExvY2tlciBrZXkgaW5mb3JtYXRpb24gZnJvbSBXTUkKICAgICAgICAgICAgICAgICAgICAoR2V0LUJpdExvY2tlclZvbHVtZSAtTW91bnRQb2ludCAkT1NEcml2ZSkuS2V5UHJvdGVjdG9yfCBXaGVyZS1PYmplY3QgeyRfLktleVByb3RlY3RvclR5cGUgLWVxICdSZWNvdmVyeVBhc3N3b3JkJ30gfCBGb3JFYWNoLU9iamVjdCB7CiAgICAgICAgICAgICAgICAgICAgICAgICRrZXkgPSAkXwogICAgICAgICAgICAgICAgICAgICAgICB3cml0ZS12ZXJib3NlICJraWQgOiAkKCRrZXkuS2V5UHJvdGVjdG9ySWQpIGtleTogJCgka2V5LlJlY292ZXJ5UGFzc3dvcmQpIgogICAgICAgICAgICAgICAgICAgICAgICAkYm9keSA9ICJ7IiJrZXkiIjoiIiQoJGtleS5SZWNvdmVyeVBhc3N3b3JkKSIiLCIia2lkIiI6IiIkKCRrZXkuS2V5UHJvdGVjdG9ySWQucmVwbGFjZSgneycsJycpLlJlcGxhY2UoJ30nLCcnKSkiIiwiInZvbCIiOiIiT1NWIiJ9IgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIENyZWF0ZSB0aGUgVVJMIHRvIHBvc3QgdGhlIGRhdGEgdG8gYmFzZWQgb24gdGhlIHRlbmFudCBhbmQgZGV2aWNlIGluZm9ybWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICR1cmwgPSAiaHR0cHM6Ly9lbnRlcnByaXNlcmVnaXN0cmF0aW9uLndpbmRvd3MubmV0L21hbmFnZS8kdGVuYW50L2RldmljZS8kKCRpZCk/YXBpLXZlcnNpb249MS4wIgogICAgICAgICAgICAgICAgICAgICAgICBMb2dzdHJpbmcgIkNyZWF0aW5nIHVybC4uLiR1cmwiCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgUG9zdCB0aGUgZGF0YSB0byB0aGUgVVJMIGFuZCBzaWduIGl0IHdpdGggdGhlIEFBRCBNYWNoaW5lIENlcnRpZmljYXRlCiAgICAgICAgICAgICAgICAgICAgICAgICRyZXEgPSBJbnZva2UtV2ViUmVxdWVzdCAtVXJpICR1cmwgLUJvZHkgJGJvZHkgLVVzZUJhc2ljUGFyc2luZyAtTWV0aG9kIFBvc3QgLVVzZURlZmF1bHRDcmVkZW50aWFscyAtQ2VydGlmaWNhdGUgJGNlcnQKICAgICAgICAgICAgICAgICAgICAgICAgJHJlcS5SYXdDb250ZW50CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkPykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJFNjcmlwdDpJc0JhY2t1cEFBRCA9ICR0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgIH0gICAgCiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1N0cmluZyAoJ1Bvc3QgdGhlIGRhdGEgdG8gdGhlIFVSTCBhbmQgc2lnbiBpdCB3aXRoIHRoZSBBQUQgTWFjaGluZSBDZXJ0aWZpY2F0ZS4gU3VjY2Vzcz8gezB9JyAtZiAoJFNjcmlwdDpJc0JhY2t1cEFBRCkpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXRjaCB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0Vycm9yIHdoaWxlIGJhY2t1cCB0byBBenVyZSBBRCwgbWFrZSBzdXJlIHRoYXQgeW91IGFyZSBBQUQgam9pbmVkIGFuZCBhcmUgcnVubmluZyB0aGUgY21kbGV0IGFzIGFuIGFkbWluLicpCiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0Vycm9yIG1lc3NhZ2U6JyArICJgcmBuIiArICgkXykpCiAgICAgICAgICAgICAgICAkSXNCYWNrdXBBQUQgPSAkZmFsc2UKICAgICAgICAgICAgfQogICAgICAgICAgICBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnRGlkIGJhY2t1cCB0byBBenVyZSBBRCBTdWNjZWVkPyB7MH0nIC1mICgkU2NyaXB0OklzQmFja3VwQUFEKSkKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIEJhY2t1cCBBenVyZSBBQUQKICAgICAgICAKICAgICAgICAKICAgICAgICAjIElmIG5vIGJhY2t1cCBhbmQgbm8gUmVjb3ZlcnkgUGFzc3dvcmRzIHByZXNlbnQKICAgICAgICAKICAgIH0KICAgIGVsc2UgewogICAgICAgIExvZ1dyaXRlICdPUyBEcml2ZSBpcyBub3QgZW5jcnlwdGV0LCB0aGVyZSBhcmUgbm8gUmVjb3ZlcnkgUGFzc3dvcmRzLCBhbmQgdGhlcmUgYXJlIG5vIGJhY2t1cHMuJwogICAgfQp9CiNlbmRyZWdpb24gQmFja3VwCiNlbmRyZWdpb24gTWFpbgoKCgojIyMjIyMjIyMjIyMjIyMjIyMjIwojIyMjIyMgIEcgVSBJICMjIyMjIwojIyMjIyMjIyMjIyMjIyMjIyMjIwojcmVnaW9uIEdVSQppZiAoJFNjcmlwdDpJc0VuY3J5cHRlZCAtYW5kICRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cgLWFuZCAkR1VJKSB7CiAgICAjIFNob3cgcmVib290IHByb21wdCB0byB1c2VyCiAgICBMb2dXcml0ZSAiUHJvbXB0aW5nIHVzZXIgdG8gUmVib290IGNvbXB1dGVyLiIKICAgICAgICAgICAKCiAgICBbdm9pZF1bU3lzdGVtLlJlZmxlY3Rpb24uQXNzZW1ibHldOjpMb2FkV2l0aFBhcnRpYWxOYW1lKCDigJxTeXN0ZW0uV2luZG93cy5Gb3Jtc+KAnSkKICAgIFt2b2lkXVtTeXN0ZW0uUmVmbGVjdGlvbi5Bc3NlbWJseV06OkxvYWRXaXRoUGFydGlhbE5hbWUoIOKAnE1pY3Jvc29mdC5WaXN1YWxCYXNpY+KAnSkKCiAgICAkZm9ybSA9IE5ldy1PYmplY3Qg4oCcU3lzdGVtLldpbmRvd3MuRm9ybXMuRm9ybeKAnTsKICAgICRmb3JtLldpZHRoID0gNTAwOwogICAgJGZvcm0uSGVpZ2h0ID0gMTUwOwogICAgJGZvcm0uVGV4dCA9ICJCaXRMb2NrZXIgcmVxdWlyZXMgYSByZWJvb3QgISI7CiAgICAkZm9ybS5TdGFydFBvc2l0aW9uID0gW1N5c3RlbS5XaW5kb3dzLkZvcm1zLkZvcm1TdGFydFBvc2l0aW9uXTo6Q2VudGVyU2NyZWVuOwoKICAgICREcm9wRG93bkFycmF5ID0gQCgiNDpIb3VycyIsICI4OkhvdXJzIiwgIjEyOkhvdXJzIiwgIjI0OkhvdXJzIikKICAgICREREwgPSBOZXctT2JqZWN0IFN5c3RlbS5XaW5kb3dzLkZvcm1zLkNvbWJvQm94CiAgICAkRERMLkxvY2F0aW9uID0gTmV3LU9iamVjdCBTeXN0ZW0uRHJhd2luZy5TaXplKDE0MCwgMTApCiAgICAkRERMLlNpemUgPSBOZXctT2JqZWN0IFN5c3RlbS5EcmF3aW5nLlNpemUoMTMwLCAzMCkKICAgIEZvckVhY2ggKCRJdGVtIGluICREcm9wRG93bkFycmF5KSB7CiAgICAgICAgJERETC5JdGVtcy5BZGQoJEl0ZW0pIHwgT3V0LU51bGwKICAgIH0KICAgICREREwuU2VsZWN0ZWRJbmRleCA9IDAKCiAgICAkYnV0dG9uMSA9IE5ldy1PYmplY3Qg4oCcU3lzdGVtLldpbmRvd3MuRm9ybXMuYnV0dG9u4oCdOwogICAgJGJ1dHRvbjEuTGVmdCA9IDQwOwogICAgJGJ1dHRvbjEuVG9wID0gODU7CiAgICAkYnV0dG9uMS5XaWR0aCA9IDEwMDsKICAgICRidXR0b24xLlRleHQgPSDigJxSZWJvb3QgTm934oCdOwogICAgJGJ1dHRvbjEuQWRkX0NsaWNrKCB7JGdsb2JhbDp4aW5wdXQgPSAiUmVib290IjsgJEZvcm0uQ2xvc2UoKX0pCgogICAgJGJ1dHRvbjIgPSBOZXctT2JqZWN0IOKAnFN5c3RlbS5XaW5kb3dzLkZvcm1zLmJ1dHRvbuKAnTsKICAgICRidXR0b24yLkxlZnQgPSAxNzA7CiAgICAkYnV0dG9uMi5Ub3AgPSA4NTsKICAgICRidXR0b24yLldpZHRoID0gMTAwOwogICAgJGJ1dHRvbjIuVGV4dCA9IOKAnFBvc3Rwb25l4oCdOwogICAgJGJ1dHRvbjIuQWRkX0NsaWNrKCB7JGdsb2JhbDp4aW5wdXQgPSAiUG9zdHBvbmU6IiArICREREwuVGV4dDsgJEZvcm0uQ2xvc2UoKX0pCgogICAgJGJ1dHRvbjMgPSBOZXctT2JqZWN0IOKAnFN5c3RlbS5XaW5kb3dzLkZvcm1zLmJ1dHRvbuKAnTsKICAgICRidXR0b24zLkxlZnQgPSAyOTA7CiAgICAkYnV0dG9uMy5Ub3AgPSA4NTsKICAgICRidXR0b24zLldpZHRoID0gMTAwOwogICAgJGJ1dHRvbjMuVGV4dCA9IOKAnENhbmNlbOKAnTsKICAgICRidXR0b24zLkFkZF9DbGljayggeyRnbG9iYWw6eGlucHV0ID0gIlBvc3Rwb25lMjQiOyAkRm9ybS5DbG9zZSgpfSkKCgogICAgJGZvcm0uS2V5UHJldmlldyA9ICRUcnVlCiAgICAkZm9ybS5BZGRfS2V5RG93bigge2lmICgkXy5LZXlDb2RlIC1lcSAiRW50ZXIiKSAKICAgICAgICB7JHggPSAkdGV4dEJveDEuVGV4dDsgJGZvcm0uQ2xvc2UoKX19KQogICAgJGZvcm0uQWRkX0tleURvd24oIHtpZiAoJF8uS2V5Q29kZSAtZXEgIkVzY2FwZSIpIAogICAgICAgIHskZm9ybS5DbG9zZSgpfX0pCgogICAgJGV2ZW50SGFuZGxlciA9IFtTeXN0ZW0uRXZlbnRIYW5kbGVyXSB7IAogICAgICAgICRidXR0b24xLkNsaWNrOwogICAgICAgICREcm9wRG93bkFycmF5LlRleHQ7CiAgICAgICAgJGZvcm0uQ2xvc2UoKTsgfTsKCiAgICAjJGJ1dHRvbi5BZGRfQ2xpY2soJGV2ZW50SGFuZGxlcikgOwogICAgJGZvcm0uQ29udHJvbHMuQWRkKCRidXR0b24xKTsKICAgICRmb3JtLkNvbnRyb2xzLkFkZCgkYnV0dG9uMik7CiAgICAkZm9ybS5Db250cm9scy5BZGQoJGJ1dHRvbjMpOwogICAgJGZvcm0uQ29udHJvbHMuQWRkKCREREwpOwogICAgJGZvcm0uQ29udHJvbHMuQWRkKCR0ZXh0TGFiZWwxKQogICAgJHJldCA9ICRmb3JtLlNob3dEaWFsb2coKTsKCiAgICBpZiAoJGdsb2JhbDp4aW5wdXQgLWVxICdSZWJvb3QnKSB7c2h1dGRvd24gLXIgLWYgL3QgNjAwfQogICAgaWYgKCRnbG9iYWw6eGlucHV0IC1saWtlICdQb3N0cG9uZToqOkhvdXJzJykgewogICAgICAgICRodmFsID0gKChbaW50XSRnbG9iYWw6eGlucHV0LnNwbGl0KCI6IilbMV0pICogNjAgKiA2MCkKICAgICAgICBzaHV0ZG93biAtciAtZiAvdCAkaHZhbAogICAgfQogICAgaWYgKCRnbG9iYWw6eGlucHV0IC1lcSAnUG9zdHBvbmUyNCcpIHtzaHV0ZG93biAtciAtZiAvdCA4NjQwMH0KfQojZW5kcmVnaW9uIEdVSQoKCgojIyMjIyMjIyMjIyMjIyMjIyMjIwojIyMjIEVORCBSRVNVTFRTICMjIwojIyMjIyMjIyMjIyMjIyMjIyMjIwojcmVnaW9uIEVuZCBSZXN1bHRzIApMb2dXcml0ZSAoJyMjIyBFbmQgcmVzdWx0cycpCiMgQ2xlYW5pbmcgdXAgaWYgc3VjY2VzcwppZiAoJFNjcmlwdDpJc0ZpbmlzaGVkMXN0VGltZSkgewogICAgTG9nV3JpdGUgJ0ZpbmlzaGVkIGZpcnN0IHRpbWUgPSBUcnVlIHwgSnVzdCBjaGVja2VkIHdlYXRoZXIgQml0TG9ja2VyIFJlY292ZXJ5IFBhc3N3b3JkIGhhZCBjaGFuZ2VkLicKfQoKZWxzZSB7CiAgICBpZiAoJFNjcmlwdDpJc0VuY3J5cHRlZCAtYW5kICRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cgLWFuZCAkU2NyaXB0OklzQmFja3VwQUFEIC1hbmQgJFNjcmlwdDpJc0JhY2t1cE9EKSB7CiAgICAgICAgJEJMViA9IEdldC1CaXRMb2NrZXJWb2x1bWUgLU1vdW50UG9pbnQgJGVudjpTeXN0ZW1Ecml2ZQogICAgICAgIGlmICgoJEJMVi4nVm9sdW1lU3RhdHVzJyAtZXEgJFNjcmlwdDpCaXRMb2NrZXJWb2x1bWVFbmNyeXB0aW9uU3RhdHVzZXNbMl0pIC1hbmQgKEAoJEJMVi5LZXlQcm90ZWN0b3IgfCBXaGVyZS1PYmplY3QgLVByb3BlcnR5ICdLZXlQcm90ZWN0b3JUeXBlJyAtZXEgJ1JlY292ZXJ5UGFzc3dvcmQnKS5Db3VudCAtZXEgMSkpIHsKICAgICAgICAKICAgICAgICAgICAgIyBGaXJzdCBzdWNjZXNzZnVsbCBydW4KICAgICAgICAgICAgJFNjcmlwdDpJc0ZpbmlzaGVkMXN0VGltZSA9ICR0cnVlIAogICAgICAgICAgICAKICAgICAgICAgICAgIyBTY2hlZHVsZWRUYXNrCiAgICAgICAgICAgIEVkaXQtU2NoZWR1bGVkVGFzayAtVGFza05hbWUgJFNjcmlwdDpTY2hlZHVsZWRUYXNrTmFtZQoKICAgICAgICAgICAgIyBGaWxlcwogICAgICAgICAgICAjcmVnaW9uIFJlbW92ZSBmaWxlcwogICAgICAgICAgICBpZiAoJFNjcmlwdDpCb29sUmVtb3ZlRmlsZXNBZnRlclN1Y2Nlc3MgLWFuZCAkU2NyaXB0OklzRmluaXNoZWQxc3RUaW1lKSB7ICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAkbnVsbCA9IFN0YXJ0LUpvYiAtQXJndW1lbnRMaXN0ICRTY3JpcHQ6RmlsZUxvZyAtU2NyaXB0QmxvY2sgewogICAgICAgICAgICAgICAgICAgIFBhcmFtKFtzdHJpbmddICRGaWxlTG9nKQogICAgICAgIAogICAgICAgICAgICAgICAgICAgIEZ1bmN0aW9uIExvZ1dyaXRlIHsKICAgICAgICAgICAgICAgICAgICAgICAgUGFyYW0gKFtzdHJpbmddJExvZ1N0cmluZykKICAgICAgICAgICAgICAgICAgICAgICAgW3N0cmluZ10gJGEgPSBHZXQtRGF0ZQogICAgICAgICAgICAgICAgICAgICAgICBbc3RyaW5nXSAkTG9nU3RyaW5nID0gJGEsICRMb2dTdHJpbmcKICAgICAgICAgICAgICAgICAgICAgICAgQWRkLWNvbnRlbnQgLVBhdGggJEZpbGVMb2cgLVZhbHVlICRMb2dTdHJpbmcKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgW3N0cmluZ10gJExvY2FsOlJlbURpclBhdGggPSAoJHtlbnY6UHJvZ3JhbUZpbGVzKHg4Nil9ICsgJ1xCaXRMb2NrZXJUcmlnZ2VyXCcpCiAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBTdGFydC1TbGVlcCAtU2Vjb25kcyA1CiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdTdGFydGVkIHRoZSBqb2IgdG8gcmVtb3ZlICJ7MH0iJyAtZiAoJExvY2FsOlJlbURpclBhdGgpKQogICAgICAgICAgICAgICAgICAgIGlmIChUZXN0LVBhdGggJExvY2FsOlJlbURpclBhdGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgUmVtb3ZlLUl0ZW0gLVBhdGggJExvY2FsOlJlbURpclBhdGggLVJlY3Vyc2UgLUZvcmNlCiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnUmVtb3ZpbmcgdGhlIGZvbGRlciAocmVjdXJzZSwgZm9yY2UpLiBTdWNjZXNzPyB7MH0nIC1mICgkPykpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0ZvbGRlciBkb2VzIG5vdCBleGlzdCcpCiAgICAgICAgICAgICAgICAgICAgfSAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfQogICAgICAgICAgICAjZW5kcmVnaW9uIFJlbW92ZSBGaWxlcwogICAgICAgIH0gICAgCiAgICB9CiAgICBlbHNlIHsKICAgICAgICBMb2dXcml0ZSAnVGhlcmUgYXJlIHN0aWxsIHRoaW5ncyB0byBkby4gVHJ5aW5nIGFnYWluIGxhdGVyLicKICAgIH0KfQojZW5kcmVnaW9uIEVuZCBSZXN1bHRzCgoKCiMjIyMjIyMjIyMjIyMjIyMjIyMjCiMjIyMgUyBUIEEgVCBTICMjIyMjCiMjIyMjIyMjIyMjIyMjIyMjIyMjCkxvZ1dyaXRlICgnIyMjIFNUQVRTJykKJFNjcmlwdDpDb3VudFJ1bnMgKz0gMQoKaWYgKC1ub3QoJFNjcmlwdDpCb29sUmVtb3ZlRmlsZXNBZnRlclN1Y2Nlc3MpKSB7CiAgICBpZiAoLW5vdChUZXN0LVBhdGggJFNjcmlwdDpEaXJJbnN0YWxsKSkgewogICAgICAgICRudWxsID0gTmV3LUl0ZW0gLVBhdGggJFNjcmlwdDpEaXJJbnN0YWxsIC1JdGVtVHlwZSAnRGlyZWN0b3J5JyAtRm9yY2UKICAgIH0KICAgIAogICAgW3N0cmluZ10gJE91dFN0cmluZyA9ICgoJFNjcmlwdDpDb3VudFJ1bnMpLlRvU3RyaW5nKCkgKyAiYHJgbiIpICAgICAgICAgICAgICAgICAgICMgMAogICAgJE91dFN0cmluZyArPSAoKFtieXRlXSAkU2NyaXB0OklzRmluaXNoZWQxc3RUaW1lKS5Ub1N0cmluZygpICsgImByYG4iKSAgICAgICAgICAgICMgMQogICAgJE91dFN0cmluZyArPSAoKFtieXRlXSAkU2NyaXB0OklzRW5jcnlwdGVkKS5Ub1N0cmluZygpICsgImByYG4iKSAgICAgICAgICAgICAgICAgICMgMgogICAgJE91dFN0cmluZyArPSAoKFtieXRlXSAkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3KS5Ub1N0cmluZygpICsgImByYG4iKSAgICAgICAgICAgICMgMwogICAgJE91dFN0cmluZyArPSAoKFtieXRlXSAkU2NyaXB0OklzQmFja3VwT0QpLlRvU3RyaW5nKCkgKyAiYHJgbiIpICAgICAgICAgICAgICAgICAgICMgNAogICAgJE91dFN0cmluZyArPSAoKFtieXRlXSAkU2NyaXB0OklzQmFja3VwQUFEKS5Ub1N0cmluZygpICsgImByYG4iKSAgICAgICAgICAgICAgICAgICMgNQogICAgJE91dFN0cmluZyArPSAoKFtzdHJpbmddICRTY3JpcHQ6T1NEcml2ZUtleUlEKSArICJgcmBuIikgICAgICAgICAgICAgICAgICAgICAgICAgICMgNgogICAgJE91dFN0cmluZyArPSAoKFtzdHJpbmddICRTY3JpcHQ6T1NEcml2ZVByb3RlY3Rpb25QYXNzd29yZCkgKyAiYHJgbiIpICAgICAgICAgICAgICMgNwogICAKICAgIE91dC1GaWxlIC1GaWxlUGF0aCAkU2NyaXB0OkZpbGVTdGF0cyAtRW5jb2RpbmcgJ3V0ZjgnIC1Gb3JjZSAtSW5wdXRPYmplY3QgKCRPdXRTdHJpbmcpCn0KTG9nV3JpdGUgKCdSdW5zIHNvIGZhcjogezB9JyAtZiAoJFNjcmlwdDpDb3VudFJ1bnMpKQoKaWYgKCRTY3JpcHQ6Qm9vbERpZEFueXRoaW5nQ2hhbmdlVGhpc1J1bnRpbWUpIHsKICAgIFdyaXRlLVN0YXRzIAp9CgoKCiMjIyBHaXZlIHVwIGFmdGVyIFggcnVucyBhbmQgSXNGaW5pc2hlZDFzdFRpbWUgLWVxICRmYWxzZQppZiAoJFNjcmlwdDpDb3VudFJ1bnMgLWVxIDMwIC1hbmQgKC1ub3QoJFNjcmlwdDpJc0ZpbmlzaGVkMXN0VGltZSkpKSB7CiAgICBMb2dXcml0ZSAoJ1Nob3VsZCBoYXZlIGJlZW4gZG9uZSBieSBub3cuJykKICAgIEVkaXQtU2NoZWR1bGVkVGFzayAtVGFza05hbWUgJFNjcmlwdDpTY2hlZHVsZWRUYXNrTmFtZQoKICAgIGlmICgkZmFsc2UpIHsKICAgICAgICAjIyMgR2F0aGVyaW5nIGluZm8gZm9yIHRoZSBlbWFpbAogICAgICAgIGlmICgtbm90KCRTY3JpcHQ6V2luZG93c1ZlcnNpb24pKSB7CiAgICAgICAgICAgIENyZWF0ZS1FbnZWYXJpYWJsZXMKICAgICAgICB9CiAgICAgICAgIyMjIEJ1aWxkaW5nIGVtYWlsIHN0cmluZwogICAgICAgIFtzdHJpbmddICRMb2NhbDpTdHJTdWJqZWN0ID0gKCdCaXRMb2NrZXJUcmlnZ2VyIGZhaWxlZCB7MH0gdGltZXMgZm9yIHRlbmFudCAiezF9IiwgZGV2aWNlOiAiezJ9IicgLWYgKCRDb3VudFJ1bnMuVG9TdHJpbmcoKSwkTG9jYWw6TmFtZVRlbmFudCwkTG9jYWw6TmFtZUNvbXB1dGVyKSkKICAgICAgICBbc3RyaW5nXSAkTG9jYWw6U3RyRW1haWwgPSBbc3RyaW5nXTo6RW1wdHkKICAgICAgICAkTG9jYWw6U3RyRW1haWwgKz0gKCRMb2NhbDpTdHJTdWJqZWN0KQogICAgICAgICRMb2NhbDpTdHJFbWFpbCArPSAoImByYG4iKQogICAgICAgICRMb2NhbDpTdHJFbWFpbCArPSAoImByYG4iICsgJyMjIEVudmlyb25tZW50IGluZm8nKQogICAgICAgICRMb2NhbDpTdHJFbWFpbCArPSAoImByYG4iICsgJ0RldmljZSBuYW1lOiAnICsgJFNjcmlwdDpDb21wdXRlck5hbWUgKyAnIHwgTWFudWZhY3R1cmVyOiAnICsgJFNjcmlwdDpDb21wdXRlck1hbnVmYWN0dXJlciArICcgfCBNb2RlbDogJyArICRTY3JpcHQ6Q29tcHV0ZXJQcm9kdWN0TmFtZSkgCiAgICAgICAgJExvY2FsOlN0ckVtYWlsICs9ICgiYHJgbiIgKyAnV2luZG93cyBFZGl0aW9uOiAnICsgJFNjcmlwdDpXaW5kb3dzRWRpdGlvbiArICcgfCBXaW5kb3dzIFZlcnNpb24nICsgJFNjcmlwdDpXaW5kb3dzVmVyc2lvbikKICAgICAgICAkTG9jYWw6U3RyRW1haWwgKz0gKCJgcmBuYHJgbiIgKyAnVGhlcmUgaGF2ZSBub3cgYmVlbiB7MH0gcnVucywgYnV0IEJpdExvY2tlclRyaWdnZXIgU1RJTEwgZmFpbHMuJyAtZiAoJFNjcmlwdDpDb3VudFJ1bnMpKQogICAgICAgICRMb2NhbDpTdHJFbWFpbCArPSAoImByYG4iICsgJ1N1Y2Nlc3Mgc3RhdHVzIHwgRW5jcnlwdGVkIDogezB9IHwgUHJvdGVjdGlvbiBQYXNzd29yZHMgcHJlc2VudCA6IHsxfSB8IEJhY2t1cCB0byBBenVyZUFEIDogezJ9IHwgQmFja3VwIHRvIE9uZURyaXZlIDogezN9JyAtZiAoJFNjcmlwdDpJc0VuY3J5cHRlZCwkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3LCRTY3JpcHQ6SXNCYWNrdXBBQUQsJFNjcmlwdDpJc0JhY2t1cE9EKSkKICAgICAgICBMb2dXcml0ZSAoJExvY2FsOlN0ckVtYWlsKQogICAgICAgIDwjIyMgU2VuZCBlbWFpbAogICAgICAgICMjIE1haWwgYWRkcmVzcyhlcykKICAgICAgICBbc3RyaW5nXSAkTG9jYWw6U3RyVG9FbWFpbEFkZHJlc3MgPSAnT2xhdiBSLiBCaXJrZWxhbmQgPG9sYXZiQGlyb25zdG9laXQuY29tPjsnCiAgICAgICAgIyRTdHJFbWFpbEFkZHJlc3MgKz0gJ0lyb25zdG9uZSBTZXJ2aWNlZGVzayA8c2VydmljZWRla3NAaXJvbnN0b25laXQuY29tPicKICAgICAgICBbc3RyaW5nXSAkTG9jYWw6U3RyRnJvbUVtYWlsQWRkcmVzcyA9ICgnQml0TG9ja2VyVHJpZ2dlckZhaWxAezB9JyAtZiAoJFNjcmlwdDpOYW1lVGVuYW50KSkKICAgICAgICAjU2VuZC1NYWlsTWVzc2FnZSAtVG8gJExvY2FsOlN0clRvRW1haWxBZGRyZXNzIC1TbXRwU2VydmVyICAtRnJvbSAkTG9jYWw6U3RyRnJvbUVtYWlsQWRkcmVzcyAtU3ViamVjdCAkTG9jYWw6U3RyU3ViamVjdCAtQm9keSAkTG9jYWw6U3RyRW1haWwKICAgICAgICAjPgogICAgfQp9CgoKCgoKIyMjIyMjIyMjIyMjIyMjIyMjIyMKIyMjIyAgRCBPIE4gRSAgIyMjIyMKIyMjIyMjIyMjIyMjIyMjIyMjIyMKTG9nV3JpdGUgKCdBbGwgZG9uZSwgZXhpdGluZyBzY3JpcHQuLi4nKQojZW5kcmVnaW9uIE1haW4=')
        #endregion FilePS1
    #endregion Files
#endregion Variables




#region Main
    Write-Output -InputObject ('### {0}' -f ($NameScript))



    ###########################################################
    ### 1. Clean up BitLockerTrigger and IronTrigger
    Write-Output -InputObject ('{0}# 1. Clean up previous install paths.' -f ("`r`n`r`n"))
    
    # Paths
    Write-Verbose -Message ('Remove previous install path(s) if present')
    # Get Directory Paths
    $Local:RemPaths = [string[]]@(
        # Install Directory used in this script
        ($Script:PathDirInstall),
        # Install Dirs matching "*Trigger*" or "*BitLocker*" is ProgramFiles x64
        @(Get-ChildItem -Path ('{0}\IronstoneIT\' -f ($env:ProgramW6432)) -Directory -ErrorAction 'SilentlyContinue' | Where-Object {$_.Name -like '*trigger*' -or $_.Name -like '*BitLocker*'} | Select-Object -ExpandProperty 'FullName'),
        # Install Dirs matching "*Trigger*" or "*BitLocker*" is ProgramFiles x86
        @(Get-ChildItem -Path ('{0}\IronstoneIT\' -f (${env:ProgramFiles(x86)})) -Directory -ErrorAction 'SilentlyContinue' | Where-Object {$_.Name -like '*trigger*' -or $_.Name -like '*BitLocker*'} | Select-Object -ExpandProperty 'FullName')
    )
    # Remove Directory Paths
    foreach ($Path in $Local:RemPaths) {
        if (-not([string]::IsNullOrEmpty($Path.Trim()))) {
            Write-Verbose -Message ('   Removing "{0}" if it exists.' -f ($Path))
            if (Test-Path -Path $Path) {
                $null = Remove-Item -Path $Path -Force -Recurse
                Write-Verbose -Message ('      Directory does exist. Removing. Success? {0}' -f ($?))
            }
            else {
                Write-Verbose -Message ('      Directory does not exist')
            }
        }
    }
    
    # Stats and Logs
    Write-Verbose -Message ('Remove previous files: Stats and Logs')
    @(Get-ChildItem -Path ('{0}\Temp' -f ($env:windir)) -File -ErrorAction 'SilentlyContinue' | Where-Object {$_.Name -like '*trigger*'} | Select-Object -ExpandProperty 'FullName') | ForEach-Object {
        Remove-Item -Path $_ -Force
        Write-Verbose -Message ('Removing "{0}". Success? {1}.' -f ($_,$?.ToString()))
    }
    Get-ChildItem -Path $PathDirLog -Name '*EnableBitLocker.log' -File -Force -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'PSChildName' | ForEach-Object {Remove-Item -Path ('{0}{1}' -f ($PathDirLog,$_)) -Force}

    # Scheduled tasks
    Write-Verbose -Message ('Remove previous ScheduledTask(s)')
    $Local:ScheduledTasks = Get-ScheduledTask | Where-Object {
        # Exact Name
        @($Script:NameScheduledTask,'IronTrigger','Enable_BitLocker').Contains($_.TaskName) -or `
        # Regex
        $_.TaskName -like '*BitLocker' -or $_.TaskName -like '*IronTrigger*'
    }
    
    if ($Local:ScheduledTasks.length -gt 0) {
        $Local:ScheduledTasks | ForEach-Object {             
            $null = Unregister-ScheduledTask -TaskName $_.TaskName -Confirm:$false -ErrorAction 'SilentlyContinue'
            Write-Verbose -Message ('  Removing the Scheduled task "{0}". Success? {1}' -f ($_.TaskName,$?))
        }
    }
    else {
        if (Get-ScheduledTask -TaskName $Script:NameScheduledTask -ErrorAction 'SilentlyContinue') {            
            $null = Unregister-ScheduledTask -TaskName $Script:NameScheduledTask -Confirm:$false -ErrorAction 'SilentlyContinue'
            Write-Verbose -Message ('  Removing the Scheduled task "{0}". Success? {1}' -f ($Script:NameScheduledTask,$?))
        }
        else {
            Write-Verbose -Message ('  Scheduled task "{0}" does not exist.' -f ($Script:ScheduledTaskName))
        }
    }




    ###########################################################
    ### 2. Install Files
    Write-Output -InputObject ('{0}# 2. Install files.' -f ("`r`n`r`n"))
    $SuccessInstallFile = [bool]$(Out-File -FilePath $Script:PathDirInstall -Encoding 'Utf8' -InputObject ([System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($Script:ContentFilePS1))) -Force:$True -ErrorAction 'SilentlyContinu')
    Write-Verbose -Message ('   Success? {0}' -f ($SuccessInstallFile))
    if (-not($SuccessInstallFile)) {Break}



    
    ###########################################################
    ### 3. Surpress BitLocker Toast Notifications
    Write-Output -InputObject ('{0}# 3. Surpress BitLocker Toast Notifications.' -f ("`r`n`r`n"))

    # Create registry base path to HKCU:\ from System context
    $RegDirBase = [string]$('Registry::HKEY_USERS\{0}\Software\Microsoft\Windows\CurrentVersion\Notifications\Settings' -f ($Script:StrIntuneUserSID))
    
    # Registry paths to disable BitLocker Toast Notifications
    $RegDirs    = [string[]]@(
        [string]('{0}\Windows.SystemToast.BitLockerPolicyRefresh' -f ($RegDirBase)),
        [string]('{0}\Windows.SystemToast.BdeUnlock' -f ($RegDirBase))
    )

    # Set registry values
    foreach ($RegDir in $RegDirs) {
        if (-not(Test-Path -Path $RegDir)) {$null = New-Item -Path $RegDir -ItemType 'Directory' -Force}
        $null = Set-ItemProperty -Path $RegDir -Name 'Enabled' -Value 0 -Type 'DWord' -Force
        Write-Verbose -Message ('   Success? {0}' -f ($?))
    }




    ###########################################################
    ### 4. Create ScheduledTask and run it if success
    Write-Output -InputObject ('{0}# 4. Create Scheduled Task "{1}", run it if success.' -f ("`r`n`r`n",$Script:NameScheduledTask))
    # Get path of PowerShell.exe and the .PS1 file
    $PathFilePowerShell = [string] '%SystemRoot%\system32\WindowsPowerShell\v1.0\powershell.exe' # Works regardless of 64bit vs 32bit
    $PathFilePS1        = [string] ('{0}\{1}' -f ($Script:PathDirInstall,$Script:NameFilePS1))
    # Create Scheduled Task
    #region    Create Scheduled Task running PS1 using PowerShell.exe - Every 15 Minutes
        # Construct Scheduled Task
        $ScheduledTask = New-ScheduledTask                                                    `
            -Action    (New-ScheduledTaskAction -Execute ('"{0}"' -f ($PathFilePowerShell)) -Argument ('-ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -WindowStyle Hidden -File "{0}"' -f ($PathFilePS1))) `
            -Principal (New-ScheduledTaskPrincipal -UserId 'NT AUTHORITY\SYSTEM' -RunLevel 'Highest')                                                                                                                   `
            -Trigger   (New-ScheduledTaskTrigger -Once -At ([datetime]::Today) -RepetitionInterval ([timespan]::FromMinutes(15)))                                                                                       `
            -Settings  (New-ScheduledTaskSettingsSet -Hidden -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -ExecutionTimeLimit ([timespan]::FromMinutes(10)) -Compatibility 4 -StartWhenAvailable)
        $ScheduledTask.Author      = 'Ironstone'
        $ScheduledTask.Description = ('{0}Runs a PowerShell script. {1}Execute: "{2}". {1}Arguments: "{3}".' -f (
            $(if([string]::IsNullOrEmpty($DescriptionScheduledTask)){''}else{('{0} {1}' -f ($DescriptionScheduledTask,"`r`n"))}),"`r`n",
            [string]($ScheduledTask | Select-Object -ExpandProperty 'Actions' | Select-Object -ExpandProperty 'Execute'),
            [string]($ScheduledTask | Select-Object -ExpandProperty 'Actions' | Select-Object -ExpandProperty 'Arguments')
        ))

        # Register Scheduled Task
        $null = Register-ScheduledTask -TaskName $NameScheduledTask -InputObject $ScheduledTask -Force -Verbose:$false -Debug:$false
                
        # Check if success registering Scheduled Task
        $SuccessCreatingScheduledTask = [bool]$($? -and [bool]$([byte](@(Get-ScheduledTask -TaskName $NameScheduledTask).Count) -eq 1))
        Write-Verbose -Message ('Success creating scheduled task "{0}"? "{1}".' -f ($NameScheduledTask,$SuccessCreatingScheduledTask.ToString()))
                
        # Run Scheduled Task if Success Creating It
        if ($SuccessCreatingScheduledTask) {$null = Start-ScheduledTask -TaskName $NameScheduledTask}
        else {Write-Error -Message 'ERROR: Failed to create scheduled task.'}
    #endregion Create Scheduled Task running PS1 using PowerShell.exe - Every 15 Minutes




    ###########################################################
    ### Done
    Write-Output -InputObject ('{0}Done.' -f ("`r`n`r`n"))    
#endregion Main



################################################
#endregion Your Code Here
################################################   
#region    Don't touch this
}
Catch {
    # Construct Message
    $ErrorMessage = [string]('{0} finished with errors:' -f ($Script:NameScriptFull))
    $ErrorMessage += ('{0}{0}Exception:{0}{1}'           -f ("`r`n",$_.Exception))
    $ErrorMessage += ('{0}{0}Activity:{0}{1}'            -f ("`r`n",$_.CategoryInfo.Activity))
    $ErrorMessage += ('{0}{0}Error Category:{0}{1}'      -f ("`r`n",$_.CategoryInfo.Category))
    $ErrorMessage += ('{0}{0}Error Reason:{0}{1}'        -f ("`r`n",$_.CategoryInfo.Reason))
    # Write Error Message
    Write-Error -Message $ErrorMessage
}
Finally {
    # Unload Users' Registry Profiles (NTUSER.DAT) if any were loaded
    if ($Script:BoolIsSystem -and ([string[]]@($RegistryLoadedProfiles | Where-Object -FilterScript {-not([string]::IsNullOrEmpty($_))})).Count -gt 0) {
        # Close Regedit.exe if running, can't unload hives otherwise
        $null = Get-Process -Name 'regedit' -ErrorAction 'SilentlyContinue' | ForEach-Object -Process{Stop-Process -InputObject $_ -ErrorAction 'SilentlyContinue'}
            
        # Get all logged in users
        $SIDsLoggedInUsers = [string[]]@(([string[]]@(Get-Process -Name 'explorer' -IncludeUserName | Select-Object -ExpandProperty 'UserName' -Unique | ForEach-Object -Process {Try{[System.Security.Principal.NTAccount]::new(($_)).Translate([System.Security.Principal.SecurityIdentifier]).Value}Catch{}} | Where-Object -FilterScript {-not([string]::IsNullOrEmpty($_))}) + @([string]([System.Security.Principal.WindowsIdentity]::GetCurrent().User.Value))) | Select-Object -Unique)

        foreach ($SID in $RegistryLoadedProfiles) {
            # If SID is found in $SIDsLoggedInUsers - Don't Unload Hive
            if ([bool]$(([string[]]@($SIDsLoggedInUsers | ForEach-Object -Process {$_.Trim().ToUpper()})).Contains($SID.Trim().ToUpper()))) {
                Write-Output -InputObject ('User with SID "{0}" is currently logged in, will not unload registry hive.' -f ($SID))
            }
            # If SID is not found in $SIDsLoggedInUsers - Unload Hive
            else {
                $PathUserHive = [string]('HKEY_USERS\{0}' -f ($SID))
                $null = Start-Process -FilePath ('{0}\reg.exe' -f ([string]([system.environment]::SystemDirectory))) -ArgumentList ('UNLOAD "{0}"' -f ($PathUserHive)) -WindowStyle 'Hidden' -Wait

                # Check success
                if (Test-Path -Path ('Registry::{0}' -f ($PathUserHive)) -ErrorAction 'SilentlyContinue') {
                    Write-Output -InputObject ('ERROR: Failed to unload user registry hive "{0}".' -f ($PathUserHive)) -ErrorAction 'Continue'
                }
                else {
                    Write-Output -InputObject ('Successfully unloaded user registry hive "{0}".' -f ($PathUserHive))
                }
            }
        }
    }
    
    # Stop Transcript
    Stop-Transcript
}
#endregion Don't touch this