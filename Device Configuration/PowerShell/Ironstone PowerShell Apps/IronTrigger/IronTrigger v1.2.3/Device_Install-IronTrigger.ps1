<#
.SYNOPSIS
    <Short, what it does>


.DESCRIPTION
    <Long, what it does>


.OUTPUTS
    <What it outputs during runtime>


Usage:


Todo:


Resources:


#>


#region Variables
# Settings
[bool] $Script:DebugLogFile = $true
[bool] $Script:DebugConsole = $false
[bool] $Script:ReadOnly     = $false
If ($Script:DebugLogFile) {[String] $Script:DebugStr=[String]::Empty}

# Variables
[bool]   $Script:DeviceScope    = $true
[string] $Script:NameApp        = 'IronTrigger'
[string] $Script:NameScript     = 'Device_Install-IronTrigger'
[string] $Script:DirLog         = ('{0}\Program Files\IronstoneIT\Intune\DeviceConfiguration\' -f ($env:SystemDrive))
[string] $Script:DirInstall     = ('{0}\Program Files\IronstoneIT\{1}\' -f ($env:SystemDrive,$Script:NameApp))


# Script specific variables
[string] $Script:ScheduledTaskName = 'IronTrigger'


# Files
#region Files
# Enable-BitLockerTrigger.PS1
#region FilePS1
[string] $Script:NamePS1 = 'Enable_BitLocker.ps1'
[string] $Script:FilePS1 = ('PCNQU1NjcmlwdEluZm8gCi5WRVJTSU9OIDEuNwouR1VJRCBmNTE4N2UzZi1lZDBhLTRjZTEtYjQzOC1kOGY0MjE2MTljYTMgCi5PUklHSU5BTCBBVVRIT1IgSmFuIFZhbiBNZWlydmVubmUgCi5NT0RJRklFRCBCWSBPbGF2IFIuIEJpcmtlbGFuZCwgU29vcmFqIFJhamFnb3BhbGFuLCBQYXVsIEh1aWpicmVndHMsIFBpZXRlciBXaWdsZXZlbiAmIE5pYWxsIEJyYWR5ICh3aW5kb3dzLW5vb2IuY29tIDIwMTcvOC8xNykKLkNPUFlSSUdIVCAKLlRBR1MgQXp1cmUgSW50dW5lIEJpdExvY2tlciAgCi5MSUNFTlNFVVJJICAKLlBST0pFQ1RVUkkgIAouSUNPTlVSSSAgCi5FWFRFUk5BTE1PRFVMRURFUEVOREVOQ0lFUyAgCi5SRVFVSVJFRFNDUklQVFMgIAouRVhURVJOQUxTQ1JJUFRERVBFTkRFTkNJRVMgIAouUkVMRUFTRU5PVEVTCi5UT0RPIAojPgoKPCMgCiAKLkRFU0NSSVBUSU9OIAogQ2hlY2sgd2hldGhlciBCaXRMb2NrZXIgaXMgRW5hYmxlZCwgaWYgbm90IEVuYWJsZSBCaXRMb2NrZXIgb24gQUFEIEpvaW5lZCBkZXZpY2VzIGFuZCBzdG9yZSByZWNvdmVyeSBpbmZvIGluIEFBRCAKIEFkZGVkIGxvZ2dpbmcKIz4gCgpbY21kbGV0YmluZGluZygpXQpwYXJhbSgKICAgIFtQYXJhbWV0ZXIoKV0KICAgIFtWYWxpZGF0ZU5vdE51bGxPckVtcHR5KCldCiAgICBbc3RyaW5nXSAkT1NEcml2ZSA9ICRlbnY6U3lzdGVtRHJpdmUKKQpbTmV0LlNlcnZpY2VQb2ludE1hbmFnZXJdOjpTZWN1cml0eVByb3RvY29sID0gW05ldC5TZWN1cml0eVByb3RvY29sVHlwZV06OlRsczEyCgoKCiNyZWdpb24gU2V0dGluZ3MgYW5kIFZhcmlhYmxlcwojIyMgU2V0dGluZ3MKICAgICMgSWYgb24sIHdpbGwgcHJvbXB0IHVzZXIgdG8gcmVib290IHdpdGggV2luZG93cyBGb3JtcyBHVUkuCiAgICBbYm9vbF0gJEdVSSA9ICRmYWxzZQogICAgIyBJZiBvbiwgd2lsbCByZW1vdmUgYWxsIGZpbGVzIGFmdGVyIGZpcnN0IHN1Y2Nlc3MuCiAgICBbYm9vbF0gJFNjcmlwdDpCb29sUmVtb3ZlRmlsZXNBZnRlclN1Y2Nlc3MgPSAkZmFsc2UKICAgICMgSWYgb2ZmLCB3aWxsIGNoYW5nZSBzY2hlZHVsZWQgdGFzayB0byBydW4gb25jZSBhIGRheSBhdCAxMjowMCBhZnRlciBmaXJzdCBzdWNjZXNzZnVsbCBydW4sIG9yIGFmdGVyIDMwIGZhaWxlZCBydW5zCiAgICAjIElmIG9uLCB3aWxsIGRlbGV0ZSBzY2hlZHVsZWQgdGFzayBhZnRlciBmaXJzdCBzdWNjZXNzZnVsbCBydW4gYW5kIGFmdGVyIDMwIGZhaWxlZCBydW5zCiAgICBbYm9vbF0gJFNjcmlwdDpCb29sUmVtb3ZlU2NoZWR1bGVkVGFza0FmdGVyRmlyc3RTdWNjZXNzID0gJGZhbHNlCiMjIyBWYXJpYWJsZXMKICAgIFtzdHJpbmddICRTY3JpcHQ6TmFtZVNjcmlwdCAgICAgICAgID0gJ0lyb25UcmlnZ2VyJwogICAgW3N0cmluZ10gJFNjcmlwdDpTY2hlZHVsZWRUYXNrTmFtZSA9ICRTY3JpcHQ6TmFtZVNjcmlwdC5DbG9uZSgpCiAgICBbc3RyaW5nXSAkU2NyaXB0OkRpckluc3RhbGwgICAgICAgID0gKCd7MH1cUHJvZ3JhbSBGaWxlc1xJcm9uc3RvbmVJVFx7MX1cJyAtZiAoJGVudjpTeXN0ZW1Ecml2ZSwkU2NyaXB0Ok5hbWVTY3JpcHQpKQogICAgW3N0cmluZ10gJFNjcmlwdDpEaXJMb2cgICAgICAgICAgICA9ICgnezB9XFByb2dyYW0gRmlsZXNcSXJvbnN0b25lSVRcSW50dW5lXERldmljZUNvbmZpZ3VyYXRpb25cJyAtZiAoJGVudjpTeXN0ZW1Ecml2ZSkpCiAgICBbc3RyaW5nXSAkU2NyaXB0OkZpbGVMb2cgICAgICAgICAgID0gKCd7MH1Jcm9uVHJpZ2dlciAtIEVuYWJsZUJpdExvY2tlci5sb2cnIC1mICgkU2NyaXB0OkRpckxvZykpCiAgICBbc3RyaW5nXSAkU2NyaXB0OkZpbGVTdGF0cyAgICAgICAgID0gKCd7MH1zdGF0cy50eHQnIC1mICgkU2NyaXB0OkRpckluc3RhbGwpKQojIEhlbHAgVmFyaWFibGVzIChET04nVCBDSEFOR0UpCiAgICBbc3RyaW5nXSAkU2NyaXB0OkNvbXB1dGVyTmFtZSAgICAgID0gJGVudjpDT01QVVRFUk5BTUUKICAgIFtib29sXSAgICRTY3JpcHQ6Qm9vbERpZEFueXRoaW5nQ2hhbmdlVGhpc1J1bnRpbWUgPSAkZmFsc2UKICAgIFtTdHJpbmdbXV0gJFNjcmlwdDpCaXRMb2NrZXJWb2x1bWVFbmNyeXB0aW9uU3RhdHVzZXMgPSBAKCdGdWxseURlY3J5cHRlZCcsJ0VuY3J5cHRpb25JblByb2dyZXNzJywnRnVsbHlFbmNyeXB0ZWQnKQojZW5kcmVnaW9uIFNldHRpbmdzIGFuZCBWYXJpYWJsZXMKCgoKI3JlZ2lvbiBGdW5jdGlvbnMKICAgICNyZWdpb24gTG9nZ2luZyBhbmQgT3V0cHV0CiAgICAgICAgI3JlZ2lvbiBMb2dXcml0ZQogICAgICAgIEZ1bmN0aW9uIExvZ1dyaXRlIHsKICAgICAgICAgICAgUGFyYW0gKFtzdHJpbmddJExvZ1N0cmluZykKICAgICAgICAgICAgW3N0cmluZ10gJGEgPSBHZXQtRGF0ZQogICAgICAgICAgICBbc3RyaW5nXSAkTG9nU3RyaW5nID0gJGEsICRMb2dTdHJpbmcKICAgICAgICAgICAgQWRkLWNvbnRlbnQgLVBhdGggJFNjcmlwdDpGaWxlTG9nIC1WYWx1ZSAkTG9nU3RyaW5nCiAgICAgICAgICAgIFdyaXRlLUhvc3QgJExvZ1N0cmluZwogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIExvZ1dyaXRlCgogICAgICAgICNyZWdpb24gTG9nRXJyb3JzCiAgICAgICAgRnVuY3Rpb24gTG9nRXJyb3JzIHsKICAgICAgICAgICAgTG9nV3JpdGUgKCdDYXVnaHQgYW4gZXhjZXB0aW9uOicpCiAgICAgICAgICAgIExvZ1dyaXRlICgnRXhjZXB0aW9uIFR5cGU6ICcgKyAkKCRfLkV4Y2VwdGlvbi5HZXRUeXBlKCkuRnVsbE5hbWUpKQogICAgICAgICAgICBMb2dXcml0ZSAoJ0V4Y2VwdGlvbiBNZXNzYWdlOiAnICsgJCgkXy5FeGNlcHRpb24uTWVzc2FnZSkpCiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gTG9nRXJyb3JzCgoKICAgICAgICAjcmVnaW9uIFdyaXRlLVN0YXRzCiAgICAgICAgIyBXcml0ZS1TdGF0czogT3V0cHV0cyBjdXJyZW50IHN0YXR1cyBvZiB2YXJpb3VzIGJvb2xlYW5zIGFuZCBvdGhlciBtZWFzdXJlbWVudHMKICAgICAgICBGdW5jdGlvbiBXcml0ZS1TdGF0cyB7ICAgIAogICAgICAgICAgICBQYXJhbSgKICAgICAgICAgICAgICAgIFtwYXJhbWV0ZXIoTWFuZGF0b3J5PSRmYWxzZSldCiAgICAgICAgICAgICAgICBbYm9vbF0gJFByZXZpb3VzT25seSA9ICRmYWxzZQogICAgICAgICAgICApCiAgICAgICAgICAgICMgR2VuZXJhbAogICAgICAgICAgICBpZiAoJFByZXZpb3VzT25seSkgewogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdSdW5zOiB7MH0gfCBIYXMgSXJvblRyaWdnZXIgaGFkIGEgc3VjY2Vzc2Z1bGwgcnVuIGFscmVhZHk/IHsxfScgLWYgKCRTY3JpcHQ6Q291bnRSdW5zLCRTY3JpcHQ6SXNGaW5pc2hlZDFzdFRpbWUpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAjIE9TIERyaXZlCiAgICAgICAgICAgIExvZ1dyaXRlICgnT1MgZHJpdmUgKHswfSkgfCBFbmNyeXB0ZWQ6IHsxfSB8IFJlY292ZXJ5IFBhc3N3b3JkcyBwcmVzZW50OiB7Mn0gfCBCYWNrdXAgdG8gT25lRHJpdmU6IHszfSB8IEJhY2t1cCB0byBBenVyZUFEOiB7NH0nIC1mICgkT1NEcml2ZSwkU2NyaXB0OklzRW5jcnlwdGVkLCRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3csJFNjcmlwdDpJc0JhY2t1cE9ELCRTY3JpcHQ6SXNCYWNrdXBBQUQpKQogICAgICAgICAgICBpZiAoLW5vdCgkUHJldmlvdXNPbmx5KSkgewogICAgICAgICAgICAgICAgTG9nd3JpdGUgKCdPUyBkcml2ZSAoezB9KSB8IFZvbHVtZVN0YXR1czogezF9IHwgUHJvdGVjdGlvblN0YXR1czogezJ9JyAtZiAoJE9TRHJpdmUsJFNjcmlwdDpWb2x1bWVFbmNTdGF0dXMsJFNjcmlwdDpWb2x1bWVQcm90ZWN0aW9uU3RhdHVzKSkgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICgkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXKSB7CiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdPUyBkcml2ZSAoezB9KSB8IFByZXNlbmNlIG9mIEJpdExvY2tlciBLZXlQcm90ZWN0b3IgfCBUUE06IHsxfSB8IFJlY292ZXJ5UGFzc3dvcmQ6IHsyfScgLWYgKCRPU0RyaXZlLCRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMF0sJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1sxXSkpCiAgICAgICAgICAgICAgICAgICAgaWYgKCRTY3JpcHQ6Vm9sdW1lRW5jU3RhdHVzWzFdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnT1MgZHJpdmUgKHswfSkgfCB7MX0nIC1mICgkT1NEcml2ZSwoV3JpdGUtUmVjb3ZlcnlQYXNzd29yZCkpKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE90aGVyIGZpeGVkIGRyaXZlcyB3aXRoIGEgZHJpdmUgbGV0dGVyCiAgICAgICAgICAgICAgICA8IyAjVE9ETwogICAgICAgICAgICAgICAgaWYgKCRTY3JpcHQ6T3RoZXJFbmNyeXB0ZWREcml2ZXMpIHsKICAgICAgICAgICAgICAgICAgICAkU2NyaXB0Ok90aGVyRW5jcnlwdGVkRHJpdmVzIHwgRm9yRWFjaC1PYmplY3QgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoLW5vdChbc3RyaW5nXTo6SXNOdWxsT3JFbXB0eSgkU2NyaXB0Ok90aGVyRW5jcnlwdGVkRHJpdmVzWzBdKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtzdHJpbmddICRMb2NhbDpEcml2ZVZvbHVtZVN0YXR1cyA9IChHZXQtVmFyaWFibGUgLU5hbWUgKCdWb2x1bWV7MH1FbmNTdGF0dXMnIC1mICRfKSAtU2NvcGUgJ1NjcmlwdCcpLlZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6RHJpdmVQcm90ZWN0aW9uU3RhdHVzID0gKEdldC1WYXJpYWJsZSAtTmFtZSAoJ1ZvbHVtZXswfVByb3RlY3Rpb25TdGF0dXMnIC1mICRfKSAtU2NvcGUgJ1NjcmlwdCcpLlZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMb2d3cml0ZSAoJ1N0YXR1cyBkcml2ZSAiezB9IiB8IFZvbHVtZVN0YXR1czogezF9IHwgUHJvdGVjdGlvblN0YXR1czogezJ9JyAtZiAoJF8sJExvY2FsOkRyaXZlVm9sdW1lU3RhdHVzLCRMb2NhbDpEcml2ZVByb3RlY3Rpb25TdGF0dXMpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgW2Jvb2xbXV0gJExvY2FsOktleVByb3RlY3RvclR5cGVzID0gR2V0LUJpdExvY2tlcktleVByb3RlY3RvclR5cGVzIC1Ecml2ZUxldHRlciAkXwogICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdCaXRMb2NrZXIgS2V5UHJvdGVjdG9yIFR5cGVzIHByZXNlbnQgZm9yIGRyaXZlICJ7MH0iPyB8IFRQTTogezF9IHwgUmVjb3ZlcnlQYXNzd29yZDogezJ9JyAtZiAoJF8sJExvY2FsOktleVByb3RlY3RvclR5cGVzWzBdLCRMb2NhbDpLZXlQcm90ZWN0b3JUeXBlc1sxXSkpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9Iz4KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIFdyaXRlLVN0YXRzCgoKICAgICAgICAjcmVnaW9uIFdyaXRlLVJlY292ZXJ5UGFzc3dvcmQKICAgICAgICAjIFdyaXRlLVJlY292ZXJ5UGFzc3dvcmQKICAgICAgICBGdW5jdGlvbiBXcml0ZS1SZWNvdmVyeVBhc3N3b3JkIHsKICAgICAgICAgICAgW2J5dGVdICRMb2NhbDpDID0gJChJZigkU2NyaXB0OkNvdW50UmVjb3ZlcnlQYXNzd29yZHMpeyRTY3JpcHQ6Q291bnRSZWNvdmVyeVBhc3N3b3Jkc31FbHNlezB9KQogICAgICAgICAgICBSZXR1cm4gKFtzdHJpbmddICgnezB9IFJlY292ZXJ5IFBhc3N3b3JkKHMpIHByZXNlbnQuezF9JyAtZiAoJExvY2FsOkMsKCQoSWYoJExvY2FsOkMgLWdlIDEpeyd7MH17MX0nIC1mICgiYHJgbiIsKEdldC1TdHJpbmdSZWNvdmVyeVBhc3N3b3JkcykpfSkpKSkpCiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gV3JpdGUtUmVjb3ZlcnlQYXNzd29yZAoKCiAgICAgICAgI3JlZ2lvbiBHZXQtU3RyaW5nUmVjb3ZlcnlQYXNzd29yZHMKICAgICAgICAjIFJldHVybnMgYSBzdHJpbmcgY29udGFpbmluZyB0aGUgcmVjb3ZlcnkgcGFzc3dvcmRzIGZyb20gJFNjcmlwdDpBcnJheVJlY292ZXJ5UGFzc3dvcmRzLiBVc2VmdWxsIGZvciBwcmludGluZy8gbG9nZ2luZy8gYmFja3VwCiAgICAgICAgRnVuY3Rpb24gR2V0LVN0cmluZ1JlY292ZXJ5UGFzc3dvcmRzIHsKICAgICAgICAgICAgUGFyYW0oCiAgICAgICAgICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeT0kZmFsc2UpXQogICAgICAgICAgICAgICAgW3N0cmluZ10gJERyaXZlTGV0dGVyID0gJE9TRHJpdmUKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDcmVhdGUgdmFyaWFibGUgbmFtZXMKICAgICAgICAgICAgW3N0cmluZ10gJExvY2FsOkFyck5hbWUgPSAnQXJyYXlSZWNvdmVyeVBhc3N3b3JkcycKICAgICAgICAgICAgaWYgKCREcml2ZUxldHRlci5TdWJzdHJpbmcoMCwxKSAtbmUgJGVudjpTeXN0ZW1Ecml2ZS5TdWJzdHJpbmcoMCwxKSkgewogICAgICAgICAgICAgICAgJExvY2FsOkFyck5hbWUgPSAoJ3swfXsxfScgLWYgKCREcml2ZUxldHRlci5TdWJzdHJpbmcoMCwxKSwkTG9jYWw6QXJyTmFtZSkpCiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAjIEdldCBBcnJheSwgbG9vcCBpdC4gSWRlYWxseSBvbmx5IG9uZSBwdywgYnV0IGxvb3AganVzdCB0byBiZSBzYWZlLgogICAgICAgICAgICBbdWludDE2XSAkTG9jYWw6VGVtcENvdW50ZXIgPSAwCiAgICAgICAgICAgIFtzdHJpbmddICRMb2NhbDpPdXRTdHIgPSBbc3RyaW5nXTo6RW1wdHkKICAgICAgICAgICAgKEdldC1WYXJpYWJsZSAtTmFtZSAkTG9jYWw6QXJyTmFtZSAtU2NvcGUgJ1NjcmlwdCcpLlZhbHVlIHwgRm9yRWFjaC1PYmplY3QgewogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciArPSAoJ3swfSB8IEtleVByb3RlY3RvcklkICJ7MX0iIHwgUmVjb3ZlcnlQYXNzd29yZCAiezJ9IicgLWYgKCgkTG9jYWw6VGVtcENvdW50ZXIgKz0gMSksJF8uS2V5UHJvdGVjdG9ySWQsJF8uUmVjb3ZlcnlQYXNzd29yZCkpCiAgICAgICAgICAgICAgICBpZiAoJExvY2FsOlRlbXBDb3VudGVyIC1sdCAoKEdldC1WYXJpYWJsZSAtTmFtZSAkTG9jYWw6QXJyTmFtZSAtU2NvcGUgJ1NjcmlwdCcpLlZhbHVlKS5Db3VudCkgeyRMb2NhbDpPdXRTdHIgKz0gImByYG4ifQogICAgICAgICAgICB9CgogICAgICAgICAgICAjIFJldHVybiB0aGUgc3RyaW5nCiAgICAgICAgICAgIFJldHVybiAkTG9jYWw6T3V0U3RyCiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gR2V0LVN0cmluZ1JlY292ZXJ5UGFzc3dvcmRzCiAgICAjZW5kcmVnaW9uIExvZ2dpbmcgYW5kIE91dHB1dAoKCgogICAgI3JlZ2lvbiBSZXR1cm4gVmFsdWVzIChVc2VkIGJ5IG90aGVyIEZ1bmN0aW9ucykKICAgICAgICAjcmVnaW9uIEdldC1CaXRMb2NrZXJLZXlQcm90ZWN0b3JUeXBlcwogICAgICAgICMgUmV0dXJucyBhIGJvb2wgYXJyYXksIHdoZXJlIHRoZSBmaXJzdCByZXByZXNlbnRzIHN0YXR1cyBvZiBUUE0gcHJlc2VuY2UsIGFuZCB0aGUgc2Vjb25kIGZvciBQcm90ZWN0aW9uIFBhc3N3b3JkCiAgICAgICAgRnVuY3Rpb24gR2V0LUJvb2xEcml2ZUhhc0JpdExvY2tlclRQTWFuZFBXIHsKICAgICAgICAgICAgUGFyYW0oCiAgICAgICAgICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeT0kZmFsc2UpXQogICAgICAgICAgICAgICAgW3N0cmluZ10gJERyaXZlTGV0dGVyID0gJE9TRHJpdmUKICAgICAgICAgICAgKQogICAgICAgICAgICAkTG9jYWw6Qml0TG9ja2VyU3RhdHVzID0gR2V0LUJpdExvY2tlclZvbHVtZSAtTW91bnRQb2ludCAkRHJpdmVMZXR0ZXIKICAgICAgICAgICAgW3VpbnQxNl0gJExvY2FsOkNvdW50UmVjUGFzcyA9IDAKICAgICAgICAgICAgW3VpbnQxNl0gJExvY2FsOkNvdW50VFBNID0gMAogICAgICAgICAgICAkTG9jYWw6Qml0TG9ja2VyU3RhdHVzLktleVByb3RlY3RvciB8IEZvckVhY2gtT2JqZWN0IHsKICAgICAgICAgICAgICAgIGlmICgkXy5LZXlQcm90ZWN0b3JUeXBlIC1lcSAnUmVjb3ZlcnlQYXNzd29yZCcpIHskTG9jYWw6Q291bnRSZWNQYXNzICs9IDF9CiAgICAgICAgICAgICAgICBlbHNlaWYgKCRfLktleVByb3RlY3RvclR5cGUgLWVxICdUUE0nKSB7JExvY2FsOkNvdW50VFBNICs9IDF9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIChbYm9vbF0gKCRMb2NhbDpDb3VudFRQTSAtZ2UgMSksW2Jvb2xdICgkTG9jYWw6Q291bnRSZWNQYXNzIC1nZSAxKSkKICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbkdldC1CaXRMb2NrZXJLZXlQcm90ZWN0b3JUeXBlcwoKCiAgICAgICAgI3JlZ2lvbiBHZXQtQXJyYXlSZWNvdmVyeVBhc3N3b3JkcwogICAgICAgICMgUmV0dXJucyBhIEFycmF5TGlzdCB3aXRoIGV4aXN0aW5nIFByb3RlY3Rpb25QYXNzd29yZHMKICAgICAgICBGdW5jdGlvbiBHZXQtQXJyYXlSZWNvdmVyeVBhc3N3b3JkcyB7CiAgICAgICAgICAgIFBhcmFtKAogICAgICAgICAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnk9JHRydWUpXQogICAgICAgICAgICAgICAgW01pY3Jvc29mdC5CaXRMb2NrZXIuU3RydWN0dXJlcy5CaXRMb2NrZXJWb2x1bWVdICRCaXRMb2NrZXJWb2x1bWUKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBHZXQgQml0TG9ja2VyIFByb3RlY3Rpb25QYXNzd29yZHMKICAgICAgICAgICAgJExvY2FsOktleVByb3RlY3RvclN0YXR1cyA9ICgkQml0TG9ja2VyVm9sdW1lIHwgU2VsZWN0LU9iamVjdCAtUHJvcGVydHkgS2V5UHJvdGVjdG9yKS5LZXlQcm90ZWN0b3IKICAgICAgICAgICAgJExvY2FsOkFycmF5UmVjb3ZlcnlQYXNzd29yZHMgPSBOZXctT2JqZWN0IE1pY3Jvc29mdC5CaXRMb2NrZXIuU3RydWN0dXJlcy5CaXRMb2NrZXJWb2x1bWVLZXlQcm90ZWN0b3JbXSAoJExvY2FsOktleVByb3RlY3RvclN0YXR1cy5Db3VudCAtIDEpCgogICAgICAgICAgICAkTG9jYWw6SW5kZXhDb3VudCA9IFtieXRlXTo6TWluVmFsdWUKICAgICAgICAgICAgJExvY2FsOktleVByb3RlY3RvclN0YXR1cyB8IEZvckVhY2gtT2JqZWN0IHsKICAgICAgICAgICAgICAgIGlmICgkXy5LZXlQcm90ZWN0b3JUeXBlIC1lcSAnUmVjb3ZlcnlQYXNzd29yZCcpIHsKICAgICAgICAgICAgICAgICAgICAkbnVsbCA9ICRMb2NhbDpBcnJheVJlY292ZXJ5UGFzc3dvcmRzWyRMb2NhbDpJbmRleENvdW50KytdID0gJF8KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gKCRMb2NhbDpBcnJheVJlY292ZXJ5UGFzc3dvcmRzKQogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIEdldC1BcnJheVJlY292ZXJ5UGFzc3dvcmRzCgoKICAgICAgICAjcmVnaW9uIEdldC1Wb2x1bWVVbmlxdWVJRAogICAgICAgIEZ1bmN0aW9uIEdldC1Wb2x1bWVVbmlxdWVJRCB7CiAgICAgICAgICAgIHBhcmFtKAogICAgICAgICAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnk9JHRydWUpXQogICAgICAgICAgICAgICAgW3N0cmluZ10gJERyaXZlTGV0dGVyCiAgICAgICAgICAgICkKICAgICAgICAgICAgJExvY2FsOkFEcml2ZUxldHRlciA9ICREcml2ZUxldHRlci5TdWJzdHJpbmcoMCwxKQogICAgICAgICAgICAkTG9jYWw6Vm9sdW1lSUQgPSAoR2V0LVZvbHVtZSAtRHJpdmVMZXR0ZXIgJEFEcml2ZUxldHRlciB8IFNlbGVjdCAqKS5VbmlxdWVJRC5TcGxpdCgneycpWy0xXQogICAgICAgICAgICAkTG9jYWw6Vm9sdW1lSUQgPSAkTG9jYWw6Vm9sdW1lSUQuU3ViU3RyaW5nKDAsKCRMb2NhbDpWb2x1bWVJRC5MZW5ndGggLSAyKSkKCiAgICAgICAgICAgIHJldHVybiAkTG9jYWw6Vm9sdW1lSUQKICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBHZXQtVm9sdW1lVW5pcXVlSUQKCgogICAgICAgICNyZWdpb24gQ2hlY2stSWZCaXRMb2NrZXJQV0hhc0NoYW5nZWQKICAgICAgICBGdW5jdGlvbiBDaGVjay1JZkJpdExvY2tlclBXSGFzQ2hhbmdlZHsKICAgICAgICAgICAgcGFyYW0oCiAgICAgICAgICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeT0kZmFsc2UpXQogICAgICAgICAgICAgICAgW3N0cmluZ10gJERyaXZlTGV0dGVyID0gJE9TRHJpdmUKICAgICAgICAgICAgKQogICAgICAgICAgICBbYm9vbF0gJExvY2FsOkhhc0NoYW5nZWQgPSAkZmFsc2UKCgogICAgICAgICAgICAjIE5hbWUgVmFyaWFibGVzCiAgICAgICAgICAgIFtzdHJpbmddICRMb2NhbDpOYW1lQXJyYXkgPSAnQXJyYXlSZWNvdmVyeVBhc3N3b3JkcycKICAgICAgICAgICAgW3N0cmluZ10gJExvY2FsOk5hbWVGaWxlICA9ICgnezB9LnR4dCcgLWYgKCRWb2x1bWVVbmlxdWVJRCkpCiAgICAgICAgICAgIFtzdHJpbmddICRMb2NhbDpWb2x1bWVJRCA9ICRTY3JpcHQ6Vm9sdW1lVW5pcXVlSUQKICAgICAgICAgICAgaWYgKCREcml2ZUxldHRlci5TdWJzdHJpbmcoMCwxKSAtbmUgJGVudjpTeXN0ZW1Ecml2ZS5TdWJzdHJpbmcoMCwxKSkgewogICAgICAgICAgICAgICAgJExvY2FsOk5hbWVBcnJheSA9ICd7MH17MX0nIC0gKCRMb2NhbDpWb2x1bWVMZXR0ZXIsJExvY2FsOk5hbWVBcnJheSkKICAgICAgICAgICAgICAgICRMb2NhbDpWb2x1bWVJRCA9IEdldC1Wb2x1bWVVbmlxdWVJRCAtRHJpdmVMZXR0ZXIgJERyaXZlTGV0dGVyCiAgICAgICAgICAgIH0KICAgICAgICAgICAKCiAgICAgICAgICAgICMgR2V0IFZhcmlhYmxlcwogICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6UGF0aERpciA9ICgnezB9ezF9JyAtZiAoJFNjcmlwdDpEaXJJbnN0YWxsLCdCYWNrdXBLZXlzXCcpKQogICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6UGF0aEZpbGUgPSAoJ3swfXsxfScgLWYgKCRMb2NhbDpQYXRoRGlyLCRMb2NhbDpOYW1lRmlsZSkpCiAgICAgICAgICAgIFtzdHJpbmddICRMb2NhbDpOb3dLZXlQcm90ZWN0b3JJRCA9ICgoR2V0LVZhcmlhYmxlIC1OYW1lICRMb2NhbDpOYW1lQXJyYXkgLVNjb3BlICdTY3JpcHQnKS5WYWx1ZSkuS2V5UHJvdGVjdG9ySUQKICAgICAgICAgICAgW3N0cmluZ10gJExvY2FsOk5vd1JlY292ZXJ5UGFzc3dvcmQgPSAoKEdldC1WYXJpYWJsZSAtTmFtZSAkTG9jYWw6TmFtZUFycmF5IC1TY29wZSAnU2NyaXB0JykuVmFsdWUpLlJlY292ZXJ5UGFzc3dvcmQKCgogICAgICAgICAgICAjIEdldCBzdGF0cwogICAgICAgICAgICBpZiAoLW5vdCAoVGVzdC1QYXRoIC1QYXRoICRMb2NhbDpQYXRoRmlsZSkpIHsKICAgICAgICAgICAgICAgIGlmICgtbm90KFRlc3QtUGF0aCAtUGF0aCAkTG9jYWw6UGF0aERpciAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSkpIHsKICAgICAgICAgICAgICAgICAgICAkbnVsbCA9IE5ldy1JdGVtIC1QYXRoICRMb2NhbDpQYXRoRGlyIC1JdGVtVHlwZSBEaXJlY3RvcnkgLUZvcmNlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBbc3RyaW5nW11dICRMb2NhbDpJbnB1dFN0cmluZyA9IChHZXQtQ29udGVudCAtUGF0aCAkTG9jYWw6UGF0aEZpbGUpLlNwbGl0KFtFbnZpcm9ubWVudF06Ok5ld0xpbmUpCiAgICAgICAgICAgICAgICBpZiAoJD8gLWFuZCAkTG9jYWw6SW5wdXRTdHJpbmcuTGVuZ3RoIC1nZSA3KSB7CiAgICAgICAgICAgICAgICAgICAgW3N0cmluZ10gJExvY2FsOlByZXZLZXlQcm90ZWN0b3JJRCA9ICRMb2NhbDpJbnB1dFN0cmluZ1s1XS5UcmltKCkKICAgICAgICAgICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6UHJldlJlY292ZXJ5UGFzc3dvcmQgPSAkTG9jYWw6SW5wdXRTdHJpbmdbN10uVHJpbSgpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHskTG9jYWw6SGFzQ2hhbmdlZCA9ICR0cnVlfQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgIyBDaGVjayBpZiBjaGFuZ2VkCiAgICAgICAgICAgIGlmICgkTG9jYWw6UHJldktleVByb3RlY3RvcklEKSB7CiAgICAgICAgICAgICAgICBpZiAoJExvY2FsOlByZXZLZXlQcm90ZWN0b3JJRCAtbmUgJExvY2FsOk5vd0tleVByb3RlY3RvcklEKSB7JExvY2FsOkhhc0NoYW5nZWQgPSAkdHJ1ZX0KICAgICAgICAgICAgICAgIGlmICgkTG9jYWw6UHJldlJlY292ZXJ5UGFzc3dvcmQgLW5lICRMb2NhbDpOb3dSZWNvdmVyeVBhc3N3b3JkKSB7JExvY2FsOkhhc0NoYW5nZWQgPSAkdHJ1ZX0KICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICMgV3JpdGUgbmV3IHZhbHVlcyBpZiBjaGFuZ2VkIG9yIGRvZXMgbm90IGV4aXN0CiAgICAgICAgICAgIGlmICgkTG9jYWw6SGFzQ2hhbmdlZCAtb3IgKC1ub3QgKFRlc3QtUGF0aCAtUGF0aCAkTG9jYWw6UGF0aEZpbGUpKSkgewogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciA9IFtzdHJpbmddOjpFbXB0eQogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciArPSAnRHJpdmUvVm9sdW1lIExldHRlciAoTm90IFVuaXF1ZSBpZGVudGlmaWVyKTp7MH0nIC1mICJgcmBuIgogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciArPSAnezB9ezF9JyAtZiAkRHJpdmVMZXR0ZXIsImByYG4iCiAgICAgICAgICAgICAgICAkTG9jYWw6T3V0U3RyICs9ICdWb2x1bWUgVW5pcXVlSUQgKE5hbWUgb2YgdGhpcyBmaWxlKTp7MH0nIC1mICJgcmBuIgogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciArPSAnezB9ezF9JyAtZiAkTG9jYWw6Vm9sdW1lSUQsImByYG4iCiAgICAgICAgICAgICAgICAkTG9jYWw6T3V0U3RyICs9ICdLZXlQcm90ZWN0b3JJRDp7MH0nIC1mICJgcmBuIgogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciArPSAnezB9ezF9JyAtZiAkTG9jYWw6Tm93S2V5UHJvdGVjdG9ySUQsImByYG4iCiAgICAgICAgICAgICAgICAkTG9jYWw6T3V0U3RyICs9ICdSZWNvdmVyeSBQYXNzd29yZDp7MH0nIC1mICJgcmBuIgogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciArPSAnezB9ezF9JyAtZiAkTG9jYWw6Tm93UmVjb3ZlcnlQYXNzd29yZCwiYHJgbiIKICAgICAgICAgICAgICAgIE91dC1GaWxlIC1GaWxlUGF0aCAkTG9jYWw6UGF0aEZpbGUgLUVuY29kaW5nIHV0ZjggLUZvcmNlIC1JbnB1dE9iamVjdCAoJExvY2FsOk91dFN0cikKICAgICAgICAgICAgfQoKCgogICAgICAgICAgICAjIFJldHVybiBzdGF0dXMKICAgICAgICAgICAgcmV0dXJuICRMb2NhbDpIYXNDaGFuZ2VkICAgICAgCiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gQ2hlY2stSWZCaXRMb2NrZXJQV0hhc0NoYW5nZWQKICAgICNlbmRyZWdpb24gUmV0dXJuIFZhbHVlcyAoVXNlZCBieSBvdGhlciBGdW5jdGlvbnMpCgoKCiAgICAjcmVnaW9uIFNldCBTY3JpcHQgV2lkZSBWYXJpYWJsZXMKICAgICAgICAjcmVnaW9uIEdldC1CaXRMb2NrZXJTdGF0dXMKICAgICAgICAjIEZpbGxzIHR3byBzdHJpbmdzIHdpdGggY3VycmVudCBWb2x1bWUgRW5jcnlwdGlvbiBTdGF0dXMsIGFuZCBWb2x1bWUgUHJvdGVjdGlvbiBTdGF0dXMuIAogICAgICAgICMgQWxzbyBtYWtlcyBhIGJvb2wgYXJyYXkgd2l0aCB0cnVlIGZhbHNlIGZvciB8IDE6IFRQTSBwcmVzZW50IHwgMjogUmVjb3ZlcnkgUGFzc3dvcmQgUHJlc2VudAogICAgICAgIEZ1bmN0aW9uIEdldC1CaXRMb2NrZXJTdGF0dXMgewogICAgICAgICAgICBQYXJhbSgKICAgICAgICAgICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5PSRmYWxzZSldCiAgICAgICAgICAgICAgICBbc3RyaW5nXSAkRHJpdmVMZXR0ZXIgPSAkT1NEcml2ZQogICAgICAgICAgICApCgogICAgICAgICAgICAjIEhlbHAgdmFyaWFibGVzCiAgICAgICAgICAgICRMb2NhbDpTdHJOYW1lID0gW3N0cmluZ106OkVtcHR5CiAgICAgICAgICAgIGlmICgkRHJpdmVMZXR0ZXIgLW5lICRlbnY6U3lzdGVtRHJpdmUpIHsKICAgICAgICAgICAgICAgICRMb2NhbDpTdHJOYW1lID0gJERyaXZlTGV0dGVyLlN1YnN0cmluZygwLDEpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgJExvY2FsOkFkZExldHRlclRvTmFtZSA9IFtzdHJpbmddOjpJc051bGxPckVtcHR5KCRMb2NhbDpTdHJOYW1lKQoKICAgICAgICAgICAgIyBHZXQgQml0TG9ja2VyIFN0YXR1cyBmb3IgVm9sdW1lCiAgICAgICAgICAgIFtNaWNyb3NvZnQuQml0TG9ja2VyLlN0cnVjdHVyZXMuQml0TG9ja2VyVm9sdW1lXSAkTG9jYWw6Qml0TG9ja2VyVm9sdW1lU3RhdHVzID0gR2V0LUJpdExvY2tlclZvbHVtZSAtTW91bnRQb2ludCAkRHJpdmVMZXR0ZXIKICAgICAgICAgICAgTmV3LVZhcmlhYmxlIC1OYW1lICgkKElmKC1ub3QoJExvY2FsOkFkZExldHRlclRvTmFtZSkpeyRMb2NhbDpTdHJOYW1lfSkgKyAnQml0TG9ja2VyVm9sdW1lU3RhdHVzJykgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSBgCiAgICAgICAgICAgICAgICAgICAgICAgICAtVmFsdWUgKFtzdHJpbmddKCRMb2NhbDpCaXRMb2NrZXJWb2x1bWVTdGF0dXMuVm9sdW1lU3RhdHVzKSkgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgIyBWb2x1bWUgRW5jcnlwdGlvbiBTdGF0dXM6IEZ1bGx5RGVjcnlwdGVkIHwgRW5jcnlwdGlvbkluUHJvZ3Jlc3MgfCBGdWxseUVuY3J5cHRlZAogICAgICAgICAgICBOZXctVmFyaWFibGUgLU5hbWUgKCQoSWYoLW5vdCgkTG9jYWw6QWRkTGV0dGVyVG9OYW1lKSl7JExvY2FsOlN0ck5hbWV9KSArICdWb2x1bWVFbmNTdGF0dXMnKSAtU2NvcGUgJ1NjcmlwdCcgLUZvcmNlIGAKICAgICAgICAgICAgICAgICAgICAgICAgIC1WYWx1ZSAoW3N0cmluZ10gKCRMb2NhbDpCaXRMb2NrZXJWb2x1bWVTdGF0dXMgfCBTZWxlY3QtT2JqZWN0IC1Qcm9wZXJ0eSBWb2x1bWVTdGF0dXMpLlZvbHVtZVN0YXR1cykKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVm9sdW1lIFByb3RlY3Rpb24gU3RhdHVzOiBPTiBpZiBFbmNyeXB0aW9uIFBlcmNlbnRhZ2UgPSAxMDAlCiAgICAgICAgICAgIE5ldy1WYXJpYWJsZSAtTmFtZSAoJChJZigtbm90KCRMb2NhbDpBZGRMZXR0ZXJUb05hbWUpKXskTG9jYWw6U3RyTmFtZX0pICsgJ1ZvbHVtZVByb3RlY3Rpb25TdGF0dXMnKSAtU2NvcGUgJ1NjcmlwdCcgLUZvcmNlIGAKICAgICAgICAgICAgICAgICAgICAgICAgIC1WYWx1ZSAoW3N0cmluZ10gKCRMb2NhbDpCaXRMb2NrZXJWb2x1bWVTdGF0dXMgfCBTZWxlY3QtT2JqZWN0IC1Qcm9wZXJ0eSBQcm90ZWN0aW9uU3RhdHVzKS5Qcm90ZWN0aW9uU3RhdHVzKQogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICA8IyAgCiAgICAgICAgICAgICAgICAgICAgVm9sdW1lIGNhbiBiZSAnRnVsbHkgRGVjcnlwdGVkJywgYnV0IHN0aWxsIGhhdmUgYSBUUE0gcHJlc2VudC4gCiAgICAgICAgICAgICAgICAgICAgVGhpcyBpcyB1c3VhbGx5IHRoZSBjYXNlIHJpZ2h0IGFmdGVyIGVuY3J5cHRpb24gaGFzIHN0YXJ0ZWQuIAogICAgICAgICAgICAjPgoKCiAgICAgICAgICAgICMgSWYgdGhlcmUgaXMgYSBLZXlQcm90ZWN0b3IgZm9yIGdpdmVuIHZvbHVtZSwgZ2V0IHRoZSByZXN0IG9mIHRoZSB2YXJpYWJsZXMKICAgICAgICAgICAgaWYgKCRMb2NhbDpCaXRMb2NrZXJWb2x1bWVTdGF0dXMuS2V5UHJvdGVjdG9yLkNvdW50IC1ndCAwKSB7CiAgICAgICAgICAgICAgICAjIFswfSA9IFZvbHVtZSBoYXMgVFBNPyAgIFsxXSA9IFZvbHVtZSBoYXMgUmVjb3ZlcnkgUGFzc3dvcmQ/CiAgICAgICAgICAgICAgICBOZXctVmFyaWFibGUgLU5hbWUgKCQoSWYoLW5vdCgkTG9jYWw6QWRkTGV0dGVyVG9OYW1lKSl7JExvY2FsOlN0ck5hbWV9KSArICdWb2x1bWVIYXNUUE1hbmRQVycpIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIC1WYWx1ZSAoW2Jvb2xbXV0oR2V0LUJvb2xEcml2ZUhhc0JpdExvY2tlclRQTWFuZFBXIC1Ecml2ZUxldHRlciAkRHJpdmVMZXR0ZXIpKSAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBFbmNyeXB0aW9uIFBlcmNlbnRhZ2U6IEhvdyBsb25nIGhhcyB0aGUgZW5jcnlwdGlvbiBwcm9jZXNzIGNvbWUKICAgICAgICAgICAgICAgIE5ldy1WYXJpYWJsZSAtTmFtZSAoJChJZigtbm90KCRMb2NhbDpBZGRMZXR0ZXJUb05hbWUpKXskTG9jYWw6U3RyTmFtZX0pICsgJ1ZvbHVtZUVuY3J5cHRpb25QZXJjZW50YWdlJykgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSBgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLVZhbHVlICgkTG9jYWw6Qml0TG9ja2VyVm9sdW1lU3RhdHVzLkVuY3J5cHRpb25QZXJjZW50YWdlLlRvU3RyaW5nKCkpICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBJZiBEcml2ZSBoYXMgVFBNIGFuZCBQVwogICAgICAgICAgICAgICAgaWYgKChHZXQtVmFyaWFibGUgLU5hbWUgKCQoSWYoLW5vdChbc3RyaW5nXTo6SXNOdWxsT3JFbXB0eSgkTG9jYWw6U3RyTmFtZSkpKXskTG9jYWw6U3RyTmFtZX0pICsgJ1ZvbHVtZUhhc1RQTWFuZFBXJykgLVNjb3BlICdTY3JpcHQnKS5WYWx1ZVsxXSkgewogICAgICAgICAgICAgICAgICAgICMgTmFtZSB0aGUgdmFyaWFibGVzCiAgICAgICAgICAgICAgICAgICAgJExvY2FsOk5hbWVBcnJheVJlY292ZXJ5UGFzc3dvcmRzID0gKCQoSWYoLW5vdChbc3RyaW5nXTo6SXNOdWxsT3JFbXB0eSgkTG9jYWw6U3RyTmFtZSkpKXskTG9jYWw6U3RyTmFtZX0pICsgJ0FycmF5UmVjb3ZlcnlQYXNzd29yZHMnKQogICAgICAgICAgICAgICAgICAgICRMb2NhbDpOYW1lQ291bnRSZWNvdmVyeVBhc3N3b3JkcyA9ICgkKElmKC1ub3QoW3N0cmluZ106OklzTnVsbE9yRW1wdHkoJExvY2FsOlN0ck5hbWUpKSl7JExvY2FsOlN0ck5hbWV9KSArICdDb3VudFJlY292ZXJ5UGFzc3dvcmRzJykKCiAgICAgICAgICAgICAgICAgICAgIyBHZXQgQXJyYXkgd2l0aCBwcm90ZWN0aW9uIHBhc3N3b3JkcwogICAgICAgICAgICAgICAgICAgIE5ldy1WYXJpYWJsZSAtTmFtZSAkTG9jYWw6TmFtZUFycmF5UmVjb3ZlcnlQYXNzd29yZHMgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSBgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC1WYWx1ZSAoR2V0LUFycmF5UmVjb3ZlcnlQYXNzd29yZHMgLUJpdExvY2tlclZvbHVtZSAkTG9jYWw6Qml0TG9ja2VyVm9sdW1lU3RhdHVzKQoKICAgICAgICAgICAgICAgICAgICAjIENvdW50IEFycmF5UmVjb3ZlcnlQYXNzd29yZHMKICAgICAgICAgICAgICAgICAgICBOZXctVmFyaWFibGUgLU5hbWUgJExvY2FsOk5hbWVDb3VudFJlY292ZXJ5UGFzc3dvcmRzIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtVmFsdWUgKChHZXQtVmFyaWFibGUgLU5hbWUgJExvY2FsOk5hbWVBcnJheVJlY292ZXJ5UGFzc3dvcmRzKS5WYWx1ZSkuTGVuZ3RoCgogICAgICAgICAgICAgICAgICAgICMgR2V0IFZvbHVtZSBVbmlxdWUgSUQgKHRvIGNoZWNrIGlmIHByb3RlY3Rpb24gcGFzc3dvcmQgaGFzIGNoYW5nZWQpCiAgICAgICAgICAgICAgICAgICAgTmV3LVZhcmlhYmxlIC1OYW1lICgkKElmKC1ub3QoW3N0cmluZ106OklzTnVsbE9yRW1wdHkoJExvY2FsOlN0ck5hbWUpKSl7JExvY2FsOlN0ck5hbWV9KSArICdWb2x1bWVVbmlxdWVJRCcpIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtVmFsdWUgKChHZXQtVm9sdW1lVW5pcXVlSUQgLURyaXZlTGV0dGVyICRMb2NhbDpEcml2ZUxldHRlcikpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBHZXQtQml0TG9ja2VyU3RhdHVzCiAgICAjZW5kcmVnaW9uIFNldCBTY3JpcHQgV2lkZSBWYXJpYWJsZXMKCgoKICAgICNyZWdpb24gUmVnaXN0cnkgRnVuY3Rpb25zCiAgICAgICAgI3JlZ2lvbiBDcmVhdGUtRW52VmFyaWFibGVzCiAgICAgICAgIyBDcmVhdGUtRW52VmFyaWFibGVzOiBDcmVhdGVzIHZhcmlhYmxlcyB1c2VkIGJ5IHRoZSB0cm91Ymxlc2hvb3RlciBhdCB0aGUgYm90dG9tLCB3aGVuIGZhaWxlZCBydW5zIHJlYWNoZXMgYSBnaXZlbiBudW1iZXIuICAKICAgICAgICBGdW5jdGlvbiBDcmVhdGUtRW52VmFyaWFibGVzIHsKICAgICAgICAgICAgIyMjIyBHbG9iYWwgVmFyaWFibGVzCiAgICAgICAgICAgICMjIFRlbmFudAogICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6SUQgPSAoR2V0LUNoaWxkSXRlbSBDZXJ0OlxMb2NhbE1hY2hpbmVcTXlcIHwgV2hlcmUtT2JqZWN0IHsgJF8uSXNzdWVyIC1tYXRjaCAnQ049TVMtT3JnYW5pemF0aW9uLUFjY2VzcycgfSkuU3ViamVjdC5SZXBsYWNlKCdDTj0nLCcnKQogICAgICAgICAgICBbc3RyaW5nXSAkU2NyaXB0Ok5hbWVUZW5hbnQgPSAoR2V0LUl0ZW1Qcm9wZXJ0eSBIS0xNOlxTWVNURU1cQ3VycmVudENvbnRyb2xTZXRcQ29udHJvbFxDbG91ZERvbWFpbkpvaW5cSm9pbkluZm9cJCgkTG9jYWw6SUQpKS5Vc2VyRW1haWwuU3BsaXQoJ0AnKVsxXQogICAgICAgICAgICBbc3RyaW5nXSAkU2NyaXB0Ok5hbWVUZW5hbnRTaG9ydCA9ICRHbG9iYWw6TmFtZVRlbmFudC5TcGxpdCgnLicpWzBdCiAgICAgICAgICAgICMjIEhhcmR3YXJlIGFuZCBXaW5kb3dzIGluZm8KICAgICAgICAgICAgW3N0cmluZ10gJFNjcmlwdDpDb21wdXRlck1hbnVmYWN0dXJlciA9IFF1ZXJ5LVJlZ2lzdHJ5IC1EaXIgJ0hLTE06XEhBUkRXQVJFXERFU0NSSVBUSU9OXFN5c3RlbVxCSU9TXFN5c3RlbU1hbnVmYWN0dXJlcicKICAgICAgICAgICAgaWYgKC1ub3QoW3N0cmluZ106OklzTnVsbE9yRW1wdHkoJFNjcmlwdDpDb21wdXRlck1hbnVmYWN0dXJlcikpKSB7CiAgICAgICAgICAgICAgICBbc3RyaW5nXSAkU2NyaXB0OkNvbXB1dGVyRmFtaWx5ID0gUXVlcnktUmVnaXN0cnkgLURpciAnSEtMTTpcSEFSRFdBUkVcREVTQ1JJUFRJT05cU3lzdGVtXEJJT1NcU3lzdGVtRmFtaWx5JwogICAgICAgICAgICAgICAgW3N0cmluZ10gJFNjcmlwdDpDb21wdXRlclByb2R1Y3ROYW1lID0gUXVlcnktUmVnaXN0cnkgLURpciAnSEtMTTpcSEFSRFdBUkVcREVTQ1JJUFRJT05cU3lzdGVtXEJJT1NcU3lzdGVtUHJvZHVjdE5hbWUnCiAgICAgICAgICAgICAgICBbc3RyaW5nXSAkU2NyaXB0OldpbmRvd3NFZGl0aW9uID0gUXVlcnktUmVnaXN0cnkgLURpciAnSEtMTTpcU09GVFdBUkVcTWljcm9zb2Z0XFdpbmRvd3MgTlRcQ3VycmVudFZlcnNpb25cUHJvZHVjdE5hbWUnCiAgICAgICAgICAgICAgICBbc3RyaW5nXSAkU2NyaXB0OldpbmRvd3NWZXJzaW9uID0gUXVlcnktUmVnaXN0cnkgLURpciAnSEtMTTpcU09GVFdBUkVcTWljcm9zb2Z0XFdpbmRvd3MgTlRcQ3VycmVudFZlcnNpb25cUmVsZWFzZUlkJwogICAgICAgICAgICAgICAgW3N0cmluZ10gJFNjcmlwdDpXaW5kb3dzVmVyc2lvbiArPSAoJyAoezB9KScgLWYgKFF1ZXJ5LVJlZ2lzdHJ5IC1EaXIgJ0hLTE06XFNPRlRXQVJFXE1pY3Jvc29mdFxXaW5kb3dzIE5UXEN1cnJlbnRWZXJzaW9uXEN1cnJlbnRCdWlsZCcpKQogICAgICAgICAgICB9IAogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICRMb2NhbDpFbnZJbmZvID0gR2V0LVdtaU9iamVjdCAtQ2xhc3MgV2luMzJfQ29tcHV0ZXJTeXN0ZW0gfCBTZWxlY3QtT2JqZWN0IC1Qcm9wZXJ0eSBNYW51ZmFjdHVyZXIsTW9kZWwsU3lzdGVtRmFtaWx5ICAgICAgICAKICAgICAgICAgICAgICAgIFtzdHJpbmddICRTY3JpcHQ6Q29tcHV0ZXJNYW51ZmFjdHVyZXIgPSAkTG9jYWw6RW52SW5mby5NYW51ZmFjdHVyZXIKICAgICAgICAgICAgICAgIFtzdHJpbmddICRTY3JpcHQ6Q29tcHV0ZXJGYW1pbHkgPSAkTG9jYWw6RW52SW5mby5TeXN0ZW1GYW1pbHkKICAgICAgICAgICAgICAgIFtzdHJpbmddICRTY3JpcHQ6Q29tcHV0ZXJQcm9kdWN0TmFtZSA9ICRMb2NhbDpFbnZJbmZvLk1vZGVsCiAgICAgICAgICAgICAgICAkTG9jYWw6T1NJbmZvID0gR2V0LVdtaU9iamVjdCAtQ2xhc3Mgd2luMzJfb3BlcmF0aW5nc3lzdGVtIHwgU2VsZWN0LU9iamVjdCAtUHJvcGVydHkgQ2FwdGlvbixWZXJzaW9uCiAgICAgICAgICAgICAgICBbc3RyaW5nXSAkU2NyaXB0OldpbmRvd3NFZGl0aW9uID0gJExvY2FsOk9TSW5mby5DYXB0aW9uCiAgICAgICAgICAgICAgICBbc3RyaW5nXSAkU2NyaXB0OldpbmRvd3NWZXJzaW9uID0gJExvY2FsOk9TSW5mby5WZXJzaW9uCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBDcmVhdGUtRW52VmFyaWFibGVzCgoKICAgICAgICAjcmVnaW9uIFF1ZXJ5LVJlZ2lzdHJ5CiAgICAgICAgRnVuY3Rpb24gUXVlcnktUmVnaXN0cnkgewogICAgICAgICAgICBQYXJhbSAoW1BhcmFtZXRlcihNYW5kYXRvcnk9JHRydWUpXSBbc3RyaW5nXSAkRGlyKQogICAgICAgICAgICAkTG9jYWw6T3V0ID0gW3N0cmluZ106OkVtcHR5CiAgICAgICAgICAgIFtzdHJpbmddICRMb2NhbDpLZXkgPSAkRGlyLlNwbGl0KCd7XH0nKVstMV0KICAgICAgICAgICAgW3N0cmluZ10gJExvY2FsOkRpciA9ICREaXIuUmVwbGFjZSgkTG9jYWw6S2V5LCcnKQogICAgICAgIAogICAgICAgICAgICAkTG9jYWw6RXhpc3RzID0gR2V0LUl0ZW1Qcm9wZXJ0eSAtUGF0aCAoJ3swfScgLWYgJERpcikgLU5hbWUgKCd7MH0nIC1mICRMb2NhbDpLZXkpIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlCiAgICAgICAgICAgIGlmICgkRXhpc3RzKSB7CiAgICAgICAgICAgICAgICAkTG9jYWw6T3V0ID0gJExvY2FsOkV4aXN0cy4kTG9jYWw6S2V5CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICRMb2NhbDpPdXQKICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBRdWVyeS1SZWdpc3RyeQogICAgI2VuZHJlZ2lvbiBSZWdpc3RyeSBGdW5jdGlvbnMKCgoKICAgICNyZWdpb24gICAgRWRpdC1TY2hlZHVsZWRUYXNrCiAgICBmdW5jdGlvbiBFZGl0LVNjaGVkdWxlZFRhc2sgewogICAgICAgIFBhcmFtKAogICAgICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeT0kZmFsc2UpXQogICAgICAgICAgICBbc3RyaW5nXSAkVGFza05hbWUgPSAkU2NyaXB0OlNjaGVkdWxlZFRhc2tOYW1lCiAgICAgICAgKQoKICAgICAgICAkVGFzayA9IEdldC1TY2hlZHVsZWRUYXNrIC1UYXNrTmFtZSAkVGFza05hbWUgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUKCiAgICAgICAgaWYgKCRUYXNrKSB7CiAgICAgICAgICAgIGlmICgkU2NyaXB0OkJvb2xSZW1vdmVTY2hlZHVsZWRUYXNrQWZ0ZXJGaXJzdFN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICRudWxsID0gVW5yZWdpc3Rlci1TY2hlZHVsZWRUYXNrIC1UYXNrTmFtZSAkVGFzayAtQ29uZmlybTokZmFsc2UgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUKICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnUmVtb3ZpbmcgdGhlIFNjaGVkdWxlZCB0YXNrICJ7MH0iLiBTdWNjZXNzPyB7MX0nIC1mICgkVGFzay5UYXNrTmFtZSwkPykpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6TmV3U2NoZWRUaW1lID0gJzEyOjAwJyAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAkbnVsbCA9IFNldC1TY2hlZHVsZWRUYXNrIC1UYXNrTmFtZSAkU2NyaXB0OlNjaGVkdWxlZFRhc2tOYW1lIC1UcmlnZ2VyIChOZXctU2NoZWR1bGVkVGFza1RyaWdnZXIgLUF0ICRMb2NhbDpOZXdTY2hlZFRpbWUgLURhaWx5KSAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZQogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdFZGl0aW5nIFNjaGVkdWxlZCB0YXNrICJ7MH0iIHRvIHN0YXJ0IGRhaWx5IGF0IHsxfS4gU3VjY2Vzcz8gezJ9JyAtZiAoJFNjcmlwdDpTY2hlZHVsZWRUYXNrTmFtZSwkTG9jYWw6TmV3U2NoZWRUaW1lLCQ/KSkKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgTG9nV3JpdGUgKCdGb3VuZCBubyBTY2hlZHVsZWQgVGFzayB3aXRoIG5hbWUgInswfSInIC1mICgkVGFza05hbWUpKQogICAgICAgIH0KICAgIH0KICAgICNlbmRyZWdpb24gRWRpdC1TY2hlZHVsZWRUYXNrCgoKICAgICNyZWdpb24gUHJvbXB0LVJlYm9vdAogICAgRnVuY3Rpb24gUHJvbXB0LVJlYm9vdCB7CiAgICAgICAgW3VpbnQxNl0gJExvY2FsOlRpbWVUb1JlYm9vdEluTWludXRlcyA9IDYwIAogICAgICAgIFtzdHJpbmddICRMb2NhbDpTdHJTaG9ydE1lc3NhZ2UgPSAoJ1dpbmRvd3Mgd2lsbCByZXN0YXJ0IGluIHswfSBtaW51dGVzIHRvIGZpbmlzaCBkZXZpY2UgY29uZmlndXJhdGlvbi4gU2F2ZSB5b3VyIHdvcmshJyAtZiAoJExvY2FsOlRpbWVUb1JlYm9vdEluTWludXRlcykpCiAgICAgICAgJG51bGwgPSBjbWQuZXhlIC9jICgnc2h1dGRvd24gL3IgL3QgezB9IC9jICJ7MX0iJyAtZiAoJExvY2FsOlRpbWVUb1JlYm9vdEluTWludXRlcyo2MCksJExvY2FsOlN0clNob3J0TWVzc2FnZSkgMj4mMQogICAgICAgIGlmICgtbm90KCQ/KSkgewogICAgICAgICAgICAkbnVsbCA9IGNtZC5leGUgL2MgKCdzaHV0ZG93biAvYScpIDI+JjEKICAgICAgICAgICAgJG51bGwgPSBjbWQuZXhlIC9jICgnc2h1dGRvd24gL3IgL3QgezB9IC9jICJ7MX0iJyAtZiAoJExvY2FsOlRpbWVUb1JlYm9vdEluTWludXRlcyo2MCksJExvY2FsOlN0clNob3J0TWVzc2FnZSkgMj4mMQogICAgICAgIH0KCiAgICAgICAgPCMgRk9SIEZVVFVSRSBFTkhBTkNFTUVOVFMKICAgICAgICBbc3RyaW5nXSAkTG9jYWw6U3RyTWVzc2FnZSA9ICdZb3VyIGNvbXB1dGVyIGFyZSBhd2FpdGluZyBhIHJlc3RhcnQ6JwogICAgICAgICRMb2NhbDpTdHJNZXNzYWdlICs9ICd7MH0gWW91ciBvcmdhbml6YXRpb24gcmVxdWlyZXMgeW91ciBoYXJkJyAtZiAiYHJgbiIKICAgICAgICAkTG9jYWw6U3RyTWVzc2FnZSArPSAnezB9IGRyaXZlIHRvIGJlIGVuY3lwdGVkLiBJbiBvcmRlciB0bycgLWYgImByYG4iCiAgICAgICAgJExvY2FsOlN0ck1lc3NhZ2UgKz0gJ3swfSBmaW5pc2ggdGhpcyBwcm9jZXNzLCB5b3UgbmVlZCB0bycgLWYgImByYG4iCiAgICAgICAgJExvY2FsOlN0ck1lc3NhZ2UgKz0gJ3swfSByZXN0YXJ0IHlvdXIgY29tcHV0ZXIuIFlvdSBjYW4nIC1mICJgcmBuIgogICAgICAgICRMb2NhbDpTdHJNZXNzYWdlICs9ICd7MH0gZWl0aGVyIGRvIGl0IG1hbnVhbGx5LCBvciBpdCB3aWxsJyAtZiAiYHJgbiIKICAgICAgICAkTG9jYWw6U3RyTWVzc2FnZSArPSAnezB9IGF1dG9tYXRpY2FsbHkgaGFwcGVuIGluJyAtZiAiYHJgbiIKICAgICAgICAkTG9jYWw6U3RyTWVzc2FnZSArPSAnezB9IHsxfSBtaW51dGVzLicgLWYgImByYG4iLCRMb2NhbDpUaW1lVG9SZWJvb3RJbk1pbnV0ZXMKICAgICAgICAkTG9jYWw6U3RyTWVzc2FnZSArPSAnezB9ezB9IFNBVkUgWU9VUiBXT1JLIScgLWYgImByYG4iCiAgICAgICAgIz4KICAgIH0KICAgICNlbmRyZWdpb24gUHJvbXB0LVJlYm9vdCAgICAKI2VuZHJlZ2lvbiBGdW5jdGlvbnMKCgoKI3JlZ2lvbiBJbml0aWFsaXplCiAgICBMb2dXcml0ZSAoJyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIycpCiAgICBMb2dXcml0ZSAoJ1N0YXJ0aW5nIFRyaWdnZXIgQml0TG9ja2VyIHNjcmlwdC4nKQogICAgTG9nV3JpdGUgKCcjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMnKQogICAgTG9nV3JpdGUgKCcjIyMgR2V0IHN0YXRzLicpCiAgICAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiAgICAjIyBGZXRjaCBwcmV2IHJ1biByZXN1bHRzICMjCiAgICAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjICAgIAogICAgaWYgKC1ub3QgKFRlc3QtUGF0aCAtUGF0aCAkU2NyaXB0OkZpbGVTdGF0cykpIHsKICAgICAgICBbdWludDE2XSAkU2NyaXB0OkNvdW50UnVucyA9IDAKICAgICAgICBbYm9vbF0gJFNjcmlwdDpJc0ZpbmlzaGVkMXN0VGltZSA9IFtib29sXSAkU2NyaXB0OklzRW5jcnlwdGVkID0gW2Jvb2xdICRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cgPSBbYm9vbF0gJFNjcmlwdDpJc0JhY2t1cE9EID0gW2Jvb2xdICRTY3JpcHQ6SXNCYWNrdXBBQUQgPSAkZmFsc2UKICAgICAgICAkU2NyaXB0Ok9TRHJpdmVLZXlJRCA9ICRTY3JpcHQ6T1NEcml2ZVByb3RlY3Rpb25QYXNzd29yZCA9IFtzdHJpbmddOjpFbXB0eQogICAgICAgIExvZ1dyaXRlICgnIyBGaXJzdCBydW4hJykKICAgIH0KICAgIGVsc2UgewogICAgICAgIFtTdHJpbmdbXV0gJElucHV0U3RyaW5nID0gKEdldC1Db250ZW50IC1QYXRoICRTY3JpcHQ6RmlsZVN0YXRzKS5TcGxpdChbRW52aXJvbm1lbnRdOjpOZXdMaW5lKQogICAgICAgIFt1aW50MTZdICRTY3JpcHQ6Q291bnRSdW5zID0gW3VpbnQxNl0gJElucHV0U3RyaW5nWzBdCiAgICAgICAgW2Jvb2xdICRTY3JpcHQ6SXNGaW5pc2hlZDFzdFRpbWUgPSBbdWludDE2XSAkSW5wdXRTdHJpbmdbMV0KICAgICAgICBbYm9vbF0gJFNjcmlwdDpJc0VuY3J5cHRlZCA9IFt1aW50MTZdICRJbnB1dFN0cmluZ1syXQogICAgICAgIFtib29sXSAkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3ID0gW3VpbnQxNl0gJElucHV0U3RyaW5nWzNdCiAgICAgICAgW2Jvb2xdICRTY3JpcHQ6SXNCYWNrdXBPRCA9IFt1aW50MTZdICRJbnB1dFN0cmluZ1s0XQogICAgICAgIFtib29sXSAkU2NyaXB0OklzQmFja3VwQUFEID0gW3VpbnQxNl0gJElucHV0U3RyaW5nWzVdCiAgICAgICAgW3N0cmluZ10gJFNjcmlwdDpPU0RyaXZlS2V5SUQgPSBbc3RyaW5nXSAkSW5wdXRTdHJpbmdbNl0KICAgICAgICBbc3RyaW5nXSAkU2NyaXB0Ok9TRHJpdmVQcm90ZWN0aW9uUGFzc3dvcmQgPSBbc3RyaW5nXSAkSW5wdXRTdHJpbmdbN10KICAgICAgICBMb2dXcml0ZSAoJyMgUHJldmlvdXMgcnVuIHJlc3VsdHM6JykKICAgICAgICBXcml0ZS1TdGF0cyAtUHJldmlvdXNPbmx5ICR0cnVlCiAgICB9CiAgICAKCiAgICAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiAgICAjIyMjIEdldCBjdXJyZW50IHN0YXR1cyAjIyMjCiAgICAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjICAKICAgIExvZ1dyaXRlICgnIyBDdXJyZW50IHN0YXR1czonKQogICAgIyBPUyBEcml2ZQogICAgR2V0LUJpdExvY2tlclN0YXR1cwogICAgaWYgKCRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFcpIHsKICAgICAgICBpZiAoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1swXSkgewogICAgICAgICAgICAkU2NyaXB0OklzRW5jcnlwdGVkID0gKCRTY3JpcHQ6Qml0TG9ja2VyVm9sdW1lU3RhdHVzIC1lcSAkU2NyaXB0OkJpdExvY2tlclZvbHVtZUVuY3J5cHRpb25TdGF0dXNlc1syXSkKICAgICAgICB9CiAgICAgICAgaWYgKCRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMV0pIHsKICAgICAgICAgICAgJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdyA9ICgkU2NyaXB0OkNvdW50UmVjb3ZlcnlQYXNzd29yZHMgLWVxIDEpCiAgICAgICAgfSAgICAgICAgICAgICAgICAgICAKICAgIH0KICAgIGVsc2UgewogICAgICAgICRTY3JpcHQ6SXNFbmNyeXB0ZWQgPSAkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3ID0gJGZhbHNlCiAgICB9CgoKICAgICMgT3RoZXIgRml4ZWQgRHJpdmVzCiAgICAjVE9ETwogICAgPCMKICAgIFtTdHJpbmdbXV0gJFNjcmlwdDpGaXhlZFZvbHVtZXNMZXR0ZXJzID0gQCgoR2V0LVZvbHVtZSB8IGAKICAgICAgICBXaGVyZS1PYmplY3QgeyRfLkRyaXZlVHlwZSAtZXEgJ0ZpeGVkJyAtYW5kICgtbm90KFtzdHJpbmddOjpJc051bGxPckVtcHR5KCRfLkRyaXZlTGV0dGVyKSkpfSB8IGAKICAgICAgICBXaGVyZS1PYmplY3QgeyRfLkRyaXZlTGV0dGVyIC1uZSAkT1NEcml2ZS5SZXBsYWNlKCc6JywnJyl9KS5Ecml2ZUxldHRlcikKICAgIAogICAgJFNjcmlwdDpGaXhlZFZvbHVtZXNMZXR0ZXJzIHwgRm9yRWFjaC1PYmplY3QgewogICAgICAgIGlmICgtbm90KFtzdHJpbmddOjpJc051bGxPckVtcHR5KCRfKSkpIHsKICAgICAgICAgICAgR2V0LUJpdGxvY2tlclN0YXR1cyAtRHJpdmVMZXR0ZXIgJF8KICAgICAgICAgICAgaWYgKChHZXQtVmFyaWFibGUgLU5hbWUgKCd7MH1Db3VudFByb3RlY3Rpb25LZXlzJyAtZiAkXykgLVNjb3BlICdTY3JpcHQnKS5MZW5ndGggLWd0IDApIHsKICAgICAgICAgICAgICAgIFtzdHJpbmdbXV0gJFNjcmlwdDpPdGhlckVuY3J5cHRlZERyaXZlcyArPSBAKCRfKQogICAgICAgICAgICB9CiAgICAgICAgfSAgICAgCiAgICB9Iz4KCiAgICBXcml0ZS1TdGF0cwojZW5kcmVnaW9uIEluaXRpYWxpemUKICAgIAoKCiNyZWdpb24gTWFpbgojcmVnaW9uIEVuY3J5cHRpb24KIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiMjIyMgQml0TG9ja2VyIEVuY3J5cHRpb24gIyMjIwojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKTG9nV3JpdGUgKCcjIyMgQml0TG9ja2VyIEVuY3J5cHRpb24nKQoKCgojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiMgQml0TG9ja2VyIEVuY3J5cHRpb24gb2YgT1MgRHJpdmUgICMKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwojcmVnaW9uIEJpdExvY2tlciBFbmNyeXB0aW9uIG9mIE9TIERyaXZlCgpMb2dXcml0ZSAoJyMgQml0TG9ja2VyIEVuY3J5cHRpb24gb2YgT1MgRHJpdmUnKQppZiAoJFNjcmlwdDpJc0VuY3J5cHRlZCkgewogICAgTG9nV3JpdGUgKCdPUyBEcml2ZSBpcyBhbHJlYWR5IGZ1bGx5IGVuY3J5cHRlZC4nKQp9CmVsc2UgewogICAgW2Jvb2xdICRTY3JpcHQ6Qm9vbERpZEFueXRoaW5nQ2hhbmdlVGhpc1J1bnRpbWUgPSAkdHJ1ZQogICAgCiAgICAjIElmICdGdWxseUVuY3J5cHRlZCcsIGFuZCBUUE0gcHJlc2VudAogICAgIyBNZWFucyB0aGF0IE9TIERyaXZlIGlzIHN1Y2Nlc3NmdWxseSBlbmNyeXB0ZWQgd2l0aCBCaXRMb2NrZXIKICAgIGlmICgoJFNjcmlwdDpWb2x1bWVFbmNTdGF0dXMgLWVxICRTY3JpcHQ6Qml0TG9ja2VyVm9sdW1lRW5jcnlwdGlvblN0YXR1c2VzWzJdKSAtYW5kICRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMF0pIHsKICAgICAgICBMb2dXcml0ZSAoJ09TIERyaXZlIGlzIGZ1bGx5IGVuY3J5cHRlZCEnKQogICAgICAgICRTY3JpcHQ6SXNFbmNyeXB0ZWQgPSAkdHJ1ZQogICAgfQogICAgCgogICAgIyBJZiAnRW5jcnlwdGlvbkluUHJvZ3Jlc3MnIGFuZCBUUE0gcHJlc2VudAogICAgIyBNZWFucyBjb21wdXRlciBoYXMgcmVzdGFydGVkIGFmdGVyIEJpdExvY2tlciBlbmNyeXB0aW9uIHdhcyBlbmFibGVkLiBXYWl0aW5nIGZvciB0aGUgdm9sdW1lIHRvIGdldCBlbmNyeXB0ZWQKICAgIGVsc2VpZiAoJFNjcmlwdDpWb2x1bWVFbmNTdGF0dXMgLWVxICRTY3JpcHQ6Qml0TG9ja2VyVm9sdW1lRW5jcnlwdGlvblN0YXR1c2VzWzFdIC1hbmQgJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1swXSkgewogICAgICAgIExvZ1dyaXRlICgnT1MgRHJpdmUgZW5jcnlwdGlvbiBpcyBpbiBwcm9ncmVzczonKQogICAgICAgIExvZ1dyaXRlICgnUmVzdGFydCBoYXZlIHRha2VuIHBsYWNlLCBhbmQgZW5jcnlwdGlvbiBoYXMgc3RhcnRlZC4nKQogICAgICAgIExvZ1dyaXRlICgnT1MgRHJpdmUgRW5jcnlwdGlvbiBQZXJjZW50YWdlOiB7MH0lLicgLWYgKCRTY3JpcHQ6Vm9sdW1lRW5jcnlwdGlvblBlcmNlbnRhZ2UpKQogICAgICAgIExvZ1dyaXRlICgnQ2FuIGNvbnRpbnVlIHRvIGNoZWNrIGlmIFJlY292ZXJ5IFBhc3N3b3JkIGlzIHByZXNlbnQsIGFuZCBiYWNrdXAgaXQuJykKICAgIH0KCgogICAgIyBJZiAnRnVsbHlEcmVjdHlwdGVkJyAgICAgCiAgICBlbHNlaWYgKCRWb2x1bWVFbmNTdGF0dXMgLWVxICRTY3JpcHQ6Qml0TG9ja2VyVm9sdW1lRW5jcnlwdGlvblN0YXR1c2VzWzBdKSB7CiAgICAgICAgCiAgICAgICAgIyBJZiAnRnVsbHlEcmVjdHlwdGVkJyBidXQgdGhlcmUgZXhpc3RzIGEgVFBNCiAgICAgICAgIyBNZWFucyB0aGF0IGVuY3J5cHRpb24gaGFzIHN0YXJ0ZWQsIGJ1dCBjb21wdXRlciBpcyBhd2FpdGluZyByZXN0YXJ0CiAgICAgICAgaWYgKCRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFcgLWFuZCAkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzBdKSB7CiAgICAgICAgICAgIExvZ1dyaXRlICgnT1MgRHJpdmUgRW5jcnlwdGlvbiBoYXMgc3RhcnRlZCwgYnV0IGNvbXB1dGVyIGhhcyBub3QgYmVlbiByZXN0YXJ0ZWQgeWV0LicpCiAgICAgICAgICAgIExvZ1dyaXRlICgnT1MgRHJpdmUgRW5jcnlwdGlvbiBQZXJjZW50YWdlOiB7MH0lLicgLWYgKCRTY3JpcHQ6Vm9sdW1lRW5jcnlwdGlvblBlcmNlbnRhZ2UpKQogICAgICAgICAgICBMb2dXcml0ZSAoJ0NhbiBjb250aW51ZSB0byBjaGVjayBpZiBSZWNvdmVyeSBQYXNzd29yZCBpcyBwcmVzZW50LCBhbmQgYmFja3VwIGl0LicpCiAgICAgICAgfQogICAgICAgIAogICAgICAgIGVsc2UgewogICAgICAgICAgICBMb2dXcml0ZSAoJ09TIERyaXZlIGlzIG5vdCBlbmNyeXB0ZWQuJykKICAgICAgICAgICAgTG9nV3JpdGUgKCdBdHRlbXB0aW5nIHRvIEVuYWJsZSBCaXRMb2NrZXIgb24gT1MgZHJpdmUgKHswfSknIC1mICgkT1NEcml2ZSkpCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAjIEVuYWJsZSBCaXRMb2NrZXIgdXNpbmcgVFBNCiAgICAgICAgICAgICAgICAkbnVsbCA9IEVuYWJsZS1CaXRMb2NrZXIgLU1vdW50UG9pbnQgJE9TRHJpdmUgLVRwbVByb3RlY3RvciAtVXNlZFNwYWNlT25seSAtRXJyb3JBY3Rpb24gQ29udGludWUKICAgICAgICAgICAgICAgIGlmICgkPykgewogICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnU3VjY2Vzc2Z1bGx5IGVuYWJsZWQgYml0bG9ja2VyLicpICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdGYWlsZWQgRW5hYmxpbmcgQml0bG9ja2VyIFRwbVByb3RlY3RvciwgaXRgcyBwcm9iYWJseSBhbHJlYWR5IGVuYWJsZWQnKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IAogICAgICAgICAgICBjYXRjaCB7CiAgICAgICAgICAgICAgICBMb2dFcnJvcnMKICAgICAgICAgICAgICAgIEVuYWJsZS1CaXRMb2NrZXIgLU1vdW50UG9pbnQgJE9TRHJpdmUgLVRwbVByb3RlY3RvciAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZQogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdXaWxsIGF0dGVtcHQgdG8gRW5hYmxlIEJpdExvY2tlciBhbnl3YXkgYW5kIHRoZW4gY29udGludWUuIFN1Y2Nlc3M/IHswfScgLWYgKCQ/KSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnRGlkIHdlIGFjdHVhbGx5IGVuYWJsZSBCaXRMb2NrZXI/JykKICAgICAgICAgICAgICAgIEdldC1CaXRMb2NrZXJTdGF0dXMKICAgICAgICAgICAgICAgIGlmICgkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXIC1hbmQgJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1swXSkgewogICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnVFBNIHByZXNlbnQgZm9yIE9TIERyaXZlPyB7MH0nIC1mICgkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzBdKSkKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1Byb21wdGluZyByZWJvb3QuJykKICAgICAgICAgICAgICAgICAgICBQcm9tcHQtUmVib290CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0VSUk9SLCBub3QgZW5jcnlwdGVkLiBUUE0gbm90IHByZXNlbnQgZm9yIE9TIERyaXZlJykKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgICMgSWYgc2NlbmFyaW8gZml0cyBub25lIG9mIHRoZSBjYXNlcyBhYm92ZS4uCiAgICBlbHNlIHsKICAgICAgICBMb2dXcml0ZSAoJ05laXRoZXIgInswfSIsICJ7MX0iIG9yICJ7Mn0iLicgLWYgKCRTY3JpcHQ6Qml0TG9ja2VyVm9sdW1lRW5jcnlwdGlvblN0YXR1c2VzWzBdLCRTY3JpcHQ6Qml0TG9ja2VyVm9sdW1lRW5jcnlwdGlvblN0YXR1c2VzWzFdLCRTY3JpcHQ6Qml0TG9ja2VyVm9sdW1lRW5jcnlwdGlvblN0YXR1c2VzWzJdKSkKICAgIH0KfQojZW5kcmVnaW9uIEJpdExvY2tlciBFbmNyeXB0aW9uIG9mIE9TIERyaXZlCgoKCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKIyBQcm90ZWN0aW9uIFBhc3N3b3JkIGZvciBPUyBEcml2ZSAgIwojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiNyZWdpb24gUHJvdGVjdGlvbiBQYXNzd29yZCBmb3IgT1MgRHJpdmUKCkxvZ1dyaXRlICgnIyBCaXRMb2NrZXIgUHJvdGVjdGlvbiBQYXNzd29yZCBmb3IgT1MgRHJpdmUnKQojIElmICdGdWxseUVuY3J5cHRlZCcsIG9yIFRNUCBpcyBwcmVzZW50CmlmICgkU2NyaXB0OklzRW5jcnlwdGVkIC1vciAoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQVyAtYW5kICRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMF0pKSB7CiAgICAKICAgIAogICAgIyBJZiB3ZSdyZSBkb25lIHdpdGggcmVjb3ZlcnkgcGFzc3dvcmQocykgYWxyZWFkeQogICAgaWYgKCRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cgLWFuZCAoJFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzIC1lcSAxKSkgewogICAgICAgIExvZ1dyaXRlICdSZWNvdmVyeSBQYXNzd29yZCBmb3IgT1MgRHJpdmUgaXMgYWxyZWFkeSBwcmVzZW50JwogICAgfQogICAgCgogICAgIyBJZiB3ZSdyZSBub3QgZG9uZSB3aXRoIHJlY292ZXJ5IHBhc3N3b3JkKHMpCiAgICBlbHNlIHsgICAgICAgIAogICAgICAgIFtib29sXSAkU2NyaXB0OkJvb2xEaWRBbnl0aGluZ0NoYW5nZVRoaXNSdW50aW1lID0gJHRydWUKICAgICAgICBbYm9vbF0gJExvY2FsOlN1Y2Nlc3MgPSAkZmFsc2UKICAgICAgICAKICAgICAgICAKICAgICAgICAjIElmIHRoZXJlIGV4aXN0cyBCaXRMb2NrZXIgRW5jcnlwdGlvbiBSZWNvdmVyeSBQYXNzd29yZCAgICAgICAKICAgICAgICBpZiAoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1sxXSkgewogICAgICAgICAgICAKCiAgICAgICAgICAgICMgSWYgdGhlcmVzIGlzIF9hXyBQcm90ZWN0aW9uUGFzc3dvcmQsIHdlJ3JlIGRvbmUKICAgICAgICAgICAgaWYgKCRTY3JpcHQ6Q291bnRSZWNvdmVyeVBhc3N3b3JkcyAtZXEgMSkgewogICAgICAgICAgICAgICAgTG9nV3JpdGUgJ09ubHkgYSBwYXNzd29yZCBwcmVzZW50JwogICAgICAgICAgICAgICAgJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdyA9ICR0cnVlCiAgICAgICAgICAgICAgICAkTG9jYWw6U3VjY2VzcyA9ICR0cnVlCiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAjIElmIHRoZXJlIGlzIG11bHRpcGxlIFJlY292ZXJ5UGFzc3dvcmRzLCB3ZSBuZWVkIHRvIHJlbW92ZSBhbGwgYnV0IG9uZQogICAgICAgICAgICBlbHNlaWYgKCRTY3JpcHQ6Q291bnRSZWNvdmVyeVBhc3N3b3JkcyAtZ3QgMSkgewogICAgICAgICAgICAgICAgTG9nV3JpdGUgJ011bHRpcGxlIHBhc3N3b3JkcyBwcmVzZW50JwogICAgICAgICAgICAgICAgV3JpdGUtUmVjb3ZlcnlQYXNzd29yZAogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdXaWxsIHJlbW92ZSBhbGwgYnV0IHRoZSBmaXJzdCBvbmUnKQogICAgICAgICAgICAgICAgJFNjcmlwdDpBcnJheVJlY292ZXJ5UGFzc3dvcmRzIHwgRm9yRWFjaC1PYmplY3QgeyAKICAgICAgICAgICAgICAgICAgICBpZiAoJF8uS2V5UHJvdGVjdG9ySWQgLW5lICRTY3JpcHQ6QXJyYXlSZWNvdmVyeVBhc3N3b3Jkc1swXS5LZXlQcm90ZWN0b3JJZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkbnVsbCA9IFJlbW92ZS1CaXRMb2NrZXJLZXlQcm90ZWN0b3IgLU1vdW50UG9pbnQgJE9TRHJpdmUgLUtleVByb3RlY3RvcklkICRfLktleVByb3RlY3RvcklECiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkPykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdTdWNjZXNzZnVsbHkgcmVtb3ZlZCB8IEtleVByb3RlY3RvcklkICJ7MH0iIHwgUmVjb3ZlcnlQYXNzd29yZCAiezF9IicgLWYgKCRfLktleVByb3RlY3RvcklkLCRfLlJlY292ZXJ5UGFzc3dvcmQpKQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1N1Y2Nlc3NmdWxseSBza2lwcGVkIHRoZSBmaXJzdCBrZXkuIHwgS2V5UHJvdGVjdG9ySWQgInswfSIgfCBSZWNvdmVyeVBhc3N3b3JkICJ7MX0iJyAtZiAoJF8uS2V5UHJvdGVjdG9ySWQsJF8uUmVjb3ZlcnlQYXNzd29yZCkpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIEdldC1CaXRMb2NrZXJTdGF0dXMKICAgICAgICAgICAgICAgIGlmICgkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXIC1hbmQgJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1sxXSAtYW5kICgkU2NyaXB0OkNvdW50UmVjb3ZlcnlQYXNzd29yZHMgLWVxIDEpKSB7CiAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN1Y2Nlc3MgPSAkdHJ1ZQogICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAjIFRoaXMgc2hvdWxkIG5vdCBiZSBwb3NzaWJsZQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIExvZ1dyaXRlICdFUlJPUjogUmVjb3ZlcnlQYXNzd29yZCBwcmVzZW50LCBidXQgY291bnQgPCAxJwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAKICAgICAgICAjcmVnaW9uIEFkZCBQcm90ZWN0aW9uIFBhc3N3b3JkIElmIE5vbmUgUHJlc2VudAogICAgICAgIGVsc2UgewogICAgICAgICAgICBMb2dXcml0ZSAoJ05vIEJpdExvY2tlciBSZWNvdmVyeSBQYXNzd29yZHMgZm91bmQgZm9yIE9TIERyaXZlIHswfSwgY3JlYXRpbmcgb25lLicgLWYgJE9TRHJpdmUpCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAkbnVsbCA9IEFkZC1CaXRMb2NrZXJLZXlQcm90ZWN0b3IgLU1vdW50UG9pbnQgJE9TRHJpdmUgLVJlY292ZXJ5UGFzc3dvcmRQcm90ZWN0b3IgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUgLVdhcm5pbmdBY3Rpb24gU2lsZW50bHlDb250aW51ZQogICAgICAgICAgICAgICAgaWYgKCQ/KSB7CiAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN1Y2Nlc3MgPSAkdHJ1ZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJG51bGwgPSBFbmFibGUtQml0TG9ja2VyIC1Nb3VudFBvaW50ICRPU0RyaXZlIC1SZWNvdmVyeVBhc3N3b3JkUHJvdGVjdG9yIC1FcnJvckFjdGlvbiBTdG9wCiAgICAgICAgICAgICAgICAgICAgaWYgKCQ/KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdWNjZXNzID0gJHRydWUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICB9IAogICAgICAgICAgICBjYXRjaCB7CiAgICAgICAgICAgICAgICBMb2dFcnJvcnMKICAgICAgICAgICAgICAgICRudWxsID0gQWRkLUJpdExvY2tlcktleVByb3RlY3RvciAtTW91bnRQb2ludCAkT1NEcml2ZSAtUmVjb3ZlcnlQYXNzd29yZFByb3RlY3RvciAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSAtV2FybmluZ0FjdGlvbiBTaWxlbnRseUNvbnRpbnVlCiAgICAgICAgICAgICAgICBpZiAoJExhc3RFeGl0Q29kZSAtZXEgMCkgewogICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdWNjZXNzID0gJHRydWUKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICRudWxsID0gRW5hYmxlLUJpdExvY2tlciAtTW91bnRQb2ludCAkT1NEcml2ZSAtUmVjb3ZlcnlQYXNzd29yZFByb3RlY3RvciAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZQogICAgICAgICAgICAgICAgICAgIGlmICgkPykgewogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3VjY2VzcyA9ICR0cnVlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZpbmFsbHkgewogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdUcmllZCB0byBhZGQgQml0TG9ja2VyIFJlY292ZXJ5UGFzc3dvcmRQcm90ZWN0b3IuIFN1Y2Nlc3M/IHswfS4nIC1mICgkTG9jYWw6U3VjY2VzcykpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gQWRkIFByb3RlY3Rpb24gUGFzc3dvcmQgSWYgTm9uZSBQcmVzZW50CgogICAgICAgIAoKICAgICAgICAjIENvdW50IGFuZCBsaXN0IGV4aXN0aW5nIFJlY292ZXJ5UGFzc3dvcmQsIG9ubHkgd3JpdGUgc3VjY2VzcyBpZiB0aGVyZXMgb25lICAgICAgICAKICAgICAgICBpZiAoJExvY2FsOlN1Y2Nlc3MpIHsKICAgICAgICAgICAgTG9nV3JpdGUgJ0NoZWNraW5nIGlmIHRoZXJlIGlzIG9ubHkgb25lIFByb3RlY3Rpb24gUGFzc3dvcmQuJwogICAgICAgICAgICBHZXQtQml0TG9ja2VyU3RhdHVzCiAgICAgICAgICAgICRMb2NhbDpCb29sVGVtcCA9ICQoSWYoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQVyl7KCRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMV0pfUVsc2V7JGZhbHNlfSkKICAgICAgICAgICAgTG9nV3JpdGUgKCdQcm90ZWN0aW9uIFBhc3N3b3JkIFByZXNlbnQ/IHswfScgLWYgKCRMb2NhbDpCb29sVGVtcCkpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIElmKCRMb2NhbDpCb29sVGVtcCkgeyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoJFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzIC1lcSAxKSB7ICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnU1VDQ0VTUywga2V5cyBsZWZ0OiAxLicpCiAgICAgICAgICAgICAgICAgICAgJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdyA9ICR0cnVlCiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAnRkFJTCwga2V5cyBsZWZ0OiB7MH0uJyAtZiAoJFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzKQogICAgICAgICAgICAgICAgICAgICRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cgPSAkZmFsc2UKICAgICAgICAgICAgICAgIH0gIAogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdGQUlMLCBubyBQcm90ZWN0aW9uIFBhc3N3b3JkIGZvdW5kJykKICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIExvZ1dyaXRlICgnU29tZXRoaW5nIGZhaWxlZCcpCiAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgCiAgICB9CiAgICAjZW5kcmVnaW9uIElmIHRoZXJlcyAwIG9yIG11bHRpcGxlIFByb3RlY3Rpb25zUGFzc3dvcmQocykgCn0KCgojIE5vdCBlbmNyeXB0ZWQgPSBObyBtYWtpbmcgb2YgUmVjb3ZlcnlQYXNzd29yZAplbHNlIHsKICAgIExvZ1dyaXRlICgnT1MgRHJpdmUgaXMgIkZ1bGx5RGVjcnlwdGVkIiBhbmQgdGhlcmUgZXhpc3RzIG5vICJUUE0iLicpCiAgICBMb2dXcml0ZSAoJ0JpdExvY2tlciBSZWNvdmVyeVBhc3N3b3JkIGNhbiBub3QgYmUgYWRkZWQgYXQgdGhpcyB0aW1lLicpCiAgICBMb2dXcml0ZSAoJ1JlY292ZXJ5IFBhc3N3b3JkIHByZXNlbnQ/IHswfScgLWYgKCQoSWYoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQVyl7JFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1swXX1FbHNleyRmYWxzZX0pKSkKICAgICRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cgPSAkZmFsc2UKfQoKIyBXcml0ZSByZWNvdmVyeSBwYXNzd29yZChzKSBpZiBhbnl0aGluZyBjaGFuZ2VkIHRoaXMgcnVudGltZQppZiAoJFNjcmlwdDpCb29sRGlkQW55dGhpbmdDaGFuZ2VUaGlzUnVudGltZSAtYW5kICRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMV0pIHsKICAgIFdyaXRlLVJlY292ZXJ5UGFzc3dvcmQKfQojZW5kcmVnaW9uIFByb3RlY3Rpb24gUGFzc3dvcmQgZm9yIE9TIERyaXZlCiNlbmRyZWdpb24gRW5jcnlwdGlvbgoKCgojIyMjIyMjIyMjIyMjIyMjIyMjIwojIyMjIyMgQkFDS1VQICMjIyMjIwojIyMjIyMjIyMjIyMjIyMjIyMjIwojcmVnaW9uIEJhY2t1cAoKCkxvZ1dyaXRlICgnIyMjIEJhY2t1cCBQcm90ZWN0aW9uIFBhc3N3b3JkIHRvIEF6dXJlQUFEIGFuZCBPbmVEcml2ZTRCJykKCiMgQ2hlY2sgZm9yIGNoYW5nZXMgaWYgRmluaXNoZWQxc3RUaW1lCmlmICgkU2NyaXB0OklzRmluaXNoZWQxc3RUaW1lKSB7CiAgICBMb2dXcml0ZSAoJ1dpbGwgY2hlY2sgaWYgYW55dGhpbmcgaGFzIGNoYW5nZWQuJykKCiAgICBpZiAoQ2hlY2stSWZCaXRMb2NrZXJQV0hhc0NoYW5nZWQpIHsKICAgICAgICBMb2dXcml0ZSAnU29tZXRoaW5nIGhhcyBjaGFuZ2VkLCBCaXRMb2NrZXIgUmVjb3ZlcnkgUHJvdGVjdGlvbiBQYXNzd29yZCBpcyBub3QgdGhlIHNhbWUgYXMgdGhlIG9uZSBiYWNrZWQgdXAuJwogICAgICAgICRTY3JpcHQ6SXNCYWNrdXBBQUQgPSAkU2NyaXB0OklzQmFja3VwT0QgPSAkZmFsc2UKICAgICAgICAkU2NyaXB0OkJvb2xEaWRBbnl0aGluZ0NoYW5nZVRoaXNSdW50aW1lID0gJHRydWUKICAgIH0KICAgIGVsc2UgewogICAgICAgIExvZ1dyaXRlICdOb3RoaW5nIGhhcyBjaGFuZ2VkLCBCaXRMb2NrZXIgUmVjb3ZlcnkgUHJvdGVjdGlvbiBQYXNzd29yZCBpcyB0aGUgc2FtZSBhcyB0aGUgb25lIHByZXZpb3VzbHkgYmFja2VkIHVwLicKICAgIH0KfQoKIyBJZiAkSXNCYWNrdXBBQUQgLWFuZCAkSXNCYWNrdXBPRAppZiAoJFNjcmlwdDpJc0JhY2t1cEFBRCAtYW5kICRTY3JpcHQ6SXNCYWNrdXBPRCkgewogICAgTG9nV3JpdGUgKCdPUyBEcml2ZSBpcyBhbHJlYWR5IGJhY2tlZCB1cC4nKQp9CgoKIyBJZiBubyBiYWNrdXBzCmVsc2UgewogICAgIyBJZiBQcm90ZWN0aW9uUGFzc3dvcmQocykgZXhpc3QKICAgIGlmICgkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3KSB7CiAgICAgICAgICAgIAogICAgICAgIExvZ1dyaXRlICgnT1MgRHJpdmUgaXMgZW5jcnlwdGVkLCBhbmQgdGhlcmUgYXJlIHswfSBQcm90ZWN0aW9uUGFzc3dvcmQocykgcHJlc2VudC4nIC1mICgkU2NyaXB0OkFycmF5UmVjb3ZlcnlQYXNzd29yZHMuTGVuZ3RoKSkKICAgICAgICBMb2dXcml0ZSAoJ0NvbnRpbnVpbmcgd2l0aCBiYWNrdXAuJykKCiAgICAKICAgICAgICAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKICAgICAgICAjIE9uZURyaXZlIGZvciBCdXNpbmVzcyBiYWNrdXAKICAgICAgICAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKICAgICAgICAjcmVnaW9uIEJhY2t1cCBPbmVEcml2ZSBmb3IgQnVzaW5lc3MKICAgIAogICAgICAgIExvZ1dyaXRlICgnIyBCYWNrdXAgdG8gT25lRHJpdmUnKQogICAgICAgIGlmICgkU2NyaXB0OklzQmFja3VwT0QpIHsKICAgICAgICAgICAgTG9nV3JpdGUgKCdBbHJlYWR5IGRvbmUnKQogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgJFNjcmlwdDpCb29sRGlkQW55dGhpbmdDaGFuZ2VUaGlzUnVudGltZSA9ICR0cnVlCiAgICAgICAgCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAjV3JpdGluZyBWYWx1ZSB0byBPbmVEcml2ZSBmaXJzdCAKICAgICAgICAgICAgICAgICRSZWdWYWx1ZXMgPSBHZXQtQ2hpbGRJdGVtICdIS0NVOlxTT0ZUV0FSRVxNaWNyb3NvZnRcT25lRHJpdmVcQWNjb3VudHNcJwogICAgICAgICAgICAgICAgZm9yZWFjaCAoJFJlZ1ZhbHVlIGluICRSZWdWYWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6T0Q0QkFjY1R5cGUgPSBbc3RyaW5nW11dICgoJFJlZ1ZhbHVlIHwgU2VsZWN0LU9iamVjdCAtRXhwYW5kUHJvcGVydHkgTmFtZSkuU3BsaXQoJ3tcfScpWy0xXSkKICAgICAgICAgICAgICAgICAgICBpZiAoJExvY2FsOk9ENEJBY2NUeXBlIC1saWtlICdCdXNpbmVzcyonKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnRm91bmQgYSBPbmVEcml2ZSBmb3IgQnVzaW5lc3MgYWNjb3VudC4nKQogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6S2V5ID0gJFJlZ1ZhbHVlLk5hbWUuUmVwbGFjZSgnSEtFWV9DVVJSRU5UX1VTRVJcJywnSEtDVTpcJykgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6UGF0aERpck9ENEIgPSAoR2V0LUl0ZW1Qcm9wZXJ0eSAtUGF0aCAkTG9jYWw6S2V5IC1OYW1lICdVc2VyRm9sZGVyJykuVXNlckZvbGRlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJExvY2FsOlBhdGhEaXJPRDRCIC1ub3RsaWtlICgnezB9XFVzZXJzXCpcT25lRHJpdmUgLSonIC1mICgkT1NEcml2ZSkpIC1hbmQgKC1ub3QoVGVzdC1QYXRoIC1QYXRoICRMb2NhbDpPRDRCUGF0aCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0ZhaWxlZCB0byBidWlsZCBPbmVEcml2ZSBwYXRoOiAiezB9Iiwgb3IgaXQgZG9lcyBub3QgZXhpc3QuJyAtZiAoJExvY2FsOlBhdGgpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgJFNjcmlwdDpJc0JhY2t1cE9EID0gJGZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjW3N0cmluZ10gJExvY2FsOlBhdGggPSAoJGVudjpTeXN0ZW1Ecml2ZSArICRlbnY6SE9NRVBBVEggKyAnT25lRHJpdmUgLSAnICsgJ1xCaXRMb2NrZXIgUmVjb3ZlcnlcJyArICRlbnY6Q09NUFVURVJOQU1FICsgJ1wnICkKICAgICAgICAgICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgtbm90KCRTY3JpcHQ6Q29tcHV0ZXJQcm9kdWN0TmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDcmVhdGUtRW52VmFyaWFibGVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgUnVudGltZSB2YXJpYWJsZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgW2Jvb2xdICRMb2NhbDpCb29sRm9sZGVyRXhpc3RzID0gJGZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIENyZWF0aW5nIHBhdGhzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6UGF0aERpck9ENEJCYWNrdXBQYXJlbnQgPSAoJ3swfVxCaXRMb2NrZXIgUmVjb3ZlcnlcJyAtZiAoJExvY2FsOlBhdGhEaXJPRDRCKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtzdHJpbmddICRMb2NhbDpQYXRoRGlyT0Q0QkJhY2t1cCA9ICgnezB9ezF9ICh7Mn0gezN9KVwnIC1mICgkTG9jYWw6UGF0aERpck9ENEJCYWNrdXBQYXJlbnQsJFNjcmlwdDpDb21wdXRlck5hbWUsJFNjcmlwdDpDb21wdXRlck1hbnVmYWN0dXJlciwkU2NyaXB0OkNvbXB1dGVyUHJvZHVjdE5hbWUpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdPbmVEcml2ZSBmb3IgQnVzaW5lc3MgUGF0aDogezB9JyAtZiAoJExvY2FsOlBhdGhEaXJPRDRCKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnQmFja3VwIFBhdGggUGFyZW50OiAgICAgICAgIHswfScgLWYgKCRMb2NhbDpQYXRoRGlyT0Q0QkJhY2t1cFBhcmVudCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0JhY2t1cCBQYXRoIGZvciBCaXRsb2NrZXIgUmVjb3ZlcnkgS2V5KHMpOiB7MH0nIC1mICgkTG9jYWw6UGF0aERpck9ENEJCYWNrdXApKSAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICNUZXN0aW5nIGlmIFJlY292ZXJ5IGZvbGRlciBleGlzdHMgaWYgbm90IGNyZWF0ZSBvbmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnVGVzdGluZyBpZiBiYWNrdXAgZm9sZGVyIGV4aXN0cywgY3JlYXRlIGl0IGlmIG5vdC4nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFRlc3QtUGF0aCAtUGF0aCAkTG9jYWw6UGF0aERpck9ENEJCYWNrdXAgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpCb29sRm9sZGVyRXhpc3RzID0gJHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICdDcmVhdGluZyBPbmVEcml2ZSBmb3IgQnVzaW5lc3MgZm9sZGVyIGZvciBiYWNrdXAuJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRudWxsID0gTmV3LUl0ZW0gLVBhdGggJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwIC1JdGVtVHlwZSAnRGlyZWN0b3J5JyAtRm9yY2UgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOkJvb2xGb2xkZXJFeGlzdHMgPSBUZXN0LVBhdGggLVBhdGggJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCd7MH0nIC1mICQoSWYoJExvY2FsOkJvb2xGb2xkZXJFeGlzdHMpeydTdWNjZXNzLid9RWxzZXsnRmFpbGVkLid9KSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgQ3JlYXRlIE9uZURyaXZlIGZvciBCdXNpbmVzcyBCYWNrdXAgaWYgdGhlIGZvbGRlciBleGlzdHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgtbm90KCRMb2NhbDpCb29sRm9sZGVyRXhpc3RzKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICdGYWlsZWQgdG8gY2hlY2sgb3IgY3JlYXRlIGZvbGRlci4nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIE1ha2Ugc3VyZSAnQml0TG9ja2VyIFJlY292ZXJ5JyBmb2xkZXIgaXMgaGlkZGVuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdNYWtpbmcgc3VyZSAiezB9IiBpcyBoaWRkZW4uJyAtZiAoJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwUGFyZW50KSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKEdldC1JdGVtIC1QYXRoICRMb2NhbDpQYXRoRGlyT0Q0QkJhY2t1cFBhcmVudCAtRm9yY2UpLkF0dHJpYnV0ZXMgLW5vdGxpa2UgJypoaWRkZW4qJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoR2V0LUl0ZW0gLVBhdGggJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwUGFyZW50IC1Gb3JjZSkuQXR0cmlidXRlcyA9IChHZXQtSXRlbSAtUGF0aCAkTG9jYWw6UGF0aERpck9ENEJCYWNrdXBQYXJlbnQgLUZvcmNlKS5BdHRyaWJ1dGVzIC1ib3IgJ0hpZGRlbicKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdTdWNjZXNzZnVsbHkgaGlkZGVuPyB7MH0uJyAtZiAoJD8pKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdBbHJlYWR5IGhpZGRlbi4nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIENyZWF0ZSBzdHJpbmcgZm9yIEJpdExvY2tlclJlY292ZXJ5UGFzc3dvcmQudHh0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgPSBbc3RyaW5nXTo6RW1wdHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAoJ0JpdExvY2tlciBSZWNvdmVyeVBhc3N3b3JkIGZvciBPUyBEcml2ZSAoezB9KXsxfScgLWYgKCRlbnY6U3lzdGVtRHJpdmUsImByYG4iKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSBHZXQtU3RyaW5nUmVjb3ZlcnlQYXNzd29yZHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAiYHJgbmByYG4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gJ0JpdExvY2tlciBEcml2ZSBFbmNyeXB0aW9uIHJlY292ZXJ5IGtleXswfScgLWYgImByYG4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gJ1RvIHZlcmlmeSB0aGF0IHRoaXMgaXMgdGhlIGNvcnJlY3QgcmVjb3Zlcnkga2V5LCBjb21wYXJlIHRoZSBzdGFydCBvZiB0aGUgZm9sbG93aW5nezB9JyAtZiAiYHJgbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAnaWRlbnRpZmllciB3aXRoIHRoZSBpZGVudGlmaWVyIHZhbHVlIGRpc3BsYXllZCBvbiB5b3VyIFBDLicKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAiYHJgbmByYG4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gKCdJZGVudGlmaWVyOiB7MH0nIC1mICgkU2NyaXB0OkFycmF5UmVjb3ZlcnlQYXNzd29yZHNbMF0uS2V5UHJvdGVjdG9ySWQpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICJgcmBuYHJgbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAnSWYgdGhlIGFib3ZlIGlkZW50aWZpZXIgbWF0Y2hlcyB0aGUgb25lIGRpc3BsYXllZCBieSB5b3VyIFBDLHswfScgLWYgImByYG4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gJ3RoZW4gdXNlIHRoZSBmb2xsb3dpbmcga2V5IHRvICB1bmxvY2sgeW91ciBkcml2ZTonCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gImByYG5gcmBuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICgnUmVjb3ZlcnkgS2V5OiB7MH0nIC1mICgkU2NyaXB0OkFycmF5UmVjb3ZlcnlQYXNzd29yZHNbMF0uUmVjb3ZlcnlQYXNzd29yZCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gImByYG5gcmBuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICdJZiB0aGUgYWJvdmUgaWRlbnRpZmllciBkb2VzbmB0IG1hdGNoIHRoZSBvbmUgZGlzcGxheWVkIGJ5IHlvdXIgUEMsezB9JyAtZiAiYHJgbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAndGhlbiB0aGlzIGlzbmB0IHRoZSByaWdodCBrZXkgdG8gdW5sb2NrIHlvdXIgZHJpdmUuezB9JyAtZiAiYHJgbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAnVHJ5IGFub3RoZXIgcmVjb3Zlcnkga2V5LCBvciByZWZlciB0b3swfScgLWYgImByYG4iIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICdodHRwczovL2dvLm1pY3Jvc29mdC5jb20vZndsaW5rLz9MaW5rSUQ9MjYwNTg5IGZvciBhZGRpdGlvbmFsIGFzc2lzdGFuY2UuJwoKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBPdXQtRmlsZSB0aGUgc3RyaW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgJ0NyZWF0aW5nIGJhY2t1cCBpbiBPbmVEcml2ZSBmb3IgQnVzaW5lc3MuJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtzdHJpbmddICRMb2NhbDpPRDRCQmFja3VwRmlsZVBhdGggPSAoJ3swfUJpdGxvY2tlclJlY292ZXJ5UGFzc3dvcmQtezF9LnR4dCcgLWYgKCRMb2NhbDpQYXRoRGlyT0Q0QkJhY2t1cCwoR2V0LURhdGUgLUZvcm1hdCAneXlNTWRkaGhtbXNzJykpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE91dC1GaWxlIC1GaWxlUGF0aCAkTG9jYWw6T0Q0QkJhY2t1cEZpbGVQYXRoIC1FbmNvZGluZyAndXRmOCcgLUZvcmNlIC1JbnB1dE9iamVjdCAoJExvY2FsOlN0clJlY1Bhc3MpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFRlc3QtUGF0aCAtUGF0aCAkTG9jYWw6T0Q0QkJhY2t1cEZpbGVQYXRoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRTY3JpcHQ6SXNCYWNrdXBPRCA9ICR0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIE9uZURyaXZlIGZvciBCdXNpbmVzcyBCYWNrdXAgU3VjY2Vzcz8KICAgICAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnU3VjY2Vzcz8gezB9JyAtZiAoJFNjcmlwdDpJc0JhY2t1cE9EKSkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdTa2lwcGluZyBwZXJzb25hbCBPbmVEcml2ZSBmb3IgQnVzaW5lc3MgZm9sZGVycy4nKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjYXRjaCB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0Vycm9yIHdoaWxlIGJhY2t1cCB0byBPbmVEcml2ZSwgbWFrZSBzdXJlIHRoYXQgeW91IGFyZSBBQUQgam9pbmVkIGFuZCBhcmUgcnVubmluZyB0aGUgY21kbGV0IGFzIGFuIGFkbWluLicpCiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0Vycm9yIG1lc3NhZ2U6JyArICJgcmBuIiArICgkXykpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmluYWxseSB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0RpZCBiYWNrdXAgdG8gT25lRHJpdmUgc3VjY2VlZD8gezB9JyAtZiAoJFNjcmlwdDpJc0JhY2t1cE9EKSkKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIEJhY2t1cCBPbmVEcml2ZSBmb3IgQnVzaW5lc3MKICAgIAoKCiAgICAgICAgIyMjIyMjIyMjIyMjIyMjIyMKICAgICAgICAjIEF6dXJlIEFEIEJhY2t1cAogICAgICAgICMjIyMjIyMjIyMjIyMjIyMjCiAgICAgICAgI3JlZ2lvbiBCYWNrdXAgQXp1cmUgQUFECgogICAgICAgIExvZ1dyaXRlICgnIyBCYWNrdXAgdG8gQXp1cmUgQUQnKQogICAgICAgIGlmICgkU2NyaXB0OklzQmFja3VwQUFEKSB7CiAgICAgICAgICAgIExvZ1dyaXRlICgnQWxyZWFkeSBkb25lJykKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICRTY3JpcHQ6Qm9vbERpZEFueXRoaW5nQ2hhbmdlVGhpc1J1bnRpbWUgPSAkdHJ1ZQogICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICNDaGVjayBpZiB3ZSBjYW4gdXNlIEJhY2t1cFRvQUFELUJpdExvY2tlcktleVByb3RlY3RvciBjb21tYW5kbGV0CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAnQ2hlY2sgaWYgd2UgY2FuIHVzZSBCYWNrdXBUb0FBRC1CaXRMb2NrZXJLZXlQcm90ZWN0b3IgY29tbWFuZGxldC4uLicKICAgICAgICAgICAgICAgICRjbWROYW1lID0gJ0JhY2t1cFRvQUFELUJpdExvY2tlcktleVByb3RlY3RvcicKICAgICAgICAgICAgICAgIGlmIChHZXQtQ29tbWFuZCAkY21kTmFtZSAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSkgewogICAgICAgICAgICAgICAgICAgICNCYWNrdXBUb0FBRC1CaXRMb2NrZXJLZXlQcm90ZWN0b3IgY29tbWFuZGxldCBleGlzdHMKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ3swfSBjb21tYW5kbGV0IGV4aXN0cyEnIC1mICRjbWROYW1lKSAKICAgICAgICAgICAgICAgICAgICAkbnVsbCA9IEJhY2t1cFRvQUFELUJpdExvY2tlcktleVByb3RlY3RvciAtTW91bnRQb2ludCAkT1NEcml2ZSAtS2V5UHJvdGVjdG9ySWQgJFNjcmlwdDpBcnJheVJlY292ZXJ5UGFzc3dvcmRzWzBdLktleVByb3RlY3RvcklkIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgaWYgKCQ/KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRTY3JpcHQ6SXNCYWNrdXBBQUQgPSAkdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOkJMViA9IEdldC1CaXRMb2NrZXJWb2x1bWUgLU1vdW50UG9pbnQgJE9TRHJpdmUKICAgICAgICAgICAgICAgICAgICAgICAgJG51bGwgPSBCYWNrdXBUb0FBRC1CaXRMb2NrZXJLZXlQcm90ZWN0b3IgLU1vdW50UG9pbnQgJE9TRHJpdmUgLUtleVByb3RlY3RvcklkICRMb2NhbDpCTFYuS2V5UHJvdGVjdG9yWzBdLktleVByb3RlY3RvcklkIC1FcnJvckFjdGlvbiBTdG9wCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkPykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJFNjcmlwdDpJc0JhY2t1cEFBRCA9ICR0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdTdWNjZXNzPyB7MH0nIC1mICgkU2NyaXB0OklzQmFja3VwQUFEKSkKICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgICAgICBlbHNlIHsgCiAgICAgICAgICAgICAgICAgICAgIyBCYWNrdXBUb0FBRC1CaXRMb2NrZXJLZXlQcm90ZWN0b3IgY29tbWFuZGxldCBub3QgYXZhaWxhYmxlLCB1c2luZyBvdGhlciBtZWNoYW5pc20gCiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgJ0JhY2t1cFRvQUFELUJpdExvY2tlcktleVByb3RlY3RvciBjb21tYW5kbGV0IG5vdCBhdmFpbGFibGUsIHVzaW5nIG90aGVyIG1lY2hhbmlzbS4nIAogICAgICAgICAgICAgICAgICAgICMgR2V0IHRoZSBBQUQgTWFjaGluZSBDZXJ0aWZpY2F0ZQogICAgICAgICAgICAgICAgICAgICRjZXJ0ID0gR2V0LUNoaWxkSXRlbSBDZXJ0OlxMb2NhbE1hY2hpbmVcTXlcIHwgV2hlcmUtT2JqZWN0IHsgJF8uSXNzdWVyIC1tYXRjaCAnQ049TVMtT3JnYW5pemF0aW9uLUFjY2VzcycgfQoKICAgICAgICAgICAgICAgICAgICAjIE9idGFpbiB0aGUgQUFEIERldmljZSBJRCBmcm9tIHRoZSBjZXJ0aWZpY2F0ZQogICAgICAgICAgICAgICAgICAgICRpZCA9ICRjZXJ0LlN1YmplY3QuUmVwbGFjZSgnQ049JywnJykKCiAgICAgICAgICAgICAgICAgICAgIyBHZXQgdGhlIHRlbmFudCBuYW1lIGZyb20gdGhlIHJlZ2lzdHJ5CiAgICAgICAgICAgICAgICAgICAgJHRlbmFudCA9IChHZXQtSXRlbVByb3BlcnR5IEhLTE06XFNZU1RFTVxDdXJyZW50Q29udHJvbFNldFxDb250cm9sXENsb3VkRG9tYWluSm9pblxKb2luSW5mb1wkKCRpZCkpLlVzZXJFbWFpbC5TcGxpdCgnQCcpWzFdCiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgJHRlbmFudAogICAgICAgICAgICAgICAgICAgICMgR2VuZXJhdGUgdGhlIGJvZHkgdG8gc2VuZCB0byBBQUQgY29udGFpbmluZyB0aGUgcmVjb3ZlcnkgaW5mb3JtYXRpb24KICAgICAgICAgICAgICAgICAgICAjIEdldCB0aGUgQml0TG9ja2VyIGtleSBpbmZvcm1hdGlvbiBmcm9tIFdNSQogICAgICAgICAgICAgICAgICAgIChHZXQtQml0TG9ja2VyVm9sdW1lIC1Nb3VudFBvaW50ICRPU0RyaXZlKS5LZXlQcm90ZWN0b3J8IFdoZXJlLU9iamVjdCB7JF8uS2V5UHJvdGVjdG9yVHlwZSAtZXEgJ1JlY292ZXJ5UGFzc3dvcmQnfSB8IEZvckVhY2gtT2JqZWN0IHsKICAgICAgICAgICAgICAgICAgICAgICAgJGtleSA9ICRfCiAgICAgICAgICAgICAgICAgICAgICAgIHdyaXRlLXZlcmJvc2UgImtpZCA6ICQoJGtleS5LZXlQcm90ZWN0b3JJZCkga2V5OiAkKCRrZXkuUmVjb3ZlcnlQYXNzd29yZCkiCiAgICAgICAgICAgICAgICAgICAgICAgICRib2R5ID0gInsiImtleSIiOiIiJCgka2V5LlJlY292ZXJ5UGFzc3dvcmQpIiIsIiJraWQiIjoiIiQoJGtleS5LZXlQcm90ZWN0b3JJZC5yZXBsYWNlKCd7JywnJykuUmVwbGFjZSgnfScsJycpKSIiLCIidm9sIiI6IiJPU1YiIn0iCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgQ3JlYXRlIHRoZSBVUkwgdG8gcG9zdCB0aGUgZGF0YSB0byBiYXNlZCBvbiB0aGUgdGVuYW50IGFuZCBkZXZpY2UgaW5mb3JtYXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgJHVybCA9ICJodHRwczovL2VudGVycHJpc2VyZWdpc3RyYXRpb24ud2luZG93cy5uZXQvbWFuYWdlLyR0ZW5hbnQvZGV2aWNlLyQoJGlkKT9hcGktdmVyc2lvbj0xLjAiCiAgICAgICAgICAgICAgICAgICAgICAgIExvZ3N0cmluZyAiQ3JlYXRpbmcgdXJsLi4uJHVybCIKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBQb3N0IHRoZSBkYXRhIHRvIHRoZSBVUkwgYW5kIHNpZ24gaXQgd2l0aCB0aGUgQUFEIE1hY2hpbmUgQ2VydGlmaWNhdGUKICAgICAgICAgICAgICAgICAgICAgICAgJHJlcSA9IEludm9rZS1XZWJSZXF1ZXN0IC1VcmkgJHVybCAtQm9keSAkYm9keSAtVXNlQmFzaWNQYXJzaW5nIC1NZXRob2QgUG9zdCAtVXNlRGVmYXVsdENyZWRlbnRpYWxzIC1DZXJ0aWZpY2F0ZSAkY2VydAogICAgICAgICAgICAgICAgICAgICAgICAkcmVxLlJhd0NvbnRlbnQKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQ/KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkU2NyaXB0OklzQmFja3VwQUFEID0gJHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgfSAgICAKICAgICAgICAgICAgICAgICAgICAgICAgTG9nU3RyaW5nICgnUG9zdCB0aGUgZGF0YSB0byB0aGUgVVJMIGFuZCBzaWduIGl0IHdpdGggdGhlIEFBRCBNYWNoaW5lIENlcnRpZmljYXRlLiBTdWNjZXNzPyB7MH0nIC1mICgkU2NyaXB0OklzQmFja3VwQUFEKSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoIHsKICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnRXJyb3Igd2hpbGUgYmFja3VwIHRvIEF6dXJlIEFELCBtYWtlIHN1cmUgdGhhdCB5b3UgYXJlIEFBRCBqb2luZWQgYW5kIGFyZSBydW5uaW5nIHRoZSBjbWRsZXQgYXMgYW4gYWRtaW4uJykKICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnRXJyb3IgbWVzc2FnZTonICsgImByYG4iICsgKCRfKSkKICAgICAgICAgICAgICAgICRJc0JhY2t1cEFBRCA9ICRmYWxzZQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZpbmFsbHkgewogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdEaWQgYmFja3VwIHRvIEF6dXJlIEFEIFN1Y2NlZWQ/IHswfScgLWYgKCRTY3JpcHQ6SXNCYWNrdXBBQUQpKQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gQmFja3VwIEF6dXJlIEFBRAogICAgICAgIAogICAgICAgIAogICAgICAgICMgSWYgbm8gYmFja3VwIGFuZCBubyBSZWNvdmVyeSBQYXNzd29yZHMgcHJlc2VudAogICAgICAgIAogICAgfQogICAgZWxzZSB7CiAgICAgICAgTG9nV3JpdGUgJ09TIERyaXZlIGlzIG5vdCBlbmNyeXB0ZXQsIHRoZXJlIGFyZSBubyBSZWNvdmVyeSBQYXNzd29yZHMsIGFuZCB0aGVyZSBhcmUgbm8gYmFja3Vwcy4nCiAgICB9Cn0KI2VuZHJlZ2lvbiBCYWNrdXAKI2VuZHJlZ2lvbiBNYWluCgoKCiMjIyMjIyMjIyMjIyMjIyMjIyMjCiMjIyMjIyAgRyBVIEkgIyMjIyMjCiMjIyMjIyMjIyMjIyMjIyMjIyMjCiNyZWdpb24gR1VJCmlmICgkU2NyaXB0OklzRW5jcnlwdGVkIC1hbmQgJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdyAtYW5kICRHVUkpIHsKICAgICMgU2hvdyByZWJvb3QgcHJvbXB0IHRvIHVzZXIKICAgIExvZ1dyaXRlICJQcm9tcHRpbmcgdXNlciB0byBSZWJvb3QgY29tcHV0ZXIuIgogICAgICAgICAgIAoKICAgIFt2b2lkXVtTeXN0ZW0uUmVmbGVjdGlvbi5Bc3NlbWJseV06OkxvYWRXaXRoUGFydGlhbE5hbWUoIOKAnFN5c3RlbS5XaW5kb3dzLkZvcm1z4oCdKQogICAgW3ZvaWRdW1N5c3RlbS5SZWZsZWN0aW9uLkFzc2VtYmx5XTo6TG9hZFdpdGhQYXJ0aWFsTmFtZSgg4oCcTWljcm9zb2Z0LlZpc3VhbEJhc2lj4oCdKQoKICAgICRmb3JtID0gTmV3LU9iamVjdCDigJxTeXN0ZW0uV2luZG93cy5Gb3Jtcy5Gb3Jt4oCdOwogICAgJGZvcm0uV2lkdGggPSA1MDA7CiAgICAkZm9ybS5IZWlnaHQgPSAxNTA7CiAgICAkZm9ybS5UZXh0ID0gIkJpdExvY2tlciByZXF1aXJlcyBhIHJlYm9vdCAhIjsKICAgICRmb3JtLlN0YXJ0UG9zaXRpb24gPSBbU3lzdGVtLldpbmRvd3MuRm9ybXMuRm9ybVN0YXJ0UG9zaXRpb25dOjpDZW50ZXJTY3JlZW47CgogICAgJERyb3BEb3duQXJyYXkgPSBAKCI0OkhvdXJzIiwgIjg6SG91cnMiLCAiMTI6SG91cnMiLCAiMjQ6SG91cnMiKQogICAgJERETCA9IE5ldy1PYmplY3QgU3lzdGVtLldpbmRvd3MuRm9ybXMuQ29tYm9Cb3gKICAgICREREwuTG9jYXRpb24gPSBOZXctT2JqZWN0IFN5c3RlbS5EcmF3aW5nLlNpemUoMTQwLCAxMCkKICAgICREREwuU2l6ZSA9IE5ldy1PYmplY3QgU3lzdGVtLkRyYXdpbmcuU2l6ZSgxMzAsIDMwKQogICAgRm9yRWFjaCAoJEl0ZW0gaW4gJERyb3BEb3duQXJyYXkpIHsKICAgICAgICAkRERMLkl0ZW1zLkFkZCgkSXRlbSkgfCBPdXQtTnVsbAogICAgfQogICAgJERETC5TZWxlY3RlZEluZGV4ID0gMAoKICAgICRidXR0b24xID0gTmV3LU9iamVjdCDigJxTeXN0ZW0uV2luZG93cy5Gb3Jtcy5idXR0b27igJ07CiAgICAkYnV0dG9uMS5MZWZ0ID0gNDA7CiAgICAkYnV0dG9uMS5Ub3AgPSA4NTsKICAgICRidXR0b24xLldpZHRoID0gMTAwOwogICAgJGJ1dHRvbjEuVGV4dCA9IOKAnFJlYm9vdCBOb3figJ07CiAgICAkYnV0dG9uMS5BZGRfQ2xpY2soIHskZ2xvYmFsOnhpbnB1dCA9ICJSZWJvb3QiOyAkRm9ybS5DbG9zZSgpfSkKCiAgICAkYnV0dG9uMiA9IE5ldy1PYmplY3Qg4oCcU3lzdGVtLldpbmRvd3MuRm9ybXMuYnV0dG9u4oCdOwogICAgJGJ1dHRvbjIuTGVmdCA9IDE3MDsKICAgICRidXR0b24yLlRvcCA9IDg1OwogICAgJGJ1dHRvbjIuV2lkdGggPSAxMDA7CiAgICAkYnV0dG9uMi5UZXh0ID0g4oCcUG9zdHBvbmXigJ07CiAgICAkYnV0dG9uMi5BZGRfQ2xpY2soIHskZ2xvYmFsOnhpbnB1dCA9ICJQb3N0cG9uZToiICsgJERETC5UZXh0OyAkRm9ybS5DbG9zZSgpfSkKCiAgICAkYnV0dG9uMyA9IE5ldy1PYmplY3Qg4oCcU3lzdGVtLldpbmRvd3MuRm9ybXMuYnV0dG9u4oCdOwogICAgJGJ1dHRvbjMuTGVmdCA9IDI5MDsKICAgICRidXR0b24zLlRvcCA9IDg1OwogICAgJGJ1dHRvbjMuV2lkdGggPSAxMDA7CiAgICAkYnV0dG9uMy5UZXh0ID0g4oCcQ2FuY2Vs4oCdOwogICAgJGJ1dHRvbjMuQWRkX0NsaWNrKCB7JGdsb2JhbDp4aW5wdXQgPSAiUG9zdHBvbmUyNCI7ICRGb3JtLkNsb3NlKCl9KQoKCiAgICAkZm9ybS5LZXlQcmV2aWV3ID0gJFRydWUKICAgICRmb3JtLkFkZF9LZXlEb3duKCB7aWYgKCRfLktleUNvZGUgLWVxICJFbnRlciIpIAogICAgICAgIHskeCA9ICR0ZXh0Qm94MS5UZXh0OyAkZm9ybS5DbG9zZSgpfX0pCiAgICAkZm9ybS5BZGRfS2V5RG93bigge2lmICgkXy5LZXlDb2RlIC1lcSAiRXNjYXBlIikgCiAgICAgICAgeyRmb3JtLkNsb3NlKCl9fSkKCiAgICAkZXZlbnRIYW5kbGVyID0gW1N5c3RlbS5FdmVudEhhbmRsZXJdIHsgCiAgICAgICAgJGJ1dHRvbjEuQ2xpY2s7CiAgICAgICAgJERyb3BEb3duQXJyYXkuVGV4dDsKICAgICAgICAkZm9ybS5DbG9zZSgpOyB9OwoKICAgICMkYnV0dG9uLkFkZF9DbGljaygkZXZlbnRIYW5kbGVyKSA7CiAgICAkZm9ybS5Db250cm9scy5BZGQoJGJ1dHRvbjEpOwogICAgJGZvcm0uQ29udHJvbHMuQWRkKCRidXR0b24yKTsKICAgICRmb3JtLkNvbnRyb2xzLkFkZCgkYnV0dG9uMyk7CiAgICAkZm9ybS5Db250cm9scy5BZGQoJERETCk7CiAgICAkZm9ybS5Db250cm9scy5BZGQoJHRleHRMYWJlbDEpCiAgICAkcmV0ID0gJGZvcm0uU2hvd0RpYWxvZygpOwoKICAgIGlmICgkZ2xvYmFsOnhpbnB1dCAtZXEgIlJlYm9vdCIpIHtzaHV0ZG93biAtciAtZiAvdCA2MDB9CiAgICBpZiAoJGdsb2JhbDp4aW5wdXQgLWxpa2UgIlBvc3Rwb25lOio6SG91cnMiKSB7CiAgICAgICAgJGh2YWwgPSAoKFtpbnRdJGdsb2JhbDp4aW5wdXQuc3BsaXQoIjoiKVsxXSkgKiA2MCAqIDYwKQogICAgICAgIHNodXRkb3duIC1yIC1mIC90ICRodmFsCiAgICB9CiAgICBpZiAoJGdsb2JhbDp4aW5wdXQgLWVxICJQb3N0cG9uZTI0Iikge3NodXRkb3duIC1yIC1mIC90IDg2NDAwfQp9CiNlbmRyZWdpb24gR1VJCgoKCiMjIyMjIyMjIyMjIyMjIyMjIyMjCiMjIyMgRU5EIFJFU1VMVFMgIyMjCiMjIyMjIyMjIyMjIyMjIyMjIyMjCiNyZWdpb24gRW5kIFJlc3VsdHMgCkxvZ1dyaXRlICgnIyMjIEVuZCByZXN1bHRzJykKIyBDbGVhbmluZyB1cCBpZiBzdWNjZXNzCmlmICgkU2NyaXB0OklzRmluaXNoZWQxc3RUaW1lKSB7CiAgICBMb2dXcml0ZSAnRmluaXNoZWQgZmlyc3QgdGltZSA9IFRydWUgfCBKdXN0IGNoZWNrZWQgd2VhdGhlciBCaXRMb2NrZXIgUmVjb3ZlcnkgUGFzc3dvcmQgaGFkIGNoYW5nZWQuJwp9CgplbHNlIHsKICAgIGlmICgkU2NyaXB0OklzRW5jcnlwdGVkIC1hbmQgJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdyAtYW5kICRTY3JpcHQ6SXNCYWNrdXBBQUQgLWFuZCAkU2NyaXB0OklzQmFja3VwT0QpIHsKICAgICAgICBHZXQtQml0TG9ja2VyU3RhdHVzCiAgICAgICAgaWYgKCgkU2NyaXB0OlZvbHVtZUVuY1N0YXR1cyAtZXEgJFNjcmlwdDpCaXRMb2NrZXJWb2x1bWVFbmNyeXB0aW9uU3RhdHVzZXNbMl0pIC1hbmQgKCRTY3JpcHQ6Q291bnRSZWNvdmVyeVBhc3N3b3JkcyAtZXEgMSkpIHsKICAgICAgICAKICAgICAgICAgICAgIyBGaXJzdCBzdWNjZXNzZnVsbCBydW4KICAgICAgICAgICAgJFNjcmlwdDpJc0ZpbmlzaGVkMXN0VGltZSA9ICR0cnVlIAogICAgICAgICAgICAKICAgICAgICAgICAgIyBTY2hlZHVsZWRUYXNrCiAgICAgICAgICAgIEVkaXQtU2NoZWR1bGVkVGFzayAtVGFza05hbWUgJFNjcmlwdDpTY2hlZHVsZWRUYXNrTmFtZQoKICAgICAgICAgICAgIyBGaWxlcwogICAgICAgICAgICAjcmVnaW9uIFJlbW92ZSBmaWxlcwogICAgICAgICAgICBpZiAoJFNjcmlwdDpCb29sUmVtb3ZlRmlsZXNBZnRlclN1Y2Nlc3MgLWFuZCAkU2NyaXB0OklzRmluaXNoZWQxc3RUaW1lKSB7ICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAkbnVsbCA9IFN0YXJ0LUpvYiAtQXJndW1lbnRMaXN0ICRTY3JpcHQ6RmlsZUxvZyAtU2NyaXB0QmxvY2sgewogICAgICAgICAgICAgICAgICAgIFBhcmFtKFtzdHJpbmddICRGaWxlTG9nKQogICAgICAgIAogICAgICAgICAgICAgICAgICAgIEZ1bmN0aW9uIExvZ1dyaXRlIHsKICAgICAgICAgICAgICAgICAgICAgICAgUGFyYW0gKFtzdHJpbmddJExvZ1N0cmluZykKICAgICAgICAgICAgICAgICAgICAgICAgW3N0cmluZ10gJGEgPSBHZXQtRGF0ZQogICAgICAgICAgICAgICAgICAgICAgICBbc3RyaW5nXSAkTG9nU3RyaW5nID0gJGEsICRMb2dTdHJpbmcKICAgICAgICAgICAgICAgICAgICAgICAgQWRkLWNvbnRlbnQgLVBhdGggJEZpbGVMb2cgLVZhbHVlICRMb2dTdHJpbmcKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgW3N0cmluZ10gJExvY2FsOlJlbURpclBhdGggPSAoJHtlbnY6UHJvZ3JhbUZpbGVzKHg4Nil9ICsgJ1xCaXRMb2NrZXJUcmlnZ2VyXCcpCiAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBTdGFydC1TbGVlcCAtU2Vjb25kcyA1CiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdTdGFydGVkIHRoZSBqb2IgdG8gcmVtb3ZlICJ7MH0iJyAtZiAoJExvY2FsOlJlbURpclBhdGgpKQogICAgICAgICAgICAgICAgICAgIGlmIChUZXN0LVBhdGggJExvY2FsOlJlbURpclBhdGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgUmVtb3ZlLUl0ZW0gLVBhdGggJExvY2FsOlJlbURpclBhdGggLVJlY3Vyc2UgLUZvcmNlCiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnUmVtb3ZpbmcgdGhlIGZvbGRlciAocmVjdXJzZSwgZm9yY2UpLiBTdWNjZXNzPyB7MH0nIC1mICgkPykpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0ZvbGRlciBkb2VzIG5vdCBleGlzdCcpCiAgICAgICAgICAgICAgICAgICAgfSAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfQogICAgICAgICAgICAjZW5kcmVnaW9uIFJlbW92ZSBGaWxlcwogICAgICAgIH0gICAgCiAgICB9CiAgICBlbHNlIHsKICAgICAgICBMb2dXcml0ZSAnVGhlcmUgYXJlIHN0aWxsIHRoaW5ncyB0byBkby4gVHJ5aW5nIGFnYWluIGxhdGVyLicKICAgIH0KfQojZW5kcmVnaW9uIEVuZCBSZXN1bHRzCgoKCiMjIyMjIyMjIyMjIyMjIyMjIyMjCiMjIyMgUyBUIEEgVCBTICMjIyMjCiMjIyMjIyMjIyMjIyMjIyMjIyMjCkxvZ1dyaXRlICgnIyMjIFNUQVRTJykKJFNjcmlwdDpDb3VudFJ1bnMgKz0gMQoKaWYgKC1ub3QoJFNjcmlwdDpCb29sUmVtb3ZlRmlsZXNBZnRlclN1Y2Nlc3MpKSB7CiAgICBpZiAoLW5vdChUZXN0LVBhdGggJFNjcmlwdDpEaXJJbnN0YWxsKSkgewogICAgICAgICRudWxsID0gTmV3LUl0ZW0gLVBhdGggJFNjcmlwdDpEaXJJbnN0YWxsIC1JdGVtVHlwZSBEaXJlY3RvcnkgLUZvcmNlCiAgICB9CiAgICAKICAgIFtzdHJpbmddICRPdXRTdHJpbmcgPSAoKCRTY3JpcHQ6Q291bnRSdW5zKS5Ub1N0cmluZygpICsgImByYG4iKSAgICAgICAgICAgICAgICAgICAjIDAKICAgICRPdXRTdHJpbmcgKz0gKChbYnl0ZV0gJFNjcmlwdDpJc0ZpbmlzaGVkMXN0VGltZSkuVG9TdHJpbmcoKSArICJgcmBuIikgICAgICAgICAgICAjIDEKICAgICRPdXRTdHJpbmcgKz0gKChbYnl0ZV0gJFNjcmlwdDpJc0VuY3J5cHRlZCkuVG9TdHJpbmcoKSArICJgcmBuIikgICAgICAgICAgICAgICAgICAjIDIKICAgICRPdXRTdHJpbmcgKz0gKChbYnl0ZV0gJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdykuVG9TdHJpbmcoKSArICJgcmBuIikgICAgICAgICAgICAjIDMKICAgICRPdXRTdHJpbmcgKz0gKChbYnl0ZV0gJFNjcmlwdDpJc0JhY2t1cE9EKS5Ub1N0cmluZygpICsgImByYG4iKSAgICAgICAgICAgICAgICAgICAjIDQKICAgICRPdXRTdHJpbmcgKz0gKChbYnl0ZV0gJFNjcmlwdDpJc0JhY2t1cEFBRCkuVG9TdHJpbmcoKSArICJgcmBuIikgICAgICAgICAgICAgICAgICAjIDUKICAgICRPdXRTdHJpbmcgKz0gKChbc3RyaW5nXSAkU2NyaXB0Ok9TRHJpdmVLZXlJRCkgKyAiYHJgbiIpICAgICAgICAgICAgICAgICAgICAgICAgICAjIDYKICAgICRPdXRTdHJpbmcgKz0gKChbc3RyaW5nXSAkU2NyaXB0Ok9TRHJpdmVQcm90ZWN0aW9uUGFzc3dvcmQpICsgImByYG4iKSAgICAgICAgICAgICAjIDcKICAgCiAgICBPdXQtRmlsZSAtRmlsZVBhdGggJFNjcmlwdDpGaWxlU3RhdHMgLUVuY29kaW5nIHV0ZjggLUZvcmNlIC1JbnB1dE9iamVjdCAoJE91dFN0cmluZykKfQpMb2dXcml0ZSAoJ1J1bnMgc28gZmFyOiB7MH0nIC1mICgkU2NyaXB0OkNvdW50UnVucykpCgppZiAoJFNjcmlwdDpCb29sRGlkQW55dGhpbmdDaGFuZ2VUaGlzUnVudGltZSkgewogICAgV3JpdGUtU3RhdHMgCn0KCgoKIyMjIEdpdmUgdXAgYWZ0ZXIgWCBydW5zIGFuZCBJc0ZpbmlzaGVkMXN0VGltZSAtZXEgJGZhbHNlCmlmICgkU2NyaXB0OkNvdW50UnVucyAtZXEgMzAgLWFuZCAoLW5vdCgkU2NyaXB0OklzRmluaXNoZWQxc3RUaW1lKSkpIHsKICAgIExvZ1dyaXRlICgnU2hvdWxkIGhhdmUgYmVlbiBkb25lIGJ5IG5vdy4nKQogICAgRWRpdC1TY2hlZHVsZWRUYXNrIC1UYXNrTmFtZSAkU2NyaXB0OlNjaGVkdWxlZFRhc2tOYW1lCgogICAgaWYgKCRmYWxzZSkgewogICAgICAgICMjIyBHYXRoZXJpbmcgaW5mbyBmb3IgdGhlIGVtYWlsCiAgICAgICAgaWYgKC1ub3QoJFNjcmlwdDpXaW5kb3dzVmVyc2lvbikpIHsKICAgICAgICAgICAgQ3JlYXRlLUVudlZhcmlhYmxlcwogICAgICAgIH0KICAgICAgICAjIyMgQnVpbGRpbmcgZW1haWwgc3RyaW5nCiAgICAgICAgW3N0cmluZ10gJExvY2FsOlN0clN1YmplY3QgPSAoJ0JpdExvY2tlclRyaWdnZXIgZmFpbGVkIHswfSB0aW1lcyBmb3IgdGVuYW50ICJ7MX0iLCBkZXZpY2U6ICJ7Mn0iJyAtZiAoJENvdW50UnVucy5Ub1N0cmluZygpLCRMb2NhbDpOYW1lVGVuYW50LCRMb2NhbDpOYW1lQ29tcHV0ZXIpKQogICAgICAgIFtzdHJpbmddICRMb2NhbDpTdHJFbWFpbCA9IFtzdHJpbmddOjpFbXB0eQogICAgICAgICRMb2NhbDpTdHJFbWFpbCArPSAoJExvY2FsOlN0clN1YmplY3QpCiAgICAgICAgJExvY2FsOlN0ckVtYWlsICs9ICgiYHJgbiIpCiAgICAgICAgJExvY2FsOlN0ckVtYWlsICs9ICgiYHJgbiIgKyAnIyMgRW52aXJvbm1lbnQgaW5mbycpCiAgICAgICAgJExvY2FsOlN0ckVtYWlsICs9ICgiYHJgbiIgKyAnRGV2aWNlIG5hbWU6ICcgKyAkU2NyaXB0OkNvbXB1dGVyTmFtZSArICcgfCBNYW51ZmFjdHVyZXI6ICcgKyAkU2NyaXB0OkNvbXB1dGVyTWFudWZhY3R1cmVyICsgJyB8IE1vZGVsOiAnICsgJFNjcmlwdDpDb21wdXRlclByb2R1Y3ROYW1lKSAKICAgICAgICAkTG9jYWw6U3RyRW1haWwgKz0gKCJgcmBuIiArICdXaW5kb3dzIEVkaXRpb246ICcgKyAkU2NyaXB0OldpbmRvd3NFZGl0aW9uICsgJyB8IFdpbmRvd3MgVmVyc2lvbicgKyAkU2NyaXB0OldpbmRvd3NWZXJzaW9uKQogICAgICAgICRMb2NhbDpTdHJFbWFpbCArPSAoImByYG5gcmBuIiArICdUaGVyZSBoYXZlIG5vdyBiZWVuIHswfSBydW5zLCBidXQgQml0TG9ja2VyVHJpZ2dlciBTVElMTCBmYWlscy4nIC1mICgkU2NyaXB0OkNvdW50UnVucykpCiAgICAgICAgJExvY2FsOlN0ckVtYWlsICs9ICgiYHJgbiIgKyAnU3VjY2VzcyBzdGF0dXMgfCBFbmNyeXB0ZWQgOiB7MH0gfCBQcm90ZWN0aW9uIFBhc3N3b3JkcyBwcmVzZW50IDogezF9IHwgQmFja3VwIHRvIEF6dXJlQUQgOiB7Mn0gfCBCYWNrdXAgdG8gT25lRHJpdmUgOiB7M30nIC1mICgkU2NyaXB0OklzRW5jcnlwdGVkLCRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3csJFNjcmlwdDpJc0JhY2t1cEFBRCwkU2NyaXB0OklzQmFja3VwT0QpKQogICAgICAgIExvZ1dyaXRlICgkTG9jYWw6U3RyRW1haWwpCiAgICAgICAgPCMjIyBTZW5kIGVtYWlsCiAgICAgICAgIyMgTWFpbCBhZGRyZXNzKGVzKQogICAgICAgIFtzdHJpbmddICRMb2NhbDpTdHJUb0VtYWlsQWRkcmVzcyA9ICdPbGF2IFIuIEJpcmtlbGFuZCA8b2xhdmJAaXJvbnN0b2VpdC5jb20+OycKICAgICAgICAjJFN0ckVtYWlsQWRkcmVzcyArPSAnSXJvbnN0b25lIFNlcnZpY2VkZXNrIDxzZXJ2aWNlZGVrc0Bpcm9uc3RvbmVpdC5jb20+JwogICAgICAgIFtzdHJpbmddICRMb2NhbDpTdHJGcm9tRW1haWxBZGRyZXNzID0gKCdCaXRMb2NrZXJUcmlnZ2VyRmFpbEB7MH0nIC1mICgkU2NyaXB0Ok5hbWVUZW5hbnQpKQogICAgICAgICNTZW5kLU1haWxNZXNzYWdlIC1UbyAkTG9jYWw6U3RyVG9FbWFpbEFkZHJlc3MgLVNtdHBTZXJ2ZXIgIC1Gcm9tICRMb2NhbDpTdHJGcm9tRW1haWxBZGRyZXNzIC1TdWJqZWN0ICRMb2NhbDpTdHJTdWJqZWN0IC1Cb2R5ICRMb2NhbDpTdHJFbWFpbAogICAgICAgICM+CiAgICB9Cn0KCgoKCgojIyMjIyMjIyMjIyMjIyMjIyMjIwojIyMjICBEIE8gTiBFICAjIyMjIwojIyMjIyMjIyMjIyMjIyMjIyMjIwpMb2dXcml0ZSAoJ0FsbCBkb25lLCBleGl0aW5nIHNjcmlwdC4uLicpCiNlbmRyZWdpb24gTWFpbg==')
#endregion FilePS1

# Enable-BitLockerTrigger.VBS
#region FileVBS
[string] $Script:NameVBS = 'Enable_BitLocker.vbs'
[string] $Script:FileVBS = ('U2V0IG9ialNoZWxsID0gQ3JlYXRlT2JqZWN0KCJXc2NyaXB0LlNoZWxsIikgIA0KU2V0IGFyZ3MgPSBXc2NyaXB0LkFyZ3VtZW50cyAgDQpGb3IgRWFjaCBhcmcgSW4gYXJncyAgDQogICAgRGltIFBTUnVuDQogICAgUFNSdW4gPSAicG93ZXJzaGVsbC5leGUgLVdpbmRvd1N0eWxlIGhpZGRlbiAtRXhlY3V0aW9uUG9saWN5IGJ5cGFzcyAtTm9uSW50ZXJhY3RpdmUgLUZpbGUgIiIiICYgYXJnICYgIiIiIg0KICAgIG9ialNoZWxsLlJ1bihQU1J1biksMA0KTmV4dA==')
#endregion FileVBS
    
# Enable-BitLockerTrigger.XML
#region FileXML
[string] $Script:NameXML = 'Enable_BitLocker.xml'
[string] $Script:FileXML = ('PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTE2Ij8+CjxUYXNrIHZlcnNpb249IjEuNCIgeG1sbnM9Imh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd2luZG93cy8yMDA0LzAyL21pdC90YXNrIj4KICA8UmVnaXN0cmF0aW9uSW5mbz4KICAgIDxEYXRlPjIwMTgtMDEtMDFUMTQ6MDA6MDA8L0RhdGU+CiAgICA8QXV0aG9yPklyb25zdG9uZTwvQXV0aG9yPgogICAgPFVSST5cSXJvblRyaWdnZXI8L1VSST4KICA8L1JlZ2lzdHJhdGlvbkluZm8+CiAgPFRyaWdnZXJzPgogICAgPFRpbWVUcmlnZ2VyPgogICAgICA8UmVwZXRpdGlvbj4KICAgICAgICA8SW50ZXJ2YWw+UFQxNU08L0ludGVydmFsPgogICAgICAgIDxTdG9wQXREdXJhdGlvbkVuZD5mYWxzZTwvU3RvcEF0RHVyYXRpb25FbmQ+CiAgICAgIDwvUmVwZXRpdGlvbj4KICAgICAgPFN0YXJ0Qm91bmRhcnk+MjAxOC0wMS0wMVQwMDowMDowMDwvU3RhcnRCb3VuZGFyeT4KICAgICAgPEVuYWJsZWQ+dHJ1ZTwvRW5hYmxlZD4KICAgIDwvVGltZVRyaWdnZXI+CiAgPC9UcmlnZ2Vycz4KICA8UHJpbmNpcGFscz4KICAgIDxQcmluY2lwYWwgaWQ9IkF1dGhvciI+CiAgICAgIDxHcm91cElkPlMtMS01LTMyLTU0NTwvR3JvdXBJZD4KICAgICAgPFJ1bkxldmVsPkhpZ2hlc3RBdmFpbGFibGU8L1J1bkxldmVsPgogICAgPC9QcmluY2lwYWw+CiAgPC9QcmluY2lwYWxzPgogIDxTZXR0aW5ncz4KICAgIDxNdWx0aXBsZUluc3RhbmNlc1BvbGljeT5JZ25vcmVOZXc8L011bHRpcGxlSW5zdGFuY2VzUG9saWN5PgogICAgPERpc2FsbG93U3RhcnRJZk9uQmF0dGVyaWVzPmZhbHNlPC9EaXNhbGxvd1N0YXJ0SWZPbkJhdHRlcmllcz4KICAgIDxTdG9wSWZHb2luZ09uQmF0dGVyaWVzPmZhbHNlPC9TdG9wSWZHb2luZ09uQmF0dGVyaWVzPgogICAgPEFsbG93SGFyZFRlcm1pbmF0ZT50cnVlPC9BbGxvd0hhcmRUZXJtaW5hdGU+CiAgICA8U3RhcnRXaGVuQXZhaWxhYmxlPnRydWU8L1N0YXJ0V2hlbkF2YWlsYWJsZT4KICAgIDxSdW5Pbmx5SWZOZXR3b3JrQXZhaWxhYmxlPmZhbHNlPC9SdW5Pbmx5SWZOZXR3b3JrQXZhaWxhYmxlPgogICAgPElkbGVTZXR0aW5ncz4KICAgICAgPFN0b3BPbklkbGVFbmQ+dHJ1ZTwvU3RvcE9uSWRsZUVuZD4KICAgICAgPFJlc3RhcnRPbklkbGU+ZmFsc2U8L1Jlc3RhcnRPbklkbGU+CiAgICA8L0lkbGVTZXR0aW5ncz4KICAgIDxBbGxvd1N0YXJ0T25EZW1hbmQ+dHJ1ZTwvQWxsb3dTdGFydE9uRGVtYW5kPgogICAgPEVuYWJsZWQ+dHJ1ZTwvRW5hYmxlZD4KICAgIDxIaWRkZW4+ZmFsc2U8L0hpZGRlbj4KICAgIDxSdW5Pbmx5SWZJZGxlPmZhbHNlPC9SdW5Pbmx5SWZJZGxlPgogICAgPERpc2FsbG93U3RhcnRPblJlbW90ZUFwcFNlc3Npb24+ZmFsc2U8L0Rpc2FsbG93U3RhcnRPblJlbW90ZUFwcFNlc3Npb24+CiAgICA8VXNlVW5pZmllZFNjaGVkdWxpbmdFbmdpbmU+dHJ1ZTwvVXNlVW5pZmllZFNjaGVkdWxpbmdFbmdpbmU+CiAgICA8V2FrZVRvUnVuPmZhbHNlPC9XYWtlVG9SdW4+CiAgICA8RXhlY3V0aW9uVGltZUxpbWl0PlBUMUg8L0V4ZWN1dGlvblRpbWVMaW1pdD4KICAgIDxQcmlvcml0eT43PC9Qcmlvcml0eT4KICA8L1NldHRpbmdzPgogIDxBY3Rpb25zIENvbnRleHQ9IkF1dGhvciI+CiAgICA8RXhlYz4KICAgICAgPENvbW1hbmQ+d3NjcmlwdC5leGU8L0NvbW1hbmQ+CiAgICAgIDxBcmd1bWVudHM+IkM6XFByb2dyYW0gRmlsZXNcSXJvbnN0b25lSVRcSXJvblRyaWdnZXJcRW5hYmxlX0JpdExvY2tlci52YnMiICJDOlxQcm9ncmFtIEZpbGVzXElyb25zdG9uZUlUXElyb25UcmlnZ2VyXEVuYWJsZV9CaXRMb2NrZXIucHMxIjwvQXJndW1lbnRzPgogICAgPC9FeGVjPgogIDwvQWN0aW9ucz4KPC9UYXNrPg==')
#endregion FileXML
#enregion Files
#endregion Variables



#region Functions
     #region Write-DebugIfOn
    Function Write-DebugIfOn {
        param(
            [Parameter(Mandatory=$true, Position=0)]
            [String] $In
        )
        If ($Script:DebugConsole) {
            Write-Output -InputObject $In
        }
        If ($Script:DebugLogFile) {
            $Script:DebugStr += ($In + "`r`n")
        }
    }
    #endregion Write-DebugIfOn


    #region Check-CreateDir
    Function Check-CreateDir {
        Param(
            [Parameter(Mandatory=$true, Position=0)]
            [String] $Dir
        )
        Write-DebugIfOn -In ('Check-CreateDir -Dir ' + $Dir)
        If (!(Test-Path $Dir)) {
                Write-DebugIfOn -In '   Reg dir does not exist, trying to create'
                If(!($Script:ReadOnly)) {
                    $null = New-Item -ItemType Directory -Force -Path $Dir 2>&1
                    If (!($?)) {
                        Write-DebugIfOn -In '      ERROR: Dir could not be created'
                    }
                    Else {
                        Write-DebugIfOn -In '      SUCCESS: Dir was created'
                    }
                }
                Else {Write-DebugIfOn -In '      ReadOnly mode'}
            } 
        Else {
            Write-DebugIfOn -In '   Reg dir does already exist'
        } 
    }
    #endregion Check-CreateDir


    #region FileOut-FromBase64
    Function FileOut-FromBase64 {
        Param(
            [Parameter(Mandatory=$true)]
            [String] $InstallDir, $FileName, $File, $Encoding
        )
        Write-DebugIfOn -In ('FileOut-FromBase64 -FilePath ' + $InstallDir + ' -FileName ' + $FileName + ' -File ' + ($File.Substring(0,10) + '...'))
        $Local:FilePath = $InstallDir + $FileName

        If (Test-Path $InstallDir) {
            Write-DebugIfOn -In ('   Path exists, trying to write the file (File alrady exists? {0})' -f (Test-Path $Local:FilePath))
            If (-not($ReadOnly)) {
                Out-File -FilePath $Local:FilePath -Encoding $Encoding -InputObject ([System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($File)))
                Write-DebugIfOn -In ('      Success? {0}' -f ($?))
                Write-DebugIfOn -In ('         Does file actually exist? {0}' -f (Test-Path $Local:FilePath -ErrorAction SilentlyContinue))
            }
        }
        Else {
            Write-DebugIfOn -In ('   ERROR: Path does not exist')
        }
    }
    #endregion FileOut-FromBase64


    #region Query-Registry
    Function Query-Registry {
        Param ([Parameter(Mandatory=$true)] [String] $Dir)
        $Local:Out = [String]::Empty
        [String] $Local:Key = $Dir.Split('{\}')[-1]
        [String] $Local:Dir = $Dir.Replace($Local:Key,'')
        
        $Local:Exists = Get-ItemProperty -Path ('{0}' -f $Dir) -Name ('{0}' -f $Local:Key) -ErrorAction SilentlyContinue
        If ($Exists) {
            $Local:Out = $Local:Exists.$Local:Key
        }
        return $Local:Out
    }
    #endregion Query-Registry


    #region Get-MachineInfo
    Function Get-MachineInfo {
        $Script:ComputerName = $env:COMPUTERNAME
        [String] $Script:ComputerManufacturer = Query-Registry -Dir 'HKLM:\HARDWARE\DESCRIPTION\System\BIOS\SystemManufacturer'
        If (-not([String]::IsNullOrEmpty($Script:ComputerManufacturer))) {
            [String] $Script:ComputerFamily = Query-Registry -Dir 'HKLM:\HARDWARE\DESCRIPTION\System\BIOS\SystemFamily'
            [String] $Script:ComputerProductName = Query-Registry -Dir 'HKLM:\HARDWARE\DESCRIPTION\System\BIOS\SystemProductName'
            [String] $Script:WindowsEdition = Query-Registry -Dir 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProductName'
            [String] $Script:WindowsVersion = Query-Registry -Dir 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\ReleaseId'
            [String] $Script:WindowsVersion += (' ({0})' -f (Query-Registry -Dir 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\CurrentBuild'))
        } 
        Else {
            $Local:EnvInfo = Get-WmiObject -Class Win32_ComputerSystem | Select-Object -Property Manufacturer,Model,SystemFamily        
            [String] $Script:ComputerManufacturer = $Local:EnvInfo.Manufacturer
            [String] $Script:ComputerFamily = $Local:EnvInfo.SystemFamily
            [String] $Script:ComputerProductName = $Local:EnvInfo.Model
            $Local:OSInfo = Get-WmiObject -Class win32_operatingsystem | Select-Object -Property Caption,Version
            [String] $Script:WindowsEdition = $Local:OSInfo.Caption
            [String] $Script:WindowsVersion = $Local:OSInfo.Version
        }
    }
    #endregion Get-MachineInfo
#enregion Functions



#region Initialize
Get-MachineInfo
If ($Script:DebugLogFile -or $Script:DebugConsole) {
    Write-DebugIfOn -In '### Environment Info'
    Write-DebugIfOn -In ('Script settings: DebugConsole = "{0}", DebugWinTemp = "{1}", ReadOnly = "{2}"' -f ($Script:DebugConsole,$Script:DebugLogFile,$Script:ReadOnly))
    Write-DebugIfOn -In ('Machine info: Name = "{0}", Manufacturer = "{1}", Family = "{2}", Model = "{3}"' -f ($Script:ComputerName,$Script:ComputerManufacturer,$Script:ComputerFamily,$Script:ComputerProductName))
    Write-DebugIfOn -In ('Windows info: Edition = "{0}", Version = "{1}"' -f ($Script:WindowsEdition,$Script:WindowsVersion))
}
#endregion Initialize



#region Main
    Write-DebugIfOn -In ("`r`n`r`n" + '### ' + $Script:NameScript)



    ###########################################################
    ### 1. Clean up BitLockerTrigger and IronTrigger
    Write-DebugIfOn -In ("`r`n`r`n" + '# 1. Clean up previous install paths')
    # Paths
    Write-DebugIfOn -In ('Remove previous install path(s) if present')
    [String[]] $Local:RemPaths = @(
                                    ($Script:DirInstall),
                                    ('{0}\Program Files\IronstoneIT\Device_Install-IronTrigger\' -f $env:SystemDrive),
                                    (${env:ProgramFiles(x86)} + '\BitLockerTrigger\'),
                                    (${env:ProgramFiles(x86)} + '\IronTrigger\')
                                 )
    $Local:RemPaths | ForEach-Object {
        Write-DebugIfOn -In ('   Removing "{0}" if it exists.' -f ($_))
        If (Test-Path -Path "$_") {
            Remove-Item -Path "$_" -Force -Recurse
            Write-DebugIfOn -In ('      Directory does exist. Removing. Success? {0}' -f ($?))
        }
        Else {
            Write-DebugIfOn -In ('      Directory does not exist')
        }
    }
    # Stats and Logs
    Write-DebugIfOn -In ('Remove previous files: Stats and Logs')
    [String[]] $Local:RemItems = @(
                                    ($env:windir + '\Temp\BitLockerTrigger.log'),
                                    ($env:windir + '\Temp\IronTrigger.log')
                                 )
    $Local:RemItems | ForEach-Object { 
        Write-DebugIfOn -In ('   Removing "{0}" if it exists.' -f ($_))
        If (Test-Path -Path "$_") {
            Remove-Item -Path "$_" -Force
            Write-DebugIfOn -In ('      File does exist. Removing. Success? {0}' -f ($?))
        }
        Else {
            Write-DebugIfOn -In ('      File does not exist')
        }     
    }
    # Scheduled tasks
    Write-DebugIfOn -In ('Remove previous ScheduledTask(s)')
    $Local:ScheduledTasks = Get-ScheduledTask | Where-Object {$_.TaskName -like $Script:ScheduledTaskName -or $_.TaskName -like '*Trigger'}
    If ($Local:ScheduledTasks.length -gt 0) {
        $Local:Tasks | ForEach-Object {             
            $null = Unregister-ScheduledTask -TaskName $_.TaskName -Confirm:$false -ErrorAction SilentlyContinue
            Write-DebugIfOn -In ('  Removing the Scheduled task "{0}". Success? {1}' -f ($_.TaskName,$?))
        }
    }
    Else {
        If (Get-ScheduledTask -TaskName $Script:ScheduledTaskName -ErrorAction SilentlyContinue) {            
            $null = Unregister-ScheduledTask -TaskName $Script:ScheduledTaskName -Confirm:$false -ErrorAction SilentlyContinue
            Write-DebugIfOn -In ('  Removing the Scheduled task "{0}". Success? {1}' -f ($Script:ScheduledTaskName,$?))
        }
        Else {
            Write-DebugIfOn -In ('  Scheduled task "{0}" does not exist.' -f ($Script:ScheduledTaskName))
        }
    }




    ###########################################################
    ### 2. Create install dir and log dir if not exist
    Write-DebugIfOn -In ("`r`n`r`n" + '# 2. Create install and log dir')
    Check-CreateDir -Dir $Script:DirInstall
    Check-CreateDir -Dir $Script:DirLog
    


    ###########################################################
    ### 3. Import files
    Write-DebugIfOn -In ("`r`n`r`n" + '# 3. Import files to "{0}"' -f ($Script:DirInstall))
    FileOut-FromBase64 -InstallDir $Script:DirInstall -FileName $Script:NamePS1 -File $Script:FilePS1 -Encoding utf8
    FileOut-FromBase64 -InstallDir $Script:DirInstall -FileName $Script:NameVBS -File $Script:FileVBS -Encoding default
    FileOut-FromBase64 -InstallDir $Script:DirInstall -FileName $Script:NameXML -File $Script:FileXML -Encoding utf8



    ###########################################################
    ### 4. Surpress BitLocker Toast Notifications
    Write-DebugIfOn -In ("`r`n`r`n" + '# 4. Surpress BitLocker Toast Notifications')
    # Get current user
    [string] $CurrentUser         = (Get-Process -Name 'explorer' -IncludeUserName).UserName
    [string] $CurrentUserName     = $CurrentUser.Split('\')[-1]
    [string] $CurrentUserRegValue = (New-Object -TypeName System.Security.Principal.NTAccount($CurrentUser)).Translate([System.Security.Principal.SecurityIdentifier]).Value
    [string] $PathDirRegRoot      = ('HKU:\{0}\' -f ($CurrentUserRegValue))
    # Set PS Drive
    If ((Get-PSDrive -Name 'HKU' -ErrorAction SilentlyContinue) -eq $null) {
        New-PSDrive -PSProvider Registry -Name 'HKU' -Root 'HKEY_USERS'
    }
    # Set REG value
    [string] $RegDir = ('{0}\Software\Microsoft\Windows\CurrentVersion\Notifications\Settings\Windows.SystemToast.BitLockerPolicyRefresh' -f ($PathDirRegRoot))
    if (-not(Test-Path -Path $RegDir)) {New-Item -Path $RegDir -ItemType 'Directory' -Force}
    $null = Set-ItemProperty -Path $RegDir -Name 'Enabled' -Value 0 -Type 'DWord' -Force
    Write-DebugIfOn -In ('   Success? {0}' -f ($?))



    ###########################################################
    ### 5. Create ScheduledTask from XML
    Write-DebugIfOn -In ("`r`n`r`n" + '# 5. Create Scheduled Task "{0}"' -f ($Script:ScheduledTaskName))
    Write-DebugIfOn -In ('Register-ScheduledTask -Xml (Get-Content "{0}" | Out-String) -TaskName "{1}" -Force' -f (($Script:DirInstall + $Script:NameXML),$Script:ScheduledTaskName))
    $null = Register-ScheduledTask -Xml (Get-Content ($Script:DirInstall + $Local:NameXML) | Out-String) -TaskName $Script:ScheduledTaskName -Force
    Write-DebugIfOn -In ('   Success? {0}' -f ($?))



    ###########################################################
    ### 6. Run ScheduledTask
    Write-DebugIfOn -In ("`r`n`r`n" + '# 6. Start Scheduled Task "{0}"' -f ($Script:ScheduledTaskName))
    $null = Start-ScheduledTask -TaskName $Script:ScheduledTaskName
    Write-DebugIfOn -In ('   Success? {0}' -f ($?))



    Write-DebugIfOn -In ("`r`n`r`n" + 'Done.')    
#endregion Main



#region Debug
If ($Script:DebugLogFile) {
    If ([String]::IsNullOrEmpty($Script:DebugStr)) {
        $Script:DebugStr = 'Everything failed'
    }

    ### Write Output
    # Get variables    
    $Local:CurTime = Get-Date -Uformat '%y%m%d%H%M%S'
    

    # Create log file name
    $Local:DebugFileName = ('{0}_{1}.txt' -f ($Script:NameScript,$Local:CurTime))
    

    # Check if log destination exists, or else: Create it
    If (-not(Test-Path -Path $Script:DirLog)) {
        $null = New-Item -Path $Script:DirLog -Force -ItemType Directory
    }
    
    
    # Out-File the Log
    $Script:DebugStr | Out-File -FilePath ($Script:DirLog + $Local:DebugFileName) -Encoding 'utf8'
}
#endregion Debug