<#

.SYNOPSIS


.DESCRIPTION


.NOTES
    * In Intune, remember to set "Run this script using the logged in credentials"  according to the $DeviceContext variable.
        * Intune -> Device Configuration -> PowerShell Scripts -> $NameScriptFull -> Properties -> "Run this script using the logged in credentials"
        * DEVICE (Local System) or USER (Logged in user).
    * Only edit $NameScript and add your code in the #region Your Code Here.
    * You might want to touch "Settings - PowerShell - Output Preferences" for testing / development. 
        * $VerbosePreference, eventually $DebugPreference, to 'Continue' will print much more details.

#>


# Script Variables
[bool]   $DeviceContext = $true
[string] $NameScript    = 'Install-IronTrigger'

# Settings - PowerShell - Output Preferences
$DebugPreference       = 'SilentlyContinue'
$InformationPreference = 'SilentlyContinue'
$VerbosePreference     = 'SilentlyContinue'
$WarningPreference     = 'Continue'



#region    Don't Touch This
# Settings - PowerShell - Interaction
$ConfirmPreference     = 'None'
$ProgressPreference    = 'SilentlyContinue'

# Settings - PowerShell - Behaviour
$ErrorActionPreference = 'Continue'

# Dynamic Variables - Process & Environment
[string] $NameScriptFull      = ('{0}_{1}' -f ($(if($DeviceContext){'Device'}Else{'User'}),$NameScript))
[string] $NameScriptVerb      = $NameScript.Split('-')[0]
[string] $NameScriptNoun      = $NameScript.Split('-')[-1]
[string] $ProcessArchitecture = $(if([System.Environment]::Is64BitProcess){'64'}Else{'32'})
[string] $OSArchitecture      = $(if([System.Environment]::Is64BitOperatingSystem){'64'}Else{'32'})

# Dynamic Variables - User
[string] $StrIsAdmin       = ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
[string] $StrUserName      = [System.Security.Principal.WindowsIdentity]::GetCurrent().Name
[string] $SidCurrentUser   = [System.Security.Principal.WindowsIdentity]::GetCurrent().User.Value
[string] $SidSystemUser    = 'S-1-5-18'
[bool] $CurrentUserCorrect = $(
    if($DeviceContext -and $SIDCurrentUser -eq $SIDSystemUser){$true}
    elseif (-not($DeviceContext) -and $SIDCurrentUser -ne $SIDSystemUser){$true}
    else {$false}
)

# Dynamic Logging Variables
$Timestamp    = [DateTime]::Now.ToString('yyMMdd-HHmmssffff')
$PathDirLog   = ('{0}\IronstoneIT\Intune\DeviceConfiguration\' -f ($(if($DeviceContext -and $CurrentUserCorrect){$env:ProgramW6432}else{$env:APPDATA})))
$PathFileLog  = ('{0}{1}-{2}bit-{3}.txt' -f ($PathDirLog,$NameScriptFull,$ProcessArchitecture,$Timestamp))

# Start Transcript
if (-not(Test-Path -Path $PathDirLog)) {New-Item -ItemType 'Directory' -Path $PathDirLog -ErrorAction 'Stop'}
Start-Transcript -Path $PathFileLog

# Output User Info, Exit if not $CurrentUserCorrect
Write-Output -InputObject ('Running as user "{0}". Has admin privileges? {1}. $DeviceContext = {2}. Running as correct user? {3}.' -f ($StrUserName,$StrIsAdmin,$DeviceContext.ToString(),$CurrentUserCorrect.ToString()))
if (-not($CurrentUserCorrect)){Throw 'Not running as correct user!'} 

# Output Process and OS Architecture Info
Write-Output -InputObject ('PowerShell is running as a {0} bit process on a {1} bit OS.' -f ($ProcessArchitecture,$OSArchitecture))


# Wrap in Try/Catch, so we can always end the transcript
Try {    
    # If OS is 64 bit, and PowerShell got launched as x86, relaunch as x64
    if ( (-not([System.Environment]::Is64BitProcess))  -and [System.Environment]::Is64BitOperatingSystem) {
        write-Output -InputObject (' * Will restart this PowerShell session as x64.')
        if ($myInvocation.Line) {
            &"$env:WINDIR\sysnative\windowspowershell\v1.0\powershell.exe" -NonInteractive -NoProfile $myInvocation.Line
        }
        else {
            &"$env:WINDIR\sysnative\windowspowershell\v1.0\powershell.exe" -NonInteractive -NoProfile -File ('{0}' -f ($myInvocation.InvocationName)) $args
        }
        exit $lastexitcode
    }
    
    # End the Initialize Region
    Write-Output -InputObject ('**********************')
#endregion Don't Touch This
################################################
#region    Your Code Here
################################################


#region    Variables
    # Settings
    [bool]   $Script:ReadOnly           = $false

    # Script specific variables
    [string] $Script:NameApp            = $NameScriptNoun
    [string] $Script:NameScheduledTask  = $NameScriptNoun
    [string] $Script:PathDirInstall     = ('{0}\IronstoneIT\{1}' -f ($env:ProgramW6432,$Script:NameApp))

    # Files
    #region Files
        # Enable-BitLockerTrigger.PS1
        #region FilePS1
        [string] $Script:NameFilePS1    = 'Enable_BitLocker.ps1'
        [string] $Script:ContentFilePS1 = ('PCNQU1NjcmlwdEluZm8gCi5WRVJTSU9OIDEuNwouR1VJRCBmNTE4N2UzZi1lZDBhLTRjZTEtYjQzOC1kOGY0MjE2MTljYTMgCi5PUklHSU5BTCBBVVRIT1IgSmFuIFZhbiBNZWlydmVubmUgCi5NT0RJRklFRCBCWSBPbGF2IFIuIEJpcmtlbGFuZCwgU29vcmFqIFJhamFnb3BhbGFuLCBQYXVsIEh1aWpicmVndHMsIFBpZXRlciBXaWdsZXZlbiAmIE5pYWxsIEJyYWR5ICh3aW5kb3dzLW5vb2IuY29tIDIwMTcvOC8xNykKLkNPUFlSSUdIVCAKLlRBR1MgQXp1cmUgSW50dW5lIEJpdExvY2tlciAgCi5MSUNFTlNFVVJJICAKLlBST0pFQ1RVUkkgIAouSUNPTlVSSSAgCi5FWFRFUk5BTE1PRFVMRURFUEVOREVOQ0lFUyAgCi5SRVFVSVJFRFNDUklQVFMgIAouRVhURVJOQUxTQ1JJUFRERVBFTkRFTkNJRVMgIAouUkVMRUFTRU5PVEVTCi5UT0RPIAojPgoKPCMgCiAKLkRFU0NSSVBUSU9OIAogQ2hlY2sgd2hldGhlciBCaXRMb2NrZXIgaXMgRW5hYmxlZCwgaWYgbm90IEVuYWJsZSBCaXRMb2NrZXIgb24gQUFEIEpvaW5lZCBkZXZpY2VzIGFuZCBzdG9yZSByZWNvdmVyeSBpbmZvIGluIEFBRCAKIEFkZGVkIGxvZ2dpbmcKIz4gCgpbY21kbGV0YmluZGluZygpXQpwYXJhbSgKICAgIFtQYXJhbWV0ZXIoKV0KICAgIFtWYWxpZGF0ZU5vdE51bGxPckVtcHR5KCldCiAgICBbc3RyaW5nXSAkT1NEcml2ZSA9ICRlbnY6U3lzdGVtRHJpdmUKKQpbTmV0LlNlcnZpY2VQb2ludE1hbmFnZXJdOjpTZWN1cml0eVByb3RvY29sID0gW05ldC5TZWN1cml0eVByb3RvY29sVHlwZV06OlRsczEyCgoKCiNyZWdpb24gU2V0dGluZ3MgYW5kIFZhcmlhYmxlcwojIyMgU2V0dGluZ3MKICAgICMgSWYgb24sIHdpbGwgcHJvbXB0IHVzZXIgdG8gcmVib290IHdpdGggV2luZG93cyBGb3JtcyBHVUkuCiAgICBbYm9vbF0gJEdVSSA9ICRmYWxzZQogICAgIyBJZiBvbiwgd2lsbCByZW1vdmUgYWxsIGZpbGVzIGFmdGVyIGZpcnN0IHN1Y2Nlc3MuCiAgICBbYm9vbF0gJFNjcmlwdDpCb29sUmVtb3ZlRmlsZXNBZnRlclN1Y2Nlc3MgPSAkZmFsc2UKICAgICMgSWYgb2ZmLCB3aWxsIGNoYW5nZSBzY2hlZHVsZWQgdGFzayB0byBydW4gb25jZSBhIGRheSBhdCAxMjowMCBhZnRlciBmaXJzdCBzdWNjZXNzZnVsbCBydW4sIG9yIGFmdGVyIDMwIGZhaWxlZCBydW5zCiAgICAjIElmIG9uLCB3aWxsIGRlbGV0ZSBzY2hlZHVsZWQgdGFzayBhZnRlciBmaXJzdCBzdWNjZXNzZnVsbCBydW4gYW5kIGFmdGVyIDMwIGZhaWxlZCBydW5zCiAgICBbYm9vbF0gJFNjcmlwdDpCb29sUmVtb3ZlU2NoZWR1bGVkVGFza0FmdGVyRmlyc3RTdWNjZXNzID0gJGZhbHNlCiMjIyBWYXJpYWJsZXMKICAgIFtzdHJpbmddICRTY3JpcHQ6TmFtZVNjcmlwdCAgICAgICAgID0gJ0lyb25UcmlnZ2VyJwogICAgW3N0cmluZ10gJFNjcmlwdDpTY2hlZHVsZWRUYXNrTmFtZSA9ICRTY3JpcHQ6TmFtZVNjcmlwdC5DbG9uZSgpCiAgICBbc3RyaW5nXSAkU2NyaXB0OkRpckluc3RhbGwgICAgICAgID0gKCd7MH1cUHJvZ3JhbSBGaWxlc1xJcm9uc3RvbmVJVFx7MX1cJyAtZiAoJGVudjpTeXN0ZW1Ecml2ZSwkU2NyaXB0Ok5hbWVTY3JpcHQpKQogICAgW3N0cmluZ10gJFNjcmlwdDpEaXJMb2cgICAgICAgICAgICA9ICgnezB9XFByb2dyYW0gRmlsZXNcSXJvbnN0b25lSVRcSW50dW5lXERldmljZUNvbmZpZ3VyYXRpb25cJyAtZiAoJGVudjpTeXN0ZW1Ecml2ZSkpCiAgICBbc3RyaW5nXSAkU2NyaXB0OkZpbGVMb2cgICAgICAgICAgID0gKCd7MH1Jcm9uVHJpZ2dlciAtIEVuYWJsZUJpdExvY2tlci5sb2cnIC1mICgkU2NyaXB0OkRpckxvZykpCiAgICBbc3RyaW5nXSAkU2NyaXB0OkZpbGVTdGF0cyAgICAgICAgID0gKCd7MH1zdGF0cy50eHQnIC1mICgkU2NyaXB0OkRpckluc3RhbGwpKQojIEhlbHAgVmFyaWFibGVzIChET04nVCBDSEFOR0UpCiAgICBbc3RyaW5nXSAkU2NyaXB0OkNvbXB1dGVyTmFtZSAgICAgID0gJGVudjpDT01QVVRFUk5BTUUKICAgIFtib29sXSAgICRTY3JpcHQ6Qm9vbERpZEFueXRoaW5nQ2hhbmdlVGhpc1J1bnRpbWUgPSAkZmFsc2UKICAgIFtTdHJpbmdbXV0gJFNjcmlwdDpCaXRMb2NrZXJWb2x1bWVFbmNyeXB0aW9uU3RhdHVzZXMgPSBAKCdGdWxseURlY3J5cHRlZCcsJ0VuY3J5cHRpb25JblByb2dyZXNzJywnRnVsbHlFbmNyeXB0ZWQnKQojZW5kcmVnaW9uIFNldHRpbmdzIGFuZCBWYXJpYWJsZXMKCgoKI3JlZ2lvbiBGdW5jdGlvbnMKICAgICNyZWdpb24gTG9nZ2luZyBhbmQgT3V0cHV0CiAgICAgICAgI3JlZ2lvbiBMb2dXcml0ZQogICAgICAgIEZ1bmN0aW9uIExvZ1dyaXRlIHsKICAgICAgICAgICAgUGFyYW0gKFtzdHJpbmddJExvZ1N0cmluZykKICAgICAgICAgICAgW3N0cmluZ10gJGEgPSBHZXQtRGF0ZQogICAgICAgICAgICBbc3RyaW5nXSAkTG9nU3RyaW5nID0gJGEsICRMb2dTdHJpbmcKICAgICAgICAgICAgQWRkLWNvbnRlbnQgLVBhdGggJFNjcmlwdDpGaWxlTG9nIC1WYWx1ZSAkTG9nU3RyaW5nCiAgICAgICAgICAgIFdyaXRlLUhvc3QgJExvZ1N0cmluZwogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIExvZ1dyaXRlCgogICAgICAgICNyZWdpb24gTG9nRXJyb3JzCiAgICAgICAgRnVuY3Rpb24gTG9nRXJyb3JzIHsKICAgICAgICAgICAgTG9nV3JpdGUgKCdDYXVnaHQgYW4gZXhjZXB0aW9uOicpCiAgICAgICAgICAgIExvZ1dyaXRlICgnRXhjZXB0aW9uIFR5cGU6ICcgKyAkKCRfLkV4Y2VwdGlvbi5HZXRUeXBlKCkuRnVsbE5hbWUpKQogICAgICAgICAgICBMb2dXcml0ZSAoJ0V4Y2VwdGlvbiBNZXNzYWdlOiAnICsgJCgkXy5FeGNlcHRpb24uTWVzc2FnZSkpCiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gTG9nRXJyb3JzCgoKICAgICAgICAjcmVnaW9uIFdyaXRlLVN0YXRzCiAgICAgICAgIyBXcml0ZS1TdGF0czogT3V0cHV0cyBjdXJyZW50IHN0YXR1cyBvZiB2YXJpb3VzIGJvb2xlYW5zIGFuZCBvdGhlciBtZWFzdXJlbWVudHMKICAgICAgICBGdW5jdGlvbiBXcml0ZS1TdGF0cyB7ICAgIAogICAgICAgICAgICBQYXJhbSgKICAgICAgICAgICAgICAgIFtwYXJhbWV0ZXIoTWFuZGF0b3J5PSRmYWxzZSldCiAgICAgICAgICAgICAgICBbYm9vbF0gJFByZXZpb3VzT25seSA9ICRmYWxzZQogICAgICAgICAgICApCiAgICAgICAgICAgICMgR2VuZXJhbAogICAgICAgICAgICBpZiAoJFByZXZpb3VzT25seSkgewogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdSdW5zOiB7MH0gfCBIYXMgSXJvblRyaWdnZXIgaGFkIGEgc3VjY2Vzc2Z1bGwgcnVuIGFscmVhZHk/IHsxfScgLWYgKCRTY3JpcHQ6Q291bnRSdW5zLCRTY3JpcHQ6SXNGaW5pc2hlZDFzdFRpbWUpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAjIE9TIERyaXZlCiAgICAgICAgICAgIExvZ1dyaXRlICgnT1MgZHJpdmUgKHswfSkgfCBFbmNyeXB0ZWQ6IHsxfSB8IFJlY292ZXJ5IFBhc3N3b3JkcyBwcmVzZW50OiB7Mn0gfCBCYWNrdXAgdG8gT25lRHJpdmU6IHszfSB8IEJhY2t1cCB0byBBenVyZUFEOiB7NH0nIC1mICgkT1NEcml2ZSwkU2NyaXB0OklzRW5jcnlwdGVkLCRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3csJFNjcmlwdDpJc0JhY2t1cE9ELCRTY3JpcHQ6SXNCYWNrdXBBQUQpKQogICAgICAgICAgICBpZiAoLW5vdCgkUHJldmlvdXNPbmx5KSkgewogICAgICAgICAgICAgICAgTG9nd3JpdGUgKCdPUyBkcml2ZSAoezB9KSB8IFZvbHVtZVN0YXR1czogezF9IHwgUHJvdGVjdGlvblN0YXR1czogezJ9JyAtZiAoJE9TRHJpdmUsJFNjcmlwdDpWb2x1bWVFbmNTdGF0dXMsJFNjcmlwdDpWb2x1bWVQcm90ZWN0aW9uU3RhdHVzKSkgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICgkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXKSB7CiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdPUyBkcml2ZSAoezB9KSB8IFByZXNlbmNlIG9mIEJpdExvY2tlciBLZXlQcm90ZWN0b3IgfCBUUE06IHsxfSB8IFJlY292ZXJ5UGFzc3dvcmQ6IHsyfScgLWYgKCRPU0RyaXZlLCRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMF0sJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1sxXSkpCiAgICAgICAgICAgICAgICAgICAgaWYgKCRTY3JpcHQ6Vm9sdW1lRW5jU3RhdHVzWzFdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnT1MgZHJpdmUgKHswfSkgfCB7MX0nIC1mICgkT1NEcml2ZSwoV3JpdGUtUmVjb3ZlcnlQYXNzd29yZCkpKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE90aGVyIGZpeGVkIGRyaXZlcyB3aXRoIGEgZHJpdmUgbGV0dGVyCiAgICAgICAgICAgICAgICA8IyAjVE9ETwogICAgICAgICAgICAgICAgaWYgKCRTY3JpcHQ6T3RoZXJFbmNyeXB0ZWREcml2ZXMpIHsKICAgICAgICAgICAgICAgICAgICAkU2NyaXB0Ok90aGVyRW5jcnlwdGVkRHJpdmVzIHwgRm9yRWFjaC1PYmplY3QgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoLW5vdChbc3RyaW5nXTo6SXNOdWxsT3JFbXB0eSgkU2NyaXB0Ok90aGVyRW5jcnlwdGVkRHJpdmVzWzBdKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtzdHJpbmddICRMb2NhbDpEcml2ZVZvbHVtZVN0YXR1cyA9IChHZXQtVmFyaWFibGUgLU5hbWUgKCdWb2x1bWV7MH1FbmNTdGF0dXMnIC1mICRfKSAtU2NvcGUgJ1NjcmlwdCcpLlZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6RHJpdmVQcm90ZWN0aW9uU3RhdHVzID0gKEdldC1WYXJpYWJsZSAtTmFtZSAoJ1ZvbHVtZXswfVByb3RlY3Rpb25TdGF0dXMnIC1mICRfKSAtU2NvcGUgJ1NjcmlwdCcpLlZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMb2d3cml0ZSAoJ1N0YXR1cyBkcml2ZSAiezB9IiB8IFZvbHVtZVN0YXR1czogezF9IHwgUHJvdGVjdGlvblN0YXR1czogezJ9JyAtZiAoJF8sJExvY2FsOkRyaXZlVm9sdW1lU3RhdHVzLCRMb2NhbDpEcml2ZVByb3RlY3Rpb25TdGF0dXMpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgW2Jvb2xbXV0gJExvY2FsOktleVByb3RlY3RvclR5cGVzID0gR2V0LUJpdExvY2tlcktleVByb3RlY3RvclR5cGVzIC1Ecml2ZUxldHRlciAkXwogICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdCaXRMb2NrZXIgS2V5UHJvdGVjdG9yIFR5cGVzIHByZXNlbnQgZm9yIGRyaXZlICJ7MH0iPyB8IFRQTTogezF9IHwgUmVjb3ZlcnlQYXNzd29yZDogezJ9JyAtZiAoJF8sJExvY2FsOktleVByb3RlY3RvclR5cGVzWzBdLCRMb2NhbDpLZXlQcm90ZWN0b3JUeXBlc1sxXSkpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9Iz4KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIFdyaXRlLVN0YXRzCgoKICAgICAgICAjcmVnaW9uIFdyaXRlLVJlY292ZXJ5UGFzc3dvcmQKICAgICAgICAjIFdyaXRlLVJlY292ZXJ5UGFzc3dvcmQKICAgICAgICBGdW5jdGlvbiBXcml0ZS1SZWNvdmVyeVBhc3N3b3JkIHsKICAgICAgICAgICAgW2J5dGVdICRMb2NhbDpDID0gJChJZigkU2NyaXB0OkNvdW50UmVjb3ZlcnlQYXNzd29yZHMpeyRTY3JpcHQ6Q291bnRSZWNvdmVyeVBhc3N3b3Jkc31FbHNlezB9KQogICAgICAgICAgICBSZXR1cm4gKFtzdHJpbmddICgnezB9IFJlY292ZXJ5IFBhc3N3b3JkKHMpIHByZXNlbnQuezF9JyAtZiAoJExvY2FsOkMsKCQoSWYoJExvY2FsOkMgLWdlIDEpeyd7MH17MX0nIC1mICgiYHJgbiIsKEdldC1TdHJpbmdSZWNvdmVyeVBhc3N3b3JkcykpfSkpKSkpCiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gV3JpdGUtUmVjb3ZlcnlQYXNzd29yZAoKCiAgICAgICAgI3JlZ2lvbiBHZXQtU3RyaW5nUmVjb3ZlcnlQYXNzd29yZHMKICAgICAgICAjIFJldHVybnMgYSBzdHJpbmcgY29udGFpbmluZyB0aGUgcmVjb3ZlcnkgcGFzc3dvcmRzIGZyb20gJFNjcmlwdDpBcnJheVJlY292ZXJ5UGFzc3dvcmRzLiBVc2VmdWxsIGZvciBwcmludGluZy8gbG9nZ2luZy8gYmFja3VwCiAgICAgICAgRnVuY3Rpb24gR2V0LVN0cmluZ1JlY292ZXJ5UGFzc3dvcmRzIHsKICAgICAgICAgICAgUGFyYW0oCiAgICAgICAgICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeT0kZmFsc2UpXQogICAgICAgICAgICAgICAgW3N0cmluZ10gJERyaXZlTGV0dGVyID0gJE9TRHJpdmUKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDcmVhdGUgdmFyaWFibGUgbmFtZXMKICAgICAgICAgICAgW3N0cmluZ10gJExvY2FsOkFyck5hbWUgPSAnQXJyYXlSZWNvdmVyeVBhc3N3b3JkcycKICAgICAgICAgICAgaWYgKCREcml2ZUxldHRlci5TdWJzdHJpbmcoMCwxKSAtbmUgJGVudjpTeXN0ZW1Ecml2ZS5TdWJzdHJpbmcoMCwxKSkgewogICAgICAgICAgICAgICAgJExvY2FsOkFyck5hbWUgPSAoJ3swfXsxfScgLWYgKCREcml2ZUxldHRlci5TdWJzdHJpbmcoMCwxKSwkTG9jYWw6QXJyTmFtZSkpCiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAjIEdldCBBcnJheSwgbG9vcCBpdC4gSWRlYWxseSBvbmx5IG9uZSBwdywgYnV0IGxvb3AganVzdCB0byBiZSBzYWZlLgogICAgICAgICAgICBbdWludDE2XSAkTG9jYWw6VGVtcENvdW50ZXIgPSAwCiAgICAgICAgICAgIFtzdHJpbmddICRMb2NhbDpPdXRTdHIgPSBbc3RyaW5nXTo6RW1wdHkKICAgICAgICAgICAgKEdldC1WYXJpYWJsZSAtTmFtZSAkTG9jYWw6QXJyTmFtZSAtU2NvcGUgJ1NjcmlwdCcpLlZhbHVlIHwgRm9yRWFjaC1PYmplY3QgewogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciArPSAoJ3swfSB8IEtleVByb3RlY3RvcklkICJ7MX0iIHwgUmVjb3ZlcnlQYXNzd29yZCAiezJ9IicgLWYgKCgkTG9jYWw6VGVtcENvdW50ZXIgKz0gMSksJF8uS2V5UHJvdGVjdG9ySWQsJF8uUmVjb3ZlcnlQYXNzd29yZCkpCiAgICAgICAgICAgICAgICBpZiAoJExvY2FsOlRlbXBDb3VudGVyIC1sdCAoKEdldC1WYXJpYWJsZSAtTmFtZSAkTG9jYWw6QXJyTmFtZSAtU2NvcGUgJ1NjcmlwdCcpLlZhbHVlKS5Db3VudCkgeyRMb2NhbDpPdXRTdHIgKz0gImByYG4ifQogICAgICAgICAgICB9CgogICAgICAgICAgICAjIFJldHVybiB0aGUgc3RyaW5nCiAgICAgICAgICAgIFJldHVybiAkTG9jYWw6T3V0U3RyCiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gR2V0LVN0cmluZ1JlY292ZXJ5UGFzc3dvcmRzCiAgICAjZW5kcmVnaW9uIExvZ2dpbmcgYW5kIE91dHB1dAoKCgogICAgI3JlZ2lvbiBSZXR1cm4gVmFsdWVzIChVc2VkIGJ5IG90aGVyIEZ1bmN0aW9ucykKICAgICAgICAjcmVnaW9uIEdldC1CaXRMb2NrZXJLZXlQcm90ZWN0b3JUeXBlcwogICAgICAgICMgUmV0dXJucyBhIGJvb2wgYXJyYXksIHdoZXJlIHRoZSBmaXJzdCByZXByZXNlbnRzIHN0YXR1cyBvZiBUUE0gcHJlc2VuY2UsIGFuZCB0aGUgc2Vjb25kIGZvciBQcm90ZWN0aW9uIFBhc3N3b3JkCiAgICAgICAgRnVuY3Rpb24gR2V0LUJvb2xEcml2ZUhhc0JpdExvY2tlclRQTWFuZFBXIHsKICAgICAgICAgICAgUGFyYW0oCiAgICAgICAgICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeT0kZmFsc2UpXQogICAgICAgICAgICAgICAgW3N0cmluZ10gJERyaXZlTGV0dGVyID0gJE9TRHJpdmUKICAgICAgICAgICAgKQogICAgICAgICAgICAkTG9jYWw6Qml0TG9ja2VyU3RhdHVzID0gR2V0LUJpdExvY2tlclZvbHVtZSAtTW91bnRQb2ludCAkRHJpdmVMZXR0ZXIKICAgICAgICAgICAgW3VpbnQxNl0gJExvY2FsOkNvdW50UmVjUGFzcyA9IDAKICAgICAgICAgICAgW3VpbnQxNl0gJExvY2FsOkNvdW50VFBNID0gMAogICAgICAgICAgICAkTG9jYWw6Qml0TG9ja2VyU3RhdHVzLktleVByb3RlY3RvciB8IEZvckVhY2gtT2JqZWN0IHsKICAgICAgICAgICAgICAgIGlmICgkXy5LZXlQcm90ZWN0b3JUeXBlIC1lcSAnUmVjb3ZlcnlQYXNzd29yZCcpIHskTG9jYWw6Q291bnRSZWNQYXNzICs9IDF9CiAgICAgICAgICAgICAgICBlbHNlaWYgKCRfLktleVByb3RlY3RvclR5cGUgLWVxICdUUE0nKSB7JExvY2FsOkNvdW50VFBNICs9IDF9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIChbYm9vbF0gKCRMb2NhbDpDb3VudFRQTSAtZ2UgMSksW2Jvb2xdICgkTG9jYWw6Q291bnRSZWNQYXNzIC1nZSAxKSkKICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbkdldC1CaXRMb2NrZXJLZXlQcm90ZWN0b3JUeXBlcwoKCiAgICAgICAgI3JlZ2lvbiBHZXQtQXJyYXlSZWNvdmVyeVBhc3N3b3JkcwogICAgICAgICMgUmV0dXJucyBhIEFycmF5TGlzdCB3aXRoIGV4aXN0aW5nIFByb3RlY3Rpb25QYXNzd29yZHMKICAgICAgICBGdW5jdGlvbiBHZXQtQXJyYXlSZWNvdmVyeVBhc3N3b3JkcyB7CiAgICAgICAgICAgIFBhcmFtKAogICAgICAgICAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnk9JHRydWUpXQogICAgICAgICAgICAgICAgW01pY3Jvc29mdC5CaXRMb2NrZXIuU3RydWN0dXJlcy5CaXRMb2NrZXJWb2x1bWVdICRCaXRMb2NrZXJWb2x1bWUKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBHZXQgQml0TG9ja2VyIFByb3RlY3Rpb25QYXNzd29yZHMKICAgICAgICAgICAgJExvY2FsOktleVByb3RlY3RvclN0YXR1cyA9ICgkQml0TG9ja2VyVm9sdW1lIHwgU2VsZWN0LU9iamVjdCAtUHJvcGVydHkgS2V5UHJvdGVjdG9yKS5LZXlQcm90ZWN0b3IKICAgICAgICAgICAgJExvY2FsOkFycmF5UmVjb3ZlcnlQYXNzd29yZHMgPSBOZXctT2JqZWN0IE1pY3Jvc29mdC5CaXRMb2NrZXIuU3RydWN0dXJlcy5CaXRMb2NrZXJWb2x1bWVLZXlQcm90ZWN0b3JbXSAoJExvY2FsOktleVByb3RlY3RvclN0YXR1cy5Db3VudCAtIDEpCgogICAgICAgICAgICAkTG9jYWw6SW5kZXhDb3VudCA9IFtieXRlXTo6TWluVmFsdWUKICAgICAgICAgICAgJExvY2FsOktleVByb3RlY3RvclN0YXR1cyB8IEZvckVhY2gtT2JqZWN0IHsKICAgICAgICAgICAgICAgIGlmICgkXy5LZXlQcm90ZWN0b3JUeXBlIC1lcSAnUmVjb3ZlcnlQYXNzd29yZCcpIHsKICAgICAgICAgICAgICAgICAgICAkbnVsbCA9ICRMb2NhbDpBcnJheVJlY292ZXJ5UGFzc3dvcmRzWyRMb2NhbDpJbmRleENvdW50KytdID0gJF8KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gKCRMb2NhbDpBcnJheVJlY292ZXJ5UGFzc3dvcmRzKQogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIEdldC1BcnJheVJlY292ZXJ5UGFzc3dvcmRzCgoKICAgICAgICAjcmVnaW9uIEdldC1Wb2x1bWVVbmlxdWVJRAogICAgICAgIEZ1bmN0aW9uIEdldC1Wb2x1bWVVbmlxdWVJRCB7CiAgICAgICAgICAgIHBhcmFtKAogICAgICAgICAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnk9JHRydWUpXQogICAgICAgICAgICAgICAgW3N0cmluZ10gJERyaXZlTGV0dGVyCiAgICAgICAgICAgICkKICAgICAgICAgICAgJExvY2FsOkFEcml2ZUxldHRlciA9ICREcml2ZUxldHRlci5TdWJzdHJpbmcoMCwxKQogICAgICAgICAgICAkTG9jYWw6Vm9sdW1lSUQgPSAoR2V0LVZvbHVtZSAtRHJpdmVMZXR0ZXIgJEFEcml2ZUxldHRlciB8IFNlbGVjdCAqKS5VbmlxdWVJRC5TcGxpdCgneycpWy0xXQogICAgICAgICAgICAkTG9jYWw6Vm9sdW1lSUQgPSAkTG9jYWw6Vm9sdW1lSUQuU3ViU3RyaW5nKDAsKCRMb2NhbDpWb2x1bWVJRC5MZW5ndGggLSAyKSkKCiAgICAgICAgICAgIHJldHVybiAkTG9jYWw6Vm9sdW1lSUQKICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBHZXQtVm9sdW1lVW5pcXVlSUQKCgogICAgICAgICNyZWdpb24gQ2hlY2stSWZCaXRMb2NrZXJQV0hhc0NoYW5nZWQKICAgICAgICBGdW5jdGlvbiBDaGVjay1JZkJpdExvY2tlclBXSGFzQ2hhbmdlZHsKICAgICAgICAgICAgcGFyYW0oCiAgICAgICAgICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeT0kZmFsc2UpXQogICAgICAgICAgICAgICAgW3N0cmluZ10gJERyaXZlTGV0dGVyID0gJE9TRHJpdmUKICAgICAgICAgICAgKQogICAgICAgICAgICBbYm9vbF0gJExvY2FsOkhhc0NoYW5nZWQgPSAkZmFsc2UKCgogICAgICAgICAgICAjIE5hbWUgVmFyaWFibGVzCiAgICAgICAgICAgIFtzdHJpbmddICRMb2NhbDpOYW1lQXJyYXkgPSAnQXJyYXlSZWNvdmVyeVBhc3N3b3JkcycKICAgICAgICAgICAgW3N0cmluZ10gJExvY2FsOk5hbWVGaWxlICA9ICgnezB9LnR4dCcgLWYgKCRWb2x1bWVVbmlxdWVJRCkpCiAgICAgICAgICAgIFtzdHJpbmddICRMb2NhbDpWb2x1bWVJRCA9ICRTY3JpcHQ6Vm9sdW1lVW5pcXVlSUQKICAgICAgICAgICAgaWYgKCREcml2ZUxldHRlci5TdWJzdHJpbmcoMCwxKSAtbmUgJGVudjpTeXN0ZW1Ecml2ZS5TdWJzdHJpbmcoMCwxKSkgewogICAgICAgICAgICAgICAgJExvY2FsOk5hbWVBcnJheSA9ICd7MH17MX0nIC0gKCRMb2NhbDpWb2x1bWVMZXR0ZXIsJExvY2FsOk5hbWVBcnJheSkKICAgICAgICAgICAgICAgICRMb2NhbDpWb2x1bWVJRCA9IEdldC1Wb2x1bWVVbmlxdWVJRCAtRHJpdmVMZXR0ZXIgJERyaXZlTGV0dGVyCiAgICAgICAgICAgIH0KICAgICAgICAgICAKCiAgICAgICAgICAgICMgR2V0IFZhcmlhYmxlcwogICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6UGF0aERpciA9ICgnezB9ezF9JyAtZiAoJFNjcmlwdDpEaXJJbnN0YWxsLCdCYWNrdXBLZXlzXCcpKQogICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6UGF0aEZpbGUgPSAoJ3swfXsxfScgLWYgKCRMb2NhbDpQYXRoRGlyLCRMb2NhbDpOYW1lRmlsZSkpCiAgICAgICAgICAgIFtzdHJpbmddICRMb2NhbDpOb3dLZXlQcm90ZWN0b3JJRCA9ICgoR2V0LVZhcmlhYmxlIC1OYW1lICRMb2NhbDpOYW1lQXJyYXkgLVNjb3BlICdTY3JpcHQnKS5WYWx1ZSkuS2V5UHJvdGVjdG9ySUQKICAgICAgICAgICAgW3N0cmluZ10gJExvY2FsOk5vd1JlY292ZXJ5UGFzc3dvcmQgPSAoKEdldC1WYXJpYWJsZSAtTmFtZSAkTG9jYWw6TmFtZUFycmF5IC1TY29wZSAnU2NyaXB0JykuVmFsdWUpLlJlY292ZXJ5UGFzc3dvcmQKCgogICAgICAgICAgICAjIEdldCBzdGF0cwogICAgICAgICAgICBpZiAoLW5vdCAoVGVzdC1QYXRoIC1QYXRoICRMb2NhbDpQYXRoRmlsZSkpIHsKICAgICAgICAgICAgICAgIGlmICgtbm90KFRlc3QtUGF0aCAtUGF0aCAkTG9jYWw6UGF0aERpciAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSkpIHsKICAgICAgICAgICAgICAgICAgICAkbnVsbCA9IE5ldy1JdGVtIC1QYXRoICRMb2NhbDpQYXRoRGlyIC1JdGVtVHlwZSBEaXJlY3RvcnkgLUZvcmNlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBbc3RyaW5nW11dICRMb2NhbDpJbnB1dFN0cmluZyA9IChHZXQtQ29udGVudCAtUGF0aCAkTG9jYWw6UGF0aEZpbGUpLlNwbGl0KFtFbnZpcm9ubWVudF06Ok5ld0xpbmUpCiAgICAgICAgICAgICAgICBpZiAoJD8gLWFuZCAkTG9jYWw6SW5wdXRTdHJpbmcuTGVuZ3RoIC1nZSA3KSB7CiAgICAgICAgICAgICAgICAgICAgW3N0cmluZ10gJExvY2FsOlByZXZLZXlQcm90ZWN0b3JJRCA9ICRMb2NhbDpJbnB1dFN0cmluZ1s1XS5UcmltKCkKICAgICAgICAgICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6UHJldlJlY292ZXJ5UGFzc3dvcmQgPSAkTG9jYWw6SW5wdXRTdHJpbmdbN10uVHJpbSgpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHskTG9jYWw6SGFzQ2hhbmdlZCA9ICR0cnVlfQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgIyBDaGVjayBpZiBjaGFuZ2VkCiAgICAgICAgICAgIGlmICgkTG9jYWw6UHJldktleVByb3RlY3RvcklEKSB7CiAgICAgICAgICAgICAgICBpZiAoJExvY2FsOlByZXZLZXlQcm90ZWN0b3JJRCAtbmUgJExvY2FsOk5vd0tleVByb3RlY3RvcklEKSB7JExvY2FsOkhhc0NoYW5nZWQgPSAkdHJ1ZX0KICAgICAgICAgICAgICAgIGlmICgkTG9jYWw6UHJldlJlY292ZXJ5UGFzc3dvcmQgLW5lICRMb2NhbDpOb3dSZWNvdmVyeVBhc3N3b3JkKSB7JExvY2FsOkhhc0NoYW5nZWQgPSAkdHJ1ZX0KICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICMgV3JpdGUgbmV3IHZhbHVlcyBpZiBjaGFuZ2VkIG9yIGRvZXMgbm90IGV4aXN0CiAgICAgICAgICAgIGlmICgkTG9jYWw6SGFzQ2hhbmdlZCAtb3IgKC1ub3QgKFRlc3QtUGF0aCAtUGF0aCAkTG9jYWw6UGF0aEZpbGUpKSkgewogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciA9IFtzdHJpbmddOjpFbXB0eQogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciArPSAnRHJpdmUvVm9sdW1lIExldHRlciAoTm90IFVuaXF1ZSBpZGVudGlmaWVyKTp7MH0nIC1mICJgcmBuIgogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciArPSAnezB9ezF9JyAtZiAkRHJpdmVMZXR0ZXIsImByYG4iCiAgICAgICAgICAgICAgICAkTG9jYWw6T3V0U3RyICs9ICdWb2x1bWUgVW5pcXVlSUQgKE5hbWUgb2YgdGhpcyBmaWxlKTp7MH0nIC1mICJgcmBuIgogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciArPSAnezB9ezF9JyAtZiAkTG9jYWw6Vm9sdW1lSUQsImByYG4iCiAgICAgICAgICAgICAgICAkTG9jYWw6T3V0U3RyICs9ICdLZXlQcm90ZWN0b3JJRDp7MH0nIC1mICJgcmBuIgogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciArPSAnezB9ezF9JyAtZiAkTG9jYWw6Tm93S2V5UHJvdGVjdG9ySUQsImByYG4iCiAgICAgICAgICAgICAgICAkTG9jYWw6T3V0U3RyICs9ICdSZWNvdmVyeSBQYXNzd29yZDp7MH0nIC1mICJgcmBuIgogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciArPSAnezB9ezF9JyAtZiAkTG9jYWw6Tm93UmVjb3ZlcnlQYXNzd29yZCwiYHJgbiIKICAgICAgICAgICAgICAgIE91dC1GaWxlIC1GaWxlUGF0aCAkTG9jYWw6UGF0aEZpbGUgLUVuY29kaW5nIHV0ZjggLUZvcmNlIC1JbnB1dE9iamVjdCAoJExvY2FsOk91dFN0cikKICAgICAgICAgICAgfQoKCgogICAgICAgICAgICAjIFJldHVybiBzdGF0dXMKICAgICAgICAgICAgcmV0dXJuICRMb2NhbDpIYXNDaGFuZ2VkICAgICAgCiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gQ2hlY2stSWZCaXRMb2NrZXJQV0hhc0NoYW5nZWQKICAgICNlbmRyZWdpb24gUmV0dXJuIFZhbHVlcyAoVXNlZCBieSBvdGhlciBGdW5jdGlvbnMpCgoKCiAgICAjcmVnaW9uIFNldCBTY3JpcHQgV2lkZSBWYXJpYWJsZXMKICAgICAgICAjcmVnaW9uIEdldC1CaXRMb2NrZXJTdGF0dXMKICAgICAgICAjIEZpbGxzIHR3byBzdHJpbmdzIHdpdGggY3VycmVudCBWb2x1bWUgRW5jcnlwdGlvbiBTdGF0dXMsIGFuZCBWb2x1bWUgUHJvdGVjdGlvbiBTdGF0dXMuIAogICAgICAgICMgQWxzbyBtYWtlcyBhIGJvb2wgYXJyYXkgd2l0aCB0cnVlIGZhbHNlIGZvciB8IDE6IFRQTSBwcmVzZW50IHwgMjogUmVjb3ZlcnkgUGFzc3dvcmQgUHJlc2VudAogICAgICAgIEZ1bmN0aW9uIEdldC1CaXRMb2NrZXJTdGF0dXMgewogICAgICAgICAgICBQYXJhbSgKICAgICAgICAgICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5PSRmYWxzZSldCiAgICAgICAgICAgICAgICBbc3RyaW5nXSAkRHJpdmVMZXR0ZXIgPSAkT1NEcml2ZQogICAgICAgICAgICApCgogICAgICAgICAgICAjIEhlbHAgdmFyaWFibGVzCiAgICAgICAgICAgICRMb2NhbDpTdHJOYW1lID0gW3N0cmluZ106OkVtcHR5CiAgICAgICAgICAgIGlmICgkRHJpdmVMZXR0ZXIgLW5lICRlbnY6U3lzdGVtRHJpdmUpIHsKICAgICAgICAgICAgICAgICRMb2NhbDpTdHJOYW1lID0gJERyaXZlTGV0dGVyLlN1YnN0cmluZygwLDEpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgJExvY2FsOkFkZExldHRlclRvTmFtZSA9IFtzdHJpbmddOjpJc051bGxPckVtcHR5KCRMb2NhbDpTdHJOYW1lKQoKICAgICAgICAgICAgIyBHZXQgQml0TG9ja2VyIFN0YXR1cyBmb3IgVm9sdW1lCiAgICAgICAgICAgIFtNaWNyb3NvZnQuQml0TG9ja2VyLlN0cnVjdHVyZXMuQml0TG9ja2VyVm9sdW1lXSAkTG9jYWw6Qml0TG9ja2VyVm9sdW1lU3RhdHVzID0gR2V0LUJpdExvY2tlclZvbHVtZSAtTW91bnRQb2ludCAkRHJpdmVMZXR0ZXIKICAgICAgICAgICAgTmV3LVZhcmlhYmxlIC1OYW1lICgkKElmKC1ub3QoJExvY2FsOkFkZExldHRlclRvTmFtZSkpeyRMb2NhbDpTdHJOYW1lfSkgKyAnQml0TG9ja2VyVm9sdW1lU3RhdHVzJykgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSBgCiAgICAgICAgICAgICAgICAgICAgICAgICAtVmFsdWUgKFtzdHJpbmddKCRMb2NhbDpCaXRMb2NrZXJWb2x1bWVTdGF0dXMuVm9sdW1lU3RhdHVzKSkgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgIyBWb2x1bWUgRW5jcnlwdGlvbiBTdGF0dXM6IEZ1bGx5RGVjcnlwdGVkIHwgRW5jcnlwdGlvbkluUHJvZ3Jlc3MgfCBGdWxseUVuY3J5cHRlZAogICAgICAgICAgICBOZXctVmFyaWFibGUgLU5hbWUgKCQoSWYoLW5vdCgkTG9jYWw6QWRkTGV0dGVyVG9OYW1lKSl7JExvY2FsOlN0ck5hbWV9KSArICdWb2x1bWVFbmNTdGF0dXMnKSAtU2NvcGUgJ1NjcmlwdCcgLUZvcmNlIGAKICAgICAgICAgICAgICAgICAgICAgICAgIC1WYWx1ZSAoW3N0cmluZ10gKCRMb2NhbDpCaXRMb2NrZXJWb2x1bWVTdGF0dXMgfCBTZWxlY3QtT2JqZWN0IC1Qcm9wZXJ0eSBWb2x1bWVTdGF0dXMpLlZvbHVtZVN0YXR1cykKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVm9sdW1lIFByb3RlY3Rpb24gU3RhdHVzOiBPTiBpZiBFbmNyeXB0aW9uIFBlcmNlbnRhZ2UgPSAxMDAlCiAgICAgICAgICAgIE5ldy1WYXJpYWJsZSAtTmFtZSAoJChJZigtbm90KCRMb2NhbDpBZGRMZXR0ZXJUb05hbWUpKXskTG9jYWw6U3RyTmFtZX0pICsgJ1ZvbHVtZVByb3RlY3Rpb25TdGF0dXMnKSAtU2NvcGUgJ1NjcmlwdCcgLUZvcmNlIGAKICAgICAgICAgICAgICAgICAgICAgICAgIC1WYWx1ZSAoW3N0cmluZ10gKCRMb2NhbDpCaXRMb2NrZXJWb2x1bWVTdGF0dXMgfCBTZWxlY3QtT2JqZWN0IC1Qcm9wZXJ0eSBQcm90ZWN0aW9uU3RhdHVzKS5Qcm90ZWN0aW9uU3RhdHVzKQogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICA8IyAgCiAgICAgICAgICAgICAgICAgICAgVm9sdW1lIGNhbiBiZSAnRnVsbHkgRGVjcnlwdGVkJywgYnV0IHN0aWxsIGhhdmUgYSBUUE0gcHJlc2VudC4gCiAgICAgICAgICAgICAgICAgICAgVGhpcyBpcyB1c3VhbGx5IHRoZSBjYXNlIHJpZ2h0IGFmdGVyIGVuY3J5cHRpb24gaGFzIHN0YXJ0ZWQuIAogICAgICAgICAgICAjPgoKCiAgICAgICAgICAgICMgSWYgdGhlcmUgaXMgYSBLZXlQcm90ZWN0b3IgZm9yIGdpdmVuIHZvbHVtZSwgZ2V0IHRoZSByZXN0IG9mIHRoZSB2YXJpYWJsZXMKICAgICAgICAgICAgaWYgKCRMb2NhbDpCaXRMb2NrZXJWb2x1bWVTdGF0dXMuS2V5UHJvdGVjdG9yLkNvdW50IC1ndCAwKSB7CiAgICAgICAgICAgICAgICAjIFswfSA9IFZvbHVtZSBoYXMgVFBNPyAgIFsxXSA9IFZvbHVtZSBoYXMgUmVjb3ZlcnkgUGFzc3dvcmQ/CiAgICAgICAgICAgICAgICBOZXctVmFyaWFibGUgLU5hbWUgKCQoSWYoLW5vdCgkTG9jYWw6QWRkTGV0dGVyVG9OYW1lKSl7JExvY2FsOlN0ck5hbWV9KSArICdWb2x1bWVIYXNUUE1hbmRQVycpIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIC1WYWx1ZSAoW2Jvb2xbXV0oR2V0LUJvb2xEcml2ZUhhc0JpdExvY2tlclRQTWFuZFBXIC1Ecml2ZUxldHRlciAkRHJpdmVMZXR0ZXIpKSAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBFbmNyeXB0aW9uIFBlcmNlbnRhZ2U6IEhvdyBsb25nIGhhcyB0aGUgZW5jcnlwdGlvbiBwcm9jZXNzIGNvbWUKICAgICAgICAgICAgICAgIE5ldy1WYXJpYWJsZSAtTmFtZSAoJChJZigtbm90KCRMb2NhbDpBZGRMZXR0ZXJUb05hbWUpKXskTG9jYWw6U3RyTmFtZX0pICsgJ1ZvbHVtZUVuY3J5cHRpb25QZXJjZW50YWdlJykgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSBgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLVZhbHVlICgkTG9jYWw6Qml0TG9ja2VyVm9sdW1lU3RhdHVzLkVuY3J5cHRpb25QZXJjZW50YWdlLlRvU3RyaW5nKCkpICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBJZiBEcml2ZSBoYXMgVFBNIGFuZCBQVwogICAgICAgICAgICAgICAgaWYgKChHZXQtVmFyaWFibGUgLU5hbWUgKCQoSWYoLW5vdChbc3RyaW5nXTo6SXNOdWxsT3JFbXB0eSgkTG9jYWw6U3RyTmFtZSkpKXskTG9jYWw6U3RyTmFtZX0pICsgJ1ZvbHVtZUhhc1RQTWFuZFBXJykgLVNjb3BlICdTY3JpcHQnKS5WYWx1ZVsxXSkgewogICAgICAgICAgICAgICAgICAgICMgTmFtZSB0aGUgdmFyaWFibGVzCiAgICAgICAgICAgICAgICAgICAgJExvY2FsOk5hbWVBcnJheVJlY292ZXJ5UGFzc3dvcmRzID0gKCQoSWYoLW5vdChbc3RyaW5nXTo6SXNOdWxsT3JFbXB0eSgkTG9jYWw6U3RyTmFtZSkpKXskTG9jYWw6U3RyTmFtZX0pICsgJ0FycmF5UmVjb3ZlcnlQYXNzd29yZHMnKQogICAgICAgICAgICAgICAgICAgICRMb2NhbDpOYW1lQ291bnRSZWNvdmVyeVBhc3N3b3JkcyA9ICgkKElmKC1ub3QoW3N0cmluZ106OklzTnVsbE9yRW1wdHkoJExvY2FsOlN0ck5hbWUpKSl7JExvY2FsOlN0ck5hbWV9KSArICdDb3VudFJlY292ZXJ5UGFzc3dvcmRzJykKCiAgICAgICAgICAgICAgICAgICAgIyBHZXQgQXJyYXkgd2l0aCBwcm90ZWN0aW9uIHBhc3N3b3JkcwogICAgICAgICAgICAgICAgICAgIE5ldy1WYXJpYWJsZSAtTmFtZSAkTG9jYWw6TmFtZUFycmF5UmVjb3ZlcnlQYXNzd29yZHMgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSBgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC1WYWx1ZSAoR2V0LUFycmF5UmVjb3ZlcnlQYXNzd29yZHMgLUJpdExvY2tlclZvbHVtZSAkTG9jYWw6Qml0TG9ja2VyVm9sdW1lU3RhdHVzKQoKICAgICAgICAgICAgICAgICAgICAjIENvdW50IEFycmF5UmVjb3ZlcnlQYXNzd29yZHMKICAgICAgICAgICAgICAgICAgICBOZXctVmFyaWFibGUgLU5hbWUgJExvY2FsOk5hbWVDb3VudFJlY292ZXJ5UGFzc3dvcmRzIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtVmFsdWUgKChHZXQtVmFyaWFibGUgLU5hbWUgJExvY2FsOk5hbWVBcnJheVJlY292ZXJ5UGFzc3dvcmRzKS5WYWx1ZSkuTGVuZ3RoCgogICAgICAgICAgICAgICAgICAgICMgR2V0IFZvbHVtZSBVbmlxdWUgSUQgKHRvIGNoZWNrIGlmIHByb3RlY3Rpb24gcGFzc3dvcmQgaGFzIGNoYW5nZWQpCiAgICAgICAgICAgICAgICAgICAgTmV3LVZhcmlhYmxlIC1OYW1lICgkKElmKC1ub3QoW3N0cmluZ106OklzTnVsbE9yRW1wdHkoJExvY2FsOlN0ck5hbWUpKSl7JExvY2FsOlN0ck5hbWV9KSArICdWb2x1bWVVbmlxdWVJRCcpIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtVmFsdWUgKChHZXQtVm9sdW1lVW5pcXVlSUQgLURyaXZlTGV0dGVyICRMb2NhbDpEcml2ZUxldHRlcikpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBHZXQtQml0TG9ja2VyU3RhdHVzCiAgICAjZW5kcmVnaW9uIFNldCBTY3JpcHQgV2lkZSBWYXJpYWJsZXMKCgoKICAgICNyZWdpb24gUmVnaXN0cnkgRnVuY3Rpb25zCiAgICAgICAgI3JlZ2lvbiBDcmVhdGUtRW52VmFyaWFibGVzCiAgICAgICAgIyBDcmVhdGUtRW52VmFyaWFibGVzOiBDcmVhdGVzIHZhcmlhYmxlcyB1c2VkIGJ5IHRoZSB0cm91Ymxlc2hvb3RlciBhdCB0aGUgYm90dG9tLCB3aGVuIGZhaWxlZCBydW5zIHJlYWNoZXMgYSBnaXZlbiBudW1iZXIuICAKICAgICAgICBGdW5jdGlvbiBDcmVhdGUtRW52VmFyaWFibGVzIHsKICAgICAgICAgICAgIyMjIyBHbG9iYWwgVmFyaWFibGVzCiAgICAgICAgICAgICMjIFRlbmFudAogICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6SUQgPSAoR2V0LUNoaWxkSXRlbSBDZXJ0OlxMb2NhbE1hY2hpbmVcTXlcIHwgV2hlcmUtT2JqZWN0IHsgJF8uSXNzdWVyIC1tYXRjaCAnQ049TVMtT3JnYW5pemF0aW9uLUFjY2VzcycgfSkuU3ViamVjdC5SZXBsYWNlKCdDTj0nLCcnKQogICAgICAgICAgICBbc3RyaW5nXSAkU2NyaXB0Ok5hbWVUZW5hbnQgPSAoR2V0LUl0ZW1Qcm9wZXJ0eSBIS0xNOlxTWVNURU1cQ3VycmVudENvbnRyb2xTZXRcQ29udHJvbFxDbG91ZERvbWFpbkpvaW5cSm9pbkluZm9cJCgkTG9jYWw6SUQpKS5Vc2VyRW1haWwuU3BsaXQoJ0AnKVsxXQogICAgICAgICAgICBbc3RyaW5nXSAkU2NyaXB0Ok5hbWVUZW5hbnRTaG9ydCA9ICRHbG9iYWw6TmFtZVRlbmFudC5TcGxpdCgnLicpWzBdCiAgICAgICAgICAgICMjIEhhcmR3YXJlIGFuZCBXaW5kb3dzIGluZm8KICAgICAgICAgICAgW3N0cmluZ10gJFNjcmlwdDpDb21wdXRlck1hbnVmYWN0dXJlciA9IFF1ZXJ5LVJlZ2lzdHJ5IC1EaXIgJ0hLTE06XEhBUkRXQVJFXERFU0NSSVBUSU9OXFN5c3RlbVxCSU9TXFN5c3RlbU1hbnVmYWN0dXJlcicKICAgICAgICAgICAgaWYgKC1ub3QoW3N0cmluZ106OklzTnVsbE9yRW1wdHkoJFNjcmlwdDpDb21wdXRlck1hbnVmYWN0dXJlcikpKSB7CiAgICAgICAgICAgICAgICBbc3RyaW5nXSAkU2NyaXB0OkNvbXB1dGVyRmFtaWx5ID0gUXVlcnktUmVnaXN0cnkgLURpciAnSEtMTTpcSEFSRFdBUkVcREVTQ1JJUFRJT05cU3lzdGVtXEJJT1NcU3lzdGVtRmFtaWx5JwogICAgICAgICAgICAgICAgW3N0cmluZ10gJFNjcmlwdDpDb21wdXRlclByb2R1Y3ROYW1lID0gUXVlcnktUmVnaXN0cnkgLURpciAnSEtMTTpcSEFSRFdBUkVcREVTQ1JJUFRJT05cU3lzdGVtXEJJT1NcU3lzdGVtUHJvZHVjdE5hbWUnCiAgICAgICAgICAgICAgICBbc3RyaW5nXSAkU2NyaXB0OldpbmRvd3NFZGl0aW9uID0gUXVlcnktUmVnaXN0cnkgLURpciAnSEtMTTpcU09GVFdBUkVcTWljcm9zb2Z0XFdpbmRvd3MgTlRcQ3VycmVudFZlcnNpb25cUHJvZHVjdE5hbWUnCiAgICAgICAgICAgICAgICBbc3RyaW5nXSAkU2NyaXB0OldpbmRvd3NWZXJzaW9uID0gUXVlcnktUmVnaXN0cnkgLURpciAnSEtMTTpcU09GVFdBUkVcTWljcm9zb2Z0XFdpbmRvd3MgTlRcQ3VycmVudFZlcnNpb25cUmVsZWFzZUlkJwogICAgICAgICAgICAgICAgW3N0cmluZ10gJFNjcmlwdDpXaW5kb3dzVmVyc2lvbiArPSAoJyAoezB9KScgLWYgKFF1ZXJ5LVJlZ2lzdHJ5IC1EaXIgJ0hLTE06XFNPRlRXQVJFXE1pY3Jvc29mdFxXaW5kb3dzIE5UXEN1cnJlbnRWZXJzaW9uXEN1cnJlbnRCdWlsZCcpKQogICAgICAgICAgICB9IAogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICRMb2NhbDpFbnZJbmZvID0gR2V0LVdtaU9iamVjdCAtQ2xhc3MgJ1dpbjMyX0NvbXB1dGVyU3lzdGVtJyB8IFNlbGVjdC1PYmplY3QgLVByb3BlcnR5IE1hbnVmYWN0dXJlcixNb2RlbCxTeXN0ZW1GYW1pbHkgICAgICAgIAogICAgICAgICAgICAgICAgW3N0cmluZ10gJFNjcmlwdDpDb21wdXRlck1hbnVmYWN0dXJlciA9ICRMb2NhbDpFbnZJbmZvLk1hbnVmYWN0dXJlcgogICAgICAgICAgICAgICAgW3N0cmluZ10gJFNjcmlwdDpDb21wdXRlckZhbWlseSA9ICRMb2NhbDpFbnZJbmZvLlN5c3RlbUZhbWlseQogICAgICAgICAgICAgICAgW3N0cmluZ10gJFNjcmlwdDpDb21wdXRlclByb2R1Y3ROYW1lID0gJExvY2FsOkVudkluZm8uTW9kZWwKICAgICAgICAgICAgICAgICRMb2NhbDpPU0luZm8gPSBHZXQtV21pT2JqZWN0IC1DbGFzcyAnV2luMzJfb3BlcmF0aW5nc3lzdGVtJyB8IFNlbGVjdC1PYmplY3QgLVByb3BlcnR5IENhcHRpb24sVmVyc2lvbgogICAgICAgICAgICAgICAgW3N0cmluZ10gJFNjcmlwdDpXaW5kb3dzRWRpdGlvbiA9ICRMb2NhbDpPU0luZm8uQ2FwdGlvbgogICAgICAgICAgICAgICAgW3N0cmluZ10gJFNjcmlwdDpXaW5kb3dzVmVyc2lvbiA9ICRMb2NhbDpPU0luZm8uVmVyc2lvbgogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gQ3JlYXRlLUVudlZhcmlhYmxlcwoKCiAgICAgICAgI3JlZ2lvbiBRdWVyeS1SZWdpc3RyeQogICAgICAgIEZ1bmN0aW9uIFF1ZXJ5LVJlZ2lzdHJ5IHsKICAgICAgICAgICAgUGFyYW0gKFtQYXJhbWV0ZXIoTWFuZGF0b3J5PSR0cnVlKV0gW3N0cmluZ10gJERpcikKICAgICAgICAgICAgJExvY2FsOk91dCA9IFtzdHJpbmddOjpFbXB0eQogICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6S2V5ID0gJERpci5TcGxpdCgne1x9JylbLTFdCiAgICAgICAgICAgIFtzdHJpbmddICRMb2NhbDpEaXIgPSAkRGlyLlJlcGxhY2UoJExvY2FsOktleSwnJykKICAgICAgICAKICAgICAgICAgICAgJExvY2FsOkV4aXN0cyA9IEdldC1JdGVtUHJvcGVydHkgLVBhdGggKCd7MH0nIC1mICREaXIpIC1OYW1lICgnezB9JyAtZiAkTG9jYWw6S2V5KSAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZQogICAgICAgICAgICBpZiAoJEV4aXN0cykgewogICAgICAgICAgICAgICAgJExvY2FsOk91dCA9ICRMb2NhbDpFeGlzdHMuJExvY2FsOktleQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAkTG9jYWw6T3V0CiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gUXVlcnktUmVnaXN0cnkKICAgICNlbmRyZWdpb24gUmVnaXN0cnkgRnVuY3Rpb25zCgoKCiAgICAjcmVnaW9uICAgIEVkaXQtU2NoZWR1bGVkVGFzawogICAgZnVuY3Rpb24gRWRpdC1TY2hlZHVsZWRUYXNrIHsKICAgICAgICBQYXJhbSgKICAgICAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnk9JGZhbHNlKV0KICAgICAgICAgICAgW3N0cmluZ10gJFRhc2tOYW1lID0gJFNjcmlwdDpTY2hlZHVsZWRUYXNrTmFtZQogICAgICAgICkKCiAgICAgICAgJFRhc2sgPSBHZXQtU2NoZWR1bGVkVGFzayAtVGFza05hbWUgJFRhc2tOYW1lIC1FcnJvckFjdGlvbiAnU2lsZW50bHlDb250aW51ZScKCiAgICAgICAgaWYgKCRUYXNrKSB7CiAgICAgICAgICAgIGlmICgkU2NyaXB0OkJvb2xSZW1vdmVTY2hlZHVsZWRUYXNrQWZ0ZXJGaXJzdFN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICRudWxsID0gVW5yZWdpc3Rlci1TY2hlZHVsZWRUYXNrIC1UYXNrTmFtZSAkVGFzayAtQ29uZmlybTokZmFsc2UgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJwogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdSZW1vdmluZyB0aGUgU2NoZWR1bGVkIHRhc2sgInswfSIuIFN1Y2Nlc3M/IHsxfScgLWYgKCRUYXNrLlRhc2tOYW1lLCQ/LlRvU3RyaW5nKCkpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgW0RhdGVUaW1lXSAkTG9jYWw6TmV3U2NoZWRUaW1lID0gW0RhdGVUaW1lXTo6VG9kYXkuQWRkSG91cnMoMTIpICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgJG51bGwgPSBTZXQtU2NoZWR1bGVkVGFzayAtVGFza05hbWUgJFNjcmlwdDpTY2hlZHVsZWRUYXNrTmFtZSAtVHJpZ2dlciAoTmV3LVNjaGVkdWxlZFRhc2tUcmlnZ2VyIC1EYWlseSAtQXQgJExvY2FsOk5ld1NjaGVkVGltZSkgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJwogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdFZGl0aW5nIFNjaGVkdWxlZCB0YXNrICJ7MH0iIHRvIHN0YXJ0IGRhaWx5IGF0IHsxfS4gU3VjY2Vzcz8gezJ9LicgLWYgKCRTY3JpcHQ6U2NoZWR1bGVkVGFza05hbWUsJExvY2FsOk5ld1NjaGVkVGltZS5Ib3VyLlRvU3RyaW5nKCksJD8uVG9TdHJpbmcoKSkpCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIExvZ1dyaXRlICgnRm91bmQgbm8gU2NoZWR1bGVkIFRhc2sgd2l0aCBuYW1lICJ7MH0iLicgLWYgKCRUYXNrTmFtZSkpCiAgICAgICAgfQogICAgfQogICAgI2VuZHJlZ2lvbiBFZGl0LVNjaGVkdWxlZFRhc2sKCgogICAgI3JlZ2lvbiBQcm9tcHQtUmVib290CiAgICBGdW5jdGlvbiBQcm9tcHQtUmVib290IHsKICAgICAgICBbdWludDE2XSAkTG9jYWw6VGltZVRvUmVib290SW5NaW51dGVzID0gNjAgCiAgICAgICAgW3N0cmluZ10gJExvY2FsOlN0clNob3J0TWVzc2FnZSA9ICgnV2luZG93cyB3aWxsIHJlc3RhcnQgaW4gezB9IG1pbnV0ZXMgdG8gZmluaXNoIGRldmljZSBjb25maWd1cmF0aW9uLiBTYXZlIHlvdXIgd29yayEnIC1mICgkTG9jYWw6VGltZVRvUmVib290SW5NaW51dGVzKSkKICAgICAgICAkbnVsbCA9IGNtZC5leGUgL2MgKCdzaHV0ZG93biAvciAvdCB7MH0gL2MgInsxfSInIC1mICgkTG9jYWw6VGltZVRvUmVib290SW5NaW51dGVzKjYwKSwkTG9jYWw6U3RyU2hvcnRNZXNzYWdlKSAyPiYxCiAgICAgICAgaWYgKC1ub3QoJD8pKSB7CiAgICAgICAgICAgICRudWxsID0gY21kLmV4ZSAvYyAoJ3NodXRkb3duIC9hJykgMj4mMQogICAgICAgICAgICAkbnVsbCA9IGNtZC5leGUgL2MgKCdzaHV0ZG93biAvciAvdCB7MH0gL2MgInsxfSInIC1mICgkTG9jYWw6VGltZVRvUmVib290SW5NaW51dGVzKjYwKSwkTG9jYWw6U3RyU2hvcnRNZXNzYWdlKSAyPiYxCiAgICAgICAgfQoKICAgICAgICA8IyBGT1IgRlVUVVJFIEVOSEFOQ0VNRU5UUwogICAgICAgIFtzdHJpbmddICRMb2NhbDpTdHJNZXNzYWdlID0gJ1lvdXIgY29tcHV0ZXIgYXJlIGF3YWl0aW5nIGEgcmVzdGFydDonCiAgICAgICAgJExvY2FsOlN0ck1lc3NhZ2UgKz0gJ3swfSBZb3VyIG9yZ2FuaXphdGlvbiByZXF1aXJlcyB5b3VyIGhhcmQnIC1mICJgcmBuIgogICAgICAgICRMb2NhbDpTdHJNZXNzYWdlICs9ICd7MH0gZHJpdmUgdG8gYmUgZW5jeXB0ZWQuIEluIG9yZGVyIHRvJyAtZiAiYHJgbiIKICAgICAgICAkTG9jYWw6U3RyTWVzc2FnZSArPSAnezB9IGZpbmlzaCB0aGlzIHByb2Nlc3MsIHlvdSBuZWVkIHRvJyAtZiAiYHJgbiIKICAgICAgICAkTG9jYWw6U3RyTWVzc2FnZSArPSAnezB9IHJlc3RhcnQgeW91ciBjb21wdXRlci4gWW91IGNhbicgLWYgImByYG4iCiAgICAgICAgJExvY2FsOlN0ck1lc3NhZ2UgKz0gJ3swfSBlaXRoZXIgZG8gaXQgbWFudWFsbHksIG9yIGl0IHdpbGwnIC1mICJgcmBuIgogICAgICAgICRMb2NhbDpTdHJNZXNzYWdlICs9ICd7MH0gYXV0b21hdGljYWxseSBoYXBwZW4gaW4nIC1mICJgcmBuIgogICAgICAgICRMb2NhbDpTdHJNZXNzYWdlICs9ICd7MH0gezF9IG1pbnV0ZXMuJyAtZiAiYHJgbiIsJExvY2FsOlRpbWVUb1JlYm9vdEluTWludXRlcwogICAgICAgICRMb2NhbDpTdHJNZXNzYWdlICs9ICd7MH17MH0gU0FWRSBZT1VSIFdPUkshJyAtZiAiYHJgbiIKICAgICAgICAjPgogICAgfQogICAgI2VuZHJlZ2lvbiBQcm9tcHQtUmVib290ICAgIAojZW5kcmVnaW9uIEZ1bmN0aW9ucwoKCgojcmVnaW9uIEluaXRpYWxpemUKICAgIExvZ1dyaXRlICgnIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjJykKICAgIExvZ1dyaXRlICgnU3RhcnRpbmcgVHJpZ2dlciBCaXRMb2NrZXIgc2NyaXB0LicpCiAgICBMb2dXcml0ZSAoJyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIycpCiAgICBMb2dXcml0ZSAoJyMjIyBHZXQgc3RhdHMuJykKICAgICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKICAgICMjIEZldGNoIHByZXYgcnVuIHJlc3VsdHMgIyMKICAgICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMgICAgCiAgICBpZiAoLW5vdCAoVGVzdC1QYXRoIC1QYXRoICRTY3JpcHQ6RmlsZVN0YXRzKSkgewogICAgICAgIFt1aW50MTZdICRTY3JpcHQ6Q291bnRSdW5zID0gMAogICAgICAgIFtib29sXSAkU2NyaXB0OklzRmluaXNoZWQxc3RUaW1lID0gW2Jvb2xdICRTY3JpcHQ6SXNFbmNyeXB0ZWQgPSBbYm9vbF0gJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdyA9IFtib29sXSAkU2NyaXB0OklzQmFja3VwT0QgPSBbYm9vbF0gJFNjcmlwdDpJc0JhY2t1cEFBRCA9ICRmYWxzZQogICAgICAgICRTY3JpcHQ6T1NEcml2ZUtleUlEID0gJFNjcmlwdDpPU0RyaXZlUHJvdGVjdGlvblBhc3N3b3JkID0gW3N0cmluZ106OkVtcHR5CiAgICAgICAgTG9nV3JpdGUgKCcjIEZpcnN0IHJ1biEnKQogICAgfQogICAgZWxzZSB7CiAgICAgICAgW1N0cmluZ1tdXSAkSW5wdXRTdHJpbmcgPSAoR2V0LUNvbnRlbnQgLVBhdGggJFNjcmlwdDpGaWxlU3RhdHMpLlNwbGl0KFtFbnZpcm9ubWVudF06Ok5ld0xpbmUpCiAgICAgICAgW3VpbnQxNl0gJFNjcmlwdDpDb3VudFJ1bnMgPSBbdWludDE2XSAkSW5wdXRTdHJpbmdbMF0KICAgICAgICBbYm9vbF0gJFNjcmlwdDpJc0ZpbmlzaGVkMXN0VGltZSA9IFt1aW50MTZdICRJbnB1dFN0cmluZ1sxXQogICAgICAgIFtib29sXSAkU2NyaXB0OklzRW5jcnlwdGVkID0gW3VpbnQxNl0gJElucHV0U3RyaW5nWzJdCiAgICAgICAgW2Jvb2xdICRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cgPSBbdWludDE2XSAkSW5wdXRTdHJpbmdbM10KICAgICAgICBbYm9vbF0gJFNjcmlwdDpJc0JhY2t1cE9EID0gW3VpbnQxNl0gJElucHV0U3RyaW5nWzRdCiAgICAgICAgW2Jvb2xdICRTY3JpcHQ6SXNCYWNrdXBBQUQgPSBbdWludDE2XSAkSW5wdXRTdHJpbmdbNV0KICAgICAgICBbc3RyaW5nXSAkU2NyaXB0Ok9TRHJpdmVLZXlJRCA9IFtzdHJpbmddICRJbnB1dFN0cmluZ1s2XQogICAgICAgIFtzdHJpbmddICRTY3JpcHQ6T1NEcml2ZVByb3RlY3Rpb25QYXNzd29yZCA9IFtzdHJpbmddICRJbnB1dFN0cmluZ1s3XQogICAgICAgIExvZ1dyaXRlICgnIyBQcmV2aW91cyBydW4gcmVzdWx0czonKQogICAgICAgIFdyaXRlLVN0YXRzIC1QcmV2aW91c09ubHkgJHRydWUKICAgIH0KICAgIAoKICAgICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKICAgICMjIyMgR2V0IGN1cnJlbnQgc3RhdHVzICMjIyMKICAgICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMgIAogICAgTG9nV3JpdGUgKCcjIEN1cnJlbnQgc3RhdHVzOicpCiAgICAjIE9TIERyaXZlCiAgICBHZXQtQml0TG9ja2VyU3RhdHVzCiAgICBpZiAoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQVykgewogICAgICAgIGlmICgkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzBdKSB7CiAgICAgICAgICAgICRTY3JpcHQ6SXNFbmNyeXB0ZWQgPSAoJFNjcmlwdDpCaXRMb2NrZXJWb2x1bWVTdGF0dXMgLWVxICRTY3JpcHQ6Qml0TG9ja2VyVm9sdW1lRW5jcnlwdGlvblN0YXR1c2VzWzJdKQogICAgICAgIH0KICAgICAgICBpZiAoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1sxXSkgewogICAgICAgICAgICAkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3ID0gKCRTY3JpcHQ6Q291bnRSZWNvdmVyeVBhc3N3b3JkcyAtZXEgMSkKICAgICAgICB9ICAgICAgICAgICAgICAgICAgIAogICAgfQogICAgZWxzZSB7CiAgICAgICAgJFNjcmlwdDpJc0VuY3J5cHRlZCA9ICRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cgPSAkZmFsc2UKICAgIH0KCgogICAgIyBPdGhlciBGaXhlZCBEcml2ZXMKICAgICNUT0RPCiAgICA8IwogICAgW1N0cmluZ1tdXSAkU2NyaXB0OkZpeGVkVm9sdW1lc0xldHRlcnMgPSBAKChHZXQtVm9sdW1lIHwgYAogICAgICAgIFdoZXJlLU9iamVjdCB7JF8uRHJpdmVUeXBlIC1lcSAnRml4ZWQnIC1hbmQgKC1ub3QoW3N0cmluZ106OklzTnVsbE9yRW1wdHkoJF8uRHJpdmVMZXR0ZXIpKSl9IHwgYAogICAgICAgIFdoZXJlLU9iamVjdCB7JF8uRHJpdmVMZXR0ZXIgLW5lICRPU0RyaXZlLlJlcGxhY2UoJzonLCcnKX0pLkRyaXZlTGV0dGVyKQogICAgCiAgICAkU2NyaXB0OkZpeGVkVm9sdW1lc0xldHRlcnMgfCBGb3JFYWNoLU9iamVjdCB7CiAgICAgICAgaWYgKC1ub3QoW3N0cmluZ106OklzTnVsbE9yRW1wdHkoJF8pKSkgewogICAgICAgICAgICBHZXQtQml0bG9ja2VyU3RhdHVzIC1Ecml2ZUxldHRlciAkXwogICAgICAgICAgICBpZiAoKEdldC1WYXJpYWJsZSAtTmFtZSAoJ3swfUNvdW50UHJvdGVjdGlvbktleXMnIC1mICRfKSAtU2NvcGUgJ1NjcmlwdCcpLkxlbmd0aCAtZ3QgMCkgewogICAgICAgICAgICAgICAgW3N0cmluZ1tdXSAkU2NyaXB0Ok90aGVyRW5jcnlwdGVkRHJpdmVzICs9IEAoJF8pCiAgICAgICAgICAgIH0KICAgICAgICB9ICAgICAKICAgIH0jPgoKICAgIFdyaXRlLVN0YXRzCiNlbmRyZWdpb24gSW5pdGlhbGl6ZQogICAgCgoKI3JlZ2lvbiBNYWluCiNyZWdpb24gRW5jcnlwdGlvbgojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKIyMjIyBCaXRMb2NrZXIgRW5jcnlwdGlvbiAjIyMjCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwpMb2dXcml0ZSAoJyMjIyBCaXRMb2NrZXIgRW5jcnlwdGlvbicpCgoKCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKIyBCaXRMb2NrZXIgRW5jcnlwdGlvbiBvZiBPUyBEcml2ZSAgIwojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiNyZWdpb24gQml0TG9ja2VyIEVuY3J5cHRpb24gb2YgT1MgRHJpdmUKCkxvZ1dyaXRlICgnIyBCaXRMb2NrZXIgRW5jcnlwdGlvbiBvZiBPUyBEcml2ZScpCmlmICgkU2NyaXB0OklzRW5jcnlwdGVkKSB7CiAgICBMb2dXcml0ZSAoJ09TIERyaXZlIGlzIGFscmVhZHkgZnVsbHkgZW5jcnlwdGVkLicpCn0KZWxzZSB7CiAgICBbYm9vbF0gJFNjcmlwdDpCb29sRGlkQW55dGhpbmdDaGFuZ2VUaGlzUnVudGltZSA9ICR0cnVlCiAgICAKICAgICMgSWYgJ0Z1bGx5RW5jcnlwdGVkJywgYW5kIFRQTSBwcmVzZW50CiAgICAjIE1lYW5zIHRoYXQgT1MgRHJpdmUgaXMgc3VjY2Vzc2Z1bGx5IGVuY3J5cHRlZCB3aXRoIEJpdExvY2tlcgogICAgaWYgKCgkU2NyaXB0OlZvbHVtZUVuY1N0YXR1cyAtZXEgJFNjcmlwdDpCaXRMb2NrZXJWb2x1bWVFbmNyeXB0aW9uU3RhdHVzZXNbMl0pIC1hbmQgJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1swXSkgewogICAgICAgIExvZ1dyaXRlICgnT1MgRHJpdmUgaXMgZnVsbHkgZW5jcnlwdGVkIScpCiAgICAgICAgJFNjcmlwdDpJc0VuY3J5cHRlZCA9ICR0cnVlCiAgICB9CiAgICAKCiAgICAjIElmICdFbmNyeXB0aW9uSW5Qcm9ncmVzcycgYW5kIFRQTSBwcmVzZW50CiAgICAjIE1lYW5zIGNvbXB1dGVyIGhhcyByZXN0YXJ0ZWQgYWZ0ZXIgQml0TG9ja2VyIGVuY3J5cHRpb24gd2FzIGVuYWJsZWQuIFdhaXRpbmcgZm9yIHRoZSB2b2x1bWUgdG8gZ2V0IGVuY3J5cHRlZAogICAgZWxzZWlmICgkU2NyaXB0OlZvbHVtZUVuY1N0YXR1cyAtZXEgJFNjcmlwdDpCaXRMb2NrZXJWb2x1bWVFbmNyeXB0aW9uU3RhdHVzZXNbMV0gLWFuZCAkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzBdKSB7CiAgICAgICAgTG9nV3JpdGUgKCdPUyBEcml2ZSBlbmNyeXB0aW9uIGlzIGluIHByb2dyZXNzOicpCiAgICAgICAgTG9nV3JpdGUgKCdSZXN0YXJ0IGhhdmUgdGFrZW4gcGxhY2UsIGFuZCBlbmNyeXB0aW9uIGhhcyBzdGFydGVkLicpCiAgICAgICAgTG9nV3JpdGUgKCdPUyBEcml2ZSBFbmNyeXB0aW9uIFBlcmNlbnRhZ2U6IHswfSUuJyAtZiAoJFNjcmlwdDpWb2x1bWVFbmNyeXB0aW9uUGVyY2VudGFnZSkpCiAgICAgICAgTG9nV3JpdGUgKCdDYW4gY29udGludWUgdG8gY2hlY2sgaWYgUmVjb3ZlcnkgUGFzc3dvcmQgaXMgcHJlc2VudCwgYW5kIGJhY2t1cCBpdC4nKQogICAgfQoKCiAgICAjIElmICdGdWxseURyZWN0eXB0ZWQnICAgICAKICAgIGVsc2VpZiAoJFZvbHVtZUVuY1N0YXR1cyAtZXEgJFNjcmlwdDpCaXRMb2NrZXJWb2x1bWVFbmNyeXB0aW9uU3RhdHVzZXNbMF0pIHsKICAgICAgICAKICAgICAgICAjIElmICdGdWxseURyZWN0eXB0ZWQnIGJ1dCB0aGVyZSBleGlzdHMgYSBUUE0KICAgICAgICAjIE1lYW5zIHRoYXQgZW5jcnlwdGlvbiBoYXMgc3RhcnRlZCwgYnV0IGNvbXB1dGVyIGlzIGF3YWl0aW5nIHJlc3RhcnQKICAgICAgICBpZiAoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQVyAtYW5kICRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMF0pIHsKICAgICAgICAgICAgTG9nV3JpdGUgKCdPUyBEcml2ZSBFbmNyeXB0aW9uIGhhcyBzdGFydGVkLCBidXQgY29tcHV0ZXIgaGFzIG5vdCBiZWVuIHJlc3RhcnRlZCB5ZXQuJykKICAgICAgICAgICAgTG9nV3JpdGUgKCdPUyBEcml2ZSBFbmNyeXB0aW9uIFBlcmNlbnRhZ2U6IHswfSUuJyAtZiAoJFNjcmlwdDpWb2x1bWVFbmNyeXB0aW9uUGVyY2VudGFnZSkpCiAgICAgICAgICAgIExvZ1dyaXRlICgnQ2FuIGNvbnRpbnVlIHRvIGNoZWNrIGlmIFJlY292ZXJ5IFBhc3N3b3JkIGlzIHByZXNlbnQsIGFuZCBiYWNrdXAgaXQuJykKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIExvZ1dyaXRlICgnT1MgRHJpdmUgaXMgbm90IGVuY3J5cHRlZC4nKQogICAgICAgICAgICBMb2dXcml0ZSAoJ0F0dGVtcHRpbmcgdG8gRW5hYmxlIEJpdExvY2tlciBvbiBPUyBkcml2ZSAoezB9KScgLWYgKCRPU0RyaXZlKSkKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICMgRW5hYmxlIEJpdExvY2tlciB1c2luZyBUUE0KICAgICAgICAgICAgICAgICRudWxsID0gRW5hYmxlLUJpdExvY2tlciAtTW91bnRQb2ludCAkT1NEcml2ZSAtVHBtUHJvdGVjdG9yIC1Vc2VkU3BhY2VPbmx5IC1FcnJvckFjdGlvbiBDb250aW51ZQogICAgICAgICAgICAgICAgaWYgKCQ/KSB7CiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdTdWNjZXNzZnVsbHkgZW5hYmxlZCBiaXRsb2NrZXIuJykgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0ZhaWxlZCBFbmFibGluZyBCaXRsb2NrZXIgVHBtUHJvdGVjdG9yLCBpdGBzIHByb2JhYmx5IGFscmVhZHkgZW5hYmxlZCcpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gCiAgICAgICAgICAgIGNhdGNoIHsKICAgICAgICAgICAgICAgIExvZ0Vycm9ycwogICAgICAgICAgICAgICAgRW5hYmxlLUJpdExvY2tlciAtTW91bnRQb2ludCAkT1NEcml2ZSAtVHBtUHJvdGVjdG9yIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlCiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1dpbGwgYXR0ZW1wdCB0byBFbmFibGUgQml0TG9ja2VyIGFueXdheSBhbmQgdGhlbiBjb250aW51ZS4gU3VjY2Vzcz8gezB9JyAtZiAoJD8pKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZpbmFsbHkgewogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdEaWQgd2UgYWN0dWFsbHkgZW5hYmxlIEJpdExvY2tlcj8nKQogICAgICAgICAgICAgICAgR2V0LUJpdExvY2tlclN0YXR1cwogICAgICAgICAgICAgICAgaWYgKCRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFcgLWFuZCAkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzBdKSB7CiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdUUE0gcHJlc2VudCBmb3IgT1MgRHJpdmU/IHswfScgLWYgKCRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMF0pKQogICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnUHJvbXB0aW5nIHJlYm9vdC4nKQogICAgICAgICAgICAgICAgICAgIFByb21wdC1SZWJvb3QKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnRVJST1IsIG5vdCBlbmNyeXB0ZWQuIFRQTSBub3QgcHJlc2VudCBmb3IgT1MgRHJpdmUnKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgIyBJZiBzY2VuYXJpbyBmaXRzIG5vbmUgb2YgdGhlIGNhc2VzIGFib3ZlLi4KICAgIGVsc2UgewogICAgICAgIExvZ1dyaXRlICgnTmVpdGhlciAiezB9IiwgInsxfSIgb3IgInsyfSIuJyAtZiAoJFNjcmlwdDpCaXRMb2NrZXJWb2x1bWVFbmNyeXB0aW9uU3RhdHVzZXNbMF0sJFNjcmlwdDpCaXRMb2NrZXJWb2x1bWVFbmNyeXB0aW9uU3RhdHVzZXNbMV0sJFNjcmlwdDpCaXRMb2NrZXJWb2x1bWVFbmNyeXB0aW9uU3RhdHVzZXNbMl0pKQogICAgfQp9CiNlbmRyZWdpb24gQml0TG9ja2VyIEVuY3J5cHRpb24gb2YgT1MgRHJpdmUKCgoKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwojIFByb3RlY3Rpb24gUGFzc3dvcmQgZm9yIE9TIERyaXZlICAjCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKI3JlZ2lvbiBQcm90ZWN0aW9uIFBhc3N3b3JkIGZvciBPUyBEcml2ZQoKTG9nV3JpdGUgKCcjIEJpdExvY2tlciBQcm90ZWN0aW9uIFBhc3N3b3JkIGZvciBPUyBEcml2ZScpCiMgSWYgJ0Z1bGx5RW5jcnlwdGVkJywgb3IgVE1QIGlzIHByZXNlbnQKaWYgKCRTY3JpcHQ6SXNFbmNyeXB0ZWQgLW9yICgkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXIC1hbmQgJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1swXSkpIHsKICAgIAogICAgCiAgICAjIElmIHdlJ3JlIGRvbmUgd2l0aCByZWNvdmVyeSBwYXNzd29yZChzKSBhbHJlYWR5CiAgICBpZiAoJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdyAtYW5kICgkU2NyaXB0OkNvdW50UmVjb3ZlcnlQYXNzd29yZHMgLWVxIDEpKSB7CiAgICAgICAgTG9nV3JpdGUgJ1JlY292ZXJ5IFBhc3N3b3JkIGZvciBPUyBEcml2ZSBpcyBhbHJlYWR5IHByZXNlbnQnCiAgICB9CiAgICAKCiAgICAjIElmIHdlJ3JlIG5vdCBkb25lIHdpdGggcmVjb3ZlcnkgcGFzc3dvcmQocykKICAgIGVsc2UgeyAgICAgICAgCiAgICAgICAgW2Jvb2xdICRTY3JpcHQ6Qm9vbERpZEFueXRoaW5nQ2hhbmdlVGhpc1J1bnRpbWUgPSAkdHJ1ZQogICAgICAgIFtib29sXSAkTG9jYWw6U3VjY2VzcyA9ICRmYWxzZQogICAgICAgIAogICAgICAgIAogICAgICAgICMgSWYgdGhlcmUgZXhpc3RzIEJpdExvY2tlciBFbmNyeXB0aW9uIFJlY292ZXJ5IFBhc3N3b3JkICAgICAgIAogICAgICAgIGlmICgkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzFdKSB7CiAgICAgICAgICAgIAoKICAgICAgICAgICAgIyBJZiB0aGVyZXMgaXMgX2FfIFByb3RlY3Rpb25QYXNzd29yZCwgd2UncmUgZG9uZQogICAgICAgICAgICBpZiAoJFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzIC1lcSAxKSB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAnT25seSBhIHBhc3N3b3JkIHByZXNlbnQnCiAgICAgICAgICAgICAgICAkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3ID0gJHRydWUKICAgICAgICAgICAgICAgICRMb2NhbDpTdWNjZXNzID0gJHRydWUKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICMgSWYgdGhlcmUgaXMgbXVsdGlwbGUgUmVjb3ZlcnlQYXNzd29yZHMsIHdlIG5lZWQgdG8gcmVtb3ZlIGFsbCBidXQgb25lCiAgICAgICAgICAgIGVsc2VpZiAoJFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzIC1ndCAxKSB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAnTXVsdGlwbGUgcGFzc3dvcmRzIHByZXNlbnQnCiAgICAgICAgICAgICAgICBXcml0ZS1SZWNvdmVyeVBhc3N3b3JkCiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1dpbGwgcmVtb3ZlIGFsbCBidXQgdGhlIGZpcnN0IG9uZScpCiAgICAgICAgICAgICAgICAkU2NyaXB0OkFycmF5UmVjb3ZlcnlQYXNzd29yZHMgfCBGb3JFYWNoLU9iamVjdCB7IAogICAgICAgICAgICAgICAgICAgIGlmICgkXy5LZXlQcm90ZWN0b3JJZCAtbmUgJFNjcmlwdDpBcnJheVJlY292ZXJ5UGFzc3dvcmRzWzBdLktleVByb3RlY3RvcklkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRudWxsID0gUmVtb3ZlLUJpdExvY2tlcktleVByb3RlY3RvciAtTW91bnRQb2ludCAkT1NEcml2ZSAtS2V5UHJvdGVjdG9ySWQgJF8uS2V5UHJvdGVjdG9ySUQKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQ/KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1N1Y2Nlc3NmdWxseSByZW1vdmVkIHwgS2V5UHJvdGVjdG9ySWQgInswfSIgfCBSZWNvdmVyeVBhc3N3b3JkICJ7MX0iJyAtZiAoJF8uS2V5UHJvdGVjdG9ySWQsJF8uUmVjb3ZlcnlQYXNzd29yZCkpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnU3VjY2Vzc2Z1bGx5IHNraXBwZWQgdGhlIGZpcnN0IGtleS4gfCBLZXlQcm90ZWN0b3JJZCAiezB9IiB8IFJlY292ZXJ5UGFzc3dvcmQgInsxfSInIC1mICgkXy5LZXlQcm90ZWN0b3JJZCwkXy5SZWNvdmVyeVBhc3N3b3JkKSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgR2V0LUJpdExvY2tlclN0YXR1cwogICAgICAgICAgICAgICAgaWYgKCRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFcgLWFuZCAkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzFdIC1hbmQgKCRTY3JpcHQ6Q291bnRSZWNvdmVyeVBhc3N3b3JkcyAtZXEgMSkpIHsKICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3VjY2VzcyA9ICR0cnVlCiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICMgVGhpcyBzaG91bGQgbm90IGJlIHBvc3NpYmxlCiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgTG9nV3JpdGUgJ0VSUk9SOiBSZWNvdmVyeVBhc3N3b3JkIHByZXNlbnQsIGJ1dCBjb3VudCA8IDEnCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIAogICAgICAgICNyZWdpb24gQWRkIFByb3RlY3Rpb24gUGFzc3dvcmQgSWYgTm9uZSBQcmVzZW50CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIExvZ1dyaXRlICgnTm8gQml0TG9ja2VyIFJlY292ZXJ5IFBhc3N3b3JkcyBmb3VuZCBmb3IgT1MgRHJpdmUgezB9LCBjcmVhdGluZyBvbmUuJyAtZiAkT1NEcml2ZSkKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICRudWxsID0gQWRkLUJpdExvY2tlcktleVByb3RlY3RvciAtTW91bnRQb2ludCAkT1NEcml2ZSAtUmVjb3ZlcnlQYXNzd29yZFByb3RlY3RvciAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSAtV2FybmluZ0FjdGlvbiBTaWxlbnRseUNvbnRpbnVlCiAgICAgICAgICAgICAgICBpZiAoJD8pIHsKICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3VjY2VzcyA9ICR0cnVlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkbnVsbCA9IEVuYWJsZS1CaXRMb2NrZXIgLU1vdW50UG9pbnQgJE9TRHJpdmUgLVJlY292ZXJ5UGFzc3dvcmRQcm90ZWN0b3IgLUVycm9yQWN0aW9uIFN0b3AKICAgICAgICAgICAgICAgICAgICBpZiAoJD8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN1Y2Nlc3MgPSAkdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgIH0gCiAgICAgICAgICAgIGNhdGNoIHsKICAgICAgICAgICAgICAgIExvZ0Vycm9ycwogICAgICAgICAgICAgICAgJG51bGwgPSBBZGQtQml0TG9ja2VyS2V5UHJvdGVjdG9yIC1Nb3VudFBvaW50ICRPU0RyaXZlIC1SZWNvdmVyeVBhc3N3b3JkUHJvdGVjdG9yIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlIC1XYXJuaW5nQWN0aW9uIFNpbGVudGx5Q29udGludWUKICAgICAgICAgICAgICAgIGlmICgkTGFzdEV4aXRDb2RlIC1lcSAwKSB7CiAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN1Y2Nlc3MgPSAkdHJ1ZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJG51bGwgPSBFbmFibGUtQml0TG9ja2VyIC1Nb3VudFBvaW50ICRPU0RyaXZlIC1SZWNvdmVyeVBhc3N3b3JkUHJvdGVjdG9yIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgaWYgKCQ/KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdWNjZXNzID0gJHRydWUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmluYWxseSB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1RyaWVkIHRvIGFkZCBCaXRMb2NrZXIgUmVjb3ZlcnlQYXNzd29yZFByb3RlY3Rvci4gU3VjY2Vzcz8gezB9LicgLWYgKCRMb2NhbDpTdWNjZXNzKSkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBBZGQgUHJvdGVjdGlvbiBQYXNzd29yZCBJZiBOb25lIFByZXNlbnQKCiAgICAgICAgCgogICAgICAgICMgQ291bnQgYW5kIGxpc3QgZXhpc3RpbmcgUmVjb3ZlcnlQYXNzd29yZCwgb25seSB3cml0ZSBzdWNjZXNzIGlmIHRoZXJlcyBvbmUgICAgICAgIAogICAgICAgIGlmICgkTG9jYWw6U3VjY2VzcykgewogICAgICAgICAgICBMb2dXcml0ZSAnQ2hlY2tpbmcgaWYgdGhlcmUgaXMgb25seSBvbmUgUHJvdGVjdGlvbiBQYXNzd29yZC4nCiAgICAgICAgICAgIEdldC1CaXRMb2NrZXJTdGF0dXMKICAgICAgICAgICAgJExvY2FsOkJvb2xUZW1wID0gJChJZigkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXKXsoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1sxXSl9RWxzZXskZmFsc2V9KQogICAgICAgICAgICBMb2dXcml0ZSAoJ1Byb3RlY3Rpb24gUGFzc3dvcmQgUHJlc2VudD8gezB9JyAtZiAoJExvY2FsOkJvb2xUZW1wKSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgSWYoJExvY2FsOkJvb2xUZW1wKSB7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICgkU2NyaXB0OkNvdW50UmVjb3ZlcnlQYXNzd29yZHMgLWVxIDEpIHsgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdTVUNDRVNTLCBrZXlzIGxlZnQ6IDEuJykKICAgICAgICAgICAgICAgICAgICAkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3ID0gJHRydWUKICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICdGQUlMLCBrZXlzIGxlZnQ6IHswfS4nIC1mICgkU2NyaXB0OkNvdW50UmVjb3ZlcnlQYXNzd29yZHMpCiAgICAgICAgICAgICAgICAgICAgJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdyA9ICRmYWxzZQogICAgICAgICAgICAgICAgfSAgCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0ZBSUwsIG5vIFByb3RlY3Rpb24gUGFzc3dvcmQgZm91bmQnKQogICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAKICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAKICAgICAgICBlbHNlIHsKICAgICAgICAgICAgTG9nV3JpdGUgKCdTb21ldGhpbmcgZmFpbGVkJykKICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAKICAgIH0KICAgICNlbmRyZWdpb24gSWYgdGhlcmVzIDAgb3IgbXVsdGlwbGUgUHJvdGVjdGlvbnNQYXNzd29yZChzKSAKfQoKCiMgTm90IGVuY3J5cHRlZCA9IE5vIG1ha2luZyBvZiBSZWNvdmVyeVBhc3N3b3JkCmVsc2UgewogICAgTG9nV3JpdGUgKCdPUyBEcml2ZSBpcyAiRnVsbHlEZWNyeXB0ZWQiIGFuZCB0aGVyZSBleGlzdHMgbm8gIlRQTSIuJykKICAgIExvZ1dyaXRlICgnQml0TG9ja2VyIFJlY292ZXJ5UGFzc3dvcmQgY2FuIG5vdCBiZSBhZGRlZCBhdCB0aGlzIHRpbWUuJykKICAgIExvZ1dyaXRlICgnUmVjb3ZlcnkgUGFzc3dvcmQgcHJlc2VudD8gezB9JyAtZiAoJChJZigkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXKXskU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzBdfUVsc2V7JGZhbHNlfSkpKQogICAgJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdyA9ICRmYWxzZQp9CgojIFdyaXRlIHJlY292ZXJ5IHBhc3N3b3JkKHMpIGlmIGFueXRoaW5nIGNoYW5nZWQgdGhpcyBydW50aW1lCmlmICgkU2NyaXB0OkJvb2xEaWRBbnl0aGluZ0NoYW5nZVRoaXNSdW50aW1lIC1hbmQgJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1sxXSkgewogICAgV3JpdGUtUmVjb3ZlcnlQYXNzd29yZAp9CiNlbmRyZWdpb24gUHJvdGVjdGlvbiBQYXNzd29yZCBmb3IgT1MgRHJpdmUKI2VuZHJlZ2lvbiBFbmNyeXB0aW9uCgoKCiMjIyMjIyMjIyMjIyMjIyMjIyMjCiMjIyMjIyBCQUNLVVAgIyMjIyMjCiMjIyMjIyMjIyMjIyMjIyMjIyMjCiNyZWdpb24gQmFja3VwCgoKTG9nV3JpdGUgKCcjIyMgQmFja3VwIFByb3RlY3Rpb24gUGFzc3dvcmQgdG8gQXp1cmVBQUQgYW5kIE9uZURyaXZlNEInKQoKIyBDaGVjayBmb3IgY2hhbmdlcyBpZiBGaW5pc2hlZDFzdFRpbWUKaWYgKCRTY3JpcHQ6SXNGaW5pc2hlZDFzdFRpbWUpIHsKICAgIExvZ1dyaXRlICgnV2lsbCBjaGVjayBpZiBhbnl0aGluZyBoYXMgY2hhbmdlZC4nKQoKICAgIGlmIChDaGVjay1JZkJpdExvY2tlclBXSGFzQ2hhbmdlZCkgewogICAgICAgIExvZ1dyaXRlICdTb21ldGhpbmcgaGFzIGNoYW5nZWQsIEJpdExvY2tlciBSZWNvdmVyeSBQcm90ZWN0aW9uIFBhc3N3b3JkIGlzIG5vdCB0aGUgc2FtZSBhcyB0aGUgb25lIGJhY2tlZCB1cC4nCiAgICAgICAgJFNjcmlwdDpJc0JhY2t1cEFBRCA9ICRTY3JpcHQ6SXNCYWNrdXBPRCA9ICRmYWxzZQogICAgICAgICRTY3JpcHQ6Qm9vbERpZEFueXRoaW5nQ2hhbmdlVGhpc1J1bnRpbWUgPSAkdHJ1ZQogICAgfQogICAgZWxzZSB7CiAgICAgICAgTG9nV3JpdGUgJ05vdGhpbmcgaGFzIGNoYW5nZWQsIEJpdExvY2tlciBSZWNvdmVyeSBQcm90ZWN0aW9uIFBhc3N3b3JkIGlzIHRoZSBzYW1lIGFzIHRoZSBvbmUgcHJldmlvdXNseSBiYWNrZWQgdXAuJwogICAgfQp9CgojIElmICRJc0JhY2t1cEFBRCAtYW5kICRJc0JhY2t1cE9ECmlmICgkU2NyaXB0OklzQmFja3VwQUFEIC1hbmQgJFNjcmlwdDpJc0JhY2t1cE9EKSB7CiAgICBMb2dXcml0ZSAoJ09TIERyaXZlIGlzIGFscmVhZHkgYmFja2VkIHVwLicpCn0KCgojIElmIG5vIGJhY2t1cHMKZWxzZSB7CiAgICAjIElmIFByb3RlY3Rpb25QYXNzd29yZChzKSBleGlzdAogICAgaWYgKCRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cpIHsKICAgICAgICAgICAgCiAgICAgICAgTG9nV3JpdGUgKCdPUyBEcml2ZSBpcyBlbmNyeXB0ZWQsIGFuZCB0aGVyZSBhcmUgezB9IFByb3RlY3Rpb25QYXNzd29yZChzKSBwcmVzZW50LicgLWYgKCRTY3JpcHQ6QXJyYXlSZWNvdmVyeVBhc3N3b3Jkcy5MZW5ndGgpKQogICAgICAgIExvZ1dyaXRlICgnQ29udGludWluZyB3aXRoIGJhY2t1cC4nKQoKICAgIAogICAgICAgICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwogICAgICAgICMgT25lRHJpdmUgZm9yIEJ1c2luZXNzIGJhY2t1cAogICAgICAgICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwogICAgICAgICNyZWdpb24gQmFja3VwIE9uZURyaXZlIGZvciBCdXNpbmVzcwogICAgCiAgICAgICAgTG9nV3JpdGUgKCcjIEJhY2t1cCB0byBPbmVEcml2ZScpCiAgICAgICAgaWYgKCRTY3JpcHQ6SXNCYWNrdXBPRCkgewogICAgICAgICAgICBMb2dXcml0ZSAoJ0FscmVhZHkgZG9uZScpCiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICAkU2NyaXB0OkJvb2xEaWRBbnl0aGluZ0NoYW5nZVRoaXNSdW50aW1lID0gJHRydWUKICAgICAgICAgICAgCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAjIEdldCBDdXJyZW50IFVzZXIgYXMgU2VjdXJpdHlJZGVudGlmaWVyCiAgICAgICAgICAgICAgICBpZiAoLW5vdCgkU2NyaXB0OlBhdGhEaXJSb290Q1UpKXsKICAgICAgICAgICAgICAgICAgICBbc3RyaW5nXSAkU2NyaXB0OlBhdGhEaXJSb290Q1UgPSAoJ0hLVTpcezB9XCcgLWYgKFtTeXN0ZW0uU2VjdXJpdHkuUHJpbmNpcGFsLk5UQWNjb3VudF06Om5ldygoR2V0LVByb2Nlc3MgLU5hbWUgJ2V4cGxvcmVyJyAtSW5jbHVkZVVzZXJOYW1lIHwgU2VsZWN0LU9iamVjdCAtRXhwYW5kUHJvcGVydHkgVXNlck5hbWUgLUZpcnN0IDEpKS5UcmFuc2xhdGUoW1N5c3RlbS5TZWN1cml0eS5QcmluY2lwYWwuU2VjdXJpdHlJZGVudGlmaWVyXSkuVmFsdWUpKQogICAgICAgICAgICAgICAgICAgIGlmKCgtbm90KCQ/KSkgLW9yIFtzdHJpbmddOjpJc051bGxPckVtcHR5KCRQYXRoRGlyUm9vdENVKSl7QnJlYWt9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQWRkIEhLVTpcIGFzIFBTRHJpdmUgaWYgbm90IGFscmVhZHkKICAgICAgICAgICAgICAgIGlmICgoR2V0LVBTRHJpdmUgLU5hbWUgJ0hLVScgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUpIC1lcSAkbnVsbCkgeyRudWxsID0gTmV3LVBTRHJpdmUgLVBTUHJvdmlkZXIgUmVnaXN0cnkgLU5hbWUgJ0hLVScgLVJvb3QgJ0hLRVlfVVNFUlMnfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEdldCBPbmVEcml2ZSBmb3IgQnVzaW5lc3MgcGF0aCBmcm9tIHJlZ2lzdHJ5ICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICRSZWdWYWx1ZXMgPSBHZXQtQ2hpbGRJdGVtIC1QYXRoICgnezB9XFNPRlRXQVJFXE1pY3Jvc29mdFxPbmVEcml2ZVxBY2NvdW50c1wnIC1mICgkUGF0aERpclJvb3RDVSkpCiAgICAgICAgICAgICAgICBmb3JlYWNoICgkUmVnVmFsdWUgaW4gJFJlZ1ZhbHVlcykgewogICAgICAgICAgICAgICAgICAgIFtzdHJpbmddICRMb2NhbDpPRDRCQWNjVHlwZSA9ICgkUmVnVmFsdWUgfCBTZWxlY3QtT2JqZWN0IC1FeHBhbmRQcm9wZXJ0eSAnTmFtZScpLlNwbGl0KCd7XH0nKVstMV0KICAgICAgICAgICAgICAgICAgICBpZiAoJExvY2FsOk9ENEJBY2NUeXBlIC1saWtlICdCdXNpbmVzcyonKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnRm91bmQgYSBPbmVEcml2ZSBmb3IgQnVzaW5lc3MgYWNjb3VudC4nKQogICAgICAgICAgICAgICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6UGF0aERpck9ENEIgPSAoR2V0LUl0ZW1Qcm9wZXJ0eSAtUGF0aCAkUmVnVmFsdWUuTmFtZS5SZXBsYWNlKCdIS0VZX1VTRVJTXCcsJ0hLVTpcJykgLU5hbWUgJ1VzZXJGb2xkZXInKS5Vc2VyRm9sZGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkTG9jYWw6UGF0aERpck9ENEIgLW5vdGxpa2UgKCd7MH1cVXNlcnNcKlxPbmVEcml2ZSAtKicgLWYgKCRPU0RyaXZlKSkgLWFuZCAoLW5vdChUZXN0LVBhdGggLVBhdGggJExvY2FsOlBhdGhEaXJPRDRCKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnRmFpbGVkIHRvIGJ1aWxkIE9uZURyaXZlIHBhdGg6ICJ7MH0iLCBvciBpdCBkb2VzIG5vdCBleGlzdC4nIC1mICgkTG9jYWw6UGF0aCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkU2NyaXB0OklzQmFja3VwT0QgPSAkZmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgtbm90KCRTY3JpcHQ6Q29tcHV0ZXJQcm9kdWN0TmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDcmVhdGUtRW52VmFyaWFibGVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgUnVudGltZSB2YXJpYWJsZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgW2Jvb2xdICRMb2NhbDpCb29sRm9sZGVyRXhpc3RzID0gJGZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIENyZWF0aW5nIHBhdGhzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6UGF0aERpck9ENEJCYWNrdXBQYXJlbnQgPSAoJ3swfVxCaXRMb2NrZXIgUmVjb3ZlcnlcJyAtZiAoJExvY2FsOlBhdGhEaXJPRDRCKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtzdHJpbmddICRMb2NhbDpQYXRoRGlyT0Q0QkJhY2t1cCA9ICgnezB9ezF9ICh7Mn0gezN9KVwnIC1mICgkTG9jYWw6UGF0aERpck9ENEJCYWNrdXBQYXJlbnQsJFNjcmlwdDpDb21wdXRlck5hbWUsJFNjcmlwdDpDb21wdXRlck1hbnVmYWN0dXJlciwkU2NyaXB0OkNvbXB1dGVyUHJvZHVjdE5hbWUpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdPbmVEcml2ZSBmb3IgQnVzaW5lc3MgUGF0aDogezB9JyAtZiAoJExvY2FsOlBhdGhEaXJPRDRCKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnQmFja3VwIFBhdGggUGFyZW50OiAgICAgICAgIHswfScgLWYgKCRMb2NhbDpQYXRoRGlyT0Q0QkJhY2t1cFBhcmVudCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0JhY2t1cCBQYXRoIGZvciBCaXRsb2NrZXIgUmVjb3ZlcnkgS2V5KHMpOiB7MH0nIC1mICgkTG9jYWw6UGF0aERpck9ENEJCYWNrdXApKSAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICNUZXN0aW5nIGlmIFJlY292ZXJ5IGZvbGRlciBleGlzdHMgaWYgbm90IGNyZWF0ZSBvbmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnVGVzdGluZyBpZiBiYWNrdXAgZm9sZGVyIGV4aXN0cywgY3JlYXRlIGl0IGlmIG5vdC4nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFRlc3QtUGF0aCAtUGF0aCAkTG9jYWw6UGF0aERpck9ENEJCYWNrdXAgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpCb29sRm9sZGVyRXhpc3RzID0gJHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICdDcmVhdGluZyBPbmVEcml2ZSBmb3IgQnVzaW5lc3MgZm9sZGVyIGZvciBiYWNrdXAuJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRudWxsID0gTmV3LUl0ZW0gLVBhdGggJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwIC1JdGVtVHlwZSAnRGlyZWN0b3J5JyAtRm9yY2UgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOkJvb2xGb2xkZXJFeGlzdHMgPSBUZXN0LVBhdGggLVBhdGggJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCd7MH0nIC1mICQoSWYoJExvY2FsOkJvb2xGb2xkZXJFeGlzdHMpeydTdWNjZXNzLid9RWxzZXsnRmFpbGVkLid9KSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgQ3JlYXRlIE9uZURyaXZlIGZvciBCdXNpbmVzcyBCYWNrdXAgaWYgdGhlIGZvbGRlciBleGlzdHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgtbm90KCRMb2NhbDpCb29sRm9sZGVyRXhpc3RzKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICdGYWlsZWQgdG8gY2hlY2sgb3IgY3JlYXRlIGZvbGRlci4nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIE1ha2Ugc3VyZSAnQml0TG9ja2VyIFJlY292ZXJ5JyBmb2xkZXIgaXMgaGlkZGVuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdNYWtpbmcgc3VyZSAiezB9IiBpcyBoaWRkZW4uJyAtZiAoJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwUGFyZW50KSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKEdldC1JdGVtIC1QYXRoICRMb2NhbDpQYXRoRGlyT0Q0QkJhY2t1cFBhcmVudCAtRm9yY2UpLkF0dHJpYnV0ZXMgLW5vdGxpa2UgJypoaWRkZW4qJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoR2V0LUl0ZW0gLVBhdGggJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwUGFyZW50IC1Gb3JjZSkuQXR0cmlidXRlcyA9IChHZXQtSXRlbSAtUGF0aCAkTG9jYWw6UGF0aERpck9ENEJCYWNrdXBQYXJlbnQgLUZvcmNlKS5BdHRyaWJ1dGVzIC1ib3IgJ0hpZGRlbicKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdTdWNjZXNzZnVsbHkgaGlkZGVuPyB7MH0uJyAtZiAoJD8pKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdBbHJlYWR5IGhpZGRlbi4nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIENyZWF0ZSBzdHJpbmcgZm9yIEJpdExvY2tlclJlY292ZXJ5UGFzc3dvcmQudHh0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgPSBbc3RyaW5nXTo6RW1wdHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAoJ0JpdExvY2tlciBSZWNvdmVyeVBhc3N3b3JkIGZvciBPUyBEcml2ZSAoezB9KXsxfScgLWYgKCRlbnY6U3lzdGVtRHJpdmUsImByYG4iKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSBHZXQtU3RyaW5nUmVjb3ZlcnlQYXNzd29yZHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAiYHJgbmByYG4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gJ0JpdExvY2tlciBEcml2ZSBFbmNyeXB0aW9uIHJlY292ZXJ5IGtleXswfScgLWYgImByYG4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gJ1RvIHZlcmlmeSB0aGF0IHRoaXMgaXMgdGhlIGNvcnJlY3QgcmVjb3Zlcnkga2V5LCBjb21wYXJlIHRoZSBzdGFydCBvZiB0aGUgZm9sbG93aW5nezB9JyAtZiAiYHJgbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAnaWRlbnRpZmllciB3aXRoIHRoZSBpZGVudGlmaWVyIHZhbHVlIGRpc3BsYXllZCBvbiB5b3VyIFBDLicKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAiYHJgbmByYG4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gKCdJZGVudGlmaWVyOiB7MH0nIC1mICgkU2NyaXB0OkFycmF5UmVjb3ZlcnlQYXNzd29yZHNbMF0uS2V5UHJvdGVjdG9ySWQpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICJgcmBuYHJgbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAnSWYgdGhlIGFib3ZlIGlkZW50aWZpZXIgbWF0Y2hlcyB0aGUgb25lIGRpc3BsYXllZCBieSB5b3VyIFBDLHswfScgLWYgImByYG4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gJ3RoZW4gdXNlIHRoZSBmb2xsb3dpbmcga2V5IHRvICB1bmxvY2sgeW91ciBkcml2ZTonCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gImByYG5gcmBuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICgnUmVjb3ZlcnkgS2V5OiB7MH0nIC1mICgkU2NyaXB0OkFycmF5UmVjb3ZlcnlQYXNzd29yZHNbMF0uUmVjb3ZlcnlQYXNzd29yZCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gImByYG5gcmBuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICdJZiB0aGUgYWJvdmUgaWRlbnRpZmllciBkb2VzbmB0IG1hdGNoIHRoZSBvbmUgZGlzcGxheWVkIGJ5IHlvdXIgUEMsezB9JyAtZiAiYHJgbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAndGhlbiB0aGlzIGlzbmB0IHRoZSByaWdodCBrZXkgdG8gdW5sb2NrIHlvdXIgZHJpdmUuezB9JyAtZiAiYHJgbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAnVHJ5IGFub3RoZXIgcmVjb3Zlcnkga2V5LCBvciByZWZlciB0b3swfScgLWYgImByYG4iIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICdodHRwczovL2dvLm1pY3Jvc29mdC5jb20vZndsaW5rLz9MaW5rSUQ9MjYwNTg5IGZvciBhZGRpdGlvbmFsIGFzc2lzdGFuY2UuJwoKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBPdXQtRmlsZSB0aGUgc3RyaW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgJ0NyZWF0aW5nIGJhY2t1cCBpbiBPbmVEcml2ZSBmb3IgQnVzaW5lc3MuJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtzdHJpbmddICRMb2NhbDpPRDRCQmFja3VwRmlsZVBhdGggPSAoJ3swfUJpdGxvY2tlclJlY292ZXJ5UGFzc3dvcmQtezF9LnR4dCcgLWYgKCRMb2NhbDpQYXRoRGlyT0Q0QkJhY2t1cCwoR2V0LURhdGUgLUZvcm1hdCAneXlNTWRkaGhtbXNzJykpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE91dC1GaWxlIC1GaWxlUGF0aCAkTG9jYWw6T0Q0QkJhY2t1cEZpbGVQYXRoIC1FbmNvZGluZyAndXRmOCcgLUZvcmNlIC1JbnB1dE9iamVjdCAoJExvY2FsOlN0clJlY1Bhc3MpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFRlc3QtUGF0aCAtUGF0aCAkTG9jYWw6T0Q0QkJhY2t1cEZpbGVQYXRoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRTY3JpcHQ6SXNCYWNrdXBPRCA9ICR0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIE9uZURyaXZlIGZvciBCdXNpbmVzcyBCYWNrdXAgU3VjY2Vzcz8KICAgICAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnU3VjY2Vzcz8gezB9JyAtZiAoJFNjcmlwdDpJc0JhY2t1cE9EKSkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdTa2lwcGluZyBwZXJzb25hbCBPbmVEcml2ZSBmb3IgQnVzaW5lc3MgZm9sZGVycy4nKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjYXRjaCB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0Vycm9yIHdoaWxlIGJhY2t1cCB0byBPbmVEcml2ZSwgbWFrZSBzdXJlIHRoYXQgeW91IGFyZSBBQUQgam9pbmVkIGFuZCBhcmUgcnVubmluZyB0aGUgY21kbGV0IGFzIGFuIGFkbWluLicpCiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0Vycm9yIG1lc3NhZ2U6JyArICJgcmBuIiArICgkXykpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmluYWxseSB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0RpZCBiYWNrdXAgdG8gT25lRHJpdmUgc3VjY2VlZD8gezB9JyAtZiAoJFNjcmlwdDpJc0JhY2t1cE9EKSkKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIEJhY2t1cCBPbmVEcml2ZSBmb3IgQnVzaW5lc3MKICAgIAoKCiAgICAgICAgIyMjIyMjIyMjIyMjIyMjIyMKICAgICAgICAjIEF6dXJlIEFEIEJhY2t1cAogICAgICAgICMjIyMjIyMjIyMjIyMjIyMjCiAgICAgICAgI3JlZ2lvbiBCYWNrdXAgQXp1cmUgQUFECgogICAgICAgIExvZ1dyaXRlICgnIyBCYWNrdXAgdG8gQXp1cmUgQUQnKQogICAgICAgIGlmICgkU2NyaXB0OklzQmFja3VwQUFEKSB7CiAgICAgICAgICAgIExvZ1dyaXRlICgnQWxyZWFkeSBkb25lJykKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICRTY3JpcHQ6Qm9vbERpZEFueXRoaW5nQ2hhbmdlVGhpc1J1bnRpbWUgPSAkdHJ1ZQogICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICNDaGVjayBpZiB3ZSBjYW4gdXNlIEJhY2t1cFRvQUFELUJpdExvY2tlcktleVByb3RlY3RvciBjb21tYW5kbGV0CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAnQ2hlY2tpbmcgaWYgd2UgY2FuIHVzZSBCYWNrdXBUb0FBRC1CaXRMb2NrZXJLZXlQcm90ZWN0b3IgY29tbWFuZGxldC4nCiAgICAgICAgICAgICAgICAkY21kTmFtZSA9ICdCYWNrdXBUb0FBRC1CaXRMb2NrZXJLZXlQcm90ZWN0b3InCiAgICAgICAgICAgICAgICBpZiAoR2V0LUNvbW1hbmQgJGNtZE5hbWUgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJykgewogICAgICAgICAgICAgICAgICAgICNCYWNrdXBUb0FBRC1CaXRMb2NrZXJLZXlQcm90ZWN0b3IgY29tbWFuZGxldCBleGlzdHMKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ3swfSBjb21tYW5kbGV0IGV4aXN0cyEnIC1mICgkY21kTmFtZSkpIAogICAgICAgICAgICAgICAgICAgICRudWxsID0gQmFja3VwVG9BQUQtQml0TG9ja2VyS2V5UHJvdGVjdG9yIC1Nb3VudFBvaW50ICRPU0RyaXZlIC1LZXlQcm90ZWN0b3JJZCAkU2NyaXB0OkFycmF5UmVjb3ZlcnlQYXNzd29yZHNbMF0uS2V5UHJvdGVjdG9ySWQgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUKICAgICAgICAgICAgICAgICAgICBpZiAoJD8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJFNjcmlwdDpJc0JhY2t1cEFBRCA9ICR0cnVlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6QkxWID0gR2V0LUJpdExvY2tlclZvbHVtZSAtTW91bnRQb2ludCAkT1NEcml2ZQogICAgICAgICAgICAgICAgICAgICAgICAkbnVsbCA9IEJhY2t1cFRvQUFELUJpdExvY2tlcktleVByb3RlY3RvciAtTW91bnRQb2ludCAkT1NEcml2ZSAtS2V5UHJvdGVjdG9ySWQgJExvY2FsOkJMVi5LZXlQcm90ZWN0b3JbMF0uS2V5UHJvdGVjdG9ySWQgLUVycm9yQWN0aW9uIFN0b3AKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQ/KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkU2NyaXB0OklzQmFja3VwQUFEID0gJHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1N1Y2Nlc3M/IHswfScgLWYgKCRTY3JpcHQ6SXNCYWNrdXBBQUQpKQogICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgIGVsc2UgeyAKICAgICAgICAgICAgICAgICAgICAjIEJhY2t1cFRvQUFELUJpdExvY2tlcktleVByb3RlY3RvciBjb21tYW5kbGV0IG5vdCBhdmFpbGFibGUsIHVzaW5nIG90aGVyIG1lY2hhbmlzbSAKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAnQmFja3VwVG9BQUQtQml0TG9ja2VyS2V5UHJvdGVjdG9yIGNvbW1hbmRsZXQgbm90IGF2YWlsYWJsZSwgdXNpbmcgb3RoZXIgbWVjaGFuaXNtLicgCiAgICAgICAgICAgICAgICAgICAgIyBHZXQgdGhlIEFBRCBNYWNoaW5lIENlcnRpZmljYXRlCiAgICAgICAgICAgICAgICAgICAgJGNlcnQgPSBHZXQtQ2hpbGRJdGVtIENlcnQ6XExvY2FsTWFjaGluZVxNeVwgfCBXaGVyZS1PYmplY3QgeyAkXy5Jc3N1ZXIgLW1hdGNoICdDTj1NUy1Pcmdhbml6YXRpb24tQWNjZXNzJyB9CgogICAgICAgICAgICAgICAgICAgICMgT2J0YWluIHRoZSBBQUQgRGV2aWNlIElEIGZyb20gdGhlIGNlcnRpZmljYXRlCiAgICAgICAgICAgICAgICAgICAgJGlkID0gJGNlcnQuU3ViamVjdC5SZXBsYWNlKCdDTj0nLCcnKQoKICAgICAgICAgICAgICAgICAgICAjIEdldCB0aGUgdGVuYW50IG5hbWUgZnJvbSB0aGUgcmVnaXN0cnkKICAgICAgICAgICAgICAgICAgICAkdGVuYW50ID0gKEdldC1JdGVtUHJvcGVydHkgSEtMTTpcU1lTVEVNXEN1cnJlbnRDb250cm9sU2V0XENvbnRyb2xcQ2xvdWREb21haW5Kb2luXEpvaW5JbmZvXCQoJGlkKSkuVXNlckVtYWlsLlNwbGl0KCdAJylbMV0KICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAkdGVuYW50CiAgICAgICAgICAgICAgICAgICAgIyBHZW5lcmF0ZSB0aGUgYm9keSB0byBzZW5kIHRvIEFBRCBjb250YWluaW5nIHRoZSByZWNvdmVyeSBpbmZvcm1hdGlvbgogICAgICAgICAgICAgICAgICAgICMgR2V0IHRoZSBCaXRMb2NrZXIga2V5IGluZm9ybWF0aW9uIGZyb20gV01JCiAgICAgICAgICAgICAgICAgICAgKEdldC1CaXRMb2NrZXJWb2x1bWUgLU1vdW50UG9pbnQgJE9TRHJpdmUpLktleVByb3RlY3RvcnwgV2hlcmUtT2JqZWN0IHskXy5LZXlQcm90ZWN0b3JUeXBlIC1lcSAnUmVjb3ZlcnlQYXNzd29yZCd9IHwgRm9yRWFjaC1PYmplY3QgewogICAgICAgICAgICAgICAgICAgICAgICAka2V5ID0gJF8KICAgICAgICAgICAgICAgICAgICAgICAgd3JpdGUtdmVyYm9zZSAia2lkIDogJCgka2V5LktleVByb3RlY3RvcklkKSBrZXk6ICQoJGtleS5SZWNvdmVyeVBhc3N3b3JkKSIKICAgICAgICAgICAgICAgICAgICAgICAgJGJvZHkgPSAieyIia2V5IiI6IiIkKCRrZXkuUmVjb3ZlcnlQYXNzd29yZCkiIiwiImtpZCIiOiIiJCgka2V5LktleVByb3RlY3RvcklkLnJlcGxhY2UoJ3snLCcnKS5SZXBsYWNlKCd9JywnJykpIiIsIiJ2b2wiIjoiIk9TViIifSIKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBDcmVhdGUgdGhlIFVSTCB0byBwb3N0IHRoZSBkYXRhIHRvIGJhc2VkIG9uIHRoZSB0ZW5hbnQgYW5kIGRldmljZSBpbmZvcm1hdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAkdXJsID0gImh0dHBzOi8vZW50ZXJwcmlzZXJlZ2lzdHJhdGlvbi53aW5kb3dzLm5ldC9tYW5hZ2UvJHRlbmFudC9kZXZpY2UvJCgkaWQpP2FwaS12ZXJzaW9uPTEuMCIKICAgICAgICAgICAgICAgICAgICAgICAgTG9nc3RyaW5nICJDcmVhdGluZyB1cmwuLi4kdXJsIgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIFBvc3QgdGhlIGRhdGEgdG8gdGhlIFVSTCBhbmQgc2lnbiBpdCB3aXRoIHRoZSBBQUQgTWFjaGluZSBDZXJ0aWZpY2F0ZQogICAgICAgICAgICAgICAgICAgICAgICAkcmVxID0gSW52b2tlLVdlYlJlcXVlc3QgLVVyaSAkdXJsIC1Cb2R5ICRib2R5IC1Vc2VCYXNpY1BhcnNpbmcgLU1ldGhvZCBQb3N0IC1Vc2VEZWZhdWx0Q3JlZGVudGlhbHMgLUNlcnRpZmljYXRlICRjZXJ0CiAgICAgICAgICAgICAgICAgICAgICAgICRyZXEuUmF3Q29udGVudAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJD8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRTY3JpcHQ6SXNCYWNrdXBBQUQgPSAkdHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICB9ICAgIAogICAgICAgICAgICAgICAgICAgICAgICBMb2dTdHJpbmcgKCdQb3N0IHRoZSBkYXRhIHRvIHRoZSBVUkwgYW5kIHNpZ24gaXQgd2l0aCB0aGUgQUFEIE1hY2hpbmUgQ2VydGlmaWNhdGUuIFN1Y2Nlc3M/IHswfScgLWYgKCRTY3JpcHQ6SXNCYWNrdXBBQUQpKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2F0Y2ggewogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdFcnJvciB3aGlsZSBiYWNrdXAgdG8gQXp1cmUgQUQsIG1ha2Ugc3VyZSB0aGF0IHlvdSBhcmUgQUFEIGpvaW5lZCBhbmQgYXJlIHJ1bm5pbmcgdGhlIGNtZGxldCBhcyBhbiBhZG1pbi4nKQogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdFcnJvciBtZXNzYWdlOicgKyAiYHJgbiIgKyAoJF8pKQogICAgICAgICAgICAgICAgJElzQmFja3VwQUFEID0gJGZhbHNlCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmluYWxseSB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0RpZCBiYWNrdXAgdG8gQXp1cmUgQUQgU3VjY2VlZD8gezB9JyAtZiAoJFNjcmlwdDpJc0JhY2t1cEFBRCkpCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBCYWNrdXAgQXp1cmUgQUFECiAgICAgICAgCiAgICAgICAgCiAgICAgICAgIyBJZiBubyBiYWNrdXAgYW5kIG5vIFJlY292ZXJ5IFBhc3N3b3JkcyBwcmVzZW50CiAgICAgICAgCiAgICB9CiAgICBlbHNlIHsKICAgICAgICBMb2dXcml0ZSAnT1MgRHJpdmUgaXMgbm90IGVuY3J5cHRldCwgdGhlcmUgYXJlIG5vIFJlY292ZXJ5IFBhc3N3b3JkcywgYW5kIHRoZXJlIGFyZSBubyBiYWNrdXBzLicKICAgIH0KfQojZW5kcmVnaW9uIEJhY2t1cAojZW5kcmVnaW9uIE1haW4KCgoKIyMjIyMjIyMjIyMjIyMjIyMjIyMKIyMjIyMjICBHIFUgSSAjIyMjIyMKIyMjIyMjIyMjIyMjIyMjIyMjIyMKI3JlZ2lvbiBHVUkKaWYgKCRTY3JpcHQ6SXNFbmNyeXB0ZWQgLWFuZCAkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3IC1hbmQgJEdVSSkgewogICAgIyBTaG93IHJlYm9vdCBwcm9tcHQgdG8gdXNlcgogICAgTG9nV3JpdGUgIlByb21wdGluZyB1c2VyIHRvIFJlYm9vdCBjb21wdXRlci4iCiAgICAgICAgICAgCgogICAgW3ZvaWRdW1N5c3RlbS5SZWZsZWN0aW9uLkFzc2VtYmx5XTo6TG9hZFdpdGhQYXJ0aWFsTmFtZSgg4oCcU3lzdGVtLldpbmRvd3MuRm9ybXPigJ0pCiAgICBbdm9pZF1bU3lzdGVtLlJlZmxlY3Rpb24uQXNzZW1ibHldOjpMb2FkV2l0aFBhcnRpYWxOYW1lKCDigJxNaWNyb3NvZnQuVmlzdWFsQmFzaWPigJ0pCgogICAgJGZvcm0gPSBOZXctT2JqZWN0IOKAnFN5c3RlbS5XaW5kb3dzLkZvcm1zLkZvcm3igJ07CiAgICAkZm9ybS5XaWR0aCA9IDUwMDsKICAgICRmb3JtLkhlaWdodCA9IDE1MDsKICAgICRmb3JtLlRleHQgPSAiQml0TG9ja2VyIHJlcXVpcmVzIGEgcmVib290ICEiOwogICAgJGZvcm0uU3RhcnRQb3NpdGlvbiA9IFtTeXN0ZW0uV2luZG93cy5Gb3Jtcy5Gb3JtU3RhcnRQb3NpdGlvbl06OkNlbnRlclNjcmVlbjsKCiAgICAkRHJvcERvd25BcnJheSA9IEAoIjQ6SG91cnMiLCAiODpIb3VycyIsICIxMjpIb3VycyIsICIyNDpIb3VycyIpCiAgICAkRERMID0gTmV3LU9iamVjdCBTeXN0ZW0uV2luZG93cy5Gb3Jtcy5Db21ib0JveAogICAgJERETC5Mb2NhdGlvbiA9IE5ldy1PYmplY3QgU3lzdGVtLkRyYXdpbmcuU2l6ZSgxNDAsIDEwKQogICAgJERETC5TaXplID0gTmV3LU9iamVjdCBTeXN0ZW0uRHJhd2luZy5TaXplKDEzMCwgMzApCiAgICBGb3JFYWNoICgkSXRlbSBpbiAkRHJvcERvd25BcnJheSkgewogICAgICAgICREREwuSXRlbXMuQWRkKCRJdGVtKSB8IE91dC1OdWxsCiAgICB9CiAgICAkRERMLlNlbGVjdGVkSW5kZXggPSAwCgogICAgJGJ1dHRvbjEgPSBOZXctT2JqZWN0IOKAnFN5c3RlbS5XaW5kb3dzLkZvcm1zLmJ1dHRvbuKAnTsKICAgICRidXR0b24xLkxlZnQgPSA0MDsKICAgICRidXR0b24xLlRvcCA9IDg1OwogICAgJGJ1dHRvbjEuV2lkdGggPSAxMDA7CiAgICAkYnV0dG9uMS5UZXh0ID0g4oCcUmVib290IE5vd+KAnTsKICAgICRidXR0b24xLkFkZF9DbGljayggeyRnbG9iYWw6eGlucHV0ID0gIlJlYm9vdCI7ICRGb3JtLkNsb3NlKCl9KQoKICAgICRidXR0b24yID0gTmV3LU9iamVjdCDigJxTeXN0ZW0uV2luZG93cy5Gb3Jtcy5idXR0b27igJ07CiAgICAkYnV0dG9uMi5MZWZ0ID0gMTcwOwogICAgJGJ1dHRvbjIuVG9wID0gODU7CiAgICAkYnV0dG9uMi5XaWR0aCA9IDEwMDsKICAgICRidXR0b24yLlRleHQgPSDigJxQb3N0cG9uZeKAnTsKICAgICRidXR0b24yLkFkZF9DbGljayggeyRnbG9iYWw6eGlucHV0ID0gIlBvc3Rwb25lOiIgKyAkRERMLlRleHQ7ICRGb3JtLkNsb3NlKCl9KQoKICAgICRidXR0b24zID0gTmV3LU9iamVjdCDigJxTeXN0ZW0uV2luZG93cy5Gb3Jtcy5idXR0b27igJ07CiAgICAkYnV0dG9uMy5MZWZ0ID0gMjkwOwogICAgJGJ1dHRvbjMuVG9wID0gODU7CiAgICAkYnV0dG9uMy5XaWR0aCA9IDEwMDsKICAgICRidXR0b24zLlRleHQgPSDigJxDYW5jZWzigJ07CiAgICAkYnV0dG9uMy5BZGRfQ2xpY2soIHskZ2xvYmFsOnhpbnB1dCA9ICJQb3N0cG9uZTI0IjsgJEZvcm0uQ2xvc2UoKX0pCgoKICAgICRmb3JtLktleVByZXZpZXcgPSAkVHJ1ZQogICAgJGZvcm0uQWRkX0tleURvd24oIHtpZiAoJF8uS2V5Q29kZSAtZXEgIkVudGVyIikgCiAgICAgICAgeyR4ID0gJHRleHRCb3gxLlRleHQ7ICRmb3JtLkNsb3NlKCl9fSkKICAgICRmb3JtLkFkZF9LZXlEb3duKCB7aWYgKCRfLktleUNvZGUgLWVxICJFc2NhcGUiKSAKICAgICAgICB7JGZvcm0uQ2xvc2UoKX19KQoKICAgICRldmVudEhhbmRsZXIgPSBbU3lzdGVtLkV2ZW50SGFuZGxlcl0geyAKICAgICAgICAkYnV0dG9uMS5DbGljazsKICAgICAgICAkRHJvcERvd25BcnJheS5UZXh0OwogICAgICAgICRmb3JtLkNsb3NlKCk7IH07CgogICAgIyRidXR0b24uQWRkX0NsaWNrKCRldmVudEhhbmRsZXIpIDsKICAgICRmb3JtLkNvbnRyb2xzLkFkZCgkYnV0dG9uMSk7CiAgICAkZm9ybS5Db250cm9scy5BZGQoJGJ1dHRvbjIpOwogICAgJGZvcm0uQ29udHJvbHMuQWRkKCRidXR0b24zKTsKICAgICRmb3JtLkNvbnRyb2xzLkFkZCgkRERMKTsKICAgICRmb3JtLkNvbnRyb2xzLkFkZCgkdGV4dExhYmVsMSkKICAgICRyZXQgPSAkZm9ybS5TaG93RGlhbG9nKCk7CgogICAgaWYgKCRnbG9iYWw6eGlucHV0IC1lcSAiUmVib290Iikge3NodXRkb3duIC1yIC1mIC90IDYwMH0KICAgIGlmICgkZ2xvYmFsOnhpbnB1dCAtbGlrZSAiUG9zdHBvbmU6KjpIb3VycyIpIHsKICAgICAgICAkaHZhbCA9ICgoW2ludF0kZ2xvYmFsOnhpbnB1dC5zcGxpdCgiOiIpWzFdKSAqIDYwICogNjApCiAgICAgICAgc2h1dGRvd24gLXIgLWYgL3QgJGh2YWwKICAgIH0KICAgIGlmICgkZ2xvYmFsOnhpbnB1dCAtZXEgIlBvc3Rwb25lMjQiKSB7c2h1dGRvd24gLXIgLWYgL3QgODY0MDB9Cn0KI2VuZHJlZ2lvbiBHVUkKCgoKIyMjIyMjIyMjIyMjIyMjIyMjIyMKIyMjIyBFTkQgUkVTVUxUUyAjIyMKIyMjIyMjIyMjIyMjIyMjIyMjIyMKI3JlZ2lvbiBFbmQgUmVzdWx0cyAKTG9nV3JpdGUgKCcjIyMgRW5kIHJlc3VsdHMnKQojIENsZWFuaW5nIHVwIGlmIHN1Y2Nlc3MKaWYgKCRTY3JpcHQ6SXNGaW5pc2hlZDFzdFRpbWUpIHsKICAgIExvZ1dyaXRlICdGaW5pc2hlZCBmaXJzdCB0aW1lID0gVHJ1ZSB8IEp1c3QgY2hlY2tlZCB3ZWF0aGVyIEJpdExvY2tlciBSZWNvdmVyeSBQYXNzd29yZCBoYWQgY2hhbmdlZC4nCn0KCmVsc2UgewogICAgaWYgKCRTY3JpcHQ6SXNFbmNyeXB0ZWQgLWFuZCAkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3IC1hbmQgJFNjcmlwdDpJc0JhY2t1cEFBRCAtYW5kICRTY3JpcHQ6SXNCYWNrdXBPRCkgewogICAgICAgIEdldC1CaXRMb2NrZXJTdGF0dXMKICAgICAgICBpZiAoKCRTY3JpcHQ6Vm9sdW1lRW5jU3RhdHVzIC1lcSAkU2NyaXB0OkJpdExvY2tlclZvbHVtZUVuY3J5cHRpb25TdGF0dXNlc1syXSkgLWFuZCAoJFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzIC1lcSAxKSkgewogICAgICAgIAogICAgICAgICAgICAjIEZpcnN0IHN1Y2Nlc3NmdWxsIHJ1bgogICAgICAgICAgICAkU2NyaXB0OklzRmluaXNoZWQxc3RUaW1lID0gJHRydWUgCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFNjaGVkdWxlZFRhc2sKICAgICAgICAgICAgRWRpdC1TY2hlZHVsZWRUYXNrIC1UYXNrTmFtZSAkU2NyaXB0OlNjaGVkdWxlZFRhc2tOYW1lCgogICAgICAgICAgICAjIEZpbGVzCiAgICAgICAgICAgICNyZWdpb24gUmVtb3ZlIGZpbGVzCiAgICAgICAgICAgIGlmICgkU2NyaXB0OkJvb2xSZW1vdmVGaWxlc0FmdGVyU3VjY2VzcyAtYW5kICRTY3JpcHQ6SXNGaW5pc2hlZDFzdFRpbWUpIHsgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICRudWxsID0gU3RhcnQtSm9iIC1Bcmd1bWVudExpc3QgJFNjcmlwdDpGaWxlTG9nIC1TY3JpcHRCbG9jayB7CiAgICAgICAgICAgICAgICAgICAgUGFyYW0oW3N0cmluZ10gJEZpbGVMb2cpCiAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgRnVuY3Rpb24gTG9nV3JpdGUgewogICAgICAgICAgICAgICAgICAgICAgICBQYXJhbSAoW3N0cmluZ10kTG9nU3RyaW5nKQogICAgICAgICAgICAgICAgICAgICAgICBbc3RyaW5nXSAkYSA9IEdldC1EYXRlCiAgICAgICAgICAgICAgICAgICAgICAgIFtzdHJpbmddICRMb2dTdHJpbmcgPSAkYSwgJExvZ1N0cmluZwogICAgICAgICAgICAgICAgICAgICAgICBBZGQtY29udGVudCAtUGF0aCAkRmlsZUxvZyAtVmFsdWUgJExvZ1N0cmluZwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6UmVtRGlyUGF0aCA9ICgke2VudjpQcm9ncmFtRmlsZXMoeDg2KX0gKyAnXEJpdExvY2tlclRyaWdnZXJcJykKICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIFN0YXJ0LVNsZWVwIC1TZWNvbmRzIDUKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1N0YXJ0ZWQgdGhlIGpvYiB0byByZW1vdmUgInswfSInIC1mICgkTG9jYWw6UmVtRGlyUGF0aCkpCiAgICAgICAgICAgICAgICAgICAgaWYgKFRlc3QtUGF0aCAkTG9jYWw6UmVtRGlyUGF0aCkgewogICAgICAgICAgICAgICAgICAgICAgICBSZW1vdmUtSXRlbSAtUGF0aCAkTG9jYWw6UmVtRGlyUGF0aCAtUmVjdXJzZSAtRm9yY2UKICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdSZW1vdmluZyB0aGUgZm9sZGVyIChyZWN1cnNlLCBmb3JjZSkuIFN1Y2Nlc3M/IHswfScgLWYgKCQ/KSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnRm9sZGVyIGRvZXMgbm90IGV4aXN0JykKICAgICAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9CiAgICAgICAgICAgICNlbmRyZWdpb24gUmVtb3ZlIEZpbGVzCiAgICAgICAgfSAgICAKICAgIH0KICAgIGVsc2UgewogICAgICAgIExvZ1dyaXRlICdUaGVyZSBhcmUgc3RpbGwgdGhpbmdzIHRvIGRvLiBUcnlpbmcgYWdhaW4gbGF0ZXIuJwogICAgfQp9CiNlbmRyZWdpb24gRW5kIFJlc3VsdHMKCgoKIyMjIyMjIyMjIyMjIyMjIyMjIyMKIyMjIyBTIFQgQSBUIFMgIyMjIyMKIyMjIyMjIyMjIyMjIyMjIyMjIyMKTG9nV3JpdGUgKCcjIyMgU1RBVFMnKQokU2NyaXB0OkNvdW50UnVucyArPSAxCgppZiAoLW5vdCgkU2NyaXB0OkJvb2xSZW1vdmVGaWxlc0FmdGVyU3VjY2VzcykpIHsKICAgIGlmICgtbm90KFRlc3QtUGF0aCAkU2NyaXB0OkRpckluc3RhbGwpKSB7CiAgICAgICAgJG51bGwgPSBOZXctSXRlbSAtUGF0aCAkU2NyaXB0OkRpckluc3RhbGwgLUl0ZW1UeXBlIERpcmVjdG9yeSAtRm9yY2UKICAgIH0KICAgIAogICAgW3N0cmluZ10gJE91dFN0cmluZyA9ICgoJFNjcmlwdDpDb3VudFJ1bnMpLlRvU3RyaW5nKCkgKyAiYHJgbiIpICAgICAgICAgICAgICAgICAgICMgMAogICAgJE91dFN0cmluZyArPSAoKFtieXRlXSAkU2NyaXB0OklzRmluaXNoZWQxc3RUaW1lKS5Ub1N0cmluZygpICsgImByYG4iKSAgICAgICAgICAgICMgMQogICAgJE91dFN0cmluZyArPSAoKFtieXRlXSAkU2NyaXB0OklzRW5jcnlwdGVkKS5Ub1N0cmluZygpICsgImByYG4iKSAgICAgICAgICAgICAgICAgICMgMgogICAgJE91dFN0cmluZyArPSAoKFtieXRlXSAkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3KS5Ub1N0cmluZygpICsgImByYG4iKSAgICAgICAgICAgICMgMwogICAgJE91dFN0cmluZyArPSAoKFtieXRlXSAkU2NyaXB0OklzQmFja3VwT0QpLlRvU3RyaW5nKCkgKyAiYHJgbiIpICAgICAgICAgICAgICAgICAgICMgNAogICAgJE91dFN0cmluZyArPSAoKFtieXRlXSAkU2NyaXB0OklzQmFja3VwQUFEKS5Ub1N0cmluZygpICsgImByYG4iKSAgICAgICAgICAgICAgICAgICMgNQogICAgJE91dFN0cmluZyArPSAoKFtzdHJpbmddICRTY3JpcHQ6T1NEcml2ZUtleUlEKSArICJgcmBuIikgICAgICAgICAgICAgICAgICAgICAgICAgICMgNgogICAgJE91dFN0cmluZyArPSAoKFtzdHJpbmddICRTY3JpcHQ6T1NEcml2ZVByb3RlY3Rpb25QYXNzd29yZCkgKyAiYHJgbiIpICAgICAgICAgICAgICMgNwogICAKICAgIE91dC1GaWxlIC1GaWxlUGF0aCAkU2NyaXB0OkZpbGVTdGF0cyAtRW5jb2RpbmcgdXRmOCAtRm9yY2UgLUlucHV0T2JqZWN0ICgkT3V0U3RyaW5nKQp9CkxvZ1dyaXRlICgnUnVucyBzbyBmYXI6IHswfScgLWYgKCRTY3JpcHQ6Q291bnRSdW5zKSkKCmlmICgkU2NyaXB0OkJvb2xEaWRBbnl0aGluZ0NoYW5nZVRoaXNSdW50aW1lKSB7CiAgICBXcml0ZS1TdGF0cyAKfQoKCgojIyMgR2l2ZSB1cCBhZnRlciBYIHJ1bnMgYW5kIElzRmluaXNoZWQxc3RUaW1lIC1lcSAkZmFsc2UKaWYgKCRTY3JpcHQ6Q291bnRSdW5zIC1lcSAzMCAtYW5kICgtbm90KCRTY3JpcHQ6SXNGaW5pc2hlZDFzdFRpbWUpKSkgewogICAgTG9nV3JpdGUgKCdTaG91bGQgaGF2ZSBiZWVuIGRvbmUgYnkgbm93LicpCiAgICBFZGl0LVNjaGVkdWxlZFRhc2sgLVRhc2tOYW1lICRTY3JpcHQ6U2NoZWR1bGVkVGFza05hbWUKCiAgICBpZiAoJGZhbHNlKSB7CiAgICAgICAgIyMjIEdhdGhlcmluZyBpbmZvIGZvciB0aGUgZW1haWwKICAgICAgICBpZiAoLW5vdCgkU2NyaXB0OldpbmRvd3NWZXJzaW9uKSkgewogICAgICAgICAgICBDcmVhdGUtRW52VmFyaWFibGVzCiAgICAgICAgfQogICAgICAgICMjIyBCdWlsZGluZyBlbWFpbCBzdHJpbmcKICAgICAgICBbc3RyaW5nXSAkTG9jYWw6U3RyU3ViamVjdCA9ICgnQml0TG9ja2VyVHJpZ2dlciBmYWlsZWQgezB9IHRpbWVzIGZvciB0ZW5hbnQgInsxfSIsIGRldmljZTogInsyfSInIC1mICgkQ291bnRSdW5zLlRvU3RyaW5nKCksJExvY2FsOk5hbWVUZW5hbnQsJExvY2FsOk5hbWVDb21wdXRlcikpCiAgICAgICAgW3N0cmluZ10gJExvY2FsOlN0ckVtYWlsID0gW3N0cmluZ106OkVtcHR5CiAgICAgICAgJExvY2FsOlN0ckVtYWlsICs9ICgkTG9jYWw6U3RyU3ViamVjdCkKICAgICAgICAkTG9jYWw6U3RyRW1haWwgKz0gKCJgcmBuIikKICAgICAgICAkTG9jYWw6U3RyRW1haWwgKz0gKCJgcmBuIiArICcjIyBFbnZpcm9ubWVudCBpbmZvJykKICAgICAgICAkTG9jYWw6U3RyRW1haWwgKz0gKCJgcmBuIiArICdEZXZpY2UgbmFtZTogJyArICRTY3JpcHQ6Q29tcHV0ZXJOYW1lICsgJyB8IE1hbnVmYWN0dXJlcjogJyArICRTY3JpcHQ6Q29tcHV0ZXJNYW51ZmFjdHVyZXIgKyAnIHwgTW9kZWw6ICcgKyAkU2NyaXB0OkNvbXB1dGVyUHJvZHVjdE5hbWUpIAogICAgICAgICRMb2NhbDpTdHJFbWFpbCArPSAoImByYG4iICsgJ1dpbmRvd3MgRWRpdGlvbjogJyArICRTY3JpcHQ6V2luZG93c0VkaXRpb24gKyAnIHwgV2luZG93cyBWZXJzaW9uJyArICRTY3JpcHQ6V2luZG93c1ZlcnNpb24pCiAgICAgICAgJExvY2FsOlN0ckVtYWlsICs9ICgiYHJgbmByYG4iICsgJ1RoZXJlIGhhdmUgbm93IGJlZW4gezB9IHJ1bnMsIGJ1dCBCaXRMb2NrZXJUcmlnZ2VyIFNUSUxMIGZhaWxzLicgLWYgKCRTY3JpcHQ6Q291bnRSdW5zKSkKICAgICAgICAkTG9jYWw6U3RyRW1haWwgKz0gKCJgcmBuIiArICdTdWNjZXNzIHN0YXR1cyB8IEVuY3J5cHRlZCA6IHswfSB8IFByb3RlY3Rpb24gUGFzc3dvcmRzIHByZXNlbnQgOiB7MX0gfCBCYWNrdXAgdG8gQXp1cmVBRCA6IHsyfSB8IEJhY2t1cCB0byBPbmVEcml2ZSA6IHszfScgLWYgKCRTY3JpcHQ6SXNFbmNyeXB0ZWQsJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdywkU2NyaXB0OklzQmFja3VwQUFELCRTY3JpcHQ6SXNCYWNrdXBPRCkpCiAgICAgICAgTG9nV3JpdGUgKCRMb2NhbDpTdHJFbWFpbCkKICAgICAgICA8IyMjIFNlbmQgZW1haWwKICAgICAgICAjIyBNYWlsIGFkZHJlc3MoZXMpCiAgICAgICAgW3N0cmluZ10gJExvY2FsOlN0clRvRW1haWxBZGRyZXNzID0gJ09sYXYgUi4gQmlya2VsYW5kIDxvbGF2YkBpcm9uc3RvZWl0LmNvbT47JwogICAgICAgICMkU3RyRW1haWxBZGRyZXNzICs9ICdJcm9uc3RvbmUgU2VydmljZWRlc2sgPHNlcnZpY2VkZWtzQGlyb25zdG9uZWl0LmNvbT4nCiAgICAgICAgW3N0cmluZ10gJExvY2FsOlN0ckZyb21FbWFpbEFkZHJlc3MgPSAoJ0JpdExvY2tlclRyaWdnZXJGYWlsQHswfScgLWYgKCRTY3JpcHQ6TmFtZVRlbmFudCkpCiAgICAgICAgI1NlbmQtTWFpbE1lc3NhZ2UgLVRvICRMb2NhbDpTdHJUb0VtYWlsQWRkcmVzcyAtU210cFNlcnZlciAgLUZyb20gJExvY2FsOlN0ckZyb21FbWFpbEFkZHJlc3MgLVN1YmplY3QgJExvY2FsOlN0clN1YmplY3QgLUJvZHkgJExvY2FsOlN0ckVtYWlsCiAgICAgICAgIz4KICAgIH0KfQoKCgoKCiMjIyMjIyMjIyMjIyMjIyMjIyMjCiMjIyMgIEQgTyBOIEUgICMjIyMjCiMjIyMjIyMjIyMjIyMjIyMjIyMjCkxvZ1dyaXRlICgnQWxsIGRvbmUsIGV4aXRpbmcgc2NyaXB0Li4uJykKI2VuZHJlZ2lvbiBNYWlu')
        #endregion FilePS1
    #endregion Files
#endregion Variables



#region Functions
    #region    FileOut-FromBase64
        Function FileOut-FromBase64 {
            [CmdLetBinding()]

            # Parameters
            Param(
                [Parameter(Mandatory=$true)]
                [ValidateNotNullOrEmpty()]
                [string] $PathDirOut,
            
                [Parameter(Mandatory=$true)]
                [ValidateNotNullOrEmpty()]
                [string] $NameFileOut,
            
                [Parameter(Mandatory=$true)]
                [ValidateNotNullOrEmpty()]
                [string] $ContentFileOut, 
            
                [Parameter(Mandatory=$true)]
                [ValidateSet('utf8','default')]
                [string] $EncodingFileOut,

                [Parameter(Mandatory=$false)]
                [Switch] $Force
            )

            # Output Debug Info
            [byte] $SubstringLength = $(if($ContentFileOut.Length -lt 10){$ContentFileOut.Length}else{10})
            Write-Debug -Message ('FileOut-FromBase64 -PathDirOut "{0}" -NameFileOut "{1}" -ContentFileOut "{2}" -EncodingFileOut "{3}"' -f ($PathDirOut,$NameFileOut,($ContentFileOut.Substring(0,$SubstringLength)+'...'),$EncodingFileOut))
        

            # If writing to Program Files, and not admin
            if ($PathDirOut -like '*Program Files\*' -and (-not([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator))) {
                Throw ('Cannot write to "{0}" without admin rights!' -f ($PathDirOut))
            }
            else {
                # Create Install Dir if not exist
                if(-not(Test-Path -Path $PathDirOut)){$null = New-Item -Path $PathDirOut -ItemType 'Directory' -Force}
                
                # Continue only if Install Dir exist    
                if (Test-Path -Path $PathDirOut) {
                    [string] $Local:PathFileOut = ('{0}{1}{2}' -f ($PathDirOut,($(if($PathDirOut[-1] -ne '\'){'\'})) + $NameFileOut)).Replace('\\','\')
                    Write-Verbose -Message ('   Path exists, trying to write the file (File alrady exists? {0}).' -f (Test-Path -Path $Local:PathFileOut))
                    if (-not($ReadOnly)) {
                        Out-File -FilePath $Local:PathFileOut -Encoding $EncodingFileOut -InputObject ([System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($ContentFileOut))) -Force:$Force
                        Write-Verbose -Message ('      Success? {0}.' -f ($?))
                        Write-Verbose -Message ('         Does file actually exist? {0}.' -f (Test-Path -Path $Local:PathFileOut -ErrorAction 'SilentlyContinue'))
                    }
                }
                else {
                    Throw ('ERROR: Install Path does not exist.')
                }
            }
        }
    #endregion FileOut-FromBase64
#endregion Functions



#region Main
    Write-Output -InputObject ('### {0}' -f ($NameScript))



    ###########################################################
    ### 1. Clean up BitLockerTrigger and IronTrigger
    Write-Output -InputObject ("`r`n`r`n" + '# 1. Clean up previous install paths.')
    
    # Paths
    Write-Verbose -Message ('Remove previous install path(s) if present')
    # Get Directory Paths
    [string[]] $Local:RemPaths = @(
        # Install Directory used in this script
        ($Script:PathDirInstall),
        # Install Dirs matching "*Trigger*" or "*BitLocker*" is ProgramFiles x64
        @(Get-ChildItem -Path ('{0}\IronstoneIT\' -f ($env:ProgramW6432)) -Directory -ErrorAction 'SilentlyContinue' | Where-Object {$_.Name -like '*trigger*' -or $_.Name -like '*BitLocker*'} | Select-Object -ExpandProperty 'FullName'),
        # Install Dirs matching "*Trigger*" or "*BitLocker*" is ProgramFiles x86
        @(Get-ChildItem -Path ('{0}\IronstoneIT\' -f (${env:ProgramFiles(x86)})) -Directory -ErrorAction 'SilentlyContinue' | Where-Object {$_.Name -like '*trigger*' -or $_.Name -like '*BitLocker*'} | Select-Object -ExpandProperty 'FullName')
    )
    # Remove Directory Paths
    $Local:RemPaths | ForEach-Object {
        if (-not([string]::IsNullOrEmpty($_.Trim()))) {
            Write-Verbose -Message ('   Removing "{0}" if it exists.' -f ($_))
            if (Test-Path -Path "$_") {
                Remove-Item -Path "$_" -Force -Recurse
                Write-Verbose -Message ('      Directory does exist. Removing. Success? {0}' -f ($?))
            }
            else {
                Write-Verbose -Message ('      Directory does not exist')
            }
        }
    }
    
    # Stats and Logs
    Write-Verbose -Message ('Remove previous files: Stats and Logs')
    @(Get-ChildItem -Path ('{0}\Temp' -f ($env:windir)) -File -ErrorAction 'SilentlyContinue' | Where-Object {$_.Name -like '*trigger*'} | Select-Object -ExpandProperty 'FullName') | ForEach-Object {
        Remove-Item -Path $_ -Force
        Write-Verbose -Message ('Removing "{0}". Success? {1}.' -f ($_,$?.ToString()))
    }
    Get-ChildItem -Path $PathDirLog -Name '*EnableBitLocker.log' -File -Force -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'PSChildName' | ForEach-Object {Remove-Item -Path ('{0}{1}' -f ($PathDirLog,$_)) -Force}

    # Scheduled tasks
    Write-Verbose -Message ('Remove previous ScheduledTask(s)')
    $Local:ScheduledTasks = Get-ScheduledTask | Where-Object {
        # Exact Name
        @($Script:NameScheduledTask,'IronTrigger','Enable_BitLocker').Contains($_.TaskName) -or `
        # Regex
        $_.TaskName -like '*BitLocker' -or $_.TaskName -like '*IronTrigger*'
    }
    
    if ($Local:ScheduledTasks.length -gt 0) {
        $Local:ScheduledTasks | ForEach-Object {             
            $null = Unregister-ScheduledTask -TaskName $_.TaskName -Confirm:$false -ErrorAction 'SilentlyContinue'
            Write-Verbose -Message ('  Removing the Scheduled task "{0}". Success? {1}' -f ($_.TaskName,$?))
        }
    }
    else {
        if (Get-ScheduledTask -TaskName $Script:NameScheduledTask -ErrorAction 'SilentlyContinue') {            
            $null = Unregister-ScheduledTask -TaskName $Script:NameScheduledTask -Confirm:$false -ErrorAction 'SilentlyContinue'
            Write-Verbose -Message ('  Removing the Scheduled task "{0}". Success? {1}' -f ($Script:NameScheduledTask,$?))
        }
        else {
            Write-Verbose -Message ('  Scheduled task "{0}" does not exist.' -f ($Script:ScheduledTaskName))
        }
    }




    ###########################################################
    ### 2. Install Files
    Write-Output -InputObject ("`r`n`r`n" + '# 2. Install files.')
    FileOut-FromBase64 -PathDirOut $Script:PathDirInstall -NameFileOut $Script:NameFilePS1 -ContentFileOut $Script:ContentFilePS1 -EncodingFileOut 'utf8' -Force    
    [bool] $SuccessInstallFile = $?
    Write-Verbose -Message ('   Success? {0}' -f ($SuccessInstallFile))
    if (-not($SuccessInstallFile)) {Break}



    
    ###########################################################
    ### 3. Surpress BitLocker Toast Notifications
    Write-Output -InputObject ("`r`n`r`n" + '# 3. Surpress BitLocker Toast Notifications.')

    # Get Current User as SecurityIdentifier
    if (-not($Script:PathDirRootCU)){
        [string] $Script:PathDirRootCU = ('HKU:\{0}\' -f ([System.Security.Principal.NTAccount]::new((Get-Process -Name 'explorer' -IncludeUserName | Select-Object -ExpandProperty UserName -First 1)).Translate([System.Security.Principal.SecurityIdentifier]).Value))
        if((-not($?)) -or [string]::IsNullOrEmpty($PathDirRootCU)){Break}
    }
    
    # Add HKU:\ as PSDrive if not already
    if ((Get-PSDrive -Name 'HKU' -ErrorAction SilentlyContinue) -eq $null) {$null = New-PSDrive -PSProvider Registry -Name 'HKU' -Root 'HKEY_USERS'}

    # Set REG value
    [string] $RegDir = ('{0}\Software\Microsoft\Windows\CurrentVersion\Notifications\Settings\Windows.SystemToast.BitLockerPolicyRefresh' -f ($PathDirRootCU))
    if (-not(Test-Path -Path $RegDir)) {New-Item -Path $RegDir -ItemType 'Directory' -Force}
    $null = Set-ItemProperty -Path $RegDir -Name 'Enabled' -Value 0 -Type 'DWord' -Force
    Write-Verbose -Message ('   Success? {0}' -f ($?))




    ###########################################################
    ### 4. Create ScheduledTask and run it if success
    Write-Output -InputObject ("`r`n`r`n" + '# 4. Create Scheduled Task "{0}", run it if success.' -f ($Script:NameScheduledTask))
    # Get path of PowerShell.exe and the .PS1 file
    [string] $PathFilePowerShell = '%SystemRoot%\system32\WindowsPowerShell\v1.0\powershell.exe' # Works regardless of 64bit vs 32bit
    [string] $PathFilePS1        = ('{0}\{1}' -f ($Script:PathDirInstall,$Script:NameFilePS1))
    # Create Scheduled Task
    #region    Create Scheduled Task running PS1 using PowerShell.exe - Every 15 Minutes
        $ScheduledTask = New-ScheduledTask                                                    `
            -Action    (New-ScheduledTaskAction -Execute ('"{0}"' -f ($PathFilePowerShell)) -Argument ('-ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -WindowStyle Hidden -File "{0}"' -f ($PathFilePS1))) `
            -Principal (New-ScheduledTaskPrincipal -UserId 'NT AUTHORITY\SYSTEM' -RunLevel 'Highest')                                                                                                                   `
            -Trigger   (New-ScheduledTaskTrigger -Once -At ([DateTime]::Today.AddHours(12)) -RepetitionInterval ([TimeSpan]::FromMinutes(15)))                                                                          `
            -Settings  (New-ScheduledTaskSettingsSet -Hidden -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -ExecutionTimeLimit ([TimeSpan]::FromMinutes(10)) -Compatibility 4 -StartWhenAvailable)
        $ScheduledTask.Author      = 'Ironstone'
        $ScheduledTask.Description = ('Runs a PowerShell script.{0} "{1}" -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -WindowStyle Hidden -File "{2}".' -f ("`r`n",$PathFilePowerShell,$PathFilePS1))
        $null = Register-ScheduledTask -TaskName $NameScheduledTask -InputObject $ScheduledTask -Force -Verbose:$false -Debug:$false
        if ($?) {$null = Start-ScheduledTask -TaskName $NameScheduledTask}
    #endregion Create Scheduled Task running PS1 using PowerShell.exe - Every 15 Minutes
    Write-Verbose -Message ('Success? {0}.' -f ($?))




    ###########################################################
    ### Done
    Write-Output -InputObject ("`r`n`r`n" + 'Done.')    
#endregion Main



################################################
#endregion Your Code Here
################################################   
#region    Don't touch this
}
Catch {
    # Construct Message
    $ErrorMessage = ('{0} finished with errors:' -f ($NameScriptFull))
    $ErrorMessage += " `n"
    $ErrorMessage += 'Exception: '
    $ErrorMessage += $_.Exception
    $ErrorMessage += " `n"
    $ErrorMessage += 'Activity: '
    $ErrorMessage += $_.CategoryInfo.Activity
    $ErrorMessage += " `n"
    $ErrorMessage += 'Error Category: '
    $ErrorMessage += $_.CategoryInfo.Category
    $ErrorMessage += " `n"
    $ErrorMessage += 'Error Reason: '
    $ErrorMessage += $_.CategoryInfo.Reason
    Write-Error -Message $ErrorMessage
}
Finally {
    Stop-Transcript
}
#endregion Don't touch this