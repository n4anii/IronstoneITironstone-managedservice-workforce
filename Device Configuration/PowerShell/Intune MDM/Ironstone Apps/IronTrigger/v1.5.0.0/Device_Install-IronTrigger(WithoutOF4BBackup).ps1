<#

.SYNOPSIS
    Installs PowerShell script "Enable_BitLocker.ps1", creates Scheduled Task that runs it.

.DESCRIPTION
    Installs PowerShell script "Enable_BitLocker.ps1", creates Scheduled Task that runs it.
    
    How to
        Convert Enable_BitLocker.ps1 to Base64
            * https://www.base64encode.org/
                * Destination charset: UTF8
                * Newline separator: LF (Linux)

.NOTES
    * In Intune, remember to set "Run this script using the logged in credentials"  according to the $DeviceContext variable.
        * Intune -> Device Configuration -> PowerShell Scripts -> $NameScriptFull -> Properties -> "Run this script using the logged in credentials"
        * DEVICE (Local System) or USER (Logged in user).
    * Only edit $NameScript and add your code in the #region Your Code Here.
    * You might want to touch "Settings - PowerShell - Output Preferences" for testing / development. 
        * $VerbosePreference, eventually $DebugPreference, to 'Continue' will print much more details.

#>


# Script Variables
$NameScript            = [string] 'Install-IronTrigger'
$DeviceContext         = [bool]   $true
$WriteToHKCUFromSystem = [bool]   $true

# Settings - PowerShell - Output Preferences
$DebugPreference       = 'SilentlyContinue'
$VerbosePreference     = 'SilentlyContinue'
$WarningPreference     = 'Continue'

#region    Don't Touch This
# Settings - PowerShell - Interaction
$ConfirmPreference     = 'None'
$InformationPreference = 'SilentlyContinue'
$ProgressPreference    = 'SilentlyContinue'

# Settings - PowerShell - Behaviour
$ErrorActionPreference = 'Continue'

# Dynamic Variables - Process & Environment
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'NameScriptFull' -Value ([string]('{0}_{1}' -f ($(if($DeviceContext){'Device'}else{'User'}),$NameScript)))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'NameScriptVerb' -Value ([string]$NameScript.Split('-')[0])
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'NameScriptNoun' -Value ([string]$NameScript.Split('-')[-1])
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrArchitectureProcess' -Value ([string]$(if([System.Environment]::Is64BitProcess){'64'}else{'32'}))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrArchitectureOS' -Value ([string]$(if([System.Environment]::Is64BitOperatingSystem){'64'}else{'32'}))

# Dynamic Variables - User
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrUserNameRunningAs' -Value ([string]$([System.Security.Principal.WindowsIdentity]::GetCurrent().'Name'))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrSIDRunningAs' -Value ([string]$([System.Security.Principal.WindowsIdentity]::GetCurrent().'User'.'Value'))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'BoolIsAdmin'  -Value ([bool]$(([System.Security.Principal.WindowsPrincipal]$([System.Security.Principal.WindowsIdentity]::GetCurrent())).IsInRole([System.Security.Principal.WindowsBuiltInRole]::Administrator)))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'BoolIsSystem' -Value ([bool]$($Script:StrSIDRunningAs -like ([string]$('S-1-5-18'))))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'BoolIsCorrectUser' -Value ([bool]$(if($Script:DeviceContext -and $Script:BoolIsSystem){$true}elseif(((-not($DeviceContext))) -and (-not($Script:BoolIsSystem))){$true}else{$false}))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'BoolWriteToHKCUFromSystem' -Value ([bool]$(if($DeviceContext -and $WriteToHKCUFromSystem){$true}else{$false}))

# Dynamic Variables - Logging
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'Timestamp' -Value ([string]$([datetime]::Now.ToString('yyMMdd-HHmmssffff')))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'PathDirLog' -Value ([string]$('{0}\IronstoneIT\Intune\DeviceConfiguration\' -f ([string]$(if($BoolIsSystem){$env:ProgramW6432}else{[System.Environment]::GetEnvironmentVariable('AppData')}))))
$null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'PathFileLog' -Value ([string]$('{0}{1}-{2}bit-{3}.txt' -f ($Script:PathDirLog,$Script:NameScriptFull,$Script:StrArchitectureProcess,$Script:Timestamp)))

# Start Transcript
if (-not(Test-Path -Path $Script:PathDirLog)) {$null = New-Item -ItemType 'Directory' -Path $Script:PathDirLog -ErrorAction 'Stop'}
Start-Transcript -Path $Script:PathFileLog -ErrorAction 'Stop'


# Wrap in Try/Catch, so we can always end the transcript
Try {
    # Output User Info, Exit if not $BoolIsCorrectUser
    Write-Output -InputObject ('Running as user "{0}" ({1}). Has admin privileges? {2}. $DeviceContext? {3}. Running as correct user? {4}.' -f ($Script:StrUserNameRunningAs,$Script:StrSIDRunningAs,$Script:BoolIsAdmin.ToString(),$Script:DeviceContext.ToString(),$Script:BoolIsCorrectUser.ToString()))
    if (-not($Script:BoolIsCorrectUser)){Throw 'Not running as correct user!'; Break}


    # Output Process and OS Architecture Info
    Write-Output -InputObject ('PowerShell is running as a {0} bit process on a {1} bit OS.' -f ($Script:StrArchitectureProcess,$Script:StrArchitectureOS))


    # If OS is 64 bit, and PowerShell got launched as x86, relaunch as x64
    if ([System.Environment]::Is64BitOperatingSystem -and -not [System.Environment]::Is64BitProcess) {
        write-Output -InputObject (' * Will restart this PowerShell session as x64.')
        if (-not([string]::IsNullOrEmpty($MyInvocation.'Line'))) {& ('{0}\sysnative\WindowsPowerShell\v1.0\powershell.exe' -f ($env:windir)) -NonInteractive -NoProfile $MyInvocation.'Line'}
        else {& ('{0}\sysnative\WindowsPowerShell\v1.0\powershell.exe' -f ($env:windir)) -NonInteractive -NoProfile -File ('{0}' -f ($MyInvocation.'InvocationName')) $args}
        exit $LASTEXITCODE
    }

    
    #region    Get SID and "Domain\Username" for Intune User only if $WriteToHKCUFromSystem
        # If running in Device Context as "NT Authority\System"
        if ($DeviceContext -and $Script:BoolIsSystem -and $BoolWriteToHKCUFromSystem) {
            # Help Variables
            $Script:RegistryLoadedProfiles = [string[]]@()
            $Local:SID                     = [string]::Empty
            $Local:LengthInterval          = [byte[]]@(40 .. 80)


            # Load User Profiles NTUSER.DAT (Registry) that is not available from current context
            $PathProfileList = [string]('Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProfileList')
            $SIDsProfileList = [string[]]@(Get-ChildItem -Path $PathProfileList -Recurse:$false | Select-Object -ExpandProperty 'Name' | ForEach-Object -Process {$_.Split('\')[-1]} | Where-Object -FilterScript {$_ -like 'S-1-12-*'})
            foreach ($SID in $SIDsProfileList) {
                if (Test-Path -Path ('Registry::HKEY_USERS\{0}' -f ($SID)) -ErrorAction 'SilentlyContinue') {
                    Write-Output -InputObject ('User with SID "{0}" is already logged in and/or NTUSER.DAT is loaded.' -f ($SID))
                }
                else {
                    Write-Output -InputObject ('User with SID "{0}" is not logged in, thus NTUSER.DAT is not loaded into registry.' -f ($SID))
                    
                    # Get User Directory
                    $PathUserDirectory = [string]$(Get-ItemProperty -Path ('{0}\{1}' -f ($PathProfileList,$SID)) -Name 'ProfileImagePath' | Select-Object -ExpandProperty 'ProfileImagePath')
                    if ([string]::IsNullOrEmpty($PathUserDirectory)) {
                        Throw ('ERROR: No User Directory was found for user with SID "{0}".' -f ($SID))
                    }

                    # Get User Registry File, NTUSER.DAT
                    $PathFileUserRegistry = ('{0}\NTUSER.DAT' -f ($PathUserDirectory))
                    if (-not(Test-Path -Path $PathFileUserRegistry)) {
                        Throw ('ERROR: "{0}" does not exist.' -f ($PathFileUserRegistry))
                    }

                    # Load NTUSER.DAT
                    $null = Start-Process -FilePath ('{0}\reg.exe' -f ([string]([system.environment]::SystemDirectory))) -ArgumentList ('LOAD "HKEY_USERS\{0}" "{1}"' -f ($SID,$PathFileUserRegistry)) -WindowStyle 'Hidden' -Wait
                    if (Test-Path -Path ('Registry::HKEY_USERS\{0}' -f ($SID))) {
                        Write-Output -InputObject ('{0}Successfully loaded "{1}".' -f ("`t",$PathFileUserRegistry))
                        $RegistryLoadedProfiles += @($SID)
                    }
                    else {
                        Throw ('ERROR: Failed to load registry hive for SID "{0}", NTUSER.DAT location "{1}".' -f ($SID,$PathFileUserRegistry))
                    }
                }
            }


            # Get Intune User Information from Registry
            $IntuneUser = [PSCustomObject]([PSCustomObject[]]@(
                foreach ($x in [string[]]@(Get-ChildItem -Path 'Registry::HKEY_USERS' -Recurse:$false -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'Name' | ForEach-Object {$_.Split('\')[-1]} | Where-Object {[bool]$($_ -like 'S-1-12-*') -and [bool]$(Test-Path -Path ('Registry::HKEY_USERS\{0}\Software\IronstoneIT\Intune\UserInfo' -f ($_)))})) {
                    [PSCustomObject]@{
                        'IntuneUserSID' =[string](Get-ItemProperty -Path ('Registry::HKEY_USERS\{0}\Software\IronstoneIT\Intune\UserInfo' -f ($x)) -Name 'IntuneUserSID' -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'IntuneUserSID');
                        'IntuneUserName'=[string](Get-ItemProperty -Path ('Registry::HKEY_USERS\{0}\Software\IronstoneIT\Intune\UserInfo' -f ($x)) -Name 'IntuneUserName' -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'IntuneUserName');
                        'DateSet'       =Try{[datetime](Get-ItemProperty -Path ('Registry::HKEY_USERS\{0}\Software\IronstoneIT\Intune\UserInfo' -f ($x)) -Name 'DateSet' -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'DateSet')}Catch{[datetime]::MinValue};
                    }
                }) | Where-Object {-not([string]::IsNullOrEmpty($_.IntuneUserSID) -or [string]::IsNullOrEmpty($_.IntuneUserName))} | Sort-Object -Property 'DateSet' -Descending:$false | Select-Object -Last 1
            )


            # Get Intune User SID
            $null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrIntuneUserSID' -Value (
                [string]$(
                    $Local:SID = [string]::Empty
                    # Try by registry values in HKEY_CURRENT_USER\Software\IronstoneIT\Intune\UserInfo
                    if (-not([string]::IsNullOrEmpty([string]($IntuneUser | Select-Object -ExpandProperty 'IntuneUserSID')))) {
                        $Local:SID = [string]($IntuneUser | Select-Object -ExpandProperty 'IntuneUserSID')
                    }

                    # If no valid SID yet, try Registry::HKEY_USERS
                    if ([string]::IsNullOrEmpty($Local:SID) -or (-not($Local:LengthInterval.Contains([byte]$Local:SID.Length))) -or (-not(Test-Path -Path ('Registry::HKEY_USERS\{0}' -f ($Local:SID)) -ErrorAction 'SilentlyContinue'))) {
                        # Get all potential SIDs from Registry::HKEY_USERS
                        $Local:SIDsFromRegistryAll = [string[]]@(Get-ChildItem -Path 'Registry::HKEY_USERS' -Recurse:$false -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'Name' | ForEach-Object {$_.Split('\')[-1]} | Where-Object {$_ -like 'S-1-12-*' -and $_ -notlike '*_Classes' -and $Local:LengthInterval.Contains([byte]$_.'Length')})
                        $Local:SID = [string]$(
                            # If none where found - Return emtpy string: Finding SID by registry will not be possible
                            if (@($Local:SIDsFromRegistryAll).'Count' -le 0) {
                                [string]::Empty
                            }
                            # If only one where found - Return it
                            elseif (@($Local:SIDsFromRegistryAll).'Count' -eq 1) {
                                [string]([string[]]@($Local:SIDsFromRegistryAll | Select-Object -First 1))
                            }
                            # If multiple where found - Try to filter out unwanted SIDs
                            else {
                                # Try to get all where IronstoneIT folder exist withing HKU (HKCU) registry
                                $Local:SIDs = [string[]]@([string[]]@($Local:SIDsFromRegistryAll) | Where-Object {Test-Path -Path ('Registry::HKEY_USERS\{0}\Software\IronstoneIT' -f ($_))})
                                # If none or more than 1 where found - Try getting only SIDs with AAD joined info in HKU (HKCU) registry
                                if (@($Local:SIDs).'Count' -le 0 -or @($Local:SIDs).'Count' -ge 2) {
                                    $Local:SIDs = [string[]]@([string[]]@($Local:SIDsFromRegistryAll) | Where-Object {Test-Path -Path ('Registry::HKEY_USERS\{0}\Software\Microsoft\Windows NT\CurrentVersion\WorkplaceJoin\AADNGC' -f ($_))})
                                }
                                # If none or more than 1 where found - Try matching Tenant ID for AAD joined HKLM with Tenant ID for AAD joined HKU (HKCU)
                                if (@($Local:SIDs).'Count' -le 0 -or @($Local:SIDs).'Count' -ge 2) {
                                    if (-not([string]::IsNullOrEmpty(($Local:TenantGUIDFromHKLM = [string]$($x='Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\CloudDomainJoin\JoinInfo'; Get-ItemProperty -Path ('{0}\{1}' -f ($x,[string](Get-ChildItem -Path $x -Recurse:$false -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'Name' | ForEach-Object {$_.Split('\')[-1]}))) -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'TenantId'))))) {
                                        $Local:SIDs = [string[]]@(@($Local:SIDsFromRegistryAll) | Where-Object {$Local:TenantGUIDFromHKLM -eq ([string]$($x=[string]('Registry::HKEY_USERS\{0}\Software\Microsoft\Windows NT\CurrentVersion\WorkplaceJoin\AADNGC' -f ($_)); Get-ItemProperty -Path ('{0}\{1}' -f ($x,([string](Get-ChildItem -Path $x -Recurse:$false -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'Name' | ForEach-Object {$_.Split('\')[-1]})))) -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'TenantDomain'))})
                                    }
                                }
                                if(@($Local:SIDs).'Count' -eq 1){
                                    [string]([string[]]@($Local:SIDs | Select-Object -First 1))
                                }
                                else{
                                    [string]::Empty
                                }
                            }
                        )
                    }

                    # If no valid SID yet, try by running process "Explorer"
                    if ([string]::IsNullOrEmpty($Local:SID) -or (-not($Local:LengthInterval.Contains([byte]$Local:SID.'Length'))) -or (-not(Test-Path -Path ('Registry::HKEY_USERS\{0}' -f ($Local:SID)) -ErrorAction 'SilentlyContinue'))) {
                        $Local:SID = [string]$(
                            $Local:UN = [string]([string[]]@(Get-WmiObject -Class 'Win32_Process' -Filter "Name='Explorer.exe'" -ErrorAction 'SilentlyContinue' | ForEach-Object {$($Owner = $_.GetOwner();if($Owner.'ReturnValue' -eq 0 -and $Owner.'Domain' -notlike 'nt *' -and $Owner.'Domain' -notlike 'nt-*'){('{0}\{1}' -f ($Owner.'Domain',$Owner.'User'))})}) | Select-Object -Unique -First 1)
                            if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.'Length' -lt 3) {
                                $Local:UN = [string]([string[]]@(Get-Process -Name 'explorer' -IncludeUserName -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'UserName' | Where-Object {$_ -notlike 'nt *' -and $_ -notlike 'nt-*'}) | Select-Object -Unique -First 1)
                            }
                            if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.'Length' -lt 3) {
                                [string]::Empty
                            }
                            else {
                                Try{
                                    $Local:SID = [string]$([System.Security.Principal.NTAccount]::new($Local:UN).Translate([System.Security.Principal.SecurityIdentifier]).'Value')
                                    if ([string]::IsNullOrEmpty($Local:SID) -or (-not($Local:LengthInterval.Contains([byte]$Local:SID.'Length'))) -or (-not(Test-Path -Path ('Registry::HKEY_USERS\{0}' -f ($Local:SID)) -ErrorAction 'SilentlyContinue'))) {
                                        [string]::Empty
                                    }
                                    else {
                                        $Local:SID
                                    }
                                }
                                catch{
                                    [string]::Empty
                                }
                            }
                        )
                    }
                
                    # If no valid SID yet, throw error
                    if ([string]::IsNullOrEmpty($Local:SID) -or (-not($Local:LengthInterval.Contains([byte]$Local:SID.'Length'))) -or (-not(Test-Path -Path ('Registry::HKEY_USERS\{0}' -f ($Local:SID)) -ErrorAction 'SilentlyContinue'))) {
                        Throw 'ERROR: Did not manage to get Intune user SID from SYSTEM context'
                    }

                    # If valid SID, return it
                    else {
                        $Local:SID
                    }         
                )
            )
        

            # Get Intune User Domain\UserName
            $null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrIntuneUserName' -Value (
                [string]$(
                    # Help Variables
                    $Local:UN = [string]::Empty

                    # Try by registry values in HKEY_CURRENT_USER\Software\IronstoneIT\Intune\UserInfo
                    if (-not([string]::IsNullOrEmpty($IntuneUser.'IntuneUserName'))) {
                        $Local:UN = [string]($IntuneUser.'IntuneUserName')
                    }
                
                    # If no valid UN yet, try by convertid $Script:StrIntuneUserSID to "Domain\Username"
                    if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.'Length' -lt 3 -and (-not([string]::IsNullOrEmpty($Script:StrIntuneUserSID)))) {
                        $Local:UN = [string]$(Try{[System.Security.Principal.SecurityIdentifier]::new($Script:StrIntuneUserSID).Translate([System.Security.Principal.NTAccount]).Value}Catch{[string]::Empty})
                    }

                    # If no valid UN yet, try by Registry::HKEY_USERS\$Script:StrIntuneUserSID\Volatile Environment
                    if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.'Length' -lt 3-and (-not([string]::IsNullOrEmpty($Script:StrIntuneUserSID)))) {
                        $Local:UN = [string]$(Try{$Local:x = Get-ItemProperty -Path ('Registry::HKEY_USERS\{0}\Volatile Environment' -f ($Script:StrIntuneUserSID)) -Name 'USERDOMAIN','USERNAME' -ErrorAction 'SilentlyContinue';('{0}\{1}' -f ([string]($Local:x | Select-Object -ExpandProperty 'USERDOMAIN'),[string]($Local:x | Select-Object -ExpandProperty 'USERNAME')))}Catch{[string]::Empty})
                    }
                
                    # If no valid UN yet, try by running process Explorer.exe - Method 1
                    if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.'Length' -lt 3) {
                        $Local:UN = [string]([string[]]@(Get-WmiObject -Class 'Win32_Process' -Filter "Name='Explorer.exe'" -ErrorAction 'SilentlyContinue' | ForEach-Object {$($Owner = $_.GetOwner();if($Owner.'ReturnValue' -eq 0 -and $Owner.'Domain' -notlike 'nt *' -and $Owner.'Domain' -notlike 'nt-*'){('{0}\{1}' -f ($Owner.'Domain',$Owner.'User'))})}) | Select-Object -Unique -First 1)
                    }
                
                    # If no valid UN yet, try by running process Explorer.exe - Method 2
                    if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.'Length' -lt 3) {
                        $Local:UN = [string]([string[]]@(Get-Process -Name 'explorer' -IncludeUserName -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'UserName' | Where-Object {$_ -notlike 'nt *' -and $_ -notlike 'nt-*'}) | Select-Object -Unique -First 1)
                    }                   

                    # If no valid UN yet, throw Error
                    if ([string]::IsNullOrEmpty($Local:UN) -or $Local:UN.'Length' -lt 3) {
                        Throw 'ERROR: Did not manage to get "Domain"\"UserName" for Intune User.'
                    }

                    # If valid UN, return it
                    else {
                        $Local:UN
                    }
                )
            )
        }
        

        # If running in User Context / Not running as "NT Authority\System"
        elseif ((-not($Script:BoolIsSystem)) -and (-not($DeviceContext))) {
            $null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrIntuneUserSID' -Value ([string]([System.Security.Principal.WindowsIdentity]::GetCurrent().'User'.'Value'))
            $null = New-Variable -Option 'ReadOnly' -Scope 'Script' -Force -Name 'StrIntuneUserName' -Value ([string]([System.Security.Principal.WindowsIdentity]::GetCurrent().'Name'))

            #region    Write SID and UserName to HKCU if running in User Context
                # Assets
                $Local:RegPath   = [string]('Registry::HKEY_CURRENT_USER\Software\IronstoneIT\Intune\UserInfo')
                $Local:RegNames  = [string[]]@('IntuneUserSID','IntuneUserName','DateSet')
                $Local:RegValues = [string[]]@($Script:StrIntuneUserSID,$Script:StrIntuneUserName,([string]([datetime]::Now.ToString('o'))))

                # Get Current Info
                $Local:CurrentUserSID     = [string](Get-ItemProperty -Path $Local:RegPath -Name $Local:RegNames[0] -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty $Local:RegNames[0] -ErrorAction 'SilentlyContinue')
                $Local:CurrentUserName    = [string](Get-ItemProperty -Path $Local:RegPath -Name $Local:RegNames[1] -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty $Local:RegNames[1] -ErrorAction 'SilentlyContinue')
                $Local:CurrentUserDateSet = [datetime]$(Try{[datetime](Get-ItemProperty -Path $Local:RegPath -Name $Local:RegNames[2] -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty $Local:RegNames[2] -ErrorAction 'SilentlyContinue')}catch{[datetime]::MinValue})

                # Set Info if any of the values does not match wanted values
                if ($Local:CurrentUserSID -ne $Local:RegValues[0] -or $Local:CurrentUserName -ne $Local:RegValues[1] -or $Local:CurrentUserDateSet -eq [datetime]::MinValue) {      
                    if (-not(Test-Path -Path $Local:RegPath)) {
                        $null = New-Item -Path $Local:RegPath -Force -ErrorAction 'Stop'
                    }

                    foreach ($x in [byte[]]@(0 .. [byte]($Local:RegNames.'Length' - 1))) {
                        $null = Set-ItemProperty -Path $Local:RegPath -Name $Local:RegNames[$x] -Value $Local:RegValues[$x] -Force -ErrorAction 'Stop'
                    }
                }
            #endregion Write SID and UserName to HKCU if running in User Context            
        }
        
        
        # Output Intune User and SID if found
        if (-not([string]::IsNullOrEmpty($Script:StrIntuneUserSID))) {
            Write-Output -InputObject ('Intune User SID "{0}", Username "{1}".' -f ($Script:StrIntuneUserSID,$Script:StrIntuneUserName))
        }
    #endregion Get SID and "Domain\Username" for Intune User



    # End the Initialize Region
    Write-Output -InputObject ('**********************')
#endregion Don't Touch This
################################################
#region    Your Code Here
################################################



#region    Variables
    # Settings
    $Script:ReadOnly           = [bool]$($false)

    # Files
    #region Files
        # Enable-BitLockerTrigger.PS1
        #region FilePS1
        $Script:NameFilePS1    = [string]$('Enable_BitLocker.ps1')
        $Script:ContentFilePS1 = [string]$('I1JlcXVpcmVzIC1SdW5Bc0FkbWluaXN0cmF0b3IKCjwjIAogCi5ERVNDUklQVElPTiAKIENoZWNrIHdoZXRoZXIgQml0TG9ja2VyIGlzIEVuYWJsZWQsIGlmIG5vdCBFbmFibGUgQml0TG9ja2VyIG9uIEFBRCBKb2luZWQgZGV2aWNlcyBhbmQgc3RvcmUgcmVjb3ZlcnkgaW5mbyBpbiBBQUQgCiBBZGRlZCBsb2dnaW5nCiM+IAoKW2NtZGxldGJpbmRpbmcoKV0KcGFyYW0oKQoKCiMgSW1wb3J0IEJpdExvY2tlciBtb2R1bGUKaWYgKFtieXRlXSQoR2V0LU1vZHVsZSAtTmFtZSAnQml0TG9ja2VyJyAtRXJyb3JBY3Rpb24gJ1NpbGVudGx5Q29udGludWUnIHwgTWVhc3VyZS1PYmplY3QgfCBTZWxlY3QtT2JqZWN0IC1FeHBhbmRQcm9wZXJ0eSAnQ291bnQnKSAtbGUgMCkgewogICAgJG51bGwgPSBJbXBvcnQtTW9kdWxlIC1OYW1lICdCaXRMb2NrZXInIC1EaXNhYmxlTmFtZUNoZWNraW5nIC1FcnJvckFjdGlvbiAnU3RvcCcKfQoKCiMgTWFrZSBzdXJlIGFsbCBuZXR3b3JrIHRyYWZmaWMgZ2VuZXJhY3RlZCBpbiB0aGlzIHNjcmlwdCB1c2VzIFRMUyAxLjIKW05ldC5TZXJ2aWNlUG9pbnRNYW5hZ2VyXTo6U2VjdXJpdHlQcm90b2NvbCA9IFtOZXQuU2VjdXJpdHlQcm90b2NvbFR5cGVdOjpUbHMxMgpbU3lzdGVtLk5ldC5TZXJ2aWNlUG9pbnRNYW5hZ2VyXTo6U2VjdXJpdHlQcm90b2NvbCA9IFtTeXN0ZW0uTmV0LlNlY3VyaXR5UHJvdG9jb2xUeXBlXTo6VGxzMTIKCgojcmVnaW9uIFNldHRpbmdzIGFuZCBWYXJpYWJsZXMKICAgICMgU2V0dGluZ3MKICAgICMjIEdVSQogICAgIyMjIElmIG9uLCB3aWxsIHByb21wdCB1c2VyIHRvIHJlYm9vdCB3aXRoIFdpbmRvd3MgRm9ybXMgR1VJLgogICAgJG51bGwgPSBOZXctVmFyaWFibGUgLU9wdGlvbiAnUmVhZE9ubHknIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgLU5hbWUgJ0Jvb2xTaG93R1VJJyAtVmFsdWUgJChbYm9vbF0kKCRmYWxzZSkpICAgIAogICAgIyMgUmVtb3ZlIGZpbGVzIGFmdGVyIHN1Y2Nlc3MKICAgICMjIyBJZiBvbiwgd2lsbCByZW1vdmUgYWxsIGZpbGVzIGFmdGVyIGZpcnN0IHN1Y2Nlc3MuCiAgICAkbnVsbCA9IE5ldy1WYXJpYWJsZSAtT3B0aW9uICdSZWFkT25seScgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSAtTmFtZSAnQm9vbFJlbW92ZUZpbGVzQWZ0ZXJTdWNjZXNzJyAtVmFsdWUgJChbYm9vbF0kKCRmYWxzZSkpCiAgICAjIyBSZW1vdmUgc2NlaGR1bGVkIHRhc2sgYWZ0ZXIgc3VjY2VzcwogICAgIyMjIElmIG9mZiwgd2lsbCBjaGFuZ2Ugc2NoZWR1bGVkIHRhc2sgdG8gcnVuIG9uY2UgYSBkYXkgYXQgMTI6MDAgYWZ0ZXIgZmlyc3Qgc3VjY2Vzc2Z1bGwgcnVuLCBvciBhZnRlciAzMCBmYWlsZWQgcnVucwogICAgIyMjIElmIG9uLCB3aWxsIGRlbGV0ZSBzY2hlZHVsZWQgdGFzayBhZnRlciBmaXJzdCBzdWNjZXNzZnVsbCBydW4gYW5kIGFmdGVyIDMwIGZhaWxlZCBydW5zCiAgICAkbnVsbCA9IE5ldy1WYXJpYWJsZSAtT3B0aW9uICdSZWFkT25seScgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSAtTmFtZSAnQm9vbFJlbW92ZVNjaGVkdWxlZFRhc2tBZnRlckZpcnN0U3VjY2VzcycgLVZhbHVlICQoW2Jvb2xdJCgkZmFsc2UpKQogICAgIyMgQmFja3VwIHRvIE9uZURyaXZlCiAgICAjIyMgSWYgdHJ1ZSB3aWxsIGJhY2t1cCB0byBPbmVEcml2ZSBmb3IgQnVzaW5lc3MsIHdpbGwgbm90IGNvdW50IGFzIHN1Y2Nlc3NmdWwgcnVuIGJlZm9yZSB0aGlzIHN0ZXAgaGFzIGNvbXBsZXRlZCBzdWNjZXNzZnVsbHkKICAgICMjIyBJZiBmYWxzZSB3aWxsIHNrdXAgYmFja3VwIHRvIE9uZURyaXZlIGZvciBCdXNpbmVzcwogICAgJG51bGwgPSBOZXctVmFyaWFibGUgLU9wdGlvbiAnUmVhZE9ubHknIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgLU5hbWUgJ0Jvb2xCYWNrdXBUb09uZURyaXZlRm9yQnVzaW5lc3MnIC1WYWx1ZSAkKFtib29sXSQoJGZhbHNlKSkKCiAgICAjIFZhcmlhYmxlcwogICAgIyMgU2NyaXB0CiAgICAkbnVsbCA9IE5ldy1WYXJpYWJsZSAtT3B0aW9uICdSZWFkT25seScgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSAtTmFtZSAnTmFtZVNjcmlwdCcgLVZhbHVlICQoW3N0cmluZ10kKCdJcm9uVHJpZ2dlcicpKQogICAgJG51bGwgPSBOZXctVmFyaWFibGUgLU9wdGlvbiAnUmVhZE9ubHknIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgLU5hbWUgJ1NjaGVkdWxlZFRhc2tOYW1lJyAtVmFsdWUgJChbc3RyaW5nXSQoJFNjcmlwdDpOYW1lU2NyaXB0LkNsb25lKCkpKQogICAgJG51bGwgPSBOZXctVmFyaWFibGUgLU9wdGlvbiAnUmVhZE9ubHknIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgLU5hbWUgJ0Rpckluc3RhbGwnIC1WYWx1ZSAkKFtzdHJpbmddJCgnezB9XFByb2dyYW0gRmlsZXNcSXJvbnN0b25lSVRcezF9XCcgLWYgKCRlbnY6U3lzdGVtRHJpdmUsJFNjcmlwdDpOYW1lU2NyaXB0KSkpCiAgICAkbnVsbCA9IE5ldy1WYXJpYWJsZSAtT3B0aW9uICdSZWFkT25seScgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSAtTmFtZSAnRGlyTG9nJyAtVmFsdWUgJChbc3RyaW5nXSQoJ3swfVxQcm9ncmFtIEZpbGVzXElyb25zdG9uZUlUXEludHVuZVxEZXZpY2VDb25maWd1cmF0aW9uXCcgLWYgKCRlbnY6U3lzdGVtRHJpdmUpKSkKICAgICRudWxsID0gTmV3LVZhcmlhYmxlIC1PcHRpb24gJ1JlYWRPbmx5JyAtU2NvcGUgJ1NjcmlwdCcgLUZvcmNlIC1OYW1lICdGaWxlTG9nJyAtVmFsdWUgJChbc3RyaW5nXSQoJ3swfUlyb25UcmlnZ2VyIC0gRW5hYmxlQml0TG9ja2VyLmxvZycgLWYgKCRTY3JpcHQ6RGlyTG9nKSkpCiAgICAkbnVsbCA9IE5ldy1WYXJpYWJsZSAtT3B0aW9uICdSZWFkT25seScgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSAtTmFtZSAnRmlsZVN0YXRzJyAtVmFsdWUgJChbc3RyaW5nXSQoJ3swfXN0YXRzLnR4dCcgLWYgKCRTY3JpcHQ6RGlySW5zdGFsbCkpKQogICAgIyMgSGVscAogICAgIyMjIFN0YXRpYyAvIFJlYWRPbmx5CiAgICAkbnVsbCA9IE5ldy1WYXJpYWJsZSAtT3B0aW9uICdSZWFkT25seScgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSAtTmFtZSAnT1NEcml2ZUxldHRlcicgLVZhbHVlICQoW3N0cmluZ10kKCRlbnY6U3lzdGVtRHJpdmUuVHJpbSgnOicpLlRvVXBwZXIoKSkpCiAgICAkbnVsbCA9IE5ldy1WYXJpYWJsZSAtT3B0aW9uICdSZWFkT25seScgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSAtTmFtZSAnQ29tcHV0ZXJOYW1lJyAtVmFsdWUgJChbc3RyaW5nXSQoW3N0cmluZ1tdXSQoW3N0cmluZ10oJGVudjpDT01QVVRFUk5BTUUpLlRyaW0oKSxbc3RyaW5nXShbU3lzdGVtLkVudmlyb25tZW50XTo6TWFjaGluZU5hbWUpLlRyaW0oKSAtbmUgW3N0cmluZ106OkVtcHR5KVswXSkpCiAgICAkbnVsbCA9IE5ldy1WYXJpYWJsZSAtT3B0aW9uICdSZWFkT25seScgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSAtTmFtZSAnQml0TG9ja2VyVm9sdW1lRW5jcnlwdGlvblN0YXR1c2VzJyAtVmFsdWUgJChbc3RyaW5nW11dJCgnRnVsbHlEZWNyeXB0ZWQnLCdFbmNyeXB0aW9uSW5Qcm9ncmVzcycsJ0Z1bGx5RW5jcnlwdGVkJykpCiAgICAjIyMgRHluYW1pYwogICAgJFNjcmlwdDpCb29sRGlkQW55dGhpbmdDaGFuZ2VUaGlzUnVudGltZSA9IFtib29sXSQoJGZhbHNlKSAgICAKI2VuZHJlZ2lvbiBTZXR0aW5ncyBhbmQgVmFyaWFibGVzCgoKCiNyZWdpb24gRnVuY3Rpb25zCiAgICAjcmVnaW9uIExvZ2dpbmcgYW5kIE91dHB1dAogICAgICAgICNyZWdpb24gTG9nV3JpdGUKICAgICAgICBGdW5jdGlvbiBMb2dXcml0ZSB7CiAgICAgICAgICAgIFBhcmFtICgKICAgICAgICAgICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJHRydWUpXQogICAgICAgICAgICAgICAgW1ZhbGlkYXRlTm90TnVsbE9yRW1wdHkoKV0KICAgICAgICAgICAgICAgIFtzdHJpbmddICRMb2dTdHJpbmcKICAgICAgICAgICAgKQoKICAgICAgICAgICAgIyBDcmVhdGUgdmFyaWFibGVzCiAgICAgICAgICAgICREYXRlVGltZSAgPSBbc3RyaW5nXSQoW1N5c3RlbS5EYXRlVGltZV06Ok5vdy5Ub1N0cmluZygneXlNTWRkIEhIOm1tOnNzOmZmJykpCiAgICAgICAgICAgICRMb2dTdHJpbmcgPSBbc3RyaW5nXSQoJ3swfSB7MX0nIC1mICgkRGF0ZVRpbWUsJExvZ1N0cmluZykpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEFkZCBjb250ZW50IHRvIGxvZyBmaWxlCiAgICAgICAgICAgIEFkZC1jb250ZW50IC1QYXRoICRTY3JpcHQ6RmlsZUxvZyAtVmFsdWUgJExvZ1N0cmluZyAtRW5jb2RpbmcgJ3V0ZjgnCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE91dHB1dCBjb250ZW50IHRvIGNvbnNvbGUKICAgICAgICAgICAgV3JpdGUtT3V0cHV0IC1JbnB1dE9iamVjdCAkTG9nU3RyaW5nCiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gTG9nV3JpdGUKCiAgICAgICAgI3JlZ2lvbiBMb2dFcnJvcnMKICAgICAgICBGdW5jdGlvbiBMb2dFcnJvcnMgewogICAgICAgICAgICBMb2dXcml0ZSAoJ0NhdWdodCBhbiBleGNlcHRpb246JykKICAgICAgICAgICAgTG9nV3JpdGUgKCdFeGNlcHRpb24gVHlwZTogICAgezB9JyAtZiAoJF8uJ0V4Y2VwdGlvbicuR2V0VHlwZSgpLidGdWxsTmFtZScpKQogICAgICAgICAgICBMb2dXcml0ZSAoJ0V4Y2VwdGlvbiBNZXNzYWdlOiB7MH0nIC1mICgkXy4nRXhjZXB0aW9uJy4nTWVzc2FnZScpKQogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIExvZ0Vycm9ycwoKCiAgICAgICAgI3JlZ2lvbiBXcml0ZS1TdGF0cwogICAgICAgICMgV3JpdGUtU3RhdHM6IE91dHB1dHMgY3VycmVudCBzdGF0dXMgb2YgdmFyaW91cyBib29sZWFucyBhbmQgb3RoZXIgbWVhc3VyZW1lbnRzCiAgICAgICAgRnVuY3Rpb24gV3JpdGUtU3RhdHMgeyAgICAKICAgICAgICAgICAgUGFyYW0oCiAgICAgICAgICAgICAgICBbcGFyYW1ldGVyKE1hbmRhdG9yeT0kZmFsc2UpXQogICAgICAgICAgICAgICAgW2Jvb2xdICRQcmV2aW91c09ubHkgPSAkZmFsc2UKICAgICAgICAgICAgKQogICAgICAgICAgICAjIEdlbmVyYWwKICAgICAgICAgICAgaWYgKCRQcmV2aW91c09ubHkpIHsKICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnUnVuczogezB9IHwgSGFzIElyb25UcmlnZ2VyIGhhZCBhIHN1Y2Nlc3NmdWxsIHJ1biBhbHJlYWR5PyB7MX0nIC1mICgkU2NyaXB0OkNvdW50UnVucywkU2NyaXB0OklzRmluaXNoZWQxc3RUaW1lKSkKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBPUyBEcml2ZQogICAgICAgICAgICBMb2dXcml0ZSAoJ09TIGRyaXZlICh7MH0pIHwgRW5jcnlwdGVkOiB7MX0gfCBSZWNvdmVyeSBQYXNzd29yZHMgcHJlc2VudDogezJ9IHwgQmFja3VwIHRvIE9uZURyaXZlOiB7M30gfCBCYWNrdXAgdG8gQXp1cmVBRDogezR9JyAtZiAoJE9TRHJpdmVMZXR0ZXIsJFNjcmlwdDpJc0VuY3J5cHRlZCwkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3LCRTY3JpcHQ6SXNCYWNrdXBPRCwkU2NyaXB0OklzQmFja3VwQUFEKSkKICAgICAgICAgICAgaWYgKC1ub3QoJFByZXZpb3VzT25seSkpIHsKICAgICAgICAgICAgICAgIExvZ3dyaXRlICgnT1MgZHJpdmUgKHswfSkgfCBWb2x1bWVTdGF0dXM6IHsxfSB8IFByb3RlY3Rpb25TdGF0dXM6IHsyfScgLWYgKCRPU0RyaXZlTGV0dGVyLCRTY3JpcHQ6Vm9sdW1lRW5jcnlwdGlvblN0YXR1cywkU2NyaXB0OlZvbHVtZVByb3RlY3Rpb25TdGF0dXMpKSAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKCRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFcpIHsKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ09TIGRyaXZlICh7MH0pIHwgUHJlc2VuY2Ugb2YgQml0TG9ja2VyIEtleVByb3RlY3RvciB8IFRQTTogezF9IHwgUmVjb3ZlcnlQYXNzd29yZDogezJ9JyAtZiAoJE9TRHJpdmVMZXR0ZXIsJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1swXSwkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzFdKSkKICAgICAgICAgICAgICAgICAgICBpZiAoJFNjcmlwdDpWb2x1bWVFbmNyeXB0aW9uU3RhdHVzWzFdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnT1MgZHJpdmUgKHswfSkgfCB7MX0nIC1mICgkT1NEcml2ZUxldHRlciwoV3JpdGUtUmVjb3ZlcnlQYXNzd29yZCkpKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE90aGVyIGZpeGVkIGRyaXZlcyB3aXRoIGEgZHJpdmUgbGV0dGVyCiAgICAgICAgICAgICAgICA8IyAjVE9ETwogICAgICAgICAgICAgICAgaWYgKCRTY3JpcHQ6T3RoZXJFbmNyeXB0ZWREcml2ZXMpIHsKICAgICAgICAgICAgICAgICAgICAkU2NyaXB0Ok90aGVyRW5jcnlwdGVkRHJpdmVzIHwgRm9yRWFjaC1PYmplY3QgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoLW5vdChbc3RyaW5nXTo6SXNOdWxsT3JFbXB0eSgkU2NyaXB0Ok90aGVyRW5jcnlwdGVkRHJpdmVzWzBdKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtzdHJpbmddICRMb2NhbDpEcml2ZVZvbHVtZVN0YXR1cyA9IChHZXQtVmFyaWFibGUgLU5hbWUgKCdWb2x1bWV7MH1FbmNTdGF0dXMnIC1mICRfKSAtU2NvcGUgJ1NjcmlwdCcpLlZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBbc3RyaW5nXSAkTG9jYWw6RHJpdmVQcm90ZWN0aW9uU3RhdHVzID0gKEdldC1WYXJpYWJsZSAtTmFtZSAoJ1ZvbHVtZXswfVByb3RlY3Rpb25TdGF0dXMnIC1mICRfKSAtU2NvcGUgJ1NjcmlwdCcpLlZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMb2d3cml0ZSAoJ1N0YXR1cyBkcml2ZSAiezB9IiB8IFZvbHVtZVN0YXR1czogezF9IHwgUHJvdGVjdGlvblN0YXR1czogezJ9JyAtZiAoJF8sJExvY2FsOkRyaXZlVm9sdW1lU3RhdHVzLCRMb2NhbDpEcml2ZVByb3RlY3Rpb25TdGF0dXMpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgW2Jvb2xbXV0gJExvY2FsOktleVByb3RlY3RvclR5cGVzID0gR2V0LUJpdExvY2tlcktleVByb3RlY3RvclR5cGVzIC1Ecml2ZUxldHRlciAkXwogICAgICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdCaXRMb2NrZXIgS2V5UHJvdGVjdG9yIFR5cGVzIHByZXNlbnQgZm9yIGRyaXZlICJ7MH0iPyB8IFRQTTogezF9IHwgUmVjb3ZlcnlQYXNzd29yZDogezJ9JyAtZiAoJF8sJExvY2FsOktleVByb3RlY3RvclR5cGVzWzBdLCRMb2NhbDpLZXlQcm90ZWN0b3JUeXBlc1sxXSkpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9Iz4KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAjZW5kcmVnaW9uIFdyaXRlLVN0YXRzCgoKICAgICAgICAjcmVnaW9uIFdyaXRlLVJlY292ZXJ5UGFzc3dvcmQKICAgICAgICAjIFdyaXRlLVJlY292ZXJ5UGFzc3dvcmQKICAgICAgICBGdW5jdGlvbiBXcml0ZS1SZWNvdmVyeVBhc3N3b3JkIHsKICAgICAgICAgICAgJExvY2FsOkMgPSBbYnl0ZV0kKGlmKCRTY3JpcHQ6Q291bnRSZWNvdmVyeVBhc3N3b3Jkcyl7JFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzfWVsc2V7MH0pCiAgICAgICAgICAgIFJldHVybiAoW3N0cmluZ10kKCd7MH0gUmVjb3ZlcnkgUGFzc3dvcmQocykgcHJlc2VudC57MX0nIC1mICgkTG9jYWw6QywoJChpZigkTG9jYWw6QyAtZ2UgMSl7J3swfXsxfScgLWYgKCJgcmBuIiwoR2V0LVN0cmluZ1JlY292ZXJ5UGFzc3dvcmRzKSl9KSkpKSkKICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBXcml0ZS1SZWNvdmVyeVBhc3N3b3JkCgoKICAgICAgICAjcmVnaW9uIEdldC1TdHJpbmdSZWNvdmVyeVBhc3N3b3JkcwogICAgICAgICMgUmV0dXJucyBhIHN0cmluZyBjb250YWluaW5nIHRoZSByZWNvdmVyeSBwYXNzd29yZHMgZnJvbSAkU2NyaXB0OkFycmF5UmVjb3ZlcnlQYXNzd29yZHMuIFVzZWZ1bGwgZm9yIHByaW50aW5nLyBsb2dnaW5nLyBiYWNrdXAKICAgICAgICBGdW5jdGlvbiBHZXQtU3RyaW5nUmVjb3ZlcnlQYXNzd29yZHMgewogICAgICAgICAgICBQYXJhbSgKICAgICAgICAgICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5PSRmYWxzZSldCiAgICAgICAgICAgICAgICBbVmFsaWRhdGVOb3ROdWxsT3JFbXB0eSgpXQogICAgICAgICAgICAgICAgW3N0cmluZ10gJERyaXZlTGV0dGVyID0gJE9TRHJpdmVMZXR0ZXIKICAgICAgICAgICAgKQoKICAgICAgICAgICAgIyBWYWxpZGF0ZSBJbnB1dAogICAgICAgICAgICAkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlciA9IFtzdHJpbmddJCgkRHJpdmVMZXR0ZXIuVHJpbSgnOicpLlRvVXBwZXIoKSkKICAgICAgICAgICAgaWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyLidMZW5ndGgnIC1ndCAxKSB7CiAgICAgICAgICAgICAgICBUaHJvdyAnRVJST1I6IERyaXZlIGxldHRlciBjYW5ub3QgYmUgbW9yZSB0aGFuIG9uZSBsZXR0ZXInCiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAjIENyZWF0ZSB2YXJpYWJsZSBuYW1lcwogICAgICAgICAgICAkTG9jYWw6QXJyYXlOYW1lICAgICA9IFtzdHJpbmddJCgnezB9QXJyYXlSZWNvdmVyeVBhc3N3b3JkcycgLWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyKSkKCgogICAgICAgICAgICAjIEdldCBBcnJheSwgbG9vcCBpdC4gSWRlYWxseSBvbmx5IG9uZSBwdywgYnV0IGxvb3AganVzdCB0byBiZSBzYWZlLgogICAgICAgICAgICAkTG9jYWw6VGVtcENvdW50ZXIgPSBbdWludDE2XSQoMCkKICAgICAgICAgICAgJExvY2FsOk91dFN0ciA9IFtzdHJpbmddOjpFbXB0eQogICAgICAgICAgICAoR2V0LVZhcmlhYmxlIC1OYW1lICRMb2NhbDpBcnJheU5hbWUgLVNjb3BlICdTY3JpcHQnIC1WYWx1ZU9ubHkpIHwgRm9yRWFjaC1PYmplY3QgewogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciArPSAoJ3swfSB8IEtleVByb3RlY3RvcklkICJ7MX0iIHwgUmVjb3ZlcnlQYXNzd29yZCAiezJ9IicgLWYgKCgkTG9jYWw6VGVtcENvdW50ZXIgKz0gMSksJF8uS2V5UHJvdGVjdG9ySWQsJF8uUmVjb3ZlcnlQYXNzd29yZCkpCiAgICAgICAgICAgICAgICBpZiAoJExvY2FsOlRlbXBDb3VudGVyIC1sdCAoKEdldC1WYXJpYWJsZSAtTmFtZSAkTG9jYWw6QXJyYXlOYW1lIC1TY29wZSAnU2NyaXB0JykuVmFsdWUpLkNvdW50KSB7JExvY2FsOk91dFN0ciArPSAiYHJgbiJ9CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAjIFJldHVybiB0aGUgc3RyaW5nCiAgICAgICAgICAgIFJldHVybiAkTG9jYWw6T3V0U3RyCiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gR2V0LVN0cmluZ1JlY292ZXJ5UGFzc3dvcmRzCiAgICAjZW5kcmVnaW9uIExvZ2dpbmcgYW5kIE91dHB1dAoKCgogICAgI3JlZ2lvbiBSZXR1cm4gVmFsdWVzIChVc2VkIGJ5IG90aGVyIEZ1bmN0aW9ucykKICAgICAgICAjcmVnaW9uICAgIEdldC1CaXRMb2NrZXJLZXlQcm90ZWN0b3JUeXBlcwogICAgICAgIEZ1bmN0aW9uIEdldC1Cb29sRHJpdmVIYXNCaXRMb2NrZXJUUE1hbmRQVyB7CiAgICAgICAgICAgIDwjCiAgICAgICAgICAgICAgICBSZXR1cm5zIGEgYm9vbCBhcnJheSwgd2hlcmUgdGhlIGZpcnN0IHJlcHJlc2VudHMgc3RhdHVzIG9mIFRQTSBwcmVzZW5jZSwgYW5kIHRoZSBzZWNvbmQgZm9yIFByb3RlY3Rpb24gUGFzc3dvcmQKICAgICAgICAgICAgIz4KICAgICAgICAgICAgUGFyYW0oCiAgICAgICAgICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeT0kZmFsc2UpXQogICAgICAgICAgICAgICAgW1ZhbGlkYXRlTm90TnVsbE9yRW1wdHkoKV0KICAgICAgICAgICAgICAgIFtzdHJpbmddICREcml2ZUxldHRlciA9ICRPU0RyaXZlTGV0dGVyCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVmFsaWRhdGUgSW5wdXQKICAgICAgICAgICAgJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIgPSBbc3RyaW5nXSQoJERyaXZlTGV0dGVyLlRyaW0oJzonKS5Ub1VwcGVyKCkpCiAgICAgICAgICAgIGlmICgkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlci4nTGVuZ3RoJyAtZ3QgMSkgewogICAgICAgICAgICAgICAgVGhyb3cgJ0VSUk9SOiBEcml2ZSBsZXR0ZXIgY2Fubm90IGJlIG1vcmUgdGhhbiBvbmUgbGV0dGVyJwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAjIEdldCBCaXRMb2NrZXIgVm9sdW1lCiAgICAgICAgICAgICRMb2NhbDpCaXRMb2NrZXJTdGF0dXMgPSBHZXQtQml0TG9ja2VyVm9sdW1lIC1Nb3VudFBvaW50ICRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENyZWF0ZSBvYmplY3QgY29udGFpbmluZyBudW1iZXIgb2YgUmVjb3ZlcnlQYXNzd29yZHMgKEluZGV4ID0gMCkgYW5kIFRQTSAoSW5kZXggPSAxKQogICAgICAgICAgICAkTG9jYWw6Q291bnRSZWNQYXNzID0gW3VpbnQxNl0kKDApCiAgICAgICAgICAgICRMb2NhbDpDb3VudFRQTSA9IFt1aW50MTZdJCgwKQogICAgICAgICAgICAkTG9jYWw6Qml0TG9ja2VyU3RhdHVzLidLZXlQcm90ZWN0b3InIHwgRm9yRWFjaC1PYmplY3QgewogICAgICAgICAgICAgICAgaWYgKCRfLidLZXlQcm90ZWN0b3JUeXBlJyAtZXEgJ1JlY292ZXJ5UGFzc3dvcmQnKSB7JExvY2FsOkNvdW50UmVjUGFzcyArPSAxfQogICAgICAgICAgICAgICAgZWxzZWlmICgkXy4nS2V5UHJvdGVjdG9yVHlwZScgLWVxICdUUE0nKSB7JExvY2FsOkNvdW50VFBNICs9IDF9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmV0dXJuIHRoZSBvYmplY3QKICAgICAgICAgICAgcmV0dXJuIChbYm9vbF0kKCRMb2NhbDpDb3VudFRQTSAtZ2UgMSksW2Jvb2xdJCgkTG9jYWw6Q291bnRSZWNQYXNzIC1nZSAxKSkKICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBHZXQtQml0TG9ja2VyS2V5UHJvdGVjdG9yVHlwZXMKCgogICAgICAgICNyZWdpb24gICAgR2V0LUFycmF5UmVjb3ZlcnlQYXNzd29yZHMKICAgICAgICAjIFJldHVybnMgYSBBcnJheUxpc3Qgd2l0aCBleGlzdGluZyBQcm90ZWN0aW9uUGFzc3dvcmRzCiAgICAgICAgRnVuY3Rpb24gR2V0LUFycmF5UmVjb3ZlcnlQYXNzd29yZHMgewogICAgICAgICAgICBQYXJhbSgKICAgICAgICAgICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5PSR0cnVlKV0KICAgICAgICAgICAgICAgIFtNaWNyb3NvZnQuQml0TG9ja2VyLlN0cnVjdHVyZXMuQml0TG9ja2VyVm9sdW1lXSAkQml0TG9ja2VyVm9sdW1lCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgR2V0IEJpdExvY2tlciBQcm90ZWN0aW9uUGFzc3dvcmRzCiAgICAgICAgICAgICRMb2NhbDpLZXlQcm90ZWN0b3JTdGF0dXMgICAgID0gJEJpdExvY2tlclZvbHVtZSB8IFNlbGVjdC1PYmplY3QgLUV4cGFuZFByb3BlcnR5ICdLZXlQcm90ZWN0b3InCiAgICAgICAgICAgICRMb2NhbDpBcnJheVJlY292ZXJ5UGFzc3dvcmRzID0gW01pY3Jvc29mdC5CaXRMb2NrZXIuU3RydWN0dXJlcy5CaXRMb2NrZXJWb2x1bWVLZXlQcm90ZWN0b3JbXV0kKCkKCiAgICAgICAgICAgICRMb2NhbDpLZXlQcm90ZWN0b3JTdGF0dXMgfCBGb3JFYWNoLU9iamVjdCAtUHJvY2VzcyB7CiAgICAgICAgICAgICAgICBpZiAoJF8uJ0tleVByb3RlY3RvclR5cGUnIC1lcSAnUmVjb3ZlcnlQYXNzd29yZCcpIHsKICAgICAgICAgICAgICAgICAgICAkTG9jYWw6QXJyYXlSZWNvdmVyeVBhc3N3b3JkcyArPSBbTWljcm9zb2Z0LkJpdExvY2tlci5TdHJ1Y3R1cmVzLkJpdExvY2tlclZvbHVtZUtleVByb3RlY3RvcltdXSQoJF8pCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmV0dXJuIHRoZSBvYmplY3QgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gJExvY2FsOkFycmF5UmVjb3ZlcnlQYXNzd29yZHMKICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBHZXQtQXJyYXlSZWNvdmVyeVBhc3N3b3JkcwoKCiAgICAgICAgI3JlZ2lvbiAgICBHZXQtVm9sdW1lVW5pcXVlSUQKICAgICAgICBGdW5jdGlvbiBHZXQtVm9sdW1lVW5pcXVlSUQgewogICAgICAgICAgICBwYXJhbSgKICAgICAgICAgICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5PSR0cnVlKV0KICAgICAgICAgICAgICAgIFtWYWxpZGF0ZU5vdE51bGxPckVtcHR5KCldCiAgICAgICAgICAgICAgICBbc3RyaW5nXSAkRHJpdmVMZXR0ZXIKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBWYWxpZGF0ZSBJbnB1dAogICAgICAgICAgICAkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlciA9IFtzdHJpbmddJCgkRHJpdmVMZXR0ZXIuVHJpbSgnOicpLlRvVXBwZXIoKSkKICAgICAgICAgICAgaWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyLidMZW5ndGgnIC1ndCAxKSB7CiAgICAgICAgICAgICAgICBUaHJvdyAnRVJST1I6IERyaXZlIGxldHRlciBjYW5ub3QgYmUgbW9yZSB0aGFuIG9uZSBsZXR0ZXInCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICMgR2V0IFVuaXF1ZSBWb2x1bWUKICAgICAgICAgICAgcmV0dXJuIFtzdHJpbmddJChHZXQtVm9sdW1lIC1Ecml2ZUxldHRlciAkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlciB8IFNlbGVjdC1PYmplY3QgLUV4cGFuZFByb3BlcnR5ICdVbmlxdWVJZCcpLlNwbGl0KCd7JylbLTFdLlRyaW0oJ31cJykKICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBHZXQtVm9sdW1lVW5pcXVlSUQKCgogICAgICAgICNyZWdpb24gICAgUmVmcmVzaC1CaXRMb2NrZXJWYXJpYWJsZXNGb3JDdXJyZW50Vm9sdW1lCiAgICAgICAgRnVuY3Rpb24gUmVmcmVzaC1CaXRMb2NrZXJWYXJpYWJsZXNGb3JDdXJyZW50Vm9sdW1lIHsKICAgICAgICAgICAgcGFyYW0oCiAgICAgICAgICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeT0kdHJ1ZSldCiAgICAgICAgICAgICAgICBbVmFsaWRhdGVOb3ROdWxsT3JFbXB0eSgpXQogICAgICAgICAgICAgICAgW3N0cmluZ10gJERyaXZlTGV0dGVyCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVmFsaWRhdGUgSW5wdXQKICAgICAgICAgICAgJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIgPSBbc3RyaW5nXSQoJERyaXZlTGV0dGVyLlRyaW0oJzonKS5Ub1VwcGVyKCkpCiAgICAgICAgICAgIGlmICgkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlci5MZW5ndGggLWd0IDEpIHsKICAgICAgICAgICAgICAgIFRocm93ICdFUlJPUjogRHJpdmUgbGV0dGVyIGNhbm5vdCBiZSBtb3JlIHRoYW4gb25lIGxldHRlcicKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICMgVmFyaWFibGVzIHRoYXRzIGFsd2F5cyBwcmVzZW50CiAgICAgICAgICAgICRTY3JpcHQ6Vm9sdW1lRW5jcnlwdGlvblN0YXR1cyAgICAgPSBbc3RyaW5nXSQoR2V0LVZhcmlhYmxlIC1OYW1lICgnezB9Vm9sdW1lRW5jcnlwdGlvblN0YXR1cycgLWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyKSkgLVNjb3BlICdTY3JpcHQnIC1WYWx1ZU9ubHkgLUVycm9yQWN0aW9uICdTdG9wJykKICAgICAgICAgICAgJFNjcmlwdDpWb2x1bWVQcm90ZWN0aW9uU3RhdHVzICAgICA9IFtzdHJpbmddJChHZXQtVmFyaWFibGUgLU5hbWUgKCd7MH1Wb2x1bWVQcm90ZWN0aW9uU3RhdHVzJyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpKSAtU2NvcGUgJ1NjcmlwdCcgLVZhbHVlT25seSAtRXJyb3JBY3Rpb24gJ1N0b3AnKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBWYXJpYWJsZXMgdGhhdHMgcHJlc2VudCBvbmx5IGlmIHRoZXJlcyBhdCBsZWFzdCBvbmUgS2V5UHJvdGVjdG9yIGZvciBjdXJyZW50IHZvbHVtZQogICAgICAgICAgICAkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXICAgICAgICAgID0gW2Jvb2xbXV0kKEdldC1WYXJpYWJsZSAtTmFtZSAoJ3swfVZvbHVtZUhhc1RQTWFuZFBXJyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpKSAtU2NvcGUgJ1NjcmlwdCcgLVZhbHVlT25seSAtRXJyb3JBY3Rpb24gJ1NpbGVudGx5Q29udGludWUnKQogICAgICAgICAgICAkU2NyaXB0OlZvbHVtZUVuY3J5cHRpb25QZXJjZW50YWdlID0gW3N0cmluZ10kKEdldC1WYXJpYWJsZSAtTmFtZSAoJ3swfVZvbHVtZUVuY3J5cHRpb25QZXJjZW50YWdlJyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpKSAtU2NvcGUgJ1NjcmlwdCcgLVZhbHVlT25seSAtRXJyb3JBY3Rpb24gJ1NpbGVudGx5Q29udGludWUnKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBWYXJpYWJsZXMgdGhhdHMgcHJlc2VudCBvbmx5IGlmIGN1cnJlbnQgdm9sdW1lIGlzIHByb3RlY3RlZCB3aXRoIG1pbmltdW0gYSBUUE0gYW5kIGEgUmVjb3ZlcnkgUGFzc3dvcmQKICAgICAgICAgICAgJFNjcmlwdDpBcnJheVJlY292ZXJ5UGFzc3dvcmRzICAgICA9IEdldC1WYXJpYWJsZSAtTmFtZSAoJ3swfUFycmF5UmVjb3ZlcnlQYXNzd29yZHMnIC1mICgkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlcikpIC1TY29wZSAnU2NyaXB0JyAtVmFsdWVPbmx5IC1FcnJvckFjdGlvbiAnU2lsZW50bHlDb250aW51ZScKICAgICAgICAgICAgJFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzICAgICA9IFtieXRlXSQoR2V0LVZhcmlhYmxlIC1OYW1lICgnezB9Q291bnRSZWNvdmVyeVBhc3N3b3JkcycgLWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyKSkgLVNjb3BlICdTY3JpcHQnIC1WYWx1ZU9ubHkgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJykKICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBSZWZyZXNoLUJpdExvY2tlclZhcmlhYmxlc0ZvckN1cnJlbnRWb2x1bWUKCgogICAgICAgICNyZWdpb24gICAgQ2hlY2stSWZCaXRMb2NrZXJQV0hhc0NoYW5nZWQKICAgICAgICBGdW5jdGlvbiBDaGVjay1JZkJpdExvY2tlclBXSGFzQ2hhbmdlZCB7CiAgICAgICAgICAgIHBhcmFtKAogICAgICAgICAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnk9JGZhbHNlKV0KICAgICAgICAgICAgICAgIFtWYWxpZGF0ZU5vdE51bGxPckVtcHR5KCldCiAgICAgICAgICAgICAgICBbc3RyaW5nXSAkRHJpdmVMZXR0ZXIgPSAkT1NEcml2ZUxldHRlcgogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEhlbHAgVmFyaWFibGVzCiAgICAgICAgICAgICRMb2NhbDpIYXNDaGFuZ2VkID0gW2Jvb2xdJCgkZmFsc2UpCiAgICAgICAgICAgICRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyID0gW3N0cmluZ10kKCREcml2ZUxldHRlci5UcmltKCc6JykuVG9VcHBlcigpKQogICAgICAgICAgICBpZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIuJ0xlbmd0aCcgLWd0IDEpIHsKICAgICAgICAgICAgICAgIFRocm93ICdFUlJPUjogRHJpdmUgbGV0dGVyIGNhbm5vdCBiZSBtb3JlIHRoYW4gb25lIGxldHRlcicKICAgICAgICAgICAgfQoKICAgICAgICAgICAgIyBOYW1lIFZhcmlhYmxlcwogICAgICAgICAgICAkTG9jYWw6TmFtZUFycmF5ID0gW3N0cmluZ10kKCd7MH1BcnJheVJlY292ZXJ5UGFzc3dvcmRzJyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpKQogICAgICAgICAgICAkTG9jYWw6Vm9sdW1lVW5pcXVlSUQgPSBbc3RyaW5nXSQoR2V0LVZvbHVtZVVuaXF1ZUlEIC1Ecml2ZUxldHRlciAkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlcikKICAgICAgICAgICAgJExvY2FsOk5hbWVGaWxlID0gW3N0cmluZ10kKCd7MH0udHh0JyAtZiAoJFZvbHVtZVVuaXF1ZUlEKSkKICAgICAgICAgICAKICAgICAgICAgICAgIyBHZXQgVmFyaWFibGVzCiAgICAgICAgICAgICRMb2NhbDpQYXRoRGlyID0gW3N0cmluZ10kKCd7MH17MX0nIC1mICgkU2NyaXB0OkRpckluc3RhbGwsJ0JhY2t1cEtleXNcJykpCiAgICAgICAgICAgICRMb2NhbDpQYXRoRmlsZSA9IFtzdHJpbmddJCgnezB9ezF9JyAtZiAoJExvY2FsOlBhdGhEaXIsJExvY2FsOk5hbWVGaWxlKSkKICAgICAgICAgICAgJExvY2FsOk5vd0tleVByb3RlY3RvcklEID0gW3N0cmluZ10kKCgoR2V0LVZhcmlhYmxlIC1OYW1lICRMb2NhbDpOYW1lQXJyYXkgLVNjb3BlICdTY3JpcHQnKS4nVmFsdWUnKS4nS2V5UHJvdGVjdG9ySUQnKQogICAgICAgICAgICAkTG9jYWw6Tm93UmVjb3ZlcnlQYXNzd29yZCA9IFtzdHJpbmddJCgoKEdldC1WYXJpYWJsZSAtTmFtZSAkTG9jYWw6TmFtZUFycmF5IC1TY29wZSAnU2NyaXB0JykuJ1ZhbHVlJykuJ1JlY292ZXJ5UGFzc3dvcmQnKQoKCiAgICAgICAgICAgICMgR2V0IHN0YXRzCiAgICAgICAgICAgIGlmICgtbm90IChUZXN0LVBhdGggLVBhdGggJExvY2FsOlBhdGhGaWxlKSkgewogICAgICAgICAgICAgICAgJExvY2FsOkhhc0NoYW5nZWQgPSAkdHJ1ZQogICAgICAgICAgICAgICAgaWYgKC1ub3QoVGVzdC1QYXRoIC1QYXRoICRMb2NhbDpQYXRoRGlyIC1FcnJvckFjdGlvbiAnU2lsZW50bHlDb250aW51ZScpKSB7CiAgICAgICAgICAgICAgICAgICAgJG51bGwgPSBOZXctSXRlbSAtUGF0aCAkTG9jYWw6UGF0aERpciAtSXRlbVR5cGUgJ0RpcmVjdG9yeScgLUZvcmNlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAkTG9jYWw6SW5wdXRTdHJpbmcgPSBbc3RyaW5nW11dJCgoR2V0LUNvbnRlbnQgLVBhdGggJExvY2FsOlBhdGhGaWxlKS5TcGxpdChbRW52aXJvbm1lbnRdOjpOZXdMaW5lKSkKICAgICAgICAgICAgICAgIGlmICgkPyAtYW5kICRMb2NhbDpJbnB1dFN0cmluZy4nTGVuZ3RoJyAtZ2UgNykgewogICAgICAgICAgICAgICAgICAgICRMb2NhbDpQcmV2S2V5UHJvdGVjdG9ySUQgPSBbc3RyaW5nXSQoJExvY2FsOklucHV0U3RyaW5nWzVdLlRyaW0oKSkKICAgICAgICAgICAgICAgICAgICAkTG9jYWw6UHJldlJlY292ZXJ5UGFzc3dvcmQgPSBbc3RyaW5nXSQoJExvY2FsOklucHV0U3RyaW5nWzddLlRyaW0oKSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgeyRMb2NhbDpIYXNDaGFuZ2VkID0gJHRydWV9CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAjIENoZWNrIGlmIGNoYW5nZWQKICAgICAgICAgICAgaWYgKCRMb2NhbDpQcmV2S2V5UHJvdGVjdG9ySUQpIHsKICAgICAgICAgICAgICAgIGlmICgkTG9jYWw6UHJldktleVByb3RlY3RvcklEIC1uZSAkTG9jYWw6Tm93S2V5UHJvdGVjdG9ySUQpIHskTG9jYWw6SGFzQ2hhbmdlZCA9ICR0cnVlfQogICAgICAgICAgICAgICAgaWYgKCRMb2NhbDpQcmV2UmVjb3ZlcnlQYXNzd29yZCAtbmUgJExvY2FsOk5vd1JlY292ZXJ5UGFzc3dvcmQpIHskTG9jYWw6SGFzQ2hhbmdlZCA9ICR0cnVlfQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgIyBXcml0ZSBuZXcgdmFsdWVzIGlmIGNoYW5nZWQgb3IgZG9lcyBub3QgZXhpc3QKICAgICAgICAgICAgaWYgKCRMb2NhbDpIYXNDaGFuZ2VkIC1vciAoLW5vdCAoVGVzdC1QYXRoIC1QYXRoICRMb2NhbDpQYXRoRmlsZSkpKSB7CiAgICAgICAgICAgICAgICAkTG9jYWw6T3V0U3RyID0gW3N0cmluZ106OkVtcHR5CiAgICAgICAgICAgICAgICAkTG9jYWw6T3V0U3RyICs9ICdEcml2ZS9Wb2x1bWUgTGV0dGVyIChOb3QgVW5pcXVlIGlkZW50aWZpZXIpOnswfScgLWYgImByYG4iCiAgICAgICAgICAgICAgICAkTG9jYWw6T3V0U3RyICs9ICd7MH17MX0nIC1mICRDdXJyZW50Vm9sdW1lTGV0dGVyLCJgcmBuIgogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciArPSAnVm9sdW1lIFVuaXF1ZUlEIChOYW1lIG9mIHRoaXMgZmlsZSk6ezB9JyAtZiAiYHJgbiIKICAgICAgICAgICAgICAgICRMb2NhbDpPdXRTdHIgKz0gJ3swfXsxfScgLWYgJExvY2FsOlZvbHVtZVVuaXF1ZUlELCJgcmBuIgogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciArPSAnS2V5UHJvdGVjdG9ySUQ6ezB9JyAtZiAiYHJgbiIKICAgICAgICAgICAgICAgICRMb2NhbDpPdXRTdHIgKz0gJ3swfXsxfScgLWYgJExvY2FsOk5vd0tleVByb3RlY3RvcklELCJgcmBuIgogICAgICAgICAgICAgICAgJExvY2FsOk91dFN0ciArPSAnUmVjb3ZlcnkgUGFzc3dvcmQ6ezB9JyAtZiAiYHJgbiIKICAgICAgICAgICAgICAgICRMb2NhbDpPdXRTdHIgKz0gJ3swfXsxfScgLWYgJExvY2FsOk5vd1JlY292ZXJ5UGFzc3dvcmQsImByYG4iCiAgICAgICAgICAgICAgICAkbnVsbCA9IE91dC1GaWxlIC1GaWxlUGF0aCAkTG9jYWw6UGF0aEZpbGUgLUVuY29kaW5nICd1dGY4JyAtRm9yY2UgLUlucHV0T2JqZWN0ICgkTG9jYWw6T3V0U3RyKQogICAgICAgICAgICB9CgoKCiAgICAgICAgICAgICMgUmV0dXJuIHN0YXR1cwogICAgICAgICAgICByZXR1cm4gJExvY2FsOkhhc0NoYW5nZWQKICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBDaGVjay1JZkJpdExvY2tlclBXSGFzQ2hhbmdlZAogICAgI2VuZHJlZ2lvbiBSZXR1cm4gVmFsdWVzIChVc2VkIGJ5IG90aGVyIEZ1bmN0aW9ucykKCgoKICAgICNyZWdpb24gU2V0IFNjcmlwdCBXaWRlIFZhcmlhYmxlcwogICAgICAgICNyZWdpb24gR2V0LUJpdExvY2tlclN0YXR1cwogICAgICAgIEZ1bmN0aW9uIEdldC1CaXRMb2NrZXJTdGF0dXMgewogICAgICAgICAgICA8IwogICAgICAgICAgICAgICAgKiBGaWxscyB0d28gc3RyaW5ncyB3aXRoIGN1cnJlbnQgVm9sdW1lIEVuY3J5cHRpb24gU3RhdHVzLCBhbmQgVm9sdW1lIFByb3RlY3Rpb24gU3RhdHVzLiAKICAgICAgICAgICAgICAgICogQWxzbyBtYWtlcyBhIGJvb2wgYXJyYXkgd2l0aCB0cnVlIGZhbHNlIGZvciB8IDE6IFRQTSBwcmVzZW50IHwgMjogUmVjb3ZlcnkgUGFzc3dvcmQgUHJlc2VudAogICAgICAgICAgICAjPgogICAgICAgICAgICBQYXJhbSgKICAgICAgICAgICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5PSRmYWxzZSldCiAgICAgICAgICAgICAgICBbVmFsaWRhdGVOb3ROdWxsT3JFbXB0eSgpXQogICAgICAgICAgICAgICAgW3N0cmluZ10gJERyaXZlTGV0dGVyID0gJE9TRHJpdmVMZXR0ZXIKICAgICAgICAgICAgKQoKICAgICAgICAgICAgIyBIZWxwIHZhcmlhYmxlCiAgICAgICAgICAgICRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyID0gW3N0cmluZ10kKCREcml2ZUxldHRlci5UcmltKCc6JykuVG9VcHBlcigpKQogICAgICAgICAgICBpZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIuJ0xlbmd0aCcgLW5lIDEpIHsKICAgICAgICAgICAgICAgIFRocm93ICdFUlJPUjogRHJpdmUgbGV0dGVyIGNhbm5vdCBiZSBtb3JlIG9yIGxlc3MgdGhhbiBvbmUgbGV0dGVyIScKICAgICAgICAgICAgfQoKICAgICAgICAgICAgIyBHZXQgQml0TG9ja2VyIFN0YXR1cyBmb3IgVm9sdW1lCiAgICAgICAgICAgICRMb2NhbDpCaXRMb2NrZXJWb2x1bWVTdGF0dXMgPSBbTWljcm9zb2Z0LkJpdExvY2tlci5TdHJ1Y3R1cmVzLkJpdExvY2tlclZvbHVtZV0kKEdldC1CaXRMb2NrZXJWb2x1bWUgLU1vdW50UG9pbnQgJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpCiAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEJpdExvY2tlciBWb2x1bWUgRW5jcnlwdGlvbiBTdGF0dXM6IEZ1bGx5RGVjcnlwdGVkIHwgRW5jcnlwdGlvbkluUHJvZ3Jlc3MgfCBGdWxseUVuY3J5cHRlZAogICAgICAgICAgICBOZXctVmFyaWFibGUgLU5hbWUgKCd7MH1Wb2x1bWVFbmNyeXB0aW9uU3RhdHVzJyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpKSAtU2NvcGUgJ1NjcmlwdCcgLUZvcmNlIGAKICAgICAgICAgICAgICAgICAgICAgICAgIC1WYWx1ZSAoW3N0cmluZ10kKCRMb2NhbDpCaXRMb2NrZXJWb2x1bWVTdGF0dXMgfCBTZWxlY3QtT2JqZWN0IC1FeHBhbmRQcm9wZXJ0eSAnVm9sdW1lU3RhdHVzJykpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEJpdExvY2tlciBWb2x1bWUgUHJvdGVjdGlvbiBTdGF0dXM6IE9OIGlmIEVuY3J5cHRpb24gUGVyY2VudGFnZSA9IDEwMCUKICAgICAgICAgICAgTmV3LVZhcmlhYmxlIC1OYW1lICgnezB9Vm9sdW1lUHJvdGVjdGlvblN0YXR1cycgLWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyKSkgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSBgCiAgICAgICAgICAgICAgICAgICAgICAgICAtVmFsdWUgKFtzdHJpbmddJCgkTG9jYWw6Qml0TG9ja2VyVm9sdW1lU3RhdHVzIHwgU2VsZWN0LU9iamVjdCAtRXhwYW5kUHJvcGVydHkgJ1Byb3RlY3Rpb25TdGF0dXMnKSkKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgPCMgIAogICAgICAgICAgICAgICAgICAgIFZvbHVtZSBjYW4gYmUgJ0Z1bGx5IERlY3J5cHRlZCcsIGJ1dCBzdGlsbCBoYXZlIGEgVFBNIHByZXNlbnQuIAogICAgICAgICAgICAgICAgICAgIFRoaXMgaXMgdXN1YWxseSB0aGUgY2FzZSByaWdodCBhZnRlciBlbmNyeXB0aW9uIGhhcyBzdGFydGVkLiAKICAgICAgICAgICAgIz4KCgogICAgICAgICAgICAjIElmIHRoZXJlIGlzIGEgS2V5UHJvdGVjdG9yIGZvciBnaXZlbiB2b2x1bWUsIGdldCB0aGUgcmVzdCBvZiB0aGUgdmFyaWFibGVzCiAgICAgICAgICAgIGlmICgkTG9jYWw6Qml0TG9ja2VyVm9sdW1lU3RhdHVzLidLZXlQcm90ZWN0b3InLidDb3VudCcgLWd0IDApIHsKICAgICAgICAgICAgICAgICMgWzB9ID0gVm9sdW1lIGhhcyBUUE0/ICAgWzFdID0gVm9sdW1lIGhhcyBSZWNvdmVyeSBQYXNzd29yZD8KICAgICAgICAgICAgICAgIE5ldy1WYXJpYWJsZSAtTmFtZSAoJ3swfVZvbHVtZUhhc1RQTWFuZFBXJyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpKSAtU2NvcGUgJ1NjcmlwdCcgLUZvcmNlIGAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtVmFsdWUgKFtib29sW11dJChHZXQtQm9vbERyaXZlSGFzQml0TG9ja2VyVFBNYW5kUFcgLURyaXZlTGV0dGVyICRDdXJyZW50Vm9sdW1lTGV0dGVyKSkgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgRW5jcnlwdGlvbiBQZXJjZW50YWdlOiBIb3cgbG9uZyBoYXMgdGhlIGVuY3J5cHRpb24gcHJvY2VzcyBjb21lCiAgICAgICAgICAgICAgICBOZXctVmFyaWFibGUgLU5hbWUgKCd7MH1Wb2x1bWVFbmNyeXB0aW9uUGVyY2VudGFnZScgLWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyKSkgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSBgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLVZhbHVlIChbc3RyaW5nXSQoJExvY2FsOkJpdExvY2tlclZvbHVtZVN0YXR1cyB8IFNlbGVjdC1PYmplY3QgLUV4cGFuZFByb3BlcnR5ICdFbmNyeXB0aW9uUGVyY2VudGFnZScpLlRvU3RyaW5nKCkpICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBJZiBEcml2ZSBoYXMgVFBNIGFuZCBQVwogICAgICAgICAgICAgICAgaWYgKChHZXQtVmFyaWFibGUgLU5hbWUgKCd7MH1Wb2x1bWVIYXNUUE1hbmRQVycgLWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyKSkgLVNjb3BlICdTY3JpcHQnKS5WYWx1ZVsxXSkgewogICAgICAgICAgICAgICAgICAgICMgTmFtZSB0aGUgdmFyaWFibGVzCiAgICAgICAgICAgICAgICAgICAgJExvY2FsOk5hbWVBcnJheVJlY292ZXJ5UGFzc3dvcmRzID0gW3N0cmluZ10kKCd7MH1BcnJheVJlY292ZXJ5UGFzc3dvcmRzJyAtZiAoJExvY2FsOkN1cnJlbnRWb2x1bWVMZXR0ZXIpKQogICAgICAgICAgICAgICAgICAgICRMb2NhbDpOYW1lQ291bnRSZWNvdmVyeVBhc3N3b3JkcyA9IFtzdHJpbmddJCgnezB9Q291bnRSZWNvdmVyeVBhc3N3b3JkcycgLWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lTGV0dGVyKSkKCiAgICAgICAgICAgICAgICAgICAgIyBHZXQgQXJyYXkgd2l0aCBwcm90ZWN0aW9uIHBhc3N3b3JkcwogICAgICAgICAgICAgICAgICAgIE5ldy1WYXJpYWJsZSAtTmFtZSAkTG9jYWw6TmFtZUFycmF5UmVjb3ZlcnlQYXNzd29yZHMgLVNjb3BlICdTY3JpcHQnIC1Gb3JjZSBgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC1WYWx1ZSAoR2V0LUFycmF5UmVjb3ZlcnlQYXNzd29yZHMgLUJpdExvY2tlclZvbHVtZSAkTG9jYWw6Qml0TG9ja2VyVm9sdW1lU3RhdHVzKQoKICAgICAgICAgICAgICAgICAgICAjIENvdW50IEFycmF5UmVjb3ZlcnlQYXNzd29yZHMKICAgICAgICAgICAgICAgICAgICBOZXctVmFyaWFibGUgLU5hbWUgJExvY2FsOk5hbWVDb3VudFJlY292ZXJ5UGFzc3dvcmRzIC1TY29wZSAnU2NyaXB0JyAtRm9yY2UgYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtVmFsdWUgKFtieXRlXSQoKEdldC1WYXJpYWJsZSAtTmFtZSAkTG9jYWw6TmFtZUFycmF5UmVjb3ZlcnlQYXNzd29yZHMpLidWYWx1ZScpLidMZW5ndGgnKQoKICAgICAgICAgICAgICAgICAgICAjIEdldCBWb2x1bWUgVW5pcXVlIElEICh0byBjaGVjayBpZiBwcm90ZWN0aW9uIHBhc3N3b3JkIGhhcyBjaGFuZ2VkKQogICAgICAgICAgICAgICAgICAgIE5ldy1WYXJpYWJsZSAtTmFtZSAoJ3swfVZvbHVtZVVuaXF1ZUlEJyAtZiAoJExvY2FsOk5hbWVWb2x1bWUpKSAtU2NvcGUgJ1NjcmlwdCcgLUZvcmNlIGAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLVZhbHVlICgoR2V0LVZvbHVtZVVuaXF1ZUlEIC1Ecml2ZUxldHRlciAkTG9jYWw6Q3VycmVudFZvbHVtZUxldHRlcikpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBHZXQtQml0TG9ja2VyU3RhdHVzCiAgICAjZW5kcmVnaW9uIFNldCBTY3JpcHQgV2lkZSBWYXJpYWJsZXMKCgoKICAgICNyZWdpb24gUmVnaXN0cnkgRnVuY3Rpb25zCiAgICAgICAgI3JlZ2lvbiBDcmVhdGUtRW52VmFyaWFibGVzCiAgICAgICAgIyBDcmVhdGUtRW52VmFyaWFibGVzOiBDcmVhdGVzIHZhcmlhYmxlcyB1c2VkIGJ5IHRoZSB0cm91Ymxlc2hvb3RlciBhdCB0aGUgYm90dG9tLCB3aGVuIGZhaWxlZCBydW5zIHJlYWNoZXMgYSBnaXZlbiBudW1iZXIuICAKICAgICAgICBGdW5jdGlvbiBDcmVhdGUtRW52VmFyaWFibGVzIHsKICAgICAgICAgICAgIyMjIyBTY3JpcHQgV2lkZSBWYXJpYWJsZXMKICAgICAgICAgICAgIyMgVGVuYW50CiAgICAgICAgICAgICRMb2NhbDpQYXRoRGlyUmVnVGVuYW50Sm9pbkluZm9CYXNlID0gW3N0cmluZ10kKCdSZWdpc3RyeTo6SEtFWV9MT0NBTF9NQUNISU5FXFNZU1RFTVxDdXJyZW50Q29udHJvbFNldFxDb250cm9sXENsb3VkRG9tYWluSm9pblxKb2luSW5mbycpCiAgICAgICAgICAgICRMb2NhbDpQYXRoRGlyUmVnVGVuYW50Sm9pbkluZm9GdWxsID0gW3N0cmluZ10kKCd7MH1cezF9JyAtZiAoJExvY2FsOlBhdGhEaXJSZWdUZW5hbnRKb2luSW5mb0Jhc2UsCiAgICAgICAgICAgICAgICAoR2V0LUNoaWxkSXRlbSAtUGF0aCAkTG9jYWw6UGF0aERpclJlZ1RlbmFudEpvaW5JbmZvQmFzZSB8IFNlbGVjdC1PYmplY3QgLUV4cGFuZFByb3BlcnR5ICdOYW1lJykuU3BsaXQoJ1wnKVstMV0KICAgICAgICAgICAgKSkKICAgICAgICAgICAgJFNjcmlwdDpOYW1lVGVuYW50ID0gW3N0cmluZ10kKEdldC1JdGVtUHJvcGVydHkgLVBhdGggJExvY2FsOlBhdGhEaXJSZWdUZW5hbnRKb2luSW5mb0Z1bGwpLidVc2VyRW1haWwnLlNwbGl0KCdAJylbMV0KICAgICAgICAgICAgJFNjcmlwdDpOYW1lVGVuYW50U2hvcnQgPSBbc3RyaW5nXSQoJFNjcmlwdDpOYW1lVGVuYW50LlNwbGl0KCcuJylbMF0pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIyBIYXJkd2FyZSBhbmQgV2luZG93cyBpbmZvCiAgICAgICAgICAgICRTY3JpcHQ6Q29tcHV0ZXJNYW51ZmFjdHVyZXIgPSBbc3RyaW5nXSQoUXVlcnktUmVnaXN0cnkgLURpciAnUmVnaXN0cnk6OkhLRVlfTE9DQUxfTUFDSElORVxIQVJEV0FSRVxERVNDUklQVElPTlxTeXN0ZW1cQklPU1xTeXN0ZW1NYW51ZmFjdHVyZXInKQogICAgICAgICAgICBpZiAoLW5vdChbc3RyaW5nXTo6SXNOdWxsT3JFbXB0eSgkU2NyaXB0OkNvbXB1dGVyTWFudWZhY3R1cmVyKSkpIHsKICAgICAgICAgICAgICAgICRTY3JpcHQ6Q29tcHV0ZXJGYW1pbHkgPSBbc3RyaW5nXSQoUXVlcnktUmVnaXN0cnkgLURpciAnUmVnaXN0cnk6OkhLRVlfTE9DQUxfTUFDSElORVxIQVJEV0FSRVxERVNDUklQVElPTlxTeXN0ZW1cQklPU1xTeXN0ZW1GYW1pbHknKQogICAgICAgICAgICAgICAgJFNjcmlwdDpDb21wdXRlclByb2R1Y3ROYW1lID0gW3N0cmluZ10kKFF1ZXJ5LVJlZ2lzdHJ5IC1EaXIgJ1JlZ2lzdHJ5OjpIS0VZX0xPQ0FMX01BQ0hJTkVcSEFSRFdBUkVcREVTQ1JJUFRJT05cU3lzdGVtXEJJT1NcU3lzdGVtUHJvZHVjdE5hbWUnKQogICAgICAgICAgICAgICAgJFNjcmlwdDpXaW5kb3dzRWRpdGlvbiA9IFtzdHJpbmddJChRdWVyeS1SZWdpc3RyeSAtRGlyICdSZWdpc3RyeTo6SEtFWV9MT0NBTF9NQUNISU5FXFNPRlRXQVJFXE1pY3Jvc29mdFxXaW5kb3dzIE5UXEN1cnJlbnRWZXJzaW9uXFByb2R1Y3ROYW1lJykKICAgICAgICAgICAgICAgICRTY3JpcHQ6V2luZG93c1ZlcnNpb24gPSBbc3RyaW5nXSQoUXVlcnktUmVnaXN0cnkgLURpciAnUmVnaXN0cnk6OkhLRVlfTE9DQUxfTUFDSElORVxTT0ZUV0FSRVxNaWNyb3NvZnRcV2luZG93cyBOVFxDdXJyZW50VmVyc2lvblxSZWxlYXNlSWQnKQogICAgICAgICAgICAgICAgJFNjcmlwdDpXaW5kb3dzVmVyc2lvbiArPSBbc3RyaW5nXSQoJyAoezB9KScgLWYgKFF1ZXJ5LVJlZ2lzdHJ5IC1EaXIgJ1JlZ2lzdHJ5OjpIS0VZX0xPQ0FMX01BQ0hJTkVcU09GVFdBUkVcTWljcm9zb2Z0XFdpbmRvd3MgTlRcQ3VycmVudFZlcnNpb25cQ3VycmVudEJ1aWxkJykpCiAgICAgICAgICAgIH0gCiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgJExvY2FsOkVudkluZm8gPSBHZXQtV21pT2JqZWN0IC1DbGFzcyAnV2luMzJfQ29tcHV0ZXJTeXN0ZW0nIHwgU2VsZWN0LU9iamVjdCAtUHJvcGVydHkgJ01hbnVmYWN0dXJlcicsJ01vZGVsJywnU3lzdGVtRmFtaWx5JwogICAgICAgICAgICAgICAgJFNjcmlwdDpDb21wdXRlck1hbnVmYWN0dXJlciA9IFtzdHJpbmddJCgkTG9jYWw6RW52SW5mby4nTWFudWZhY3R1cmVyJykKICAgICAgICAgICAgICAgICRTY3JpcHQ6Q29tcHV0ZXJGYW1pbHkgPSBbc3RyaW5nXSQoJExvY2FsOkVudkluZm8uJ1N5c3RlbUZhbWlseScpCiAgICAgICAgICAgICAgICAkU2NyaXB0OkNvbXB1dGVyUHJvZHVjdE5hbWUgPSBbc3RyaW5nXSQoJExvY2FsOkVudkluZm8uJ01vZGVsJykKICAgICAgICAgICAgICAgICRMb2NhbDpPU0luZm8gPSBHZXQtV21pT2JqZWN0IC1DbGFzcyAnV2luMzJfb3BlcmF0aW5nc3lzdGVtJyB8IFNlbGVjdC1PYmplY3QgLVByb3BlcnR5ICdDYXB0aW9uJywnVmVyc2lvbicKICAgICAgICAgICAgICAgICRTY3JpcHQ6V2luZG93c0VkaXRpb24gPSBbc3RyaW5nXSQoJExvY2FsOk9TSW5mby4nQ2FwdGlvbicpCiAgICAgICAgICAgICAgICAkU2NyaXB0OldpbmRvd3NWZXJzaW9uID0gW3N0cmluZ10kKCRMb2NhbDpPU0luZm8uJ1ZlcnNpb24nKQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gQ3JlYXRlLUVudlZhcmlhYmxlcwoKCiAgICAgICAgI3JlZ2lvbiAgICBRdWVyeS1SZWdpc3RyeQogICAgICAgIEZ1bmN0aW9uIFF1ZXJ5LVJlZ2lzdHJ5IHsKICAgICAgICAgICAgUGFyYW0gKFtQYXJhbWV0ZXIoTWFuZGF0b3J5PSR0cnVlKV0gW3N0cmluZ10gJERpcikKICAgICAgICAgICAgJExvY2FsOk91dCA9IFtzdHJpbmddOjpFbXB0eQogICAgICAgICAgICAkTG9jYWw6S2V5ID0gW3N0cmluZ10kKCREaXIuU3BsaXQoJ3tcfScpWy0xXSkKICAgICAgICAgICAgJExvY2FsOkRpciA9IFtzdHJpbmddJCgkRGlyLlJlcGxhY2UoJExvY2FsOktleSwnJykpCiAgICAgICAgCiAgICAgICAgICAgICRMb2NhbDpFeGlzdHMgPSBHZXQtSXRlbVByb3BlcnR5IC1QYXRoICgnezB9JyAtZiAkRGlyKSAtTmFtZSAoJ3swfScgLWYgJExvY2FsOktleSkgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJwogICAgICAgICAgICBpZiAoJEV4aXN0cykgewogICAgICAgICAgICAgICAgJExvY2FsOk91dCA9ICRMb2NhbDpFeGlzdHMuJExvY2FsOktleQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAkTG9jYWw6T3V0CiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gUXVlcnktUmVnaXN0cnkKICAgICNlbmRyZWdpb24gUmVnaXN0cnkgRnVuY3Rpb25zCgoKCiAgICAjcmVnaW9uICAgIEVkaXQtU2NoZWR1bGVkVGFzawogICAgZnVuY3Rpb24gRWRpdC1TY2hlZHVsZWRUYXNrIHsKICAgICAgICBQYXJhbSgKICAgICAgICAgICAgW1BhcmFtZXRlcihNYW5kYXRvcnk9JGZhbHNlKV0KICAgICAgICAgICAgW3N0cmluZ10gJFRhc2tOYW1lID0gJFNjcmlwdDpTY2hlZHVsZWRUYXNrTmFtZQogICAgICAgICkKCiAgICAgICAgJFRhc2sgPSBHZXQtU2NoZWR1bGVkVGFzayAtVGFza05hbWUgJFRhc2tOYW1lIC1FcnJvckFjdGlvbiAnU2lsZW50bHlDb250aW51ZScKCiAgICAgICAgaWYgKCRUYXNrKSB7CiAgICAgICAgICAgIGlmICgkU2NyaXB0OkJvb2xSZW1vdmVTY2hlZHVsZWRUYXNrQWZ0ZXJGaXJzdFN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICRudWxsID0gVW5yZWdpc3Rlci1TY2hlZHVsZWRUYXNrIC1UYXNrTmFtZSAkVGFzayAtQ29uZmlybTokZmFsc2UgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJwogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdSZW1vdmluZyB0aGUgU2NoZWR1bGVkIHRhc2sgInswfSIuIFN1Y2Nlc3M/IHsxfScgLWYgKCRUYXNrLidUYXNrTmFtZScsJD8uVG9TdHJpbmcoKSkpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAkTG9jYWw6TmV3U2NoZWRUaW1lID0gW2RhdGV0aW1lXSQoW2RhdGV0aW1lXTo6VG9kYXkuQWRkSG91cnMoMTIpKQogICAgICAgICAgICAgICAgJG51bGwgPSBTZXQtU2NoZWR1bGVkVGFzayAtVGFza05hbWUgJFNjcmlwdDpTY2hlZHVsZWRUYXNrTmFtZSAtVHJpZ2dlciAoTmV3LVNjaGVkdWxlZFRhc2tUcmlnZ2VyIC1EYWlseSAtQXQgJExvY2FsOk5ld1NjaGVkVGltZSkgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJwogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdFZGl0aW5nIFNjaGVkdWxlZCB0YXNrICJ7MH0iIHRvIHN0YXJ0IGRhaWx5IGF0IHsxfS4gU3VjY2Vzcz8gezJ9LicgLWYgKCRTY3JpcHQ6U2NoZWR1bGVkVGFza05hbWUsJExvY2FsOk5ld1NjaGVkVGltZS4nSG91cicuVG9TdHJpbmcoKSwkPy5Ub1N0cmluZygpKSkKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgTG9nV3JpdGUgKCdGb3VuZCBubyBTY2hlZHVsZWQgVGFzayB3aXRoIG5hbWUgInswfSIuJyAtZiAoJFRhc2tOYW1lKSkKICAgICAgICB9CiAgICB9CiAgICAjZW5kcmVnaW9uIEVkaXQtU2NoZWR1bGVkVGFzawoKCiAgICAjcmVnaW9uICAgIFByb21wdC1SZWJvb3QKICAgIEZ1bmN0aW9uIFByb21wdC1SZWJvb3QgewogICAgICAgICRMb2NhbDpUaW1lVG9SZWJvb3RJbk1pbnV0ZXMgPSBbdWludDE2XSQoNjApCiAgICAgICAgJExvY2FsOlN0clNob3J0TWVzc2FnZSA9IFtzdHJpbmddJCgnV2luZG93cyB3aWxsIHJlc3RhcnQgaW4gezB9IG1pbnV0ZXMgdG8gZmluaXNoIGRldmljZSBjb25maWd1cmF0aW9uLiBTYXZlIHlvdXIgd29yayEnIC1mICgkTG9jYWw6VGltZVRvUmVib290SW5NaW51dGVzKSkKICAgICAgICAkbnVsbCA9IGNtZC5leGUgL2MgKCdzaHV0ZG93biAvciAvdCB7MH0gL2MgInsxfSInIC1mICgkTG9jYWw6VGltZVRvUmVib290SW5NaW51dGVzKjYwKSwkTG9jYWw6U3RyU2hvcnRNZXNzYWdlKSAyPiYxCiAgICAgICAgaWYgKC1ub3QoJD8pKSB7CiAgICAgICAgICAgICRudWxsID0gY21kLmV4ZSAvYyAoJ3NodXRkb3duIC9hJykgMj4mMQogICAgICAgICAgICAkbnVsbCA9IGNtZC5leGUgL2MgKCdzaHV0ZG93biAvciAvdCB7MH0gL2MgInsxfSInIC1mICgkTG9jYWw6VGltZVRvUmVib290SW5NaW51dGVzKjYwKSwkTG9jYWw6U3RyU2hvcnRNZXNzYWdlKSAyPiYxCiAgICAgICAgfQoKICAgICAgICA8IyBGT1IgRlVUVVJFIEVOSEFOQ0VNRU5UUwogICAgICAgIFtzdHJpbmddICRMb2NhbDpTdHJNZXNzYWdlID0gJ1lvdXIgY29tcHV0ZXIgYXJlIGF3YWl0aW5nIGEgcmVzdGFydDonCiAgICAgICAgJExvY2FsOlN0ck1lc3NhZ2UgKz0gJ3swfSBZb3VyIG9yZ2FuaXphdGlvbiByZXF1aXJlcyB5b3VyIGhhcmQnIC1mICJgcmBuIgogICAgICAgICRMb2NhbDpTdHJNZXNzYWdlICs9ICd7MH0gZHJpdmUgdG8gYmUgZW5jeXB0ZWQuIEluIG9yZGVyIHRvJyAtZiAiYHJgbiIKICAgICAgICAkTG9jYWw6U3RyTWVzc2FnZSArPSAnezB9IGZpbmlzaCB0aGlzIHByb2Nlc3MsIHlvdSBuZWVkIHRvJyAtZiAiYHJgbiIKICAgICAgICAkTG9jYWw6U3RyTWVzc2FnZSArPSAnezB9IHJlc3RhcnQgeW91ciBjb21wdXRlci4gWW91IGNhbicgLWYgImByYG4iCiAgICAgICAgJExvY2FsOlN0ck1lc3NhZ2UgKz0gJ3swfSBlaXRoZXIgZG8gaXQgbWFudWFsbHksIG9yIGl0IHdpbGwnIC1mICJgcmBuIgogICAgICAgICRMb2NhbDpTdHJNZXNzYWdlICs9ICd7MH0gYXV0b21hdGljYWxseSBoYXBwZW4gaW4nIC1mICJgcmBuIgogICAgICAgICRMb2NhbDpTdHJNZXNzYWdlICs9ICd7MH0gezF9IG1pbnV0ZXMuJyAtZiAiYHJgbiIsJExvY2FsOlRpbWVUb1JlYm9vdEluTWludXRlcwogICAgICAgICRMb2NhbDpTdHJNZXNzYWdlICs9ICd7MH17MH0gU0FWRSBZT1VSIFdPUkshJyAtZiAiYHJgbiIKICAgICAgICAjPgogICAgfQogICAgI2VuZHJlZ2lvbiBQcm9tcHQtUmVib290ICAgIAojZW5kcmVnaW9uIEZ1bmN0aW9ucwoKCgojcmVnaW9uIEluaXRpYWxpemUKICAgIExvZ1dyaXRlICgnIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjJykKICAgIExvZ1dyaXRlICgnU3RhcnRpbmcgVHJpZ2dlciBCaXRMb2NrZXIgc2NyaXB0LicpCiAgICBMb2dXcml0ZSAoJyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIycpCiAgICBMb2dXcml0ZSAoJyMjIyBHZXQgc3RhdHMuJykKICAgICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKICAgICMjIEZldGNoIHByZXYgcnVuIHJlc3VsdHMgIyMKICAgICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMgICAgCiAgICBpZiAoLW5vdChUZXN0LVBhdGggLVBhdGggJFNjcmlwdDpGaWxlU3RhdHMpKSB7CiAgICAgICAgJFNjcmlwdDpDb3VudFJ1bnMgPSBbdWludDE2XSQoMCkKICAgICAgICAkU2NyaXB0OklzRmluaXNoZWQxc3RUaW1lID0gJFNjcmlwdDpJc0VuY3J5cHRlZCA9ICRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cgPSAkU2NyaXB0OklzQmFja3VwT0QgPSAkU2NyaXB0OklzQmFja3VwQUFEID0gW2Jvb2xdJCgkZmFsc2UpCiAgICAgICAgJFNjcmlwdDpPU0RyaXZlS2V5SUQgPSAkU2NyaXB0Ok9TRHJpdmVQcm90ZWN0aW9uUGFzc3dvcmQgPSBbc3RyaW5nXTo6RW1wdHkKICAgICAgICBMb2dXcml0ZSAoJyMgRmlyc3QgcnVuIScpCiAgICB9CiAgICBlbHNlIHsKICAgICAgICAkSW5wdXRTdHJpbmcgPSBbc3RyaW5nW11dJChHZXQtQ29udGVudCAtUGF0aCAkU2NyaXB0OkZpbGVTdGF0cykuU3BsaXQoW0Vudmlyb25tZW50XTo6TmV3TGluZSkKICAgICAgICAkU2NyaXB0OkNvdW50UnVucyA9IFt1aW50MTZdJCgkSW5wdXRTdHJpbmdbMF0pCiAgICAgICAgJFNjcmlwdDpJc0ZpbmlzaGVkMXN0VGltZSA9IFt1aW50MTZdJCgkSW5wdXRTdHJpbmdbMV0pCiAgICAgICAgJFNjcmlwdDpJc0VuY3J5cHRlZCA9IFt1aW50MTZdJCgkSW5wdXRTdHJpbmdbMl0pCiAgICAgICAgJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdyA9IFt1aW50MTZdJCgkSW5wdXRTdHJpbmdbM10pCiAgICAgICAgJFNjcmlwdDpJc0JhY2t1cE9EID0gW3VpbnQxNl0kKCRJbnB1dFN0cmluZ1s0XSkKICAgICAgICAkU2NyaXB0OklzQmFja3VwQUFEID0gW3VpbnQxNl0kKCRJbnB1dFN0cmluZ1s1XSkKICAgICAgICAkU2NyaXB0Ok9TRHJpdmVLZXlJRCA9IFtzdHJpbmddJCgkSW5wdXRTdHJpbmdbNl0pCiAgICAgICAgJFNjcmlwdDpPU0RyaXZlUHJvdGVjdGlvblBhc3N3b3JkID0gW3N0cmluZ10kKCRJbnB1dFN0cmluZ1s3XSkKICAgICAgICBMb2dXcml0ZSAoJyMgUHJldmlvdXMgcnVuIHJlc3VsdHM6JykKICAgICAgICBXcml0ZS1TdGF0cyAtUHJldmlvdXNPbmx5ICR0cnVlCiAgICB9CiAgICAKCiAgICAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiAgICAjIyMjIEdldCBjdXJyZW50IHN0YXR1cyAjIyMjCiAgICAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjICAKICAgIExvZ1dyaXRlICgnIyBDdXJyZW50IHN0YXR1czonKQogICAgICAgIAogICAgIyBHZXQgQ3VycmVudCBTdGF0dXMgZm9yIE9TIERyaXZlCiAgICBHZXQtQml0TG9ja2VyU3RhdHVzIC1Ecml2ZUxldHRlciAkU2NyaXB0Ok9TRHJpdmVMZXR0ZXIKICAgIFJlZnJlc2gtQml0TG9ja2VyVmFyaWFibGVzRm9yQ3VycmVudFZvbHVtZSAtRHJpdmVMZXR0ZXIgJFNjcmlwdDpPU0RyaXZlTGV0dGVyCiAgICAKCiAgICBpZiAoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQVykgewogICAgICAgIGlmICgkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzBdKSB7CiAgICAgICAgICAgICRTY3JpcHQ6SXNFbmNyeXB0ZWQgPSBbYm9vbF0kKCRTY3JpcHQ6Vm9sdW1lRW5jcnlwdGlvblN0YXR1cyAtZXEgJFNjcmlwdDpCaXRMb2NrZXJWb2x1bWVFbmNyeXB0aW9uU3RhdHVzZXNbMl0pCiAgICAgICAgfQogICAgICAgIGlmICgkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzFdKSB7CiAgICAgICAgICAgICRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cgPSBbYm9vbF0kKCRTY3JpcHQ6Q291bnRSZWNvdmVyeVBhc3N3b3JkcyAtZXEgMSkKICAgICAgICB9ICAgICAgICAgICAgICAgICAgIAogICAgfQogICAgZWxzZSB7CiAgICAgICAgJFNjcmlwdDpJc0VuY3J5cHRlZCA9ICRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cgPSBbYm9vbF0kKCRmYWxzZSkKICAgIH0KCgogICAgIyBPdGhlciBGaXhlZCBEcml2ZXMKICAgICNUT0RPCiAgICA8IwogICAgW1N0cmluZ1tdXSAkU2NyaXB0OkZpeGVkVm9sdW1lc0xldHRlcnMgPSBAKChHZXQtVm9sdW1lIHwgYAogICAgICAgIFdoZXJlLU9iamVjdCB7JF8uRHJpdmVUeXBlIC1lcSAnRml4ZWQnIC1hbmQgKC1ub3QoW3N0cmluZ106OklzTnVsbE9yRW1wdHkoJF8uRHJpdmVMZXR0ZXIpKSl9IHwgYAogICAgICAgIFdoZXJlLU9iamVjdCB7JF8uRHJpdmVMZXR0ZXIgLW5lICRPU0RyaXZlTGV0dGVyLlJlcGxhY2UoJzonLCcnKX0pLkRyaXZlTGV0dGVyKQogICAgCiAgICAkU2NyaXB0OkZpeGVkVm9sdW1lc0xldHRlcnMgfCBGb3JFYWNoLU9iamVjdCB7CiAgICAgICAgaWYgKC1ub3QoW3N0cmluZ106OklzTnVsbE9yRW1wdHkoJF8pKSkgewogICAgICAgICAgICBHZXQtQml0bG9ja2VyU3RhdHVzIC1Ecml2ZUxldHRlciAkXwogICAgICAgICAgICBpZiAoKEdldC1WYXJpYWJsZSAtTmFtZSAoJ3swfUNvdW50UHJvdGVjdGlvbktleXMnIC1mICRfKSAtU2NvcGUgJ1NjcmlwdCcpLkxlbmd0aCAtZ3QgMCkgewogICAgICAgICAgICAgICAgW3N0cmluZ1tdXSAkU2NyaXB0Ok90aGVyRW5jcnlwdGVkRHJpdmVzICs9IEAoJF8pCiAgICAgICAgICAgIH0KICAgICAgICB9ICAgICAKICAgIH0jPgoKICAgIFdyaXRlLVN0YXRzCiNlbmRyZWdpb24gSW5pdGlhbGl6ZQogICAgCgoKI3JlZ2lvbiBNYWluCiNyZWdpb24gRW5jcnlwdGlvbgojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKIyMjIyBCaXRMb2NrZXIgRW5jcnlwdGlvbiAjIyMjCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwpMb2dXcml0ZSAoJyMjIyBCaXRMb2NrZXIgRW5jcnlwdGlvbicpCgoKCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKIyBCaXRMb2NrZXIgRW5jcnlwdGlvbiBvZiBPUyBEcml2ZSAgIwojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiNyZWdpb24gQml0TG9ja2VyIEVuY3J5cHRpb24gb2YgT1MgRHJpdmUKCkxvZ1dyaXRlICgnIyBCaXRMb2NrZXIgRW5jcnlwdGlvbiBvZiBPUyBEcml2ZScpCmlmICgkU2NyaXB0OklzRW5jcnlwdGVkKSB7CiAgICBMb2dXcml0ZSAoJ09TIERyaXZlIGlzIGFscmVhZHkgZnVsbHkgZW5jcnlwdGVkLicpCn0KZWxzZSB7CiAgICAkU2NyaXB0OkJvb2xEaWRBbnl0aGluZ0NoYW5nZVRoaXNSdW50aW1lID0gW2Jvb2xdJCgkdHJ1ZSkKICAgIAogICAgIyBJZiAnRnVsbHlFbmNyeXB0ZWQnLCBhbmQgVFBNIHByZXNlbnQKICAgICMgTWVhbnMgdGhhdCBPUyBEcml2ZSBpcyBzdWNjZXNzZnVsbHkgZW5jcnlwdGVkIHdpdGggQml0TG9ja2VyCiAgICBpZiAoKCRTY3JpcHQ6Vm9sdW1lRW5jcnlwdGlvblN0YXR1cyAtZXEgJFNjcmlwdDpCaXRMb2NrZXJWb2x1bWVFbmNyeXB0aW9uU3RhdHVzZXNbMl0pIC1hbmQgJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1swXSkgewogICAgICAgIExvZ1dyaXRlICgnT1MgRHJpdmUgaXMgZnVsbHkgZW5jcnlwdGVkIScpCiAgICAgICAgJFNjcmlwdDpJc0VuY3J5cHRlZCA9ICR0cnVlCiAgICB9CiAgICAKCiAgICAjIElmICdFbmNyeXB0aW9uSW5Qcm9ncmVzcycgYW5kIFRQTSBwcmVzZW50CiAgICAjIE1lYW5zIGNvbXB1dGVyIGhhcyByZXN0YXJ0ZWQgYWZ0ZXIgQml0TG9ja2VyIGVuY3J5cHRpb24gd2FzIGVuYWJsZWQuIFdhaXRpbmcgZm9yIHRoZSB2b2x1bWUgdG8gZ2V0IGVuY3J5cHRlZAogICAgZWxzZWlmICgkU2NyaXB0OlZvbHVtZUVuY3J5cHRpb25TdGF0dXMgLWVxICRTY3JpcHQ6Qml0TG9ja2VyVm9sdW1lRW5jcnlwdGlvblN0YXR1c2VzWzFdIC1hbmQgJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1swXSkgewogICAgICAgIExvZ1dyaXRlICgnT1MgRHJpdmUgZW5jcnlwdGlvbiBpcyBpbiBwcm9ncmVzczonKQogICAgICAgIExvZ1dyaXRlICgnUmVzdGFydCBoYXZlIHRha2VuIHBsYWNlLCBhbmQgZW5jcnlwdGlvbiBoYXMgc3RhcnRlZC4nKQogICAgICAgIExvZ1dyaXRlICgnT1MgRHJpdmUgRW5jcnlwdGlvbiBQZXJjZW50YWdlOiB7MH0lLicgLWYgKCRTY3JpcHQ6Vm9sdW1lRW5jcnlwdGlvblBlcmNlbnRhZ2UpKQogICAgICAgIExvZ1dyaXRlICgnQ2FuIGNvbnRpbnVlIHRvIGNoZWNrIGlmIFJlY292ZXJ5IFBhc3N3b3JkIGlzIHByZXNlbnQsIGFuZCBiYWNrdXAgaXQuJykKICAgIH0KCgogICAgIyBJZiAnRnVsbHlEcmVjdHlwdGVkJyAgICAgCiAgICBlbHNlaWYgKCRTY3JpcHQ6Vm9sdW1lRW5jcnlwdGlvblN0YXR1cyAtZXEgJFNjcmlwdDpCaXRMb2NrZXJWb2x1bWVFbmNyeXB0aW9uU3RhdHVzZXNbMF0pIHsKICAgICAgICAKICAgICAgICAjIElmICdGdWxseURyZWN0eXB0ZWQnIGJ1dCB0aGVyZSBleGlzdHMgYSBUUE0KICAgICAgICAjIE1lYW5zIHRoYXQgZW5jcnlwdGlvbiBoYXMgc3RhcnRlZCwgYnV0IGNvbXB1dGVyIGlzIGF3YWl0aW5nIHJlc3RhcnQKICAgICAgICBpZiAoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQVyAtYW5kICRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMF0pIHsKICAgICAgICAgICAgTG9nV3JpdGUgKCdPUyBEcml2ZSBFbmNyeXB0aW9uIGhhcyBzdGFydGVkLCBidXQgY29tcHV0ZXIgaGFzIG5vdCBiZWVuIHJlc3RhcnRlZCB5ZXQuJykKICAgICAgICAgICAgTG9nV3JpdGUgKCdPUyBEcml2ZSBFbmNyeXB0aW9uIFBlcmNlbnRhZ2U6IHswfSUuJyAtZiAoJFNjcmlwdDpWb2x1bWVFbmNyeXB0aW9uUGVyY2VudGFnZSkpCiAgICAgICAgICAgIExvZ1dyaXRlICgnQ2FuIGNvbnRpbnVlIHRvIGNoZWNrIGlmIFJlY292ZXJ5IFBhc3N3b3JkIGlzIHByZXNlbnQsIGFuZCBiYWNrdXAgaXQuJykKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIExvZ1dyaXRlICgnT1MgRHJpdmUgaXMgbm90IGVuY3J5cHRlZC4nKQogICAgICAgICAgICBMb2dXcml0ZSAoJ0F0dGVtcHRpbmcgdG8gRW5hYmxlIEJpdExvY2tlciBvbiBPUyBkcml2ZSAoezB9KScgLWYgKCRPU0RyaXZlKSkKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICMgRW5hYmxlIEJpdExvY2tlciB1c2luZyBUUE0KICAgICAgICAgICAgICAgICRudWxsID0gRW5hYmxlLUJpdExvY2tlciAtTW91bnRQb2ludCAkT1NEcml2ZUxldHRlciAtVHBtUHJvdGVjdG9yIC1Vc2VkU3BhY2VPbmx5OiRmYWxzZSAtSGFyZHdhcmVFbmNyeXB0aW9uOiRmYWxzZSAtRXJyb3JBY3Rpb24gJ0NvbnRpbnVlJwogICAgICAgICAgICAgICAgaWYgKCQ/KSB7CiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdTdWNjZXNzZnVsbHkgZW5hYmxlZCBiaXRsb2NrZXIuJykgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0ZhaWxlZCBFbmFibGluZyBCaXRsb2NrZXIgVHBtUHJvdGVjdG9yLCBpdGBzIHByb2JhYmx5IGFscmVhZHkgZW5hYmxlZCcpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gCiAgICAgICAgICAgIGNhdGNoIHsKICAgICAgICAgICAgICAgIExvZ0Vycm9ycwogICAgICAgICAgICAgICAgRW5hYmxlLUJpdExvY2tlciAtTW91bnRQb2ludCAkT1NEcml2ZUxldHRlciAtVHBtUHJvdGVjdG9yIC1Vc2VkU3BhY2VPbmx5OiRmYWxzZSAtSGFyZHdhcmVFbmNyeXB0aW9uOiRmYWxzZSAtRXJyb3JBY3Rpb24gJ1NpbGVudGx5Q29udGludWUnCiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1dpbGwgYXR0ZW1wdCB0byBFbmFibGUgQml0TG9ja2VyIGFueXdheSBhbmQgdGhlbiBjb250aW51ZS4gU3VjY2Vzcz8gezB9JyAtZiAoJD8pKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZpbmFsbHkgewogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdEaWQgd2UgYWN0dWFsbHkgZW5hYmxlIEJpdExvY2tlcj8nKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFJlZnJlc2ggVmFyaWFibGVzCiAgICAgICAgICAgICAgICBHZXQtQml0TG9ja2VyU3RhdHVzIC1Ecml2ZUxldHRlciAkT1NEcml2ZUxldHRlcgogICAgICAgICAgICAgICAgUmVmcmVzaC1CaXRMb2NrZXJWYXJpYWJsZXNGb3JDdXJyZW50Vm9sdW1lIC1Ecml2ZUxldHRlciAkT1NEcml2ZUxldHRlcgoKICAgICAgICAgICAgICAgICMgQ2hlY2sgcmVzdWx0CiAgICAgICAgICAgICAgICBpZiAoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQVyAtYW5kICRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMF0pIHsKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1RQTSBwcmVzZW50IGZvciBPUyBEcml2ZT8gezB9JyAtZiAoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1swXSkpCiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdQcm9tcHRpbmcgcmVib290LicpCiAgICAgICAgICAgICAgICAgICAgUHJvbXB0LVJlYm9vdAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdFUlJPUiwgbm90IGVuY3J5cHRlZC4gVFBNIG5vdCBwcmVzZW50IGZvciBPUyBEcml2ZScpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAjIElmIHNjZW5hcmlvIGZpdHMgbm9uZSBvZiB0aGUgY2FzZXMgYWJvdmUuLgogICAgZWxzZSB7CiAgICAgICAgTG9nV3JpdGUgKCdOZWl0aGVyICJ7MH0iLCAiezF9IiBvciAiezJ9Ii4nIC1mICgkU2NyaXB0OkJpdExvY2tlclZvbHVtZUVuY3J5cHRpb25TdGF0dXNlc1swXSwkU2NyaXB0OkJpdExvY2tlclZvbHVtZUVuY3J5cHRpb25TdGF0dXNlc1sxXSwkU2NyaXB0OkJpdExvY2tlclZvbHVtZUVuY3J5cHRpb25TdGF0dXNlc1syXSkpCiAgICB9Cn0KI2VuZHJlZ2lvbiBCaXRMb2NrZXIgRW5jcnlwdGlvbiBvZiBPUyBEcml2ZQoKCgojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiMgUHJvdGVjdGlvbiBQYXNzd29yZCBmb3IgT1MgRHJpdmUgICMKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwojcmVnaW9uIFByb3RlY3Rpb24gUGFzc3dvcmQgZm9yIE9TIERyaXZlCgpMb2dXcml0ZSAoJyMgQml0TG9ja2VyIFByb3RlY3Rpb24gUGFzc3dvcmQgZm9yIE9TIERyaXZlJykKIyBJZiAnRnVsbHlFbmNyeXB0ZWQnLCBvciBUTVAgaXMgcHJlc2VudAppZiAoJFNjcmlwdDpJc0VuY3J5cHRlZCAtb3IgKCRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFcgLWFuZCAkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzBdKSkgewogICAgCiAgICAKICAgICMgSWYgd2UncmUgZG9uZSB3aXRoIHJlY292ZXJ5IHBhc3N3b3JkKHMpIGFscmVhZHkKICAgIGlmICgkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3IC1hbmQgKCRTY3JpcHQ6Q291bnRSZWNvdmVyeVBhc3N3b3JkcyAtZXEgMSkpIHsKICAgICAgICBMb2dXcml0ZSAnUmVjb3ZlcnkgUGFzc3dvcmQgZm9yIE9TIERyaXZlIGlzIGFscmVhZHkgcHJlc2VudCcKICAgIH0KICAgIAoKICAgICMgSWYgd2UncmUgbm90IGRvbmUgd2l0aCByZWNvdmVyeSBwYXNzd29yZChzKQogICAgZWxzZSB7ICAgICAgICAKICAgICAgICAkU2NyaXB0OkJvb2xEaWRBbnl0aGluZ0NoYW5nZVRoaXNSdW50aW1lID0gW2Jvb2xdJCgkdHJ1ZSkKICAgICAgICAkTG9jYWw6U3VjY2VzcyA9IFtib29sXSQoJGZhbHNlKQogICAgICAgIAogICAgICAgIAogICAgICAgICMgSWYgdGhlcmUgZXhpc3RzIEJpdExvY2tlciBFbmNyeXB0aW9uIFJlY292ZXJ5IFBhc3N3b3JkICAgICAgIAogICAgICAgIGlmICgkU2NyaXB0OlZvbHVtZUhhc1RQTWFuZFBXWzFdKSB7CiAgICAgICAgICAgIAoKICAgICAgICAgICAgIyBJZiB0aGVyZXMgaXMgX2FfIFByb3RlY3Rpb25QYXNzd29yZCwgd2UncmUgZG9uZQogICAgICAgICAgICBpZiAoJFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzIC1lcSAxKSB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAnT25seSBhIHBhc3N3b3JkIHByZXNlbnQnCiAgICAgICAgICAgICAgICAkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3ID0gJHRydWUKICAgICAgICAgICAgICAgICRMb2NhbDpTdWNjZXNzID0gJHRydWUKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICMgSWYgdGhlcmUgaXMgbXVsdGlwbGUgUmVjb3ZlcnlQYXNzd29yZHMsIHdlIG5lZWQgdG8gcmVtb3ZlIGFsbCBidXQgb25lCiAgICAgICAgICAgIGVsc2VpZiAoJFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzIC1ndCAxKSB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAnTXVsdGlwbGUgcGFzc3dvcmRzIHByZXNlbnQnCiAgICAgICAgICAgICAgICBXcml0ZS1SZWNvdmVyeVBhc3N3b3JkCiAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1dpbGwgcmVtb3ZlIGFsbCBidXQgdGhlIGZpcnN0IG9uZScpCiAgICAgICAgICAgICAgICAkU2NyaXB0OkFycmF5UmVjb3ZlcnlQYXNzd29yZHMgfCBGb3JFYWNoLU9iamVjdCB7IAogICAgICAgICAgICAgICAgICAgIGlmICgkXy4nS2V5UHJvdGVjdG9ySWQnIC1uZSAkU2NyaXB0OkFycmF5UmVjb3ZlcnlQYXNzd29yZHNbMF0uJ0tleVByb3RlY3RvcklkJykgewogICAgICAgICAgICAgICAgICAgICAgICAkbnVsbCA9IFJlbW92ZS1CaXRMb2NrZXJLZXlQcm90ZWN0b3IgLU1vdW50UG9pbnQgJE9TRHJpdmVMZXR0ZXIgLUtleVByb3RlY3RvcklkICRfLidLZXlQcm90ZWN0b3JJZCcKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQ/KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1N1Y2Nlc3NmdWxseSByZW1vdmVkIHwgS2V5UHJvdGVjdG9ySWQgInswfSIgfCBSZWNvdmVyeVBhc3N3b3JkICJ7MX0iJyAtZiAoJF8uJ0tleVByb3RlY3RvcklkJywkXy4nUmVjb3ZlcnlQYXNzd29yZCcpKQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1N1Y2Nlc3NmdWxseSBza2lwcGVkIHRoZSBmaXJzdCBrZXkuIHwgS2V5UHJvdGVjdG9ySWQgInswfSIgfCBSZWNvdmVyeVBhc3N3b3JkICJ7MX0iJyAtZiAoJF8uJ0tleVByb3RlY3RvcklkJywkXy4nUmVjb3ZlcnlQYXNzd29yZCcpKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBHZXQtQml0TG9ja2VyU3RhdHVzCiAgICAgICAgICAgICAgICBpZiAoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQVyAtYW5kICRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMV0gLWFuZCAoJFNjcmlwdDpDb3VudFJlY292ZXJ5UGFzc3dvcmRzIC1lcSAxKSkgewogICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdWNjZXNzID0gJHRydWUKICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgIAogICAgICAgICAgICB9CgoKICAgICAgICAgICAgIyBUaGlzIHNob3VsZCBub3QgYmUgcG9zc2libGUKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBMb2dXcml0ZSAnRVJST1I6IFJlY292ZXJ5UGFzc3dvcmQgcHJlc2VudCwgYnV0IGNvdW50IDwgMScKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgCiAgICAgICAgI3JlZ2lvbiBBZGQgUHJvdGVjdGlvbiBQYXNzd29yZCBJZiBOb25lIFByZXNlbnQKICAgICAgICBlbHNlIHsKICAgICAgICAgICAgTG9nV3JpdGUgKCdObyBCaXRMb2NrZXIgUmVjb3ZlcnkgUGFzc3dvcmRzIGZvdW5kIGZvciBPUyBEcml2ZSB7MH0sIGNyZWF0aW5nIG9uZS4nIC1mICgkT1NEcml2ZUxldHRlcikpCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAkbnVsbCA9IEFkZC1CaXRMb2NrZXJLZXlQcm90ZWN0b3IgLU1vdW50UG9pbnQgJE9TRHJpdmVMZXR0ZXIgLVJlY292ZXJ5UGFzc3dvcmRQcm90ZWN0b3IgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJyAtV2FybmluZ0FjdGlvbiAnU2lsZW50bHlDb250aW51ZScKICAgICAgICAgICAgICAgIGlmICgkPykgewogICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdWNjZXNzID0gJHRydWUKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICRudWxsID0gRW5hYmxlLUJpdExvY2tlciAtTW91bnRQb2ludCAkT1NEcml2ZUxldHRlciAtUmVjb3ZlcnlQYXNzd29yZFByb3RlY3RvciAtRXJyb3JBY3Rpb24gJ1N0b3AnCiAgICAgICAgICAgICAgICAgICAgaWYgKCQ/KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdWNjZXNzID0gJHRydWUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICB9IAogICAgICAgICAgICBjYXRjaCB7CiAgICAgICAgICAgICAgICBMb2dFcnJvcnMKICAgICAgICAgICAgICAgICRudWxsID0gQWRkLUJpdExvY2tlcktleVByb3RlY3RvciAtTW91bnRQb2ludCAkT1NEcml2ZUxldHRlciAtUmVjb3ZlcnlQYXNzd29yZFByb3RlY3RvciAtRXJyb3JBY3Rpb24gJ1NpbGVudGx5Q29udGludWUnIC1XYXJuaW5nQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJwogICAgICAgICAgICAgICAgaWYgKCRMYXN0RXhpdENvZGUgLWVxIDApIHsKICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3VjY2VzcyA9ICR0cnVlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkbnVsbCA9IEVuYWJsZS1CaXRMb2NrZXIgLU1vdW50UG9pbnQgJE9TRHJpdmVMZXR0ZXIgLVJlY292ZXJ5UGFzc3dvcmRQcm90ZWN0b3IgLUVycm9yQWN0aW9uICdTaWxlbnRseUNvbnRpbnVlJwogICAgICAgICAgICAgICAgICAgIGlmICgkPykgewogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3VjY2VzcyA9ICR0cnVlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZpbmFsbHkgewogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdUcmllZCB0byBhZGQgQml0TG9ja2VyIFJlY292ZXJ5UGFzc3dvcmRQcm90ZWN0b3IuIFN1Y2Nlc3M/IHswfS4nIC1mICgkTG9jYWw6U3VjY2VzcykpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gQWRkIFByb3RlY3Rpb24gUGFzc3dvcmQgSWYgTm9uZSBQcmVzZW50CgogICAgICAgIAoKICAgICAgICAjIENvdW50IGFuZCBsaXN0IGV4aXN0aW5nIFJlY292ZXJ5UGFzc3dvcmQsIG9ubHkgd3JpdGUgc3VjY2VzcyBpZiB0aGVyZXMgb25lICAgICAgICAKICAgICAgICBpZiAoJExvY2FsOlN1Y2Nlc3MpIHsKICAgICAgICAgICAgTG9nV3JpdGUgJ0NoZWNraW5nIGlmIHRoZXJlIGlzIG9ubHkgb25lIFByb3RlY3Rpb24gUGFzc3dvcmQuJwogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZWZyZXNoIFZhcmlhYmxlcyBmb3IgY3VycmVudCB2b2x1bWUKICAgICAgICAgICAgR2V0LUJpdExvY2tlclN0YXR1cyAtRHJpdmVMZXR0ZXIgJE9TRHJpdmVMZXR0ZXIKICAgICAgICAgICAgUmVmcmVzaC1CaXRMb2NrZXJWYXJpYWJsZXNGb3JDdXJyZW50Vm9sdW1lIC1Ecml2ZUxldHRlciAkT1NEcml2ZUxldHRlcgoKICAgICAgICAgICAgIyBDaGVjayByZXN1bHRzCiAgICAgICAgICAgICRMb2NhbDpCb29sVGVtcCA9IFtib29sXSQoaWYoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQVyl7KCRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMV0pfWVsc2V7JGZhbHNlfSkKICAgICAgICAgICAgTG9nV3JpdGUgKCdQcm90ZWN0aW9uIFBhc3N3b3JkIFByZXNlbnQ/IHswfScgLWYgKCRMb2NhbDpCb29sVGVtcCkpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICgkTG9jYWw6Qm9vbFRlbXApIHsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKCRTY3JpcHQ6Q291bnRSZWNvdmVyeVBhc3N3b3JkcyAtZXEgMSkgeyAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1NVQ0NFU1MsIGtleXMgbGVmdDogMS4nKQogICAgICAgICAgICAgICAgICAgICRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cgPSAkdHJ1ZQogICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgJ0ZBSUwsIGtleXMgbGVmdDogezB9LicgLWYgKCRTY3JpcHQ6Q291bnRSZWNvdmVyeVBhc3N3b3JkcykKICAgICAgICAgICAgICAgICAgICAkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3ID0gJGZhbHNlCiAgICAgICAgICAgICAgICB9ICAKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnRkFJTCwgbm8gUHJvdGVjdGlvbiBQYXNzd29yZCBmb3VuZCcpCiAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgIAogICAgICAgIH0gICAgICAgICAgICAgICAgICAgIAogICAgICAgIGVsc2UgewogICAgICAgICAgICBMb2dXcml0ZSAoJ1NvbWV0aGluZyBmYWlsZWQnKQogICAgICAgIH0gICAgICAgICAgICAgICAgICAgIAogICAgfQogICAgI2VuZHJlZ2lvbiBJZiB0aGVyZXMgMCBvciBtdWx0aXBsZSBQcm90ZWN0aW9uc1Bhc3N3b3JkKHMpIAp9CgoKIyBOb3QgZW5jcnlwdGVkID0gTm8gbWFraW5nIG9mIFJlY292ZXJ5UGFzc3dvcmQKZWxzZSB7CiAgICBMb2dXcml0ZSAoJ09TIERyaXZlIGlzICJGdWxseURlY3J5cHRlZCIgYW5kIHRoZXJlIGV4aXN0cyBubyAiVFBNIi4nKQogICAgTG9nV3JpdGUgKCdCaXRMb2NrZXIgUmVjb3ZlcnlQYXNzd29yZCBjYW4gbm90IGJlIGFkZGVkIGF0IHRoaXMgdGltZS4nKQogICAgTG9nV3JpdGUgKCdSZWNvdmVyeSBQYXNzd29yZCBwcmVzZW50PyB7MH0nIC1mIChbc3RyaW5nXSQoaWYoJFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQVyl7JFNjcmlwdDpWb2x1bWVIYXNUUE1hbmRQV1swXX1lbHNleyRmYWxzZX0pKSkKICAgICRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cgPSAkZmFsc2UKfQoKIyBXcml0ZSByZWNvdmVyeSBwYXNzd29yZChzKSBpZiBhbnl0aGluZyBjaGFuZ2VkIHRoaXMgcnVudGltZQppZiAoJFNjcmlwdDpCb29sRGlkQW55dGhpbmdDaGFuZ2VUaGlzUnVudGltZSAtYW5kICRTY3JpcHQ6Vm9sdW1lSGFzVFBNYW5kUFdbMV0pIHsKICAgIFdyaXRlLVJlY292ZXJ5UGFzc3dvcmQKfQojZW5kcmVnaW9uIFByb3RlY3Rpb24gUGFzc3dvcmQgZm9yIE9TIERyaXZlCiNlbmRyZWdpb24gRW5jcnlwdGlvbgoKCgojIyMjIyMjIyMjIyMjIyMjIyMjIwojIyMjIyMgQkFDS1VQICMjIyMjIwojIyMjIyMjIyMjIyMjIyMjIyMjIwojcmVnaW9uIEJhY2t1cAoKCkxvZ1dyaXRlICgnIyMjIEJhY2t1cCBQcm90ZWN0aW9uIFBhc3N3b3JkIHRvIEF6dXJlQUFEIGFuZCBPbmVEcml2ZTRCJykKCiMgQ2hlY2sgZm9yIGNoYW5nZXMgaWYgRmluaXNoZWQxc3RUaW1lCmlmICgkU2NyaXB0OklzRmluaXNoZWQxc3RUaW1lIC1vciAkU2NyaXB0OklzQmFja3VwQUFEIC1hbmQgW2Jvb2xdJChbYm9vbF0kKCRTY3JpcHQ6Qm9vbEJhY2t1cFRvT25lRHJpdmVGb3JCdXNpbmVzcyAtYW5kICRTY3JpcHQ6SXNCYWNrdXBPRCkgLW9yIFtib29sXSQoLW5vdCgkU2NyaXB0OkJvb2xCYWNrdXBUb09uZURyaXZlRm9yQnVzaW5lc3MpKSkpIHsKICAgIExvZ1dyaXRlICgnRHJpdmUgaXMgYWxyZWFkeSBiYWNrZWQgdXAuJykKICAgIExvZ1dyaXRlICgnV2lsbCBjaGVjayBpZiBhbnl0aGluZyBoYXMgY2hhbmdlZC4nKQoKICAgIGlmIChDaGVjay1JZkJpdExvY2tlclBXSGFzQ2hhbmdlZCkgewogICAgICAgIExvZ1dyaXRlICdTb21ldGhpbmcgaGFzIGNoYW5nZWQsIEJpdExvY2tlciBSZWNvdmVyeSBQcm90ZWN0aW9uIFBhc3N3b3JkIGlzIG5vdCB0aGUgc2FtZSBhcyB0aGUgb25lIGJhY2tlZCB1cC4nCiAgICAgICAgJFNjcmlwdDpJc0JhY2t1cEFBRCA9ICRTY3JpcHQ6SXNCYWNrdXBPRCA9ICRmYWxzZQogICAgICAgICRTY3JpcHQ6Qm9vbERpZEFueXRoaW5nQ2hhbmdlVGhpc1J1bnRpbWUgPSAkdHJ1ZQogICAgfQogICAgZWxzZSB7CiAgICAgICAgTG9nV3JpdGUgJ05vdGhpbmcgaGFzIGNoYW5nZWQsIEJpdExvY2tlciBSZWNvdmVyeSBQcm90ZWN0aW9uIFBhc3N3b3JkIGlzIHRoZSBzYW1lIGFzIHRoZSBvbmUgcHJldmlvdXNseSBiYWNrZWQgdXAuJwogICAgfQp9CgoKIyBJZiBubyBiYWNrdXBzCmlmICgtbm90KCRTY3JpcHQ6SXNCYWNrdXBBQUQgLWFuZCBbYm9vbF0kKFtib29sXSQoJFNjcmlwdDpCb29sQmFja3VwVG9PbmVEcml2ZUZvckJ1c2luZXNzIC1hbmQgJFNjcmlwdDpJc0JhY2t1cE9EKSAtb3IgW2Jvb2xdJCgtbm90KCRTY3JpcHQ6Qm9vbEJhY2t1cFRvT25lRHJpdmVGb3JCdXNpbmVzcykpKSkpIHsKICAgICMgSWYgUHJvdGVjdGlvblBhc3N3b3JkKHMpIGV4aXN0CiAgICBpZiAoJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdykgewogICAgICAgICAgICAKICAgICAgICBMb2dXcml0ZSAoJ09TIERyaXZlIGlzIGVuY3J5cHRlZCwgYW5kIHRoZXJlIGFyZSB7MH0gUHJvdGVjdGlvblBhc3N3b3JkKHMpIHByZXNlbnQuJyAtZiAoJFNjcmlwdDpBcnJheVJlY292ZXJ5UGFzc3dvcmRzLidDb3VudCcpKQogICAgICAgIExvZ1dyaXRlICgnV3JpdGluZyBleGlzdGluZyBSZWNvdmVyeVBhc3N3b3JkIGZvciBjdXJyZW50IGRyaXZlLCBmb3IgZnV0dXJlIHJlZmVyZW5jZS4uLicpCiAgICAgICAgJG51bGwgPSBDaGVjay1JZkJpdExvY2tlclBXSGFzQ2hhbmdlZAogICAgICAgIAogICAgICAgIExvZ1dyaXRlICgnQ29udGludWluZyB3aXRoIGJhY2t1cC4nKQoKICAgIAogICAgICAgICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwogICAgICAgICMgT25lRHJpdmUgZm9yIEJ1c2luZXNzIGJhY2t1cAogICAgICAgICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwogICAgICAgICNyZWdpb24gQmFja3VwIE9uZURyaXZlIGZvciBCdXNpbmVzcwogICAgCiAgICAgICAgTG9nV3JpdGUgKCcjIEJhY2t1cCB0byBPbmVEcml2ZScpCiAgICAgICAgaWYgKC1ub3QkU2NyaXB0OkJvb2xCYWNrdXBUb09uZURyaXZlRm9yQnVzaW5lc3MpIHsKICAgICAgICAgICAgTG9nV3JpdGUgKCdEaXNhYmxlZCBpbiBzY3JpcHQgc2V0dGluZ3MuJykKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIExvZ1dyaXRlICgnRW5hYmxlZCBpbiBzY3JpcHQgc2V0dGluZ3MuJykKICAgICAgICAgICAgaWYgKCRTY3JpcHQ6SXNCYWNrdXBPRCkgewogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdBbHJlYWR5IGRvbmUnKQogICAgICAgICAgICB9ICAgICAgICAgICAgICAgIAogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICRTY3JpcHQ6Qm9vbERpZEFueXRoaW5nQ2hhbmdlVGhpc1J1bnRpbWUgPSAkdHJ1ZQogICAgICAgICAgICAKICAgICAgICAgICAgICAgIFRyeSB7CiAgICAgICAgICAgICAgICAgICAgIyBHZXQgQ3VycmVudCBVc2VyIGFzIFNlY3VyaXR5SWRlbnRpZmllcgogICAgICAgICAgICAgICAgICAgIGlmICgtbm90KCRTY3JpcHQ6UGF0aERpclJvb3RDVSkpewogICAgICAgICAgICAgICAgICAgICAgICAkU2NyaXB0OlBhdGhEaXJSb290Q1UgPSBbc3RyaW5nXSQoJ1JlZ2lzdHJ5OjpIS0VZX1VTRVJTXHswfVwnIC1mIChbU3lzdGVtLlNlY3VyaXR5LlByaW5jaXBhbC5OVEFjY291bnRdOjpuZXcoKEdldC1Qcm9jZXNzIC1OYW1lICdleHBsb3JlcicgLUluY2x1ZGVVc2VyTmFtZSB8IFNlbGVjdC1PYmplY3QgLUV4cGFuZFByb3BlcnR5ICdVc2VyTmFtZScgLUZpcnN0IDEpKS5UcmFuc2xhdGUoW1N5c3RlbS5TZWN1cml0eS5QcmluY2lwYWwuU2VjdXJpdHlJZGVudGlmaWVyXSkuJ1ZhbHVlJykpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCgtbm90KCQ/KSkgLW9yIFtzdHJpbmddOjpJc051bGxPckVtcHR5KCRQYXRoRGlyUm9vdENVKSl7QnJlYWt9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEdldCBPbmVEcml2ZSBmb3IgQnVzaW5lc3MgcGF0aCBmcm9tIHJlZ2lzdHJ5ICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAkUmVnVmFsdWVzID0gW2FycmF5XSQoR2V0LUNoaWxkSXRlbSAtUGF0aCAoJ3swfVxTT0ZUV0FSRVxNaWNyb3NvZnRcT25lRHJpdmVcQWNjb3VudHNcJyAtZiAoJFBhdGhEaXJSb290Q1UpKSB8IFdoZXJlLU9iamVjdCAtUHJvcGVydHkgJ05hbWUnIC1saWtlICcqXEJ1c2luZXNzKicpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBFeGl0IFRyeS9DYXRjaCBpZiBubyBhY2NvdW50cyB3aGVyZSBmb3VuZAogICAgICAgICAgICAgICAgICAgIGlmICgkUmVnVmFsdWVzLidDb3VudCcgLWxlIDApIHsgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgJFNjcmlwdDpJc0JhY2t1cE9EID0gJGZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIFRocm93ICgnRmFpbGVkIHRvIGZpbmQgT25lRHJpdmUgZm9yIEJ1c2luZXNzIGFjY291bnRzLicpCiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAjIEZvciBlYWNoIGZvdW5kIE9uZURyaXZlIGZvciBCdXNpbmVzcyBhY2NvdW50CiAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJFJlZ1ZhbHVlIGluICRSZWdWYWx1ZXMpIHsgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlBhdGhEaXJPRDRCID0gW3N0cmluZ10kKEdldC1JdGVtUHJvcGVydHkgLVBhdGggJFJlZ1ZhbHVlLidOYW1lJy5SZXBsYWNlKCdIS0VZX1VTRVJTXCcsJ1JlZ2lzdHJ5OjpIS0VZX1VTRVJTXCcpIC1OYW1lICdVc2VyRm9sZGVyJykuJ1VzZXJGb2xkZXInCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIEV4aXQgVHJ5L0NhdGNoIGlmIGZhaWxlZCB0byBidWlsZCBwYXRoIGZvciBPbmVEcml2ZSBmb3IgQnVzaW5lc3MgZm9sZGVyICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRMb2NhbDpQYXRoRGlyT0Q0QiAtbm90bGlrZSAoJ3swfVxVc2Vyc1wqXE9uZURyaXZlIC0qJyAtZiAoJE9TRHJpdmUpKSAtYW5kICgtbm90W2Jvb2xdJChUZXN0LVBhdGggLVBhdGggJExvY2FsOlBhdGhEaXJPRDRCKSkpIHsgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkU2NyaXB0OklzQmFja3VwT0QgPSAkZmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRocm93ICgnRmFpbGVkIHRvIGJ1aWxkIE9uZURyaXZlIHBhdGggKCJ7MH0iKSwgb3IgaXQgZG9lcyBub3QgZXhpc3QuJyAtZiAoJExvY2FsOlBhdGgpKQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgQ3JlYXRlIHNjcmlwdCB2YXJpYWJsZXMgaWYgdGhleSBkbyBub3QgZXhpc3QgYWxyZWFkeQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoLW5vdCgkU2NyaXB0OkNvbXB1dGVyUHJvZHVjdE5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDcmVhdGUtRW52VmFyaWFibGVzCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIFJ1bnRpbWUgdmFyaWFibGUKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOkJvb2xGb2xkZXJFeGlzdHMgPSBbYm9vbF0kKCRmYWxzZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAoKICAgICAgICAgICAgICAgICAgICAgICAgIyBDcmVhdGluZyBwYXRocwogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6UGF0aERpck9ENEJCYWNrdXBQYXJlbnQgPSBbc3RyaW5nXSQoJ3swfVxCaXRMb2NrZXIgUmVjb3ZlcnlcJyAtZiAoJExvY2FsOlBhdGhEaXJPRDRCKSkKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwID0gW3N0cmluZ10kKCd7MH17MX0gKHsyfSB7M30pXCcgLWYgKCRMb2NhbDpQYXRoRGlyT0Q0QkJhY2t1cFBhcmVudCwkU2NyaXB0OkNvbXB1dGVyTmFtZSwkU2NyaXB0OkNvbXB1dGVyTWFudWZhY3R1cmVyLCRTY3JpcHQ6Q29tcHV0ZXJQcm9kdWN0TmFtZSkpCiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnT25lRHJpdmUgZm9yIEJ1c2luZXNzIFBhdGg6IHswfScgLWYgKCRMb2NhbDpQYXRoRGlyT0Q0QikpCiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnQmFja3VwIFBhdGggUGFyZW50OiAgICAgICAgIHswfScgLWYgKCRMb2NhbDpQYXRoRGlyT0Q0QkJhY2t1cFBhcmVudCkpCiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnQmFja3VwIFBhdGggZm9yIEJpdGxvY2tlciBSZWNvdmVyeSBLZXkocyk6IHswfScgLWYgKCRMb2NhbDpQYXRoRGlyT0Q0QkJhY2t1cCkpIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgCgogICAgICAgICAgICAgICAgICAgICAgICAjVGVzdGluZyBpZiBSZWNvdmVyeSBmb2xkZXIgZXhpc3RzIGlmIG5vdCBjcmVhdGUgb25lCiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnVGVzdGluZyBpZiBiYWNrdXAgZm9sZGVyIGV4aXN0cywgY3JlYXRlIGl0IGlmIG5vdC4nKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoVGVzdC1QYXRoIC1QYXRoICRMb2NhbDpQYXRoRGlyT0Q0QkJhY2t1cCAtRXJyb3JBY3Rpb24gJ1NpbGVudGx5Q29udGludWUnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6Qm9vbEZvbGRlckV4aXN0cyA9ICR0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAnQ3JlYXRpbmcgT25lRHJpdmUgZm9yIEJ1c2luZXNzIGZvbGRlciBmb3IgYmFja3VwLicKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRudWxsID0gTmV3LUl0ZW0gLVBhdGggJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwIC1JdGVtVHlwZSAnRGlyZWN0b3J5JyAtRm9yY2UgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6Qm9vbEZvbGRlckV4aXN0cyA9IFRlc3QtUGF0aCAtUGF0aCAkTG9jYWw6UGF0aERpck9ENEJCYWNrdXAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnezB9JyAtZiAkKGlmKCRMb2NhbDpCb29sRm9sZGVyRXhpc3RzKXsnU3VjY2Vzcy4nfWVsc2V7J0ZhaWxlZC4nfSkpCiAgICAgICAgICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAoKICAgICAgICAgICAgICAgICAgICAgICAgIyBFeGl0IFRyeS9DYXRjaCBvZiBmYWlsZWQgdG8gY3JlYXRlIE9uZURyaXZlIGZvciBCdXNpbmVzcyBCYWNrdXAgaWYgaXQgZGlkbid0IGV4aXN0CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgtbm90KCRMb2NhbDpCb29sRm9sZGVyRXhpc3RzKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJFNjcmlwdDpJc0JhY2t1cE9EID0gJGZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaHJvdyAnRmFpbGVkIHRvIGNoZWNrIG9yIGNyZWF0ZSBmb2xkZXIuJwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIE1ha2Ugc3VyZSAnQml0TG9ja2VyIFJlY292ZXJ5JyBmb2xkZXIgaXMgaGlkZGVuCiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnTWFraW5nIHN1cmUgInswfSIgaXMgaGlkZGVuLicgLWYgKCRMb2NhbDpQYXRoRGlyT0Q0QkJhY2t1cFBhcmVudCkpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoR2V0LUl0ZW0gLVBhdGggJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwUGFyZW50IC1Gb3JjZSkuQXR0cmlidXRlcyAtbm90bGlrZSAnKmhpZGRlbionKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoR2V0LUl0ZW0gLVBhdGggJExvY2FsOlBhdGhEaXJPRDRCQmFja3VwUGFyZW50IC1Gb3JjZSkuQXR0cmlidXRlcyA9IChHZXQtSXRlbSAtUGF0aCAkTG9jYWw6UGF0aERpck9ENEJCYWNrdXBQYXJlbnQgLUZvcmNlKS5BdHRyaWJ1dGVzIC1ib3IgJ0hpZGRlbicKICAgICAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnU3VjY2Vzc2Z1bGx5IGhpZGRlbj8gezB9LicgLWYgKCQ/KSkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnQWxyZWFkeSBoaWRkZW4uJykKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAoKICAgICAgICAgICAgICAgICAgICAgICAgIyBHZXQgQXJyYXlSZWNvdmVyeVBhc3N3b3JkcyBmb3IgY3VycmVudCB2b2x1bWUKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOkN1cnJlbnRWb2x1bWVBcnJheVJlY292ZXJ5UGFzc3dvcmRzID0gR2V0LVZhcmlhYmxlIC1OYW1lICgnezB9QXJyYXlSZWNvdmVyeVBhc3N3b3JkcycgLWYgKCRPU0RyaXZlTGV0dGVyKSkgLVNjb3BlICdTY3JpcHQnIC1WYWx1ZU9ubHkgLUVycm9yQWN0aW9uICdTdG9wJwoKICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIENyZWF0ZSBzdHJpbmcgZm9yIEJpdExvY2tlclJlY292ZXJ5UGFzc3dvcmQudHh0CiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzID0gW3N0cmluZ106OkVtcHR5CiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICgnQml0TG9ja2VyIFJlY292ZXJ5UGFzc3dvcmQgZm9yIE9TIERyaXZlICh7MH0pezF9JyAtZiAoJGVudjpTeXN0ZW1Ecml2ZSwiYHJgbiIpKQogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSBHZXQtU3RyaW5nUmVjb3ZlcnlQYXNzd29yZHMKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gImByYG5gcmBuIgogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAnQml0TG9ja2VyIERyaXZlIEVuY3J5cHRpb24gcmVjb3Zlcnkga2V5ezB9JyAtZiAiYHJgbiIKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gJ1RvIHZlcmlmeSB0aGF0IHRoaXMgaXMgdGhlIGNvcnJlY3QgcmVjb3Zlcnkga2V5LCBjb21wYXJlIHRoZSBzdGFydCBvZiB0aGUgZm9sbG93aW5nezB9JyAtZiAiYHJgbiIKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gJ2lkZW50aWZpZXIgd2l0aCB0aGUgaWRlbnRpZmllciB2YWx1ZSBkaXNwbGF5ZWQgb24geW91ciBQQy4nCiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICJgcmBuYHJgbiIKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gKCdJZGVudGlmaWVyOiB7MH0nIC1mICgkTG9jYWw6Q3VycmVudFZvbHVtZUFycmF5UmVjb3ZlcnlQYXNzd29yZHNbMF0uS2V5UHJvdGVjdG9ySWQpKQogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAiYHJgbmByYG4iCiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICdJZiB0aGUgYWJvdmUgaWRlbnRpZmllciBtYXRjaGVzIHRoZSBvbmUgZGlzcGxheWVkIGJ5IHlvdXIgUEMsezB9JyAtZiAiYHJgbiIKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gJ3RoZW4gdXNlIHRoZSBmb2xsb3dpbmcga2V5IHRvICB1bmxvY2sgeW91ciBkcml2ZTonCiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICJgcmBuYHJgbiIKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gKCdSZWNvdmVyeSBLZXk6IHswfScgLWYgKCRMb2NhbDpDdXJyZW50Vm9sdW1lQXJyYXlSZWNvdmVyeVBhc3N3b3Jkc1swXS5SZWNvdmVyeVBhc3N3b3JkKSkKICAgICAgICAgICAgICAgICAgICAgICAgJExvY2FsOlN0clJlY1Bhc3MgKz0gImByYG5gcmBuIgogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAnSWYgdGhlIGFib3ZlIGlkZW50aWZpZXIgZG9lc25gdCBtYXRjaCB0aGUgb25lIGRpc3BsYXllZCBieSB5b3VyIFBDLHswfScgLWYgImByYG4iCiAgICAgICAgICAgICAgICAgICAgICAgICRMb2NhbDpTdHJSZWNQYXNzICs9ICd0aGVuIHRoaXMgaXNuYHQgdGhlIHJpZ2h0IGtleSB0byB1bmxvY2sgeW91ciBkcml2ZS57MH0nIC1mICJgcmBuIgogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAnVHJ5IGFub3RoZXIgcmVjb3Zlcnkga2V5LCBvciByZWZlciB0b3swfScgLWYgImByYG4iIAogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6U3RyUmVjUGFzcyArPSAnaHR0cHM6Ly9nby5taWNyb3NvZnQuY29tL2Z3bGluay8/TGlua0lEPTI2MDU4OSBmb3IgYWRkaXRpb25hbCBhc3Npc3RhbmNlLicKCgogICAgICAgICAgICAgICAgICAgICAgICAjIE91dC1GaWxlIHRoZSBzdHJpbmcKICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgJ0NyZWF0aW5nIGJhY2t1cCBpbiBPbmVEcml2ZSBmb3IgQnVzaW5lc3MuJwogICAgICAgICAgICAgICAgICAgICAgICAkTG9jYWw6T0Q0QkJhY2t1cEZpbGVQYXRoID0gW3N0cmluZ10kKCd7MH1CaXRsb2NrZXJSZWNvdmVyeVBhc3N3b3JkLXsxfS50eHQnIC1mICgkTG9jYWw6UGF0aERpck9ENEJCYWNrdXAsKEdldC1EYXRlIC1Gb3JtYXQgJ3l5TU1kZGhobW1zcycpKSkKICAgICAgICAgICAgICAgICAgICAgICAgT3V0LUZpbGUgLUZpbGVQYXRoICRMb2NhbDpPRDRCQmFja3VwRmlsZVBhdGggLUVuY29kaW5nICd1dGY4JyAtRm9yY2UgLUlucHV0T2JqZWN0ICgkTG9jYWw6U3RyUmVjUGFzcykKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFRlc3QtUGF0aCAtUGF0aCAkTG9jYWw6T0Q0QkJhY2t1cEZpbGVQYXRoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkU2NyaXB0OklzQmFja3VwT0QgPSAkdHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgCgoKICAgICAgICAgICAgICAgICAgICAgICAgIyBPbmVEcml2ZSBmb3IgQnVzaW5lc3MgQmFja3VwIFN1Y2Nlc3M/CiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnU3VjY2Vzcz8gezB9JyAtZiAoJFNjcmlwdDpJc0JhY2t1cE9EKSkKICAgICAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIENhdGNoIHsKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0Vycm9yIHdoaWxlIGJhY2t1cCB0byBPbmVEcml2ZSwgbWFrZSBzdXJlIHRoYXQgeW91IGFyZSBBQUQgam9pbmVkIGFuZCBhcmUgcnVubmluZyB0aGUgY21kbGV0IGFzIGFuIGFkbWluLicpCiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdFcnJvciBtZXNzYWdlOicgKyAiYHJgbiIgKyAoJF8pKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgRmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdEaWQgYmFja3VwIHRvIE9uZURyaXZlIHN1Y2NlZWQ/IHswfScgLWYgKCRTY3JpcHQ6SXNCYWNrdXBPRCkpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgI2VuZHJlZ2lvbiBCYWNrdXAgT25lRHJpdmUgZm9yIEJ1c2luZXNzCiAgICAKCgogICAgICAgICMjIyMjIyMjIyMjIyMjIyMjCiAgICAgICAgIyBBenVyZSBBRCBCYWNrdXAKICAgICAgICAjIyMjIyMjIyMjIyMjIyMjIwogICAgICAgICNyZWdpb24gQmFja3VwIEF6dXJlIEFBRAoKICAgICAgICBMb2dXcml0ZSAoJyMgQmFja3VwIHRvIEF6dXJlIEFEJykKICAgICAgICBpZiAoJFNjcmlwdDpJc0JhY2t1cEFBRCkgewogICAgICAgICAgICBMb2dXcml0ZSAoJ0FscmVhZHkgZG9uZScpCiAgICAgICAgfQogICAgICAgIAogICAgICAgIGVsc2UgewogICAgICAgICAgICAkU2NyaXB0OkJvb2xEaWRBbnl0aGluZ0NoYW5nZVRoaXNSdW50aW1lID0gJHRydWUKICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgVHJ5IHsKICAgICAgICAgICAgICAgICMgR2V0IEFycmF5UmVjb3ZlcnlQYXNzd29yZHMgZm9yIGN1cnJlbnQgdm9sdW1lCiAgICAgICAgICAgICAgICAkTG9jYWw6Q3VycmVudFZvbHVtZUFycmF5UmVjb3ZlcnlQYXNzd29yZHMgPSBHZXQtVmFyaWFibGUgLU5hbWUgKCd7MH1BcnJheVJlY292ZXJ5UGFzc3dvcmRzJyAtZiAoJE9TRHJpdmVMZXR0ZXIpKSAtU2NvcGUgJ1NjcmlwdCcgLVZhbHVlT25seSAtRXJyb3JBY3Rpb24gJ1N0b3AnCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ2hlY2sgaWYgd2UgY2FuIHVzZSBCYWNrdXBUb0FBRC1CaXRMb2NrZXJLZXlQcm90ZWN0b3IgY29tbWFuZGxldCAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIExvZ1dyaXRlICdDaGVja2luZyBpZiB3ZSBjYW4gdXNlICJCYWNrdXBUb0FBRC1CaXRMb2NrZXJLZXlQcm90ZWN0b3IiIGNvbW1hbmRsZXQuJwoKICAgICAgICAgICAgICAgIGlmIChHZXQtQ29tbWFuZCAtTmFtZSAnQmFja3VwVG9BQUQtQml0TG9ja2VyS2V5UHJvdGVjdG9yJyAtRXJyb3JBY3Rpb24gJ1NpbGVudGx5Q29udGludWUnKSB7ICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0NvbW1hbmRsZXQgZXhpc3RzIScgLWYgKCRMb2NhbDpDbWROYW1lKSkgCiAgICAgICAgICAgICAgICAgICAgJG51bGwgPSBCYWNrdXBUb0FBRC1CaXRMb2NrZXJLZXlQcm90ZWN0b3IgLU1vdW50UG9pbnQgJE9TRHJpdmVMZXR0ZXIgLUtleVByb3RlY3RvcklkICRMb2NhbDpDdXJyZW50Vm9sdW1lQXJyYXlSZWNvdmVyeVBhc3N3b3Jkc1swXS4nS2V5UHJvdGVjdG9ySWQnIC1FcnJvckFjdGlvbiAnU2lsZW50bHlDb250aW51ZScKICAgICAgICAgICAgICAgICAgICBpZiAoJD8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJFNjcmlwdDpJc0JhY2t1cEFBRCA9ICR0cnVlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAkbnVsbCA9IEJhY2t1cFRvQUFELUJpdExvY2tlcktleVByb3RlY3RvciAtTW91bnRQb2ludCAkT1NEcml2ZUxldHRlciAtS2V5UHJvdGVjdG9ySWQgJExvY2FsOkN1cnJlbnRWb2x1bWVBcnJheVJlY292ZXJ5UGFzc3dvcmRzWzBdLktleVByb3RlY3RvcklkIC1FcnJvckFjdGlvbiAnU3RvcCcKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQ/KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkU2NyaXB0OklzQmFja3VwQUFEID0gJHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ1N1Y2Nlc3M/IHswfScgLWYgKCRTY3JpcHQ6SXNCYWNrdXBBQUQpKQogICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgICAgIGVsc2UgeyAKICAgICAgICAgICAgICAgICAgICAjIEJhY2t1cFRvQUFELUJpdExvY2tlcktleVByb3RlY3RvciBjb21tYW5kbGV0IG5vdCBhdmFpbGFibGUsIHVzaW5nIG90aGVyIG1lY2hhbmlzbSAKICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAnQmFja3VwVG9BQUQtQml0TG9ja2VyS2V5UHJvdGVjdG9yIGNvbW1hbmRsZXQgbm90IGF2YWlsYWJsZSwgdXNpbmcgb3RoZXIgbWVjaGFuaXNtLicgCiAgICAgICAgICAgICAgICAgICAgIyBHZXQgdGhlIEFBRCBNYWNoaW5lIENlcnRpZmljYXRlCiAgICAgICAgICAgICAgICAgICAgJENlcnRpZmljYXRlICAgICAgICAgICA9ICQoW2FycmF5XSQoR2V0LUNoaWxkSXRlbSAtUGF0aCAnQ2VydDpcTG9jYWxNYWNoaW5lXE15XCcpLldoZXJleyRfLidJc3N1ZXInIC1tYXRjaCAnQ049TVMtT3JnYW5pemF0aW9uLUFjY2Vzcyd9KQogICAgICAgICAgICAgICAgICAgICRDZXJ0aWZpY2F0ZVRodW1icHJpbnQgPSBbc3RyaW5nXSQoJENlcnRpZmljYXRlIHwgU2VsZWN0LU9iamVjdCAtRXhwYW5kUHJvcGVydHkgJ1RodW1icHJpbnQnKQogICAgICAgICAgICAgICAgICAgICRDZXJ0aWZpY2F0ZVN1YmplY3QgICAgPSBbc3RyaW5nXSQoW3N0cmluZ10kKCRDZXJ0aWZpY2F0ZSB8IFNlbGVjdC1PYmplY3QgLUV4cGFuZFByb3BlcnR5ICdTdWJqZWN0JykuUmVwbGFjZSgnQ049JywnJykpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBHZXQgdGVuYW50IGRvbWFpbiBuYW1lIGZyb20gcmVnaXN0cnkKICAgICAgICAgICAgICAgICAgICAkVGVuYW50RG9tYWluID0gW3N0cmluZ10kKFtzdHJpbmddJChHZXQtSXRlbVByb3BlcnR5IC1QYXRoICgnUmVnaXN0cnk6OkhLRVlfTE9DQUxfTUFDSElORVxTWVNURU1cQ3VycmVudENvbnRyb2xTZXRcQ29udHJvbFxDbG91ZERvbWFpbkpvaW5cSm9pbkluZm9cezB9JyAtZiAoJENlcnRpZmljYXRlVGh1bWJwcmludCkpIC1OYW1lICdVc2VyRW1haWwnIHwgU2VsZWN0LU9iamVjdCAtRXhwYW5kUHJvcGVydHkgJ1VzZXJFbWFpbCcpLlNwbGl0KCdAJylbLTFdKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTWFrZSBzdXJlIHdlIGhhdmUgdmFsaWQgdmFsdWVzCiAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJFZhcmlhYmxlIGluIFthcnJheV0kKCRDZXJ0aWZpY2F0ZVRodW1icHJpbnQsJENlcnRpZmljYXRlU3ViamVjdCwkVGVuYW50RG9tYWluKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoW3N0cmluZ106OklzTnVsbE9yRW1wdHkoJFZhcmlhYmxlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhyb3cgJ0ZhaWxlZCB0byBiYWNrdXAgdG8gQUFEIHVzaW5nIGFsdGVybmF0aXZlIG1ldGhvZCBpbnZvbHZpbmcgSW52b2tlLVdlYlJlcXVlc3QuJwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAjIExvZwogICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICRUZW5hbnREb21haW4KICAgICAgICAgICAgICAgICAgICAjIEdlbmVyYXRlIHRoZSBib2R5IHRvIHNlbmQgdG8gQUFEIGNvbnRhaW5pbmcgdGhlIHJlY292ZXJ5IGluZm9ybWF0aW9uCiAgICAgICAgICAgICAgICAgICAgIyBHZXQgdGhlIEJpdExvY2tlciBrZXkgaW5mb3JtYXRpb24gZnJvbSBXTUkKICAgICAgICAgICAgICAgICAgICBbYXJyYXldJChHZXQtQml0TG9ja2VyVm9sdW1lIC1Nb3VudFBvaW50ICRPU0RyaXZlTGV0dGVyIHwgU2VsZWN0LU9iamVjdCAtRXhwYW5kUHJvcGVydHkgJ0tleVByb3RlY3RvcicpLldoZXJleyRfLidLZXlQcm90ZWN0b3JUeXBlJyAtZXEgJ1JlY292ZXJ5UGFzc3dvcmQnfS5Gb3JFYWNoewogICAgICAgICAgICAgICAgICAgICAgICAkS2V5ID0gJF8KICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCJraWQgOiAkKCRLZXkuJ0tleVByb3RlY3RvcklkJykga2V5OiAkKCRLZXkuJ1JlY292ZXJ5UGFzc3dvcmQnKSIpCiAgICAgICAgICAgICAgICAgICAgICAgICRCb2R5ID0gW3N0cmluZ10kKCJ7IiJrZXkiIjoiIiQoJEtleS4nUmVjb3ZlcnlQYXNzd29yZCcpIiIsIiJraWQiIjoiIiQoJEtleS4nS2V5UHJvdGVjdG9ySWQnLlJlcGxhY2UoJ3snLCcnKS5SZXBsYWNlKCd9JywnJykpIiIsIiJ2b2wiIjoiIk9TViIifSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgQ3JlYXRlIHRoZSBVUkwgdG8gcG9zdCB0aGUgZGF0YSB0byBiYXNlZCBvbiB0aGUgdGVuYW50IGFuZCBkZXZpY2UgaW5mb3JtYXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgJFVyaSA9IFtzdHJpbmddJCgnaHR0cHM6Ly9lbnRlcnByaXNlcmVnaXN0cmF0aW9uLndpbmRvd3MubmV0L21hbmFnZS97MH0vZGV2aWNlL3sxfT9hcGktdmVyc2lvbj0xLjAnIC1mICgkVGVuYW50RG9tYWluLCRDZXJ0aWZpY2F0ZVN1YmplY3QpKQogICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAiQ3JlYXRpbmcgdXJsLi4uJFVyaSIKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBQb3N0IHRoZSBkYXRhIHRvIHRoZSBVUkwgYW5kIHNpZ24gaXQgd2l0aCB0aGUgQUFEIE1hY2hpbmUgQ2VydGlmaWNhdGUKICAgICAgICAgICAgICAgICAgICAgICAgJFJlcXVlc3QgPSBJbnZva2UtV2ViUmVxdWVzdCAtVXJpICRVcmkgLUJvZHkgJEJvZHkgLVVzZUJhc2ljUGFyc2luZyAtTWV0aG9kICdQb3N0JyAtVXNlRGVmYXVsdENyZWRlbnRpYWxzIC1DZXJ0aWZpY2F0ZSAkQ2VydGlmaWNhdGUKICAgICAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgJFJlcXVlc3QuJ1Jhd0NvbnRlbnQnCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkPykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJFNjcmlwdDpJc0JhY2t1cEFBRCA9ICR0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgIH0gICAgCiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnUG9zdCB0aGUgZGF0YSB0byB0aGUgVVJMIGFuZCBzaWduIGl0IHdpdGggdGhlIEFBRCBNYWNoaW5lIENlcnRpZmljYXRlLiBTdWNjZXNzPyB7MH0nIC1mICgkU2NyaXB0OklzQmFja3VwQUFEKSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICB9CiAgICAgICAgICAgIENhdGNoIHsKICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnRXJyb3Igd2hpbGUgYmFja3VwIHRvIEF6dXJlIEFELCBtYWtlIHN1cmUgdGhhdCB5b3UgYXJlIEFBRCBqb2luZWQgYW5kIGFyZSBydW5uaW5nIHRoZSBjbWRsZXQgYXMgYW4gYWRtaW4uJykKICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnRXJyb3IgbWVzc2FnZTonICsgImByYG4iICsgKCRfKSkKICAgICAgICAgICAgICAgICRJc0JhY2t1cEFBRCA9ICRmYWxzZQogICAgICAgICAgICB9CiAgICAgICAgICAgIEZpbmFsbHkgewogICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdEaWQgYmFja3VwIHRvIEF6dXJlIEFEIFN1Y2NlZWQ/IHswfScgLWYgKCRTY3JpcHQ6SXNCYWNrdXBBQUQpKQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgICNlbmRyZWdpb24gQmFja3VwIEF6dXJlIEFBRAogICAgICAgIAogICAgICAgIAogICAgICAgICMgSWYgbm8gYmFja3VwIGFuZCBubyBSZWNvdmVyeSBQYXNzd29yZHMgcHJlc2VudAogICAgICAgIAogICAgfQogICAgZWxzZSB7CiAgICAgICAgTG9nV3JpdGUgJ09TIERyaXZlIGlzIG5vdCBlbmNyeXB0ZWQsIHRoZXJlIGFyZSBubyBSZWNvdmVyeSBQYXNzd29yZHMsIGFuZCB0aGVyZSBhcmUgbm8gYmFja3Vwcy4nCiAgICB9Cn0KI2VuZHJlZ2lvbiBCYWNrdXAKI2VuZHJlZ2lvbiBNYWluCgoKCiMjIyMjIyMjIyMjIyMjIyMjIyMjCiMjIyMjIyAgRyBVIEkgIyMjIyMjCiMjIyMjIyMjIyMjIyMjIyMjIyMjCiNyZWdpb24gR1VJCmlmICgkU2NyaXB0OklzRW5jcnlwdGVkIC1hbmQgJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdyAtYW5kICRTY3JpcHQ6Qm9vbFNob3dHVUkpIHsKICAgICMgU2hvdyByZWJvb3QgcHJvbXB0IHRvIHVzZXIKICAgIExvZ1dyaXRlICJQcm9tcHRpbmcgdXNlciB0byBSZWJvb3QgY29tcHV0ZXIuIgogICAgICAgICAgIAoKICAgIFt2b2lkXVtTeXN0ZW0uUmVmbGVjdGlvbi5Bc3NlbWJseV06OkxvYWRXaXRoUGFydGlhbE5hbWUoIOKAnFN5c3RlbS5XaW5kb3dzLkZvcm1z4oCdKQogICAgW3ZvaWRdW1N5c3RlbS5SZWZsZWN0aW9uLkFzc2VtYmx5XTo6TG9hZFdpdGhQYXJ0aWFsTmFtZSgg4oCcTWljcm9zb2Z0LlZpc3VhbEJhc2lj4oCdKQoKICAgICRmb3JtID0gW1N5c3RlbS5XaW5kb3dzLkZvcm1zLkZvcm1dOjpuZXcoKQogICAgJGZvcm0uJ1dpZHRoJyA9IDUwMAogICAgJGZvcm0uJ0hlaWdodCcgPSAxNTAKICAgICRmb3JtLidUZXh0JyA9ICdCaXRMb2NrZXIgcmVxdWlyZXMgYSByZWJvb3QhJwogICAgJGZvcm0uJ1N0YXJ0UG9zaXRpb24nID0gW1N5c3RlbS5XaW5kb3dzLkZvcm1zLkZvcm1TdGFydFBvc2l0aW9uXTo6Q2VudGVyU2NyZWVuCgogICAgJERyb3BEb3duQXJyYXkgPSBAKCI0OkhvdXJzIiwgIjg6SG91cnMiLCAiMTI6SG91cnMiLCAiMjQ6SG91cnMiKQogICAgJERETCA9IFtTeXN0ZW0uV2luZG93cy5Gb3Jtcy5Db21ib0JveF06Om5ldygpCiAgICAkRERMLidMb2NhdGlvbicgPSBbU3lzdGVtLkRyYXdpbmcuU2l6ZV06Om5ldygxNDAsIDEwKQogICAgJERETC4nU2l6ZScgPSBbU3lzdGVtLkRyYXdpbmcuU2l6ZV06Om5ldygxMzAsIDMwKQogICAgZm9yZWFjaCAoJEl0ZW0gaW4gJERyb3BEb3duQXJyYXkpIHsKICAgICAgICAkRERMLidJdGVtcycuQWRkKCRJdGVtKSB8IE91dC1OdWxsCiAgICB9CiAgICAkRERMLidTZWxlY3RlZEluZGV4JyA9IDAKCiAgICAkYnV0dG9uMSA9IFtTeXN0ZW0uV2luZG93cy5Gb3Jtcy5idXR0b25dOjpuZXcoKQogICAgJGJ1dHRvbjEuJ0xlZnQnID0gNDAKICAgICRidXR0b24xLidUb3AnID0gODUKICAgICRidXR0b24xLidXaWR0aCcgPSAxMDAKICAgICRidXR0b24xLidUZXh0JyA9ICdSZWJvb3QgTm93JwogICAgJGJ1dHRvbjEuJ0FkZF9DbGljaycoeyRnbG9iYWw6eGlucHV0ID0gJ1JlYm9vdCc7ICRGb3JtLkNsb3NlKCl9KQoKICAgICRidXR0b24yID0gW1N5c3RlbS5XaW5kb3dzLkZvcm1zLmJ1dHRvbl06Om5ldygpCiAgICAkYnV0dG9uMi4nTGVmdCcgPSAxNzAKICAgICRidXR0b24yLidUb3AnID0gODUKICAgICRidXR0b24yLidXaWR0aCcgPSAxMDAKICAgICRidXR0b24yLidUZXh0JyA9ICdQb3N0cG9uZScKICAgICRidXR0b24yLidBZGRfQ2xpY2snKHskZ2xvYmFsOnhpbnB1dCA9ICdQb3N0cG9uZTonICsgJERETC5UZXh0OyAkRm9ybS5DbG9zZSgpfSkKCiAgICAkYnV0dG9uMyA9IFtTeXN0ZW0uV2luZG93cy5Gb3Jtcy5idXR0b25dOjpuZXcoKQogICAgJGJ1dHRvbjMuJ0xlZnQnID0gMjkwOwogICAgJGJ1dHRvbjMuJ1RvcCcgPSA4NTsKICAgICRidXR0b24zLidXaWR0aCcgPSAxMDA7CiAgICAkYnV0dG9uMy4nVGV4dCcgPSAnQ2FuY2VsJzsKICAgICRidXR0b24zLidBZGRfQ2xpY2snKHskZ2xvYmFsOnhpbnB1dCA9ICJQb3N0cG9uZTI0IjsgJEZvcm0uQ2xvc2UoKX0pCgoKICAgICRmb3JtLidLZXlQcmV2aWV3JyA9ICRUcnVlCiAgICAkZm9ybS4nQWRkX0tleURvd24nKCB7aWYgKCRfLidLZXlDb2RlJyAtZXEgJ0VudGVyJykgCiAgICAgICAgeyR4ID0gJHRleHRCb3gxLidUZXh0JzsgJGZvcm0uQ2xvc2UoKX19KQogICAgJGZvcm0uJ0FkZF9LZXlEb3duJygge2lmICgkXy4nS2V5Q29kZScgLWVxICdFc2NhcGUnKSAKICAgICAgICB7JGZvcm0uQ2xvc2UoKX19KQoKICAgICRldmVudEhhbmRsZXIgPSBbU3lzdGVtLkV2ZW50SGFuZGxlcl0geyAKICAgICAgICAkYnV0dG9uMS4nQ2xpY2snOwogICAgICAgICREcm9wRG93bkFycmF5LidUZXh0JzsKICAgICAgICAkZm9ybS5DbG9zZSgpOyB9OwoKICAgICMkYnV0dG9uLkFkZF9DbGljaygkZXZlbnRIYW5kbGVyKSA7CiAgICAkZm9ybS4nQ29udHJvbHMnLkFkZCgkYnV0dG9uMSk7CiAgICAkZm9ybS4nQ29udHJvbHMnLkFkZCgkYnV0dG9uMik7CiAgICAkZm9ybS4nQ29udHJvbHMnLkFkZCgkYnV0dG9uMyk7CiAgICAkZm9ybS4nQ29udHJvbHMnLkFkZCgkRERMKTsKICAgICRmb3JtLidDb250cm9scycuQWRkKCR0ZXh0TGFiZWwxKQogICAgJHJldCA9ICRmb3JtLlNob3dEaWFsb2coKTsKCiAgICBpZiAoJGdsb2JhbDp4aW5wdXQgLWVxICdSZWJvb3QnKSB7c2h1dGRvd24gLXIgLWYgL3QgNjAwfQogICAgaWYgKCRnbG9iYWw6eGlucHV0IC1saWtlICdQb3N0cG9uZToqOkhvdXJzJykgewogICAgICAgICRodmFsID0gKChbaW50XSRnbG9iYWw6eGlucHV0LnNwbGl0KCI6IilbMV0pICogNjAgKiA2MCkKICAgICAgICBzaHV0ZG93biAtciAtZiAvdCAkaHZhbAogICAgfQogICAgaWYgKCRnbG9iYWw6eGlucHV0IC1lcSAnUG9zdHBvbmUyNCcpIHtzaHV0ZG93biAtciAtZiAvdCA4NjQwMH0KfQojZW5kcmVnaW9uIEdVSQoKCgojIyMjIyMjIyMjIyMjIyMjIyMjIwojIyMjIEVORCBSRVNVTFRTICMjIwojIyMjIyMjIyMjIyMjIyMjIyMjIwojcmVnaW9uIEVuZCBSZXN1bHRzIApMb2dXcml0ZSAoJyMjIyBFbmQgcmVzdWx0cycpCiMgQ2xlYW5pbmcgdXAgaWYgc3VjY2VzcwppZiAoJFNjcmlwdDpJc0ZpbmlzaGVkMXN0VGltZSkgewogICAgTG9nV3JpdGUgJ0ZpbmlzaGVkIGZpcnN0IHRpbWUgPSBUcnVlIHwgSnVzdCBjaGVja2VkIHdlYXRoZXIgQml0TG9ja2VyIFJlY292ZXJ5IFBhc3N3b3JkIGhhZCBjaGFuZ2VkLicKfQoKZWxzZSB7CiAgICBpZiAoJFNjcmlwdDpJc0VuY3J5cHRlZCAtYW5kICRTY3JpcHQ6SXNQcm90ZWN0aW9uUGFzc3cgLWFuZCAkU2NyaXB0OklzQmFja3VwQUFEIC1hbmQKICAgICAgICAoW2Jvb2xdJCgkU2NyaXB0OkJvb2xCYWNrdXBUb09uZURyaXZlRm9yQnVzaW5lc3MgLWFuZCAkU2NyaXB0OklzQmFja3VwT0QpIC1vciBbYm9vbF0kKC1ub3QoJFNjcmlwdDpCb29sQmFja3VwVG9PbmVEcml2ZUZvckJ1c2luZXNzKSkpCiAgICApIHsKICAgICAgICAkQkxWID0gR2V0LUJpdExvY2tlclZvbHVtZSAtTW91bnRQb2ludCAkZW52OlN5c3RlbURyaXZlCiAgICAgICAgaWYgKCgkQkxWLidWb2x1bWVTdGF0dXMnIC1lcSAkU2NyaXB0OkJpdExvY2tlclZvbHVtZUVuY3J5cHRpb25TdGF0dXNlc1syXSkgLWFuZCAoQCgkQkxWLidLZXlQcm90ZWN0b3InIHwgV2hlcmUtT2JqZWN0IC1Qcm9wZXJ0eSAnS2V5UHJvdGVjdG9yVHlwZScgLWVxICdSZWNvdmVyeVBhc3N3b3JkJykuJ0NvdW50JyAtZXEgMSkpIHsKICAgICAgICAKICAgICAgICAgICAgIyBGaXJzdCBzdWNjZXNzZnVsbCBydW4KICAgICAgICAgICAgJFNjcmlwdDpJc0ZpbmlzaGVkMXN0VGltZSA9ICR0cnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFNjaGVkdWxlZFRhc2sKICAgICAgICAgICAgRWRpdC1TY2hlZHVsZWRUYXNrIC1UYXNrTmFtZSAkU2NyaXB0OlNjaGVkdWxlZFRhc2tOYW1lCgogICAgICAgICAgICAjIEZpbGVzCiAgICAgICAgICAgICNyZWdpb24gUmVtb3ZlIGZpbGVzCiAgICAgICAgICAgIGlmICgkU2NyaXB0OkJvb2xSZW1vdmVGaWxlc0FmdGVyU3VjY2VzcyAtYW5kICRTY3JpcHQ6SXNGaW5pc2hlZDFzdFRpbWUpIHsgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICRudWxsID0gU3RhcnQtSm9iIC1Bcmd1bWVudExpc3QgJFNjcmlwdDpGaWxlTG9nIC1TY3JpcHRCbG9jayB7CiAgICAgICAgICAgICAgICAgICAgUGFyYW0oW3N0cmluZ10gJEZpbGVMb2cpCiAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgRnVuY3Rpb24gTG9nV3JpdGUgewogICAgICAgICAgICAgICAgICAgICAgICBQYXJhbSAoW3N0cmluZ10kTG9nU3RyaW5nKQogICAgICAgICAgICAgICAgICAgICAgICAkYSA9IFtzdHJpbmddJChHZXQtRGF0ZSkKICAgICAgICAgICAgICAgICAgICAgICAgJExvZ1N0cmluZyA9IFtzdHJpbmddJCgkYSwgJExvZ1N0cmluZykKICAgICAgICAgICAgICAgICAgICAgICAgQWRkLWNvbnRlbnQgLVBhdGggJEZpbGVMb2cgLVZhbHVlICRMb2dTdHJpbmcKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgJExvY2FsOlJlbURpclBhdGggPSBbc3RyaW5nXSQoJHtlbnY6UHJvZ3JhbUZpbGVzKHg4Nil9ICsgJ1xCaXRMb2NrZXJUcmlnZ2VyXCcpCiAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBTdGFydC1TbGVlcCAtU2Vjb25kcyA1CiAgICAgICAgICAgICAgICAgICAgTG9nV3JpdGUgKCdTdGFydGVkIHRoZSBqb2IgdG8gcmVtb3ZlICJ7MH0iJyAtZiAoJExvY2FsOlJlbURpclBhdGgpKQogICAgICAgICAgICAgICAgICAgIGlmIChUZXN0LVBhdGggJExvY2FsOlJlbURpclBhdGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgUmVtb3ZlLUl0ZW0gLVBhdGggJExvY2FsOlJlbURpclBhdGggLVJlY3Vyc2UgLUZvcmNlCiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1dyaXRlICgnUmVtb3ZpbmcgdGhlIGZvbGRlciAocmVjdXJzZSwgZm9yY2UpLiBTdWNjZXNzPyB7MH0nIC1mICgkPykpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBMb2dXcml0ZSAoJ0ZvbGRlciBkb2VzIG5vdCBleGlzdCcpCiAgICAgICAgICAgICAgICAgICAgfSAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfQogICAgICAgICAgICAjZW5kcmVnaW9uIFJlbW92ZSBGaWxlcwogICAgICAgIH0gICAgCiAgICB9CiAgICBlbHNlIHsKICAgICAgICBMb2dXcml0ZSAnVGhlcmUgYXJlIHN0aWxsIHRoaW5ncyB0byBkby4gVHJ5aW5nIGFnYWluIGxhdGVyLicKICAgIH0KfQojZW5kcmVnaW9uIEVuZCBSZXN1bHRzCgoKCiMjIyMjIyMjIyMjIyMjIyMjIyMjCiMjIyMgUyBUIEEgVCBTICMjIyMjCiMjIyMjIyMjIyMjIyMjIyMjIyMjCkxvZ1dyaXRlICgnIyMjIFNUQVRTJykKJFNjcmlwdDpDb3VudFJ1bnMgKz0gMQoKaWYgKC1ub3QoJFNjcmlwdDpCb29sUmVtb3ZlRmlsZXNBZnRlclN1Y2Nlc3MpKSB7CiAgICBpZiAoLW5vdChUZXN0LVBhdGggJFNjcmlwdDpEaXJJbnN0YWxsKSkgewogICAgICAgICRudWxsID0gTmV3LUl0ZW0gLVBhdGggJFNjcmlwdDpEaXJJbnN0YWxsIC1JdGVtVHlwZSAnRGlyZWN0b3J5JyAtRm9yY2UKICAgIH0KICAgIAogICAgIyBGZXRjaCBPUyBkcml2ZSBlbmNyeXB0aW9uIGtleSBhbmQgcGFzc3dvcmQKICAgICRTY3JpcHQ6T1NEcml2ZUtleUlEID0gW3N0cmluZ10kKCRTY3JpcHQ6Q0FycmF5UmVjb3ZlcnlQYXNzd29yZHMgfCBTZWxlY3QtT2JqZWN0IC1GaXJzdCAxIC1FeHBhbmRQcm9wZXJ0eSAnS2V5UHJvdGVjdG9ySWQnKQogICAgJFNjcmlwdDpPU0RyaXZlUHJvdGVjdGlvblBhc3N3b3JkID0gW3N0cmluZ10kKCRTY3JpcHQ6Q0FycmF5UmVjb3ZlcnlQYXNzd29yZHMgfCBTZWxlY3QtT2JqZWN0IC1GaXJzdCAxIC1FeHBhbmRQcm9wZXJ0eSAnUmVjb3ZlcnlQYXNzd29yZCcpCgogICAgIyBDcmVhdGUgb3V0cHV0IHN0cmluZwogICAgJE91dFN0cmluZyA9IFtzdHJpbmddJCgoJFNjcmlwdDpDb3VudFJ1bnMpLlRvU3RyaW5nKCkgKyAiYHJgbiIpICAgICAgICAgICAgIyAwICAgTGluZSAxCiAgICAkT3V0U3RyaW5nICs9ICgoW2J5dGVdICRTY3JpcHQ6SXNGaW5pc2hlZDFzdFRpbWUpLlRvU3RyaW5nKCkgKyAiYHJgbiIpICAgICAjIDEgICBMaW5lIDIKICAgICRPdXRTdHJpbmcgKz0gKChbYnl0ZV0gJFNjcmlwdDpJc0VuY3J5cHRlZCkuVG9TdHJpbmcoKSArICJgcmBuIikgICAgICAgICAgICMgMiAgIExpbmUgMwogICAgJE91dFN0cmluZyArPSAoKFtieXRlXSAkU2NyaXB0OklzUHJvdGVjdGlvblBhc3N3KS5Ub1N0cmluZygpICsgImByYG4iKSAgICAgIyAzICAgTGluZSA0CiAgICAkT3V0U3RyaW5nICs9ICgoW2J5dGVdICRTY3JpcHQ6SXNCYWNrdXBPRCkuVG9TdHJpbmcoKSArICJgcmBuIikgICAgICAgICAgICAjIDQgICBMaW5lIDUKICAgICRPdXRTdHJpbmcgKz0gKChbYnl0ZV0gJFNjcmlwdDpJc0JhY2t1cEFBRCkuVG9TdHJpbmcoKSArICJgcmBuIikgICAgICAgICAgICMgNSAgIExpbmUgNgogICAgJE91dFN0cmluZyArPSAoKFtzdHJpbmddICRTY3JpcHQ6T1NEcml2ZUtleUlEKSArICJgcmBuIikgICAgICAgICAgICAgICAgICAgIyA2ICAgTGluZSA3CiAgICAkT3V0U3RyaW5nICs9ICgoW3N0cmluZ10gJFNjcmlwdDpPU0RyaXZlUHJvdGVjdGlvblBhc3N3b3JkKSkgICAgICAgICAgICAgICAjIDcgICBMaW5lIDgKICAgCiAgICAjIE91dHB1dCB0aGUgc3RhdHMgZmlsZQogICAgJG51bGwgPSBPdXQtRmlsZSAtRmlsZVBhdGggJFNjcmlwdDpGaWxlU3RhdHMgLUVuY29kaW5nICd1dGY4JyAtRm9yY2UgLUlucHV0T2JqZWN0ICgkT3V0U3RyaW5nKQp9CkxvZ1dyaXRlICgnUnVucyBzbyBmYXI6IHswfScgLWYgKCRTY3JpcHQ6Q291bnRSdW5zKSkKCmlmICgkU2NyaXB0OkJvb2xEaWRBbnl0aGluZ0NoYW5nZVRoaXNSdW50aW1lKSB7CiAgICBXcml0ZS1TdGF0cyAKfQoKCgojIyMgR2l2ZSB1cCBhZnRlciBYIHJ1bnMgYW5kIElzRmluaXNoZWQxc3RUaW1lIC1lcSAkZmFsc2UKaWYgKCRTY3JpcHQ6Q291bnRSdW5zIC1lcSAzMCAtYW5kICgtbm90KCRTY3JpcHQ6SXNGaW5pc2hlZDFzdFRpbWUpKSkgewogICAgTG9nV3JpdGUgKCdTaG91bGQgaGF2ZSBiZWVuIGRvbmUgYnkgbm93LicpCiAgICBFZGl0LVNjaGVkdWxlZFRhc2sgLVRhc2tOYW1lICRTY3JpcHQ6U2NoZWR1bGVkVGFza05hbWUKCiAgICBpZiAoJGZhbHNlKSB7CiAgICAgICAgIyMjIEdhdGhlcmluZyBpbmZvIGZvciB0aGUgZW1haWwKICAgICAgICBpZiAoLW5vdCgkU2NyaXB0OldpbmRvd3NWZXJzaW9uKSkgewogICAgICAgICAgICBDcmVhdGUtRW52VmFyaWFibGVzCiAgICAgICAgfQogICAgICAgICMjIyBCdWlsZGluZyBlbWFpbCBzdHJpbmcKICAgICAgICAkTG9jYWw6U3RyU3ViamVjdCA9IFtzdHJpbmddJCgnQml0TG9ja2VyVHJpZ2dlciBmYWlsZWQgezB9IHRpbWVzIGZvciB0ZW5hbnQgInsxfSIsIGRldmljZTogInsyfSInIC1mICgkQ291bnRSdW5zLlRvU3RyaW5nKCksJExvY2FsOk5hbWVUZW5hbnQsJExvY2FsOk5hbWVDb21wdXRlcikpCiAgICAgICAgJExvY2FsOlN0ckVtYWlsID0gW3N0cmluZ106OkVtcHR5CiAgICAgICAgJExvY2FsOlN0ckVtYWlsICs9ICgkTG9jYWw6U3RyU3ViamVjdCkKICAgICAgICAkTG9jYWw6U3RyRW1haWwgKz0gKCJgcmBuIikKICAgICAgICAkTG9jYWw6U3RyRW1haWwgKz0gKCJgcmBuIiArICcjIyBFbnZpcm9ubWVudCBpbmZvJykKICAgICAgICAkTG9jYWw6U3RyRW1haWwgKz0gKCJgcmBuIiArICdEZXZpY2UgbmFtZTogJyArICRTY3JpcHQ6Q29tcHV0ZXJOYW1lICsgJyB8IE1hbnVmYWN0dXJlcjogJyArICRTY3JpcHQ6Q29tcHV0ZXJNYW51ZmFjdHVyZXIgKyAnIHwgTW9kZWw6ICcgKyAkU2NyaXB0OkNvbXB1dGVyUHJvZHVjdE5hbWUpIAogICAgICAgICRMb2NhbDpTdHJFbWFpbCArPSAoImByYG4iICsgJ1dpbmRvd3MgRWRpdGlvbjogJyArICRTY3JpcHQ6V2luZG93c0VkaXRpb24gKyAnIHwgV2luZG93cyBWZXJzaW9uJyArICRTY3JpcHQ6V2luZG93c1ZlcnNpb24pCiAgICAgICAgJExvY2FsOlN0ckVtYWlsICs9ICgiYHJgbmByYG4iICsgJ1RoZXJlIGhhdmUgbm93IGJlZW4gezB9IHJ1bnMsIGJ1dCBCaXRMb2NrZXJUcmlnZ2VyIFNUSUxMIGZhaWxzLicgLWYgKCRTY3JpcHQ6Q291bnRSdW5zKSkKICAgICAgICAkTG9jYWw6U3RyRW1haWwgKz0gKCJgcmBuIiArICdTdWNjZXNzIHN0YXR1cyB8IEVuY3J5cHRlZCA6IHswfSB8IFByb3RlY3Rpb24gUGFzc3dvcmRzIHByZXNlbnQgOiB7MX0gfCBCYWNrdXAgdG8gQXp1cmVBRCA6IHsyfSB8IEJhY2t1cCB0byBPbmVEcml2ZSA6IHszfScgLWYgKCRTY3JpcHQ6SXNFbmNyeXB0ZWQsJFNjcmlwdDpJc1Byb3RlY3Rpb25QYXNzdywkU2NyaXB0OklzQmFja3VwQUFELCRTY3JpcHQ6SXNCYWNrdXBPRCkpCiAgICAgICAgTG9nV3JpdGUgKCRMb2NhbDpTdHJFbWFpbCkKICAgICAgICA8IyMjIFNlbmQgZW1haWwKICAgICAgICAjIyBNYWlsIGFkZHJlc3MoZXMpCiAgICAgICAgW3N0cmluZ10gJExvY2FsOlN0clRvRW1haWxBZGRyZXNzID0gJ09sYXYgUi4gQmlya2VsYW5kIDxvbGF2YkBpcm9uc3RvZWl0LmNvbT47JwogICAgICAgICMkU3RyRW1haWxBZGRyZXNzICs9ICdJcm9uc3RvbmUgU2VydmljZWRlc2sgPHNlcnZpY2VkZWtzQGlyb25zdG9uZWl0LmNvbT4nCiAgICAgICAgW3N0cmluZ10gJExvY2FsOlN0ckZyb21FbWFpbEFkZHJlc3MgPSAoJ0JpdExvY2tlclRyaWdnZXJGYWlsQHswfScgLWYgKCRTY3JpcHQ6TmFtZVRlbmFudCkpCiAgICAgICAgI1NlbmQtTWFpbE1lc3NhZ2UgLVRvICRMb2NhbDpTdHJUb0VtYWlsQWRkcmVzcyAtU210cFNlcnZlciAgLUZyb20gJExvY2FsOlN0ckZyb21FbWFpbEFkZHJlc3MgLVN1YmplY3QgJExvY2FsOlN0clN1YmplY3QgLUJvZHkgJExvY2FsOlN0ckVtYWlsCiAgICAgICAgIz4KICAgIH0KfQoKCgoKCiMjIyMjIyMjIyMjIyMjIyMjIyMjCiMjIyMgIEQgTyBOIEUgICMjIyMjCiMjIyMjIyMjIyMjIyMjIyMjIyMjCkxvZ1dyaXRlICgnQWxsIGRvbmUsIGV4aXRpbmcgc2NyaXB0Li4uJykKI2VuZHJlZ2lvbiBNYWlu')
        #endregion FilePS1
    #endregion Files

    # Script specific variables
    $Script:NameApp            = [string]$($NameScriptNoun)
    $Script:NameScheduledTask  = [string]$($NameScriptNoun)
    $Script:PathDirInstall     = [string]$('{0}\IronstoneIT\{1}' -f ($env:ProgramW6432,$Script:NameApp))
    $Script:PathFileInstall    = [string]$('{0}\{1}' -f ($Script:PathDirInstall,$Script:NameFilePS1))
#endregion Variables




#region Main
    Write-Output -InputObject ('### {0}' -f ($NameScript))



    ###########################################################
    ### 1. Clean up BitLockerTrigger and IronTrigger
    Write-Output -InputObject ('{0}# 1. Clean up previous install paths.' -f ("`r`n`r`n"))
    
    # Paths
    Write-Verbose -Message ('Remove previous install path(s) if present')
    # Get Directory Paths
    $Local:RemPaths = [string[]]@(
        # Install Directory used in this script
        ($Script:PathDirInstall),
        # Install Dirs matching "*Trigger*" or "*BitLocker*" is ProgramFiles x64
        @(Get-ChildItem -Path ('{0}\IronstoneIT\' -f ($env:ProgramW6432)) -Directory -ErrorAction 'SilentlyContinue' | Where-Object {$_.Name -like '*trigger*' -or $_.Name -like '*BitLocker*'} | Select-Object -ExpandProperty 'FullName'),
        # Install Dirs matching "*Trigger*" or "*BitLocker*" is ProgramFiles x86
        @(Get-ChildItem -Path ('{0}\IronstoneIT\' -f (${env:ProgramFiles(x86)})) -Directory -ErrorAction 'SilentlyContinue' | Where-Object {$_.Name -like '*trigger*' -or $_.Name -like '*BitLocker*'} | Select-Object -ExpandProperty 'FullName')
    )
    # Remove Directory Paths
    foreach ($Path in $Local:RemPaths) {
        if (-not([string]::IsNullOrEmpty($Path.Trim()))) {
            Write-Verbose -Message ('   Removing "{0}" if it exists.' -f ($Path))
            if (Test-Path -Path $Path) {
                $null = Remove-Item -Path $Path -Force -Recurse
                Write-Verbose -Message ('      Directory does exist. Removing. Success? {0}' -f ($?))
            }
            else {
                Write-Verbose -Message ('      Directory does not exist')
            }
        }
    }
    
    # Stats and Logs
    Write-Verbose -Message ('Remove previous files: Stats and Logs')
    @(Get-ChildItem -Path ('{0}\Temp' -f ($env:windir)) -File -ErrorAction 'SilentlyContinue' | Where-Object -FilterScript {$_.'Name' -like '*trigger*'} | Select-Object -ExpandProperty 'FullName') | ForEach-Object {
        Remove-Item -Path $_ -Force
        Write-Verbose -Message ('Removing "{0}". Success? {1}.' -f ($_,$?.ToString()))
    }
    Get-ChildItem -Path $PathDirLog -Name '*EnableBitLocker.log' -File -Force -ErrorAction 'SilentlyContinue' | Select-Object -ExpandProperty 'PSChildName' | ForEach-Object {Remove-Item -Path ('{0}{1}' -f ($PathDirLog,$_)) -Force}

    # Scheduled tasks
    Write-Verbose -Message ('Remove previous ScheduledTask(s)')
    $Local:ScheduledTasks = Get-ScheduledTask | Where-Object {
        # Exact Name
        @($Script:NameScheduledTask,'IronTrigger','Enable_BitLocker').Contains($_.'TaskName') -or `
        # Regex
        $_.'TaskName' -like '*BitLocker' -or $_.'TaskName' -like '*IronTrigger*'
    }
    
    if ($Local:ScheduledTasks.'Length' -gt 0) {
        $Local:ScheduledTasks | ForEach-Object {             
            $null = Unregister-ScheduledTask -TaskName $_.'TaskName' -Confirm:$false -ErrorAction 'SilentlyContinue'
            Write-Verbose -Message ('  Removing the Scheduled task "{0}". Success? {1}' -f ($_.'TaskName',$?))
        }
    }
    else {
        if (Get-ScheduledTask -TaskName $Script:NameScheduledTask -ErrorAction 'SilentlyContinue') {            
            $null = Unregister-ScheduledTask -TaskName $Script:NameScheduledTask -Confirm:$false -ErrorAction 'SilentlyContinue'
            Write-Verbose -Message ('  Removing the Scheduled task "{0}". Success? {1}' -f ($Script:NameScheduledTask,$?))
        }
        else {
            Write-Verbose -Message ('  Scheduled task "{0}" does not exist.' -f ($Script:ScheduledTaskName))
        }
    }




    ###########################################################
    ### 2. Install Files
    Write-Output -InputObject ('{0}# 2. Install files.' -f ("`r`n`r`n"))
    # Create path if not exist
    if (-not([System.IO.Directory]::Exists($Script:PathDirInstall))){$null=[System.IO.Directory]::CreateDirectory($Script:PathDirInstall)}
    # Output file
    $null = Out-File -FilePath $Script:PathFileInstall -Encoding 'Utf8' -InputObject ([System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($Script:ContentFilePS1))) -Force:$true -ErrorAction 'Stop'
    # Verbose
    Write-Verbose -Message ('   Success? {0}' -f ($?))



    
    ###########################################################
    ### 3. Surpress BitLocker Toast Notifications
    Write-Output -InputObject ('{0}# 3. Surpress BitLocker Toast Notifications.' -f ("`r`n`r`n"))

    # Create registry base path to HKCU:\ from System context
    $RegDirBase = [string]$('Registry::HKEY_USERS\{0}\Software\Microsoft\Windows\CurrentVersion\Notifications\Settings' -f ($Script:StrIntuneUserSID))
    
    # Registry paths to disable BitLocker Toast Notifications
    $RegDirs    = [string[]]@(
        [string]('{0}\Windows.SystemToast.BitLockerPolicyRefresh' -f ($RegDirBase)),
        [string]('{0}\Windows.SystemToast.BdeUnlock' -f ($RegDirBase))
    )

    # Set registry values
    foreach ($RegDir in $RegDirs) {
        if (-not(Test-Path -Path $RegDir)) {$null = New-Item -Path $RegDir -ItemType 'Directory' -Force}
        $null = Set-ItemProperty -Path $RegDir -Name 'Enabled' -Value 0 -Type 'DWord' -Force
        if (-not($?)) {
            Throw 'ERROR: Failed to set registry values to surpress BotLocker Toast Notifications.'
        }
        else {
            Write-Verbose -Message ('   Success.')
        }
    }




    ###########################################################
    ### 4. Create ScheduledTask and run it if success
    Write-Output -InputObject ('{0}# 4. Create Scheduled Task "{1}", run it if success.' -f ("`r`n`r`n",$Script:NameScheduledTask))
    # Get path of PowerShell.exe and the .PS1 file
    $PathFilePowerShell = [string] '%SystemRoot%\system32\WindowsPowerShell\v1.0\powershell.exe' # Works regardless of 64bit vs 32bit
    $PathFilePS1        = [string] ('{0}\{1}' -f ($Script:PathDirInstall,$Script:NameFilePS1))
    # Create Scheduled Task
    #region    Create Scheduled Task running PS1 using PowerShell.exe - Every 15 Minutes
        # Construct Scheduled Task
        $ScheduledTask = New-ScheduledTask                                                    `
            -Action    (New-ScheduledTaskAction -Execute ('"{0}"' -f ($PathFilePowerShell)) -Argument ('-ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -WindowStyle Hidden -File "{0}"' -f ($PathFilePS1))) `
            -Principal (New-ScheduledTaskPrincipal -UserId 'NT AUTHORITY\SYSTEM' -RunLevel 'Highest')                                                                                                                   `
            -Trigger   (New-ScheduledTaskTrigger -Once -At ([datetime]::Today) -RepetitionInterval ([timespan]::FromMinutes(15)))                                                                                       `
            -Settings  (New-ScheduledTaskSettingsSet -Hidden -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -ExecutionTimeLimit ([timespan]::FromMinutes(10)) -Compatibility 4 -StartWhenAvailable)
        $ScheduledTask.'Author'      = 'Ironstone'
        $ScheduledTask.'Description' = ('{0}Runs a PowerShell script. {1}Execute: "{2}". {1}Arguments: "{3}".' -f (
            $(if([string]::IsNullOrEmpty($DescriptionScheduledTask)){''}else{('{0} {1}' -f ($DescriptionScheduledTask,"`r`n"))}),"`r`n",
            [string]($ScheduledTask | Select-Object -ExpandProperty 'Actions' | Select-Object -ExpandProperty 'Execute'),
            [string]($ScheduledTask | Select-Object -ExpandProperty 'Actions' | Select-Object -ExpandProperty 'Arguments')
        ))

        # Register Scheduled Task
        $null = Register-ScheduledTask -TaskName $NameScheduledTask -InputObject $ScheduledTask -Force -Verbose:$false -Debug:$false
                
        # Check if success registering Scheduled Task
        $SuccessCreatingScheduledTask = [bool]$($? -and [bool]$([byte](@(Get-ScheduledTask -TaskName $NameScheduledTask).'Count') -eq 1))
        Write-Verbose -Message ('Success creating scheduled task "{0}"? "{1}".' -f ($NameScheduledTask,$SuccessCreatingScheduledTask.ToString()))
                
        # Run Scheduled Task if Success Creating It
        if ($SuccessCreatingScheduledTask) {$null = Start-ScheduledTask -TaskName $NameScheduledTask}
        else {Throw 'ERROR: Failed to create scheduled task.'}
    #endregion Create Scheduled Task running PS1 using PowerShell.exe - Every 15 Minutes




    ###########################################################
    ### Done
    Write-Output -InputObject ('{0}Done.' -f ("`r`n`r`n"))    
#endregion Main



################################################
#endregion Your Code Here
################################################   
#region    Don't touch this
}
Catch {
    # Construct Message
    ## Generic 
    $ErrorMessage = [string]$('{0}Finished with errors:' -f ("`r`n"))
    $ErrorMessage += [string]$('{0}# Exception:{0}{1}' -f ("`r`n",$_.'Exception'))
    ## Dynamically add info to the error message
    foreach ($ParentProperty in [string[]]$($_ | Get-Member -MemberType 'Property' | Select-Object -ExpandProperty 'Name')) {
        if ($_.$ParentProperty) {
            $ErrorMessage += ('{0}# {1}:' -f ("`r`n",$ParentProperty))
            foreach ($ChildProperty in [string[]]$($_.$ParentProperty | Get-Member -MemberType 'Property' | Select-Object -ExpandProperty 'Name')) {
                ### Build ErrorValue
                $ErrorValue = [string]::Empty
                if ($_.$ParentProperty.$ChildProperty -is [System.Collections.IDictionary]) {
                    foreach ($Name in [string[]]$($_.$ParentProperty.$ChildProperty.GetEnumerator().'Name')) {
                        $ErrorValue += ('{0} = {1}{2}' -f ($Name,[string]$($_.$ParentProperty.$ChildProperty.$Name),"`r`n"))
                    }
                }
                else {
                    $ErrorValue = [string]$($_.$ParentProperty.$ChildProperty)
                }
                if (-not[string]::IsNullOrEmpty($ErrorValue)) {
                    $ErrorMessage += ('{0}## {1}\{2}:{0}{3}' -f ("`r`n",$ParentProperty,$ChildProperty,$ErrorValue.Trim()))
                }
            }
        }
    }
    ## Last exit code
    if (-not[string]::IsNullOrEmpty($LASTEXITCODE)) {
        $ErrorMessage += ('{0}# Last exit code:{0}{1}' -f ("`r`n",$LASTEXITCODE))
    }
    # Write Error Message
    Write-Error -Message $ErrorMessage -ErrorAction 'Continue'
}
Finally {
    # Unload Users' Registry Profiles (NTUSER.DAT) if any were loaded
    if ($Script:BoolIsSystem -and $BoolWriteToHKCUFromSystem -and ([string[]]@($RegistryLoadedProfiles | Where-Object -FilterScript {-not([string]::IsNullOrEmpty($_))})).'Count' -gt 0) {
        # Close Regedit.exe if running, can't unload hives otherwise
        $null = Get-Process -Name 'regedit' -ErrorAction 'SilentlyContinue' | ForEach-Object -Process {Stop-Process -InputObject $_ -ErrorAction 'SilentlyContinue'}

        # Get all logged in users
        $SIDsLoggedInUsers = [string[]]$(([string[]]@(Get-Process -Name 'explorer' -IncludeUserName | Select-Object -ExpandProperty 'UserName' -Unique | ForEach-Object -Process {Try{[System.Security.Principal.NTAccount]::new(($_)).Translate([System.Security.Principal.SecurityIdentifier]).'Value'}Catch{}} | Where-Object -FilterScript {-not([string]::IsNullOrEmpty($_))}),[string]$([System.Security.Principal.WindowsIdentity]::GetCurrent().'User'.'Value')) | Select-Object -Unique)

        foreach ($SID in $RegistryLoadedProfiles) {
            # If SID is found in $SIDsLoggedInUsers - Don't Unload Hive
            if ([bool]$(([string[]]@($SIDsLoggedInUsers | ForEach-Object -Process {$_.Trim().ToUpper()})).Contains($SID.Trim().ToUpper()))) {
                Write-Output -InputObject ('User with SID "{0}" is currently logged in, will not unload registry hive.' -f ($SID))
            }
            # If SID is not found in $SIDsLoggedInUsers - Unload Hive
            else {
                $PathUserHive = [string]('Registry::HKEY_USERS\{0}' -f ($SID))
                $null = Start-Process -FilePath ('{0}\reg.exe' -f ([string]$([system.environment]::SystemDirectory))) -ArgumentList ('UNLOAD "{0}"' -f ($PathUserHive)) -WindowStyle 'Hidden' -Wait

                # Check success
                if (Test-Path -Path ('Registry::{0}' -f ($PathUserHive)) -ErrorAction 'SilentlyContinue') {
                    Write-Output -InputObject ('ERROR: Failed to unload user registry hive "{0}".' -f ($PathUserHive)) -ErrorAction 'Continue'
                }
                else {
                    Write-Output -InputObject ('Successfully unloaded user registry hive "{0}".' -f ($PathUserHive))
                }
            }
        }
    }
    
    # Stop Transcript
    Stop-Transcript
}
#endregion Don't touch this